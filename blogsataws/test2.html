<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Automatically Revert and Receive Notifications About Changes to Your Amazon VPC Security Groups</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Rob Barnes</span></span> | on 
<time property="datePublished" datetime="2017-10-11T06:50:58+00:00">11 OCT 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-vpc-networking-content-delivery/" title="View all posts in Amazon VPC"><span property="articleSection">Amazon VPC</span></a>, <a href="https://aws.amazon.com/blogs/security/category/how-to-guides/" title="View all posts in How-to guides"><span property="articleSection">How-to guides</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security/" title="View all posts in Security"><span property="articleSection">Security</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-automatically-revert-and-receive-notifications-about-changes-to-your-amazon-vpc-security-groups/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-5393" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=5393&amp;disqus_title=How+to+Automatically+Revert+and+Receive+Notifications+About+Changes+to+Your+Amazon+VPC+Security+Groups&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-automatically-revert-and-receive-notifications-about-changes-to-your-amazon-vpc-security-groups/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5393');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>In this post, I take that approach a step further by introducing an example of a <em>responsive control</em>, which you can use to automatically respond to a detected security event by applying a chosen security mitigation. I demonstrate a solution that continuously monitors changes made to an <a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon VPC</a> <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_SecurityGroups.html" target="_blank" rel="noopener noreferrer">security group</a>, and if a new ingress rule (the same as an inbound rule) is added to that security group, the solution removes the rule and then sends you a notification after the changes have been automatically reverted.</p> 
<h3>The scenario</h3> 
<p>Let’s say you want to reduce your infrastructure complexity by <a href="https://aws.amazon.com/blogs/mt/replacing-a-bastion-host-with-amazon-ec2-systems-manager/" target="_blank" rel="noopener noreferrer">replacing your Secure Shell (SSH) bastion hosts</a> with <a href="https://aws.amazon.com/ec2/systems-manager/" target="_blank" rel="noopener noreferrer">Amazon EC2 Systems Manager</a> (SSM). SSM allows you to run commands on your hosts remotely, removing the need to manage bastion hosts&nbsp;or rely on SSH to execute commands. To support this objective, you must prevent your staff members from opening SSH ports to your web server’s Amazon VPC security group. If one of your staff members does modify the VPC security group to allow SSH access, you want the change to be automatically reverted and then receive a notification that the change to the security group was automatically reverted. If you are not yet familiar with security groups, see <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_SecurityGroups.html" target="_blank" rel="noopener noreferrer">Security Groups for Your VPC</a> before reading the rest of this post.<span id="more-5393"></span></p> 
<h3>Solution overview</h3> 
<p>This solution begins with a <em>directive</em> <em>control</em> to mandate that no web server should be accessible using SSH. The directive control is enforced using a <em>preventive</em> <em>control,</em> which is implemented using a security group rule that prevents ingress from port 22 (typically used for SSH). The detective control is a “listener” that identifies any changes made to your security group. Finally, the responsive control reverts changes made to the security group and then sends a notification of this security mitigation.</p> 
<p>The detective control, in this case, is an <a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="noopener noreferrer">Amazon CloudWatch</a> event that detects changes to your security group and triggers the responsive control, which in this case is an <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> function. I use <a href="https://aws.amazon.com/cloudformation/" target="_blank" rel="noopener noreferrer">AWS CloudFormation</a> to simplify the deployment.</p> 
<p>The following diagram shows the architecture of this solution.</p> 
<p><img class="alignnone wp-image-5398 size-full" title="Solution architecture diagram" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/09/Annotated-Flow-FINAL.png" alt="Solution architecture diagram" width="1028" height="263" /></p> 
<p>Here is how the process works:</p> 
<ol> 
<li>Someone on your staff adds a new ingress rule to your security group.</li> 
<li>A CloudWatch event that continually monitors changes to your security groups detects the new ingress rule and invokes a designated Lambda function (with Lambda, you can run code without provisioning or managing servers).</li> 
<li>The Lambda function evaluates the event to determine whether you are monitoring this security group and reverts the new security group ingress rule.</li> 
<li>Finally, the Lambda function sends you an email to let you know what the change was, who made it, and that the change was reverted.</li> 
</ol> 
<h3>Deploy the solution by using CloudFormation</h3> 
<p>In this section, you will click the <strong>Launch Stack</strong> button shown below to launch the CloudFormation stack and deploy the solution.</p> 
<h4>Prerequisites</h4> 
<ul> 
<li>You must have <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a> already enabled in the AWS Region where you will be deploying the solution. CloudTrail lets you log, continuously monitor, and retain events related to API calls across your AWS infrastructure. See <a href="http://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-getting-started.html" target="_blank" rel="noopener noreferrer">Getting Started with CloudTrail</a> for more information.</li> 
<li>You must have a default VPC in the region in which you will be deploying the solution. AWS accounts have one default VPC per AWS Region. If you’ve deleted your VPC, see <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html#create-default-vpc" target="_blank" rel="noopener noreferrer">Creating a Default VPC</a> to recreate it.</li> 
</ul> 
<h4>Resources that this solution creates</h4> 
<p>When you launch the CloudFormation stack, it creates the following resources:</p> 
<ul> 
<li>A sample VPC security group in your default VPC, which is used as the target for reverting ingress rule changes.</li> 
<li>A CloudWatch event rule that monitors changes to your AWS infrastructure.</li> 
<li>A Lambda function that reverts changes to the security group and sends you email notifications.</li> 
<li>A permission that allows CloudWatch to invoke your Lambda function.</li> 
<li>An <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) role with limited privileges that the Lambda function assumes when it is executed.</li> 
<li>An <a href="http://aws.amazon.com/sns/" target="_blank" rel="noopener noreferrer">Amazon SNS</a> topic to which the Lambda function publishes notifications.</li> 
</ul> 
<h4>Launch the CloudFormation stack</h4> 
<p>The link in this section uses the <span style="font-family: courier">us-east-1</span> Region (the US East [N. Virginia] Region). Change the region if you want to use this solution in a different region. See <a href="http://docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/getting-started.html#select-region" target="_blank" rel="noopener noreferrer">Selecting a Region</a> for more information about changing the region.</p> 
<p>To deploy the solution, click the following <strong>Launch Stack</strong> button to launch the stack.&nbsp;After you click the button, you must sign in to the AWS Management Console if you have not already done so.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=security-group-change-auto-response&amp;templateURL=https://s3.amazonaws.com/awsiammedia/public/sample/revertsecuritygroupchanges/security-group-change-auto-response.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone wp-image-5399 size-full" title="Click this &quot;Launch Stack&quot; button" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/09/Launch-Stack.png" alt="Click this &quot;Launch Stack&quot; button" width="107" height="20" /></a></p> 
<p>Then:</p> 
<ol> 
<li>Choose <strong>Next</strong> to proceed to the <strong>Specify Details</strong> page.</li> 
<li>On the <strong>Specify Details</strong> page, type your email address in the <strong>Send notifications to</strong>&nbsp;box. This is the email address to which change notifications will be sent. (After the stack is launched, you will receive a confirmation email that you must accept before you can receive notifications.)</li> 
<li>Choose <strong>Next</strong> until you get to the <strong>Review</strong> page, and then choose the <strong>I acknowledge that AWS CloudFormation might create IAM resources</strong> check box. This confirms that you are aware that the CloudFormation template includes an IAM resource.</li> 
<li>Choose <strong>Create</strong>. CloudFormation displays the stack status, <strong>CREATE_COMPLETE</strong>, when the stack has launched completely, which should take less than two minutes.<img class="alignnone wp-image-5460 size-full" title="Screenshot showing that the stack has launched completely" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/createcomplete_RB101017-a.png" alt="Screenshot showing that the stack has launched completely" width="792" height="156" /></li> 
</ol> 
<h3>Testing the solution</h3> 
<ol> 
<li>Check your email for the SNS confirmation email. You must confirm this subscription to receive future notification emails. If you don’t confirm the subscription, your security group ingress rules still will be automatically reverted, but you will not receive notification emails.</li> 
<li>Navigate to the <a href="https://console.aws.amazon.com/ec2/v2/home" target="_blank" rel="noopener noreferrer">EC2 console</a> and choose <strong>Security Groups</strong> in the navigation pane.</li> 
<li>Choose the security group created by CloudFormation. Its name is <strong>Web Server Security Group</strong>.</li> 
<li>Choose the <strong>Inbound</strong> tab in the bottom pane of the page. Note that only one rule allows HTTPS ingress on port 443 from <span style="font-family: courier">0.0.0.0/0</span> (from anywhere).<img class="alignnone wp-image-5447 size-full" title="Screenshot showing the &quot;Inbound&quot; tab in the bottom pane of the page" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/edit-inboundtab_RB101017.png" alt="Screenshot showing the &quot;Inbound&quot; tab in the bottom pane of the page" width="912" height="549" /></li> 
</ol> 
<ol start="5"> 
<li>Choose <strong>Edit</strong> to display the <strong>Edit inbound rules</strong> dialog box (again, an inbound rule and an ingress rule are the same thing).</li> 
<li>Choose <strong>Add Rule</strong>.</li> 
<li>Choose <strong>SSH</strong> from the <strong>Type</strong> drop-down list.</li> 
<li>Choose <strong>My IP</strong> from the <strong>Source</strong> drop-down list. Your IP address is populated for you. By adding this rule, you are simulating one of your staff members violating your organization’s policy (in this blog post’s hypothetical example) against allowing SSH access to your EC2 servers. You are testing the solution created when you launched the CloudFormation stack in the previous section. The solution should remove this newly created SSH rule automatically.<br /> <img class="alignnone wp-image-5456 size-full" title="Screenshot of editing inbound rules" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/editinboundrules_RB101017-c.png" alt="Screenshot of editing inbound rules" width="1087" height="332" /></li> 
<li>Choose <strong>Save</strong>.</li> 
</ol> 
<p>Adding this rule creates an EC2 <span style="font-family: courier">AuthorizeSecurityGroupIngress</span> service event, which triggers the Lambda function created in the CloudFormation stack. After a few moments, choose the refresh button (&nbsp;<img class="alignnone wp-image-5406" title="The &quot;refresh&quot; icon" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/09/refresh.png" alt="The &quot;refresh&quot; icon" width="10" height="10" />&nbsp;) to see that the new SSH ingress rule that you just created has been removed by the solution you deployed earlier with the CloudFormation stack. If the rule is still there, wait a few more moments and choose the refresh button again.</p> 
<p><img class="alignnone wp-image-5450 size-full" title="Screenshot of refreshing the page to see that the SSH ingress rule has been removed" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/refreshbutton_RB101017.png" alt="Screenshot of refreshing the page to see that the SSH ingress rule has been removed" width="900" height="404" /></p> 
<p>You should also receive an email to notify you that the ingress rule was added and subsequently reverted.</p> 
<p><img class="alignnone wp-image-5455 size-full" title="Screenshot of the notification email" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/Notification-Email-a.png" alt="Screenshot of the notification email" width="769" height="550" /></p> 
<h3>Cleaning up</h3> 
<p>If you want to remove the resources created by this CloudFormation stack, you can delete the CloudFormation stack:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/cloudformation/home" target="_blank" rel="noopener noreferrer">CloudFormation console</a>.</li> 
<li>Choose the stack that you created earlier.</li> 
<li>Choose the <strong>Actions</strong> drop-down list.</li> 
<li>Choose <strong>Delete Stack</strong>, and then choose <strong>Yes, Delete</strong>.</li> 
<li>CloudFormation will display a status of <strong>DELETE_IN_PROGRESS</strong> while it deletes the resources created with the stack. After a few moments, the stack should no longer appear in the list of completed stacks.<br /> <img class="alignnone wp-image-5458 size-full" title="Screenshot of stack &quot;DELETE_IN_PROGRESS&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/10/deleteinprogress_RB101017-a.png" alt="Screenshot of stack &quot;DELETE_IN_PROGRESS&quot;" width="795" height="157" /></li> 
</ol> 
<h3>Other applications of this solution</h3> 
<p>I have shown one way to use multiple AWS services to help continuously ensure that your security controls haven’t deviated from your security baseline. However, you also could use the <a href="https://github.com/awslabs/aws-security-benchmark" target="_blank" rel="noopener noreferrer">CIS Amazon Web Services Foundations Benchmarks</a>, for example, to establish a governance baseline across your AWS accounts and then use the principles in this blog post to automatically mitigate changes to that baseline.</p> 
<p>To scale this solution, you can create a framework that uses <a href="https://aws.amazon.com/answers/account-management/aws-tagging-strategies/" target="_blank" rel="noopener noreferrer">resource tags</a> to identify particular resources for monitoring. You also can use a consolidated monitoring approach by using cross-account event delivery. See <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/CloudWatchEvents-CrossAccountEventDelivery.html" target="_blank" rel="noopener noreferrer">Sending and Receiving Events Between AWS Accounts</a> for more information. You also can extend the principle of automatic mitigation to detect and revert changes to other resources such as IAM policies and <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> bucket policies.</p> 
<h3>Summary</h3> 
<p>In this blog post, I demonstrated how you can automatically revert changes to a VPC security group and have a notification sent about the changes. You can use this solution in your own AWS accounts to enforce your security requirements continuously.</p> 
<p>If you have comments about this blog post or other ideas for ways to use this solution, submit a comment in the “Comments” section below. If you have implementation questions, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=30" target="_blank" rel="noopener noreferrer">EC2 forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Rob</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/amazon-vpc-vpc-security-groups-amazon-ec2-amazon-ec2-systems-manager-secure-shell-ssh-bastion-hosts-aws-cloudformation-aws-lambda-amazon-cloudwatch-detective-controls/" rel="tag">Amazon VPC | VPC security groups | Amazon EC2 | Amazon EC2 Systems Manager | Secure Shell | SSH | bastion hosts | AWS CloudFormation | AWS Lambda | Amazon CloudWatch | detective controls</a>, <a href="https://aws.amazon.com/blogs/security/tag/responsive-controls/" rel="tag">responsive controls</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5393');
});
</script> 
</article> 
