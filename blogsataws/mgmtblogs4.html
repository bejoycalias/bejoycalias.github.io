<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Management Tools Blogs @ AWS" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Management Tools Blogs @ AWS</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a</p>
<br>
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Keeping CloudWatch Dashboards up to date using AWS Lambda</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Mike Meaney</span></span> | on 
<time property="datePublished" datetime="2017-07-05T16:12:07+00:00">05 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch"><span property="articleSection">Amazon CloudWatch</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation"><span property="articleSection">AWS CloudFormation</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/compute/aws-lambda/" title="View all posts in AWS Lambda"><span property="articleSection">AWS Lambda</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/keeping-cloudwatch-dashboards-up-to-date-using-aws-lambda/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>With the launch of the new <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/Welcome.html">CloudWatch Dashboards API</a> and CloudFormation support it is now easy to <a href="https://aws.amazon.com/blogs/aws/new-api-cloudformation-support-for-amazon-cloudwatch-dashboards/">automate your CloudWatch Dashboards</a> and make sure they monitor all the resources that you launched when creating your <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html">CloudFormation stacks</a>.</p> 
<p>Let’s now see how you can use the new CloudWatch Dashboards API to dynamically update your dashboard as EC2 instances are added or removed. When you use auto-scaled EC2 instances for example, EC2 instances may be launched or terminated at any time and if you have a CloudWatch Dashboard monitoring your EC2 resources it can suddenly be monitoring instances that do not exist anymore, and may be missing ones that do exist.</p> 
<b>Use AWS Lambda to keep EC2 instances up to date</b> 
<p>A simple solution is to run the script below periodically in AWS Lambda. The script loads your CloudWatch Dashboards that monitors your instances and updates the EC2 graph widgets if needed.</p> 
<p><span id="more-700"></span></p> 
<p>The script:</p> 
<ul> 
<li>Loads the specified CloudWatch Dashboard(s)</li> 
<li>Looks for all graph widgets displaying EC2 instance metrics</li> 
<li>Calls <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#describeInstances-property">EC2 DescribeInstances API</a> with configured parameters to discover the current EC2 instances for that graph in that region</li> 
<li>Updates the widget if needed</li> 
<li>Saves the CloudWatch Dashboards if any widget definition has changed</li> 
</ul> 
<p>The script is configured via an environment variable <strong>AWS_DASHBOARDS</strong> whose value is a JSON array of the dashboard names that you want to update along with (optional) parameters for <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#describeInstances-property">EC2 DescribeInstances API</a> which sets which EC2 Instances should be displayed on each dashboard.</p> 
<p>Here’s an example that will update a CloudWatch Dashboard called <code>MyAutoScalingDashboard</code> with all running instances in the AutoScaling group called <code>MyAutoScalingGroup</code>:</p> 
<pre><code class="lang-json">[
{
&quot;dashboardName&quot;: &quot; MyAutoScalingDashboard &quot;,
&quot;ec2DescribeInstanceParams&quot;: {
&quot;Filters&quot;: [
{
&quot;Name&quot;: &quot;instance-state-name&quot;,
&quot;Values&quot;: [ &quot;running&quot; ]
},
{
&quot;Name&quot;: &quot;tag:aws:autoscaling:groupName&quot;,
&quot;Values&quot;: [ &quot;MyAutoScalingGroup&quot; ]
}
]
}
}
]
</code></pre> 
<h3>To create the Lambda function:</h3> 
<ol> 
<li>In the <a href="https://console.aws.amazon.com/lambda">Lambda console</a>, choose <strong>Create a Lambda function</strong></li> 
<li>Select <strong>Blank Function</strong> and choose <strong>Next</strong> when asked to configure a trigger.</li> 
<li>For <strong>Name</strong>, enter <code>ec2DashboardUpdater</code></li> 
<li>For <strong>Code entry type</strong> choose <strong>Upload a file from Amazon S3</strong>.</li> 
<li>For <strong>S3 link URL</strong> enter <code>https://s3.amazonaws.com/ec2-dashboard-updater/ec2DashboardUpdater.zip</code></li> 
<li>You’ll need to specify the <code>AWS_DASHBOARDS</code> environment variable with a JSON array for the dashboards you want to update, e.g. with the JSON in the example earlier (no newlines: <pre><code class="lang-json">[{&quot;dashboardName&quot;:&quot;AutoUpdateEC2Dashboard&quot;,&quot;ec2DescribeInstanceParams&quot;:{&quot;Filters&quot;:[{&quot;Name&quot;:&quot;instance-state-name&quot;,&quot;Values&quot;:[&quot;running&quot;]},{&quot;Name&quot;:&quot;tag:aws:autoscaling:groupName&quot;,&quot;Values&quot;:[&quot;test-asg-01&quot;]}]}}]</code></pre> </li> 
<li>Set the <strong>Handler</strong> as <code>ec2DashboardUpdater.handler</code></li> 
<li>For <strong>Role</strong> select <strong>Create a custom role</strong></li> 
<li>In the IAM Console window that opens choose <strong>IAM Role</strong> of <strong>Create a new IAM Role</strong></li> 
<li>Set <strong>Role Name</strong> of <code>ec2DashboardUpdaterRole</code></li> 
<li>Choose <strong>View Policy Document, Edit, Ok</strong>.</li> 
<li>Set the role to: <pre><code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;cloudwatch:GetDashboard&quot;,
&quot;cloudwatch:PutDashboard&quot;,
&quot;ec2:DescribeInstances&quot;
],
&quot;Resource&quot;: &quot;*&quot;
}
]
}</code></pre> </li> 
<li>Choose <strong>Allow</strong></li> 
<li>In <strong>Advanced settings</strong> set <strong>Timeout</strong> to a value that is enough to describe all instances for all EC2 graph widgets and load and save all dashboards – set it to <strong>5 min</strong> if unsure</li> 
<li>Select <strong>Next</strong> then <strong>Create function</strong></li> 
</ol> 
<h3>To call the Lambda function periodically:</h3> 
<ol> 
<li>In the <a href="https://console.aws.amazon.com/cloudwatch">CloudWatch console,</a> choose <strong>Rules</strong> in the left navigation pane</li> 
<li>Select <strong>Create rule</strong></li> 
<li>Choose the <strong>Schedule</strong> radio button and set <strong>Fixed rate</strong> of <code>15</code> Minutes</li> 
<li>Select <strong>Add target</strong>, make sure <strong>Lambda function</strong> is active and for <strong>Function</strong> select the previously created <code>ec2DashboardUpdater</code> function</li> 
<li>Choose <strong>Configure details</strong></li> 
<li>Enter <strong>Name</strong> as <code>ec2DashboardUpdaterCron</code></li> 
<li>Select <strong>Create rule</strong></li> 
</ol> 
<p>And that’s it, you’re done. Your selected dashboards will now be kept up to date with your changing EC2 instances hourly. If your EC2 instances do not change from hour to hour then your dashboards will not be updated.</p> 
<p>Please note some limitations of the script:</p> 
<ul> 
<li>It will only update graphs where the first metric is an EC2 instance id metric, such as CPUUtilization, NetworkIn or DiskReadBytes, in the AWS/EC2 namespace.</li> 
<li>It assumes EC2 metrics on a graph all use the same MetricName field.</li> 
<li>All EC2 graphs on a particular dashboard are for the same list of EC2 instances (as specified in the ec2DescribeInstanceParams configuration parameter.</li> 
</ul> 
<p>The (Javascript) code for the script is given below. Feel free to use it as the basis for keeping your CloudWatch Dashboards up to date with other resources.</p> 
<pre><code class="lang-javascript">//
// EC2 Dashboard Updater
// This script will keep EC2 graphs on a chosen list of CloudWatch Dashboards up to date. In the CloudWatch Events
// console create a rule to call this Lambda whenever and EC2 instance changes state.
//
// Configure this script with the AWS_DASHBOARDS environment variable. The content of AWS_DASHBOARDS indicates
// which dashboards to update with which EC2 instances.  The value is an array in JSON format. Each array element
// is an object with two properties, dashboardName and ec2DescribeInstanceParams. dashboardName is the dashboard to
// update and ec2DescribeInstanceParams are parameters to pass to EC2 DescribeInstances API, to determine which
// instances to update the graphs with.
//
// For example, set AWS_DASHBOARDS to the following to keep 'MyDashboard' up to date with the instances in the
// AutoScalingGroup 'MyAutoScalingGroup':
//
// [
//     {
//         dashboardName: 'MyDashboard',
//         ec2DescribeInstanceParams: {
//             Filters: [
//                 {
//                     Name: 'tag:aws:autoscaling:groupName',
//                     Values: [ 'MyAutoScalingGroup' ]
//                 }
//             ]
//         }
//     }
// ]
//
// Limitations:
// - it will only update graphs whose first metric is an EC2 instance metric, all other metrics on the graph
//   will be replaced with these metrics
// - metrics can not have custom periods or statistics, the graph defaults will be used
//
'use strict'
var _ = require('lodash'),
co = require('co'),
AWS = require('aws-sdk'),
EC2_NAMESPACE = 'AWS/EC2',
INSTANCE_ID_DIM = 'InstanceId',
REPEAT_PREVIOUS = '...',
NAME_TAG = 'Name',
METRIC_WIDGET_TYPE = 'metric';
function getDashboards() {
let dashboardDef = process.env.AWS_DASHBOARDS,
dashboards;
if (! dashboardDef) {
throw 'Environment variable AWS_DASHBOARDS is not set. It should be set with JSON array, e.g [{&quot;dashboardName&quot;: &quot;myDashboard&quot;}]';
}
try {
dashboards = JSON.parse(dashboardDef);
} catch (err) {
throw 'Error, AWS_DASHBOARDS is not valid JSON';
}
if (! Array.isArray(dashboards)) {
throw 'Expecting AWS_DASHBOARDS to be an array';
}
return dashboards;
}
function ec2MetricsFromDescribeInstances(ec2DescribeInstances, metricName) {
return _.chain(ec2DescribeInstances.Reservations).
map('Instances').
flatten().
map(function(instance) {
let idAndLabel = {
id: instance.InstanceId,
label: instance.InstanceId
};
_.each(instance.Tags, (tag) =&gt; {        // Use Name tag instead of InstanceId as label, if it exists
if (tag.Key === NAME_TAG) {
idAndLabel.label = tag.Value;
return false;
}
});
return idAndLabel;
}).
sortBy(['label']).
map((idAndLabel, i) =&gt; {
var metric = i == 0 ?
[ EC2_NAMESPACE, metricName, INSTANCE_ID_DIM, idAndLabel.id ] :
[ REPEAT_PREVIOUS, idAndLabel.id ];
if (idAndLabel.id != idAndLabel.label) {
metric.push({label: idAndLabel.label});
}
return metric;
}).
value();
}
function* getEC2Metrics(dashboardContext, region, metricName) {
var params = dashboardContext.dashboard.ec2DescribeInstanceParams || {},
ec2Cache = dashboardContext.ec2Cache,
ec2DescribeInstances;
// ec2Cache is a cache of instance responses per region for the current dashboard, to limit calls to EC2
if (!ec2Cache) {
dashboardContext.ec2Cache = {};
} else if (ec2Cache[region]) {
ec2DescribeInstances = ec2Cache[region];
}
if (!ec2DescribeInstances) {
// Not in cache, call EC2 to get list of regions
let ec2Client = new AWS.EC2({region: region});
ec2DescribeInstances = yield ec2Client.describeInstances(params).promise(),
dashboardContext.ec2Cache[region] = ec2DescribeInstances;
}
return ec2MetricsFromDescribeInstances(ec2DescribeInstances, metricName);
}
function* updateDashboard(cloudwatchClient, dashboardContext, dashboardBody) {
var newDashboard = _.cloneDeep(dashboardBody),
widgets = newDashboard.widgets,
dashboardName = dashboardContext.dashboard.dashboardName;
for (let i = 0; i &lt; widgets.length; i++) {
let widget = widgets[i],
metrics = widget.properties.metrics,
region = widget.region;
// Check to see if it's a metric widget and first metric is an EC2 Instance metric
if (widget.type === METRIC_WIDGET_TYPE &amp;&amp; metrics &amp;&amp; (metrics[0].length === 4 || metrics[0].length === 5) &amp;&amp;
metrics[0][0] === EC2_NAMESPACE &amp;&amp; metrics[0][2] === INSTANCE_ID_DIM) {
let ec2Metrics = yield getEC2Metrics(dashboardContext, region, metrics[0][1]);
widget.properties.metrics = ec2Metrics;
}
}
if (JSON.stringify(dashboardBody) !== JSON.stringify(newDashboard)) {
console.log(`Updating dashboard ${dashboardName} to:`, JSON.stringify(newDashboard));
// Save updated dashboard
yield cloudwatchClient.putDashboard({
DashboardName: dashboardName,
DashboardBody: JSON.stringify(newDashboard)
}).promise();
} else {
console.log(`Dashboard ${dashboardName} is unchanged, update skipped`);
}
}
exports.handler = (event, context, callback) =&gt; {
var dashboards = getDashboards(),
cloudwatchClient = new AWS.CloudWatch(),
dashboard,
dashboardContext;
try {
co(function* () {
for (let i = 0; i &lt; dashboards.length; i++) {
dashboard = dashboards[i];
dashboardContext = { dashboard: dashboard };
if (dashboard.dashboardName) {
let dashboardResponse = yield cloudwatchClient.getDashboard({
DashboardName: dashboard.dashboardName }).promise(),
dashboardBody = JSON.parse(dashboardResponse.DashboardBody);
yield updateDashboard(cloudwatchClient, dashboardContext, dashboardBody);
}
}
callback(null, 'Update complete');
});
} catch (err) {
callback(err);
}
};
</code></pre> 
<p>&nbsp;</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-lambda/" rel="tag">AWS Lambda</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Join a Microsoft Active Directory Domain with Parameter Store and Amazon EC2 Systems Manager Documents</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Matteo Rinaudo</span></span> | on 
<time property="datePublished" datetime="2017-06-19T10:04:06+00:00">19 JUN 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/join-a-microsoft-active-directory-domain-with-parameter-store-and-amazon-ec2-systems-manager-documents/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>The process of configuration management can be difficult, in particular when performed at scale. An example could be an application, running on your fleet, which uses configuration values like database connection strings or passwords.</p> 
<p>For deployment best practices, isolate application configuration portions so that you can separately deploy configuration values specific to each environment, for example development and production environments. To ameliorate the security posture of your application, encrypt sensitive configuration values like passwords. From a management standpoint, store configuration values in a central and secure location, instead of storing and maintaining such information on your fleet. Central storage has the advantage of easily maintaining and rotating configuration values in one single place, and it also facilitates auditing changes and access to such configuration values.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/" target="_blank" rel="noopener noreferrer">Amazon EC2 Systems Manager</a> is a management service that helps you configure and manage Amazon EC2 instances and on-premises servers. <a href="https://aws.amazon.com/ec2/systems-manager/parameter-store/" target="_blank" rel="noopener noreferrer">Parameter Store</a> is a Systems Manager feature that makes it easier to reference your configuration data, securely stored in a central location. Parameter Store integrates with other AWS services like <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) and <a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service</a> (AWS KMS). With IAM, you define access control to Systems Manager parameters. With KMS, you can encrypt sensitive information, such as SecureString parameters. API calls made to Systems Manager parameters can be recorded with <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>, so you can audit access or changes to your parameters, for example.</p> 
<p>In this post, I show you a scenario for centralized configuration management, with an example of joining EC2 instances to a Microsoft Active Directory. You launch an EC2 instance that consumes and uses configuration values stored as Systems Manager parameters to join your Active Directory domain. For more information about creating an Active Directory with <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">AWS Directory Service</a> instead, see the <a href="https://aws.amazon.com/blogs/aws/seamlessly-join-ec2-instances-to-a-domain/" target="_blank" rel="noopener noreferrer">Seamlessly Join EC2 Instances to a Domain</a> blog post.</p> 
<p><span id="more-635"></span></p> 
<p>This is the diagram of the example infrastructure you create:</p> 
<p><img class="aligncenter wp-image-638 size-large" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-parameter-store-demo-diagram-1024x576.png" alt="" width="640" height="360" /></p> 
<p><strong>Walkthrough</strong><br /> In this walkthrough, you create an example Active Directory domain to run on a single EC2 instance. Next, you create Systems Manager parameters where you put the following information:</p> 
<ul> 
<li>The Active Directory instance’s private IP address (used as a DNS server for domain members)</li> 
<li>The domain name</li> 
<li>The Active Directory administrator’s user name</li> 
<li>The Active Directory administrator’s password</li> 
</ul> 
<p>Then, you create a KMS customer master key (CMK) that you use to store the Active Directory admin password as an encrypted object in the relevant SecureString parameter.</p> 
<p>Finally, you create an association between a <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html" target="_blank" rel="noopener noreferrer">Systems Manager document</a>, where an example domain join script is defined, and an EC2 instance that joins the domain. Associations define the state to apply to a set of targets. In your example, the EC2 instance (a target) joins your domain (a state). <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/" target="_blank" rel="noopener noreferrer">State Manager</a>, another Systems Manager feature, uses the association to keep your managed instance in the intended state.</p> 
<p>For this walkthrough, you use the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface</a> (AWS CLI) to create AWS resources. The examples show the us-east-1 region. I’ve also prepared example <a href="https://aws.amazon.com/cloudformation/" target="_blank" rel="noopener noreferrer">AWS CloudFormation</a> templates that you can use to create AWS resources.</p> 
<p><strong>Step 1: &nbsp;Select the AMI</strong><br /> Use an Amazon Machine Image (AMI) for Microsoft Windows 2012 R2 to launch both your example Active Directory instance and the instance you join to the Active Directory domain.</p> 
<p>First, you need the ID of the AMI to use. Generate and choose from a list of AMIs, matching your search pattern. For readability, I’ve broken down the following command (and all the other commands in this post) in multiple lines instead of a single line:</p> 
<pre><code class="lang-bash">aws ec2 describe-images
--owners amazon
--filters
'Name=name,Values=Windows_Server-2012-R2_RTM-English-64Bit-Base-*'
'Name=state,Values=available'
--query 'Images[].[Name, ImageId]'
--output text
--region us-east-1
</code></pre> 
<p>After running the command above, you should get a list with AMI names in the left column, and AMI IDs on the right column. Note the ID of the AMI to use, for example <em>ami-1234abcd</em>.</p> 
<p><strong>Step 2: &nbsp;Create the EC2 key pair</strong><br /> Now, create an Amazon EC2 key pair to use to retrieve Windows passwords for the EC2 instances that you create. Call the key pair <em>your-domain-join-demo</em> and store the private key material on your computer in the <em>your-domain-join-demo.pem</em> file:</p> 
<pre><code class="lang-bash">aws ec2 create-key-pair
--key-name your-domain-join-demo
--query &quot;KeyMaterial&quot;
--output text
--region us-east-1 &gt; your-domain-join-demo.pem
</code></pre> 
<p><strong>Step 3: &nbsp;Create the Active Directory</strong><br /> For this post, you create your example Active Directory on a single EC2 instance, and launch it on a default VPC subnet. The directory’s admin user name is <em>Administrator</em>, and the directory’s admin password is the one retrieved from the instance.</p> 
<p>As part of your example Active Directory creation, specify a value to set up for the restore mode password (SafeModeAdminPassword). The password can have a minimum of 8 characters and contain alphanumeric and special characters.</p> 
<p>You are now ready to create your example Active Directory with CloudFormation. Sign in to the CloudFormation console. Choose <strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ad-single-instance</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ad-single-instance.yaml">ad-single-instance.yaml</a> example template. You can also download the template and use it as a starting point for your own implementation. This template is a modified version of the Microsoft Windows Server Active Directory template found at <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/sample-templates-applications-us-east-1.html" target="_blank" rel="noopener noreferrer">Sample Solutions</a>. I changed it to work with this walkthrough and converted it to YAML.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ad-single-instance&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ad-single-instance.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, choose <strong>Next</strong> and specify the following values&nbsp;for parameters defined in the template:</p> 
<ul> 
<li>The name of the domain to create (example: <em>corp.example.com</em>)</li> 
<li>The NetBIOS name (example: <em>CORP</em>)</li> 
<li>The AMI ID from step 1</li> 
<li>The instance size&nbsp;(example: <em>t2.micro</em>)</li> 
<li>The key pair name from step 2</li> 
<li>The value for your restore mode password</li> 
<li>The IPv4 CIDR block from which you are likely to connect, via RDP (if needed) into your instances</li> 
</ul> 
<p>For more information, see&nbsp;<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-console-create-stack-parameters.html" target="_blank" rel="noopener noreferrer">Specifying Stack Name and Parameters</a>.</p> 
<p>In the CloudFormation console, look at the stack you are creating. In the example below, you have just launched your stack and it is in the CREATE_IN_PROGRESS status:</p> 
<p>&nbsp;</p> 
<p><img class="aligncenter wp-image-647 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-domain-join-cfn-stack.png" alt="" width="953" height="188" /></p> 
<p>&nbsp;</p> 
<p>Wait for the stack creation to be in the CREATE_COMPLETE Status. This stack also creates a security group, called DomainMemberSecurityGroup, to be used later by your EC2 instance joining the domain.</p> 
<p><strong>Step 4: &nbsp;Create the KMS CMK</strong><br /> Create the KMS customer master key to encrypt the SecureString parameter that you later create for your directory’s admin password.</p> 
<p>Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-kms-cmk</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/kms-custom-cmk.yaml">kms-custom-cmk.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-kms-cmk&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/kms-custom-cmk.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console,&nbsp;specify the following values for parameters defined in the template:</p> 
<ul> 
<li>The KMS key alias (example: <em>your-domain-join-demo</em>)</li> 
<li>The key description (example: “<em>Example key</em>“)</li> 
</ul> 
<p>When I prepared the example template that describes the KMS key, I added an output, in the template’s <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html" target="_blank" rel="noopener noreferrer">Outputs</a> section, called CMKID. Its value should show the ID of the KMS key created by the stack launched off of the previously mentioned template. When the stack creation is complete, you then describe the Outputs section of the stack to get the ID of the KMS key that you just created:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-kms-cmk
--query &quot;Stacks[0].Outputs[?OutputKey == 'CMKID'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>You need the KMS key ID value later on this walkthrough. Refer to it as YOUR_KMS_KEY_ID.</p> 
<p><strong>Step 5: &nbsp;Create Systems Manager parameters</strong><br /> Start by creating a parameter for the private IP address of the Active Directory instance. You set up this value later on as the DNS server in the DNS client configuration of your instance to join the domain.</p> 
<p>When you created your Active Directory in step 3, in the CloudFormation template that created the instance, you set up output values relevant to the instance configuration, including instance ID and the private IP address of the instance. Retrieve this IP address by describing the Outputs section of the stack that you created on step 3, and by getting the value for the DNSIPAddress output key:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-ad-single-instance
--query &quot;Stacks[0].Outputs[?OutputKey == 'DNSIPAddress'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the IP address that you need, for example <em>172.31.11.22</em>. You could have set up a static private IP address for your Active Directory instance, but for this walkthrough, you just used an IP address that was automatically assigned.</p> 
<p>Now store the value for the IP address in a parameter called <em>your-domain-join-demo-dns-ip-address</em>, as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-dns-ip-address
--description &quot;Example parameter for your DNS server's IP address&quot;
--value '172.31.11.22'
--type String
--region us-east-1
</code></pre> 
<p>Create another parameter where you put the name of the domain you are creating (<em>corp.example.com</em>). Call the parameter <em>your-domain-join-demo-domain-name</em>, as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-domain-name
--description &quot;Example parameter for your domain name&quot;
--value 'corp.example.com'
--type String
--region us-east-1
</code></pre> 
<p>The user name of your directory’s admin, in your example, is <em>Administrator</em>. Create another parameter called <em>your-domain-join-demo-ad-admin-username</em>, where you put this information as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-ad-admin-username
--description &quot;Example parameter for the username of your AD admin account&quot;
--value 'Administrator'
--type String
--region us-east-1
</code></pre> 
<p>Next, store your directory’s admin password as an encrypted object in another parameter. First, retrieve the Windows password from the Active Directory instance. For this task, you need the instance ID from the Outputs section of the stack created in step 3:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-ad-single-instance
--query &quot;Stacks[0].Outputs[?OutputKey == 'InstanceID'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the ID of the Active Directory instance, for example <em>i-1234567890abcdef0</em>. Next, retrieve the Windows password for your instance, and decrypt the password with the private key material of the EC2 key pair that you created earlier:</p> 
<pre><code class="lang-bash">aws ec2 get-password-data
--instance-id i-1234567890abcdef0
--priv-launch-key your-domain-join-demo.pem
--query &quot;PasswordData&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the Windows password for your instance. Refer to this password as YOUR_WINDOWS_PASSWORD_FOR_AD on this step. Next, store YOUR_WINDOWS_PASSWORD_FOR_AD as a SecureString parameter. Create a parameter called <em>your-domain-join-demo-ad-admin-password</em>. Use the KMS CMK, created in step 4, for encryption:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-ad-admin-password
--description &quot;Example parameter for the password of your AD admin account&quot;
--value 'YOUR_WINDOWS_PASSWORD_FOR_AD'
--type SecureString
--key-id YOUR_KMS_KEY_ID
--region us-east-1
</code></pre> 
<p>At the end of this step, you should have four parameters. In the EC2 console, view your parameters:</p> 
<p><img class="aligncenter wp-image-649 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-parameter-store-resources.png" alt="" width="617" height="570" /></p> 
<p>&nbsp;</p> 
<p><strong>Step 6: &nbsp;Create the IAM role for the EC2 instance</strong><br /> On this step, you create an IAM role to be used by your instance joining the domain, via an IAM instance profile, to get read-only access to Systems Manager parameters. The example template describes a role to which the AmazonEC2RoleforSSM managed policy is attached. An example policy is also attached to the role, and a snippet of this policy is shown below:</p> 
<pre><code class="lang-json">[…]
{
&quot;Action&quot;: [
&quot;kms:Decrypt&quot;
],
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Resource&quot;: &quot;THE_ARN_OF_YOUR_KMS_KEY&quot;
}
[…]
</code></pre> 
<p>The example policy above allows kms:Decrypt API calls for the KMS key resource that you created earlier. In the policy snippet, you reference the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the KMS CMK, that you see in the relevant placeholder in capital letters above.</p> 
<p>When editing templates for this walkthrough, I used the CloudFormation feature to <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-exports.html" target="_blank" rel="noopener noreferrer">export stack output values</a>, to facilitate passing values between stacks. The stack that you are creating now needs the ARN of the KMS CMK created earlier, so that it can be referenced in the IAM policy for the role.</p> 
<p>You have already exported the KMS CMK ARN from the stack that created the CMK. You can now import and reference the ARN by specifying the name of the CMK stack (in your example: <em>your-domain-join-demo-kms-cmk</em>) as a parameter to the stack you are creating for the role. Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ec2-instance-role</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance-role.yaml">ec2-instance-role.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ec2-instance-role&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance-role.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the <em>your-domain-join-demo-kms-cmk</em> parameter value.</p> 
<p>Then, wait for the stack creation to complete and continue with the next step.</p> 
<p><strong>Step 7: &nbsp;Create the Systems Manager document</strong><br /> Create, with an example CloudFormation template, the Systems Manager document that contains commands to execute on the EC2 instance for it to join your domain. In the document, specify the parameter names that you created earlier. Pass these names to the CloudFormation stack that creates the document.</p> 
<p>The example code below depicts a portion of an example Systems Manager document. You can see how this document uses the !Sub short form of the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html" target="_blank" rel="noopener noreferrer">Fn::Sub</a> intrinsic function in CloudFormation to reference stack parameters (for example, the DNSParameterStore parameter):</p> 
<pre><code class="lang-yaml">[…]
Document:
Type: AWS::SSM::Document
Properties:
Content:
description: Run a PowerShell script to domain join a Windows instance securely
mainSteps:
- action: aws:runPowerShellScript
inputs:
runCommand:
- '# Example PowerShell script to domain join a Windows instance securely'
- ''
- $ErrorActionPreference = 'Stop'
- ''
- try{
- '    # Parameter names'
- !Sub '    $dnsParameterStore = ''${DNSParameterStore}'''
- !Sub '    $domainNameParameterStore = ''${DomainNameParameterStore}'''
- !Sub '    $domainJoinUserNameParameterStore = ''${DomainJoinUserNameParameterStore}'''
- !Sub '    $domainJoinPasswordParameterStore = ''${DomainJoinPasswordParameterStore}'''
- ''
- '    # Retrieve configuration values from parameters'
- '    $ipdns = (Get-SSMParameterValue -Name $dnsParameterStore).Parameters[0].Value'
- '    $domain = (Get-SSMParameterValue -Name $domainNameParameterStore).Parameters[0].Value'
- '    $username = $domain + ''\'' + (Get-SSMParameterValue -Name $domainJoinUserNameParameterStore).Parameters[0].Value'
- '    $password = (Get-SSMParameterValue -Name $domainJoinPasswordParameterStore
-WithDecryption $True).Parameters[0].Value | ConvertTo-SecureString
-asPlainText -Force'
[…]
</code></pre> 
<p>Create the document with a stack. Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ssm-document-domain-join&nbsp;</em>with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm-document-domain-join.yaml">ssm-document-domain-join.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ssm-document-domain-join&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm-document-domain-join.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the following values for parameters defined in the template:</p> 
<ul> 
<li><em>your-domain-join-demo-dns-ip-address</em></li> 
<li><em>your-domain-join-demo-ad-admin-password</em></li> 
<li><em>your-domain-join-demo-ad-admin-username</em></li> 
<li><em>your-domain-join-demo-domain-name</em></li> 
</ul> 
<p>After the stack creation is complete, you should find your new document listed in the Documents page in the console:</p> 
<p><img class="aligncenter wp-image-650 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-ssm-document.png" alt="" width="547" height="169" /></p> 
<p>&nbsp;</p> 
<p><strong>Step 8: &nbsp;Launch the instance and join the domain</strong><br /> On this last step, use CloudFormation to create an EC2 instance based on the Microsoft Windows 2012 R2 AMI you chose in step 1.</p> 
<p>After the instance starts up, it is associated to the document you created in the previous step, and should then join the domain after running the script in the document. When you create the stack for the instance, you import values that you have exported in other stacks, so you can easily reference the values you need. Specify the names of the stacks that created the Active Directory domain and the Systems Manager document, so you can reference the following:</p> 
<ul> 
<li>The ID of the domain member security group for your EC2 instance</li> 
<li>The name of the document for the association between the document and instance</li> 
</ul> 
<p>Now, create the instance. Choose <strong>Launch Stack</strong> below to create the stack called&nbsp;<em>your-domain-join-demo-ec2-instance</em>&nbsp;with the&nbsp;<a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance.yaml">ec2-instance.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ec2-instance&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the following values for parameters defined in the template:</p> 
<ul> 
<li><em>your-domain-join-demo-ad-single-instance</em></li> 
<li><em>your-domain-join-demo-ssm-document-domain-join</em></li> 
<li>The AMI ID from step 1</li> 
<li><em>your-domain-join-demo-ec2-instance-role</em></li> 
<li>The instance size (in your example: <em>t2.micro</em>)</li> 
<li>The key pair name from step 2</li> 
</ul> 
<p>Wait for the stack creation to complete. At the end of the process, your instance should have joined your <em>corp.example.com</em> domain. In the EC2 console, State Manager should show that the association between the Systems Manager document and the instance is successful:</p> 
<p><img class="aligncenter wp-image-651 size-large" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-state-manager-1024x446.png" alt="" width="640" height="279" /></p> 
<p>&nbsp;</p> 
<p>Verify that the machine joined the domain by connecting via RDP to the instance with your Active Directory admin credentials.</p> 
<p><strong>Conclusion</strong><br /> In this post, I showed you how to use Parameter Store to set up configuration values in a central and secure location. Using Parameter Store, you securely stored the configuration values needed for your EC2 instance to join the domain. You also stored the admin password for the example Active Directory as a SecureString parameter, and used a KMS key for encryption. Then, you launched an EC2 instance associated with a Systems Manager document, ran a custom script on the instance, and joined your example domain.</p> 
<p><strong>About the Author</strong><br /> <img class="alignleft wp-image-661 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/matteo-rinaudo-150x150.png" alt="" width="150" height="150" />Matteo Rinaudo is a Sr. Consultant at AWS Professional Services. Matteo enjoys working with our customers to deliver solutions and best practices around DevOps automation, infrastructure-as-code and configuration management. In his spare time, Matteo enjoys spending time with his wife, playing the trumpet, the piano, and listening to classical music.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-windows/" rel="tag">EC2 Windows</a>, <a href="https://aws.amazon.com/blogs/mt/tag/parameter-store/" rel="tag">Parameter Store</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Introducing Tagging Support for AWS OpsWorks Stacks</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Kai Rubarth</span></span> | on 
<time property="datePublished" datetime="2017-06-06T08:46:11+00:00">06 JUN 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-ops-works/" title="View all posts in AWS Ops Works"><span property="articleSection">AWS Ops Works</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/introducing-tagging-support-for-aws-opsworks-stacks/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>AWS now supports tagging of <a href="https://aws.amazon.com/opsworks">AWS OpsWorks</a> Stacks application environments. Tags that you add to a stack and layer now automatically propagate down to all underlying AWS resources, including Amazon EC2 instances, Elastic Load Balancing load balancers, Amazon RDS databases, Amazon EBS volumes, and Amazon ECS clusters. This benefits everyone who wants to track their AWS usage for OpsWorks Stacks infrastructure and components.</p> 
<p><img class="aligncenter wp-image-609 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/layer_inherited_tags.png" alt="" width="835" height="476" /><span id="more-608"></span></p> 
<p><a href="https://aws.amazon.com/opsworks/stacks/">OpsWorks Stacks</a> is a powerful AWS configuration management service that lets you model applications, ensure uniform configuration across groups of resources, and scale fleets of instances. Tags are key-value pairs that you can link to AWS resources for <a href="https://aws.amazon.com/de/answers/account-management/aws-tagging-strategies/">business, technical, and other purposes</a>.</p> 
<p>Until now, customers who wanted to track the costs of their OpsWorks applications or components had to tag all underlying resources manually. Now, you can simply add tags to your existing stacks. The great thing is that tags work similar to custom attributes in OpsWorks Stacks. Tags that you specify on the stack are automatically inherited by every layer in that stack, where you can override values and add extra layer-specific tags.</p> 
<p>OpsWorks does the heavy lifting of computing a resulting tag set and applying it to all the linked resources. Additionally, OpsWorks ensures that new resources that you create in a layer or assign to the layer are tagged automatically. OpsWorks gives you the ability to add, update, or remove tags on stacks and layer at any time, and then update tags on your AWS resources accordingly.</p> 
<p>For more information on how to apply tags to your stacks, see the <a href="http://docs.aws.amazon.com/opsworks/latest/userguide/tagging.html">documentation</a>.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-opsworks/" rel="tag">AWS OpsWorks</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Using Microsoft PowerShell DSC with Amazon EC2 Systems Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Shaun Breen</span></span> | on 
<time property="datePublished" datetime="2017-06-05T13:46:48+00:00">05 JUN 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/using-microsoft-powershell-dsc-with-amazon-ec2-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a> is a management service that helps you automatically collect software inventory, apply OS patches, create system images, and configure Windows and Linux operating systems. These capabilities help you define and track system configurations, prevent drift, and maintain software compliance of your EC2 and on-premises configurations.</p> 
<p>By providing a management approach that is designed for the scale and agility of the cloud but extends into your on-premises data center, Systems Manager makes it easier for you to seamlessly bridge your existing infrastructure with AWS.</p> 
<p>In this post, I show you how you can remotely manage your EC2 Windows instances using a declarative based model for instance configuration management at cloud scale. You use <a href="https://blogs.technet.microsoft.com/privatecloud/2013/08/30/introducing-powershell-desired-state-configuration-dsc/">Microsoft PowerShell Desired State Configuration (DSC)</a> to define a configuration and then apply it to your instances using Systems Manager.</p> 
<h3><span style="text-decoration: underline">Benefits</span></h3> 
<ul> 
<li>Systems Manager is built for cloud scale. It can handle applying your PowerShell DSC configuration to thousands of instances at one time.</li> 
<li>Systems Manager allows you to send logs (stdout/stderr) offline. When you apply your configuration to an instance, you can have the logs sent directly to an Amazon S3 bucket. There is no need to log in to instances to retrieve logs.</li> 
<li>Systems Manager works on your on-premises servers. There are some prerequisites required to get this to work. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up.html">Setting Up Systems Manager</a>.</li> 
</ul> 
<p><span id="more-603"></span></p> 
<h3><span style="text-decoration: underline">Microsoft DSC via Run Command</span></h3> 
<p>Systems Manager contains many tools, including <a href="https://aws.amazon.com/ec2/run-command">Run Command</a>. This tool allows you to execute a PowerShell DSC script on your instances remotely.</p> 
<p>So how exactly does this work? Run Command uses command documents to accomplish tasks. There are many AWS managed public documents that you can choose from.</p> 
<p>In this post, you use the document called AWS-InstallPowerShellModule. Run Command executes this document that downloads a PowerShell module contained within a zip file from the specified URL. It then allows you to issue commands. You issue commands that execute the cmdlets in the downloaded PowerShell Module.</p> 
<p>Below is a diagram of the workflow.</p> 
<p><img class="alignnone size-full wp-image-615" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/DSC1.png" alt="" width="735" height="463" /></p> 
<h3><span style="text-decoration: underline">Walkthrough</span></h3> 
<p>In this post, you can follow these steps using two different approaches:</p> 
<ul> 
<li>AWS Management Console</li> 
<li>PowerShell</li> 
</ul> 
<p>&nbsp;</p> 
<h4>Install IIS on Windows Server via Run Command using the AWS Management Console</h4> 
<p>In this section, I show you how to use Run Command to install IIS by executing a cmdlet from a PowerShell module on a target instance.</p> 
<ol> 
<li>In the EC2 console, <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html#ec2-launch-instance_linux">create a new Windows Server instance</a>.</li> 
<li>Choose <strong>Run Command</strong>, <strong>Run a Command</strong>.</li> 
<li>Under <strong>Target Instance</strong>, select the newly created Windows instance. If the instance is not listed, you may need to wait until the instance is ready.</li> 
<li>For <strong>Source</strong>, copy and paste the following URL. This PowerShell module is stored in Amazon S3 and was created by Amazon specifically for this post. <pre><code class="lang-http">https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip</code></pre> </li> 
<li>For <strong>Commands</strong>, copy and paste the following: <pre><code class="lang-powershell">Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
Import-Module SSMDevOps
Install-SsmDoIIS
Start-DscConfiguration -Path Install-SsmDoIIS -Wait</code></pre> </li> 
<li>Choose <strong>Run</strong>.</li> 
<li>Check the status of the Run Command execution.</li> 
<li>Choose <strong>View Results</strong> or <strong>Command Id</strong>.</li> 
<li>Choose <strong>Output</strong>, <strong>View Output</strong>.</li> 
</ol> 
<h4>Install IIS on Windows Server via Run Command using PowerShell</h4> 
<p>In this section, I show you how to accomplish the same thing programmatically.</p> 
<ol> 
<li>On your local PC, download and install the latest version of the <a href="https://aws.amazon.com/powershell/">AWS Tools for Windows PowerShell</a>.</li> 
<li>Import the AWSPowerShell module. <pre><code class="lang-powershell">if(-not (Get-Module -Name AWSPowershell)) 
{ 
Import-Module AWSPowerShell
}</code></pre> </li> 
<li>Open PowerShell and load your user profile. <pre><code class="lang-powershell">Set-AWSCredentials –AccessKey &lt;yourkey&gt; -SecretKey &lt;yourkey&gt;</code></pre> </li> 
<li>Set your AWS region to the region where your Windows Server instance is located. In this example, the region is set to us-east-1. Be sure to set the correct region for your environment. <pre><code class="lang-powershell">Set-DefaultAWSRegion –Region us-east-1</code></pre> </li> 
<li>Use Run Command to install IIS onto your instance. You need to update the instanceId with your instances instanceId. <pre><code class="lang-powershell">$instanceId = 'Enter-your-instanceId' 
$source = 'https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip'
$commands = @(
'Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force',
'Import-Module SSMDevOps',
'Install-SsmDoIIS',
'Start-DscConfiguration -Path Install-SsmDoIIS -Wait'
)
$parameter = @{
source = $source;
commands = $commands;
}
$document = 'AWS-InstallPowerShellModule'
$cmd = Send-SSMCommand –InstanceId $instanceId –DocumentName $document –Parameter $parameter</code></pre> </li> 
<li>Check the status of the Run Command execution. <pre><code class="lang-powershell">$cmd = Get-SSMCommand –CommandId $cmd.CommandId
$cmd</code></pre> <p><img class="alignnone size-full wp-image-619" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/DSC2.png" alt="" width="787" height="432" /></p></li> 
</ol> 
<h3>Conclusion</h3> 
<p>Systems Manager offers a suite of tools to help you manage both your EC2 and on-premises instances. In this post, I showed you how you could use Run Command to remotely execute a PowerShell DSC script on your instances. In the next post in this series, I show you how to perform this same example using a different tool, Systems Manager <a href="https://aws.amazon.com/ec2/state-manager">State Manager</a>.</p> 
<h3>About the Author</h3> 
<p><img class="size-full wp-image-618 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/shaunbreen.png" alt="" width="130" height="174" /></p> 
<p><strong>Shaun Breen is a Systems Development Engineer on the Amazon EC2 Windows team.</strong>&nbsp;The EC2 Windows team is responsible for producing Windows Server AMI’s and EC2 Systems Manager documents. Shaun enjoys developing solutions that makes AWS EC2 the best place to run Microsoft Windows Server in the cloud. When not working on EC2 Windows based solutions, he enjoys attending sporting events, coaching ice hockey, and spending time with his wife and three children.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-windows/" rel="tag">EC2 Windows</a>, <a href="https://aws.amazon.com/blogs/mt/tag/microsoft-powershell-dsc/" rel="tag">Microsoft PowerShell DSC</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">AWS Config Support for Amazon CloudWatch Alarms</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Shashi Prabhakar</span></span> and 
<span property="author" typeof="Person"><span property="name">Sid Gupta</span></span> | on 
<time property="datePublished" datetime="2017-06-01T13:22:40+00:00">01 JUN 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch"><span property="articleSection">Amazon CloudWatch</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config"><span property="articleSection">AWS Config</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-config-support-for-amazon-cloudwatch-alarms/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>On June 1st, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for <a href="http://aws.amazon.com/cloudwatch">Amazon CloudWatch</a> alarms. CloudWatch alarms are used on any of your CloudWatch metrics <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html">to send notifications or take other automated actions</a>.</p> 
<p>You can now start tracking the current as well as historical configuration of your alarms and get notified via <a href="https://aws.amazon.com/sns">Amazon SNS</a> when your alarm configuration changes. You can also use three new Config rules to verify the following:</p> 
<ul> 
<li>Your resources have CloudWatch alarms for the specified metric</li> 
<li>Alarm metrics have the right settings</li> 
<li>All alarms have at least one action configured</li> 
</ul> 
<p>You can get started via the AWS Config console, <a href="http://aws.amazon.com/cli">AWS CLI</a>, or <a href="http://aws.amazon.com/tools">AWS SDKs</a>.</p> 
<p>With this integration, you can view the historical configuration of your CloudWatch alarms and review all changes that occurred to them. This information is valuable in determining why certain CloudWatch alarms did not get triggered and how their configuration was modified. In this post, we show you two example scenarios in detail.</p> 
<h3>AWS Config</h3> 
<p>Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.<span id="more-382"></span></p> 
<b>Example: View configuration changes</b> 
<p>Here’s an example showing how you can use Config to troubleshoot a scenario where customers are reporting service degradations for your application hosted on Amazon EC2 but you did not see any CloudWatch alarms. On the CloudWatch console, you can see spikes in CPU but start wondering why you did not see any alarms.</p> 
<p>&nbsp;</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Example-Picture-1-2.png"><img class="alignleft size-full wp-image-400" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Example-Picture-1-2.png" alt="" width="1896" height="722" /></a></p> 
<p>&nbsp;</p> 
<p>Config can help you with troubleshooting. We use the AWS Management Console in this example, but you can use the AWS CLI or SDKs as well.</p> 
<p>First, log in to the Config console. For <strong>Resources</strong>, choose <strong>CloudWatch: Alarm</strong>. Choose <strong>Look up</strong> to see the list of CloudWatch alarms that Config has automatically discovered in your account. The following screenshot shows an example alarm on the <strong>Resource inventory</strong> page.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-9.24.47-PM.png"><img class="alignleft size-large wp-image-411" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-9.24.47-PM-1024x372.png" alt="" width="640" height="233" /></a></p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>Look at the <strong>Config timeline</strong> for the <strong>SSM CPU Alarm</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p>&nbsp;</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-9.58.31-PM.png"><img class="alignleft size-large wp-image-413" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-9.58.31-PM-1024x480.png" alt="" width="640" height="300" /></a></p> 
<p>&nbsp;</p> 
<p>For your alarm, you can see alarm settings such as <strong>Threshold</strong> and <strong>Comparison operator</strong>, and actions that would be taken under various alarm states. The timeline also shows you all configuration changes that were made after the alarm was created.</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on April 9th to the alarm configuration, when the threshold was increased from 30 to 90. That explains why you did not see any alarms.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-10.13.51-PM.png"><img class="alignleft size-large wp-image-414" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-04-09-at-10.13.51-PM-1024x275.png" alt="" width="640" height="172" /></a></p> 
<p>Using this information, you can fix these configuration issues in the CloudWatch console.</p> 
<b>Example: Verify alarm configuration using Config rules</b> 
<p>When you started seeing service degradations for your application hosted on EC2, you also noticed that no actions were configured on the alarm. Dynamic scaling wouldn’t occur, which explains why the application couldn’t handle the spikes in CPU. It is really important to configure actions for various alarm states: Alarm, OK, Insufficient.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-05-01-at-3.51.17-PM.png"><img class="alignleft size-large wp-image-415" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-05-01-at-3.51.17-PM-1024x529.png" alt="" width="640" height="331" /></a></p> 
<p>&nbsp;</p> 
<p>AWS recommends that you continuously monitor all alarm configurations in your account and verify that they have the right settings and actions configured at all times. Administrators should immediately get notified of any deviation from the desired configuration.</p> 
<p>Using Config, you can use the following rules to check alarm configuration:</p> 
<ul> 
<li>cloudwatch-alarm-action-check</li> 
</ul> 
<p>Checks whether CloudWatch alarms have at least one alarm, INSUFFICIENT_DATA action, or OK action enabled. Optionally, checks whether any actions match one of the specified ARNs.</p> 
<ul> 
<li>cloudwatch-alarm-resource-check</li> 
</ul> 
<p>Checks whether the specified resource type has a CloudWatch alarm for the specified metric. For resource type, you can specify EBS volumes, EC2 instances, RDS clusters, or S3 buckets.</p> 
<ul> 
<li>cloudwatch-alarm-settings-check</li> 
</ul> 
<p>Checks whether CloudWatch alarms with the given metric name have the specified settings.</p> 
<p>When these rules run, you immediately get notified about alarms that violate the above rules. You can check the Config Rule compliance status on the Config dashboard, as in the following screenshot.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-05-18-at-1.58.20-PM.png"><img class="alignleft size-large wp-image-416" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Screen-Shot-2017-05-18-at-1.58.20-PM-1024x250.png" alt="" width="640" height="156" /></a></p> 
<b>Summary</b> 
<p>By adding support for CloudWatch alarms in Config, you can now easily track alarm configuration changes and ensure that your alarms are configured per best practices.</p> 
<hr /> 
<h3>About the Authors</h3> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/profile-pic.png"><img class="alignleft wp-image-431 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/profile-pic-150x150.png" alt="" width="150" height="150" /></a></p> 
<p>Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and help them implement cloud security best practices. In his spare time, he enjoys hiking, reading and spending time with his kids.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/30/DSC_0666.jpg"><img class="alignleft wp-image-586 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/30/DSC_0666-150x150.jpg" alt="" width="150" height="150" /></a><br /> Shashi Prabhakar is a Solutions Architect at AWS. He loves working with&nbsp;customers to help design, architect and build variety of&nbsp;workloads. Shashi always gets excited&nbsp;to learn new Technologies and Businesses while working with customers. When not learning, he likes to run, play tennis, travel, spend time with wife and enjoy life.</p> 
<p>&nbsp;</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch-alarm/" rel="tag">Amazon CloudWatch Alarm</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-config/" rel="tag">AWS Config</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Automate Running Tasks Using Amazon EC2 Systems Manager Maintenance Windows</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Mats Lanner</span></span> | on 
<time property="datePublished" datetime="2017-05-31T20:59:02+00:00">31 MAY 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/automate-running-tasks-using-amazon-ec2-systems-manager-maintenance-windows/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>In <a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a>, a maintenance window defines a specific set of tasks, along with a set of managed instances where those tasks should be run and the schedule for when the tasks should run. Each task also has a velocity and error threshold defined (for example, run the task on at most four instances at a time and stop if there are one or more errors). You can use this to automate running many common systems administration tasks to ensure they run when needed and that you get notified about any problems running the tasks.</p> 
<p>In this post, I discuss how maintenance windows work and provide a walkthrough for setting one up.</p> 
<b>Maintenance window overview</b> 
<p>You can consider the <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-maintenance.html">Maintenance Window</a> capability of Systems Manager to be a replacement for tools like cron or Windows Task Scheduler. Instead of scheduling tasks on individual instances, you can use a feature that’s fully integrated with AWS and the rest of Systems Manager that also provides a central access point for task history and notification support.</p> 
<p>Here are some of the benefits:</p> 
<ul> 
<li>Schedule and duration</li> 
<li>Targets</li> 
<li>Tasks</li> 
<li>History</li> 
</ul> 
<p><span id="more-589"></span></p> 
<b>Schedule and duration</b> 
<p>The schedule controls when tasks run. The schedule can be defined as either a <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-cron.html">cron or a rate expression</a>. There is also a duration that defines how long the maintenance window runs (1–23 hours).</p> 
<p>It’s important to note that a maintenance window never stops any running tasks when it reaches the end of the duration; any started task runs to completion. However, when the duration closes, the maintenance window does stop starting any remaining registered tasks.</p> 
<p>A cutoff period parameter controls the time after which new tasks aren’t started. For instance, if a maintenance window has a duration of 4 hours and a cutoff period of 1 hour, tasks are started up until 3 hours in.</p> 
<b>Targets</b> 
<p>A target defines one or more instances for which tasks can be registered. That way, you control the instances on which tasks can operate. This is an optional feature.</p> 
<p>Define a target by either specifying one or more instance IDs or using tags. Targeting using instance IDs is frequently useful when you’re working with long-running instances, such as a database server. Using tags allows you to target instances dynamically. Every time the tasks run, instances that match the specified tag are identified and used as the targets. This can be helpful in scenarios where you have many instances to target or want to make sure to always run the task for any existing instances. For example, you may have instances in Auto Scaling groups.</p> 
<b>Tasks</b> 
<p>Tasks define the actions to be performed when a schedule triggers. If the maintenance window is configured to require registered targets, the task can run for one or more targets. If a task that uses specific instance IDs and the maintenance window requires registered targets, then the task’s target instance IDs must be registered with the maintenance window as well. If registered targets are not required, you can pick any managed instance for the task, by specifying an ID or using tags.</p> 
<p>Every task is a Run Command document where you define the parameters and how it should be invoked. When registering the task, specify the name of the document —or ARN in the case of shared documents, along with any parameters required for the document. Parameters are specified as a JSON string and the exact format depends on the document you are using. For the AWS CLI, you can also use the CLI shorthand syntax.</p> 
<p>Task priority determines the order in which tasks are run, when multiple tasks are registered. The lower the number, the higher the priority (for example, a task with a priority of 3 runs before one with a priority of 5). If two tasks have the same priority, they run in parallel and to completion before tasks at the next priority level start. This helps to ensure that the most important tasks are run first, in case there are more tasks than can be run in the allotted time.</p> 
<p>Finally, you also control how many instances the task should run on at the same time and how many errors to allow before stopping the task. For example, you can run the task for at most two instances at a time, and stop if a single task invocation fails. In this context, an error is anything Run Command considers a failed command invocation (for example, if the application or script invoked returns a non-zero exit code).</p> 
<b>History</b> 
<p>Every time registered tasks run, Systems Manager captures the results so you can review the history. <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">Amazon CloudWatch Events</a> is also supported, so you can get notifications about the maintenance window and task execution.</p> 
<p>A maintenance window also contains the history of all the times it has run. This allows you to see the results of every task that ran, the corresponding task invocations, and the corresponding Run Command invocation. The history provides a central place to see the status of every task run for the last 30 days. You don’t have to log in to individual instances to see task status of scheduled tasks, as with cron or Windows Task Scheduler.</p> 
<b>Getting started with maintenance windows</b> 
<p>The sections below show you how to create a maintenance window, register targets and tasks, and view the history of the maintenance window using the AWS CLI and the AWS Tools for PowerShell. All of these operations can also be done using the AWS Management Console.</p> 
<b>Prerequisites</b> 
<p>Before you can start using maintenance windows, there are some prerequisites that must be configured:</p> 
<ol> 
<li>Your instances must be configured with the SSM agent and an appropriate instance profile so that they can call the Systems Manager API. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html">Installing SSM Agent</a>.</li> 
<li>An IAM role must be created for Maintenance Windows to assume when running tasks on your behalf. This role must be specified when registering a task. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-permissions.html">Configuring Roles and Permissions for Maintenance Windows</a>.</li> 
<li>Users registering tasks with maintenance windows must have the IAM PassRole permission. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-permissions.html">Configuring Roles and Permissions for Maintenance Windows</a>.</li> 
</ol> 
<b>Create a maintenance window</b> 
<p>The Systems Manager documentation describes how to create a maintenance window using the <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-console.html">console </a>or <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-cli.html">AWS CLI</a>. The following PowerShell example shows how to create a maintenance window that runs every Tuesday at 4PM with a cut-off period of 1 hour:</p> 
<pre>PS &gt; New-SSMMaintenanceWindow -Name &quot;Every-Tuesday&quot; `
&nbsp;&nbsp;&nbsp; -Schedule &quot;cron(0 16 ? * TUE *)&quot; -Duration 4 -Cutoff 1 `
&nbsp;&nbsp;&nbsp; -AllowUnassociatedTarget $false</pre> 
<b>Register targets</b> 
<p>When registering a target, you can specify the optional <strong>owner-information</strong> field, which is passed along in all CloudWatch events raised for this target. This can be helpful when you’re processing events.</p> 
<h3>Registering a target using tags</h3> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm register-target-with-maintenance-window
--window-ID mw-0123456789abcdef
--targets &quot;Key=tag:Project,Values=Website&quot;
--owner-information &quot;Website instances&quot;
--resource-type &quot;INSTANCE&quot;</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS&gt; $tagTargets = `
@{Key=&quot;tag:Project&quot;;Values=@(&quot;Website&quot;)}
PS&gt; Register-SSMTargetWithMaintenanceWindow `
-WindowId &quot;mw-0123456789abcdef&quot; `
-Target $tagTargets `
-OwnerInformation &quot;Website instances&quot; `
-ResourceType &quot;INSTANCE&quot;
</pre> 
<h3>Registering a target using instance IDs</h3> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm register-target-with-maintenance-window
--window-ID mw-0123456789abcdef
--targets &quot;Key=InstanceIds,Values=i-0123456,i-789abcd&quot;
--owner-information &quot;Database servers&quot;
--resource-type &quot;INSTANCE&quot;</pre> 
<h3>AWS Tools for PowerShell</h3> 
<pre>PS&gt; $instanceIdTargets = `
@{Key=&quot;InstanceIds&quot;;Values=@(&quot;i-0123456&quot;,&quot;i-789abcd&quot;)}
PS&gt; Register-SSMTargetWithMaintenanceWindow `
-WindowId &quot;mw-0123456789abcdef&quot; `
-Target $instanceIdTargets `
-OwnerInformation &quot;Database servers&quot; `
-ResourceType &quot;INSTANCE&quot;
</pre> 
<b>Register tasks</b> 
<p>Each task requires an associated role that the maintenance window can assume. In most cases, you can create a single role to use for all tasks. There may also be scenarios where you need to create specific roles for specific tasks, to control more closely the instances and documents that the role is allowed to use. For more information about how to set up a general role to use for tasks in maintenance windows, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-permissions.html">Configuring Roles and Permissions for Maintenance Windows</a>.</p> 
<h3>Registering a task for a target</h3> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm register-task-with-maintenance-window 
--window-ID mw-063b7d9dcd2fac2f0 
--targets &quot;Key=WindowTargetIds,Values=abcdef012-3456-789a-bcde-f0123456789a&quot; 
--task-arn &quot;AWS-RunPowerShellScript&quot; 
--service-role-arn &quot;arn:aws:iam::123456789012:role/mw-task-role&quot; 
--task-type &quot;RUN_COMMAND&quot; 
--task-parameters '{\&quot;commands\&quot;:{\&quot;Values\&quot;:[\&quot;ipconfig.exe\&quot;]}}' 
--max-concurrency 1 
--max-errors 1 
--priority 1</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS&gt; $parameters = @{}
PS&gt; $parameterValues = New-Object Amazon.SimpleSystemsManagement.Model.MaintenanceWindowTaskParameterValueExpression
PS&gt; $parameterValues.Values = @(&quot;ipconfig.exe&quot;)
PS&gt; $parameters.Add(&quot;commands&quot;, $parameterValues)
PS&gt; Register-SSMTaskWithMaintenanceWindow `
-WindowId mw-063b7d9dcd2fac2f0 `
-Target @{ Key=&quot;WindowTargetIds&quot;;Values=&quot;abcdef012-3456-789a-bcde-f0123456789a&quot; } `
-TaskArn &quot;AWS-RunPowerShellScript&quot; `
-ServiceRoleArn &quot;arn:aws:iam::123456789012:role/mw-task-role&quot; `
-TaskType &quot;RUN_COMMAND&quot; `
-TaskParameter $parameters `
-MaxConcurrency 1 `
-MaxError 1 `
-Priority 1</pre> 
<h3>Registering a task for instance IDs</h3> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm register-task-with-maintenance-window 
--window-ID mw-063b7d9dcd2fac2f0 
--targets &quot;Key= InstanceIds,Values=i-0123456,i-789abcd&quot; 
--task-arn &quot;AWS-RunPowerShellScript&quot; 
--service-role-arn &quot;arn:aws:iam::123456789012:role/mw-task-role&quot; 
--task-type &quot;RUN_COMMAND&quot; 
--task-parameters '{\&quot;commands\&quot;:{\&quot;Values\&quot;:[\&quot;ipconfig.exe\&quot;]}}' 
--max-concurrency 1 
--max-errors 1 
--priority 1</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS&gt; $parameters = @{}
PS&gt; $parameterValues = New-Object Amazon.SimpleSystemsManagement.Model.MaintenanceWindowTaskParameterValueExpression
PS&gt; $parameterValues.Values = @(&quot;ipconfig.exe&quot;)
PS&gt; $parameters.Add(&quot;commands&quot;, $parameterValues)
PS&gt; Register-SSMTaskWithMaintenanceWindow `
-WindowId mw-063b7d9dcd2fac2f0 `
-Target @{ Key=&quot;InstanceIds&quot;;Values=&quot;i-0a00def7faa94f1dc&quot; } `
-TaskArn &quot;AWS-RunPowerShellScript&quot; `
-ServiceRoleArn &quot;arn:aws:iam::123456789012:role/mw-task-role&quot; `
-TaskType &quot;RUN_COMMAND&quot; `
-TaskParameter $parameters `
-MaxConcurrency 1 `
-MaxError 1 `
-Priority 1</pre> 
<b>View history</b> 
<p>The history for a maintenance window consists of the following levels of detail:</p> 
<ul> 
<li>Each execution occurrence (one entry each time it runs)</li> 
<li>Each task that was run in each occurrence (one record for each registered task)</li> 
<li>Each task invocation (one record for each defined target)<br /> <strong>Note:</strong> A task with a list of instance IDs as the target turns into a single invocation.</li> 
<li>The actual Run Command invocation details</li> 
</ul> 
<h3>Look at the maintenance window execution history</h3> 
<p>The WindowExecutionId field uniquely identifies a particular execution of a maintenance window and the StartTime field represents the time that the maintenance window was run. The execution ID can be used to get more detail on the tasks run in the maintenance window.</p> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm describe-maintenance-window-executions
--window-ID mw-063b7d9dcd2fac2f0</pre> 
<p>The command returns something similar to the following:</p> 
<pre>{
&quot;WindowExecutions&quot;: [
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;WindowId&quot;: &quot;mw-063b7d9dcd2fac2f0&quot;,
&quot;WindowExecutionId&quot;: &quot;75d4e9fb-20db-4c30-bf73-1a2514f59265&quot;,
&quot;StartTime&quot;: 1479046329.861
},
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;WindowId&quot;: &quot;mw-063b7d9dcd2fac2f0&quot;,
&quot;WindowExecutionId&quot;: &quot;c8a2916b-e1de-46fb-800c-c41a9fd4f63f&quot;,
&quot;StartTime&quot;: 1479047229.861
},
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;WindowId&quot;: &quot;mw-063b7d9dcd2fac2f0&quot;,
&quot;WindowExecutionId&quot;: &quot;16551bd0-df3d-4f9d-827c-15a643492ddd&quot;,
&quot;StartTime&quot;: 1479047588.543
}
]
}</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS &gt; Get-SSMMaintenanceWindowExecutionList `
-WindowId mw-063b7d9dcd2fac2f0</pre> 
<p>The command returns something similar to the following:</p> 
<pre>EndTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/14/2017 17:13:07
StartTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/14/2017 16:01:40
Status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : SUCCESS
StatusDetails&nbsp;&nbsp;&nbsp;&nbsp; :
WindowExecutionId : 75d4e9fb-20db-4c30-bf73-1a2514f59265
WindowId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : mw-063b7d9dcd2fac2f0
EndTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/21/2017 17:02:02
StartTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/21/2017 16:00:27
Status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : SUCCESS
StatusDetails&nbsp;&nbsp;&nbsp;&nbsp; :
WindowExecutionId : c8a2916b-e1de-46fb-800c-c41a9fd4f63f
WindowId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : mw-063b7d9dcd2fac2f0
EndTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/28/2017 17:22:16
StartTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 3/28/2017 16:02:33
Status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : SUCCESS
StatusDetails&nbsp;&nbsp;&nbsp;&nbsp; :
WindowExecutionId : 16551bd0-df3d-4f9d-827c-15a643492ddd
WindowId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : mw-063b7d9dcd2fac2f0
</pre> 
<h3>Look at the tasks performed by a particular maintenance window execution</h3> 
<p>In the examples above, a single task was run in the maintenance window. To get more detailed information about the task, use the TaskExecutionId field.</p> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm describe-maintenance-window-execution-tasks 
--window-execution-ID 75d4e9fb-20db-4c30-bf73-1a2514f59265</pre> 
<p>The command returns something similar to the following:</p> 
<pre>{
&quot;WindowExecutionTaskIdentities&quot;: [
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;TaskArn&quot;: &quot;AWS-RunPowerShellScript&quot;,
&quot;StartTime&quot;: 1479046330.269,
&quot;TaskType&quot;: &quot;RUN_COMMAND&quot;,
&quot;EndTime&quot;: 1479046351.331,
&quot;WindowExecutionId&quot;: &quot;75d4e9fb-20db-4c30-bf73-1a2514f59265&quot;,
&quot;TaskExecutionId&quot;: &quot;219d5326-20e5-4014-b7be-1dc13aa9e85f&quot;
}
]
}</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS &gt; Get-SSMMaintenanceWindowExecutionTaskList `
-WindowExecutionId 75d4e9fb-20db-4c30-bf73-1a2514f59265</pre> 
<p>The command returns something similar to the following:</p> 
<pre>EndTime           : 3/14/2017 17:13:07
StartTime         : 3/14/2017 16:01:40
Status            : SUCCESS
StatusDetails     :
TaskArn           : AWS-RunPowerShellScript
TaskExecutionId   : 219d5326-20e5-4014-b7be-1dc13aa9e85f
TaskType          : RUN_COMMAND
WindowExecutionId : 75d4e9fb-20db-4c30-bf73-1a2514f59265</pre> 
<h3>Look at the invocations for a particular task</h3> 
<p>In addition to the detailed information about the parameters used for the invocation, the <strong>ExecutionId</strong> field also contains the command ID that can be used to get detailed information from Run Command.</p> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm describe-maintenance-window-execution-task-invocations 
--window-execution-ID 75d4e9fb-20db-4c30-bf73-1a2514f59265 
--task-ID 219d5326-20e5-4014-b7be-1dc13aa9e85f</pre> 
<p>This command returns specific information about the Run Command invocation:</p> 
<pre>{
&quot;WindowExecutionTaskInvocationIdentities&quot;: [
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;Parameters&quot;: &quot;{\&quot;documentName\&quot;:\&quot;AWS-RunPowerShellScript\&quot;,\&quot;instanceIds\&quot;:[\&quot;i-09a618aec652973a9\&quot;,\&quot;i-0a00def7faa94f1dc\&quot;,\&quot;i-0fff3aab684d01b23\&quot;],\&quot;parameters\&quot;:{\&quot;commands\&quot;:[\&quot;ipconfig.exe\&quot;]},\&quot;maxConcurrency\&quot;:\&quot;2\&quot;,\&quot;maxErrors\&quot;:\&quot;
3\&quot;}&quot;,
&quot;ExecutionId&quot;: &quot;654eb74d-d1bc-4c32-8d5f-98d1dc602e94&quot;,
&quot;InvocationId&quot;: &quot;824d7b43-cd1c-4f9d-927b-97f147acbfc9&quot;,
&quot;StartTime&quot;: 1479046330.393,
&quot;EndTime&quot;: 1479046351.071,
&quot;WindowExecutionId&quot;: &quot;75d4e9fb-20db-4c30-bf73-1a2514f59265&quot;,
&quot;TaskExecutionId&quot;: &quot;219d5326-20e5-4014-b7be-1dc13aa9e85f&quot;
}
]
}</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS &gt; Get-SSMMaintenanceWindowExecutionTaskInvocationList ` 
-WindowExecutionId 75d4e9fb-20db-4c30-bf73-1a2514f59265 `
-TaskId 219d5326-20e5-4014-b7be-1dc13aa9e85f</pre> 
<p>This command returns specific information about the Run Command invocation:</p> 
<pre>EndTime           : 3/14/2017 17:13:07
ExecutionId       : 654eb74d-d1bc-4c32-8d5f-98d1dc602e94
InvocationId      : 824d7b43-cd1c-4f9d-927b-97f147acbfc9
OwnerInformation  :
Parameters        : {&quot;documentName&quot;:&quot;AWS-RunPowerShellScript&quot;,&quot;commands&quot;:[&quot;ipconfig.exe&quot;],&quot;maxConcurrency&quot;:&quot;1&quot;,&quot;maxErrors&quot;:&quot;1&quot;}
StartTime         : 3/14/2017 16:01:40
Status            : SUCCESS
StatusDetails     : Incomplete
TaskExecutionId   : 219d5326-20e5-4014-b7be-1dc13aa9e85f
WindowExecutionId : 75d4e9fb-20db-4c30-bf73-1a2514f59265
WindowTargetId    :</pre> 
<h3>Get the details of a Run Command invocation</h3> 
<p>To get the specific results from the Run Command invocation (for instance the output of the command), you use the ExecutionId field from the task invocation above with the Run Command ListCommands API.</p> 
<h4>AWS CLI</h4> 
<pre>&gt; aws ssm list-commands --command-ID 654eb74d-d1bc-4c32-8d5f-98d1dc602e94</pre> 
<p>The command returns specific details from Run Command.</p> 
<pre>{
&quot;Commands&quot;: [
{
&quot;Comment&quot;: &quot;&quot;,
&quot;Status&quot;: &quot;Success&quot;,
&quot;MaxErrors&quot;: &quot;3&quot;,
&quot;Parameters&quot;: {
&quot;commands&quot;: [
&quot;ipconfig.exe&quot;
]
},
&quot;ExpiresAfter&quot;: 1479049930.641,
&quot;ServiceRole&quot;: &quot;&quot;,
&quot;DocumentName&quot;: &quot;AWS-RunPowerShellScript&quot;,
&quot;TargetCount&quot;: 3,
&quot;OutputS3BucketName&quot;: &quot;&quot;,
&quot;NotificationConfig&quot;: {
&quot;NotificationArn&quot;: &quot;&quot;,
&quot;NotificationEvents&quot;: [],
&quot;NotificationType&quot;: &quot;&quot;
},
&quot;CompletedCount&quot;: 3,
&quot;Targets&quot;: [],
&quot;StatusDetails&quot;: &quot;Success&quot;,
&quot;ErrorCount&quot;: 0,
&quot;OutputS3KeyPrefix&quot;: &quot;&quot;,
&quot;RequestedDateTime&quot;: 1479046330.641,
&quot;CommandId&quot;: &quot;654eb74d-d1bc-4c32-8d5f-98d1dc602e94&quot;,
&quot;InstanceIds&quot;: [
&quot;i-09a618aec652973a9&quot;,
&quot;i-0a00def7faa94f1dc&quot;,
&quot;i-0fff3aab684d01b23&quot;
],
&quot;MaxConcurrency&quot;: &quot;2&quot;
}
]
}</pre> 
<h4>AWS Tools for PowerShell</h4> 
<pre>PS &gt; Get-SSMCommand –CommandId 654eb74d-d1bc-4c32-8d5f-98d1dc602e94
The command returns specific details from Run Command.
CommandId          : 654eb74d-d1bc-4c32-8d5f-98d1dc602e94
Comment            :
CompletedCount     : 3
DocumentName       : AWS-RunPowerShellScript
ErrorCount         : 0
ExpiresAfter       : 3/14/2017 16:01:40
InstanceIds        : {&quot;i-09a618aec652973a9&quot;,&quot;i-0a00def7faa94f1dc&quot;,&quot;i-0fff3aab684d01b23&quot;}
MaxConcurrency     : 2
MaxErrors          : 3
NotificationConfig : Amazon.SimpleSystemsManagement.Model.NotificationConfig
OutputS3BucketName :
OutputS3KeyPrefix  :
OutputS3Region     :
Parameters         : {[Operation, Amazon.Runtime.Internal.Util.AlwaysSendList`1[System.String]], [commands,                    Amazon.Runtime.Internal.Util.AlwaysSendList`1[System.String]]}
RequestedDateTime  : 3/24/2017 05:37:03
ServiceRole        :
Status             : Success
StatusDetails      : Success
TargetCount        : 3
Targets            : {}</pre> 
<b>Summary</b> 
<p>In this post, I described some of the benefits and helped you get started creating maintenance windows with AWS CLI and PowerShell. Look at the <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-maintenance.html">Systems Manager documentation</a> for more details and keep an eye out for more blog posts about how you can use maintenance windows to automate systems management tasks.<br /> If you have questions or suggestions, please comment below.</p> 
<b>About the Author</b> 
<p>Mats Lann&eacute;r is a Software Development Manager on the Amazon EC2 Systems Manager team, responsible for the Maintenance Window, Patch Manager and Document capabilities. When not working on Systems Manager he enjoys working and hiking with his two German Shepherds.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/maintenance-window/" rel="tag">Maintenance Window</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Getting Started with Patch Manager and Amazon EC2 Systems Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Kevin Yung</span></span> | on 
<time property="datePublished" datetime="2017-05-29T05:33:51+00:00">29 MAY 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/getting-started-with-patch-manager-and-amazon-ec2-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>At last year’s re:Invent, AWS launched&nbsp;<a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a>, which helps you automatically apply OS patches within customized maintenance windows, collect software inventory, and configure Windows and Linux operating systems. These capabilities enable automated configuration and ongoing management of systems at scale and help maintain software compliance for instances running in <a href="https://aws.amazon.com/ec2">Amazon EC2</a> or on-premises.</p> 
<p>One of the capabilities of Systems Manager is Patch Manager, which can automate the process of patching Windows managed instances at scale. With Patch Manager, you can scan instances for missing patches, or scan and install missing patches to individual instances or large groups of instances by using EC2 tags. Patch Manager can also be used with Systems Manager Maintenance Windows, so you can create a schedule to perform patch operations on your instances within a customized maintenance window.</p> 
<p>In this post, I guide you through using Patch Manager to patch your Windows instances. If you run the demo, you are charged for the EC2 resources, but Systems Manager is free of charge.</p> 
<h3>Walkthrough</h3> 
<p>To get on the fast track of experiencing Patch Manager, these examples use newly created Windows EC2 instances. Here are the steps:<span id="more-483"></span></p> 
<ol> 
<li>Launch new Windows instances.</li> 
<li>Create a custom patch baseline.</li> 
<li>Set the patch group for the custom patch baseline.</li> 
<li>Create a maintenance window.</li> 
<li>Register targets for the maintenance window.</li> 
<li>Register a task for the maintenance window.</li> 
<li>Verify the patch compliance report.</li> 
</ol> 
<h4>Prerequisites</h4> 
<p>Make sure you have the following roles created before starting the walkthrough:</p> 
<ul> 
<li>Create an IAM role for EC2 instances</li> 
</ul> 
<p style="padding-left: 30px">Systems Manager requires an IAM role for EC2 instances that will process commands. Follow <strong>Task 2</strong> in <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-configuring-access-policies.html#sysman-configuring-access-role">Configuring Access Using Systems Manager Managed Policies</a>.</p> 
<ul> 
<li>Create an IAM role for Maintenance Windows</li> 
</ul> 
<p style="padding-left: 30px">For Maintenance Windows to send commands to EC2 instances, you must configure an IAM role. Follow the steps in <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-permissions.html">Configuring Access to Maintenance Windows</a>.</p> 
<h4>Step 1: &nbsp;Launch new Windows instances</h4> 
<p>For AWS Windows AMIs, AWS frequently offers fully-patched AMIs. For the details of the patch cycle, see the <em>Keeping Your AMIs Up-to-Date</em> section in <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/AMIs.html#aws-windows-ami">AWS Windows AMIs</a>. If you follow the example and choose to use the latest Windows AMI, it may not have any missing patches.</p> 
<p>Create Amazon EC2 Windows Instances</p> 
<ol> 
<li>To create new Windows instances, follow the <strong>Step 1 </strong>in <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html">Getting Started with Amazon EC2 Windows Instances</a>. Follow the wizard, click <strong>Configure Instance Details</strong> after choosing an instance type. For IAM role, choose the IAM role for EC2 created as a prerequisite.<br /> <img class="aligncenter wp-image-507" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/10-Attach-EC2-IAM-Role-to-newly-luach-EC2.png" alt="" width="450" height="310" /></li> 
<li>Choose <strong>Next: Add Tags</strong> and define EC2 tags as follows: 
<ul> 
<li>First, create a tag called <strong>Patch Group </strong>(required) and a value, such as <strong>Windows Server 2016 Base</strong>. A patch group is an optional means of organizing instances for patching. It defines which patch baseline should be used. If this tag is not defined, and you don’t specify your own default patch baseline, an AWS predefined patch baseline is used instead. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-patch-working.html">Working with Patch Manager</a>.</li> 
<li>Next, create a tag called <strong>Name</strong>, which is used later as a filter in the maintenance window configuration. Enter a value such as <strong>Patch Manager Demo</strong>.<br /> <a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/02-create-tags-for-new-instances.png"><img class="aligncenter wp-image-525" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/02-create-tags-for-new-instances.png" alt="" width="450" height="160" /></a></li> 
</ul> </li> 
</ol> 
<h4>Step 2: &nbsp;Create a custom patch baseline</h4> 
<p>A patch baseline defines which patches should and shouldn’t be installed on your instances. Systems Manager provides a predefined default patch baseline. You can use the predefined baseline or create your own default to meet your patch compliance requirements.&nbsp;For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-patch-working.html">Working with Patch Manager</a>.</p> 
<p>If you are using the default Patch Baseline or any Patch Baseline that contains a rule that approves patches classified as Security Updates with a severity of Critical, the baseline will approve the Mar. 2017 critical security update for Microsoft Windows SMB Server. Please see the following table for the appropriate patches that need to be installed for different Windows versions.</p> 
<table class=" aligncenter" style="border-collapse: collapse;border-spacing: 0" width="300"> 
<tbody> 
<tr> 
<th class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;font-weight: bold;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Version</th> 
<th class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;font-weight: bold;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Relevant KB #</th> 
</tr> 
<tr> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Server 2008</td> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">4018466</td> 
</tr> 
<tr> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Server 2008 R2</td> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">4012212</td> 
</tr> 
<tr> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Server 2012</td> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">4012214</td> 
</tr> 
<tr> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Server 2012 R2</td> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">4012213</td> 
</tr> 
<tr> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">Windows Server 2016</td> 
<td class="tg-031e" style="font-family: Arial, sans-serif;font-size: 14px;padding: 10px 5px;border-style: solid;border-width: 0px;overflow: hidden;border-top-width: 1px;border-bottom-width: 1px">4019472</td> 
</tr> 
</tbody> 
</table> 
<p>In this step, you create a custom baseline to use with the patch group defined earlier, and configure it to approve all Critical and Important security updates for WindowsServer2016 three days after they are released.</p> 
<p>To create a custom baseline</p> 
<ol> 
<li>In the EC2 console, under Systems Manager Services, choose Patch Baselines, Create Patch Baseline.</li> 
<li>In the Create Patch Baseline page, enter values for the patch filters as follows: 
<ul> 
<li>For Product, enter WindowsServer2016.</li> 
<li>For Classification, enter SecurityUpdates.</li> 
<li>For Severity, enter both Critical and Important.</li> 
<li>For Auto Approval Delay, enter 3 days.</li> 
</ul> </li> 
<li>Choose Create Patch Baseline.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/23-create-patch-baseline.png"><img class="aligncenter wp-image-502" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/23-create-patch-baseline.png" alt="" width="450" height="350" /></a></p> 
<h4>Step 3: Set the patch group for the custom patch baseline</h4> 
<p>On the <strong>Patch Baselines</strong> page, you should see the newly created baseline policy called <em>WindowsServer2016</em>.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/31-custom-patch-baseline.png"><img class="aligncenter wp-image-493" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/31-custom-patch-baseline.png" alt="" width="450" height="126" /></a></p> 
<p><strong>To modify</strong><strong> the patch groups for this custom baseline policy</strong></p> 
<ol> 
<li>On the <strong>Patch Baselines</strong> page, for the <em>WindowsServer2016</em> custom baseline, choose <strong>Actions</strong>, <strong>Modify Patch Groups</strong>.</li> 
<li>On the <strong>Modify Patch Groups</strong> page, for <strong>Patch Groups</strong>, add the previously defined patch group <strong>Windows Server 2016 Base</strong>.</li> 
<li>Select the tick to save the entry and choose <strong>Close</strong>.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/16-set-patch-group-for-baseline.png"><img class="aligncenter wp-image-500" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/16-set-patch-group-for-baseline.png" alt="" width="450" height="261" /></a></p> 
<p>Only one patch baseline can be used for each patch group, to ensure that there’s a single set of approved patches for the group. You can, however, use a patch baseline for several patch groups.</p> 
<h4>Step 4: Create a maintenance window</h4> 
<p>The Maintenance Windows feature defines schedules when you are performing potentially disruptive actions, for example Operation System patching, updating drivers, or installing software. Inside the maintenance window, you register targets, which are EC2 instances to be patched, and register a patching tasks to be run.</p> 
<p><strong>To create a maintenance window</strong></p> 
<ol> 
<li>In the EC2 console, under<strong> Systems Manager Shared Resources</strong>, choose <strong>Maintenance Windows</strong>, <strong>Create maintenance window. </strong></li> 
<li>On the <strong>Create maintenance window</strong> page, fill in the name of the maintenance window</li> 
<li>Select a schedule to run the tasks. The format of the schedule can be specified in <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-maintenance-cron.html">CRON expression</a> or you can use the prepared schedule builder to construct a schedule. In this example, I set up a fast feedback loop for demonstration. For <strong>CRON/Rate expression</strong>, enter<em> rate(15 minutes)</em>. For <strong>Duration</strong>, enter <strong>1</strong> For <strong>Stop initiating tasks</strong>, enter 0 for the period before the end of the maintenance window when the system should stop scheduling new tasks to run.</li> 
<li>After filling in the required fields, choose <strong>Create maintenance window </strong>and return to the maintenance window list.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/25-create-maintenance-window.png"><img class="aligncenter wp-image-499" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/25-create-maintenance-window.png" alt="" width="450" height="376" /></a></p> 
<p>&nbsp;</p> 
<h4>Step 5: Register targets for the maintenance window</h4> 
<p>After creating the maintenance window, associate the EC2 instances that will be affected inside the schedule.</p> 
<p><strong>To register a target for the maintenance window</strong></p> 
<ol> 
<li>Choose <strong>Actions</strong>, <strong>Register targets </strong>for the maintenance window created in the previous step.</li> 
<li>On the <strong>Register targets</strong> page, for <strong>Tag Filters</strong>, use the <strong>Name</strong> tag and <strong>Patch Manager Demo </strong>value created earlier. If you have a fleet of instances with the same <strong>Name</strong> tag, but they use different patch baselines, by choosing <strong>Name </strong>tag you can simplify and consolidate their patch exercise within the same maintenance window.</li> 
<li>Choose <strong>Register targets</strong>.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/19-register-target-details.png"><img class="aligncenter wp-image-505" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/19-register-target-details.png" alt="" width="450" height="228" /></a></p> 
<h4>Step 6: Register a task for the maintenance window</h4> 
<p>After the target is registered, register a patch task for the maintenance window.</p> 
<p><strong>To register a task</strong></p> 
<ol> 
<li>Choose <strong>Actions</strong>, <strong>Register task </strong>for the maintenance window created earlier.<br /> <a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/28-register-tasks.png"><img class="aligncenter wp-image-496" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/28-register-tasks.png" alt="" width="450" height="113" /></a></li> 
<li>In the <strong>Register Task</strong> page, for <strong>Document</strong>, select <strong>AWS-ApplyPatchBaseline for Windows platform.</strong> You can narrow down the items by filtering the documents with <strong>Name</strong>.</li> 
<li>For <strong>Task Priority</strong>, specify a priority for this task. Digit 1 is the highest priority. Tasks in a maintenance window are scheduled in priority order. Tasks that have the same priority are scheduled in parallel.</li> 
<li>For <strong>Targets</strong>, select the target created in the previous step.</li> 
<li>For <strong>Parameters</strong>, choose <strong>Install </strong>to instruct the task to install the patch onto the instances. Or, you can choose <strong>Scan</strong> to instruct the task to perform read-only operations.</li> 
<li>Select the role used in the maintenance window created earlier.</li> 
<li>Next, specify how many instances can be patched in parallel, and how many errors are allowed before the patching operation is stopped. For this post, I choose to patch <em>5</em> instances in parallel, and stop patching if <em>1</em> or more errors occur.</li> 
<li>Choose <strong>Register task</strong>.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/29-register-task-for-patch-baseline.png"><img class="aligncenter wp-image-495" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/29-register-task-for-patch-baseline.png" alt="" width="450" height="656" /></a></p> 
<p>&nbsp;</p> 
<p>Now Patch Manager is all set. The patches are applied to the instances during the next scheduled maintenance window.</p> 
<h4>Step 7: Verify the patch compliance report</h4> 
<p>After the initial maintenance task is completed, you should see the result of the tasks in the maintenance window history.</p> 
<p><strong>To see the patch compliance report</strong></p> 
<ol> 
<li>In the EC2 console, under <strong>Systems Manager Services</strong>, choose <strong>Patch Compliance</strong>.</li> 
<li>Review the compliance summary by selected individual instances or choose <strong>Patch Group </strong>to filter instances for the report.<br /> <a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/22-patch-complaince-report.png"><img class="aligncenter wp-image-503" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/22-patch-complaince-report.png" alt="" width="450" height="365" /></a></li> 
<li>To drill down into the patches for an instance, select the link of the instance.</li> 
<li>On the <strong>Managed Instances </strong>page, in the <strong>Patch </strong>pane, the detailed status of each patch is shown.</li> 
</ol> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/30-patch-details-in-instance.png"><img class="aligncenter wp-image-494" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/26/30-patch-details-in-instance.png" alt="" width="450" height="245" /></a></p> 
<h3>Conclusion</h3> 
<p>In this post, I showed you how to get started using Patch Manager and Maintenance Windows to patch Windows Instances.</p> 
<p>If you have questions or suggestions, please comment below.</p> 
<h4>About the author</h4> 
<p><img class="wp-image-541 size-full alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/29/Kevin-Yung.png" alt="" width="165" height="189" /></p> 
<p>Kevin Yung is a Cloud Architect in the Professional Services team in Australia.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/maintenance-window/" rel="tag">Maintenance Window</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-complaince/" rel="tag">Patch Complaince</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-manager/" rel="tag">Patch Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Running Ansible Playbooks using EC2 Systems Manager Run Command and State Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Andres Silva</span></span> | on 
<time property="datePublished" datetime="2017-05-25T13:30:02+00:00">25 MAY 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/running-ansible-playbooks-using-ec2-systems-manager-run-command-and-state-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>If you are running complex workloads on AWS and managing large groups of instances, chances are you are using some form of configuration management. Configuration management tools are effective in automating the deployment and configuration of applications on hybrid instances. However, efficiently managing the distribution and execution of the playbooks or recipes, centrally managing the code, having a secure and scalable deployment mechanism and properly logging system changes is a challenge. To address this, some of our customers use tools like cron, Rundeck or others provided by configuration management vendors.</p> 
<p><a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-state.html">State Manager</a> and <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/execute-remote-commands.html">Run Command</a>, part of <a href="https://aws.amazon.com/ec2/systems-manager/">EC2 Systems Manager</a>, automate management tasks by providing a secure, and easy to use platform to maintain state and remotely execute commands on large groups of instances. Using these tools also addresses many of the common challenges of managing infrastructure at scale. Here are some of the benefits of these tools:</p> 
<ul> 
<li>Better security 
<ul> 
<li>There is no need to open incoming ports to remotely execute the directives. This eliminates the need for using SSH</li> 
<li>You can use IAM to restrict and control access to the platform</li> 
<li>All command execution is audited via AWS Cloudtrail</li> 
</ul> </li> 
<li>Performance and reliability 
<ul> 
<li>Asynchronous execution of commands</li> 
<li>Commands are delivered and executed even when the system comes back from being offline</li> 
<li>Execute at scale by taking advantage of velocity control</li> 
<li>Control deployment rate if errors increase during deployment</li> 
</ul> </li> 
</ul> 
<p>In this blog post, I will show you how to execute configuration management directives using Ansible on your instances using State Manager and Run Command, and the new “AWS-RunAnsiblePlaybook” public document. This document runs Ansible locally on your instances.</p> 
<p><span id="more-469"></span></p> 
<h3>Getting Started</h3> 
<h4>Pre-requisities</h4> 
<ul> 
<li>Target instances must be set up as managed instances. To set up managed instances, please see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-setting-up.html">here</a></li> 
<li>Ansible must be pre-installed on the instances. Please see the following section on installing Ansible</li> 
<li>For Amazon S3 URLs in the playbook field, the <a href="https://aws.amazon.com/cli/">AWS Command line</a> tools must be installed on the target instance or server</li> 
</ul> 
<h4>Installing Ansible on target instances</h4> 
<p>Ansible can be installed as part of the bootstrapping of the instance or with Run Command. The following is some reference information you can use to install Ansible on different Linux distributions:</p> 
<p><span style="text-decoration: underline">Amazon Linux</span><br /> For Amazon Linux Ansible can be installed using pip. You can use the following command.</p> 
Bash 
<pre class=" language-bash"><code class=" language-bash"><span class="token function">sudo</span> pip <span class="token function">install</span> ansible</code></pre> 
<p><span style="text-decoration: underline">Ubuntu</span><br /> For Ubuntu you can install Ansible using the default package manager. Use this command.</p> 
Bash 
<pre class=" language-bash"><code class=" language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ansible <span class="token operator">-</span>y</code></pre> 
<p><span style="text-decoration: underline">RedHat 7</span><br /> For RedHat 7 you can install Ansible by enabling the epel repo. Use the following commands:</p> 
Bash 
<pre class=" language-bash"><code class=" language-bash"><span class="token function">sudo</span> rpm <span class="token operator">-</span>Uvh https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>dl<span class="token punctuation">.</span>fedoraproject<span class="token punctuation">.</span>org<span class="token operator">/</span>pub<span class="token operator">/</span>epel<span class="token operator">/</span>epel<span class="token operator">-</span>release<span class="token operator">-</span>latest<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
<span class="token function">sudo</span> yum <span class="token operator">-</span>y <span class="token function">install</span> ansible</code></pre> 
<h4>Document Parameters</h4> 
<p>The “AWS-RunAnsiblePlaybook” document has a few parameters that can be used to execute playbooks locally:</p> 
<ul> 
<li>Playbook – Use this parameter if you would like to pass the YAML text for the playbook directly</li> 
<li>Playbookurl – Use this parameter if you would like to specify a URL where the playbook file is stored. The URL can be a web (http or https) or an s3 URL in the form of s3://bucket-name/playbook.yml . For s3 URL there is a pre-requisite of the AWS Command line tools</li> 
<li>Extravars – This is a string list of additional variables that will be passed to Ansible for the execution of the playbook</li> 
<li>Check – This flag tells Ansible not to execute the actions of the playbook, but try to predict the outcome and log it. This is helpful for testing playbook execution</li> 
</ul> 
<h4>Workflow</h4> 
<p>The document performs a few checks and then execute the playbook specified in the parameter. Here is a summary of how the logic works:</p> 
<ul> 
<li>Check the Ansible version to determine if Ansible is present on the system. Having Ansible installed is a pre-requisite of this document. See prerequisites section and also the section on installing Ansible</li> 
<li>Determine if the playbook parameter was passed as YAML using the playbook variable text or a URL using the Playbookurl. Based on the input it will copy the data to a temporary playbook file for later execution</li> 
<li>Determine if the check option was selected and based on the input execute the proper ansible-playbook command</li> 
</ul> 
<h3>State Manager Walkthrough</h3> 
<p>Let’s walk through the process of using State Manager to set the desired state for an instance using Ansible Playbook. To understand better how you can use this new public document with State Manager, let’s imagine you have a fleet of servers running Apache. You want to make sure that the web server software is installed and running all the time.</p> 
<p><strong>Step 1: Create Ansible playbook</strong></p> 
<p>This playbook installs Apache and makes sure is running. It has some logic to use different package management tools depending on the operating system:</p> 
YAML 
<pre class=" language-yaml"><code class=" language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
<span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gather ec2 facts
<span class="token key atrule">action</span><span class="token punctuation">:</span> ec2_facts
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install apache on redhat or centos instances
<span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present
<span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == &quot;RedHat&quot;
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install apache on debian or ubuntu instances
<span class="token key atrule">apt</span><span class="token punctuation">:</span> name=apache2 state=present
<span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == &quot;Debian&quot;
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enable apache on startup and start service for redhat or centos
<span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd enabled=yes state=started
<span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == &quot;RedHat&quot;
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enable apache on startup and start service for debian or ubuntu
<span class="token key atrule">service</span><span class="token punctuation">:</span> name=apache2 enabled=yes state=started
<span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == &quot;Debian&quot;
</code></pre> 
<p><strong class="lang-yaml">Step 2: Create State Manager Association</strong></p> 
<p>From the EC2 section of the AWS Console, select “State Manager” from the “System Manager Services” section of the left pane menu, and click on “Create Association”.</p> 
<p>Select the “AWS-RunAnsiblePlaybook” document, your target instances (or tag) and the application schedule. In the Parameters section, since the playbook will be specified as direct YAML text, let’s just paste it on the Playbook field and leave the Playbookurl field empty.</p> 
<p><img class="alignnone wp-image-443" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/doc-parameters.png" alt="" width="588" height="322" /></p> 
<p>In the Extravars field, we can enter any additional variables we would like to pass to the playbook for execution. In this case we are not using any additional variables, so we take the default. Select if you want to use the Check option.<br /> After you click the “Run” button, the console will display the Association ID of this run, which you can to see the result and verify the output from the console.</p> 
<p>After the association runs for the first time, you can see the results of the execution by navigating to the association and looking at the status column. Now every time the association runs it will run the playbook and this in turn will ensure the software is installed and running.</p> 
<h3>Run Command Walkthrough</h3> 
<p>Run Command lets you rate control remote execution by configuring maximum number of concurrent invocations and errors allowed. This feature will set a threshold to detect errors and stop the execution if the threshold is passed.</p> 
<p>Let’s walk through an example of using velocity control when running the AWS-RunAnsiblePlaybook Document. In this example, we will be running the AWS- RunAnsiblePlaybook document on 3 target instances. We will pass the playbook as an s3 URL. To do this you can use the following command:</p> 
Bash 
<pre class=" language-bash"><code class=" language-bash">aws ssm send<span class="token operator">-</span><span class="token function">command</span> <span class="token operator">--</span>document<span class="token operator">-</span>name <span class="token string">&quot;AWS-RunAnsible&quot;</span> <span class="token operator">--</span>instance<span class="token operator">-</span>ids <span class="token string">&quot;i-02f6bdc3d73044db6&quot;</span> <span class="token string">&quot;i-0e6954b9ae36b4b68&quot;</span> <span class="token string">&quot;i-023834f459f1a9fe6&quot;</span> <span class="token operator">--</span>max<span class="token operator">-</span>errors <span class="token number">1</span> <span class="token operator">--</span>parameters '<span class="token punctuation">{</span><span class="token string">&quot;extravars&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">&quot;SSM=True&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;check&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">&quot;False&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;playbook&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">&quot;s3://andress-web/playbook.yml&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>' <span class="token operator">--</span><span class="token function">timeout</span><span class="token operator">-</span>seconds <span class="token number">600</span> <span class="token operator">--</span>region us<span class="token operator">-</span>east<span class="token operator">-</span><span class="token number">1</span></code></pre> 
<p>This command performs the following actions:</p> 
<ul> 
<li>Executes the document AWS- RunAnsiblePlaybook</li> 
<li>Sets the target instances</li> 
<li>Defines the max errors as 1. This means that if the execution encounters 1 error it will stop on the remaining targets</li> 
<li>Passes the parameters for the Ansible document</li> 
<li>It also sets a timeout of 600 seconds</li> 
</ul> 
<h3>Conclusion</h3> 
<p>In this post, we’ve showed you how to use State Manager and Run Command to deploy Ansible playbooks at scale. These tools are secure, easy to use platforms that let you perform remote administration and maintain state of your hybrid instances. You can control the rate at which you send commands, use fine-grained permissions, and use notifications to simplify your workflow.</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img class="alignleft wp-image-453 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Andres-headshot-150x150.jpg" alt="" width="150" height="150" /></p> 
<p>Andres Silva is a Senior Technical Account Manager for AWS Enterprise Support. He has been working with AWS technology for more than 6 years. Andres works with Enterprise customers to design, implement and support complex cloud infrastructures. When he is not building cloud automation he enjoys skateboarding with his 2 kids.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/configuration-management/" rel="tag">Configuration Management</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Use Application Load Balancers with your AWS OpsWorks Chef 12 Stacks</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Kai Rubarth</span></span> | on 
<time property="datePublished" datetime="2017-05-23T08:47:14+00:00">23 MAY 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-ops-works/" title="View all posts in AWS Ops Works"><span property="articleSection">AWS Ops Works</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/use-application-load-balancers-with-your-aws-opsworks-chef-12-stacks/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Want to build scalable applications that take advantage of <a href="https://aws.amazon.com/elasticloadbalancing">Elastic Load Balancing</a> Application Load Balancer features? You could add capabilities such as content-based routing, HTTP/2 and WebSocket protocols, support for containers, and enhanced metrics, and more.</p> 
<p><a href="https://aws.amazon.com/opsworks">AWS OpsWorks</a> Stacks users have been asking AWS how they can use the new Application Load Balancer option with their layer. So AWS decided to develop and open source a set Chef 12 recipes to make this integration simple. This post walks you through the steps required to make any Chef 12 Linux layer in OpsWorks Stacks work with Application Load Balancers.</p> 
<p><span id="more-434"></span></p> 
<b>Walkthrough</b> 
<p>Unless otherwise noted, all steps are completed in the OpsWorks console.</p> 
<b>Overview of the alb_support recipes</b> 
<p><strong>alb_support::attach_to_alb:</strong> &nbsp;This recipe does the actual work of attaching an instance to a target group of an Application Load Balancer. Recipes to be executed during the <strong>Setup</strong> lifecycle event must be added before this recipe, before your instance is attached to an Application Load Balancer.</p> 
<p><strong>alb_support::detach_from_alb: </strong>&nbsp;This recipe detaches instances from the load balancer. Add this recipe to the <strong>Shutdown</strong> lifecycle event. Recipes to be executed after the <strong>Shutdown</strong> lifecycle event must come after this recipe, when the instance is detached from the Application Load Balancer and the connection is drained.</p> 
<p><strong>alb_support::install</strong> and <strong>alb_support::uninstall_http_server:&nbsp; </strong>To give you an easy way to pass the default Application Load Balancer health check, and provide you with a visual indication that the load balancer works as expected, AWS also included sample recipes that install and uninstall an NGINX server on port 80 to serve as a default test page.</p> 
<b>Step 1: &nbsp;Create an Application Load Balancer</b> 
<p><a href="http://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-application-load-balancer.html">Create a simple ALB with a default TCP listener and HTTP health checks performed on port 80</a>. Do not add any instances to the target groups as this is handled by the open source Chef recipes.</p> 
<b>Step 2: &nbsp;Create a Chef 12 stack</b> 
<p><a href="http://docs.aws.amazon.com/opsworks/latest/userguide/gettingstarted-linux-create-stack.html">Create a new Chef 12 stack</a>. Be sure to enable <strong>Use custom Chef cookbooks</strong> and use the following settings:</p> 
<ul> 
<li>For <strong>Repository type</strong>, choose Git.</li> 
<li>For <strong>Repository URL</strong>, use <a href="https://github.com/awslabs/opsworks-example-cookbooks">https://github.com/awslabs/opsworks-example-cookbooks</a>. If you already have a running stack, you can download the <strong>alb_cookbook</strong> from the repository, and merge it into your Chef repository and continue with the next section.</li> 
</ul> 
<b>Step 3: &nbsp;Grant the instances in your stack permission to call the Elastic Load Balancing API</b> 
<ol> 
<li>Choose <strong>Stack Settings</strong>.</li> 
<li>Choose the link next to <strong>Default IAM Instance Profile</strong> to open your instance profile in IAM.</li> 
<li>On the <strong>Permissions</strong> tab, expand <strong>Inline Policies</strong> and choose <strong>create here</strong> to create an inline policy.</li> 
<li>Choose <strong>Custom Policy</strong>, and then choose <strong>Select</strong>.</li> 
<li>Type a name for the policy, paste the following into the <strong>Policy Document</strong> field, and then choose <strong>Apply Policy</strong>.</li> 
</ol> 
<pre><code class="lang-json">{   
&quot;Version&quot;: &quot;2012-10-17&quot;,   
&quot;Statement&quot;: [     
{ 
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;elasticloadbalancing:RegisterTargets&quot;,
&quot;elasticloadbalancing:DeregisterTargets&quot;,
&quot;elasticloadbalancing:DescribeTargetHealth&quot;
],
&quot;Resource&quot;: &quot;*&quot;
}
]
}
</code></pre> 
<b>Step 4:&nbsp; Create and configure an Application Load Balancer layer</b> 
<p><a href="http://docs.aws.amazon.com/opsworks/latest/userguide/layers-elb.html">Create a new layer.</a> Next, use recipes from the open source <strong>alb_support</strong> cookbook to manage layer instance association with your Application Load Balancer.</p> 
<h3>Configure the layer recipes</h3> 
<p>To configure the recipes for your layer, do the following:</p> 
<ul> 
<li>Add <strong>alb_support::install_http_server </strong>and <strong>alb_support::attach_to_alb</strong> to the <strong>Setup</strong> lifecycle event.</li> 
<li>Add <strong>alb_support::detach_from_alb </strong>and <strong>alb_support::uninstall_http_server </strong>to the <strong>Shutdown </strong>lifecycle event.</li> 
</ul> 
<p><img class="aligncenter wp-image-435 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/layer_recipes.png" alt="" width="986" height="353" /></p> 
<h3>Specify your ALB configuration details</h3> 
<p>After you’ve configured the <strong>alb_support</strong> recipes, change the instance shutdown timeout and provide some details via custom JSON.</p> 
<ol> 
<li>On the <strong>Layer Settings</strong> page, enter an <strong>Instance shutdown timeout</strong> that allows enough time for the execution of your shutdown recipes and the connection drainage. I recommend that you specify a period equal to the connection draining timeout (see below), plus the maximum time it takes your post-draining recipes to execute.</li> 
<li>Edit the layer settings and specify the following custom JSON before saving:</li> 
</ol> 
<pre><code class="lang-json">{ 
&quot;alb_helper&quot;: 
{ 
&quot;target_group_arn&quot;: &quot;SPECIFY ARN OF YOUR ALB TARGET GROUP HERE&quot;
} 
}
</code></pre> 
<p>There are two optional parameters you might want to add to the alb_helper JSON block:</p> 
<ul> 
<li><strong>connection_draining_timeout</strong> (default: 750)</li> 
</ul> 
<p>This is the maximum amount time, in seconds, to wait for the Application Load Balancer to drain connections from the instance before executing additional shutdown recipes. You might want to set this value to match the draining timeout of your load balancer. If you do not want to postpone the execution of your shutdown recipes until the instance is drained, specify the parameter with a value of 0.</p> 
<ul> 
<li><strong>state_check_frequency</strong> (default: 30)</li> 
</ul> 
<p>This is the frequency, in seconds, in which to call <strong>EC2::describeTargetHealth</strong> to get an update on the connection draining process.</p> 
<h3>Security</h3> 
<p>To pass the Application Load Balancer health checks, you need to allow incoming HTTP traffic. Choose <strong>Security</strong> on the layer, then add the <strong>AWS-OpsWorks-Web-Server</strong> group to your layer. This layer allows incoming traffic from any source address on port 80.</p> 
<b>Verify your Application Load Balancer</b> 
<p>You’re done! On the <strong>Instances </strong>page of your stack, add a new instance, choose <strong>start</strong>, and wait for it to come online. Now open the Amazon EC2 console and find the DNS name of your Application Load Balancer. When you open the address in your browser, you see the NGINX test page:</p> 
<p><img class="aligncenter wp-image-436 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/nginx_test_page.png" alt="" width="669" height="396" /></p> 
<p>Instances added to the layer are attached automatically to the target group that you specified in the layer’s custom JSON block. Your Application Load Balancer uses health checks to detect unhealthy OpsWorks Stacks instances, and reroutes traffic to the remaining ones until the unhealthy instances have been restored.</p> 
<p>Instances that are terminated have their connections drained and are removed from their assigned Application Load Balancer. The execution of shutdown recipes specified with an order later than <strong>alb_support::detach_from_alb</strong> are postponed until the instance is drained from the Application Load Balancer or the <strong>connection_ draining_timeout</strong> value is exceeded.</p> 
<b>Conclusion</b> 
<p>This post showed how easy it is to integrate an Application Load Balancer with your OpsWorks Stacks application. With the help of the Chef recipes, instances in your layers can automatically be added and removed from an Application Load Balancer. You can extend this example to take advantage of features such as path-based routing, HTTP/2 or WebSocket, container support and advanced metrics.</p> 
<p>If you have questions or suggestions, please comment below.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-opsworks/" rel="tag">AWS OpsWorks</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">More Automation Actions for Amazon EC2 Systems Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Taylor Anderson</span></span> | on 
<time property="datePublished" datetime="2017-05-17T15:04:45+00:00">17 MAY 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/more-automation-actions-for-amazon-ec2-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Recently, AWS released five new <a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a> Automation <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ami-actions.html">actions</a>. These actions allow you to:</p> 
<ul> 
<li>Launch an <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> stack</li> 
<li>Delete the stack</li> 
<li>Insert a delay in your workflow</li> 
<li>Copy and encrypt Amazon Machine Images (AMIs)</li> 
<li>Tag AWS resources</li> 
</ul> 
<p>These actions extend the existing collection of actions, which can be used to orchestrate tasks such as instance launch, OS-level instance configuration and patching, <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function invocation, and AMI creation.</p> 
<p>In this post, I introduce the actions, discuss possible uses, and include examples.</p> 
<p><strong><em>Automation Overview</em></strong></p> 
<p><a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-automation.html">Automation</a> allows you to patch, update agents, or bake applications into an AMI. With Automation, you can avoid the time and effort associated with manual image updates, and instead build AMIs through a streamlined, repeatable, and auditable process. Automation workflows are composed of a series of steps, where each step is based on an action.</p> 
<h3>Automation actions</h3> 
<p>Here are the actions:</p> 
<ul> 
<li><strong>aws:createStack</strong></li> 
<li><strong>aws:deleteStack</strong></li> 
<li><strong>aws:sleep</strong></li> 
<li><strong>aws:createTags</strong></li> 
<li><strong>aws:copyImage</strong></li> 
</ul> 
<p><span id="more-255"></span><br /> <strong>aws:createStack</strong></p> 
<p>Creates a new <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html">CloudFormation stack</a> from a template.</p> 
<p>Use this action when running a workflow that requires creation of AWS resources. An example is a workflow that creates a new AMI and subsequently invokes a Lambda function, where the Lambda function updates an <a href="http://docs.aws.amazon.com/autoscaling/latest/userguide/WhatIsAutoScaling.html">Auto Scaling</a> group’s launch configuration with the new AMI ID.</p> 
<p>By embedding the creation of the Lambda function and the needed IAM permissions directly into the Automation workflow, <strong>aws:createStack</strong> enables a self-contained solution for both automation and resource creation.</p> 
<p><strong>aws:createStack</strong> is also helpful when running an Automation workflow requiring AWS resources in a newly created account. In your primary account, create an Automation workflow as a <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-how-to-share.html">shared Systems Manager document</a>, then execute the workflow locally in each account.</p> 
<p>The following example shows an Automation step of type <strong>aws:createStack</strong>:</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;makeStack&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:createStack&quot;,
&nbsp;&nbsp;&nbsp;&quot;maxAttempts&quot;:1,
&nbsp;&nbsp;&nbsp;&quot;onFailure&quot;:&quot;Abort&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Capabilities&quot;:[&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;CAPABILITY_IAM&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;StackName&quot;:&quot;myStack&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;TemplateURL&quot;:&quot;http://s3.amazonaws.com/mybucket/myStackTemplate&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;TimeoutInMinutes&quot;:5
&nbsp;&nbsp;&nbsp;}
}</pre> 
<p>&nbsp;</p> 
<p><strong>aws:deleteStack</strong></p> 
<p>Deletes a CloudFormation stack.</p> 
<p>To complete the example above, you can add the <strong>aws:deleteStack</strong> step to your workflow to remove all resources created during the execution of the Automation workflow.</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;deleteStack&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:deleteStack&quot;,
&nbsp;&nbsp;&nbsp;&quot;maxAttempts&quot;:1,
&nbsp;&nbsp;&nbsp;&quot;onFailure&quot;:&quot;Abort&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;StackName&quot;:&quot;{{stackName}}&quot;
&nbsp;&nbsp;&nbsp;}
}</pre> 
<p>&nbsp;</p> 
<p><strong>aws:sleep</strong></p> 
<p>Delays Automation execution for a specified amount of time.</p> 
<p>Use this action to insert a delay in your workflow. You can set the delay over a specific duration, or until a specific time is reached. Let’s say you have multiple Run Command steps of type <strong>aws:runCommand</strong> that you’re running to configure an instance, and you’d like to ensure a pause between them. Using <strong>aws:sleep</strong>, you can insert a delay.</p> 
<p>The following examples show how to define the sleep interval using either a duration or timestamp―both are formatted following <a href="https://www.iso.org/iso-8601-date-and-time-format.html">ISO 8601</a>.</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Duration&quot;:&quot;PT10M&quot;
&nbsp;&nbsp;&nbsp;}
}</pre> 
<p>Duration passed in as a parameter:</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Duration&quot;:&quot;PT{{delayInMinutes}}M&quot;
&nbsp;&nbsp;&nbsp;}
}</pre> 
<p>Using a timestamp to terminate the sleep interval:</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:sleep&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Timestamp&quot;:&quot;2020-01-01T01:00:00Z&quot;
&nbsp;&nbsp;&nbsp;}
}
</pre> 
<h3></h3> 
<p><strong>aws:createTags</strong><br /> Creates new tags for resources such as Amazon EC2 instances or Amazon Machine Images (AMIs).</p> 
<p>Tagging is a popular way to keep track of AMIs. With <strong>aws:createTags</strong>, your workflow can tag images after it creates them. Similarly, you can use tags to keep track of any temporary instances created by your workflow. In the event that your workflow ceases before terminating the instances, your tagged temporary instances are easier to track down.</p> 
<p>The following example shows how to tag an AMI and an instance as production resources for a particular department:</p> 
<pre>{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&quot;name&quot;:&quot;createTags&quot;,
&nbsp;&nbsp;&nbsp;&quot;action&quot;:&quot;aws:createTags&quot;,
&nbsp;&nbsp;&nbsp;&quot;maxAttempts&quot;:3,
&nbsp;&nbsp;&nbsp;&quot;onFailure&quot;:&quot;Abort&quot;,
&nbsp;&nbsp;&nbsp;&quot;inputs&quot;:{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ResourceType&quot;:&quot;EC2&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ResourceIds&quot;:[&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ami-9a3768fa&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;i-02951acd5111a8169&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Tags&quot;:[&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Key&quot;:&quot;production&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Value&quot;:&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Key&quot;:&quot;department&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Value&quot;:&quot;devops&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp;}
}</pre> 
<p>&nbsp;</p> 
<p><strong>aws:copyImage</strong><br /> Copies an AMI from any region into the current region. This action can also encrypt the new AMI.</p> 
<p>An example use case is to copy images across regions. To automate the process, you can use a Lambda function to post to an SNS topic upon the creation of a new image in the source region. A Lambda function in the target region is then trigged by this topic, and invokes Automation to copy the image. After you’ve copied the shared image, you can encrypt using a second <strong>aws:copyImage</strong> action in the workflow.</p> 
<p>The following example creates a copy of an AMI from the Seoul region. The new AMI is copied to the region where you initiated the Automation action.</p> 
<pre> { 
&quot;name&quot;: &quot;createEncryptedCopy&quot;,
&quot;action&quot;: &quot;aws:copyImage&quot;,
&quot;maxAttempts&quot;: 3,
&quot;onFailure&quot;: &quot;Abort&quot;,
&quot;inputs&quot;: {
&quot;SourceImageId&quot;: &quot;ami-0fe10819&quot;,
&quot;SourceRegion&quot;: &quot;ap-northeast-2&quot;,
&quot;ImageName&quot;: &quot;Encrypted copy of LAMP base AMI in ap-northeast-2&quot;,
&quot;Encrypted&quot;: false
} 
} 
</pre> 
<h3></h3> 
<h3>Summary</h3> 
<p>In this post, I discussed five recently released Automation actions that can help you orchestrate even more tasks with other AWS services.</p> 
<p>Before creating your own Automation workflow, try the <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ami-consolewalk.html">Getting Started Walkthrough</a> and run your first workflow using a AWS-managed Automation document. Then, try <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ami-createdoc.html">creating your own workflow</a>, using <a href="https://aws.amazon.com/blogs/aws/streamline-ami-maintenance-and-patching-using-amazon-ec2-systems-manager-automation/">AWS-UpdateLinuxAmi</a> or AWS-UpdateWindowsAmi (coming soon!) as a template.</p> 
<h3></h3> 
<p>&nbsp;</p> 
<h3>About the author</h3> 
<p>Taylor Anderson is a product manager for EC2 Systems Manager. When he’s not working on new hybrid-cloud management tools, he enjoys spending time writing code for Arduino projects, or kiteboarding the waters of Puget Sound.</p> 
<p><img class="alignnone size-full wp-image-289" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/17/badgephoto.jpeg" alt="" width="119" height="160" /></p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a></span> 
</footer> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
