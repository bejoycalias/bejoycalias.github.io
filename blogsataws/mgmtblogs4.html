<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a</p>
<br>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Secure, Scalable, and Efficient Instance Management Using Amazon EC2 Run Command</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-08-08T13:50:03+00:00">08 AUG 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/secure-scalable-and-efficient-instance-management-using-amazon-ec2-run-command/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><em>This post was written by Miguel Jo&atilde;o, Cloud Software Engineer at OutSystems.</em></p> 
<p>The OutSystems low-code development platform allows users to create and deliver high-quality web and mobile apps a lot faster, leveraging all the advantages of visual programming with few of the drawbacks. Of course, providing this high productivity, enterprise-grade <a href="https://en.wikipedia.org/wiki/Platform_as_a_service">Platform-as-a-Service</a> (PaaS) solution can be challenging. For us at OutSystems, those challenges ended up inspiring us to build custom solutions to manage large infrastructures.</p> 
<p>We were working on a custom offer for clients that would enable them to build their tailored apps. That led us to deploy our own orchestration processes.</p> 
<li>Instead of only using the common configuration management tools, we had to deploy a <strong>custom remote command execution environment</strong>. This resulted in a tight control over all the steps in the deployment and configuration of the infrastructure.</li> 
<li>We needed to provide an <strong>enterprise-grade PaaS solution with secure access, data integrity, and high availability</strong>.</li> 
<li>This solution must scale to meet future demand, and for the long run we’re talking about <strong>1M+ instances</strong>.</li> 
<li>We had to <strong>ensure a path for the solution to evolve</strong> without disrupting the customer service.</li> 
<p>Sounds complicated, right? Well, it was, especially when you consider that we had to apply our custom environment to an existing underlying infrastructure while keeping the security, isolation, and evolution requirements.</p> 
<p>The end result was a leaner and more secure solution. <a href="https://aws.amazon.com/ec2/run-command">Amazon EC2 Run Command</a> service improved the stability of our orchestration processes (error ratio reduction of over 80%), and the performance (10–20 times faster).</p> 
<p><span id="more-1024"></span></p> 
<h3>Problem: Difficult to manage instance proliferation</h3> 
<p>We designed with the standardization of the underlying infrastructure that supports our PaaS offer in mind. However, the need to respond to the specific needs of our enterprise customers led to the development of an orchestration process that takes advantage of configuration management tools like Chef for the initial and base configuration. Afterwards, we extended that orchestration to support the customization using on-demand remote command execution.</p> 
<p>The adoption of these orchestration processes in our cloud services has grown, and it now supports all of our paid and free PaaS offers, and some of our R&amp;D internal development quality assurance requirements.</p> 
<p>We currently provision <a href="https://aws.amazon.com/ec2/">EC2</a> instances and <a href="https://aws.amazon.com/rds/">Amazon RDS</a> instances to meet our needs in six different AWS Regions, in an automated fashion, 24/7. Our current infrastructure landscape consists of more than a thousand EC2 instances, and hundreds of RDS instances with many different software versions and software configurations. We have Windows and Linux operating systems, and at least two database flavors: Microsoft SQL Server and Oracle. This graphic shows the management nightmare for which we signed up.</p> 
<p><img class="size-full wp-image-1030 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/01/infra_growth-1.png" alt="" width="500" height="327" /></p> 
<h3>Temporary solution (not scalable): SSH and ESB</h3> 
<p>Early in the PaaS project, we determined that direct remote commands would control the infrastructure servers, and we designed the orchestration processes to support that.</p> 
<p>The result was a remote command architecture with an <a href="https://en.wikipedia.org/wiki/Enterprise_service_bus">Enterprise Service Bus (ESB)</a> and <a href="https://en.wikipedia.org/wiki/Secure_Shell">secure shell connections (SSH)</a>. The ESB served as a central point of convergence for all remote connections managing the cloud servers, allowing remote commands to be executed through a synchronous SSH. The orchestration processes invoke the remote command execution via the ESB, and expect a callback from the ESB when the command finishes executing.</p> 
<p><img class="size-full wp-image-1034 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/01/old_arch.png" alt="" width="450" height="303" /></p> 
<p>However, this solution rapidly began to show its limitations:</p> 
<li><strong>Performance overhead</strong> due to connection handshake and authentication</li> 
<li><strong>Increased error rate</strong> due to <strong>instability</strong> in the network and long standing connections</li> 
<li><strong>Limited parallelism</strong> due to concurrent number of remote long standing connections in the ESB (we started to see instability after 40 concurrent remote executions per ESB node)</li> 
<li><strong>Security concerns</strong> about having SSH inbound traffic on the instances for orchestration purposes, and all the hassle of managing the SSH authentication best practices (keys vs. passwords)</li> 
<p>With the growth in demand for our cloud services, we had to consider other options immediately. Before we committed to searching for or developing better alternatives that would scale for 1M+ instances, AWS answered our prayers with the <a href="https://aws.amazon.com/ec2/run-command/">EC2 Run Command</a> feature.</p> 
<h3>Better solution: Scalable, secure remote commands</h3> 
<p>After a short assessment of Run Command, we realized that it would allow us to greatly improve our efforts and our custom orchestration systems, increasing both reliability and performance. We started changing our orchestration to use this new feature, and replaced the remote command execution engine with Run Command.</p> 
<p><img class="size-full wp-image-1035 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/01/new_arch.png" alt="" width="450" height="304" /></p> 
<p>Sending the remote command through Run Command removed the SSH connectivity requirement, eliminating security concerns. The feature also keeps network instability concerns at bay because keeping long-standing connections during the command execution is no longer necessary. It’s all asynchronous.</p> 
<p>The most significant changes in our orchestration were:</p> 
<li>Roll out (re-create) EC2 instances with <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">IAM</a> roles</li> 
<li>Deploy updated EC2Config and SSM Agent services on the EC2 instances</li> 
<li>Implement the callback after execution end, based on the S3 output files, using an AWS Lambda function that runs when a new output file is created</li> 
<li>Change our orchestration command execution engine module to invoke Run Command (using SSM API)</li> 
<p>We were able to evaluate, design, develop, test, and deploy the changes to our orchestration processes in approximately two months. This opened the door to a new growth spurt in our cloud services, mainly because the parallelism limitations were gone.</p> 
<h3>Replacing the ESB services: Additional details</h3> 
<p>We had our system architected to be modular, so replacing the ESB services with the Run Command services seemed like it would be straightforward. But as with any new development, we had to deal with some unexpected challenges. No straightforward replacement—after all, where would be the fun in that?</p> 
<li>To use Run Command, each EC2 instance had to have an associated instance role. Unfortunately, at the time, it was not possible to associate an IAM role with a running instance. Instead, we re-created about 80% of our EC2 instances to activate Run Command. Thankfully, <a href="https://aws.amazon.com/about-aws/whats-new/2017/02/new-attach-an-iam-role-to-your-existing-amazon-ec2-instance/">it is now possible</a> to add an instance role to an existing EC2 instance without having to re-create it</li> 
<li>Run Command requires agents installed in the EC2 instances. However, the configuration and execution outputs of these agents differ between Windows and Linux systems. At the time, to use Run Command on Windows, we needed to have the EC2Config service running. For Linux, we needed the SSM Agent service. These two different applications require different configurations, and as such, the output log files prefixes in the S3 output bucket were also different. So, we had to make allowances for these differences as part of the process. Nowadays, the <span style="text-decoration: underline">SSM Agent service is available for both Windows and Linux</span>, which simplifies the configurations and eases the setup between different operating systems</li> 
<li>Managing the S3 bucket access across the few hundred different AWS accounts that require specific permissions is practically impossible. We had to get creative with the S3 bucket management for the Run Command outputs.<br /> Using a single bucket, each output log would be owned by the account hosting the EC2 instance where the log ran. No other user could access it, so we created a secondary S3 bucket and moved the output logs from the original bucket, fixing the object permissions. This way, we could keep the output logs secured in a bucket with restricted accesses, not allowing the instances to access it anymore. In the meantime, <span style="text-decoration: underline">new versions of the SSM Agent support changing the output log ownership in the bucket</span>.</li> 
<p>After it was all up and running, magic started to happen. Before, with the ESB solution, our average error rate was usually up to 5%, and it increased to over 20% during the second half of 2016. This growing error rate was a reflex of the ESB solution not keeping up with the growing demand. When we started using Run Command, the average error ratio dropped to values below 1%, regardless of the growth in demand. It seriously made our lives better, as you can see in the stability comparison:</p> 
<p><img class="size-full wp-image-1053 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/01/stability-1.png" alt="" width="505" height="330" /></p> 
<p>Additionally, the Run Command solution improved the remote command execution average time by one order of magnitude: from 10 to 20 times faster. The solution allowed us to remove the bottlenecks in the ESB and the SSH connections, as well as improve stability by reducing the error rate. Here’s the performance comparison so you don’t have to take our word for it:</p> 
<p><img class="size-full wp-image-1052 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/01/performance.png" alt="" width="505" height="330" /></p> 
<p>The new Run Command feature responded as advertised. The end result is a faster, leaner, and more robust remote command execution engine that complies with our on-demand custom configuration orchestration requirements.</p> 
<h3>About the Author</h3> 
<p><a href="https://www.linkedin.com/in/migueljoao/">Miguel Jo&atilde;o</a><img class="alignleft size-full wp-image-1109" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/08/miguel.jpg" alt="" width="119" height="130" /> joined OutSystems R&amp;D in 2005, and became a Cloud Software Engineer in 2013. Since then, he’s been working on the Platform-as-a-Service offer of the industry-leading, low-code platform for mobile and web application development. Miguel is a technology enthusiast, and he is passionate about automation.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<hr /> 
<p><img class="alignnone wp-image-1111 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/08/08/oustsystems-logo-1.png" alt="" width="300" height="64" /></p> 
<hr /> 
<p><em>AWS is not responsible for the content or accuracy of this post. The content and opinions in this blog are solely those of the third party author. </em></p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Supercharge Multi-Account Management with AWS CloudFormation</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Adam McLean</span></span> | on 
<time property="datePublished" datetime="2017-08-04T10:17:17+00:00">04 AUG 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/supercharge-multi-account-management-with-aws-cloudformation/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>As your use of Amazon Web Services evolves, you will probably outgrow your first account, and need to move into a multi-account model.</p> 
<p>There are plenty of benefits to using more than one AWS account:</p> 
<li><b>An administrative boundary:</b> I can choose how permissive or restrictive my policies are based on the account type. Separating user authority within an account can be complicated and error prone. Using separate accounts is often the answer.</li> 
<li><b>A workload boundary:</b> I can choose to peer (or not to peer) various workloads together within accounts, ensuring that my ‘blast radius’ for a poorly behaved application is minimized.</li> 
<li><b>A billing entity:</b> Detailed bills are generated at an account level. An account has higher ‘resolution’ than is afforded by billing tags, and can be easier to implement.</li> 
<p>However, management complexities increase using multiple accounts. How do you manage the administrative boundaries? Who can log in and how? How do you manage your baseline infrastructure, such as VPCs and CloudTrail? Is it possible to deploy these by hand and not make potentially critical mistakes?</p> 
<p>In this blog post I’ll explore ways to manage deployments in your multi-account AWS environment.</p> 
<p><span id="more-917"></span></p> 
<p>The broad answer to the questions above is to use infrastructure as code, and tools like <a title="AWS CloudFormation" href="https://aws.amazon.com/cloudformation" target="_blank" rel="noopener noreferrer">AWS CloudFormation</a>. CloudFormation gives you a language to describe your desired state, and have it implemented programmatically. For complex multi-account deployments, this can get difficult to manage quickly, especially for complex subjects such as IAM users, groups, polices, and roles.</p> 
<p>The recent release of <a title="AWS Orgnizations" href="https://aws.amazon.com/organizations/" target="_blank" rel="noopener noreferrer">AWS Organizations</a> has certainly helped with this complexity. Using policies, you can broadly permit or deny service use within your AWS account organizational structure. Layering these capabilities with consistently deployed IAM elements gets the most value from a multi-account model.</p> 
<b>A tool to help</b> 
<p>I’d like to introduce a tool I wrote while working with multiple AWS customers as a Professional Services Consultant. This tool allows you to describe complex multi-account IAM elements using simple YAML, and Jinja2 templates. Running a build produces a CloudFormation template per account that can be deployed in your preferred fashion.</p> 
<p>Some customers have even built a pipeline so that when the configuration YAML is changed, a build is run and deployed automatically. They’re managing multiple accounts completely hands-off, from a central source of truth!</p> 
<p>I’ll discuss the tool a bit. First, the tool assumes that you’re using a ‘parent’ account model where everyone logs in, or federates, into a single account. Then, users assume roles in the ‘child’ accounts for which they have permissions. This model was explored in more detail by an AWS customer with hundreds of accounts. For more information, see <a title="SEC315" href="https://youtu.be/CY-xvo8Cc54" target="_blank" rel="noopener noreferrer">(SEC315) AWS Directory Service Deep Dive</a> re:Invent session video.</p> 
<p>I’ve included a simplification of the model for reference. Your child accounts can be one or many.</p> 
<p><img class="alignnone size-medium wp-image-926" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/Parent-Child-Account-Model.png" alt="" width="708" height="303" /></p> 
<b>Tool walk-through</b> 
<h3>Prerequisites</h3> 
<p>To go through this walkthrough, you need the following:</p> 
<li>A bash environment</li> 
<li>A Python 2.7 interpreter</li> 
<li>At least two AWS accounts that you can experiment with. You can use AWS Organizations to create them programmatically</li> 
<li>The <a title="Tropsophere" href="https://github.com/cloudtools/troposphere" target="_blank" rel="noopener noreferrer">troposphere</a> and the <a title="Tropsophere" href="https://github.com/pallets/jinja" target="_blank" rel="noopener noreferrer">jinja2</a> libraries installed</li> 
<pre><code class="lang-bash">
sudo pip install troposphere
sudo pip install jinja2
</code></pre> 
<h3>Download the code</h3> 
<p>Clone or download the project from /awslabs/ on GitHub:</p> 
<pre><code class="lang-bash">
git clone git@github.com:awslabs/aws-iam-generator.git
</code></pre> 
<h3>Build your configuration file</h3> 
<p>Start with a simple configuration and grow it over time, as you would naturally evolve your AWS environment.</p> 
<p>Create a file called config.yaml in the downloaded projects root directory. Cut and paste the example configuration below into the file. <b>Substitute the account IDs with the account IDs that you’re using for this walkthrough.</b></p> 
<pre><code class="lang-yaml">
---
accounts:
central:
# Change to the ID of your central parent account.
id: 012345678910
parent: true
lab:
# Change to the ID of a child account for specific roles.
id: 109876543210
policies:
AssumeLabPowerUser:
description: Allow assumption of the PowerUser Role in the lab account
assume:
roles:
- PowerUser
accounts:
# Use the name you've given your account in the 'accounts' section.
- lab
in_accounts:
# Use the keyword 'parent' to match the account that has 'parent: true'
- parent
roles:
PowerUser:
trusts:
- parent
managed_policies:
- arn:aws:iam::aws:policy/PowerUserAccess
in_accounts:
# Use the keyword 'children' to match all accounts except the one marked 'parent: true'
- children
groups:
LabUsers:
managed_policies:
- arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials
- arn:aws:iam::aws:policy/IAMUserChangePassword
- arn:aws:iam::aws:policy/IAMUserSSHKeys
- arn:aws:iam::aws:policy/IAMReadOnlyAccess
- AssumeLabPowerUser
in_accounts:
- parent
users:
TestUser:
groups:
- LabUsers
in_accounts:
- parent
</code></pre> 
<h3>What happens now?</h3> 
<p>Because you have two accounts, expect two CloudFormation templates to be created.</p> 
<p>The CloudFormation template for your <code>central</code> account should contain:</p> 
<li>A managed policy called <code>AssumeLabPowerUser</code>. The policy document permits sts::AssumeRole on your child account.</li> 
<li>A group called <code>LabUsers</code>. This group has built-in AWS policies attached to it to allow self service credential management. It also has the <code>AssumeLabPowerUser</code> policy attached that you created under the <code>policies:</code> section.</li> 
<li>A user called <code>TestUser</code> who is a member of the <code>LabUser</code> group.</li> 
<p>The CloudFormation template for your <code>lab</code> account should contain:</p> 
<li>A role called <code>PowerUser</code>. This role has a trust document that allows it to be assumed from the <code>central</code> account. The roles policy document is modeled from the AWS built-in PowerUserAccess policy document.</li> 
<h3>Run the build</h3> 
<p>Executing the build.py script reads the contents of the config.yaml file and creates CloudFormation templates in your output_templates/ directory. If the build is successful, you won’t see any output. When a build fails, the output should produce an meaningful error to help figure out what’s wrong. Most of the time, the problem is in the yaml formatting (usually, indentation).</p> 
<pre><code class="lang-bash">
python build.py
</code></pre> 
<p>If your build ran, you should see output in the <code>output_templates/</code> directory</p> 
<pre><code class="lang-bash">
ls -l output_templates/
-rw-r--r-- 1 user user Users 3367 Apr 10 10:14 central(012345678910)-IAM.template
-rw-r--r-- 1 user user Users 1680 Apr 10 10:14 lab(109876543210)-IAM.template
</code></pre> 
<p>You can see both of your CloudFormation templates. They are named so that you can easily identify the account in which they should be run. Also notice that your <code>central</code> template is about double the size of the <code>lab</code> template. This is expected as <code>central</code> contains a lot more information.</p> 
<h3>Explore the output</h3> 
<p>View the <code>central</code> template in your favorite viewer.</p> 
<p>Your managed policy is there, with the sts::AssumeRole correctly formed:</p> 
<pre><code class="lang-json">
...
&quot;AssumeLabPowerUser&quot;: {
&quot;Properties&quot;: {
&quot;Description&quot;: &quot;Allow assumption of the PowerUser role in the lab account&quot;,
&quot;Groups&quot;: [],
&quot;PolicyDocument&quot;: {
&quot;Statement&quot;: [
{
&quot;Action&quot;: &quot;sts:AssumeRole&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Resource&quot;: &quot;arn:aws:iam::109876543210:role/PowerUser&quot;
}
],
&quot;Version&quot;: &quot;2012-10-17&quot;
},
&quot;Roles&quot;: [],
&quot;Users&quot;: []
},
&quot;Type&quot;: &quot;AWS::IAM::ManagedPolicy&quot;
},
...
</code></pre> 
<p>You can also see the group that uses this managed policy:</p> 
<pre><code class="lang-json">
....
&quot;LabUsersGroup&quot;: {
&quot;Properties&quot;: {
&quot;GroupName&quot;: &quot;LabUsers&quot;,
&quot;ManagedPolicyArns&quot;: [
&quot;arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials&quot;,
&quot;arn:aws:iam::aws:policy/IAMUserChangePassword&quot;,
&quot;arn:aws:iam::aws:policy/IAMUserSSHKeys&quot;,
&quot;arn:aws:iam::aws:policy/IAMReadOnlyAccess&quot;,
{
&quot;Ref&quot;: &quot;AssumeLabPowerUser&quot;
}
],
&quot;Path&quot;: &quot;/&quot;,
&quot;Policies&quot;: []
},
&quot;Type&quot;: &quot;AWS::IAM::Group&quot;
}
...
</code></pre> 
<p>Finally, your user is here as a member of the group you’ve created:</p> 
<pre><code class="lang-json">
...
&quot;TestUserUser&quot;: {
&quot;Properties&quot;: {
&quot;Groups&quot;: [
&quot;LabUsers&quot;
],
&quot;ManagedPolicyArns&quot;: [],
&quot;Path&quot;: &quot;/&quot;,
&quot;Policies&quot;: [],
&quot;UserName&quot;: &quot;TestUser&quot;
},
&quot;Type&quot;: &quot;AWS::IAM::User&quot;
}
...
</code></pre> 
<p>When you view the <code>lab</code> template, you can see the PowerUser role that you’re permitted to assume, with the trust set correctly to the parent.</p> 
<pre><code class="lang-json">
...
&quot;PowerUserRole&quot;: {
&quot;Properties&quot;: {
&quot;AssumeRolePolicyDocument&quot;: {
&quot;Statement&quot;: [
{
&quot;Action&quot;: &quot;sts:AssumeRole&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;arn:aws:iam::012345678910:root&quot;
}
}
],
&quot;Version&quot;: &quot;2012-10-17&quot;
},
&quot;ManagedPolicyArns&quot;: [
&quot;arn:aws:iam::aws:policy/PowerUserAccess&quot;
],
&quot;Path&quot;: &quot;/&quot;,
&quot;Policies&quot;: [],
&quot;RoleName&quot;: &quot;PowerUser&quot;
},
&quot;Type&quot;: &quot;AWS::IAM::Role&quot;
}
...
</code></pre> 
<h3>Deploy in your accounts</h3> 
<p>Deploy the CloudFormation templates in your favorite way, either through the console or the <a title="AWS CLI" href="https://aws.amazon.com/cli" target="_blank" rel="noopener noreferrer">AWS CLI</a>. I’ve included example CLI commands.</p> 
<p>To use multiple accounts from the AWS CLI, configure profiles. For more information about setting up profiles, see <a title="Configuring the AWS CLI" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html#cli-multiple-profiles" target="_blank" rel="noopener noreferrer">AWS CLI</a>.</p> 
<p>Deploy in your <code>central</code> account. <b>Substitute your –template-body –profile and –region accordingly.</b></p> 
<pre><code class="lang-bash">
aws cloudformation create-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/central(012345678910)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile central \
--region us-east-2
</code></pre> 
<p>Deploy in your <code>lab</code> account. <b>Substitute your –template-body –profile and –region accordingly.</b></p> 
<pre><code class="lang-bash">
aws cloudformation create-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/lab(109876543210)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile lab \
--region us-east-2
</code></pre> 
<h3>Explore the results</h3> 
<p>Sign into the <code>central</code> account with an existing role or user and <a title="Set the password" href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords_admin-change-user.html" target="_blank" rel="noopener noreferrer">set the password</a> for the <code>TestUser</code> user. You could have set a password in the CloudFormation template, but then it would be in plaintext!</p> 
<p>Sign into the <code>central</code> account as <code>TestUser</code>. Verify that you have read-only access. You should be able to self-manage your credentials though (set your own password, etc.).</p> 
<p>Now, switch roles to the <code>PowerUser</code> role in the <code>lab</code> account. Switching roles can be done through the console. For more information, see <a title="Switching to a Role" href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-console.html" target="_blank" rel="noopener noreferrer">Switching to a Role</a> (AWS Management Console).</p> 
<p>Confirm that you can now perform expected activities in the <code>lab</code> account. You should be able to create resources, as per the PowerUserAccess reference policy.</p> 
<b>Add a new account</b> 
<p>A new line of business has decided to use AWS and has asked for a new lab environment. You used AWS Organizations to create a new account for them. Now, bring their IAM policies up to the central standard.</p> 
<p>Edit config.yaml and add the new account:</p> 
<pre><code class="lang-yaml">
---
accounts:
central:
# Change to the ID of the central parent account.
id: 012345678910
parent: true
lab:
# Change to the ID of the child account.
id: 109876543210
newlab:
# Change to the ID of the new account created using Organizations.
id: 543210123456
...
</code></pre> 
<p>This automatically creates the <code>PowerUser</code> role definition in the <code>newlab</code> account because you’ve used a keyword of <code>children</code> in the <code>in_accounts</code> section of the <code>PowerUser</code> role definition. This is a great way to assure that roles are kept consistent across all accounts. Only the users who can assume those roles change.</p> 
<p>You also need to create a managed policy, group, and a test user in the <code>central</code> account to make use of the new account.</p> 
<p>For reference your config.yaml should now look like this:</p> 
<pre><code class="lang-yaml">
---
accounts:
central:
# Change to the ID of the central parent account.
id: 012345678910
parent: true
lab:
# Change to the ID of the child account.
id: 109876543210
newlab:
# Change to the ID of the new account created using Organizations.
id: 543210123456
policies:
AssumeLabPowerUser:
description: Allow assumption of the PowerUser role in the lab account
assume:
roles:
- PowerUser
accounts:
- lab
in_accounts:
- parent
# The new managed policy lets users assume PowerUser in the newlab account.
AssumeNewLabPowerUser:
description: Allow assumption of the PowerUser role in the newlab account
assume:
roles:
- PowerUser
accounts:
# Here is the new account added in the accounts section
- newlab
in_accounts:
- parent
roles:
PowerUser:
trusts:
- parent
managed_policies:
- arn:aws:iam::aws:policy/PowerUserAccess
in_accounts:
# Because you use the keyword 'children' here, the newlab account gets this role
- children
groups:
LabUsers:
managed_policies:
- arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials
- arn:aws:iam::aws:policy/IAMUserChangePassword
- arn:aws:iam::aws:policy/IAMUserSSHKeys
- arn:aws:iam::aws:policy/IAMReadOnlyAccess
- AssumeLabPowerUser
in_accounts:
- parent
# This group services the newlab account users.
NewLabUsers:
managed_policies:
- arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials
- arn:aws:iam::aws:policy/IAMUserChangePassword
- arn:aws:iam::aws:policy/IAMUserSSHKeys
- arn:aws:iam::aws:policy/IAMReadOnlyAccess
# This matches our new policy above.
- AssumeNewLabPowerUser
in_accounts:
- parent
users:
TestUser:
groups:
- LabUsers
in_accounts:
- parent
NewTestUser:
groups:
- NewLabUsers
in_accounts:
- parent
</code></pre> 
<h3>Build and deploy</h3> 
<p>Run the build:</p> 
<pre><code class="lang-bash">
python build.py
</code></pre> 
<p>Now, you see a new set of CloudFormation templates in output_templates/:</p> 
<pre><code class="lang-bash">
ls -l output_templates/
-rw-r--r-- 1 user user Users 6307 Apr 10 10:59 central(012345678910)-IAM.template
-rw-r--r-- 1 user user Users 1680 Apr 10 10:59 lab(109876543210)-IAM.template
-rw-r--r-- 1 user user Users 1683 Apr 10 10:59 newlab(543210123456)-IAM.template
</code></pre> 
<p>View one of the templates, and notice that the build number has changed:</p> 
<pre><code class="lang-json">
...
&quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,
&quot;Description&quot;: &quot;Build 2017-07-25Z19:35:41 - IAM Users, Groups, Roles, and Policies for account central (012345678910)&quot;,
...
</code></pre> 
<p>The build number is the datestamp when the build was executed. It will be the same across all of the templates generated during that build. Use it to assure the environment remtains consistent. You can audit all of your accounts to assure this number is identical to assure deployment conssitency.</p> 
<p>Again, deploy using your favorite mechanism or use the AWS CLI commands below.</p> 
<p>In <code>central</code> this is an update which creates the new managed policy, group, and user.</p> 
<pre><code class="lang-bash">
aws cloudformation update-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/central(012345678910)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile central \
--region us-east-2
</code></pre> 
<p>In <code>lab</code>, this is a simple version increment. Nothing else changes but keeping the version consistent ensures that your environment is consistently deployed.</p> 
<pre><code class="lang-bash">
aws cloudformation update-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/lab(109876543210)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile lab \
--region us-east-2
</code></pre> 
<p>In <code>newlab</code>, this is the first deployment.</p> 
<pre><code class="lang-bash">
aws cloudformation create-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/newlab(543210123456)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile newlab \
--region us-east-2
</code></pre> 
<h3>Explore the results</h3> 
<p>You’ve enabled a new account and brought it in line with centrally managed IAM policies, with a few changes to a configuration yaml file.</p> 
<p>As before, create a password for <code>NewTestUser</code> and assume the <code>PowerUser</code> Role in the <code>newlab</code> account. As a test step, confirm that you cannot assume the <code>PowerUser</code> role in the <code>lab</code> account from this user because you didn’t permit that in the config.yaml file.</p> 
<b>Corral users into a specific region</b> 
<p>As your use of AWS has grown, you’ve noticed that your users are creating EC2 instances in multiple regions. This is becoming difficult to manage, and you’d like to restrict their region use to us-east-2.</p> 
<p>There is no ‘off the shelf’ managed policy for this, so you need to create one. Going through the <a title="IAM Policy Generator" href="https://awspolicygen.s3.amazonaws.com/policygen.html" target="_blank" rel="noopener noreferrer">IAM Policy Generator</a>, create a policy that looks like the following:</p> 
<pre><code class="lang-json">
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;DenyAllButOhio&quot;,
&quot;Action&quot;: &quot;ec2:*&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Resource&quot;: &quot;*&quot;,
&quot;Condition&quot;: {
&quot;StringNotEquals&quot;: {
&quot;ec2:Region&quot;: &quot;us-east-2&quot;
}
}
}
]
}
</code></pre> 
<h3>Update the configuration</h3> 
<p>To support the region restrictions, create a file called <code>policy/restrictEc2Region.j2</code>, and copy the policy json contents above into it.</p> 
<p>Edit the config.yaml file and make some changes.</p> 
<p>Define the new managed policy to restrict regions based on the template in the <code>policy/</code> directory.</p> 
<pre><code class="lang-yaml">
...
policies:
...
restrictEc2Region:
description: Prevent EC2 actions outside of us-east-2
# Get the policy json content from the file in the policy/ directory
policy_file: restrictEc2Region.j2
in_accounts:
- children
...
</code></pre> 
<p>Modify the <code>PowerUser</code> role to include this region restriction policy:</p> 
<pre><code class="lang-yaml">
...
roles:
PowerUser:
trusts:
- parent
managed_policies:
# Add our new managed policy
- restrictEc2Region
- arn:aws:iam::aws:policy/PowerUserAccess
in_accounts:
- children
...
</code></pre> 
<p>For reference your config.yaml should now look like this:</p> 
<pre><code class="lang-yaml">
---
accounts:
central:
# Change to the ID of the central parent account.
id: 012345678910
parent: true
lab:
# Change to the ID of the child account.
id: 109876543210
newlab:
# Change to the ID of the new account created using Organizations.
id: 543210123456
policies:
AssumeLabPowerUser:
description: Allow assumption of the PowerUser role in the lab account
assume:
roles:
- PowerUser
accounts:
- lab
in_accounts:
- parent
# The new managed policy lets users assume PowerUser in the newlab account.
AssumeNewLabPowerUser:
description: Allow assumption of the PowerUser role in the newlab account
assume:
roles:
- PowerUser
accounts:
# Here is the new account added in the accounts section
- newlab
in_accounts:
- parent
# A policy document taken from a jinja template
restrictEc2Region:
description: Prevent EC2 actions outside of us-east-2
# Get the policy json content from the file in the policy/ directory
policy_file: restrictEc2Region.j2
in_accounts:
- children
roles:
PowerUser:
trusts:
- parent
managed_policies:
# Add our new managed policy
- restrictEc2Region
- arn:aws:iam::aws:policy/PowerUserAccess
in_accounts:
# Because you use the keyword 'children' here, the newlab account gets this role
- children
groups:
LabUsers:
managed_policies:
- arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials
- arn:aws:iam::aws:policy/IAMUserChangePassword
- arn:aws:iam::aws:policy/IAMUserSSHKeys
- arn:aws:iam::aws:policy/IAMReadOnlyAccess
- AssumeLabPowerUser
in_accounts:
- parent
# This group services the newlab account users.
NewLabUsers:
managed_policies:
- arn:aws:iam::aws:policy/IAMSelfManageServiceSpecificCredentials
- arn:aws:iam::aws:policy/IAMUserChangePassword
- arn:aws:iam::aws:policy/IAMUserSSHKeys
- arn:aws:iam::aws:policy/IAMReadOnlyAccess
# This matches our new policy above.
- AssumeNewLabPowerUser
in_accounts:
- parent
users:
TestUser:
groups:
- LabUsers
in_accounts:
- parent
NewTestUser:
groups:
- NewLabUsers
in_accounts:
- parent
</code></pre> 
<h3>Build and deploy</h3> 
<p>Build the CloudFormation templates:</p> 
<pre><code class="lang-bash">
python build.py
</code></pre> 
<p>View the <code>lab</code> CloudFormation template. You can see the new managed policy:</p> 
<pre><code class="lang-json">
...
&quot;restrictEc2Region&quot;: {
&quot;Properties&quot;: {
&quot;Description&quot;: &quot;Prevent EC2 actions outside of us-east-2&quot;,
&quot;Groups&quot;: [],
&quot;PolicyDocument&quot;: {
&quot;Statement&quot;: [
{
&quot;Action&quot;: &quot;ec2:*&quot;,
&quot;Condition&quot;: {
&quot;StringNotEquals&quot;: {
&quot;ec2:Region&quot;: &quot;us-east-2&quot;
}
},
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Resource&quot;: &quot;*&quot;,
&quot;Sid&quot;: &quot;DenyAllButOhio&quot;
}
],
&quot;Version&quot;: &quot;2012-10-17&quot;
},
&quot;Roles&quot;: [],
&quot;Users&quot;: []
},
&quot;Type&quot;: &quot;AWS::IAM::ManagedPolicy&quot;
}
...
</code></pre> 
<p>You can also see that <code>PowerUser</code> definition now includes the following:</p> 
<pre><code class="lang-json">
...
&quot;ManagedPolicyArns&quot;: [
&quot;arn:aws:iam::aws:policy/PowerUserAccess&quot;,
{
&quot;Ref&quot;: &quot;restrictEc2Region&quot;
}
],
...
</code></pre> 
<p>If you look at <code>newlab</code>, you see the same set of definitions are there too. If you had tens or even hundreds of child accounts, those would all reflect the new policy and updated role definitions as well. This scales very nicely!</p> 
<p>Now, deploy to your three accounts.</p> 
<p>In <code>central</code>, nothing actually changes. It’s just a deployment version update.</p> 
<pre><code class="lang-bash">
aws cloudformation update-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/central(012345678910)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile central \
--region us-east-2
</code></pre> 
<p>In <code>lab</code> and <code>newlab</code>, this deploys the new managed policy, and update the <code>PowerUser</code> role.</p> 
<pre><code class="lang-bash">
aws cloudformation update-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/lab(109876543210)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile lab \
--region us-east-2
</code></pre> 
<pre><code class="lang-bash">
aws cloudformation update-stack \
--stack-name CentralIAMPolicies \
--template-body 'file://./output_templates/newlab(543210123456)-IAM.template' \
--capabilities CAPABILITY_NAMED_IAM \
--profile newlab \
--region us-east-2
</code></pre> 
<b>Conclusion</b> 
<p>I hope you find this tool as useful as I have. The tool is capable of much more complex deployments as well, which leverage the power of Jinja2 templating. Explore the contents of <code>sample_configs/config-complex.yaml</code> and the policy examples in the <code>sample_policy/</code> directory in the project.</p> 
<p>The <a title="README.md" href="https://github.com/awslabs/aws-iam-generator/blob/master/README.md" target="_blank" rel="noopener noreferrer">README.md</a> file has more detailed explanations of functionality and syntax usage.</p> 
<h4>About the Author</h4> 
<p><img class="size-full wp-image-831 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/apmclean.jpeg" alt="" width="119" height="160" /><br /> <a title="LinkedIn Profile" href="https://www.linkedin.com/in/adam-mclean-90bb3020/" target="_blank" rel="noopener noreferrer">Adam McLean</a> is a Cloud Infrastructure Architect with AWS Professional Services. Adam enjoys helping his Canadian enterprise customers achieve success on their cloud journey. In his spare time, Adam enjoys spending time with his family and three small children.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-multi-account-management/" rel="tag">AWS Multi-Account Management</a>, <a href="https://aws.amazon.com/blogs/mt/tag/configuration-management/" rel="tag">Configuration Management</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How Cloudticity Automates Security Patches for Linux and Windows using Amazon EC2 Systems Manager and AWS Step Functions</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-08-02T19:14:49+00:00">02 AUG 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/application-services/aws-step-functions/" title="View all posts in AWS Step Functions*"><span property="articleSection">AWS Step Functions*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-cloudticity-automates-security-patches-for-linux-and-windows-using-amazon-ec2-systems-manager-and-aws-step-functions/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><em>This guest post was written by Uri Katsir, AWS Architect at Cloudticity, and Thomas Zinn, Project Manager at Cloudticity.</em></p> 
<p>As a provider of HIPAA-compliant solutions using AWS, Cloudticity always has security as the base of everything we do. HIPAA breaches would be an end-of-life event for most of our customers. Having been born in the cloud with automation in our DNA, Cloudticity embeds automation into all levels of infrastructure management including security, monitoring, and continuous compliance. As mandated by the HIPAA Security Rule (45 CFR <a href="http://www.access.gpo.gov/nara/cfr/waisidx_07/45cfr160_07.html">Part 160</a> and Subparts A and C of <a href="http://www.access.gpo.gov/nara/cfr/waisidx_07/45cfr164_07.html">Part 164</a>), patches at the operating system and application level are required to prevent security vulnerabilities. As a result, patches are a major component of infrastructure management.</p> 
<p><span id="more-988"></span></p> 
<p>Cloudticity strives to provide consistent and reliable services to all of our customers. As such, we needed to create a custom patching solution that supports both Linux and Windows. The minimum requirements for such a solution were to read from a manifest file that contains instance names and a list of knowledge base articles (KBs) or security packages to apply to each instance. Below is a simplified, high-level process overview.</p> 
<p><img class="size-full wp-image-1016 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/31/flowchart-patching.png" alt="" width="340" height="423" /></p> 
<p>There were a few guidelines to be considered when designing the solution:</p> 
<ol> 
<li>Each customer has a defined maintenance window that patches can be completed within. As such, the solution must be able to perform the updates within the specified maintenance window.</li> 
<li>The solution must be able to provide patches to one or many instances and finish within the maintenance window.</li> 
<li>The solution should use as many AWS services as possible to reduce time-to-market and take advantage of the built-in scaling that many AWS services provide.</li> 
<li>Code reusability is essential.</li> 
</ol> 
<p>In this post, we walk through our solution and discuss how combining <a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a> and <a href="https://aws.amazon.com/step-functions/">AWS Step Functions</a> is ideal for this particular use case.</p> 
<h3>Systems Manager for Patch Management</h3> 
<p>We have been using Systems Manager to remotely manage instances from its inception, so it was natural to consider it as part of the solution. We use Systems Manager in many ways:</p> 
<ol> 
<li>Installing New Relic and Trend Micro agents for every new instance that is launched (whether manually or via Auto Scaling).</li> 
<li>Ensuring that EC2Config and the SSM agents are running the latest versions.</li> 
<li>Deploying software updates to multiple remote instances.</li> 
</ol> 
<p>We began with the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">Systems Manager predefined documents</a> “AWS-InstallWindowsUpdates” for Windows and “AWS-RunShellScript” for Linux. To achieve maximum code reusability, we created several AWS Lambda functions to perform individual tasks, such as identifying operating system type (Linux or Windows) or applying patches using the SSM agents. Each process (rectangle) in the flowchart above is implemented using a single Lambda function. The Systems Manager document is smart enough to apply multiple patches provided by a manifest file stored in Amazon S3 and only perform a single reboot, if a reboot is required to complete the patch process. Below is a code snippet from the Lambda function that runs Linux patches:</p> 
<pre><code class="lang-clike">if (IncludedKB === '') {	
// Build the yum command based on the entry in the manifest file
command = 'sudo yum update -y';
} else if (IncludedKB.toUpperCase() == 'SECURITY') {
command = 'yum update --security -y';
} else {
command = 'yum --security update ' + IncludedKB + ' -y';
}
var commands = [];
commands.push(command);
//prepare parameters for the Systems Manager command. Specify the output folder to hold the run //results.
var params = {
DocumentName: 'AWS-RunShellScript',
InstanceIds: [instanceId],
Comment: 'OS Patch command',
OutputS3BucketName: bucket,
OutputS3KeyPrefix: OutputFolder,
Parameters: {
commands: commands
},
TimeoutSeconds: 60
};
console.log('Sending command to InstanceID: ' + instanceId);
console.log('Command is: ' + command);
ssm.sendCommand(params, function(err, data) {
//console.log('err= ' + err);
if (err) {
callback(command + ', Error, ' + err.code);
} else {
console.log(command + ', ' + data.Command.CommandId + ', ' + data.Command.Status);
callback(null);
}
});
</code></pre> 
<h3>Step Functions for workflow orchestration</h3> 
<p>Given the nature of the solution (microservices that perform unique and distinct tasks), we needed a centralized service to manage and drive the process end-to-end, as well as pass parameters between Lambda functions. In other words, a state machine of Lambda functions. At AWS re:Invent 2016, AWS Step Functions was released. It allowed us to spin up multiple concurrent processes for completing the patches (one for each row in the manifest file) without the need to worry about scale, <a href="https://en.wikipedia.org/wiki/Deadlock">deadlocks</a>, timeouts, or <a href="https://en.wikipedia.org/wiki/Race_condition">race conditions</a>. By running concurrent processes, we can complete the patch process in the minimum time required for the patches to be applied without introducing any overhead to the process.</p> 
<p>Step Functions provides some additional benefits including visualization of the overall state machine, passing input/output parameters between Lambda functions, and simplified debugging for each step in the process.</p> 
<p>The image below is a visual preview of the patching process generated by the Step Functions user interface in the AWS Management Console. Notice how the resulting state machine mimics the initial workflow.</p> 
<p><img class="alignleft wp-image-989" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/31/Step-functions-diagram.png" alt="" width="521" height="320" /></p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<pre><code class="lang-json">{
&quot;Comment&quot;: &quot;Cloudticity-Oxygen-OS-Patch-SF.&quot;,
&quot;StartAt&quot;: &quot;GetInstancePlatform&quot;,
&quot;States&quot;: {
&quot;GetInstancePlatform&quot;: {
&quot;Type&quot;: &quot;Task&quot;,
&quot;Resource&quot;: &quot;arn:aws:lambda:us-east-1:123456789012:function:Cloudticity-Oxygen-GetInstancePlatform&quot;,
&quot;Next&quot;: &quot;ChoiceState&quot;
},
&quot;ChoiceState&quot;: {
&quot;Type&quot;: &quot;Choice&quot;,
&quot;Choices&quot;: [
{
&quot;Variable&quot;: &quot;$.PlatformType&quot;,
&quot;StringEquals&quot;: &quot;Windows&quot;,
&quot;Next&quot;: &quot;WindowsMatchState&quot;
},
{
&quot;Variable&quot;: &quot;$.PlatformType&quot;,
&quot;StringEquals&quot;: &quot;Linux&quot;,
&quot;Next&quot;: &quot;LinuxMatchState&quot;
}
],
&quot;Default&quot;: &quot;NoMatchFound&quot;
},
&quot;WindowsMatchState&quot;: {
&quot;Type&quot;: &quot;Task&quot;,
&quot;Resource&quot;: &quot;arn:aws:lambda:us-east-1:123456789012:function:Cloudticity-Oxygen-Windows-OS-Patching&quot;,
&quot;Retry&quot;: [
{
&quot;ErrorEquals&quot;: [
&quot;States.ALL&quot;
],
&quot;IntervalSeconds&quot;: 6,
&quot;MaxAttempts&quot;: 2,
&quot;BackoffRate&quot;: 3
}
],
&quot;End&quot;: true
},
&quot;LinuxMatchState&quot;: {
&quot;Type&quot;: &quot;Task&quot;,
&quot;Resource&quot;: &quot;arn:aws:lambda:us-east-1:123456789012:function:Cloudticity-Oxygen-Linux-OS-Patching&quot;,
&quot;End&quot;: true
},
&quot;NoMatchFound&quot;: {
&quot;Type&quot;: &quot;Fail&quot;,
&quot;Cause&quot;: &quot;No Matches!&quot;
}
}
}
</code></pre> 
<p>The first state (GetInstancePlatform) executes the <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/utility/GetInstancePlatform.js">Cloudticity-Oxygen-GetInstancePlatform</a> Lambda function. As you can see in the code snippet below, the Lambda function then invokes the <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html#describeInstanceInformation-property">ssm.describeInstanceInformation</a> method to retrieve the platform type of the instance (Linux or Windows).</p> 
<pre><code class="lang-clike">var aws = require('aws-sdk');	
var getInstancePlatform = function(instanceID, event, IncludeKbs, isReboot, bucket, OutputFolder, callback) {
var ssm = new aws.SSM();
//Prepare the parameters for the Systems Manager run. Instance ID is an input parameter in the //manifest file.
var params = {
InstanceInformationFilterList: [{
key: &quot;InstanceIds&quot;,
valueSet: [
instanceID
]
}]
};
ssm.describeInstanceInformation(params, function(err, instanceData) {
if (err) {
callback(err);
} else {
let instanceInformation = instanceData.InstanceInformationList[0];
if (instanceInformation) {
console.log('Running GetInstancePlatform. PlatformType = ' + instanceInformation.PlatformType);
//return instance information to the next step in the Step Function.
callback(null, {
PlatformType: instanceInformation.PlatformType,
kB: IncludeKbs,
instanceID: instanceID,
isReboot: isReboot,
bucket: bucket,
OutputFolder: OutputFolder
}, event);
} else {
callback('Unknown instance platform');
}
}
});
};</code></pre> 
<p>The platform information is passed on to the built-in <a href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-choice-state.html">Choice</a> state (InstancePlatform) that adds branching logic to a state machine. The InstancePlatform state uses the platform information to route traffic via one of three options:</p> 
<li>PatchWindows</li> 
<li>PatchLinux</li> 
<li>NoMatchFound.</li> 
<p>When patching Windows instances, the state is transferred to the <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/lib/Windows_updates-patcher.js">Cloudticity-Oxygen-Windows-OS-Patching</a> Lambda function that invokes the <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html#sendCommand-property">ssm.sendCommand</a> method with “AWS-InstallWindowsUpdates” as the document name. An input to this document is a <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/events/ManifestFileSample.csv">manifest file</a>, which contains the Windows Knowledge Base (KBs) numbers to be applied to instances.</p> 
<p>Below is a snippet from the Lambda function that patches Windows instances.</p> 
<pre><code class="lang-clike">//prepare parameters for the ssm command. Instance ID and included KBs are input from the manifest file.
var params = {	
DocumentName: 'AWS-InstallWindowsUpdates',
Comment: 'OS Patch command',
InstanceIds: [instanceId],
OutputS3BucketName: bucket,
OutputS3KeyPrefix: OutputFolder,
Parameters: {
&quot;Action&quot;: [&quot;Install&quot;],
&quot;IncludeKbs&quot;: [IncludeKbs]
},
TimeoutSeconds: 60
};
console.log(&quot;Sending InstallWindowsUpdates ssm command with the following InstanceId: &quot; + instanceId + &quot;\n&quot;);
//Send the ssm command.
ssm.sendCommand(params, function(err, data) {
if (err) callback(command + ', Error, ' + err.code + &quot;\n&quot;);
else {
callback(null);
console.log(&quot;Sending InstallWindowsUpdates &quot; + command + ', ' + data.Command.CommandId + ', ' + data.Command.Status + &quot;\n&quot;);
}
});</code></pre> 
<p>When patching a Linux instance, the state is transferred to the <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/lib/linux_updates-patcher.js">Cloudticity-Oxygen-Linux-OS-Patching</a> Lambda function that invokes the <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SSM.html#sendCommand-property">ssm.sendCommand</a> method with “AWS-RunShellScript” as the document name. Our Linux patching implementation provides two options:</p> 
<ol> 
<li>Security packages that need to be applied are entered into a <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/events/ManifestFileSample.csv">manifest file</a>. This file is referenced as an input parameter to the “AWS-RunShellScript” document.</li> 
<li>In the <a href="https://github.com/Cloudticity/o2-instance-patching/blob/master/events/ManifestFileSample.csv">manifest file</a>, instead of listing packages, “security” is specified in the packages place.</li> 
</ol> 
<p>In the latter case, all security-related packages are applied to the specified instance according to the manifest file.</p> 
<h3>Looking Ahead</h3> 
<p>Based on our customer feedback and internal reviews, we are planning to add the following features to the above implementation:</p> 
<li>Add AMI patching as part of the overall process: Replace an AMI in an Auto Scaling Launch Configuration with the patched AMI.</li> 
<li>Add additional exception handling for process failures and the patching product: If an SSM command successfully sent, but the patch process fails on the instance. A notification or support ticket is created. In some cases, a single patch process can take longer than five minutes to run. Since five minutes is the maximum runtime for Lambda functions, we introduce a polling mechanism to query the patch progress following the guidelines outlined in this <a href="https://aws.amazon.com/blogs/compute/building-high-throughput-genomics-batch-workflows-on-aws-workflow-layer-part-4-of-4/">post</a>.</li> 
<h3>Summary</h3> 
<p>Using <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">Systems Manager predefined documents</a> and <a href="https://aws.amazon.com/step-functions/">AWS Step Functions</a> together allowed this <a href="https://github.com/Cloudticity/o2-instance-patching">solution</a> to be implemented within a short time frame. It also enabled the release of a scalable patching service to multiple customers. Beyond the automation and scalability, our customers see additional benefits like the ability to decrease the length of maintenance windows.</p> 
<h3>About the Authors</h3> 
<p><img class="size-full wp-image-1004 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/31/uri-2.jpg" alt="" width="150" height="114" />Uri Katsir is an AWS Architect at Cloudticity, where he spends his days building really cool HIPAA-compliant services for the healthcare industry.</p> 
<p>&nbsp;</p> 
<p><img class="size-full wp-image-1003 alignnone" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/31/thomas.png" alt="" width="151" height="151" />Thomas Zinn is a Project Manager at Cloudticity, where he provides HIPAA-compliant infrastructure solutions using AWS.</p> 
<h3>About Cloudticity</h3> 
<p><a href="http://cloudticity.com/">Cloudticity</a> helps healthcare organizations design, build, migrate, and manage HIPAA-compliant systems using AWS. We are an <a href="https://aws.amazon.com/partners/managed-service/">audited AWS Managed Service Provider (MSP)</a>, <a href="https://aws.amazon.com/health/healthcare-partners/">AWS Healthcare Competency Partner</a> and <a href="https://aws.amazon.com/devops/partner-solutions/">AWS DevOps Competency Partner</a>. In addition, as an AWS Service Catalog Partner and Public Sector Partner, Cloudticity is well positioned to help providers, payers, and healthcare services organizations use AWS securely and effectively. For further reading, check out <a href="https://aws.amazon.com/blogs/apn/how-cloudticity-uses-automation-to-scale-healthcare-solutions/">How Cloudticity Uses Automation to Scale Healthcare Solutions</a> and <a href="https://aws.amazon.com/partners/success/cloudticity/">AWS Partner Story: Cloudticity</a>.</p> 
<hr /> 
<p><em>AWS is not responsible for the content or accuracy of this post. The content and opinions in this blog are solely those of the third party author. It is each customer’s responsibility to determine whether they are subject to HIPAA, and if so, how best to comply with HIPAA and its implementing regulations. Before using AWS in connection with protected health information, customers must enter an AWS Business Associate Addendum (BAA) and follow its configuration requirements.</em></p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/DSC2_statemanager-888x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">Combating Configuration Drift Using Amazon EC2 Systems Manager and Windows PowerShell DSC</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Shaun Breen</span></span> | on 
<time property="datePublished" datetime="2017-07-26T10:12:43+00:00">26 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/combating-configuration-drift-using-amazon-ec2-systems-manager-and-windows-powershell-dsc/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Configuration drift occurs when a system “drifts” or changes from its intended configuration. It is caused by having inconsistent configuration items (CIs) across environments.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a> is a management service that helps you automatically collect a software inventory, apply OS patches, create system images, and configure Windows and Linux operating systems. These capabilities help you define and track system configurations, prevent drift, and maintain software compliance of your EC2 and on-premises configurations.</p> 
<p>Systems Manager provides a management approach that is designed for the scale and agility of the cloud but extends into your on-premises data center. Systems Manager makes it easier for you to seamlessly bridge your existing infrastructure with AWS.</p> 
<p>In my last <a href="https://aws.amazon.com/blogs/mt/using-microsoft-powershell-dsc-with-amazon-ec2-systems-manager/">post</a>, I introduced the concept of using Systems Manager <a href="https://aws.amazon.com/ec2/systems-manager/run-command/">Run Command</a> to apply a declarative based model for EC2 instance configuration (configuration as code) via Windows PowerShell Desired State Configuration (DSC). In this post, I show how you can combat configuration drift at scale using PowerShell DSC and a management tool from Systems Manager called <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">State Manager</a>.</p> 
<p><span id="more-886"></span></p> 
<b>Configuration drift</b> 
<p>Configuration drift can happen for a multitude of reasons and can occur in many types of environments such as database systems, network configurations, directory services, web servers, and custom APIs. Some possible reasons that drift can occur include system updates, code pushes, hardware upgrades, or software updates that get applied to some, but not all of your intended systems. I am sure that you have seen this firsthand. &nbsp;We have all heard “but it worked in my dev environment.”</p> 
<p>Configuration drift can cause problems that can result in unintended system behaviors, system failures, disaster recovery issues, and many other potential problems. Fortunately, there are tools and technologies that help mitigate drift.</p> 
<li><strong>Configuration as code</strong></li> 
<p style="padding-left: 30px">Declaratively define a desired state within a configuration file that can be applied to a system to interpret and apply.</p> 
<li><strong>State Manager</strong></li> 
<p style="padding-left: 30px">An EC2 tool that helps you apply a configuration to a set of on-premises servers and EC2 instances on a scheduled basis.</p> 
<li><strong>Configuration management databases (CMDB)</strong></li> 
<p style="padding-left: 30px">CMDBs help track the state of IT assets (also known as configuration items), allowing IT administrators the ability to check on the current state of CIs at any time. A common issue with CMDBs is stale data, meaning that the current state is not always up-to-date. The inability to reliably detect drift is problematic as mitigation is not performed. While CMDBs are popular, I do not use them as a solution in this post.</p> 
<b>Configuration as code via PowerShell DSC</b> 
<p>Before I dive into a solution to help with the ongoing struggles of configuration drift, here are the benefits of using configuration as code via PowerShell DSC:</p> 
<li><strong>Definition files.</strong></li> 
<p style="padding-left: 30px">A system “desired state” is defined in declaratively based configuration files. You no longer need to develop custom code and scripts to handle the configuration state that you want for your servers.</p> 
<li><strong>Idempotency.</strong></li> 
<p style="padding-left: 30px">You can apply the configuration file repeatedly without adverse side effects.</p> 
<li><strong>Self-documentation.</strong></li> 
<p style="padding-left: 30px">The configuration files are human-readable and easily understood.</p> 
<b>State Manager</b> 
<p>State Manager allows you to schedule a script to be run against your on-premises servers and EC2 instances on a scheduled basis. If the scripts are idempotent, you can apply them repeatedly. This gives way to a simple and scalable pattern that helps mitigate configuration drift.</p> 
<ol> 
<li>Define your set of servers.</li> 
<li>Create idempotent scripts or use PowerShell DSC to define your desired state configuration.</li> 
<li>Apply the script on a scheduled basis to mitigate any drift that may have occurred since the last time you ran the script.</li> 
</ol> 
<b>State Manager and PowerShell DSC</b> 
<p>This is a powerful combination! State Manager and PowerShell DSC allow you to define configuration policies that can be applied to your EC2 instances at scale. It ensures that your instances remain in that state by reapplying the policy on a defined schedule. While this does not prevent drift from occurring, it helps you mitigate any drift that may have occurred. Thus, this is an excellent pattern to ensure that both your on-premises servers and EC2 instances stay in your desired state.</p> 
<p><img class="alignnone size-full wp-image-902" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/DSC2_statemanager.png" alt="" width="1431" height="1015" /></p> 
<p>In this section, I show you how to use State Manager from the AWS Management Console. You learn to use both State Manager and PowerShell DSC to combat configuration drift.</p> 
<p>At a high level, this is the walk-through process:</p> 
<ol> 
<li>Create EC2 Windows instances.</li> 
<li>Tag those instances such that they are considered a set of instances that share a common purpose.</li> 
<li>Create a State Manager association. This association executes a PowerShell DSC script against the tagged instances on a specified schedule. 
<li>The PowerShell DSC script is contained in a PowerShell module downloaded from a S3 endpoint. It is authored by AWS and its intent is to install IIS on the instance and enable ASP and Tracing features. The module is publicly available and can be <a href="https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip">downloaded</a>.</li> 
</ul> </li> 
</ol> 
<b>Walk-through</b> 
<ol> 
<li>In the EC2 console, <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html#ec2-launch-instance_linux">create two or more new Windows Server instances</a>.</li> 
<li>Choose <strong>Instances</strong>, select the instances that you just created, and choose <strong>Tags</strong>.</li> 
<li>Choose <strong>Add/Edit Tags</strong> and set the following values: 
<li><strong>Set Key</strong> = Metadata</li> 
<li><strong>Set Value</strong> = {“Environment”: “Production”, “Type”: “IIS Web Server”}</li> 
</ul> </li> 
<li>In the EC2 console, choose <strong>State Manager</strong>, <strong>Create Association</strong>, and select the document <strong>AWS-InstallPowerShellModule</strong>. Set the following values: 
<li>Keep the document version as $DEFAULT.</li> 
<li>For <strong>Specifying a Tag</strong>, select: 
<li><strong>Tag Name</strong> = Metadata</li> 
<li><strong>Tag Value</strong> = {“Environment”: “Production”, “Type”: “IIS Web Server”}</li> 
</ul> </li> 
<li>For <strong>Schedule</strong>, choose Every <strong>30</strong> Minutes.</li> 
<li>For the <strong>Source</strong>, enter the following URL: <a href="https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip">https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip</a></li> 
<li>For <strong>Commands</strong>, copy and paste the following:</li> 
<li> <pre><code class="lang-powershell">Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
Import-Module SSMDevOps
Install-SsmDoIIS
Start-DscConfiguration -Path Install-SsmDoIIS -Wait</code></pre> </li> 
</ul> </li> 
<li>Choose <strong>Create Association</strong>.</li> 
</ol> 
<b>Conclusion</b> 
<p>Systems Manager offers a suite of tools to help you manage both your EC2 and on-premises instances. In this post, I discussed some common approaches to mitigate configuration drift at scale. Finally, I provided an example walk-through to try mitigating configuration drift using Systems Manager and PowerShell DSC.</p> 
<b>About the Author</b> 
<p><strong><a href="https://www.linkedin.com/in/shaunbreen/"><img class="alignleft wp-image-618" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/shaunbreen.png" alt="" width="130" height="174" /></a>Shaun Breen is a Systems Development Engineer on the Amazon EC2 Windows team</strong>.&nbsp;The EC2 Windows team is responsible for producing Windows Server AMIs and Systems Manager documents. Shaun enjoys developing solutions that make EC2 the best place to run Microsoft Windows Server in the cloud. When not working on EC2 Windows solutions, he enjoys attending sporting events, coaching ice hockey, and spending time with his wife and three children.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/powershell-dsc/" rel="tag">PowerShell DSC</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Organize Parameters by Hierarchy, Tags, or Amazon CloudWatch Events with Amazon EC2 Systems Manager Parameter Store</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-07-25T17:30:01+00:00">25 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/organize-parameters-by-hierarchy-tags-or-amazon-cloudwatch-events-with-amazon-ec2-systems-manager-parameter-store/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><em>This post was written by Lusha Zhang, Software Development Engineer with Amazon Web Services.</em></p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/parameter-store/">Parameter Store</a>, part of <a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a>, provides a centralized, encrypted store to manage your configuration data, whether plaintext data (database strings) or secrets (passwords, API keys for example). Because Parameter Store is available through the AWS CLI, APIs, and SDKs, you can easily reference parameters across AWS services such as AWS Lambda and Amazon ECS.</p> 
<p>For additional posts on Parameter Store, please see:</p> 
<li><a href="https://aws.amazon.com/blogs/compute/managing-secrets-for-amazon-ecs-applications-using-parameter-store-and-iam-roles-for-tasks/">Managing Secrets for Amazon ECS Applications Using Parameter Store and IAM Roles for Tasks</a></li> 
<li><a href="https://aws.amazon.com/blogs/mt/use-parameter-store-to-securely-access-secrets-and-config-data-in-aws-codedeploy/">Use Parameter Store to Securely Access Secrets and Config Data in AWS CodeDeploy</a></li> 
<p>Parameter Store recently <a href="https://aws.amazon.com/about-aws/whats-new/2017/06/amazon-ec2-systems-manager-adds-hierarchy-tagging-and-notification-support-for-parameter-store/">launched</a> hierarchy support, parameter tagging, and CloudWatch Events support, which makes it easy to organize and manage parameters at scale. In this post, I demonstrate how you can use these new features to scale and improve your security posture.</p> 
<p><span id="more-864"></span></p> 
<h3>Hierarchical parameters</h3> 
<p>Parameter Store support for hierarchies lets you organize parameters based on your deployment. It provides powerful tools for parameter organization, querying, and permission control.</p> 
<p>A common DevOps scenario is to automate software deployment across different environments such as Dev, Beta, and Prod. For example, when you create a deployment configuration, you can use Parameter Store to save your settings. Maybe you have to set the minimum healthy host number or percentage for each deployment environment, and want to store it in Parameter Store, with different values for each environment.</p> 
<h4>Step 1. Create the path for deployment configuration</h4> 
<p>Use the following commands to create the path and parameters to store:</p> 
<pre><code class="lang-bash">aws ssm put-parameter --name /DeploymentConfig/Prod/FleetHealth --value 75 --type String
aws ssm put-parameter --name /DeploymentConfig/Beta/FleetHealth --value 20 --type String
</code></pre> 
<p>You can also organize your secrets under a dedicated path. For example,</p> 
<pre><code class="lang-bash">aws ssm put-parameter –-name /DeploymentConfig/Prod/Password/SQLPassword –-value <span style="color: #ff0000">&lt;password&gt;</span> --type SecureString</code></pre> 
<p>For more information about how to use the SecureString type parameter, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-about.html">About Systems Manager Parameters</a>.</p> 
<p>Your parameter hierarchy now looks like the following:</p> 
<p>&nbsp;</p> 
<p>Step 2. Use parameters to manage your deployment configuration<br /> When you create a deployment configuration using an AWS CloudFormation template, you can set the FleetHealth for a Prod stage as in the following example.</p> 
<p><img class="alignnone size-full wp-image-870" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/hierarchy.png" alt="" width="681" height="349" /></p> 
<h4>Step 2. Use parameters to manage your deployment configuration</h4> 
<p>When you create a deployment configuration using an AWS CloudFormation template, you can set the FleetHealth for a Prod stage as in the following example.</p> 
<pre><code class="lang-bash">#!/bin/bash
fleetHealth=$(aws ssm get-parameter --name /DeploymentConfig/Prod/FleetHealth --query Parameter.Value)
aws cloudformation create-stack --stack-name <span style="color: #ff0000">&lt;stack_name&gt;</span> --template-url <span style="color: #ff0000">&lt;templateurl&gt;</span> --parameters ParameterKey=FleetHealth,ParameterValue=$fleetHealth
</code></pre> 
<p>You can retrieve all the configuration parameters of your Prod or Beta environments using the recursive flag and parse the configuration hierarchy returned to get the parameter of your choice.</p> 
<pre><code class="lang-bash">aws ssm get-parameters-by-path --path /DeploymentConfig/Prod –-recursive</code></pre> 
<p>You can also filter parameters by path from the AWS Management Console or AWS CLI.</p> 
<pre><code class="lang-bash">aws ssm describe-parameters --parameter-filters Key=Path,Option=Recursive,Values=/DeploymentConfig/Prod</code></pre> 
<p><img class="alignnone wp-image-876" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/getParamsbypath.png" alt="" width="941" height="320" /></p> 
<h4>Control access to hierarchies</h4> 
<p>Now that you have created a parameter hierarchy for your deployment configuration in the Prod and Beta environments, you may want to restrict access to parameters. Maybe the Dev team should have access only to the Beta environment parameters, and not to the Prod environment parameters.</p> 
<p>Use IAM to control access to the Beta parameter hierarchy. For example, the following IAM policy restricts user access to Prod parameters.</p> 
<pre><code class="lang-json">{
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Action&quot;: [
&quot;ssm:GetParametersByPath&quot;
],
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;ssm:Recursive&quot;: [
&quot;true&quot;
]
}
},
&quot;Resource&quot;:“arn:aws:ssm:&lt;region&gt;:&lt;account_id&gt;:parameter/DeploymentConfig/Prod*&quot;
}
</code></pre> 
<p>Now when a user runs the following command, they get AccessDeniedException.</p> 
<pre><code class="lang-bash">aws ssm get-parameters-by-path --path /DeploymentConfig/Prod —-recursive</code></pre> 
<h3>Tagging parameters</h3> 
<p>Tags let you manage your AWS resources easily. You can now also tag parameters, allowing you to group and query them. Using the same deployment configuration example, you can add a tag with a <span style="text-decoration: underline">Tag Key</span> value of “Password”, and <span style="text-decoration: underline">Tag Value</span> equal to “Beta” or “Prod”.</p> 
<pre><code class="lang-bash">aws ssm add-tags-to-resource --resource-type Parameter --resource-id  /DeploymentConfig/Beta/FleetHealth --tags Key=Password,Value=Beta</code></pre> 
<p>You can also apply multiple filters to get a combined filter result. For example, if you apply Tag Key Password and a path /DeploymentConfig/Beta with the recursive flag, you get those parameters in your Beta environment that are password-related.</p> 
<pre><code class="lang-bash">aws ssm describe-parameters --parameter-filters Key=tag:Password Key=Path,Option=Recursive,Values=/DeploymentConfig/Beta</code></pre> 
<p><img class="alignnone wp-image-878" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/multiple-tag-filters.png" alt="" width="1012" height="261" /><br /> You can manage the security access with IAM policies. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-access.html">Controlling Access to Systems Manager Parameters</a>.</p> 
<h3>Get change notifications with CloudWatch Events rules</h3> 
<p>Parameter Store is now a <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">CloudWatch Events</a> source. You can set up CloudWatch rules to trigger a CloudWatch Event target such as a Lambda function or SNS topic whenever a parameter gets created, updated, or deleted.</p> 
<p>The following example shows you how to set up a CloudWatch rule to trigger an SNS topic for your parameter update. For more information, see <a href="http://docs.aws.amazon.com/gettingstarted/latest/deploy/creating-an-sns-topic.html">Step 2: Create an SNS Topic</a>. After you set up your SNS topic to trigger an email notification about your parameter update, create a CloudWatch rule to associate with the SNS topic as a target. You can edit the Event Pattern value to specify the parameters for which to get notified:</p> 
<pre><code class="lang-json">{
&quot;source&quot;: [
&quot;aws.ssm&quot;
],
&quot;detail-type&quot;: [
&quot;Parameter Store Change&quot;
],
&quot;detail&quot;: {
&quot;name&quot;: [
&quot;/DeploymentConfig/Prod/FleetHealth&quot;,
&quot;/DeploymentConfig/Beta/FleetHealth&quot;
],
&quot;operation&quot;: [
&quot;Update&quot;,
&quot;Delete&quot;
]
}
}
</code></pre> 
<p><img class="alignnone wp-image-873" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/CWE-filled.png" alt="" width="886" height="572" /></p> 
<p>When you change the value of the /DeploymentConfig/Beta/FleetHealth parameter, the CloudWatch event should show up in the metrics.</p> 
<p><img class="alignnone wp-image-875" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/CWE-metrics.png" alt="" width="593" height="349" /></p> 
<p>In the meantime, the SNS topic that you created is triggered and you should receive an email as well.</p> 
<h3>Conclusion</h3> 
<p>This post demonstrated several new Parameter Store features to manage parameters: &nbsp;hierarchy, tagging, and CloudWatch notifications. Hierarchical parameters make it easier to organize and control access to configuration data, whether plaintext or secrets. Tagging support provides you with another way to group and query parameters easily. With CloudWatch Events, you can get timely notifications about parameter updates.</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img class="size-full wp-image-877 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/lusha-zhang.jpg" alt="" width="119" height="160" />Lusha Zhang is a Software Development Engineer in the Amazon EC2 System Manager Team. She has worked on various products at Amazon from Amazon Textbook Rentals to AWS Parameter Store. Outside work, she enjoys playing the violin and the piano as well as surfing in the Pacific Northwest.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch-events/" rel="tag">Amazon Cloudwatch Events</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Windows AMI Patching and Maintenance with Amazon EC2 Systems Manager</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Venkat Krish</span></span> | on 
<time property="datePublished" datetime="2017-07-19T16:47:01+00:00">19 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/windows-ami-patching-and-maintenance-with-amazon-ec2-systems-manager-2/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>The <a href="https://aws.amazon.com/ec2/systems-manager/automation/"><strong>Automation</strong> </a>service, which is part of <strong><a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a></strong>, helps you save time and the effort associated with routine management operations. Automation workflows are streamlined, repeatable, and auditable. For example, you can easily automate manual tasks such as golden image creation, baking applications into Amazon Machine Images (AMIs), or patching and updating agents.</p> 
<p>In a recent post on the AWS Blog (<a href="https://aws.amazon.com/blogs/aws/streamline-ami-maintenance-and-patching-using-amazon-ec2-systems-manager-automation/">Streamline AMI Maintenance and Patching Using Amazon EC2 Systems Manager</a>), AWS announced the availability of the first public Document for Automation: AWS-UpdateLinuxAmi. This Document streamlines patching for Linux AMIs, allowing you to get started quickly with a predefined Automation workflow managed by AWS.</p> 
<p>Today, AWS announces the updated availability of the Windows equivalent: <strong>AWS-UpdateWindowsAmi.</strong> The AWS-UpdateWindowsAmi Document is a great fit for building a hardened AMI from the monthly Windows AMI release, applying Windows patches and AWS agent updates to your proprietary Windows AMI, or baking applications into a golden Windows AMI as part of your CI/CD pipeline. You can also use your custom AMIs as a source for images that meet organizational IT policies.&nbsp;Documents help centrally create, manage, and share code for IT Ops and the management tasks that Systems Manager can perform on your managed infrastructure.</p> 
<p><span id="more-823"></span></p> 
<p><strong>The AWS-UpdateWindowsAmi Document automates the following workflow:</strong></p> 
<ol> 
<li>Launch a temporary EC2 instance from a source Windows AMI.</li> 
<li>Perform Operating System compatibility checks.</li> 
<li>(Optional) Invoke a user-provided, pre-update hook script.</li> 
<li>Update EC2Config or EC2Launch (determined by the version of Windows launched in step 1).</li> 
<li>Update the SSM Agent.</li> 
<li>Update the AWS PV driver.</li> 
<li>Install Windows updates.</li> 
<li>(Optional) Invoke a user-provided, pre-update hook script on the instance.</li> 
<li>Run Sysprep /generalize.</li> 
<li>Stop the temporary instance.</li> 
<li>Create a new AMI from the stopped instance.</li> 
<li>Terminate the instance.</li> 
</ol> 
<h3>Prerequisites</h3> 
<p>If you haven’t used Automation before, you must configure IAM roles and permissions. This <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ami-cf.html">CloudFormation template</a> completes the required prerequisite actions. After logging on to your AWS account, choose <strong>Launch Stack</strong>. The template:</p> 
<li>Creates a service role for Automation.</li> 
<li>Grants PassRole permission to authorize a user to provide the service role.</li> 
<li>Creates an instance role to enable instance management under Systems Manager.</li> 
<h3>Executing Automation</h3> 
<p>1. In the EC2 console, choose Systems Manager, Automations.</p> 
<p><img class="alignnone wp-image-841 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/EC2SSMAutomation-1.png" alt="" width="2294" height="1200" /></p> 
<p>2. Choose <strong>Run automation document</strong>.</p> 
<p>3. Under <strong>Document name</strong>, choose <strong>AWS-UpdateWindowsAmi</strong>. Use the $DEFAULT document version.</p> 
<p><img class="alignnone wp-image-837 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/2.png" alt="" width="1877" height="514" /></p> 
<p>4. For the SourceAmiId variable, enter the ID of the Windows AMI to update. This is the only required field. The InstanceIamRole and AutomationAssumeRole variables are assigned default values that match the resource IDs generated by the CloudFormation template executed earlier.</p> 
<p><img class="alignnone wp-image-838 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/3-1.png" alt="" width="1741" height="860" /></p> 
<p>Optionally, specify values for the following (descriptions for each variable are listed in the console):</p> 
<li>Target AMI name</li> 
<li>Instance type</li> 
<li>KBs to include or exclude</li> 
<li>Update categories (Critical Update, Security Update)</li> 
<li>Severity levels (MSRC level such as Critical, Important, Low)</li> 
<li>Any pre– or post-update scripts to run</li> 
<p>5. Choose <strong>Run Automation</strong>.</p> 
<p>6. Monitor progress in the Automation Steps tab, and view the step-level outputs.</p> 
<p><img class="alignnone wp-image-829 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/4.png" alt="" width="1892" height="838" /></p> 
<p>After execution is complete, you can view any outputs returned by the workflow in the <strong>Description</strong> tab. In this example, <strong>AWS-UpdateWindowsAmi</strong> returns the new AMI ID and is tagged with your source AMI ID.</p> 
<p>Next, choose <strong>Images, AMIs</strong> to view your new AMI.</p> 
<p><img class="alignnone wp-image-830 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/5.png" alt="" width="1898" height="856" /></p> 
<p>There is no additional charge to use the Automation service, and any resources created by a workflow incur published usage charges. If you terminate AWS-UpdateWindowsAmi before reaching the “Terminate Instance” step, you should shut down the temporary instance created by the workflow.</p> 
<h3>Conclusion</h3> 
<p>Now that you’ve successfully run <strong>AWS-UpdateWindowsAmi</strong>, you may want to create default values for the service and instance roles. You can customize your workflow by creating your own Automation Document based on AWS-UpdateWindowsAmi. For more details, see <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/sysman-ami-createdoc.html">Create an Automation Document</a>. After you’ve created your Document, you can write additional steps and add them to the workflow.</p> 
<p>Example steps include:<br /> • Updating an Auto Scaling group with the new AMI ID (aws:invokeLambdaFunction action type)<br /> • Creating an encrypted copy of your new AMI (aws:encryptedCopy action type)<br /> • Validating your new AMI using Run Command with the RunPowerShellScript Document (aws:runCommand action type)<br /> Automation also makes a great addition to a CI/CD pipeline for application bake-in, and can be invoked as a CLI build step in Jenkins. For details on these examples, see the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/systems-manager-ami.html">Systems Manager Automation</a> technical documentation. Be sure to follow the <a href="https://aws.amazon.com/blogs/mt/">Management Tools blog</a> for additional deep dives on maintaining Windows AMIs using <strong>AWS-UpdateWindowsAmi.</strong></p> 
<p><strong>About the author</strong></p> 
<p><strong><img class="size-full wp-image-831 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/KRVenkt.jpg" alt="" width="119" height="160" /></strong><a href="https://www.linkedin.com/in/venkatkr/">Venkat Krishnamachari</a> is a Product Manager in the Amazon EC2 Systems Manager team. Venkat is excited by the opportunities presented by cloud computing, and loves helping customers realize the value of efficient infrastructure and management. In his personal time Venkat volunteers with NGOs and loves producing live theater and music shows.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-codedeploy/" rel="tag">AWS CodeDeploy</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-opsworks/" rel="tag">AWS OpsWorks</a>, <a href="https://aws.amazon.com/blogs/mt/tag/documents/" rel="tag">Documents</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-windows/" rel="tag">EC2 Windows</a>, <a href="https://aws.amazon.com/blogs/mt/tag/maintenance-window/" rel="tag">Maintenance Window</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-complaince/" rel="tag">Patch Complaince</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-manager/" rel="tag">Patch Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ssm/" rel="tag">SSM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Amazon EC2 Systems Manager Documents: Support for Cross-platform Documents and Multiple Steps of the Same Type</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-07-18T12:21:11+00:00">18 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/amazon-ec2-systems-manager-documents-support-for-cross-platform-documents-and-multiple-steps-of-the-same-type/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><em>This post was written by Babul Mehta, Software Development Engineer with Amazon Web Services.</em></p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a> documents define the actions that Systems Manager services perform on your managed instances. <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">Documents</a> are essentially a series of steps executed in sequence, and can be versioned and shared across accounts (and even publicly). Systems Manager includes many pre-configured documents that you can use by specifying parameters at runtime. In addition to these pre-configured public documents, you can create your own documents to perform actions relevant to your needs.</p> 
<p>With the launch of cross-platform support and the ability to have multiple steps of the same type in a document, some of the existing pain points are eliminated and you can build rich documents to perform cross-platform actions. In this post, I show you how to use these new features while creating documents and executing them via <a href="https://aws.amazon.com/ec2/systems-manager/run-command/">Run Command</a> and <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">State Manager</a>.</p> 
<p><span id="more-800"></span></p> 
<h3>Cross-platform document support</h3> 
<p>For each step in a document, you can now set preconditions that let you specify whether a step can target Windows or Linux instances. Previously, you could not add Windows-only compatible and Linux-only compatible steps in a single document. You had to create multiple, duplicate documents. With cross-platform support, this restriction is removed. I walk through an example to demonstrate this. Preconditions are supported from document schema version 2.2, which is the latest version recommended for new documents.</p> 
<h4>Precondition</h4> 
<p>You can now specify an option precondition for each step. The step is executed if the precondition is met, else it is skipped. For example:</p> 
<pre><code class="lang-json">{
&quot;action&quot;:&quot;aws:runPowerShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Windows&quot;]
},
&quot;name&quot;:&quot;runPowerShellScript&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[&quot;hostname&quot;]
}
}
</code></pre> 
<p>Here, the runPowerShellScript step is executed only on Windows instances. On Linux instances, this step is skipped.</p> 
<p>To use cross-platform functionality, your instances must be running Systems Manager (SSM) Agent version 2.0.834.0 or later.</p> 
<p>Another good example of cross-platform document is the AWS-RunPatchBaseline public document. It scans or installs patches from a patch baseline to a Linux or Windows operating system. For more information, see <a href="https://aws.amazon.com/blogs/aws/amazon-ec2-systems-manager-patch-manager-now-supports-linux/">Amazon EC2 Systems Manager Patch Manager now supports Linux</a>.</p> 
<p>Here’s another example where you can create a custom document that lists open ports on Windows and Linux managed instances. The document contains two steps: &nbsp;one runs a PowerShell command and another a Shell command. They have preconditions with platformType equaling Windows and Linux respectively, so that the same document can be targeted against both platforms. Only the compatible step is executed, while the non-compatible step is skipped.</p> 
<h4>Step 1: Create a cross-platform document</h4> 
<p>Store the following JSON in a local file:</p> 
<pre><code class="lang-json">{
&quot;schemaVersion&quot;:&quot;2.2&quot;,
&quot;description&quot;:&quot;Cross-platform demo document&quot;,
&quot;mainSteps&quot;: [
{
&quot;action&quot;:&quot;aws:runPowerShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Windows&quot;]
},
&quot;name&quot;:&quot;WindowsOpenPorts&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;: [&quot;netstat -a&quot;]
}
},
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Linux&quot;]
},
&quot;name&quot;:&quot;LinuxOpenPorts&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;: [&quot;netstat -lntu&quot;]
}
}
]
}
</code></pre> 
<p>To create the document, call the <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-document.html">CreateDocument</a> API operation:</p> 
<pre><code class="lang-bash">aws ssm create-document --name CrossPlatformDemo --content file://cross-platform_demo.json --document-type Command</code></pre> 
<p>You can execute the preceding document using Systems Manager Run Command or State Manager. This post demonstrates both.</p> 
<h4>Step 2: Execute cross-platform document via Run Command</h4> 
<p>First, execute the CrossPlatformDemo document via the Send Command API. You are executing the command against two instances: &nbsp;Windows and Linux. You can do the same via tags as well.</p> 
<pre><code class="lang-bash">aws ssm send-command --document-name &quot;CrossPlatformDemo&quot; --instance-ids &quot;i-09d19a0a297ad4c56&quot; &quot;i-07091332b7f4c71f2&quot;</code></pre> 
<p>You can view the results via AWS CLI or console. Here is the console output:</p> 
<p><img class="alignnone size-full wp-image-804" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_consoleoutput.png" alt="" width="1820" height="894" /></p> 
<p><img class="alignnone size-full wp-image-806" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_OuptutLinuxports.png" alt="" width="1458" height="714" /></p> 
<p><img class="alignnone size-full wp-image-808" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_windowsportoutput.png" alt="" width="1404" height="178" /></p> 
<p>The preceding screenshots are the results from the Linux instance. You can see that the LinuxOpenPorts step got executed and returned valid results, while the WindowsOpenPorts step was skipped because the precondition was not satisfied on the Linux instance.</p> 
<h4>Step 3: &nbsp;Execute the cross-platform document via State Manager</h4> 
<p>Now, execute the same document via State Manager by <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-association.html">creating an association</a>. An association is a binding of the intent (described in the document) to a target specified by either a list of instance IDs or a tag query.</p> 
<p>Use the following command to create an association using a tag query. The document name is from the previous step: “CrossPlatformDemo”.</p> 
<pre><code class="lang-bash">aws ssm create-association --name CrossPlatformDemo --targets &quot;Key=tag:Scenario,Values=Demo&quot; --schedule-expression &quot;cron(0 0/30 * 1/1 * ? *)&quot;</code></pre> 
<p>After you create an association, you can view the details using either the CLI or the console. You can easily drill down and find out which instances were targeted as part of this State Manager association, and their status.</p> 
<p><img class="alignnone size-full wp-image-809" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/SM_mainpage.png" alt="" width="1536" height="956" /></p> 
<h3>Multiple steps of the same type</h3> 
<p>Previously, Systems Manager did not support having the same step or plugin multiple times within a document. This made it cumbersome to separate out logical steps, such as pre- and post-scripts in a configuration.</p> 
<p>With this addition, you can perform more powerful configurations using Systems Manager. For example, you can use RunShellScript to install different applications. It is more organized if you have different steps for each application, instead of forcing everything in one step.</p> 
<p>In the following example, you install SSMAgent and Apache HTTP Server in two separate steps. They both run the RunShellScript plugin.</p> 
<h4>Step 1: &nbsp;Create a document with multiple steps of the same type</h4> 
<p>Store the following JSON in a local file:</p> 
<pre><code class="lang-json">{
&quot;schemaVersion&quot;:&quot;2.0&quot;,
&quot;description&quot;:&quot;Multiple steps of same type demo document&quot;,
&quot;mainSteps&quot;: [
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;name&quot;:&quot;installSSMAgent&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[
&quot;sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm&quot;,
&quot;sudo start amazon-ssm-agent&quot;,
&quot;sudo status amazon-ssm-agent&quot;
]
}
},
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;name&quot;:&quot;installApache&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[
&quot;sudo yum install -y httpd24&quot;
]
}
}
]
}</code></pre> 
<p>To create the document, call the <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-document.html">CreateDocument</a> API operation:</p> 
<pre><code class="lang-bash">aws ssm create-document --name MultipleStepsDemo --content file://multiple-steps_demo.json --document-type Command</code></pre> 
<p>Again, you can execute this document via Systems Manager Run Command or State Manager. For this scenario, execute it via Run Command only.</p> 
<h4>Step 2: Execute the multiple-steps document via Run Command</h4> 
<p>The following command executes the MultipleStepsDemo document against one instance. You can do the same via tags as well.</p> 
<pre><code class="lang-bash">aws ssm send-command --document-name &quot;MultipleStepsDemo&quot; --instance-ids &quot;i-09d19a0a297ad4c56&quot;</code></pre> 
<p>You can view the results via CLI or console. Here’s the output from the console.</p> 
<p><img class="alignnone size-full wp-image-803" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_console_multiplesteps.png" alt="" width="1848" height="896" /></p> 
<p><img class="alignnone size-full wp-image-805" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_istallapache_output.png" alt="" width="1454" height="984" /></p> 
<p><img class="alignnone size-full wp-image-807" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_outputinstallssmagent.png" alt="" width="1436" height="1022" /></p> 
<h3>Conclusion</h3> 
<p>In this post, I showed you how to use the newly launched Systems Manager document features to create cross-platform documents, and have multiple steps of same type within a document. These features eliminate the current pain point of maintaining a duplicate set of documents for different platforms. They also open up more possibilities to create rich documents that you can use with Systems Manager to manage and configure your EC2 instance fleet.</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img class="size-full wp-image-810 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/babul.jpg" alt="" width="119" height="160" />Babul Mehta is a Software Development Engineer in the Amazon EC2 Systems Manager team. Outside of work, he loves to watch cricket and American football and he is a big fan of the Indian cricket team and the Seahawks.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/documents/" rel="tag">Documents</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ssm/" rel="tag">SSM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to track configuration changes to CloudFormation stacks using AWS Config</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Shashi Prabhakar</span></span> and 
<span property="author" typeof="Person"><span property="name">Sid Gupta</span></span> | on 
<time property="datePublished" datetime="2017-07-18T11:02:01+00:00">18 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-configuration-changes-to-cloudformation-stacks-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> stacks. You can now start tracking the current and historical configuration of your CloudFormation stacks, and get notified via <a href="https://aws.amazon.com/sns">Amazon SNS</a> when your stack configuration changes. You can also use a managed AWS Config rule to check whether your CloudFormation stacks are sending event notifications to an SNS topic.</p> 
<p>Tracking configuration changes to a CloudFormation stack is valuable from a governance perspective. It tells you how and when a stack got modified. Use this information to troubleshoot operational issues and outages, and maintain audit compliance.</p> 
<p>In this post, I describe two possible use cases, tracking stack changes and evaluating compliance, and walk you through each scenario.</p> 
<p><span id="more-757"></span></p> 
<h3>AWS services</h3> 
<p>AWS Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p>CloudFormation gives developers and systems administrators an easy way to create and manage a collection of related AWS resources, provisioning and updating them in an orderly and predictable fashion. CloudFormation standardizes the manner in which resources get deployed into your environments and simplifies the management of cloud resources. You can create your own templates to describe the AWS resources, and any associated dependencies or runtime parameters, required to run your application. You can deploy and update a template and its associated collection of resources (called a stack) by using the AWS Management Console, AWS CLI, or APIs.</p> 
<h3>Example: Track stack configuration changes</h3> 
<p>When you create a stack, all update actions are allowed on all resources. By default, anyone with stack update permissions can update all of the resources in the stack.</p> 
<p>With a stack policy, you can prevent <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">stack resources</a> from being unintentionally updated or deleted during a stack update. A stack policy is a JSON document that defines the update actions that can be performed on designated resources. Use a stack policy only as a fail-safe mechanism to prevent accidental updates to specific stack resources.</p> 
<p>Consider a scenario where Bob, a cloud administrator, provisions a stack that creates a secure VPC for a public-facing application that includes subnets, NAT gateways, route tables, and custom network ACL rules. The security of this stack and its underlying resources is critical since it contains the essential building blocks for creating applications and any changes to this VPC, subnets, route tables etc. could potentially impact all applications hosted within that VPC. Hence, in order to prevent changes to this stack, Bob applies a “deny all” stack policy that disallows updates to all resources in the stack.</p> 
<p>Adam, an application developer with stack update permissions attempts to modify the stack. He realizes that the stack cannot be updated due to the “deny all” stack policy, so he attaches a new stack policy (“allow all”) that allows updates to all resources in the stack.</p> 
<p>You can capture these changes via AWS Config and use them to alert Bob, the cloud administrator. Download the CloudFormation template <a href="https://s3.amazonaws.com/quickstart-reference/enterprise-accelerator/nist/latest/submodules/quickstart-compliance-common/templates/vpc-production.template">VPC-Production</a> for this example. This template configures a secure VPC for a public-facing application that includes subnets, NAT gateways, route tables, and custom network ACL rules. The example uses the AWS Management Console, but you can use the AWS CLI or SDKs as well.</p> 
<p>In the CloudFormation console, you can see what resources were configured when the stack was launched.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image001.png"><img class="alignleft wp-image-758 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image001.png" alt="" width="1430" height="635" /></a></p> 
<p>&nbsp;</p> 
<p>The following stack policy was attached at launch time. This policy denies updates to all resources in this stack.</p> 
<pre><code class="lang-json">{
&quot;Statement&quot; : [
{
&quot;Effect&quot; : &quot;Deny&quot;,
&quot;Action&quot; : &quot;Update:*&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Resource&quot; : &quot;*&quot;
}
]
}</code></pre> 
<p>Now, Adam, the application developer with stack update permissions, wants to modify the management subnet IP address range “pManagement CIDR”. After realizing that the stack has a “deny all” stack policy, he updates the stack policy via CLI as shown below:</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image002.png"><img class="alignleft wp-image-759 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image002.png" alt="" width="813" height="80" /></a></p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>This policy basically allows all updates to stack resources:</p> 
<p>&nbsp;</p> 
<pre><code class="lang-json">{
&quot;Statement&quot; : [
{
&quot;Effect&quot; : &quot;Allow&quot;,
&quot;Action&quot; : &quot;Update:*&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Resource&quot; : &quot;*&quot;
}
]
}</code></pre> 
<p>He then updates the stack to change the management subnet IP address range.</p> 
<p>Check how AWS Config tracked these modifications. First, log in to the AWS Config console. Choose <strong>Resources</strong>. For <strong>Resources</strong>, choose <strong>CloudFormation: Stack</strong>. To see the list of all CloudFormation stacks being recorded in Config, choose <strong>Look up</strong>.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image003.png"><img class="alignleft wp-image-760 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image003.png" alt="" width="1868" height="703" /></a>In this example, open the CloudFormation stack named <strong>myProdVPC</strong> to view its <strong>Config timeline</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image004.png"><img class="alignleft wp-image-761 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image004.png" alt="" width="1867" height="824" /></a></p> 
<p>At the top, you see a timeline of all changes that have occurred to the stack after creation.</p> 
<p>You can see the configuration of the stack under <strong>Configuration Details</strong>. This includes the Amazon resource name (ARN), resource ID, rollback settings, and creation time.</p> 
<p>In this scenario, there were 8 changes on July 10th. You can drill down further to see what those changes were. The stack policy was modified to allow updates to all resources, and then an EC2 network ACL entry was modified. Specifically, the “pManagement CIDR” block was modified from 10.100.10.0/24 to 10.100.96.0/21.</p> 
<p>AWS Config also sends an SNS notification each time a configuration change is detected, so that you can be alerted of changes to your CloudFormation stacks.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p2.jpg"><img class="alignleft wp-image-794 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p2.jpg" alt="" width="1856" height="758" /></a> <a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p1.jpg"><img class="alignleft size-full wp-image-793" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p1.jpg" alt="" width="1846" height="651" /></a></p> 
<p>In addition to reviewing these configuration changes, you can also see the entire list of resources within the stack. View <strong>Relationships</strong> for resource types supported in AWS Config, and view <strong>Unsupported Resources</strong> for resource types not currently supported in AWS Config.</p> 
<p>You can also view the configuration history of resources currently supported in AWS Config, if you choose to investigate further.</p> 
<h3><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image007.png"><img class="alignleft size-full wp-image-764" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image007.png" alt="" width="1847" height="841" /></a>Example: AWS Config rules</h3> 
<p>In addition to tracking the configuration of your CloudFormation stacks, you can use AWS Config rules to check your stacks against best practice rules and internal policies.</p> 
<p>For example, use the prebuilt rules called <strong>cloudformation-stack-notification-check</strong> to verify whether your CloudFormation stacks are sending event notifications to an SNS topic at all times. The following example shows compliant and noncompliant configuration states.</p> 
<p>cloudformation-stack-notification-check</p> 
<p>The CloudFormation stack that you created earlier is showing as noncompliant with this rule, as it does not have any SNS topic configured.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image008.png"><img class="alignleft size-full wp-image-765" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image008.png" alt="" width="1861" height="803" /></a></p> 
<p>&nbsp;</p> 
<p>After adding a notification topic to the stack in the CloudFormation console, you can see that the compliance status changes to the compliant state.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image009.png"><img class="alignleft size-full wp-image-766" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image009.png" alt="" width="1862" height="508" /></a></p> 
<h3>Summary</h3> 
<p>With support for CloudFormation stacks in AWS Config, you can now continuously track configuration changes to all stacks, including stack policies and parameter changes. You can use AWS Config rules to verify configuration best practices and compliance with internal policies.</p> 
<p>&nbsp;</p> 
<hr /> 
<p>About the Authors</p> 
<p><img class="alignleft wp-image-786 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/profile-pic-150x150.png" alt="" width="150" height="150" /></p> 
<p>Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and help them implement cloud security best practices. In his spare time, he enjoys hiking, reading and spending time with his kids.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img class="alignleft wp-image-787 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/shashi.jpg" alt="" width="150" height="150" /></p> 
<p>Shashi Prabhakar is a Solutions Architect at AWS. He loves working with customers to help design, architect and build variety of workloads. Shashi always gets excited to learn new Technologies and Businesses while working with customers. When not learning, he likes to run, play tennis, travel, spend time with wife and enjoy life.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-config/" rel="tag">AWS Config</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Running Salt States Using Amazon EC2 Systems Manager</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Andres Silva</span></span> | on 
<time property="datePublished" datetime="2017-07-16T22:38:49+00:00">16 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/running-salt-states-using-amazon-ec2-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Like <a href="https://www.ansible.com/">Ansible</a>, <a href="https://saltstack.com/">Salt</a> is a popular tool for configuration management. As with other tools in the same category, one of the key challenges is efficiently managing the deployment and execution of the automation directives.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a> is a powerful configuration management platform. One of its key benefits is that it allows customers to use whatever configuration management tool they are currently using. In the <a href="https://aws.amazon.com/blogs/mt/running-ansible-playbooks-using-ec2-systems-manager-run-command-and-state-manager/">Running Ansible Playbooks using EC2 Systems Manager Run Command and State Manager</a> post, I explained how Systems Manager can be used to manage configuration management states using Ansible.</p> 
<p>In this post, I explore how to use Salt (on master-less mode), while leveraging the power, simplicity, and security of Systems Manager. I also introduce a new Systems Manager document that makes it easier for customers to run Salt states.</p> 
<p><span id="more-693"></span></p> 
<b>Systems Manager overview</b> 
<p>Systems Manager uses <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">documents</a> to define actions to be executed on your managed instances.</p> 
<p>Some of the benefits of using Systems Manager:</p> 
<li>Improved security posture 
<li>There is no need to open incoming ports to remotely execute the directives. This eliminates the need for using SSH.</li> 
<li>You can use granular IAM policies to restrict and control access to the platform</li> 
<li>All command execution is audited via AWS CloudTrail.</li> 
</ul> </li> 
<li>Performance and reliability 
<li>Asynchronously execute commands.</li> 
<li>Commands are delivered and executed even when the system comes back from being offline.</li> 
<li>Execute at scale by taking advantage of velocity control and sending commands based on tags.</li> 
<li>Control deployment rate if errors increase during deployment.</li> 
</ul> </li> 
<p>&nbsp;</p> 
<b>Salt overview</b> 
<p>Salt uses the concept of states. A state is a set of configuration directives that represents what software should be installed and how it should be configured.</p> 
<p>In typical deployments, Salt is used with a master server. The servers that receive automation directives are called minions. However, Salt states can also be run locally in what is called master-less mode. Using this feature, you can leverage Systems Manager to distribute and execute the Salt state files using <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">Amazon EC2 State Manager</a> or <a href="https://aws.amazon.com/ec2/run-command/">Run Command</a>.</p> 
<b>AWS-RunSaltState document</b> 
<p>The new document that automates the process of running Salt states locally using Systems Manager is AWSRunSaltState. It is available to use via the console or API. Here are the different parts of the document and how it works:</p> 
<li>Parameters</li> 
<li>Steps</li> 
<li>Salt-call</li> 
<h3>Parameters</h3> 
<p>The AWSRunSaltState document provides a number of parameters to execute the Salt states:</p> 
<li><strong>State</strong> – Allows for input YAML to define the Salt state automation.</li> 
<li><strong>Stateurl</strong> – (Optional) Provides a URL to a file that contains the YAML text for the Salt state. The URL can be in http or s3 format.</li> 
<li><strong>Pillars</strong> – (Optional) Passes additional variables to be used during the execution. Salt uses the concept of pillars to define data that can be used to configure the managed instances (minions).</li> 
<li><strong>Test</strong> – If true, performs a dry-run of the state. This reports on the actions to be performed by the automation but does not execute them.</li> 
<h3>Steps</h3> 
<p>The AWSRunSaltState document performs a few validations, then executes the automation using the YAML definitions passed by the parameters. Here is a summary of how the logic works:</p> 
<li>Checks the Salt version to determine if Salt is present on the system.</li> 
<li>Determines if the <strong>State</strong> parameter was passed as YAML using the <strong>State</strong> text or as a URL using <strong>Stateurl</strong>. Based on the input, it copies the data to a temporary state file for later execution.</li> 
<li>Determines if the test option was selected and executes the proper command.</li> 
<h3>Salt-call</h3> 
<p>Salt includes an application called salt-call that can be used on managed instances to execute Salt states locally. The AWSRunSaltState document uses this application to execute the Salt state locally.</p> 
<b>Walkthrough using Systems Manager and State Manager</b> 
<p>Here’s an example of using State Manager with the new document to execute Salt state files.</p> 
<b>Prerequisites</b> 
<p>Complete the following requirements before going through this walkthrough:</p> 
<li>Target instances must be managed by Systems Manager. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html">Installing SSM Agent</a>.</li> 
<li>Salt must be pre-installed on the target instance or execution fails. This document runs Salt states locally. For more information, see the following section on installing Salt for master-less execution.</li> 
<li>For S3 URLs in the playbook field, the <a href="https://aws.amazon.com/cli/">AWS CLI</a> must be installed on the target instance or server.</li> 
<b>Installing Salt for master-less execution</b> 
<p><em>If you already have Salt installed on the target instances, you can skip this section. </em></p> 
<p>Install Salt on the target instances to run what is called a master-less minion. Execute the following on the Linux instance:</p> 
<pre><code class="lang-bash">curl -L https://bootstrap.saltstack.com -o bootstrap_salt.sh
sudo sh bootstrap_salt.sh</code></pre> 
<p>&nbsp;</p> 
<p>You could also run these two commands using Systems Manager Run Command and the AWS-RunShellScript document. This installs the necessary files to run Salt in master-less mode, using the salt-call application to execute the automation. This command is installed as part of the master-less bootstrapping.</p> 
<b>Using State Manager and the AWSRunSalt document</b> 
<p>The following YAML Salt state file contains automation that installs Apache if it is not already installed.</p> 
<p>&nbsp;</p> 
<pre><code class="lang-yaml">apache:
pkg.installed:
{% if grains['os'] == 'Amazon' %}
- name: httpd
{% elif grains['os'] == 'Ubuntu' %}
- name: apache2
{% endif %}</code></pre> 
<p>To use this Salt state file with Systems Manager, follow these steps:</p> 
<ol> 
<li>In the EC2 console, choose <strong>State Manager, Create Association</strong>.</li> 
<li>From the Document list, choose the new document “AWS-RunSaltState”.</li> 
<li>For <strong>Document Version</strong>, leave $DEFAULT selected.</li> 
<li>Under <strong>Targets</strong>, choose <strong>Manually Selecting instances</strong> and select the instance or instances to target with the Salt state. Alternatively, use a tag to select the instances to target. <img class="wp-image-9" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/07/SaltPicture4.png" /></li> 
<li>Under <strong>Schedule</strong>, enter how frequently to run the association.</li> 
<li>Under <strong>Parameters</strong>, for <strong>State, </strong>paste the YAML text for the Salt state. Leave <strong>Stateurl</strong> empty. <img class="wp-image-10" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/10/SaltPicture6-1.png" /></li> 
<li>For <strong>Pillars</strong>, enter the additional variables to use for the Salt state. Make sure the values are entered in the following format:</li> 
</ol> 
<p>{“SSM”:”True”}</p> 
<p>You can also use nested dict:</p> 
<p>{‘pkg’: {‘apache’: ‘httpd’}}</p> 
<ol> 
<li>(Optional) Choose the test option.</li> 
<li>(Optional) Enter a comment for this association.</li> 
<li>Choose <strong>Run</strong>.</li> 
<li>To verify the output from the console, choose the <strong>Association ID</strong> link for this run. <img class="wp-image-11" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/07/SaltPicture8.png" /></li> 
</ol> 
<p>After the association runs for the first time, you can see the results of the execution by navigating to the association and looking at the <strong>Status</strong> column. Now, every time the association runs, it run the salt state and this in turn ensures that the software is installed and running.</p> 
<b>Integration with Parameter Store</b> 
<p>All Systems Manager documents support referencing settings or secrets stored in Parameter Store, which provides a secure storage for configuration data such as passwords, database connection strings, and license code. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html">Systems Manager Parameter Store</a>.</p> 
<p>To use data stored in Parameter Store with Salt, reference it as part of the State code using the following format:</p> 
<pre><code class="lang-json">{{ssm:parameter_name}}</code></pre> 
<p>&nbsp;</p> 
<p>For example, to run a simple touch command to create a file in the /tmp directory and pass the file name as a saved setting, make sure that the parameter is created in Parameter Store. The Salt state file looks like the following:</p> 
<pre><code class="lang-yaml">mycommand:
cmd.run:
- name: touch /tmp/{{ssm:tempfilename}} /</code></pre> 
<p>&nbsp;</p> 
<b>Summary</b> 
<p>In this post, I introduced the new Systems Manager document to execute Salt state files using State Manager and Run Command. I also demonstrated how you can use this new document to deploy and manage your Salt automation.</p> 
<p>You can also use this Systems Manager document with the Run Command option and leverage velocity control. For an example on how to do this, see the <a href="https://aws.amazon.com/blogs/mt/running-ansible-playbooks-using-ec2-systems-manager-run-command-and-state-manager/">Running Ansible Playbooks using EC2 Systems Manager Run Command and State Manager</a> post.</p> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<p><img class="alignleft wp-image-453 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Andres-headshot-150x150.jpg" alt="" width="150" height="150" /></p> 
<p>Andres Silva is a Senior Technical Account Manager for AWS Enterprise Support. He has been working with AWS technology for more than 6 years. Andres works with Enterprise customers to design, implement and support complex cloud infrastructures. When he is not building cloud automation he enjoys skateboarding with his 2 kids.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a></span> 
</footer> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Monitor and Notify on AWS Account Root User Activity</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Sudhanshu Malhotra</span></span> | on 
<time property="datePublished" datetime="2017-07-14T11:16:44+00:00">14 JUL 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch*"><span property="articleSection">Amazon CloudWatch*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/monitor-and-notify-on-aws-account-root-user-activity/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Are you aware when someone uses your AWS account credentials to perform some activity? Are you notified in time?</p> 
<p>When you first create an AWS account, you begin only with a single sign-in identity that has complete access to all AWS services and resources in the account. This identity is called the root user and is accessed by signing in with the email address and password that you used to create the account.</p> 
<p>An AWS account root user has full access to all your resources for all AWS services, including billing information. It is critical to prevent root user access from getting into the wrong hands and to be aware whenever root user activity occurs in your AWS account. For more information about AWS recommendations, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html">IAM Best Practices</a>. Some of the key recommendations include:</p> 
<li>Enabling multi factor authentication (MFA)</li> 
<li>Setting complex passwords</li> 
<li>Avoiding creating access key for root</li> 
<li>Creating an admin level IAM user to perform any high privilege activities</li> 
<p>However, there are <a href="https://docs.aws.amazon.com/general/latest/gr/aws_tasks-that-require-root.html">certain actions that can only be performed by the root user</a>. To be certain that all root user activity is authorized and expected, it is important to monitor root API calls to a given AWS account and to notify when this type of activity is detected. This notification gives you the ability to take any necessary steps when an illegitimate root API activity is detected or it can simply be used as a record for any future auditing needs.</p> 
<p>In this post, I walk through a solution that monitors and notifies on root API activity for an AWS account.</p> 
<p><span id="more-751"></span></p> 
<b>Solution</b> 
<p>The diagram below describes the solution at a high level.</p> 
<p>&nbsp;</p> 
<p><img class="alignnone size-full wp-image-1365" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/flow_diagram-1.jpg" alt="" width="2118" height="294" /></p> 
<ol> 
<li>An <a href="https://aws.amazon.com/cloudwatch">Amazon CloudWatch Events</a> rule detects any AWS account root user API events.</li> 
<li>It triggers an <a href="https://aws.amazon.com/lambda">AWS Lambda</a> function.</li> 
<li>The Lambda function then processes the root API event. It also publishes a message to an <a href="https://aws.amazon.com/sns">Amazon SNS topic</a>, where the subject contains the AWS account ID or AWS account alias where the root API call was detected and the type of API activity.</li> 
<li>The SNS topic then sends notifications to its email subscribers about this event.</li> 
</ol> 
<p>I walk through deploying the <a href="https://aws.amazon.com/cloudformation">AWS CloudFormation</a> stack that creates these resources and then validates that root user activity is detected and notified. It helps if you know about&nbsp;<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">CloudWatch Events rules</a>,&nbsp;<a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html">Lambda</a>,&nbsp;and&nbsp;<a href="https://docs.aws.amazon.com/sns/latest/dg/welcome.html">SNS</a>.</p> 
<p>&nbsp;</p> 
<b>Prerequisites</b> 
<li>Create and enable a multi-region <a href="https://aws.amazon.com/cloudtrail">AWS CloudTrail</a> trail for all AWS regions.</li> 
<li>Upload the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/RootActivityLambda.zip">RootActivityLambda.zip</a> file to an S3 bucket.</li> 
<p>&nbsp;</p> 
<b>Deployment steps</b> 
<ol> 
<li>In the CloudFormation console, choose <strong>Create Stack</strong>.&nbsp;Use the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/RootAPIMonitor.json">RootAPIMonitor.json</a> CloudFormation JSON template. Choose <strong>Next</strong>.</li> 
<li>Create the stack in the region in which to monitor root API activity, as well as the us-east-1 region. Root API login is a global event and logged in us-east-1. I recommend deploying in all AWS regions.</li> 
<li>Enter the following parameter details and choose <strong>Next</strong>: 
<li><strong>SNSTopicName</strong>: A unique name for the SNS topic to be created.</li> 
<li><strong>SNSSubscriptions</strong>: An email address to subscribe to the SNS topic.&nbsp;. I recommend sending these notifications to a distribution list rather than an individual.</li> 
<li><strong>LambdaTimeout</strong>: The Lambda function timeout value in seconds. The default is 30 seconds.</li> 
<li><strong>LambdaS3Bucket</strong>: Name of the S3 bucket where the Lambda function zip file is stored.</li> 
<li><strong>LambdaS3Key</strong>: Name of the Lambda function zip file. This is the full path to the S3 object, with the prefix. For example, “/dir1/dir2/lambdafunction.zip”.</li> 
</ul> </li> 
<li>Select <strong>Capabilities Acknowledgement</strong> and choose <strong>Create</strong>. This field gives permission to the stack to create IAM roles and policies. These roles and policies are used by the Lambda function to perform certain actions such as publishing messages to the SNS topic, listing the account alias, and so on.</li> 
<li>After the CloudFormation stack completes, check for an SNS subscription email sent to the email provided for <strong>SNSSubscriptions</strong>. Open the <strong>SubscribeURL</strong> link to complete the subscription.<img class="alignnone size-full wp-image-1378" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/subscribe_email.png" alt="" width="496" height="285" /></li> 
<li>After the SNS topic is subscribed, the subscriber starts receiving email notification when root API activity is detected.</li> 
</ol> 
<p>&nbsp;</p> 
<p>The CloudFormation template created three main AWS resources for this solution:</p> 
<p>&nbsp;</p> 
<h3>CloudWatch Events rule</h3> 
<p>The rule catches a console login event and all other API events by a root user, and triggers the Lambda function (set as a target) when such events are detected.</p> 
<p><img class="alignnone size-full wp-image-1379" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/CWE_snapshot.png" alt="" width="824" height="545" /></p> 
<p>&nbsp;</p> 
<h3>Lambda function</h3> 
<p>The function collects the necessary information about the root API event and publishes it to the SNS topic. The function parses the name of the event and the AWS account alias where this root API event occurred and puts them in the subject field for the message that it publishes to the SNS topic.</p> 
<p>&nbsp;</p> 
<p>Code for getting the name of the event:</p> 
<pre><code class="lang-python">def lambda_handler(event, context):
logger.setLevel(logging.INFO)
eventname = event['detail']['eventName']
</code></pre> 
<p>Code for getting the AWS account alias:</p> 
<pre><code class="lang-python">response = client.list_account_aliases()
logger.debug(&quot;List account alias response --- %s&quot; %response)
try:
if not response['AccountAliases']:
accntAlias = (boto3.client('sts').get_caller_identity()['Account'])
logger.info(&quot;Account alias is not defined. Account ID is %s&quot; %accntAliase)
else:
accntAliase = response['AccountAliases'][0]
logger.info(&quot;Account alias is : %s&quot; %accntAliase)
except ClientError as e:
logger.error(&quot;Client error occurred&quot;)</code></pre> 
<p>Code for publishing to the SNS topic:</p> 
<pre><code class="lang-python">try: 
#Sending the notification...
snspublish = snsclient.publish(
TargetArn= snsARN,
Subject=((&quot;Root API call-\&quot;%s\&quot; detected in Account-\&quot;%s\&quot;&quot; %(eventname,accntAliase))[:100]),
Message=json.dumps({'default':json.dumps(event)}),
MessageStructure='json')
</code></pre> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<h3>SNS topic</h3> 
<p>The topic sends the email notification published by the Lambda function.</p> 
<p><img class="alignnone size-full wp-image-1380" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/SNS.png" alt="" width="826" height="406" /></p> 
<p>&nbsp;</p> 
<b>Solution validation</b> 
<p>Now that you have the solution deployed and ready, test and validate. First, sign in to your AWS account using your access credentials. This console login activity by a root user should send an email notification in near real time.</p> 
<p><img class="alignnone size-full wp-image-1381" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/login_notify.png" alt="" width="609" height="269" /></p> 
<p>&nbsp;</p> 
<p>Next, validate if other root API events are also detected and notified on. For example, you can create an EBS volume using the root credentials and confirm that you receive an email notification in near real time.</p> 
<p><img class="alignnone size-full wp-image-1382" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/ebs.png" alt="" width="630" height="260" /></p> 
<p>Some AWS services—such as Auto Scaling, Elastic Load Balancing, and Trusted Advisor—use root to access resources in your AWS account, instead of an IAM role. When this happens, you see the service name in the&nbsp;<strong>invokedBy</strong>&nbsp;field of the&nbsp;<strong>userIdentity</strong>&nbsp;JSON statement. This event is legitimate and can be ignored. For more information, see <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudtrail-root-action-logs/">My AWS CloudTrail logs show root credentials are being used to authenticate actions I didn’t initiate</a>.</p> 
<b>Summary</b> 
<p>In this post, I showed you how to monitor and notify on root API activity for an AWS account. This framework can be extended to monitor and notify on other IAM user activity, giving you the ability to monitor highly privileged users in near real time.</p> 
<p>For more information, I recommend the following whitepapers:</p> 
<li><a href="https://d0.awsstatic.com/whitepapers/Security/AWS_Security_Whitepaper.pdf">Amazon Web Services: Overview of Security Processes</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Governance_in_AWS_Whitepaper.pdf">Security at Scale: Governance in AWS</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/Automating_Governance_on_AWS.pdf">Automating Governance on AWS</a></li> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<p><img class="alignleft size-thumbnail wp-image-747" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/10/dp-119x150.jpeg" alt="" width="119" height="150" />Sudhanshu Malhotra is a Solutions Architect at AWS Professional Services. Sudhanshu enjoys working with our customers and helping them deliver complex solutions in AWS in the area of DevOps, Infrastructure-as-Code and Config Management. In his spare time, Sudhanshu enjoys spending time with his family, hiking and tinkering with cars.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-lambda/" rel="tag">AWS Lambda</a>, <a href="https://aws.amazon.com/blogs/mt/tag/root-credentials/" rel="tag">root credentials</a>, <a href="https://aws.amazon.com/blogs/mt/tag/secdevops/" rel="tag">SecDevOps</a></span> 
</footer> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
