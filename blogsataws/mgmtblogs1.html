<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Recovering AWS CloudFormation stacks using ContinueUpdateRollback</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Casey Nishant</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:37:00+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/recovering-aws-cloudformation-stacks-using-continueupdaterollback/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS CloudFormation treats a stack as a collection of AWS resources that customers can manage as a single unit. After you launch a stack, you can use the AWS CloudFormation console, API, or AWS CLI to update resources in your stacks. You should not make any changes to stack resources outside of CloudFormation. This is due to something we call resource drift. Resource drift occurs when you make out-of-band changes to CloudFormation managed resources that can cause errors if you later update or delete the stack.</p> 
<p>This blog post walks you through examples of how to recover your stack from states such as <em>UPDATE_ROLLBACK_FAILED</em>. We show you how to regain control of the stack to perform further updates using CloudFormation without intervention from AWS Support.</p> 
<p><span id="more-2526"></span></p> 
<b><span style="text-decoration: underline"><a name="update_rollback_failed"></a>UPDATE_ROLLBACK_FAILED</span></b> 
<p>Out-of-band changes can easily occur when there are newcomers to your organization who make accidental changes to resources created by CloudFormation. These changes can also be made by members of different teams who might not have awareness of the service. Out-of-band changes can cause your CloudFormation stack to enter a state in which you are no longer able to continue modifying the stack. When a stack reaches UPDATE_ROLLBACK_FAILED, this means that the CloudFormation stack was attempting an UPDATE operation, the operation failed, and we began a rollback. An issue occurred that stopped CloudFormation from returning to the previous “good” state during the rollback. As a result, the stack can’t update and can’t roll back, thus it assumes this half-way state. The API then stops any further actions on the stack other than ContinueUpdateRollback and DeleteStack.</p> 
<b><a name="continueupdaterollback"></a>ContinueUpdateRollback</b> 
<p>The <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-continueupdaterollback.html">ContinueUpdateRollback API</a> operation provides customers an override for stacks in an UPDATE_ROLLBACK_FAILED state. It forces CloudFormation to continue with the rollback procedure. Use this operation only for troubleshooting. When a failure occurs and the stack enters an UPDATE_ROLLBACK_FAILED state, the API operation simply continues the rollback. However, it provides no fix to the underlying issue. For example, it doesn’t fix the underlying issue of whether a rollback failed due to an account limit. If you don’t address this account limit constraint, ContinueUpdateRollback will simply retry the rollback and fail once more. You still need to fix the underlying problem separately and, in a break from best-practices, outside of AWS CloudFormation.</p> 
<b>A practical example</b> 
<p>We’ll walk you through a scenario involving stacks entering the UPDATE_ROLLBACK_FAILED state and the use of the Auto Scaling service. Let’s take a look at a CloudFormation template.</p> 
<p><b>Note</b>: This template can be deployed in any Region as long as you specify a valid HVM-compatible Amazon Machine Image (AMI) on launch. Alternatively, to launch it <i>as-is</i> use the Europe (London) (eu-west-2) Region.</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.micro&quot;
</code> 
<p>As you can see, we create an Auto Scaling group with a launch configuration and our stack is created just as we expected.</p> 
<h3><a name="chaos-ensues"></a>Chaos ensues</h3> 
<p>To continue our hypothetical, let’s pretend that we hire Jimmy, a new member of the operations team fresh out his AWS Certified Solutions Architect Associate exam. One day, while you are not around, the development team asks him to decrease the size of the instance type for the Auto Scaling group. He decides it’s best to create a cool new launch configuration for the running the Auto Scaling group and assign the new launch configuration to the group:</p> 
<code class="lang-bash">aws autoscaling create-launch-configuration --launch-configuration-name Jimmys_new_LC --image-id ami-1a7f6d7e --instance-type t2.nano --region eu-west-2
ASName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id ASG --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling update-auto-scaling-group --auto-scaling-group-name $ASName --launch-configuration-name Jimmys_new_LC --region eu-west-2
</code> 
<p>Of course, he also decides to clean up the old Auto Scaling launch configuration for good measure:</p> 
<p>(For your ease of replication, I include the first line below to fetch the physical ID of the launch configuration created by the previous template.)</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling delete-launch-configuration --launch-configuration-name $LCName --region eu-west-2
</code> 
<p>Oh Jimmy, we had such high hopes…</p> 
<h3><a name="rollbacks-and-stabilization"></a>Rollbacks and stabilization</h3> 
<p>In the majority of my tests AWS CloudFormation attempts to fail fast. For example, if we were to add a HealthCheckType with an incorrect value, the initial API call would fail and the stack would roll back. However, because CloudFormation did not replace or successfully change the configuration of the target resource, it correctly assumes that no API call is necessary in order to roll back.</p> 
<p>A rollback can trigger a reapplication of a previous configuration after a period of time. CloudFormation refers to this as stabilization. CloudFormation performs an API call on behalf of a user, and in addition, it attempts to ensure that, when a resource is labeled as CREATE COMPLETE, the resource is running in the desired state. For Auto Scaling for example, it sends a CreateAutoScalingGroup API call and then attempts to DescribeAutoScalingGroup until the group has a Min/Max and Desired count equal to the count defined in the template. If this doesn’t occur, CloudFormation must then reapply the previous configuration.</p> 
<h3><a name="forcing-a-rollback"></a>Forcing a rollback</h3> 
<p>In our example, we could force this type of failure by increasing the Auto Scaling group’s capacity past our account limit for running On-Demand instances. This would in turn fail stabilization and trigger our rollback. At this point CloudFormation would be unable to find the previously defined launch configuration and the stack would then enter the UPDATE_ROLLBACK_FAILED state. However, this would involve launching a number of unused instances, which would not be very frugal. Instead, we can use the CloudFormation Wait Condition resource to simulate a failure and force a rollback.</p> 
<p>This is how we update the CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.large&quot;
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: ASG
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p class="FirstParagraph">As you can see, the template updates our launch configuration to use t2.large instances. However, because we never signal our WaitCondition, the stack will roll back. At this point CloudFormation will attempt to reapply the launch configuration. However, as we saw earlier, Jimmy deleted our launch configuration. So any update on the stack that updates the Auto Scaling group and triggers a rollback will fail.</p> 
<h3><a name="general-guidance-on-recovering-stuck-sta"></a>General guidance on recovering <i>stuck</i> stacks</h3> 
<p class="FirstParagraph">To address issues with CloudFormation stacks that have entered UPDATE_ROLLBACK_FAILED state you have three options:</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">1.<span style="font: 7.0pt 'Times New Roman'"><code> </code></span>Delete the stack. If the deletion fails for any reason, you can then use the DeleteStack API operation with the RetainResources option listing resources that failed deletion.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">2. Make underlying account changes manually/outside the scope of the stack to re-synchronize the stack with the expectation and then perform ContinueUpdateRollback.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">3. If you address the issues with the underlying stack resources you canuse ContinueUpdateRollback along with the ResourcesToSkip option. CloudFormation will mark the problematic/failing resources as UPDATE_COMPLETE and continue with the rest of the rollback.</p> 
<h3><a name="saving-the-day"></a>Saving the day</h3> 
<p>Now to address Jimmy’s mistake. With experience we know that CloudFormation relies on resource names or IDs to keep track of ownership. With launch configurations, we can see that the service uses a combination of the StackName, LogicalId, and a random string to name the launch configuration.</p> 
<p>What we can do is create a new launch configuration using the precise name of the previous one. We can grab that name by describing our stack as before then follow that up with a ContinueUpdateRollback:</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId`
aws autoscaling create-launch-configuration --launch-configuration-name $LCName --image-id ami-1a7f6d7e --instance-type t2.micro --region eu-west-2
aws cloudformation continue-update-rollback --stack-name &lt;stack-name&gt; --region eu-west-2
</code> 
<p class="FirstParagraph">Our stack should now be back to UPDATE_ROLLBACK_COMPLETE and ready for us to perform our update again.</p> 
<code class="lang-basg">aws cloudformation describe-stacks --stack-name &lt;stack-name&gt; --query Stacks[0].StackStatus –region eu-west-2
&quot;UPDATE_ROLLBACK_COMPLETE&quot;</code> 
<p class="FirstParagraph">In our example we forced the rollback by adding a never-completing WaitCondition. In your case the cause might be due to account limitations or other issues.</p> 
<b>When replacement is not an option</b> 
<p>In our example, we were left in the lucky situation in which you can replace the removed resource easily by naming a new resource the same name that your stack expects. Let’s take a look at a situation in which a resource was deleted that does not have a custom-name.</p> 
<p>Consider the following CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Please use your *default* VPC security group so that the steps that follow are successful&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
SecurityGroupIds:
- !Ref InstanceSecurityGroup
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>In this template we are creating an instance and a security group. Let’s pretend our old friend Jimmy was this time instructed to alter the EC2 instance and reference the default VPC security group:</p> 
<code class="lang-bash">defaultSecGroup=`aws ec2 describe-security-groups --group-name default --query SecurityGroups[0].GroupId --output text --region eu-west-2`
stackSecGroup=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id InstanceSecurityGroup --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
instance=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id Instance --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws ec2 modify-instance-attribute --instance-id $instance --group $defaultSecGroup --region eu-west-2
aws ec2 delete-security-group --group-id $stackSecGroup --region eu-west-2
</code> 
<p>And then, once again we update our stack with the failing wait condition to simulate a failure and initiate a rollback:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: Instance
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p>The stack is now in the UPDATE_ROLLBACK_FAILED state due to the ‘Instance’ resource being unable to rollback with an error like:</p> 
<p><em><strong>The security group ‘sg-xxxxxxxx’ does not exist</strong></em></p> 
<p>This time, to recover, because we can’t re-create sg-xxxxxxxx with the exact ID, we will have to continue the rollback and skip past the instance so that we can continue to modify the stack and regain a working and synced state.</p> 
<p>The first step is to perform continue-update-rollback skipping the resource:</p> 
<code class="lang-bash">aws cloudformation continue-update-rollback --resources-to-skip Instance --region eu-west-2</code> 
<p>The stack would now be in the UPDATE_ROLLBACK_COMPLETE state. However, the state of the stack no longer matches the state of the underlying resources. The instance, while still running, will have the default EC2 security group assigned to it by Jimmy instead of the security group we have defined here in the stack. To rectify this, we have to modify our template so that the instance is updated with a different security group ID. We can also remove the reference to the old, now deleted group from our template and use this as the new group for the instance:</p> 
<code class="lang-bash">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
SecurityGroupIds:
- InstanceSecurityGroup2
InstanceSecurityGroup2:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>Our stack should now be back in a state that is synchronized with the underlying resources and in a state that allows for further modifications down the line.</p> 
<b>Conclusion</b> 
<p>Throughout this blog, we learned about various CloudFormation concepts such as rollbacks, stabilization and using the ContinueUpdateRollback operation. We showed you two examples of using ContinueUpdateRollback to rescue a stack from a stuck state. In the first example we simply alter an underlying value then perform the API call. In the second example we have to skip past the problematic resource (due to the fact that it uses a unique ID instead of a user-defined value).</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/cnishant.jpeg" /></p> 
<p style="text-align: left"><a href="https://www.linkedin.com/in/nishantcasey">Nishant Casey</a> is a Cloud Support Engineer on the AWS Deployment team where he focuses on AWS CloudFormation and AWS Elastic Beanstalk. Nishant is passionate about Infrastructure as Code and DevOps. A gigging DJ and guitarist in a previous life, he enjoys music, as well as cooking, traveling, and video and board gaming.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Track Changes to Auto Scaling Groups Using AWS Config</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Varun Pole</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:04:27+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-changes-to-auto-scaling-groups-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for Auto Scaling groups. You can now track configuration changes in Auto Scaling groups, such as minimum, maximum, and desired capacities, termination policies, scaling policies, subnets, and instance protection settings.</p> 
<p>You can also use a new managed AWS Config rule to check whether the Auto Scaling groups associated with your load balancers are using the Elastic Load Balancing health checks to determine the health state of your Amazon EC2 instances.</p> 
<p>In this post, I describe two possible ways that you could track changes to Auto Scaling groups and evaluate compliance. I’ll walk you through each scenario.</p> 
<p><span id="more-2483"></span></p> 
<p><strong>AWS services</strong><br /> AWS Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p>An Auto Scaling group is a collection of EC2 instances, with similar configuration and characteristics, that are used for the purpose of scaling and management. These EC2 instances in the Auto Scaling group are treated as a logical group. You can configure the Auto Scaling group with the capacity that you want for instances required for the application to operate. You can configure the group with the minimum and maximum instances, depending on which instances Auto Scaling can launch or terminate based on dynamic scaling.</p> 
<p><strong>Example: Track configuration changes</strong></p> 
<p>Let’s consider a scenario where a customer notices an increase in his Amazon Elastic Compute Cloud (Amazon EC2) bill for a prior month. He notices that there are Amazon EC2 charges related to the use of an m4.xlarge instance type. The customer is confused because his applications have always used t2.micro instances, so he investigates further. He notices that when a scale out happens, the instances launched by the Auto Scaling group are of type m4.xlarge, instead of t2.micro. So it appears that the Auto Scaling launch configuration must have been modified.</p> 
<p>AWS Config can help you investigate in this scenario and determine if and when any configuration changes occurred on the Auto Scaling launch configuration, since it maintains a history of all configuration changes to the Auto Scaling group. We use the AWS Management Console in this scenario, but you can use the AWS CLI or SDKs as well.</p> 
<p>First, log in to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: AutoScaling Group</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling groups that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling group on the <strong>Resource inventory</strong> page.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1024x416.png" /></p> 
<p>Look at the <strong>Config timeline</strong> for the <strong>AS- APP1 – AS group</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1-1024x303.png" /></p> 
<p>The timeline shows you all configuration changes that were made after the Auto Scaling group was created.</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on the 31st August to the Auto Scaling group configuration, when the launch configuration was changed from AS-APP1-Launch config to AS-APPv2-Launch config.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-2.png" /></p> 
<p>Let’s open the EC2 console to check the Auto Scaling launch configurations. We can confirm that the instance type associated with the new launch configuration is m4.xlarge.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/AS-group-m4xlarge-1024x265.png" /></p> 
<p>&nbsp;</p> 
<p>Here is another example of tracking configuration changes using AWS Config. In this example, let’s assume that you are seeing performance degradations for applications hosted on your EC2 instances. Open the Amazon CloudWatch console. You can see spikes but are unable to understand why Auto Scaling did not dynamically scale out based on the CPU threshold scaling policy which was set to scale at 60 percent of average CPU.</p> 
<p>Go back to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: ScalingPolicy</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling Policies that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling policy on the <strong>Resource inventory</strong> page</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1.png" /></p> 
<p>Look at the Config timeline for Scale Group Size scaling policy. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/scaling-policy-changes-scale-1024x281.png" /></p> 
<p>&nbsp;</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on 4th September to the Scaling policy configuration, when the target value for Average CPU threshold was changed from 60 to 90 percent. This explains why the scale out did not happen as soon as the CPU spiked over 60 percent.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/Screen-Shot-2017-09-05-at-10.38.06-AM.jpg" /></p> 
<p>Using this information, you can fix these Auto Scaling configuration issues in the EC2 console.</p> 
<p>Another common scenario some customers have experienced is noticing too many instances in their account. This is because the instance termination policy has been enabled, which does not terminate your instances when the scale-in happens. This can be identified using the AWS Config service as well.</p> 
<p><strong>Example: Verify Heath Check using AWS Config rules</strong></p> 
<p>In addition to tracking the configuration of your Auto Scaling service, you can use AWS Config rules to check your Auto Scaling groups against best practices and internal policies.</p> 
<p>For example, use the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> to check whether your Auto Scaling groups that are associated with a load balancer are using Elastic Load Balancing health checks.</p> 
<p>Auto Scaling groups use Amazon EC2 health checks by default to determine the health of an instance. In situations where EC2 instances are running behind a load balancer, it’s beneficial to leverage the load balancer health checks for EC2 instances instead of Amazon EC2 health checks. This is because the load balancer health checks can determine the health of the application running on top of the EC2 instances, unlike the Amazon EC2 health checks.</p> 
<p>Here’s an example that shows how you can use AWS Config to troubleshoot a scenario where customers notice service errors or failures for the applications hosted on Amazon EC2 behind a load balancer even though the EC2 instance is healthy, reachable, and running.</p> 
<p>On the EC2 console, you can see that the EC2 instances healthy and running. But customers are still reporting errors while running your application. After some troubleshooting you determine that there are issues with the web service running on top of your EC2 instances. Elastic Load Balancing (ELB) load balancers have the capability to detect such failures via application-specific health checks and stop directing traffic to the affected EC2 instances. But since the Auto Scaling group isn’t configured to leverage the ELB health checks, customer requests are still hitting the unhealthy EC2 instances.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-instance-status.png" /></p> 
<p>AWS Config can help you identify Auto Scaling groups with this misconfiguration so that you can take corrective action. With the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> we can identify Auto Scaling groups that do not use ELB health checks. These resources are “non-compliant” as far as the AWS Config rule is concerned, as seen in the AWS Config console:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-nc.png" /></p> 
<p>Go to the EC2 console to change the health check type to ELB in the Auto Scaling group. When you return to the AWS Config console, you can see that the compliance status for the Auto Scaling group changes to the compliant state.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/ELB-hc-complaint-1024x291.png" /></p> 
<p>&nbsp;</p> 
<p><strong>Summary</strong><br /> With support for Auto Scaling in AWS Config, you can track configuration changes to your Auto Scaling groups and associated resource types. You can use the pre-built AWS Config rule or you can create custom rules to scan the configuration of these resources and verify compliance with best practices, internal guidelines, and regulatory requirements.</p> 
<hr /> 
<p><strong>About the Authors</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/3-150x150.jpg" />Varun Pole is a Solutions Architect at Amazon Web Services. He enjoys working with customers providing technical guidance and assist in architect and build solutions and help them make the best use of AWS services. In his free time, he enjoys traveling, cooking and photography.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture2-150x150.png" />Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and help them implement cloud security best practices. In his spare time, he enjoys hiking, reading and spending time with his kids.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to Track Configuration Changes to Classic Load Balancers Using AWS Config</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Parth Shah</span></span> | on 
<time property="datePublished" datetime="2018-02-12T23:24:29+00:00">12 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/networking-content-delivery/elastic-load-balancing/" title="View all posts in Elastic Load Balancing*"><span property="articleSection">Elastic Load Balancing*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/networking-content-delivery/" title="View all posts in Networking &amp; Content Delivery*"><span property="articleSection">Networking &amp; Content Delivery*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-configuration-changes-to-classic-load-balancers-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, AWS Config announced support for <a href="https://aws.amazon.com/elasticloadbalancing/">Classic Load Balancer</a> in all public regions and AWS GovCloud (US). You can now start tracking the current and historical configurations of your Classic Load Balancers, and get notified via&nbsp;<a href="https://aws.amazon.com/sns/">Amazon SNS</a> when your configurations change. You can also use three new managed AWS Config rules to verify whether your Classic Load Balancers are using SSL certificates provided by <a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a>, and whether the SSL listeners are using specific policies.</p> 
<p>Tracking configuration changes to your Classic Load Balancers is valuable from an operations perspective. You can use AWS Config to troubleshoot common operational issues with your Classic Load Balancers such as health check failures, connectivity issues, sticky session failures, SSL certificate issues, etc.</p> 
<p>In this post, I walk you through two possible use cases:</p> 
<ol> 
<li>Monitoring your Classic Load Balancer for configuration changes (two parts)</li> 
<li>Verifying whether the SSL certificate installed on your Classic Load Balancer is provided by AWS Certificate Manager (ACM).</li> 
</ol> 
<p><span id="more-1471"></span></p> 
<b>AWS services</b> 
<p><a href="https://aws.amazon.com/config/">AWS Config</a> enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against the configurations you want. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p><a href="https://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancing</a> offers two types of load balancers that both feature high availability, automatic scaling, and robust security. These include the Classic Load Balancer that routes traffic based on either application or network level information, and the Application Load Balancer that routes traffic based on advanced application-level information that includes the content of the request. The Classic Load Balancer is ideal for simple load balancing of traffic across multiple EC2 instances.</p> 
<p><a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a> is a service that lets you easily provision, manage, and deploy Secure Sockets Layer/Transport Layer Security (SSL/TLS) certificates for use with AWS services such as Elastic Load Balancing.</p> 
<b>Use case: Monitoring a Classic Load Balancer for configuration changes (Part 1)</b> 
<p>Your customers are reporting connectivity issues to your Classic Load Balancer. Here’s how you can use AWS Config to quickly identify the issues and minimize production downtime.</p> 
<p>For this example, a Classic Load Balancer is created with the following health check parameters and listener configurations:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture1-3.png" /></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture2-1.png" /></p> 
<p>In this configuration, your application is running on HTTP port 80. Now, imagine that someone accidentally updates the load balancer and sets the health check and listener ports to 8080. Because the application is not listening on port 8080, the health check fails and the EC2 instances behind the load balancer become unhealthy. Also, there would be connectivity issues because the load balancer is no longer listening on port 80. Until both of these changes are reverted, there would be an impact on production traffic.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture3.png" /></p> 
<p>AWS Config helps you troubleshoot these types of issues.</p> 
<ol> 
<li>Log in to the AWS Config console.</li> 
<li>For <strong>Resources</strong>, choose <strong>ElasticLoadBalancing:LoadBalancer</strong>.</li> 
<li>Choose <strong>Look up</strong> to see the list of Classic Load Balancers that AWS Config has automatically discovered in your account.</li> 
</ol> 
<p>The following screenshot shows an example Classic Load Balancer on the Resource inventory page:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture4.png" /></p> 
<p>Look at the Config timeline for the <strong>ProductionLB</strong>. The following screenshot shows the timeline and configuration details:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture5.png" /></p> 
<p>&nbsp;</p> 
<p>At the top, you see a timeline of all changes that have occurred to the load balancer after creation.</p> 
<p>You can see the configuration of the load balancer under <strong>Configuration Details</strong>. This includes the <strong>Amazon Resource Name (ARN), Resource ID, DNS name, </strong>and<strong> Listeners</strong>.</p> 
<p>In this scenario, there were <strong>3 changes</strong> on <strong>September 8th </strong>at<strong> 07:01:36 PM</strong>. You can drill down further to see what those changes were. The load balancer health check and listener ports were changed to 8080.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/10/Screen-Shot-2017-09-08-at-7.07.23-PM.png" />AWS Config also sends an SNS notification each time that a configuration change is detected, so that you can be alerted of changes to your Classic Load Balancers.</p> 
<b>Use case: Monitoring a Classic Load Balancer for configuration changes (Part 2)</b> 
<p>Your customers intermittently observe blank pages on your website. The session information is stored in the application running on the EC2 instances behind the load balancer. For this reason, you have enabled session stickiness on your load balancer, as seen in the following screenshot:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture7.png" /></p> 
<p>If someone accidentally disables the cross-zone load balancing, the load balancer would not forward requests to EC2 instances across Availability Zones. This breaks the session stickiness for your application and your customers observe intermittent blank pages on your website.</p> 
<p>You can track the configuration changes to your load balancer using AWS Config, as explained in the previous example. In this case, AWS Config shows that cross-zone load balancing was disabled. You can enable it again to fix the issue.</p> 
<b>Use case: Verifying the SSL certificate installed on a Classic Load Balancer</b> 
<p>In addition to tracking the configuration changes on your Classic Load Balancers, you can use AWS Config rules to check your Classic Load Balancers against best practices and internal policies.</p> 
<p>For example, you can use the prebuilt rule <strong>elb-acm-certificate-required</strong> to verify whether your Classic Load Balancers are using SSL certificates provided by ACM.</p> 
<p><strong>Note</strong>: ACM makes it easier to enable SSL/TLS for a website or application on AWS. ACM eliminates many of the manual processes previously associated with using SSL/TLS and managing SSL/TLS certificates. ACM can also help you avoid downtime due to misconfigured, revoked, or expired certificates by managing renewals. You get SSL/TLS protection and easy certificate management.</p> 
<p>The following illustration shows compliant and noncompliant states for this rule. The Classic Load Balancer that you created earlier is showing as noncompliant with this rule because it doesn’t have an SSL certificate installed using ACM.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture8.png" /></p> 
<p>After installing an SSL certificate provided by ACM, you can see that the compliance status changes to the compliant state.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture9.png" /></p> 
<b>Additional AWS Config rules</b> 
<p>In addition to the managed Config rule described above, you can use the <strong>elb-predefined-security-policy-ssl-check</strong> and <strong>elb-custom-security-policy-ssl-check</strong> rules to verify that the SSL listeners on the Classic Load Balancer are using specific custom or predefined policies.</p> 
<b>Summary</b> 
<p>With support for Classic Load Balancers in AWS Config, you can now continuously track configuration changes such as health check parameters, listener configuration changes, sticky session configuration changes, and cross-zone load balancing. You can then use managed Config rules to evaluate these configuration changes against your desired configuration and verify your compliance with best practices.</p> 
<p>&nbsp;</p> 
<p>About the Authors</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture1-2-150x150.png" /></p> 
<p>Parth Shah is a Solutions Architect at Amazon Web Services. He enjoys working with customers in cloud adoption and business strategy as well as helping them design applications and services on AWS. Outside of work, he enjoys playing cricket, traveling, and spending time with his friends and family.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture2-150x150.png" />Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and helping them implement cloud security best practices. In his spare time, he enjoys hiking, reading, and spending time with his kids.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/29/Social_AWS-Config_es-02.png" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Config: A Year in Review 2017</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Stas Neyman</span></span> | on 
<time property="datePublished" datetime="2018-02-12T08:00:00+00:00">12 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-config-a-year-in-review-2017/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>It’s been another exciting year for <a href="https://aws.amazon.com/config/">AWS Config</a>, a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. We have expanded our regional availability, added support for new resource types, introduced new managed Config rules, and introduced a dashboard view of your resource configuration and compliance. In this post, I recap some of this year’s announcements and provide links to additional resources.</p> 
<p><strong>Regional expansion:</strong> With the addition of the South America (S&atilde;o Paulo), Canada (Central), Asia Pacific (Mumbai), and Europe (London) Regions, AWS Config now supports Config rules in all 17 public AWS Regions and in AWS GovCloud (US). For the complete list of regions where Config and Config rules are available, see the AWS Config section under <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#awsconfig_region">AWS Regions and Endpoints</a>.</p> 
<p><strong>New resource types:</strong> We have added support for eight new services in 2017. You can now record configuration changes from the following:</p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-tracks-changes-to-aws-cloudformation-stacks/">AWS CloudFormation</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-classic-load-balancers/">Classic Load Balancers</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">AWS WAF</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">Amazon CloudFront</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/10/aws-config-adds-support-for-aws-codebuild/">AWS CodeBuild</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-auto-scaling-groups/">Auto Scaling groups</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-amazon-dynamodb-tables/">Amazon DynamoDB</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">Amazon CloudWatch</a></li> 
<p><strong>New managed rules:</strong> AWS Config allows you to enable rules to evaluate whether your AWS resources comply with common best practices. In 2017, we added support for nine new rules, bringing the <a href="https://docs.aws.amazon.com/config/latest/developerguide/managed-rules-by-aws-config.html">total to 47</a>. Two of the rules that we announced during the AWS NY Summit allow you to <a href="https://aws.amazon.com/blogs/mt/example-scenarios-for-aws-config-continuous-monitoring-of-amazon-s3-bucket-access-controls/">secure your Amazon S3 buckets</a>. The rules check your S3 buckets for unrestricted public write access or unrestricted public read access. They are backed by a new semantic-based automated reasoning engine, which returns a compliance decision.</p> 
<p><strong>Notable features:</strong> In 2017, we released <a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">ready-to-use AWS CloudFormation templates</a> for all managed rules and <a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">added support for a test mode</a> to check the functionality of custom Config rules. Using the test mode, you can safely check whether your custom Config rules are correctly reporting evaluation results for your resources without sending evaluation results to Config and incurring charges.</p> 
<p>We also <a href="https://aws.amazon.com/about-aws/whats-new/2017/07/introducing-aws-config-dashboard/">introduced an AWS Config dashboard</a> that allows you to view the total number of resources being recorded in your account and the count of resources by type to easily access the configuration history of a resource. With a Config dashboard, you can also quickly spot the number of resources that are non-compliant with your Config rules in each region, view the Config rules with the most non-compliant resources, and drill down to view the resources that are non-compliant with a particular Config rule.</p> 
<p>For the complete list of 2017 AWS Config announcements, see <a href="https://aws.amazon.com/config/release-notes/">What’s New from AWS Config</a>. To view Config documentation, click <a href="https://docs.aws.amazon.com/config/latest/developerguide/WhatIsConfig.html">here</a>.</p> 
<p>Individual announcements for the releases noted in this post are listed below.</p> 
<p><strong>Regional expansion:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-supports-rules-in-south-america-and-canada-regions/">AWS Config Supports Rules in South America (Sao Paulo) and Canada (Central) regions</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-rules-available-in-aws-govcloud-us/">AWS Config Rules Available in AWS GovCloud (US)</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/04/aws-config-supports-rules-in-asia-pacific-mumbai-region/">AWS Config Supports Rules in Asia Pacific (Mumbai) Region</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-available-in-europe-london-region/">AWS Config Rules Available in Europe (London) Region</a></li> 
<p><strong>New resource types:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-classic-load-balancers/">AWS Config Adds Support for Classic Load Balancers</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">AWS Config Adds Support for AWS WAF and Amazon CloudFront</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/10/aws-config-adds-support-for-aws-codebuild/">AWS Config Adds Support for AWS CodeBuild</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-auto-scaling-groups/">AWS Config Adds Support for Auto Scaling Groups</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-amazon-dynamodb-tables/">AWS Config Adds Support for Amazon DynamoDB Tables</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-tracks-changes-to-aws-cloudformation-stacks/">AWS Config Tracks Changes to AWS CloudFormation Stacks</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">AWS Config Supports Amazon CloudWatch Alarms and Additional Rules</a></li> 
<p><strong>New managed rules:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/08/aws-config-supports-new-managed-rules-for-securing-amazon-s3-buckets/">AWS Config Supports New Managed Rules for Securing Amazon S3 Buckets</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">AWS Config Supports Amazon CloudWatch Alarms and Additional Rules</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-supports-new-managed-rules/">AWS Config Rules Supports New Managed Rules</a></li> 
<p><strong>Notable features:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/introducing-aws-config-dashboard/">Introducing AWS Config Dashboard</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">AWS Config Rules Adds AWS CloudFormation Templates and a Test Mode for Rule Authoring</a></li> 
<p>The AWS Config team is excited about 2018 and is looking forward to continually adding new functionality. To learn more about Config features, see the <a href="https://aws.amazon.com/config/">AWS Config page</a>.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Centralized Management of Multiple Accounts and Cross-Platform EC2 Instances Using AWS Systems Manager</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Sohaib Tahir</span></span> | on 
<time property="datePublished" datetime="2018-02-06T15:24:46+00:00">06 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/centralized-management-of-multiple-accounts-and-cross-platform-ec2-instances-using-aws-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<h3><strong>Introduction</strong></h3> 
<p>Many AWS customers, particularly in the public sector, are implementing a central IT agency model. These organizations have an AWS account for central IT that is designated for the management of security and compliance activities such as patch management, use of golden Amazon Machine Images (AMIs), and federates user access for other agencies’ AWS accounts.</p> 
<p>In this blog post, I present a solution that will allow the AWS account for central IT to use AWS Systems Manager (SSM) to execute commands using Run Command and manage patches in the AWS accounts of other agencies. I’ll walk you through the steps for deploying this solution using AWS CloudFormation templates. We will create a Systems Manager Activation in the central account for registering Amazon EC2 instances as managed instances from the other agencies’ AWS accounts. We’ll also deploy AWS Lambda functions to propagate the EC2 tags into the Central IT account and attach them to the managed instances as Systems Manager tags. This way the tags can be used as targets for executing SSM Documents through Run Commands and for other Systems Manager features such as State Manager, Maintenance Windows, and Patch Management.</p> 
<p><span id="more-2227"></span></p> 
<p>These are the minimum requirements for implementing this solution:<br /> • Central IT account (or a parent account)<br /> • Agency account (or child accounts)<br /> • EC2 instance profile in the agency account<br /> • SSM agents and Boto3 library on EC2 instances</p> 
<p>The following diagram shows the system architecture:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/12/27/Blog_ssm_diag.png" /></p> 
<p>&nbsp;</p> 
<h3><strong>Implementation </strong></h3> 
<p><strong>Step one</strong><br /> First, we’ll create a managed instance activation in the central IT AWS account. This activation will be used to register both Windows and Linux EC2 instances from individual agency accounts. On activation creation, an activation ID along with activation code is returned. You need to store these in a text file, we’ll use them in later steps.</p> 
<p>For this blog post I’m providing a Python script for registering Amazon Linux-based EC2 instances from the agency account. You can easily write your own script for Windows or other operating system (OS) platforms.</p> 
<p><strong>Step two</strong><br /> Next, we’ll deploy SSM Agent on EC2 instances in all of the agency/child accounts that will be centrally managed through the activation created in the first step. Note that by default the EC2 instance registers to its own account’s Systems Manager after the agent is installed and started. The EC2 instance appears in the Systems Manager Shared Resources section in the appropriate AWS Region, in the Managed Instances tab.</p> 
<p><strong>Step three</strong><br /> Now we’ll create two parameters, ActivationID and ActivationCode, in the agency’s Systems Manager Parameter Store for the values we already have copied in a text file in step one. Our Python script that registers the EC2 instance to activation uses the values of these parameters for registration. You can use either the AWS Management Console, the API, or AWS CLI for creating the parameters. For the AWS CLI, use the following commands, which are documented in the&nbsp;CLI Command Reference.</p> 
<code class="lang-bash">aws ssm put-parameter --name &quot;ActivationID&quot; --type &quot;String&quot; --value &quot;xxxxxxxxxx&quot; --region &lt;AWS_region&gt;
aws ssm put-parameter --name &quot;ActivationCode&quot; --type &quot;String&quot; --value &quot;xxxxxxxxx&quot; --region &lt;AWS_region&gt;
</code> 
<p>&nbsp;</p> 
<p><strong>Step four</strong><br /> After the SSM Agent is installed, the EC2 instances need to be registered to the activation that we created in the first step. When the registration to an activation is complete, a managed instance ID is returned in the form mi-xxxxxxxxxxxxxxxx. This ID is attached to the instance since neither EC2 instance ID nor the EC2 tags are propagated to the Central IT account from the agency account through activation. We’ll use Lambda functions later to propagate all of the EC2 tags to the Central IT account from each agency account.</p> 
<p>The Python code that follows registers an Amazon Linux-based EC2 instance to an unexpired activation. The code requires the Boto 3 library to be pre-installed on the instance and an EC2 instance profile that has permissions to access Systems Manager Parameter Store and create EC2 tags.</p> 
<code class="lang-python">#!/usr/bin/python
import os
import urllib2
import json
import commands
import re
import boto3
from boto3 import session
instance_details = json.loads(urllib2.urlopen('http://169.254.169.254/2016-06-30/dynamic/instance-identity/document/').read())
instanceid=instance_details['instanceId']
REGION=instance_details['region']
# Getting the AWS credentials from the IAM role
session = session.Session()
credentials = session.get_credentials()
def Activation(InstanceID):
#Getting Activation ID and Code from parameter store
ssm = boto3.client('ssm',region_name=REGION)
activation_id = ssm.get_parameter(Name='ActivationID')
ActivationID=activation_id['Parameter']['Value']
activation_code = ssm.get_parameter(Name='ActivationCode')
ActivationCode=activation_code['Parameter']['Value']
# Registering Instance to Activation and storing ManagedInstanceID for tagging
status_stop_service, Output_stop_service =commands.getstatusoutput(&quot;sudo stop amazon-ssm-agent&quot;)
cmd=&quot;sudo amazon-ssm-agent -register -y -code %s -id %s -region %s&quot;%(ActivationCode,ActivationID,REGION)
status, output = commands.getstatusoutput(cmd)
m = re.search('(mi-)\w{17}',output.splitlines()[-1])
ManagedInstanceID=m.group(0)
if status==0:
status_start_service, Output_start_service =commands.getstatusoutput(&quot;sudo start amazon-ssm-agent&quot;)
print ManagedInstanceID
# Creating Tag for ManagedInstanceID tag
create_tags = ec2.create_tags(Resources=[str(InstanceID)],Tags=[{'Key':'managedinstanceid','Value':ManagedInstanceID}])
# Checking if Instance already has ManagedInstanceID Tag
ec2=boto3.client('ec2',region_name=REGION)
ec2_attached_tags = ec2.describe_instances(Filters=[{'Name': 'tag-key','Values': ['managedinstanceid']}],InstanceIds=[instanceid])
if not ec2_attached_tags['Reservations']:
Activation(instanceid)
else:
print &quot;Instance is already registered to an Activation/Account&quot;</code> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>IAM policy for the EC2 instance profile:</p> 
<p><code></code></p> 
<code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Action&quot;: [
&quot;ec2:CreateTags&quot;,
&quot;ec2:DescribeInstances&quot;
],
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;ssm:GetParameter&quot;
],
&quot;Resource&quot;: &quot;*&quot;
}
]
}
</code> 
 
<p><code></code></p> 
<p>&nbsp;</p> 
<p>Learn more about activation for different operating systems:</p> 
<li>Registering Windows instances to activation: <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-win">http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-win</a></li> 
<li>Registering Linux instances to activation:<br /> <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-linux">http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-linux</a></li> 
<p>Note that there is a limit of 1,000 instances per activation and activation expires after a maximum of 30 days. After activation expiry, new instances can’t be registered to it, but registered instances can continue to be managed.</p> 
<p><strong>Step five</strong><br /> After they are registered, the EC2 Instances in other accounts will appear in the EC2 console, in the Central IT account, Managed Instances section. They are identified by the same managed ID that was returned during activation process. This returned Managed ID is attached as an EC2 tag in the earlier Python code. A Lambda function, called Automation-EC2-Tags-Collector, copies the EC2 tags in the agency account to the Central IT account by invoking a second Lambda function, called Automation-SSM-Tag-Manager. The following CloudFormation template will deploy this Lambda function in agency accounts:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=Automation-EC2-Tags-Collector&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ec2-tag-collector.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p>The Automation-SSM-Tag-Manager Lambda function is deployed in the Central IT account so that it can accept the EC2 tags passed as an event by each agency’s Lambda function. Since each of the EC2 tags has the managed instance ID tag as well, it can used to map all the relevant EC2 tags propagated from agency accounts to the managed instances in in the central account. A maximum of 10 tags can be attached to a managed instance. Tags are critical to Systems Manager operation because they group resources together for applying and deploying Systems Manager functionalities such as Run Command, State Manager, Patch Manager, and Maintenance Windows.</p> 
<p>Use the following CloudFormation template to deploy Automation-SSM-Tag-Manager Central IT account:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=Automation-SSM-Tag-Manager&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ssm-tag-manager.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p>The Automation-EC2-Tags-Collector Lambda function should have permissions to invoke Automation-SSM-Tag-Manager. We’ll ensure this by deploying the following CloudFormation template. For parameters for adding permissions, you need to provide the agency account ID and the AWS Region into which the Automation-EC2-Tags-Collector is deployed.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new? stackName=AWS-Automation-SSM-Add-Agency&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ssm-add-agency.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p><strong>Step six</strong><br /> After these CloudFormation templates are successfully deployed, you need to validate the instances appearing as managed instances in the central IT account along with the EC2 tags. Execute following AWS CLI command for the central IT account:</p> 
<code class="lang-bash">aws ssm list-tags-for-resource --resource-type “ManagedInstance” --resource-id &quot;&lt;managedinstanceID&gt;&quot; --region &lt;Activation_region&gt;
</code> 
<p>You can now use the propagated tags to execute Systems Manager documents or create Maintenance Windows. As an example you can execute the following Run Command on EC2 tag of “OS=Linux” as under:</p> 
<code class="lang-bash">aws ssm send-command --document-name &quot;AWS-RunShellScript&quot; –parameters commands=[&quot;ifconfig&quot;] --targets Key=tag:OS,Values=Linux --region &lt;your_SSM_region&gt;
</code> 
<h3><strong>Conclusion</strong></h3> 
<p>In this blog post I presented a Central IT solution for cross-account and cross-platform EC2 management using AWS Systems Manager and AWS Lambda. We created an Activation in the central IT account for registering agencies’ EC2 instances, we then deployed Lambda functions to import EC2 tags into the Central IT account for using them in implementing various EC2 SSM features. Using Systems Manager in Central IT provides you a variety of out-of-the-box features such as Patch Management, Maintenance Windows, Automation, and State Manager. These features can be used to enforce compliance and governance. Deploying this solution not only allows you to manage instances centrally but also to keep managing various OS platforms independently using the exported EC2 tags.</p> 
<p>&nbsp;</p> 
<p><strong>About the Author</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/12/27/Phone_Tool_2-199x300.jpg" /></p> 
<p>Sohaib Tahir is a Solutions Architect for State and Local Government Public Sector Team. Sohaib has a focus in Networking and Automation, and loves to help customers in building architectures with automation services like AWS Systems Manager, AWS Lambda and Cloud-formation and Networking services including Amazon VPC and Direct Connect.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/31/Screen-Shot-2018-01-31-at-12.00.15-PM.png" /> 
<b class="lb-b blog-post-title" property="name headline">AWS CloudFormation: 2017 in Review</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Chuck Meyer</span></span> | on 
<time property="datePublished" datetime="2018-02-02T13:35:05+00:00">02 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-cloudformation-2017-in-review/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>In 2017, over 350,000 AWS customers used <a href="https://aws.amazon.com/cloudformation">AWS CloudFormation</a> to manage resources collected across 2.4M stacks. We added coverage for 14 new services and several new features.</p> 
<p>In this post, I’d like to look back at some features and new content that CloudFormation introduced in 2017, including:</p> 
<ul class="incremental"> 
<li>New AWS resources that you can provision with CloudFormation.</li> 
<li>StackSets to centrally manage stacks across accounts and regions.</li> 
<li>Termination protection to protect stacks that contain critical resources.</li> 
<li>Rollback triggers to revert infrastructure changes impacting application performance.</li> 
<li>Integration with <a href="https://aws.amazon.com/systems-manager">AWS Systems Manager</a> Parameter Store.</li> 
<li>Quick-create links to get stacks up and running quickly.</li> 
<li>…and some of our most popular posts and re:Invent sessions.</li> 
<p>I also talk a little about what’s ahead in 2018.<span id="more-2521"></span></p> 
<h3 id="new-aws-resources">New AWS resources</h3> 
<p>I did some digging into the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">AWS CloudFormation Resource Specification</a> and pulled out a few interesting statistics.</p> 
<p>In 2017, we added support for 14 new services and APIs in CloudFormation:</p> 
<table style="height: 203px" width="775"> 
<tbody> 
<tr> 
<td>Amazon Athena</td> 
<td>AWS Glue</td> 
</tr> 
<tr> 
<td>AWS Batch</td> 
<td>Amazon GuardDuty</td> 
</tr> 
<tr> 
<td>AWS Cloud9</td> 
<td>Amazon Inspector</td> 
</tr> 
<tr> 
<td>AWS CodeStar</td> 
<td>Amazon Kinesis Data Analytics</td> 
</tr> 
<tr> 
<td>Amazon Cognito</td> 
<td>Amazon Route 53 Auto Naming API</td> 
</tr> 
<tr> 
<td>AWS Database Migration Service (AWS DMS)</td> 
<td>AWS Step Functions</td> 
</tr> 
<tr> 
<td>Amazon DynamoDB Accelerator (DAX)</td> 
<td>AWS WAF Regional</td> 
</tr> 
</tbody> 
</table> 
<p>As of today, you can use CloudFormation to provision 248 AWS resource types, 71 more than this time last year. For information about supported resources, see the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">AWS Resource Types Reference</a> in the <em>AWS CloudFormation User Guide</em> or grab the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">AWS CloudFormation Resource Specification</a> yourself for the canonical list.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/31/Screen-Shot-2018-01-31-at-12.00.15-PM.png" /></p> 
<p>You can read up on some of these new features and service in a series of coverage posts that my colleague, Luis Colon, has been writing. For instance, here’s one walking you through <a href="https://aws.amazon.com/blogs/mt/aws-cloudformation-features-update-support-for-amazon-athena-coverage-updates-for-s3-rds-kinesis-and-cloudwatch/">creating a named query resource for Amazon Athena</a>.</p> 
<h3 id="stacksets">StackSets</h3> 
<p>With CloudFormation StackSets, you can now define AWS resources in a CloudFormation template and then roll it out across multiple AWS accounts or Regions in an automated and repeatable manner. You can use this to set up a baseline level of AWS functionality that addresses cross-account and cross-region infrastructure management.</p> 
<p>Jeff Barr walked you through <a href="https://aws.amazon.com/blogs/aws/use-cloudformation-stacksets-to-provision-resources-across-multiple-aws-accounts-and-regions/">using StackSets</a> in a post on the AWS Blog.</p> 
<h3 id="termination-protection">Termination protection</h3> 
<p>Enabling termination protection on a stack prevents it from being accidentally deleted. You cannot delete a stack with termination protection enabled. We walked you through turning on this feature in our post on how to <a href="https://aws.amazon.com/blogs/mt/use-aws-cloudformation-stack-termination-protection-and-rollback-triggers-to-maintain-infrastructure-availability/">Use AWS CloudFormation Stack Termination Protection and Rollback Triggers to Maintain Infrastructure Availability</a>. We also discussed incorporating this feature into a strategy for <a href="https://aws.amazon.com/blogs/mt/aws-cloudformation-guardrails-protecting-your-stacks-and-ensuring-safer-updates/">AWS CloudFormation Guardrails: Protecting your Stacks and Ensuring Safer Updates</a>.</p> 
<h3 id="rollback-triggers">Rollback triggers</h3> 
<p>Rollback triggers enable you to have CloudFormation monitor the state of your application during stack creation and updates. CloudFormation rolls back that operation if the application breaches the threshold of any of the alarms that you’ve specified.</p> 
<p>There’s a walkthrough of setting up a rollback trigger in the second half of my post, <a href="https://aws.amazon.com/blogs/mt/use-aws-cloudformation-stack-termination-protection-and-rollback-triggers-to-maintain-infrastructure-availability/">Use AWS CloudFormation Stack Termination Protection and Rollback Triggers to Maintain Infrastructure Availability</a>.</p> 
<h3 id="systems-manager-parameter-store-integration">Systems Manager Parameter Store integration</h3> 
<p>You can now reference Systems Manager parameters in the Parameters section of your CloudFormation templates to simplify stack updates and achieve consistency by using values from Parameter Store.</p> 
<p>We published a post to walk you through the process of <a href="https://aws.amazon.com/blogs/mt/integrating-aws-cloudformation-with-aws-systems-manager-parameter-store/">Integrating AWS CloudFormation with AWS Systems Manager Parameter Store</a>.</p> 
<h3 id="quick-create-links-to-get-stacks-up-and-running-quickly.">Quick-create links to get stacks up and running quickly.</h3> 
<p>Finally, you can now build quick-create links pre-populated with the template URL, stack name, and template parameters. To try it out yourself, check out <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-create-stacks-quick-create-links.html">Creating Quick-Create Links for Stacks</a>.</p> 
<h3 id="blog-posts-and-reinvent-sessions">Blog posts and re:Invent sessions</h3> 
<p>The most-read CloudFormation post from the <a href="https://aws.amazon.com/blogs/mt/">AWS Management Tools blog</a> in 2017 was <a href="https://aws.amazon.com/blogs/mt/configuring-serverless-applications-using-aws-cloudformation-custom-resources/">Configuring Serverless applications using CloudFormation Custom Resources</a>. Posts on <a href="https://aws.amazon.com/blogs/mt/use-aws-cloudformation-stack-termination-protection-and-rollback-triggers-to-maintain-infrastructure-availability/">Stack Termination</a> and <a href="https://aws.amazon.com/blogs/mt/integrating-aws-cloudformation-with-aws-systems-manager-parameter-store/">Parameter Store integration</a> were also popular.</p> 
<p>At re:Invent, there were 67 sessions at least partially dealing with CloudFormation. The <a href="https://youtu.be/01hy48R9Kr8">CloudFormation Deep Dive (DEV317)</a> session was popular enough to get a repeat session. Other sessions included:</p> 
<ul class="incremental"> 
<li><a href="https://www.youtube.com/watch?v=vKd7WeCLJaM">Learn How Intuit Built a Frictionless Infrastructure Management (DEV318)</a></li> 
<li><a href="https://www.youtube.com/watch?v=IBvsizhKtFk">AWS re:Invent 2017: How Amazon.com Uses AWS Management Tools (DEV340)</a></li> 
<h3 id="whats-next">What’s next</h3> 
<p>The AWS CloudFormation team looks forward to making more improvements to your CloudFormation experience in 2018, starting with the new Drift Detection feature that we announced at re:Invent and which is currently in beta.</p> 
<p>And remember, you can always go to the documentation <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/ReleaseHistory.html">CloudFormation release history page</a> to see the latest updates.</p> 
<hr /> 
<h3><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/23/BadgePhoto-blog.jpg" />About the Author</h3> 
<p>Chuck Meyer&nbsp;is a Senior Developer Advocate for AWS CloudFormation based in Ohio.&nbsp; He&nbsp;spends his time&nbsp;working with&nbsp;both&nbsp;external and internal development teams to constantly improve the developer experience for CloudFormation users.&nbsp; He’s a live music true believer and spends as much time as possible playing bass and watching bands.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to secure infrequently used EC2 instances with AWS Systems Manager</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Spencer Glazier</span></span> | on 
<time property="datePublished" datetime="2018-01-31T17:47:06+00:00">31 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/compute/aws-lambda/" title="View all posts in AWS Lambda*"><span property="articleSection">AWS Lambda*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/application-services/aws-step-functions/" title="View all posts in AWS Step Functions*"><span property="articleSection">AWS Step Functions*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-secure-infrequently-used-ec2-instances-with-aws-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Many organizations have predictable spikes in the usage of their applications and services. For example, retailers see large spikes in usage during Black Friday or Cyber Monday. The beauty of Amazon Elastic Compute Cloud (Amazon EC2) is that it allows customers to quickly scale up their compute power to meet these demands. However, some customers might require more time-consuming setup for their software running on EC2 instances. Instead of creating and terminating instances to meet demand, these customers turn off instances and then turn them on again when they are needed. Eventually the patches on those instances become out of date, and they require updates.</p> 
<p>In this blog, I cover how to leverage AWS Step Functions and AWS Systems Manager Maintenance Windows to start an EC2 instance, apply any outstanding patches using Patch Manager, then stop the EC2 instance. I also cover the necessary steps to manage these resources using AWS CloudFormation. A Maintenance Window lets you define a schedule for when to perform potentially disruptive actions on your instances, such as patching an operating system (OS), updating drivers, or installing software. Each Maintenance Window has a schedule, a duration, a set of registered targets, and a set of registered tasks. AWS Step Functions are part of the AWS Serverless Platform. They make it simple to orchestrate AWS Lambda functions for serverless applications. Finally, CloudFormation gives developers and systems administrators an easy way to create and manage a collection of related AWS resources, provisioning and updating them in an orderly and predictable fashion.</p> 
<p><span id="more-2436"></span></p> 
<p><strong>Availability</strong></p> 
<p>Although AWS Systems Manager is currently available in all AWS Regions, CloudFormation support for Systems Manager is only available in some Regions. For a list of available Regions, please check the CloudFormationResourceSpecification.json for a given Region, which can be seen <a title="undefined" href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html" target="_blank" rel="noopener noreferrer">here</a>. Similarly, Step Functions are only available in some Regions as well. The list of available Regions can be seen <a title="undefined" href="https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/" target="_blank" rel="noopener noreferrer">here</a>.</p> 
<p><strong>Setup</strong></p> 
<p>CloudFormation works on your behalf to manage AWS resources. The CloudFormation template for this post, which outlines the resources that will be provisioned into an AWS CloudFormation stack, can be run as-is, there is no additional setup required to get started. The template creates the following resources:</p> 
<li>An EC2 instance 
<li>The instance we are going to patch</li> 
</ul> </li> 
<li>A Systems Manager Maintenance Window 
<li>A Maintenance Window representing a timeframe in which to run our patching operation</li> 
</ul> </li> 
<li>A Systems Manager Maintenance Window target 
<li>A target on which the task will act, in this case it will be our EC2 instance</li> 
</ul> </li> 
<li>A Systems Manager Maintenance Window task 
<li>The task that we want to execute, in this case an AWS Step Function</li> 
</ul> </li> 
<li>A series of AWS Lambda functions 
<li>One Lambda function for each of the following actions: start, stop, patch, and poll our instance as well as poll the patching activity</li> 
</ul> </li> 
<li>An AWS Step Function 
<li>Manages the workflow of the Lambda Functions</li> 
</ul> </li> 
<li>IAM roles 
<li>Give proper access to all of the above mentioned resources</li> 
</ul> </li> 
<p>Here is a link (<a title="undefined" href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/InstancePatchingWithSSMTemplate.json" target="_blank" rel="noopener noreferrer">JSON</a>)/(<a title="undefined" href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/InstancePatchingWithSSMTemplate.yaml" target="_blank" rel="noopener noreferrer">YAML</a>) to the sample template. I will walk through each piece of the template step-by-step. I’ll discuss some of the common issues to look out for when trying to run this template on your own account.</p> 
<h3><strong>CloudFormation template walkthrough</strong></h3> 
<p><strong>IAM roles</strong></p> 
<p>A Maintenance Window executes a set of tasks on a schedule without requiring user interaction through the AWS Management Console or the AWS SDK/CLI. For this blog post, the task will be a Step Function. The Maintenance Window will require an IAM role that grants it the appropriate permissions to execute the Step Function. Also, the Lambda functions and Step Function require their own roles based on the resources they are accessing. These are the IAM roles created for this blog post:</p> 
<li>InstanceStateActionRoleForLambda 
<li>The InstanceStateActionRoleForLambda provides the necessary access to allow the Starter, Stopper, and InstancePoller Lambda functions to call an EC2 instance.</li> 
</ul> </li> 
<li>InstancePatchingRoleForLambda 
<li>The InstancePatchingRoleForLambda provides the necessary access to allow the Patcher and PatchPoller Lambda functions to call Systems Manager.</li> 
</ul> </li> 
<li>StepFunctionRole 
<li>The StepFunctionRole allows your Step Function to call each of the Lambda functions.</li> 
</ul> </li> 
<p><strong>Lambda functions</strong></p> 
<p>Here is a list and short description of the Lambda functions created for this blog post:</p> 
<li>InstancePatcherLambda 
<li>Uses AWS Systems Manager&nbsp;Patch Manager&nbsp;to&nbsp;scan and install any patches based on the Patch Baseline that applies to the instance (the Patch Baseline associated with the instance’s Patch Group, if defined, otherwise the default Patch Baseline for the instance’s operating system).</li> 
</ul> </li> 
<li>InstancePatchPollerLambda 
<li>Polls Systems Manager to verify the status of the patching command.</li> 
</ul> </li> 
<li>InstanceStarterFunction 
<li>Starts the EC2 instance.</li> 
</ul> </li> 
<li>InstanceStopperLambda 
<li>Stops the EC2 instance.</li> 
</ul> </li> 
<li>InstancePollerLambda 
<li>Polls Amazon EC2 to verify whether the instance is running or stopped.</li> 
</ul> </li> 
<p><strong>Step Function</strong></p> 
<p>The Step Function organizes each of the Lambda functions into a workflow. The steps are laid out in a specific order, which reliably coordinates each component and steps through the workflow of the application. Also, in the Step Functions console, you can watch the Step Function operate and see each step as it moves through the workflow.</p> 
<p><strong>Maintenance Window</strong></p> 
<p>To set up a Maintenance Window using CloudFormation, you need three resources, and they must be created in the following order: a Maintenance Window, a Maintenance Window target, and a Maintenance Window task. The DependsOn attribute of CloudFormation allows us to order the creation of our resources. In the provided template, you can see that each of the Maintenance Window resources uses DependsOn to ensure this ordering. See the following excerpt:</p> 
<p><code class="language-yaml">MaintenanceWindow:<br /> Type: 'AWS::SSM::MaintenanceWindow'<br /> Properties:<br /> Name: 'LambdaMW'<br /> AllowUnassociatedTargets: 'true'<br /> Schedule: 'rate(30 minutes)'<br /> Duration: '2'<br /> Cutoff: '1'<br /> DependsOn: TestInstance<br /> </code></p> 
<p><strong>AMIInfo/AMIInfoFunction</strong></p> 
<p>These two resources are used only for convenience, they perform a lookup that generates the AMI-ID for the EC2 instance that we create in the stack. For more information <a title="undefined" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" target="_blank" rel="noopener noreferrer">see the documentation</a>.</p> 
<h3><strong>Activity walkthrough</strong></h3> 
<p>&nbsp;</p> 
<p><strong>Create the CloudFormation stack</strong></p> 
<p>Follow these steps to create the CloudFormation stack for this walkthrough.</p> 
<ol> 
<li>Open the <strong>AWS CloudFormation</strong> console at <a title="undefined" href="https://console.aws.amazon.com/cloudformation" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/cloudformation</a>.</li> 
<li>Choose <strong>Create Stack</strong>.</li> 
<li>On the <strong>Select Template</strong> page, choose <strong>Specify an Amazon S3 template URL</strong> and give the following S3 URL: https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/InstancePatchingWithSSMTemplate.yaml.</li> 
<li>For <strong>Stack Name</strong>, give an appropriate name, choose <strong>Next</strong>.</li> 
<li>On the <strong>Options</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Review</strong> page, select <strong>I acknowledge that AWS CloudFormation might create IAM resources with custom names</strong> and choose <strong>Create</strong>.</li> 
</ol> 
<p>You can view the progress of CloudFormation progress by selecting your stack and choosing the <strong>Events</strong> tab. Once CloudFormation has built each resource, it will show <em>CREATE_COMPLETE</em> as the Status for the stack.</p> 
<p>Follow these steps to view the Maintenance Window created in this walkthrough.</p> 
<ol> 
<li>Open the <strong>AWS Systems Manager</strong> console at <a title="undefined" href="https://console.aws.amazon.com/systems-manager" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/systems-manager</a>.</li> 
<li>Navigate to <strong>Explore Maintenance Windows</strong>.</li> 
<li>Choose the Maintenance Window named <em>SSMStepFunctionDemo</em>.</li> 
<li>Choose the <strong>View Details</strong> button.</li> 
<li>Choose the <strong>History</strong> tab.</li> 
</ol> 
<p>It is possible that on the first Maintenance Window execution you might see a status message stating that there were no tasks to execute. This happens because the Maintenance Window is set to run every 30 minutes. When it gets created, it attempts to run immediately, but since there is no task associated with it, the execution returns Success with the above status. The schedule of a Maintenance Window can be in the form of a <a title="undefined" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html" target="_blank" rel="noopener noreferrer">cron or rate expression</a> and since our Maintenance Window uses a rate expression, it will not run again for another 30 minutes. This issue also occurs for cron expressions that run in explicit intervals, for example <em>cron(0/15 * * * ? *)</em>. We can restart it by disabling and re-enabling the Maintenance Window.</p> 
<p>Here are the steps for restarting a Maintenance Window created in this walkthrough.</p> 
<ol> 
<li>Choose the Maintenance Window you want to restart.</li> 
<li>Choose <strong>Actions</strong> then choose <strong>Disable maintenance window</strong>.</li> 
<li>Choose <strong>Actions</strong> again then choose <strong>Enable maintenance window</strong>.</li> 
</ol> 
<p>Here are the steps for viewing the Step Function created in this walkthrough.</p> 
<ol> 
<li>Open the <strong>AWS CloudFormation</strong> console at <a title="undefined" href="https://console.aws.amazon.com/cloudformation" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/cloudformation</a>.</li> 
<li>Choose the <strong>CloudFormation</strong> stack created previously.</li> 
<li>Select the <strong>Resources</strong> tab, search for the <strong>StateMachine</strong> created by <strong>CloudFormation</strong>. Take note of the name of the StateMachine, it will look something like this <em>SSMStepFunctionDemo-YCIADKH4IGYU</em>.</li> 
<li>Open the <strong>AWS State Machine</strong> console at <a title="undefined" href="https://console.aws.amazon.com/states" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/states</a>.</li> 
<li>Choose the <strong>StateMachine</strong> with the name from <strong>step #3</strong>.</li> 
<li>Under the list of executions for the <strong>StateMachine</strong> find the currently running execution, then click on the link for that execution in the <strong>Name</strong> column.</li> 
</ol> 
<p>You can now watch as the Step Function executes each of the Lambda functions created through CloudFormation. Note that the actual updating of the patches can take some time, at least 10 to 15 minutes.</p> 
<p><strong>Viewing patching results</strong></p> 
<p>Now that the execution of the Step Function is complete, we can view the results of the Patching activity.</p> 
<p>Here are the steps to view the Maintenance Window patching results:</p> 
<ol> 
<li>Open the <strong>StateMachine</strong> execution from the previous step.</li> 
<li>Under the <strong>Visual Workflow</strong> tab, Choose the step labeled Patch Instance.</li> 
<li>Under <strong>Execution Details</strong> on the right, Choose the Output tab.</li> 
<li>Copy the value of <strong>commandId</strong>.</li> 
<li>Open the <strong>AWS Systems Manager</strong> console at <a title="undefined" href="https://console.aws.amazon.com/systems-manager" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/systems-manager</a>.</li> 
<li>Choose <strong>Explore Run Command</strong>.</li> 
<li>Choose the search bar at the top of the table to add a filter.</li> 
<li>Select <strong>Command Id</strong> as the filter and paste in the Command Id you copied from step #4.</li> 
<li>Select the <strong>Command</strong>.</li> 
<li>In the <strong>Output</strong> tab at the bottom,&nbsp;click <strong>View Output</strong>.</li> 
</ol> 
<p>The output will display various pieces of information including which patches were installed, the snapshot ID for the patching snapshot, and the patch baseline used.</p> 
<p><strong>Verifying that the instance has stopped</strong></p> 
<p>After the execution of the Step Function is complete, it will stop the instance. We can see this by viewing the instance in the EC2 console.</p> 
<ol> 
<li>Open the <strong>EC2</strong> console at <a title="undefined" href="https://console.aws.amazon.com/ec2" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/ec2</a>.</li> 
<li>Choose the <strong>Instances</strong> link under the <strong>Instances</strong> tab on the left.</li> 
<li>Find the <strong>EC2 instance</strong> with the Name <em>ssm-stepfunction-demo</em>.</li> 
</ol> 
<h3><strong>Conclusion</strong></h3> 
<p>In this post, I have shown you how to use CloudFormation to create a Maintenance Window that executes a Step Function, which&nbsp;uses Patch Manager to patch&nbsp;long running instances that we don’t want to keep on at all times. You can use CloudFormation to easily deploy Maintenance Windows across multiple Regions to ensure that resources are properly patched and that the states of your resources are as you expect. This also greatly reduces the burden of keeping Maintenance Windows in sync across Regions, guaranteeing that the Maintenance Windows are all operating in the same manner.</p> 
<p>For further information regarding using some of the AWS services in this blog post see the following user guides:</p> 
<p><a title="undefined" href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-maintenance.html" target="_blank" rel="noopener noreferrer">Maintenance Window User Guide</a><br /> <a title="undefined" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-patch.html" target="_blank" rel="noopener noreferrer">Patch Manager User Guide</a><br /> <a title="undefined" href="http://docs.aws.amazon.com/step-functions/latest/dg/welcome.html" target="_blank" rel="noopener noreferrer">Step Functions User Guide</a><br /> <a title="undefined" href="http://docs.aws.amazon.com/lambda/latest/dg/welcome.html" target="_blank" rel="noopener noreferrer">Lambda User Guide</a><br /> <a title="undefined" href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" target="_blank" rel="noopener noreferrer">CloudFormation User Guide</a></p> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/phonetoolicon.jpeg" /></p> 
<p>&nbsp;</p> 
<p>Spencer Glazier is a Software Development Engineer on the AWS Systems Manager team. He’s passionate about delivering products and services that enables customers to do more, faster and cheaper. In his free time he enjoys&nbsp;getting up early to run along the narrow streets of Seattle and spending time with his family.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Analyzing Bitcoin Data: AWS CloudFormation Support for AWS Glue</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Luis Colon</span></span> | on 
<time property="datePublished" datetime="2018-01-30T10:14:22+00:00">30 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/analytics/" title="View all posts in Analytics*"><span property="articleSection">Analytics*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/analytics/aws-glue/" title="View all posts in AWS Glue*"><span property="articleSection">AWS Glue*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/analyzing-bitcoin-data-aws-cloudformation-support-for-aws-glue/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>The AWS CloudFormation team has been busy in the last couple of months, adding support for new resource types for recently released AWS services. In this post, I take a deep dive into using AWS Glue with CloudFormation.</p> 
<p><strong>About AWS Glue</strong></p> 
<p><a href="https://aws.amazon.com/glue/">AWS Glue</a> was first announced at re:Invent in 2016, and was made generally available in August 2017. AWS Glue is a serverless extract, transform and load (<a href="https://en.wikipedia.org/wiki/Extract,_transform,_load">ETL</a>) service. ETL is a critical step in operationalizing data analytics, since data cleansing and reformatting is almost always necessary when creating everything from data marts, warehouses, data lakes, machine learning algorithms, metrics dashboards, operational reports, and many other data science projects.</p> 
<p>Data science projects can be very time-consuming from an experimentation and discovery perspective. When a promising candidate project emerges, implementing the necessary production compute and storage resources can cause significant delays. It’s necessary that the business leverage the resources in a repeatable and ongoing basis.</p> 
<p><strong>Analyzing historical price data for bitcoin: Planning</strong></p> 
<p>Your company wants to pursue a new service relating to cryptocurrency analysis, and your IT team gets asked to produce a database with historical price information for bitcoin, to feed other analysis processes. Rather than require a significant upfront investment in building the database and the necessary tooling for ongoing analysis and model development, you can leverage AWS Glue and open source development tools like <a href="https://spark.apache.org/">Apache Spark</a>, Python and <a href="https://zeppelin.apache.org/">Apache Zeppelin</a> to enable quick experimentation and further product development. Further, you want to automate the operationalization of this data analysis platform as quickly as possible, and AWS CloudFormation helps with this automation.</p> 
<p><span id="more-2555"></span></p> 
<p>Start with getting historical bitcoin price data. You can choose to consume the data directly from currency exchanges, or you can find an existing dataset that includes past data. There are many sources of public data sets for such projects, as outlined in 18 places to find data sets for data science projects. One of my favorite sources for such data sets is <a href="https://www.kaggle.com/">Kaggle</a>, where you can also learn from other scientists’ projects and findings, as well as participate in data science competitions sponsored by companies and academic institutions.</p> 
<p>The dataset <a href="https://www.kaggle.com/mczielinski/bitcoin-historical-data">from the Bitcoin Historical Data</a> page will fit our needs (see Figure 1 below); it includes historical data from January 2012 to today, from several exchanges.</p> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/29/datasample.png" /></p> 
<p><strong>Figure 1. A sample of the CSV data provided for the coinbase exchange.</strong></p> 
<p>&nbsp;</p> 
<p><strong>Setting up our Bitcoin Price Database</strong></p> 
<ol> 
<li>If you’ve never used Kaggle, you are asked to set up a free account.</li> 
<li>Download the data as a zip file from <a href="https://www.kaggle.com/mczielinski/bitcoin-historical-data">Bitcoin Historical Data</a>.</li> 
<li>Expand the zip file locally and locate the file for the coinbase exchange.</li> 
<li>Set up an Amazon S3 bucket and put the file there.</li> 
</ol> 
<p>Armed with this data, now get the data to a point that you can inspect it, query it, and plan for further development and experiments.</p> 
<ol> 
<li>Create a new file in your favorite editor.</li> 
<li>Copy and paste the following CloudFormation template into the file (see Figure 2 below).</li> 
<li>Save it, and create a new stack with the console (I used the US East N. Virginia region), the CLI, or the API.</li> 
</ol> 
<code class="lang-yaml">---
#===============================================================================
# Template: CoinbaseCrawler.yaml
#
# Purpose:  Creates resources to populate bitcoin historical data from
#           the Coinbase exchange into an AWS Glue Catalog
#===============================================================================
AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;Populate Bitcoin historical data from Coinbase into AWS Glue&quot;
Resources:
#=============================================================================
# IAM Role and Policies for AWS Glue. Reusable across other ETL crawlers
#=============================================================================
ETLRole:
Type: AWS::IAM::Role
Properties:
AssumeRolePolicyDocument:
Version: &quot;2012-10-17&quot;
Statement:
-
Effect: &quot;Allow&quot;
Principal:
Service:
- &quot;glue.amazonaws.com&quot;
Action:
- &quot;sts:AssumeRole&quot;
Path: &quot;/&quot;
Policies:
-
PolicyName: &quot;root&quot;
PolicyDocument:
Version: &quot;2012-10-17&quot;
Statement:
-
Effect: &quot;Allow&quot;
Action: &quot;*&quot;
Resource: &quot;*&quot;
#=============================================================================
# BitcoinPriceDB: May reuse it if we want to compare data from other
# exchanges, like bitflyer, coincheck, and bitstamp
#=============================================================================
BitcoinPriceDB:
Type: AWS::Glue::Database
Properties:
CatalogId: !Ref AWS::AccountId
DatabaseInput:
Name: &quot;bitcoin-price-db&quot;
Description: &quot;Historical Bitcoin Price Data&quot;
#=============================================================================
# CoinbaseCrawler: Grab data from the coinbase csv into the BitcoinPriceDB
# NOTE: You MUST change the S3 Targets Path to point to your own bucket and
# folder!!!
#=============================================================================
CoinbaseCrawler:
Type: AWS::Glue::Crawler
Properties:
Name: &quot;coinbase-crawler&quot;
Description: &quot;Populate table with Bitcoin historical data from Coinbase&quot;
Role: !GetAtt ETLRole.Arn
DatabaseName: !Ref BitcoinPriceDB
TablePrefix: &quot;coinbase_&quot;
Targets:
S3Targets:
- Path: s3://cfnda-bitcoin-historical-data/coinbase
SchemaChangePolicy:
UpdateBehavior: &quot;UPDATE_IN_DATABASE&quot;
DeleteBehavior: &quot;DEPRECATE_IN_DATABASE&quot;
Schedule:
ScheduleExpression: &quot;cron(0/5 * ? * MON-FRI *)&quot;
</code> 
<p><strong>Figure 2. The CloudFormation template for the AWS Glue crawler from bitcoin data.</strong></p> 
<p>You set up everything with CloudFormation early in the process, so eventually operationalizing the solution in a production environment becomes fast and repeatable.&nbsp;The template helps you:</p> 
<li>Designate S3 as the storage data lake</li> 
<li>Create an IAM role to use AWS Glue</li> 
<li>Extract the data</li> 
<li>Create a database</li> 
<li>Load the data into a table that you can query with <a href="https://aws.amazon.com/athena/">Amazon Athena</a> or later visualize with <a href="https://aws.amazon.com/quicksight/">Amazon QuickSight</a>.</li> 
<p>Note the following from the template code:</p> 
<li>The template creates the minimal resources for setting up your database. This include the IAM role (<em>ETLRole</em> in the code example), the database itself, which can be used in Athena or QuickSight for further analysis, and the crawler. The crawler does the work of extracting the data from the CSV file that you downloaded and populates the table in the database.</li> 
<li>When creating the database (<em>BitcoinPriceDB</em> in the code example), ensure that you only use lowercase characters in the string for the Database Input/Name attribute (<em>bitcoin-price-db</em>, in the code example).</li> 
<li>For the crawler, specify your bucket in the Targets/S3Targets/Path attribute (<em>s3://cfnda-bitcoin-historical-data/</em>coinbase in the code example). Put your own bucket and folder path where you uploaded your copy of the coinbase file that you got from Kaggle in the previous steps.</li> 
<li>For this example, the template sets up a schedule for the crawler to run every five minutes on weekdays. For your experiment, you may either omit the Schedule/ScheduleExpression stanza and run the crawler manually from the AWS Glue console, or use your own cron expression (see some examples in <a href="https://docs.aws.amazon.com/glue/latest/dg/monitor-data-warehouse-schedule.html">Time-Based Schedules for Jobs and Crawlers</a>,keeping in mind that you are charged per the rates on <a href="https://aws.amazon.com/glue/pricing/">AWS Glue Pricing</a>).</li> 
<li>For this quick example, it makes sense to put everything in one template, with the benefit of quickly deleting all resources by deleting the stack. For a long-term project, you may want to create these resources in separate templates, as you only need to create the role and database one time. To look at the data from the other bitcoin exchanges provided in the Kaggle dataset, reuse the crawler code in separate templates and stacks for biflyer, coincheck, and bit stamp, which are also provided in the same dataset.</li> 
<p>After creating the stack, which should take about 40 seconds, check the AWS Glue console where your database and crawler show up on the respective lists immediately. After the crawler runs (in about 5 minutes, per your scheduled cron expression), the table also shows up. After the table creation is complete, you can view the schema from the AWS Glue console (see Figure 3), or execute SQL queries against it using the Athena console (see Figure 4).</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/29/glue-coinbase-table-schema-1024x543.png" /></p> 
<p><strong>Figure 3. Schema for the coinbase historical pricing table, created with the AWS Glue crawler.</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/29/athena-coinbase-table-preview-1024x576.png" /></p> 
<p><strong>Figure 4. Sample query results from the coinbase historical pricing table, using the Athena Query Editor.</strong></p> 
<p>&nbsp;</p> 
<p><strong>Suggested next steps</strong></p> 
<p>Now that you’ve figured out how to ingest the data to a place where you can query it, you can begin to compare the data with other exchanges from the dataset. You can also merge it with other data, reformat the data to make it easier to consume, and further enable data experiments.</p> 
<p>For example, maybe you want to merge the data with other events or logs, but those events lack enough structure to build tables from them and join them with your existing tables.&nbsp;Using AWS Glue <a href="https://docs.aws.amazon.com/glue/latest/dg/add-classifier.html">classifiers</a>, you can use grok expressions to add structure to these additional data sources.</p> 
<p>Another example that considers the current data schema would be transforming the UNIX time format field to a conventional date field.&nbsp;AWS Glue allows for the creation of <a href="https://docs.aws.amazon.com/glue/latest/dg/add-job.html">jobs</a> that can do such transforms on fields.&nbsp;It also allows you to use <a href="http://spark.apache.org/docs/2.2.0/api/python/pyspark.html">PySpark</a> (Python-based <a href="http://spark.apache.org/">Spark</a> scripts) to do such transformations.&nbsp;You can later operationalize those scripts as jobs in AWS Glue, and have them run periodically or based on a trigger, perhaps to get updated data.</p> 
<p>You can write and debug your own scripts, from your local IDE, by creating development endpoints in AWS Glue.&nbsp;Further, you can develop scripts and conduct experiments using <a href="https://zeppelin.apache.org/">Apache Zeppelin</a> notebooks, deploying a server with the Zeppelin software ready to use.&nbsp;Not surprisingly, AWS Glue uses CloudFormation to deploy these Zeppelin servers.&nbsp;For more information about setting up your local IDE, see <a href="https://docs.aws.amazon.com/glue/latest/dg/dev-endpoint-tutorial-pycharm.html">Tutorial: Set Up PyCharm Professional with a Development Endpoint</a> to link your AWS Glue endpoint with JetBrains’ <a href="https://www.jetbrains.com/pycharm/">PyCharm Professional</a>, or see <a href="https://docs.aws.amazon.com/glue/latest/dg/dev-endpoint-tutorial-EC2-notebook.html">Tutorial: Set Up an Apache Zeppelin Notebook on Amazon EC2</a> on how to create a Zeppelin notebook server on an Amazon EC2 instance right from the AWS Glue console, using CloudFormation to deploy the server.</p> 
<p>Visit the <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> details page and <a href="https://aws.amazon.com/documentation/cloudformation/">CloudFormation documentation</a> for more information, as well as the full list of <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-supported-resources.html">supported resources</a>.</p> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<table style="height: 164px" width="1242"> 
<tbody> 
<tr> 
<td width="63"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/17/PhoneTool1.jpg" /></td> 
<td width="391"> <p><strong>Luis Colon is a Senior Developer Advocate for the AWS CloudFormation team.</strong>&nbsp;He works with customers and internal development teams to focus on and improve the developer experience for CloudFormation users. In his spare time, he mixes progressive trance music.</p> <p>&nbsp;</p></td> 
</tr> 
</tbody> 
</table> 
<p></p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">AWS CloudFormation Update: AWS Guard Duty, Amazon Inspector, and Service Discovery, plus 40 resource updates</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Luis Colon</span></span> | on 
<time property="datePublished" datetime="2018-01-30T10:14:06+00:00">30 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-cloudformation-update-aws-guard-duty-amazon-inspector-and-service-discovery-plus-40-resource-updates/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS CloudFormation recently added support for these recently released AWS services:</p> 
<li><a href="https://aws.amazon.com/guardduty/"><strong>AWS Guard Duty</strong></a> is an automated threat-detection service that can be quickly enabled, does not require agents to be installed, and monitors unusual account usage using sources like AWS CloudTrail logs, DNS logs, and other sources. With the new AWS CloudFormation resource support, you can create <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-guardduty-detector.html">detectors</a>, whitelisted <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-guardduty-ipset.html">IP sets</a>, and identify known malicious IP addresses via <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-guardduty-threatintelset.html">ThreatIntelSets</a>.</li> 
<li><a href="https://aws.amazon.com/inspector/"><strong>Amazon Inspector</strong></a> is a low-impact, low-cost, agent-based vulnerability scanner.Use it, for example, to automate vulnerability assessments and make them part of your deployment process.&nbsp;With the new AWS CloudFormation resource support, you can take tagged resources and build a <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-inspector-resourcegroup.html">resource group</a>, then use the resource group to create an <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-inspector-assessmenttarget.html">assessment target</a>.&nbsp;Finally, you can create an <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-inspector-assessmenttemplate.html">assessment template</a>, which is similar to a policy document and determines which rules the service uses to analyze the target hosts, as well as a duration for the assessment run.</li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/12/amazon-route-53-releases-auto-naming-api-name-service-management/"><strong>Amazon Route 53 Auto Naming for Service Discovery</strong></a> and the new AWS::ServiceDiscovery resources in CloudFormation make it easy to consume the recently released Route 53 Auto Naming API calls.It can be used, for example, if you’re creating microservices in Amazon ECS and you want to leverage Route 53 to register new service instances and aid in the management and discovery of service names. This is important for <a href="https://aws.amazon.com/ecs/">Amazon ECS</a> deployments, and it helps enable blue/green deployment patterns.&nbsp;With the new AWS CloudFormation resources, you can create either <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-servicediscovery-publicdnsnamespace.html">public</a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-servicediscovery-privatednsnamespace.html">private</a> DNS namespaces, then create named <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-servicediscovery-service.html">services</a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-servicediscovery-instance.html">service instances</a> for your microservices.&nbsp;If you’re interested in using these new resources, I recommend checking out this <a href="https://www.slideshare.net/AmazonWebServices/introducing-service-discovery-for-amazon-ecs-con403-reinvent-2017">deck</a> from a session at the AWS re:Invent 2017 conference.</li> 
<p>Beyond supporting these new services, 40 of the 248 existing supported resources have been updated recently, adding 50 new property types for these resources. The following list summarizes these recent changes, ordered by service name:</p> 
<p><span id="more-2568"></span></p> 
<p><strong>Amazon API Gateway</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-deployment.html">AWS::ApiGateway::Deployment</a>, a&nbsp;<em>StageName</em> property has been deprecated on the StageDescription property type</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-method.html">AWS::ApiGateway::Method</a>, an&nbsp;<em>OpeationName</em> property was added to assign a friendly name to an API Gateway method; a&nbsp;<em>RequestValidatorId</em> property was added to associate a request validator with a method; a&nbsp;<em>ContentHandling</em> property was added for <em>Integration</em> and <em>IntegrationResponse</em> property types to specify how to handle request payload content type conversions</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-apikey.html">AWS::ApiGateway::ApiKey</a>, a&nbsp;<em>CustomerID</em> property was added to specify an AWS Marketplace customer identifier; a&nbsp;<em>GenerateDistinctID</em> property was added to indicate whether the key identifier is different from the created API key value</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-authorizer.html">AWS::ApiGateway::Authorizer</a>, an&nbsp;<em>AuthType</em> property was added to specify a customer-defined field that is used in Swagger imports and exports without functional impact</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-domainname.html">AWS::ApiGateway::DomainName</a>, an&nbsp;<em>EndpointConfiguration</em> property was added to specify the endpoint types of an API Gateway domain name; a&nbsp;<em>RegionalCertificateArn</em> property was added to reference a certificate for use by the regional endpoint for a domain name</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-restapi.html">AWS::ApiGateway::RestApi</a>, an&nbsp;<em>EndpointConfiguration</em> property was added to specify the endpoint types of a REST API</li> 
<p><strong>AWS Auto Scaling</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-applicationautoscaling-scalabletarget.html">AWS::ApplicationAutoScaling::ScalableTarget</a>, a&nbsp;<em>ScheduledActions</em> property was added to specify scheduled actions</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html">AWS::AutoScaling::AutoScalingGroup</a>, a&nbsp;<em>LifecycleHookSpecificationList</em> property was added to specify actions to perform when Auto Scaling launches or terminates instances</li> 
<p><strong>AWS Cloud9</strong></p> 
<li><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloud9-environmentec2.html">AWS::Cloud9::EnvironmentEC2</a>&nbsp;creates an Amazon EC2 development environment in AWS Cloud9</li> 
<p><strong>AWS CodeBuild</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html">AWS::CodeBuild::Project</a>, a <em>BadgeEnabled</em> property was added to generate a publicly accessible URL for a project’s build badge; a <em>Cache</em> property was added to configure cache settings for build dependencies; a <em>VpcConfig</em> property was added to enable AWS CodeBuild to access resources in an Amazon VPC; a <em>Type</em> property was added in the EnvironmentVariable property type to specify the type of environment variable</li> 
<p><strong>AWS CodeDeploy</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codedeploy-application.html">AWS::CodeDeploy::Application</a>, a <em>ComputePlatform</em> property was added to specify an AWS Lambda compute platform for AWS CodeDeploy to deploy an application to</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codedeploy-deploymentgroup.html">AWS::CodeDeploy::DeploymentGroup</a>, a <em>TargetGroupInfoList</em> property was added to the <em>LoadBalancerInfo</em> property type to specify information about a target group in Elastic Load Balancing to use in a deployment; a <em>DeploymentType</em> property was added to the <em>DeploymentStyle</em> property type to specify a blue/green deployment on a Lambda compute platform</li> 
<p><strong>Amazon CloudFront</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution.html">AWS::CloudFront::Distribution</a>, a <em>Tags</em> property was added to specify an arbitrary set of tags (key-value pairs) to associate with an Amazon CloudFront distribution; <em>OriginKeepAliveTimeout</em> and <em>OriginReadTimeout</em> properties were added to the <em>CustomOriginConfig</em> property type to specify a custom keep-alive timeout and a custom origin read timeout respectively; an <em>IPV6Enabled</em> property was added to the <em>DistributionConfig</em> property type to specify whether Amazon CloudFront responds to IPv6 DNS requests an IPv6 address for your distribution</li> 
<li>Use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudfront-cloudfrontoriginaccessidentity.html">AWS::CloudFront::CloudFrontOriginAccessIdentity</a> resource to specify the origin access identity to associate with the origin of an Amazon CloudFront distribution</li> 
<li>Use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudfront-streamingdistribution.html">AWS::CloudFront::StreamingDistribution</a> resource to specify an Adobe Real-Time Messaging protocol (RTMP) streaming distribution for Amazon CloudFront</li> 
<p><strong>Amazon EC2</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html">AWS::EC2::SecurityGroup</a>, <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-security-group-egress.html">AWS::EC2::SecurityGroupEgress</a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group-ingress.html">AWS::EC2::SecurityGroupIngress</a> resources, a <em>Description</em> property was added to specify the description of security group rules</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html">AWS::EC2::Subnet</a>, an <em>Ipv6CidrBlock</em> property now supports <em>No Interruption</em> updates</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpn-gateway.html">AWS::EC2::VPNGateway</a>, an <em>AmazonSideAsn</em> property was added to specify a private Autonomous System Number (ASN) for the Amazon side of a Border Gateway Protocol (BGP) session</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpn-connection.html">AWS::EC2::VPNConnection</a>, a <em>VpnTunnelOptionsSpecifications</em> property was added to configure tunnel options for a VPN connection</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-spotfleet.html">AWS::EC2::SpotFleet</a>, the <em>SpotPrice</em> property in <em>SpotFleetRequestConfigData</em> property type is now optional</li> 
<p><strong>Amazon Elastic Container Registry</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecr-repository.html">AWS::ECR::Repository</a>, a <em>LifecyclePolicy</em> property was added to specify a lifecycle policy for an Amazon ECR repository</li> 
<p><strong>Amazon Elastic Container Service</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html">AWS::ECS::TaskDefinition</a>, a <em>LinuxParameters</em> property was added to the <em>ContainerDefinition</em> property type to specify Linux-specific options for an Amazon ECS container; a <em>Cpu</em> property was added to specify the number of CPU units needed for the task; an <em>ExecutionRoleArn</em> property was added to specify the Amazon Resource Name (ARN) of the execution role; Memory property was added to specify the amount of memory in MiB needed for the task; and a <em>RequiresCompatibilities</em> property was added to specify the launch type the task requires</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html">AWS::ECS::Service</a>, a <em>LaunchType</em> property was added to specify the launch type on which to run the service; a <em>NetworkConfiguration</em> property was added to specify the network configuration for the service; a <em>PlatformVersion</em> property was added to specify the platform version on which to run your service</li> 
<p><strong>AWS Elastic Beanstalk</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-beanstalk-configurationtemplate.html">AWS::ElasticBeanstalk::ConfiguraionTemplate</a>, and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-beanstalk-environment.html">AWS::ElasticBeanstalk::Environment</a>, a <em>ResourceName</em> property was added to the <em>ConfigurationOptionSetting</em> and <em>OptionSetting</em> property types, to specify a resource name for a time-based scaling configuration option</li> 
<p><strong>Amazon ElastiCache</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticache-replicationgroup.html">AWS::ElastiCache::ReplicationGroup</a>, an <em>AtRestEncryptionEnabled</em> property was added to enable encryption at rest; an <em>AuthToken</em> property was added to specify a password that is used to access a password-protected server; and a <em>TransitEncryptionEnabled</em> property was added to enable in-transit encryption</li> 
<p><strong>Elastic Load Balancing</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html">AWS::ElasticLoadBalancingV2::TargetGroup</a>, use the <em>TargetGroupName</em> attribute with the <em>Fn::GetAtt</em> function to get the name of an Elastic Load Balancing target group</li> 
<p><strong>Amazon ElasticSearch Service</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticsearch-domain.html">AWS::Elasticsearch::Domain</a>, a <em>VPCOptions</em> property was added to specify a VPC configuration for the domain</li> 
<p><strong>Amazon EMR</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-emr-cluster.html">AWS::EMR::Cluster</a>, a <em>CustomAmiId</em> property was added to specify a custom Amazon Linux AMI for a cluster; an&nbsp;<em>EbsRootVolumeSize</em> property was added to specify the size of the EBS root volume for an Amazon EMR cluster</li> 
<p><strong>Amazon Kinesis</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-kinesisanalytics-application.html">AWS::KinesisAnalytics::Application</a>, an <em>InputProcessingConfiguration</em> property was added to the Input property type to transform records as they are received from the stream</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-kinesisfirehose-deliverystream.html">AWS::KinesisFirehose::DeliveryStream</a>, use the <em>Arn</em> attribute with the <em>Fn:GetAtt</em> function to get the Amazon Resource Name (ARN) of the delivery stream</li> 
<p><strong>AWS Key Management Service</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-kms-key.html">AWS::KMS::Key</a>, a <em>Tags</em> property was added to specify an arbitrary set of tags (key-value pairs) to associate with a custom master key</li> 
<p><strong>AWS Lambda</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-alias.html">AWS::Lambda::Alias</a>, use the <em>CodeDeployLambdaAliasUpdate</em> update policy to perform an AWS CodeDeploy deployment when the version changes on a resource; you can also use the <em>RoutingConfig</em> property to specify two different versions of an AWS Lambda function, allowing you to dictate what percentage of traffic will invoke each version</li> 
<p><strong>AWS OpsWorks</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-opsworks-layer.html">AWS::Opsworks::Layer</a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-opsworks-stack.html">AWS::OpsWorks::Stack</a>, a <em>Tags</em> property was added to specify an arbitrary set of tags (key-value pairs) to associate with either a layer or stack</li> 
<p><strong>Amazon RDS</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-rds-optiongroup.html">AWS::RDS::OptionGroup</a>, an <em>OptionVersion</em> property was added to the <em>OptionConfiguration</em> property type to specify a version for the option</li> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html">AWS::RDS::DBInstance</a>, <em>SourceRegion</em> and <em>KmsKeyId</em> properties were added to create an encrypted read replica from a cross-region source database instance</li> 
<p><strong>Amazon Route53</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-route53-hostedzone.html">AWS::Route53::HostedZone</a>, a <em>QueryLoggingConfig</em> property was added to specify a configuration for DNS query logging</li> 
<p><strong>Amazon S3</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html">AWS::S3::Bucket</a>, an <em>AnalyticsConfigurations</em> property was added to configure an analysis filter for an Amazon S3 bucket</li> 
<p><strong>AWS Systems Manager</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ssm-parameter.html">AWS::SSM::Parameter</a>, an <em>AllowedPattern</em> property was added to specify a regular expression used to validate the parameter value</li> 
<p><strong>AWS Step Functions</strong></p> 
<li>For <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-stepfunctions-statemachine.html">AWS::StepFunctions::StateMachine</a>, you can specify a <em>StateMachineName</em> when creating a state machine, and both <em>DefinitionString</em> and <em>RoleArn</em> can be updated without replacing the state machine.</li> 
<p>&nbsp;</p> 
<p>Visit the <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> details page and <a href="https://aws.amazon.com/documentation/cloudformation/">CloudFormation documentation</a> for more information, as well as the full list of <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-supported-resources.html">supported resources</a>.</p> 
<h3>About the Author</h3> 
<table style="height: 250px" width="1107" cellpadding="8"> 
<tbody> 
<tr> 
<td width="63">&nbsp;<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/17/PhoneTool1.jpg" /></td> 
<td width="391"> <p><strong>Luis Colon is a Senior Developer Advocate for the AWS CloudFormation team.</strong>&nbsp;He works with customers and internal development teams to focus on and improve the developer experience for CloudFormation users. In his spare time, he mixes progressive trance music.</p> <p>&nbsp;</p></td> 
</tr> 
</tbody> 
</table> 
<p>&nbsp;</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Password Rotation for Windows on Amazon EC2 Made Easy with EC2Rescue</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Alessandro Martini</span></span> | on 
<time property="datePublished" datetime="2018-01-26T17:41:05+00:00">26 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/compute/" title="View all posts in Compute*"><span property="articleSection">Compute*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/password-rotation-for-windows-on-amazon-ec2-made-easy-with-ec2rescue/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/Windows-Server-EC2Rescue.html">EC2Rescue for Windows</a> is an easy-to-use tool that you run on an <a href="https://aws.amazon.com/ec2">Amazon EC2</a> Windows Server instance to diagnose and troubleshoot possible problems. A common use of the tool is to <a href="https://aws.amazon.com/premiumsupport/knowledge-center/reset-admin-password/">reset the local administrator password</a>.</p> 
<p>Password rotation is an important security task in any organization. In addition, setting strong passwords is necessary to ensure that the password doesn’t get hacked by brute force or dictionary attacks.&nbsp;However, these tasks become very challenging to perform manually, particularly when you are dealing with more than a few servers.</p> 
<p><a href="https://aws.amazon.com/systems-manager">AWS Systems Manager</a> allows you to manage your fleet remotely, and to run commands at scale using Run Command.&nbsp;The Systems Manager Parameter Store feature is integrated with AWS Key Management Service (<a href="https://aws.amazon.com/kms">AWS KMS</a>). Parameter Store allows for string values to be stored encrypted, with granular access controlled by AWS Identity and Access Management (<a href="https://aws.amazon.com/iam">IAM</a>) policies.</p> 
<p>In this post, I show you how to rotate the local administrator password for your Windows instances using EC2Rescue, and store the rotated password in Parameter Store. By using Systems Manager Maintenance Window, you can then schedule this activity to occur automatically at a frequency of your choosing.</p> 
<p><span id="more-2155"></span></p> 
<b><strong>Overview</strong></b> 
<p>EC2Rescue is available as a Run Command document called <a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2rw-ssm.html">AWSSupport-RunEC2RescueForWindowsTool</a>. The option to reset the local administrator password allows you to specify which KMS key to use to encrypt the randomly generated password.<br /> If your EC2 Windows instances are already enabled with Systems Manager, then the password reset via EC2Rescue Run Command happens online, with no downtime. You can then configure a Systems Manager maintenance window to run AWSSupport-RunEC2RescueForWindowsTool on a schedule (make sure your EC2 instances are running during the maintenance window!).</p> 
<b><strong>Workflow</strong></b> 
<p>In this post, I provide step-by-step instructions to configure this solution manually. For those of you who want to see the solution in action with minimal effort, I have created a CloudFormation template that configures everything for you, in the us-west-2 (Oregon) region.</p> 
<p><a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?filter=active&amp;templateURL=https:%2F%2Fs3.amazonaws.com%2Fec2rescue%2Fsolutions%2FAWS-ResetWindowsPasswordOnASchedule.template&amp;stackName=ResetWindowsPasswordOnASchedule"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/cloudformation-launch-stack-button.png" /></a></p> 
<p>&nbsp;</p> 
<p>Keep reading to learn what is being configured, or jump to the <strong>Deploy the solution</strong> section for a description of the template parameters.</p> 
<h3><strong>Define a KMS key</strong></h3> 
<p>First, you create a KMS key specifically to encrypt Windows passwords. This gives you control over which users and roles can encrypt these passwords, and who can then decrypt them. I recommend that you create a new KMS key dedicated to this task to better manage access.</p> 
<h4><strong>Create a JSON file for the Key policy</strong></h4> 
<p>In a text editor of your choosing, copy and paste the following policy. Replace <span style="color: #ff0000"><strong>ACCOUNTID</strong></span> with your AWS Account ID.&nbsp;<strong>Administrators</strong>&nbsp;is the IAM role name that you want to allow to&nbsp;decrypt the rotated passwords, and&nbsp;<strong>EC2SSMRole&nbsp;</strong>is the IAM role name attached to your EC2 instances. Save the file as&nbsp;<em>RegionalPasswordEncryptionKey-Policy.json</em>.</p> 
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Id&quot;: &quot;key-policy&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;Allow access for Key Administrators&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;arn:aws:iam::<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:role/<strong>Administrators</strong>&quot;
},
&quot;Action&quot;: [
&quot;kms:Create*&quot;,
&quot;kms:Describe*&quot;,
&quot;kms:Enable*&quot;,
&quot;kms:List*&quot;,
&quot;kms:Put*&quot;,
&quot;kms:Update*&quot;,
&quot;kms:Revoke*&quot;,
&quot;kms:Disable*&quot;,
&quot;kms:Get*&quot;,
&quot;kms:Delete*&quot;,
&quot;kms:ScheduleKeyDeletion&quot;,
&quot;kms:CancelKeyDeletion&quot;
],
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Sid&quot;: &quot;Allow decryption&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;arn:aws:iam::<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:role/<strong>Administrators</strong>&quot;
},
&quot;Action&quot;: &quot;kms:Decrypt&quot;,
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Sid&quot;: &quot;Allow encryption&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;arn:aws:iam::<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:role/<strong>EC2SSMRole</strong>&quot;
},
&quot;Action&quot;: &quot;kms:Encrypt&quot;,
&quot;Resource&quot;: &quot;*&quot;
}
]
}
 
<p><strong>Create the key and its alias (user-friendly name)</strong><br /> Use the following CLI command to create a KMS key that the IAM role <strong>Administrators</strong> can manage, and that the IAM role <strong>EC2SSMRole</strong> can use for encryption only:</p> 
aws kms create-key \
–-policy file://RegionalPasswordEncryptionKey-Policy.json \
--description &quot;Key used to encrypt local Administrator passwords stored in SSM Parameter Store.&quot;
Output:
{
&quot;KeyMetadata&quot;:
{
&quot;Origin&quot;: &quot;AWS_KMS&quot;,
&quot;KeyId&quot;: &quot;<strong>88eea0b7-0508-4318-a0bc-feee4a5250a3</strong>&quot;,
&quot;Description&quot;: &quot;Key used to encrypt local Administrator passwords stored in SSM Parameter Store.&quot;,
(...)
}
}
 
<p>Use the following CLI command to create an alias for the KMS key:</p> 
aws kms create-alias \
--alias-name alias/WindowsPasswordRotation-EncryptionKey \
--target-key-id <strong>88eea0b7-0508-4318-a0bc-feee4a5250a3
</strong> 
<h3><strong>Define a maintenance window</strong></h3> 
<p>Use a maintenance window to schedule the password reset. Here is the CLI command to schedule such activity every Sunday at 5AM UTC:</p> 
aws ssm create-maintenance-window \
--name &quot;windows-password-rotation&quot; \
--schedule &quot;cron(0 5 ? * SUN *)&quot; \
--duration 2 \
--cutoff 1 \
--no-allow-unassociated-targets
Output:
{ &quot;WindowId&quot;: &quot;<strong>mw-0f2c58266a8c49246</strong>&quot; }
 
<h3><strong>Define a target</strong></h3> 
<p>Use tags to identify which instances to reset the password. For example, you can reset all instances tagged with tag key <strong>Environment</strong> with value <strong>Production</strong>.</p> 
aws ssm register-target-with-maintenance-window \
--window-id &quot;<strong>mw-0f2c58266a8c49246</strong>&quot; \
--targets &quot;Key=tag:<strong>Environment</strong>,Values=<strong>Production</strong>&quot; \
--owner-information &quot;Production Servers&quot; \
--resource-type &quot;INSTANCE&quot;
Output:
{
&quot;WindowTargetId&quot;: &quot;<strong>a5fc445b-a7f1-4591-b528-98440832da41</strong>&quot;
}
 
<h3><strong>Define a maintenance window IAM role</strong></h3> 
<p>These steps are only necessary if you haven’t configured a maintenance window before. Skip this section if you already have your IAM role with the AmazonSSMMaintenanceWindowRole AWS Managed Policy attached.</p> 
<h4><strong>Create a JSON file for the role trust policy</strong></h4> 
<p>In a text editor of your choosing, copy and paste the following trust policy. Save the file as <em>AutomationMWRole-Trust-Policy.json</em>.</p> 
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {
&quot;Service&quot;: &quot;ssm.amazonaws.com&quot;
},
&quot;Action&quot;: &quot;sts:AssumeRole&quot;
}
]
}
 
<h4><strong>Create the IAM role and attach the Amazon managed policy for SSM maintenance window</strong></h4> 
<p>Use the following CLI two commands to create the IAM role&nbsp;<strong>AutomationMWRole&nbsp;</strong>and associate the&nbsp;AmazonSSMMaintenanceWindowRole&nbsp;AWS Managed Policy<strong>.</strong></p> 
aws iam create-role \
--role-name <strong>AutomationMWRole</strong> \
--assume-role-policy-document file://AutomationMWRole-Trust-Policy.json
aws iam attach-role-policy \
--policy-arn arn:aws:iam::aws:policy/service-role/AmazonSSMMaintenanceWindowRole \
--role-name AutomationMWRole
 
<h3><strong>Define a task</strong></h3> 
<p>EC2Rescue is available as a Run Command document called <a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2rw-ssm.html">AWSSupport-RunEC2RescueForWindowsTool</a>. This document allows you to run EC2Rescue remotely on your instances. One of the available options is the ability to reset the local administrator password. As the final configuration step, create a Run Command task that runs AWSSupport-RunEC2RescueForWindowsTool with the following parameters:</p> 
<li>Command = ResetAccess</li> 
<li>Parameters = KMS Key ID</li> 
<p>Rotated passwords are saved in Parameter Store encrypted with the KMS key to use. Here is the CLI command using the KMS key, target, maintenance window and role that you previously generated:</p> 
aws ssm register-task-with-maintenance-window \
--targets &quot;Key=WindowTargetIds,Values=<strong>a5fc445b-a7f1-4591-b528-98440832da41</strong>&quot; \
--task-arn &quot;AWSSupport-RunEC2RescueForWindowsTool&quot; \
--service-role-arn &quot;arn:aws:iam::<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:role/AutomationMWRole&quot; \
--window-id &quot;<strong>mw-0f2c58266a8c49246</strong>&quot; \
--task-type &quot;RUN_COMMAND&quot; \
--task-parameters&nbsp; &quot;{\&quot;Command\&quot;:{ \&quot;Values\&quot;: [\&quot;ResetAccess\&quot;] }, \&quot;Parameters\&quot;:{ \&quot;Values\&quot;: [\&quot;<strong>88eea0b7-0508-4318-a0bc-feee4a5250a3</strong>\&quot;] } }&quot; \
--max-concurrency 5 \
--max-errors 1 \
--priority 1
Output:
{
&quot;WindowTaskId&quot;: &quot;<strong>a3571731-c64c-4e43-be8d-7b543942a179</strong>&quot;
}
 
<p>Your Windows instances need to be enabled for Systems Manager, and to have additional IAM permissions to be able to write to Parameter Store. You can accomplish this by adding the following policy to the existing IAM roles associated with your Windows instances:</p> 
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;ssm:PutParameter&quot;
],
&quot;Resource&quot;: [
&quot;arn:aws:ssm:*:<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:parameter/EC2Rescue/Passwords/*&quot;
]
}
]
}
 
<p>Save the policy as&nbsp;<em>EC2Rescue-ResetAccess-Policy.json</em>. Here are the CLI commands to create a new IAM customer managed policy and attach it to an existing Systems Manager IAM role for EC2 (in this example, <strong>EC2SSMRole</strong>).</p> 
aws iam create-policy \
--policy-name EC2Rescue-ResetAccess-Policy \
--policy-document file://EC2Rescue-ResetAccess-Policy.json
aws iam attach-role-policy \
--policy-arn arn:aws:iam::<span style="color: #ff0000"><strong>ACCOUNTID</strong></span>:policy/EC2Rescue-ResetAccess-Policy \
--role-name <strong>EC2SSMRole
</strong> 
<b><strong>Deploy the solution</strong></b> 
<p>To simplify the deployment of this solution, I have created an AWS CloudFormation template that configures all the parts described earlier in this post, and deploys this solution in us-west-2 (Oregon).</p> 
<p><a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?filter=active&amp;templateURL=https:%2F%2Fs3.amazonaws.com%2Fec2rescue%2Fsolutions%2FAWS-ResetWindowsPasswordOnASchedule.template&amp;stackName=ResetWindowsPasswordOnASchedule"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/cloudformation-launch-stack-button.png" /></a></p> 
<p>&nbsp;</p> 
<p>These are the parameters that the template requires:</p> 
<li><strong>Target</strong> 
<li>Tag key to filter your instances</li> 
<li>Tag value to filter your instances</li> 
<li>Cron expression for the maintenance window</li> 
</ul> </li> 
<li><strong>Permissions</strong> 
<li>Existing IAM role name you are using for your Systems Manager-enabled EC2 instances, which will be authorized to encrypt the passwords.</li> 
</ul> </li> 
<li><strong>Security</strong> 
<li>Current IAM role name that you are using to deploy this CloudFormation template. The role is authorized to decrypt the passwords and manage the KMS key.</li> 
</ul> </li> 
<p>The following figure shows the CloudFormation console, with the default template parameters and the existing EC2 IAM role named <strong>EC2SSMRole</strong>, as well as the administrative IAM role <strong>Administrators</strong>, which you use to create the CloudFormation stack.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/cfn-parameters.png" /></p> 
<p>The deployment takes few minutes. Here is a sample maintenance window, which was last executed on October 29th 2017.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/mw.png" /></p> 
<p>Parameter Store has an encrypted parameter for each production Windows instance. You can decrypt each value from the console if you have kms:decrypt permissions on the key used to encrypt the password.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/ps.png" /></p> 
<b><strong>Conclusion</strong></b> 
<p>In this post, I showed you how to enhance the security of an EC2 environment by automating secure password rotation. Passwords are rotated on a schedule, and these actions are logged in AWS CloudTrail. Passwords are stored in Parameter Store with a KMS key, so that you have granular control over who has access to the encrypted passwords with IAM policies.<br /> As long as your EC2 Windows instances are running during the maintenance window and are configured to work with Systems Manager, the local administrator password is rotated automatically. Additional maintenance windows can be created for other environments, or new targets added to the existing maintenance window (such as development, staging, or QA environments).</p> 
<p><strong>About the Author</strong><br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/02/AMartini.jpg" />Alessandro Martini is a Senior Cloud Support Engineer in the AWS Support organization. He likes working with customers, understanding and solving problems, and writing blog posts that outline solutions on multiple AWS products. He also loves pizza, especially when there is no pineapple on it.</p> 
</article> 
<p>
© 2018 Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
