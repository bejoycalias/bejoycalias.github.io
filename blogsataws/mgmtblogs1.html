<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/12/CloudFormation.jpg" /> 
<b class="lb-b blog-post-title" property="name headline">Using AWS Cloud9, AWS CodeCommit, and Troposphere to author AWS CloudFormation templates</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Luis Colon</span></span> | on 
<time property="datePublished" datetime="2018-03-14T12:13:39+00:00">14 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/developer-tools/" title="View all posts in Developer Tools*"><span property="articleSection">Developer Tools*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/using-aws-cloud9-aws-codecommit-and-troposphere-to-author-aws-cloudformation-templates/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS Cloud9 was announced at AWS re:Invent in November 2017. It’s a browser-based IDE suitable for many cloud development use cases, including serverless applications. AWS CloudFormation now supports quickly spinning up AWS Cloud9 development environments, with integration with AWS CodeCommit. In this blog post, I’ll explore how to quickly spin up AWS Cloud9 environments with CloudFormation, and also how to code in AWS Cloud9 with Python and Boto3, and generate CloudFormation template code in YAML using <a href="https://github.com/cloudtools/troposphere">Troposphere</a>.<span id="more-2791"></span></p> 
<p>Note: As of the time of this writing, AWS Cloud9 is available in the following AWS Regions: Northern Virginia, Ohio, Oregon, Ireland, and Singapore regions.</p> 
<b><strong>Spinning up Cloud9 Environments with CloudFormation</strong></b> 
<p>Using the <code class="lang-clike">AWS::Cloud9::EnvironmentEC2</code> resource type, you can quickly deploy AWS Cloud9 development environments, which you can use to set up development environments for a class or workshop at your company. Each AWS Cloud9 environment also creates an Amazon EC2 instance where you can use a command line to set up additional development tools, much like modern IDEs integrate with your local machine’s terminal sessions. You can also use this automation opportunity to set up CodeCommit repositories for each student that is using the environment. When you create these environments using CloudFormation you can also create a Git-compatible repository and integrate it with the Amazon EC2 instance that gets deployed with the AWS Cloud9 environments.</p> 
<p>The template code that follows shows how simple it is to set up a single environment using CloudFormation with a CodeCommit repository. There are two prerequisites that you must complete before you deploy this template into a stack:</p> 
<li>Your IAM user must belong to a group that includes the <code class="lang-clike">AWSCodeCommitPowerUser</code>&nbsp;and <code class="lang-clike">AWSCodeCommitFullAccess</code></li> 
<li>You need an appropriate subnet to deploy the EC2 instance. I used an account that had a VPC already deployed. (For more information, read <a href="https://docs.aws.amazon.com/AmazonVPC/latest/GettingStartedGuide/getting-started-ipv4.html">Getting Started with Amazon VPC</a>.) I used the intrinsic function <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html"><code class="lang-clike">GetAtt</code></a>&nbsp;to connect the instance to the CodeCommit repository being created.</li> 
<p>After it’s deployed, this template creates a separate stack that includes the EC2 instance as an output. This additional stack gets deleted after you delete the <code class="lang-clike">AWS::Cloud9::EnvironmentEC2</code> resources, so you don’t have to worry about administering this additional stack for the purposes of this example. After the stack deployment is complete, you can verify that it created both the AWS Cloud9 environment and CodeCommit repository by visiting their respective browser-based consoles.</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: A CodeCommit Repo and Cloud9 Environment for Basic Development
Resources:
MyRepo:
Type: &quot;AWS::CodeCommit::Repository&quot;
Properties:
RepositoryName: MyRepo
RepositoryDescription: Sample Repo for Cloud9 CFN Post
MyC9Environment:
Type: &quot;AWS::Cloud9::EnvironmentEC2&quot;
Properties:
Repositories:
- PathComponent: /cfn
RepositoryUrl: !GetAtt MyRepo.CloneUrlHttp
InstanceType: t2.micro
SubnetId: subnet-be8735d6
AutomaticStopTimeMinutes: 45</code> 
<h5><strong>Figure 1. A CloudFormation template to create a Cloud9 environment and a CodeCommit repository.</strong></h5> 
<b><strong>More on AWS Cloud9</strong></b> 
<p>AWS Cloud9 is a versatile browser-based IDE. After you create your environment, you can operate your environment from typical MacOS, Linux and Windows machines, as well as from Chromebooks and tablets. This modern IDE provides multiple coding panes, as well as a command line pane, so you can switch from the editor to command line functions. As shown in Figure 2, I did some of the coding for this article on an iPad Pro, changing a few keyboard settings like splitting the keyboard so I can see both the editor and command line. I could also disable automatic capitalization, automatic word suggestions, and smart punctuation. As I do more iPad-based coding in the future, I’ll probably choose a more programmer-centric keyboard, like SmoothMobile’s <a href="https://itunes.apple.com/us/app/devkey-developer-keyboard-for-programming/id961304986?platform=ipad&amp;preserveScrollPosition=true#platform/ipad">DevKey</a>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/c9oniPad-1024x766.png" /></p> 
<h5><strong>Figure 2. The Cloud9 experience on an iPad.</strong></h5> 
<b><strong>Basic file editing</strong></b> 
<p>When you open your AWS Cloud9 environment, your EC2 instance has already been configured with the AWS CLI and a handful of other utilities, like Python versions 2 and 3, as well as Node 6. Also, the AWS CLI has been preconfigured with the required permissions to execute AWS commands. Finally, your local Git client automatically recognizes the repository you’ve just created, and clones it. Note that because it is a new repository, it will be empty.</p> 
<p>Assuming you’ve never used AWS Cloud9 or CodeCommit, now is a good time to create a simple file and add it to the repository. I’ll create a default markdown text file for the repository. After you navigate to your repository and open it in CodeCommit, it will automatically look for a <code class="lang-clike">README.md</code> file and render it, behaving in a similar way to Git repositories hosted on GitHub.</p> 
<p>The first time you open your AWS Cloud9 environment, it will prompt you to navigate to the (still empty) directory it cloned for your newly created repository. It will also advise you to set up your display name and email for your commits using the following commands:</p> 
<code class="lang-bash">git config --global user.name “YOUR_USER_NAME”
git config --global user.email YOUR_EMAIL_ADDRESS</code> 
<p>I’ll execute those two commands first.</p> 
<p>For this example, I’ll create a bare bones markdown file for my sample project, as shown in Figure 3. First, I navigated to the AWS Cloud9 console, found the environment I recently created, and opened it. Then, I leveraged a pre-packaged file template by choosing the <strong>File</strong> menu, then the <strong>New From Template</strong> submenu, then the <strong>Markdown</strong> template option from the resulting submenu. Notice that I also changed the default color theme for the IDE, and I changed the local Git configuration for my commits. In addition, I checked the versions for some of the pre-installed packages in the EC2 instance that AWS Cloud9 presents. I can also preview my markdown file in a separate pane with the Preview button. After I’ve added a few lines, I saved the file inside my repository folder (<code class="lang-bash">~/environment/cfn</code> in my example).</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/c9blogFig3-1024x731.png" /></p> 
<h5><strong>Figure 3. Editing a markdown file in Cloud9, previewing it, and checking versions on the instance.</strong></h5> 
<p>Now that I have a new local file in my repository folder, it’s time to commit it to my remote CodeCommit repository. After I changed directories to my local repository folder, I’ll enter the following sequence of commands:</p> 
<table style="height: 181px" width="808"> 
<tbody> 
<tr> 
<td><code class="lang-bash">git status</code></td> 
<td>Confirms any new files saved to my local repository</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git add –all</code></td> 
<td>Adds new files to my next commit</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git commit -m “message”</code></td> 
<td>Adds a helpful message context to my commit action</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git push -u origin master</code></td> 
<td>Sends the committed files to the (remote) repository</td> 
</tr> 
</tbody> 
</table> 
<p>To verify that everything works as I expected, go to the CodeCommit console and inspect your repository, which we named MyRepo in our template. The <code class="lang-bash">README.md</code> file we just created should be there, and it should be automatically rendered.</p> 
<b><strong>Using Python and AWS Boto3</strong></b> 
<p>In preparation for using Troposphere to generate CloudFormation code, I’ll make sure that I can create and run a Python program, and that I can use the AWS-provided Boto3 library to execute AWS API calls. You can find a fairly easy Python example as part of the Cloud9 documentation <a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/sample-python.html">here</a>. You’ll find that both Python 2 and 3 are already installed, so you can grab the sample code, save a new file in your instance and repository, and add a new Run Configuration to execute your code. The Run Configuration is handy to inject environment variables as you test your code, as well as to see the active standard output console for a long-running server process.</p> 
<p>In Figure 4, I’ve validated that I’m able to compose and run basic Python code in my environment. I created the file by choosing the <strong>File</strong> menu, then the <strong>New From Template</strong> submenu, then the <strong>Python File</strong> template option from the resulting submenu. When I paste the sample code into my editing pane, I get smart syntax highlighting as well. Note the command I entered in the <strong>Command:</strong> field on the Run pane on the bottom of the screen, and that it is running Python 2.</p> 
<p>Now that I’ve verified that I can edit and run Python programs in my environment, I’ll repeat the sequence of Git commands that I used for my earlier markdown file above, and move on to my next sample file.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/cloud9python-1024x760.png" /></p> 
<h5><strong>Figure 4. Running a basic Python program in AWS Cloud9.</strong></h5> 
<p>Next, let’s ensure we can call AWS APIs with the latest version of Boto3. From a terminal tab, enter the following command:</p> 
<p><code class="lang-bash">sudo python -m pip install boto3</code></p> 
<p>After it is installed, I’ll use the sample AWS SDK code from the previously mentioned documentation page for AWS Cloud9 and copy it into a new file. When creating the new file, I’ll use the <strong>File, New From Template, </strong>and<strong> Python File</strong> menu sequence as I did before, to ensure that I get proper syntax highlighting. Do this for all your language-specific code files and, in some cases, you’ll be able to leverage automatic suggestions as you type. Save your file and execute it in the existing Run Configuration tab. When you use a unique bucket name as the first runtime parameter, and a target Region as the second runtime parameter, the program uses Boto3 to list the current S3 buckets for the current user account. It also adds the new bucket, lists the buckets again, then deletes the newly-added bucket, and lists the buckets again showing that it successfully deleted it. See Figure 5.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/awsbotoapi.png" /></p> 
<h5><strong>Figure 5. Using AWS APIs in Python with Boto3.</strong></h5> 
<b><strong>Generating CloudFormation template code with Troposphere</strong></b> 
<p><a href="https://github.com/cloudtools/troposphere">Troposphere</a> is an open-source project that enables Python developers to use Boto3 to generate CloudFormation code in either JSON or YAML. Many AWS customers use it. Troposphere is a mature project, its repository provides many examples, and it allows you to use imperative language constructs like looping to generate template code. To add it to our environment, run the following command as you did when installing Boto3 before:</p> 
<p><code class="lang-bash">sudo python -m pip install troposphere[policy]</code></p> 
<p>Installing it with the policy option brings an additional project, which makes it easier to generate JSON for the AWS Access Policy Language, although is it not required for this example. To set up our example, first write the header for our template into a file called <code class="lang-bash">template.yaml</code>:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: A CFN Template</code> 
<p>With this file in hand, we’ll create a short Python program to loop through the generation of an EC2 instance three times. The code, which uses the installed Troposphere library, is listed in Figure 6.</p> 
<code class="lang-python">from troposphere import Ref, Template
import troposphere.ec2 as ec2
template = Template()
envs = ['dev', 'test', 'prod']
for x in envs:
instancename = x + &quot;Ec2&quot;
ec2_instance = template.add_resource(ec2.Instance(
instancename,
ImageId=&quot;ami-a7a242da&quot;,
InstanceType=&quot;t2.nano&quot;,
))
fh = open(&quot;template.yaml&quot;, &quot;a&quot;)
fh.writelines(template.to_yaml())
fh.close()
</code> 
<h5><strong>Figure 6. A sample Python file using Troposphere to generate a CloudFormation YAML code snippet.</strong></h5> 
<p>As it loops, the EC2 template instance name will be generated from a list of three items. This will have the effect of generating three instances each for <em>dev</em>, <em>test</em>, and <em>prod</em> environments. Then, we’ll append the generated YAML code into the <code class="lang-bash">template.yaml</code> header file we manually created earlier, although the header could also be generated in Python code as well. The sample code, as well as the resulting YAML file, are shown in Figure 7.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/trop-sample-1024x673.png" /></p> 
<h5><strong>Figure 7. A sample Python file using Troposphere to generate a CloudFormation YAML code snippet.</strong></h5> 
<p>The resulting YAML file is ready for us to use with CloudFormation. You can either list the file and copy and paste its contents to a local YAML file to upload to CloudFormation, or push it back to your CodeCommit repo and pick up the file from there.</p> 
<p><strong>Cleaning up</strong></p> 
<p>Now that the sample exercise is completed, I’ll clean up all the resources I’ve created. But first, I’ll probably want to keep the files in my CodeCommit repository for future reference. Since removing the initial stack will remove my AWS Cloud9 environment and CodeCommit repository, I’ll clone my repository locally so I can keep the files I’ve created. To do so, I’ll go to the <a href="https://console.aws.amazon.com/iam/">AWS IAM console</a> and create HTTPS Git credentials for my user account. You can find this option after you choose your user, then choose the <strong>Security Credentials</strong> tab. Scroll down, and choose the <strong>Generate</strong> button, as shown in Figure 8. Grab the resulting username and password, and clone your repository locally. To find the URL, open the CodeCommit console, select your repository, and choose the <strong>Connect</strong> button. This will give you the URL and the Git clone command to enter locally.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/git-credentials.png" /></p> 
<h5><strong>Figure 8. Generating Git credentials so you can copy the sample files from your repository to your local machine.</strong></h5> 
<p>After the files are copied down, go back to the CloudFormation console and delete the sample stack you created from the Troposphere-generated YAML code, as well as the stack that created your AWS Cloud9 environment and CodeCommit repository. You can delete both stacks in parallel since they don’t depend on each other. Also, note that the additional stack that was created to generate your Amazon EC2 instance will be removed as well.</p> 
<b><strong>Bonus Tip: Increasing your AWS Cloud9 storage space</strong></b> 
<p>While coding on your EC2-backed AWS Cloud9 instance, you may run out of the default 8GB storage space in your connected EBS volume. You can expand the space by following these steps:</p> 
<ol> 
<li>On the AWS Cloud9 IDE, switch to a bash terminal session, and enter the <code class="lang-bash">df -k</code> command. You should see the default 8GB disk size under the <code class="lang-bash">1K-blocks</code> column. This is the value you will change in this procedure.</li> 
<li>Close your Cloud9 session, then go to the EC2 console and stop the EC2 instance used by your environment. Its name should have the prefix “<code class="lang-bash">aws-cloud9-YourResourceName-0a0b…</code>”. In the template listed earlier, the prefix is “<code class="lang-bash">aws-cloud9-MyC9Environment-0a0b…</code>”.</li> 
<li>Wait until the instance state is displayed as <em>stopped</em>, and then choose <strong>Volumes</strong> from the Elastic Block Store submenu on the left side of the page.</li> 
<li>Choose your volume, and then choose <strong>Modify Volume</strong> from the Actions menu above the instance list.</li> 
<li>Enter a number larger than 8 in the <strong>Size</strong> field (for example, 16 corresponds to 16GB, which will double your storage).</li> 
<li>Choose the <strong>Modify</strong> button and accept the changes.</li> 
<li>Refresh the page a few times, and you will see the state of the volume changing to <strong><em>in-use – optimizing</em></strong>. Continue to refresh the page until the state of the volume changes to <strong><em>in-use – completed (100%)</em></strong>.</li> 
<li>Return to the AWS Cloud9 console, and choose <strong>Open IDE</strong> to start your environment. It will recognize that the instance is stopped, and it will restart the instance and connect to it.</li> 
<li>Run <code class="lang-bash">df -k</code> again to verify that the space is allocated. In the earlier example, you should see the 16GB size of your disk under the <code class="lang-bash">1K-blocks</code> column, and your <code class="lang-bash">Use %</code> should be updated to reflect the larger size.</li> 
</ol> 
<b><strong>Summary</strong></b> 
<p>Setting up a robust browser-based development environment with CloudFormation, AWS Cloud9, and CodeCommit is fast and easy. Using tools like Boto3 and Troposphere, you can use AWS SDK APIs and generate CloudFormation code in YAML from Python just as quickly. There are other ways to use high-level languages like Python to generate CloudFormation code. Other public projects target other languages like Ruby, JavaScript, and Go.</p> 
<p>Finally, I should note that we only covered a few of the features of AWS Cloud9 in this blog post. Using AWS Cloud9 you can edit remote files, enable live pair programming, and perform debugging with breakpoints, and show variable values as the program runs. You can clone additional repositories and work on multiple projects from a single AWS Cloud9 environment. There are many additional configuration options, accessible by using the Settings menu or by choosing the gear icon on the right edge of the top menu bar. For more information on AWS Cloud9 features, see the <a href="https://aws.amazon.com/documentation/cloud9/">AWS Cloud9 documentation</a>.</p> 
<p>I encourage you to experiment with other AWS Cloud9 features, as well as other projects that allow you to use high-level languages to author CloudFormation templates. It is likely that you’ll discover new ideas to help you improve your infrastructure code and your automation options.</p> 
<b>About the Author</b> 
<table style="height: 250px" width="1107" cellpadding="8"> 
<tbody> 
<tr> 
<td width="63">&nbsp;<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/picForBio-300x297.jpg" /></td> 
<td width="391"><strong>Luis Colon is a Senior Developer Advocate for the AWS CloudFormation team.</strong>&nbsp;He works with customers and internal development teams to focus on and improve the developer experience for CloudFormation users. In his spare time, he mixes progressive trance music.&nbsp;You can reach him via @luiscolon1 on Twitter.</td> 
</tr> 
</tbody> 
</table> 
<p>&nbsp;</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/09/Screen-Shot-2018-03-09-at-11.57.42-AM-1127x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">Distributing your AWS OpsWorks for Chef Automate infrastructure</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Nick Alteen</span></span> | on 
<time property="datePublished" datetime="2018-03-09T13:24:11+00:00">09 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-ops-works/" title="View all posts in AWS OpsWorks*"><span property="articleSection">AWS OpsWorks*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/distributing-your-aws-opsworks-for-chef-automate-infrastructure/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Organizations that manage many nodes over larger geographical AWS Regions may wish to reduce latency and load between nodes in their AWS OpsWorks for Chef Automate implementation. By distributing nodes between multiple servers, organizations encounter the challenge of how to ensure that cookbooks and other configurations are consistently deployed across two or more Chef Servers residing in one or more Regions. To accomplish this, customers can make use of several supplemental AWS services that will drive the process of distributing cookbooks to one or more Chef Automate instances.</p> 
<p><span id="more-2767"></span></p> 
<h3>Overview</h3> 
<p>One situation large-scale Chef users might run into is that the number of nodes managed by their OpsWorks for Chef Automate (OWCA) server exceeds its capacity. Customers can switch to a bigger Amazon EC2 instance by using their most recent backup, but this limit may be reached at some point. Additionally, latency in communications may be experienced in globally-distributed environments.</p> 
<p>This is easy to overcome by distributing management of nodes to multiple OpsWorks for Chef Automate instances. However, this approach introduces the challenge to synchronize cookbooks across multiple OWCA instances. This can be accomplished with the use of AWS CodeCommit, AWS CodeBuild, AWS CodePipeline, and optionally AWS Lambda. For this blog post, we will show you how customers can scale their Chef-managed infrastructure across two Regions.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/09/Screen-Shot-2018-03-09-at-11.57.42-AM-1024x572.png" /></p> 
<p>By using CodePipeline and CodeCommit, a cookbook developer simply has to push changes to a central repository. CodePipeline will trigger off this commit and send the updated repository contents to CodeBuild for processing. With simple scripting, CodeBuild will pull dependencies from Chef Supermarket, and upload the needed cookbooks to each Chef Automate instance in the account (or accounts). By using the chef-client cookbook, nodes will check in automatically on a pre-configured schedule. In this blog post, an Invoke stage in the pipeline can use AWS Lambda and AWS Systems Manager to run chef-client on any nodes in the environment. This step is optional, but useful for testing scenarios where it is helpful to deploy changes more rapidly.</p> 
<h3>Setup</h3> 
<p>To set this up, we use an AWS CloudFormation template. We will walk through each resource to be added to the template. Prior to doing so, at least one OpsWorks for Chef Automate instance must be created. The starter kit for each instance will contain a private key in the <code>[Starter-Kit]/.chef/</code> directory. Though this key can be used for authentication from CodeBuild, we recommend that you create a separate user in the Chef Automate console, and assign it a public/private key pair. Follow the <a title="undefined" href="https://docs.chef.io/delivery_users_and_roles.html" target="_blank" rel="noopener noreferrer">instructions on Chef.io</a> for reference. At minimum, this user account will require Committer permissions. The private key for this user can be saved in an Amazon S3 bucket in your account, which will be accessed by CodeBuild to authenticate with the Chef Automate server during the cookbook upload process. It’s important to ensure that access to this bucket is tightly controlled with appropriate bucket policies. An alternative to consider would be storing the keys in AWS Key Management Service (KMS).</p> 
<h3>Components</h3> 
<h4>Parameters</h4> 
<p>This template requires only one input parameter, <code>KeyBucket</code>, which corresponds to the Amazon S3 bucket that contains the private keys for each Chef Automate instance to be synchronized with this cookbook repository.</p> 
<code class="lang-json">{
&quot;Parameters&quot;: {
&quot;KeyBucket&quot;: {
&quot;Type&quot;: &quot;String&quot;,
&quot;Description&quot;: &quot;Name of S3 bucket which contains the OWCA private keys.&quot;,
&quot;AllowedPattern&quot;: &quot;^[a-z0-9][a-z0-9-.]*$&quot;,
&quot;MinLength&quot;: 3,
&quot;MaxLength&quot;: 63,
&quot;ConstraintDescription&quot;: &quot;Please provide a valid S3 bucket name.&quot;
}
}
}</code> 
<h4>IAM Permissions</h4> 
<p>Two AWS Identity and Access Management (IAM) roles will be needed for the pipeline to function correctly.</p> 
<p>The first IAM role, <code>BuildRole</code>, will be used by CodeBuild during build tasks, and will need the default permissions for CodeBuild containers. Additionally, the role will need access to the Amazon S3 bucket containing the private keys for authentication with each Chef Automate instance (referenced in the Parameters section of the template).</p> 
<p>The second IAM role, <code>FunctionRole</code>, will be used by AWS Lambda to execute <code>chef-client</code> on each instance in the environment. In addition to the Amazon CloudWatch Logs permissions required by Lambda execution roles, this role will require the ability to send commands via AWS Systems Manager.</p> 
<code class="lang-json">{
&nbsp;  &quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;  &nbsp; &quot;BuildRole&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;AssumeRolePolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Principal&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Service&quot;: [ &quot;codebuild.amazonaws.com&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;sts:AssumeRole&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Path&quot;: &quot;/&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Policies&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyName&quot;: &quot;CodeBuildS3WithCWL&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;PolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:Get*&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:List*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
{ &quot;Fn::GetAtt&quot;: [ &quot;ArtifactBucket&quot;, &quot;Arn&quot; ] },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Fn::GetAtt&quot;: [ &quot;ArtifactBucket&quot;, &quot;Arn&quot; ] },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:s3:::&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;KeyBucket&quot; }
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:s3:::&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;KeyBucket&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/codebuild/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/codebuild/*:*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogGroup&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;logs:CreateLogStream&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:PutLogEvents&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Resource&quot;: [ &quot;arn:aws:s3:::codepipeline-*&quot; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;s3:PutObject&quot;,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:GetObject&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:GetObjectVersion&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;ssm:GetParameters&quot; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Resource&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:ssm:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:parameter/CodeBuild/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp; }
&nbsp;&nbsp;    },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;FunctionRole&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;AssumeRolePolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Principal&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Service&quot;: [ &quot;lambda.amazonaws.com&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;sts:AssumeRole&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Path&quot;: &quot;/&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Policies&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyName&quot;: &quot;LambdaBasicExecutionWithSSM&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm:SendCommand&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm:GetCommandInvocation&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: &quot;*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogGroup&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogStream&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:PutLogEvents&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&quot;:log-group:/aws/lambda/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/lambda/*:*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;codepipeline:PutJobSuccessResult&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;codepipeline:PutJobFailureResult&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: &quot;*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;    }
}
}
}</code> 
<h4>Amazon S3 bucket</h4> 
<p>For use in CodePipeline to store artifacts, the <code>ArtifactBucket</code> resource is created and referenced when creating the pipeline itself.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;ArtifactBucket&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
}
}</code> 
<h4>CodeCommit repository</h4> 
<p>The CodeCommit repository being created will act as the Chef Repo to store cookbooks. The repository structure should adhere to the following format:</p> 
 .
├── .chef
│&nbsp;&nbsp; ├── knife.rb
│&nbsp;&nbsp; ├── ca_certs
│&nbsp;&nbsp; │&nbsp;&nbsp; └── opsworks-cm-ca-2016-root.pem
│&nbsp;&nbsp; └── [CHEF_SERVER_NAME]
│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── config.yml
├── Berksfile
├── buildspec.yml
└── cookbooks/ 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Repo&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::CodeCommit::Repository&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;RepositoryDescription&quot;: &quot;Cookbook repository for multiple region OWCA deployment.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;RepositoryName&quot;: &quot;owca-multi-region-repo&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>.chef</h4> 
<p>The <code>.chef/</code> directory structure is slightly different than what is normally included in the OpsWorks for Chef Automate starter kit. The modifications that follow will allow the knife utility to use environment variables when determining which Chef Automate instance to communicate with and which certificate file to use.</p> 
<p>The <code>knife.rb</code> file below uses the <code>yaml</code> gem to parse configuration data from <code>config.yml</code>. The correct configuration file is determined based on the value of the <code>CHEF_SERVER</code> environment variable.</p> 
<code class="lang-yaml">require 'yaml'
CHEF_SERVER = ENV['CHEF_SERVER'] || &quot;NONE&quot;
current_dir = File.dirname(__FILE__)
base_dir = File.join(File.dirname(File.expand_path(__FILE__)), '..')
env_config = YAML.load_file(&quot;#{current_dir}/#{CHEF_SERVER}/config.yml&quot;)
log_level&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :info
log_location&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STDOUT
node_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'pivotal'
client_key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;#{current_dir}/#{CHEF_SERVER}/private.pem&quot;
syntax_check_cache_path&nbsp; File.join(base_dir, '.chef', 'syntax_check_cache')
cookbook_path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [File.join(base_dir, 'cookbooks')]
chef_server_url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env_config[&quot;server&quot;]
ssl_ca_file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File.join(base_dir, '.chef', 'ca_certs', 'opsworks-cm-ca-2016-root.pem')
trusted_certs_dir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File.join(base_dir, '.chef', 'ca_certs')</code> 
<p>To determine the correct Chef Automate instance to communicate with, each instance should have its own directory underneath <code>.chef/</code>, corresponding to the name of the instance. Within this directory, the <code>config.yml</code> file must follow the below format.</p> 
server: 'https://[SERVER_FQDN]/organizations/default' 
<p>Currently, each Chef Automate instance directory does not contain the private key needed to communicate with the server. It is not recommended to include authentication information such as SSL/API keys or passwords within files committed to source control systems. Instead, steps have been added to the build process to include the needed keys from S3 instead.</p> 
<h4>Berksfile</h4> 
<p>Within the Berksfile, any cookbooks contained in the <code>cookbooks/</code> directory must be referenced in the format that follows. This will indicate to Berkshelf that the cookbook can be found within the local repository.</p> 
# Local Cookbooks
cookbook '[COOKBOOK_NAME]', path: 'cookbooks/[COOKBOOK_NAME]' 
<p>Cookbooks that are imported from Chef Supermarket can be included as normal.</p> 
source 'https://supermarket.chef.io'
# Supermarket Cookbooks
cookbook '[COOKBOOK_NAME]' 
<h4>buildspec.yml</h4> 
<p>The <code>buildspec.yml</code> file provides instructions to CodeBuild for downloading dependencies and uploading the cookbooks to each Chef Automate instance. To use the berks command, ChefDK must be installed during the build process. In this example the installation package is downloaded from Chef.io. Alternatively, ChefDK can be packaged and installed preemptively on a custom build environment to reduce build times. As shown in the following example, these are the major steps for the build process:</p> 
<ol> 
<li>Download and install ChefDK.</li> 
<li>Copy the private keys to authenticate to two Chef Automate instances from S3.</li> 
<li>Run <code>berks install</code> to download and install any dependencies.</li> 
<li>Upload cookbooks to both Chef Automate instances.</li> 
</ol> 
<code class="lang-yaml">version: 0.2
phases:
&nbsp;install:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;wget https://packages.chef.io/files/stable/chefdk/1.5.0/ubuntu/14.04/chefdk_1.5.0-1_amd64.deb&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;dpkg -i ./chefdk_1.5.0-1_amd64.deb&quot;
&nbsp;build:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;aws s3 cp s3://[KEY_BUCKET]/[CHEF_SERVER_1]/private.pem ./.chef/[CHEF_SERVER_1]/private.pem&quot;
&nbsp;&nbsp;&nbsp; &nbsp;- &quot;aws s3 cp s3://[KEY_BUCKET]/[CHEF_SERVER_2/private.pem ./.chef/[CHEF_SERVER_2]/private.pem&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_1] berks install&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_2] berks install&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_1] berks upload --no-ssl-verify&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_2] berks upload --no-ssl-verify&quot;
&nbsp;post_build:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;echo 'Complete'&quot;</code> 
<p>This build specification will be ingested by CodeBuild during the build stage of the pipeline.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;    &quot;BuildProject&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;Type&quot;: &quot;AWS::CodeBuild::Project&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Artifacts&quot;: { &quot;Type&quot;: &quot;CODEPIPELINE&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Description&quot;: &quot;Installs cookbook dependencies from Berksfile and uploads to one or more OWCA servers.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Environment&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;ComputeType&quot;: &quot;BUILD_GENERAL1_SMALL&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Image&quot;: &quot;aws/codebuild/ubuntu-base:14.04&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Type&quot;: &quot;LINUX_CONTAINER&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;ServiceRole&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;BuildRole&quot;, &quot;Arn&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Source&quot;: { &quot;Type&quot;: &quot;CODEPIPELINE&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>Lambda function</h4> 
<p>The Lambda function, <code>ChefClientFunction</code>, uses AWS Systems Manager via Boto3 to call sudo chef-client on a list of instances provided in the function code. The example below uses two instance IDs passed in a list. However, Boto3 can be leveraged further to generate lists of nodes by tags or other relevant properties. This is left as an exercise for the reader.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;ChefClientFunction&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::Lambda::Function&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Code&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ZipFile&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;\n&quot;, [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;from __future__ import print_function&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;import boto3&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm = boto3.client('ssm')&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;code_pipeline = boto3.client('codepipeline')&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;def lambda_handler(event,context):&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; job_id = event['CodePipeline.job']['id']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; try:&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = ssm.send_command(&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InstanceIds=[&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '[INSTANCE_ID_1]',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '[INSTANCE_ID_2]'&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DocumentName='AWS-RunShellScript',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Comment='chef-client',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Parameters={&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'commands': ['sudo chef-client']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command_id = response['Command']['CommandId']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('SSM Command ID: ' + command_id)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('Command Status: ' + response['Command']['Status'])&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Include monitoring of job success/failure as needed.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code_pipeline.put_job_success_result(jobId=job_id)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; except Exception as e:&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code_pipeline.put_job_failure_result(jobId=job_id, failureDetails={'message': e.message, 'type': 'JobFailed'})&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise e&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Description&quot;: &quot;Executes chef-client on specified nodes.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Handler&quot;: &quot;index.lambda_handler&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Role&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;FunctionRole&quot;, &quot;Arn&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Runtime&quot;: &quot;python2.7&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Timeout&quot;: &quot;10&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>Pipeline</h4> 
<p>Lastly, the Pipeline deployed will use each of the components to deploy a cookbook to both Chef Automate servers simultaneously.</p> 
<code class="lang-json">{
&nbsp;  &quot;Resources&quot;: {
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;OWCAPipeline&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::CodePipeline::Pipeline&quot;,
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ArtifactStore&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Location&quot;: { &quot;Ref&quot;: &quot;ArtifactBucket&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;S3&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;RoleArn&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;arn:aws:iam::&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;:role/AWS-CodePipeline-Service&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Stages&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Source&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;CodeCommit&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;BranchName&quot;: &quot;master&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;RepositoryName&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;Repo&quot;, &quot;Name&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;ChefRepo&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;OutputArtifacts&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Name&quot;: &quot;Cookbooks&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Source&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Build&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;CodeBuild&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ProjectName&quot;: { &quot;Ref&quot;: &quot;BuildProject&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;InputArtifacts&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Name&quot;: &quot;Cookbooks&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;Berkshelf&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Build&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Invoke&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;Lambda&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;FunctionName&quot;: { &quot;Ref&quot;: &quot;ChefClientFunction&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;LambdaChefClient&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Invoke&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h3>Summary</h3> 
<p>By distributing nodes across multiple OpsWorks for Chef Automate instances, the average workload per instance can be reduced, allowing management of considerably more instances as your infrastructure grows. Using several AWS services, it is a simple task to ensure consistency and ease of management of cookbooks across servers, Regions, and even AWS accounts.</p> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/12/28/internal-cdn.amazon.com_.jpeg" /></p> 
<p>Nick Alteen is a Lab Development Engineer at Amazon Web Services.&nbsp;In&nbsp;his role, he enjoys process automation and configuration management. Along with this, he supports customers on best practices and on-boarding OpsWorks services.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to create custom AWS Config rules with AWS CodeStar</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Greg Kim</span></span> | on 
<time property="datePublished" datetime="2018-03-09T07:44:40+00:00">09 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/developer-tools/aws-codestar/" title="View all posts in AWS CodeStar*"><span property="articleSection">AWS CodeStar*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-create-custom-aws-config-rules-with-aws-codestar/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>The <a href="https://aws.amazon.com/config/">AWS Config</a> rules feature enables you to define in code the desired configuration of your AWS resources. For example, you can check that your Amazon S3 buckets are not publicly accessible or that your instances are associated with a security group.</p> 
<p>While Config offers <a href="https://docs.aws.amazon.com/config/latest/developerguide/managed-rules-by-aws-config.html">a set of prebuilt (managed) rules</a> that represent common best practices, you may want to create custom rules to ensure that your AWS resources conform to your organization’s unique guidelines. You can define these guidelines in an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function that executes as your rule’s engine. For more information, see <a href="https://aws.amazon.com/blogs/aws/aws-config-rules-dynamic-compliance-checking-for-cloud-resources/">AWS Config Rules – Dynamic Compliance Checking for Cloud Resources</a>.</p> 
<p><a href="https://aws.amazon.com/codestar/">AWS CodeStar</a> is a centralized dashboard, from which you and your team can collaborate to develop, build, and deploy applications on AWS. AWS CodeStar includes project templates for common development platforms to enable provisioning of projects and resources for coding, building, testing, deploying, and running your software project.</p> 
<p>In order to make the process of authoring Config rules easier, AWS CodeStar recently announced support for AWS Config custom rule templates, which allow you and your team to work together to define and author the set of Config rules that fit your organization. You can then deploy the necessary resources so that you have a working Config Rule at the click of a button.</p> 
<p>In this blog, I show you how to author and create a custom Config rule using the AWS CodeStar end-to-end development experience.</p> 
<p><span id="more-2695"></span></p> 
<p><strong>Walkthrough</strong><br /> First, you need to record your AWS resources with Config. This means that Config records the configuration states of your resources whenever they are created or modified. Follow the steps in:</p> 
<li><a href="https://docs.aws.amazon.com/config/latest/developerguide/gs-console.html">Setting up AWS Config with the Console</a></li> 
<li><a href="https://docs.aws.amazon.com/config/latest/developerguide/gs-cli.html">Setting up AWS Config with the AWS CLI</a></li> 
<p>Now, get started creating your Config rule. For this example, you will write a rule to check that the S3 buckets in your account have versioning enabled. Luckily, this is already a managed rule, but for this example, pretend it isn’t.</p> 
<p>In the AWS CodeStar console, start a project with the Config rule project template, selecting either Python or Node.js to author your rule.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/project_templates-1.png" /></p> 
<p>This example will use&nbsp;Python, but the steps will be the same for Node.js.&nbsp;Click through until you get to the rule’s project dashboard. Use <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a> as the code repository and <a href="https://aws.amazon.com/cloud9/">AWS Cloud9</a> as the IDE. Here’s what the AWS CodeStar dashboard looks like upon arrival.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/codestar_dashboard-1.png" /></p> 
<p>The AWS CodeStar dashboard is a one-stop-shop for the entire development process for your Config rule. It has links to AWS Cloud9, CodeCommit, <a href="https://aws.amazon.com/codebuild/">AWS CodeBuild</a>, <a href="https://aws.amazon.com/codepipeline/">AWS CodePipeline</a>, and <a href="https://aws.amazon.com/codedeploy/">AWS CodeDeploy</a>, as well as the permissions to access this project and the resources that this project creates.</p> 
<p>First, open the link to the AWS Cloud9 IDE to author your rule.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/open_ide.png" /></p> 
<p>Inside the IDE, you see the project directory with the code for the example rule and the <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> template to be used create the Config rule and Lambda function for this project. The rule’s code is separated into two files:</p> 
<li>The rule_util file handles the API calls to report evaluations back to Config (you won’t need to modify this file).</li> 
<li>The rule_code file comprises the actual logic of the rule.</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rules_directory.png" /></p> 
<p>If you open up the rule_code file, you can modify the code to check if your S3 buckets have versioning enabled.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rule_code_change.png" /></p> 
<p>Modify the APPLICABLE_RESOURCES because you want this rule to only report evaluations for S3 buckets. Then, look in the <a href="https://docs.aws.amazon.com/config/latest/developerguide/config-concepts.html#config-items">Configuration Item</a> that was sent by Config to this Lambda function to check if versioning is enabled. If it isn’t, return that this resource is noncompliant with this rule.</p> 
<p>Now, make the necessary changes to your CloudFormation template.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/template_change.png" /></p> 
<p>Change the rule name to something more descriptive (like S3BucketVersioningEnabled), add a description for what the rule does, and change the scope of the rule to only apply to S3 buckets.</p> 
<p>That’s it. At this point, you’ve made all the code changes you need to have a Config rule that checks that your S3 buckets have versioning enabled. Push the change and watch it go through all the related services. The AWS Cloud9 IDE has a terminal window open where you can push the code directly to your CodeCommit repository.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/git_push.png" /></p> 
<p>Now, navigate back to the AWS CodeStar dashboard.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/commit_build_deploy.png" /></p> 
<p>Watch as the change is pushed into the CodeCommit repository. Afterwards, CodeBuild packages up the code that you wrote and stores it in an S3 bucket that was created by this AWS CodeStar project. Then, CodeDeploy takes that build from S3 and creates your Config rule backed by the Lambda function that you just wrote.</p> 
<p>Also accessible from the dashboard is a link to the Config rule console where you can see your rule in action.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rule_link.png" /></p> 
<p>You can see that the Config rule evaluated all of your S3 buckets. Three of them are noncompliant, meaning versioning wasn’t enabled.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rules_console.png" /></p> 
<p><strong>Conclusion</strong><br /> I hope this post has shown you how easy it is to use AWS CodeStar to create custom Config rules that verify the configurations of your AWS resources.</p> 
<p><strong>About the author:</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/07/badge_photo-150x150.jpg" /></p> 
<p>Greg Kim is an engineer on AWS Config. In his spare time, he likes to play basketball, eat, and enjoy the sun when Seattle is in a giving mood.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/001_arch_diagram.png" /> 
<b class="lb-b blog-post-title" property="name headline">Using AWS Systems Manager to run compliance scans using InSpec by Chef</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Maitreya Ranganath</span></span> | on 
<time property="datePublished" datetime="2018-03-07T10:16:28+00:00">07 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/using-aws-systems-manager-to-run-compliance-scans-using-inspec-by-chef/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>As described in the <a href="https://d1.awsstatic.com/whitepapers/architecture/AWS-Security-Pillar.pdf">Security Pillar </a>of the <a href="https://aws.amazon.com/architecture/well-architected/">AWS Well-Architected Framework</a>, the careful management of the security configurations of the running systems within your environment forms the foundation of how you will maintain robust, secure, scalable systems.</p> 
<p><a href="https://www.chef.io/inspec/">InSpec by Chef</a>, an open-source testing framework, provides teams the ability to define and assess system state and status across the entire application lifecycle. InSpec can already be used with AWS OpsWorks for Chef Automate to track the compliance of your infrastructure based on predefined policies. For example, you can describe compliance controls in InSpec and integrate these tests into any stage of your deployment pipeline or choose from a set of pre-packaged InSpec profiles. You can then use the Compliance pane as a unified dashboard to identify issues, remediate them, and track progress for various nodes and profiles.</p> 
<blockquote> 
<p><em>“According to the Chef User Survey 2017, 55% of organizations do compliance assessments incompletely or not at all,” says James Casey, Vice President of Partner Engineering and Integration at Chef. “Amazon Web Services and Chef help customers identify and automate compliance by using InSpec, part of Chef’s integration with AWS OpsWorks for Chef Automate. Now, customers have more options to use InSpec’s framework with the addition of InSpec availability through AWS Systems Manager.”</em></p> 
</blockquote> 
<p>In this blog post, I’ll focus on three features of AWS Systems Manager that can be used with InSpec:</p> 
<li><a href="https://aws.amazon.com/systems-manager/features/#Run_Command">Run Command</a>—Provides a simple way of running an ad hoc scan of your infrastructure using InSpec.</li> 
<li><a href="https://aws.amazon.com/systems-manager/features/#State_Manager">State Manager</a>—Allows you to execute InSpec tests on a schedule so that you can continuously assess the compliance of your systems.</li> 
<li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-compliance.html">Configuration Compliance</a> –Collects and aggregates information about InSpec test results.</li> 
<p><span id="more-2726"></span>I’ll use the newly defined Systems Manager Document <strong>AWS-RunInSpecChecks</strong> to run InSpec profiles that check the configuration of both Windows and Linux servers against a security baseline.</p> 
<p>Here’s an outline of the steps:</p> 
<ol> 
<li>Launch Systems Manager Managed Instances.</li> 
<li>Ensure you have an <a href="https://www.inspec.io/docs/reference/profiles/">InSpec Profile</a>. In this blog you will use predefined profiles from the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project on GitHub to check both Linux and Windows servers against a security baseline.</li> 
<li>Execute the InSpec tests using Run Command or State Manager. You don’t need InSpec installed your servers because the scripts will do that for you.</li> 
<li>View the results of your tests in Compliance.</li> 
</ol> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/001_arch_diagram.png" /></p> 
<b>Launch Managed Instances</b> 
<p>You need at least one <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/managed_instances.html">managed instance</a> that can act as a target of InSpec test execution. You can skip this step if you already have one or more Systems Manager managed instances in your AWS Account.</p> 
<p>Otherwise, you can launch an AWS CloudFormation stack that launches two Amazon EC2 instances, one Windows Server 2012 R2 Base and one Amazon Linux, to act as test managed instances. The stack also creates an IAM Role and Instance Profile with the AmazonEC2RoleforSSM managed policy.</p> 
<p>The following link launches the stack in the us-east-1 (N. Virginia) Region:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=SSM-InSpec&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm_inspec_test_servers.template"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/cloudformation-launch-stack.png" /></a></p> 
<p>The CloudFormation template requires the following parameters:</p> 
<li><strong>KeyPair</strong>: Choose an Amazon EC2 key pair from the list. Ensure that you have the private key corresponding to the key pair.</li> 
<li><strong>Subnet</strong>: Choose a subnet where the instances will be launched. Ensure that the subnet has outbound access to Internet addresses and to the Systems Manager API endpoints via an<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html"> Internet Gateway</a>, a <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html">NAT Gateway</a> or a <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-setting-up-vpc.html">VPC Endpoint for Systems Manager</a>.</li> 
<li><strong>VpcId</strong>: Choose the VPC for the subnet you chose in Subnet.</li> 
<p>The CloudFormation stack provides the following outputs:</p> 
<li><strong>LinuxServer</strong>: The EC2 instance ID of the Linux server.</li> 
<li><strong>WindowsServer</strong>: The EC2 instance ID of the Windows server.</li> 
<b>Create a Parameter to store your GitHub token</b> 
<p>You need a GitHub personal token to download InSpec profiles from GitHub. Follow the steps in <a href="https://github.com/join">Join GitHub</a> to create a GitHub account if you don’t already have one, <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/">create a token</a> and save the token in a secure location.</p> 
<p>You can use Parameter Store to store your GitHub personal access token using the <a href="https://aws.amazon.com/cli/">AWS CLI</a>:</p> 
aws ssm put-parameter --name 'github-personal-token' --description 'GitHub Personal Token' --type SecureString --value '&lt;value&gt;' 
<p>Or you can perform these steps using the Systems Manager console:</p> 
<ol> 
<li>In the AWS Management Console, navigate to the Systems Manager console. Choose <strong>Parameter Store</strong> from the left navigation pane. Then choose <strong>Create Parameter</strong>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/002.png" /></li> 
<li>For <strong>Name</strong>, type <strong>github-personal-token</strong>.</li> 
<li>For <strong>Description</strong>, type <strong>GitHub Personal Token</strong>.</li> 
<li>For <strong>Type</strong>, choose <strong>SecureString</strong> and accept the default KMS Key ID <strong>alias/aws/ssm</strong>.</li> 
<li>For <strong>Value</strong>, copy and paste the value of the GitHub personal token you saved earlier.</li> 
<li>Choose <strong>Create parameter</strong> to create the parameter.</li> 
</ol> 
<b>Execute InSpec tests on Windows Servers</b> 
<p>In this step, you’ll execute an InSpec Profile against a Windows server. An InSpec Profile organizes multiple controls to support dependency management and code reuse. Each profile is a standalone structure with its own distribution and execution flow.</p> 
<ol> 
<li>Log into the Systems Manager console and choose <strong>Run Command</strong> from the left navigation pane.</li> 
<li>Choose <strong>Run Command</strong>.</li> 
<li>In the search bar, choose to search by <strong>Document name prefix</strong>. Choose <strong>Equal</strong> as the condition and type <strong>AWS-Run</strong> as the prefix. From the list of Command documents, choose the document named <strong>AWS-RunInSpecChecks</strong>.</li> 
<li>Choose the Targets (either instances or tags). You can narrow the list to Windows servers in the search bar by choosing the filter <strong>Platform</strong> and choosing <strong>Windows</strong>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/003.png" /></li> 
<li>In the <strong>Command parameters</strong> section, choose <strong>Github</strong> as the <strong>Source Type</strong>. Type the following into the text area for <strong>Source Info</strong> to execute an InSpec profile that checks Windows servers against a <a href="https://github.com/dev-sec/windows-baseline">security baseline</a> defined by the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project on GitHub. {
&quot;owner&quot;:&quot;dev-sec&quot;,
&quot;repository&quot;:&quot;windows-baseline&quot;,
&quot;path&quot;: &quot;&quot;,
&quot;getOptions&quot; : &quot;branch:master&quot;,
&quot;tokenInfo&quot;:&quot;{{ssm-secure:github-personal-token}}&quot;
} <p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/004.png" /></p></li> 
<li>Accept the default values for the remaining parameters and choose <strong>Run</strong>.</li> 
<li>Refresh the Command status page until the status for the instances shown in the <strong>Targets and outputs list</strong> changes from <strong>In Progress</strong> to <strong>Success</strong>.</li> 
<li>Choose an instance ID from the list to see the output of the command run. Expand the steps shown on the <strong>Output</strong> page to view the command output.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/005.png" /></li> 
<li>Verify that the output of the runInSpecWindows step shows that the execution was successful and has a line showing the number of tests executed and the number that were compliant and non-compliant. Note that the scripts install the <a href="https://docs.chef.io/about_chefdk.html">Chef Development Kit</a> (chefdk), execute InSpec tests, and then uninstall chefdk. For example: Installing Chef Development Kit
Installing chefdk from C:\Windows\TEMP\chefdk-2.4.22-1-x64.msi
Executing InSpec tests
Completed InSpec checks and put 27 compliant (27 critical, 0 high, 0 low) and 47 non-compliant (39 critical, 0 high, 8 low) items
Uninstalling Chef Development Kit <p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/006.png" /></p></li> 
</ol> 
<b>View Compliance items</b> 
<p>In this step, you’ll view the results of the tests in Systems Manager Compliance.</p> 
<ol> 
<li>Log into the Systems Manager console and choose <strong>Explore Built-in insights</strong>.</li> 
<li>Choose <strong>Compliance</strong> from the navigation pane on the left.</li> 
<li>A summary of compliance items is shown as a chart, and the list of managed instances is displayed.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/007.png" /></li> 
<li>Choose a Managed Instance to view a list of compliance items of type Custom:InSpec that were created as a result of the InSpec tests executed. You can see that each item has a descriptive title, the compliance status: whether it is compliant (the test passed) or non-compliant (the test failed), and severity.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/008.png" /></li> 
</ol> 
<b>Execute InSpec tests on Linux servers</b> 
<p>To execute InSpec tests on Linux servers, follow the steps in the previous section, but choose one or more Linux servers in Step 4. In Step 6, type the following for Source Info to execute an InSpec profile that checks Linux servers against the <a href="https://github.com/dev-sec/ssh-baseline">SSH baseline</a> defined by the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project.</p> 
{
&quot;owner&quot;:&quot;dev-sec&quot;,
&quot;repository&quot;:&quot;ssh-baseline&quot;,
&quot;path&quot;: &quot;&quot;,
&quot;getOptions&quot; : &quot;branch:master&quot;,
&quot;tokenInfo&quot;:&quot;{{ssm-secure:github-personal-token}}&quot;
} 
<p>You can also choose to execute a sample cross-platform InSpec profile that checks for open SSH and RDP ports. Type the following for <strong>Source Info</strong> and chose a combination of Linux and Windows servers.</p> 
{
&quot;owner&quot;: &quot;awslabs&quot;,
&quot;repository&quot;: &quot;amazon-ssm&quot;,
&quot;path&quot;: &quot;Compliance/InSpec/PortCheck&quot;,
&quot;getOptions&quot;: &quot;branch:master&quot;,
&quot;tokenInfo&quot;: &quot;{{ssm-secure:github-personal-token}}&quot;
} 
<b>Conclusion</b> 
<p>In this blog post, I have shown how Systems Manager now lets you run compliance scans using InSpec by Chef. The walk-throughs used Run Command to execute individual tests. You can also create <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-state-assoc.html">State Manager Associations</a> to execute these tests on a schedule so that you can continuously assess the compliance of your systems.</p> 
<p>Visit the <a href="https://aws.amazon.com/systems-manager/">AWS Systems Manager</a> landing page to learn more and get started.</p> 
<b>Cleaning up</b> 
<p>If you launched instances using the CloudFormation template described earlier, you can delete those resources to avoid being charged for them going forward.</p> 
<ol> 
<li>In the CloudFormation console, choose the stack named <strong>SSM-InSpec</strong>, and from <strong>Actions</strong>, choose <strong>Delete Stack</strong>.</li> 
<li>Refresh the <strong>Events</strong> tab of the stack until the stack disappears from the stack list.</li> 
</ol> 
<h3></h3> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/07/author009-1.png" /></p> 
<p>&nbsp;</p> 
<p>Maitreya Ranganath is a Solutions Architect with the Enterprise team. He has a focus in Security and Compliance and enjoys helping customers architect secure, scalable, and cost-effective solutions on AWS.</p> 
<p>&nbsp;</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to develop custom AWS Config rules using the Rule Development Kit</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Michael Borchert</span></span> | on 
<time property="datePublished" datetime="2018-03-06T18:09:41+00:00">06 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-develop-custom-aws-config-rules-using-the-rule-development-kit/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>To help customers rapidly prototype, develop, and deploy their custom <a href="https://aws.amazon.com/config">AWS Config</a> rules at scale, AWS introduces a new version of the AWS Config Rule Development Kit (RDK).</p> 
<p>The RDK is a command-line utility designed to help you to shorten your security and compliance feedback cycles when using Config. It helps you build a continuous compliance framework that your auditors will love. It can be included in an end-to-end DevSecOps pipeline or used interactively from your command line to create and atomically deploy the Config, <a href="https://aws.amazon.com/lambda">AWS Lambda</a>, and <a href="https://aws.amazon.com/iam">IAM</a> resources necessary for your custom Config use case.</p> 
<p>In this post, I show you how to get started with the RDK.<span id="more-2669"></span></p> 
<b><strong>Background</strong></b> 
<p>Config is a native service for continuous compliance. It allows you to track the changes to resources and configurations (configuration items) in your account. You can define rules that detect when configuration items have drifted into undesirable territory.</p> 
<p>Config has a number of out-of-the-box rules that cover many the common use cases for customers. You can also create custom Config Rules backed by Lambda functions. Many enterprise customers or customers operating in highly regulated industries have special requirements that need specific definitions of compliant. I also see customers using the robust, serverless Config framework to build other housekeeping functionality such as cost and security controls.</p> 
<b>Getting Started</b> 
<p>The first steps are to make sure that you have the necessary permissions in your AWS account, and then you can install the tool itself.</p> 
<h3>Prerequisites</h3> 
<p>To get started, you need an AWS account, and necessary permissions for modifying Config rules, Lambda functions, and various IAM resources within that account. The <a href="https://github.com/awslabs/aws-config-rdk/blob/master/policy/rdk-minimum-permissions.json">rdk-minimum-permissions.json</a> sample policy document illustrates the required permissions.</p> 
<p>RDK allows you to author Lambda functions in almost all of the supported languages. It is itself written in Python, and is compatible with both Python 2.7 and 3.6. The recommended installation method is through pip (<code>pip install rdk</code>). To see the source code (or even contribute!), clone the GitHub aws-config-rdk repo.</p> 
<p>You can make sure that it is installed correctly by typing rdk at a command prompt. You should see usage instructions and an error about required arguments.</p> 
<code class="lang-bash">
(rdk-demo) 186590d1e043:rdk-demo USER $ rdk
usage: rdk [-h] [-p PROFILE] [-k ACCESS_KEY_ID] [-s SECRET_ACCESS_KEY]
[-r REGION]
&lt;command&gt; ...
rdk: error: the following arguments are required: &lt;command&gt;, 
&lt;command arguments&gt;
</code> 
<h3>Runtime-specific prerequisites</h3> 
<p>Config rules backed by Python and Node.js Lambda functions can be deployed without any additional setup. To use either the Java 8 or .NET Core runtimes, you need some additional components:</p> 
<li>Java: Use gradle to build your deployment package, so install it somewhere accessible from your CLI.</li> 
<li>.NET: Microsoft ships a CLI for .NET called “dotnet” that you need installed, as well as the latest release of the .NET Core framework v1.0. These are necessary to build and create Lambda deployment packages for your .NET code.</li> 
<p>&nbsp;</p> 
<b>Workflow</b> 
<p>Now that you have the RDK installed, walk through the steps to create, deploy, and manage your custom Config rules.</p> 
<h3>Set credentials</h3> 
<p>RDK uses the boto3 libraries for AWS API access, so any of the standard methods of passing credentials work. For more information about ways to supply your credentials, see options 3 through 8 in <a href="http://boto3.readthedocs.io/en/latest/guide/configuration.html">Credentials</a> in the Boto documentation. Alternately, you can pass them in with the following command-line parameters:</p> 
<li>–profile</li> 
<li>–region</li> 
<li>–access-key-id</li> 
<li>–secret-access-key</li> 
<p>&nbsp;</p> 
<h3>Initialize</h3> 
<p>Use <code>rdk init</code> to create a working directory. The working directory holds your rule definitions, as well as a snapshot of template files used to build your Config rules. Ideally, your working directory is a local code repo and python virtualenv, but it’s not necessary for just playing around. The <code>init</code> command also configures AWS Config in the account specified by your credentials. Config begins tracking information about your resources and their configurations.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk init
Running init!
Found Config Recorder: default
Found Config Role: arn:aws:iam::123456789012:role/config-role
Found Bucket: config-bucket-123456789012
Config Service is ON
Config setup complete.
Found code bucket: config-rule-code-bucket-123456789012us-west-2
</code> 
<p>&nbsp;</p> 
<h3>Create or modify</h3> 
<p>Now it’s time to create some rules!</p> 
<p>Use <code>rdk create &lt;rulename&gt; --runtime &lt;runtime&gt;</code> to create a local rule folder that contains your initial rule code, as well as some helper code and the parameters used to deploy the rule later. You need to specify a valid Lambda runtime. Optional flags include resource types for triggering on configuration change events, the frequency for scheduled evaluations, and any parameters that Config passes on to the backing Lambda function.</p> 
<p>To change rule parameters later on, you can use <code>rdk modify &lt;rulename&gt; --&lt;flag&gt; &lt;option&gt;</code> to overwrite any of the options that were previously set for your local rule definition.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk create MyTestRule --runtime python3.6 --resource-types AWS::EC2::Instance
Running create!
Defaulting to TwentyFour_Hours Maximum Frequency.
Local Rule files created.
</code> 
<h3>Edit</h3> 
<p>Navigate to the folder created by create and you see a number of files, depending on the runtime that you selected.</p> 
<p>Config rules backed by Python or Node.js Lambda functions have a .py or .js file named the same as your<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/19/file_structure.png" /> rule name, which is the code template to which to add your custom logic. There are other files associated with each runtime that provide necessary functions to validate inputs, submit compliance results back to Config, and handle errors and logging. You probably don’t need to worry about these.</p> 
<p>Go ahead and add whatever logic you want based on the CI, rule parameters, or any other data that your function should pull out of your AWS environment. Just make you return a valid compliance result. If you are writing your Lambda function in Java, make sure that you update the build.gradle file with any dependencies that you add.</p> 
<h3>Deploy</h3> 
<p>Now you’re ready to deploy your custom rule to AWS!</p> 
<p>From your working directory, use <code>rdk deploy &lt;rulename&gt;</code> to push your changes out to AWS. This uses AWS CloudFormation behind the scenes to build your Config rule, Lambda function. It also creates the necessary policies and permissions to let them talk to one another. You can list multiple rules to deploy, or use the <code>–all</code> flag to push all of the rules in your working directory. If you are using either Java or .NET, this also compiles your code and packages it appropriately for Lambda deployment.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk deploy MyTestRule
Running deploy!
Zipping MyTestRule
Uploading MyTestRule
Updating CloudFormation Stack for MyTestRule
Waiting for CloudFormation stack operation to complete...
Waiting for CloudFormation stack operation to complete...
Waiting for CloudFormation stack operation to complete...
Publishing Lambda code...
Lambda code updated.
Config deploy complete.
</code> 
<h3>Monitor</h3> 
<p>After your rule has successfully deployed, you’ll want to know what it’s actually doing!</p> 
<p>It can be useful to instrument your Lambda function with some logging so that you can have some debugging output about the decisions that your function is making. RDK provides a quick way to get a view into your function with the <code>logs</code> command. It has command-line arguments for how many log events to look back, and also supports the <code>–f</code> flag for continuously polling the log group for the specified function and returning results as they happen.</p> 
<p>The following is an example of the <code>logs</code> command:</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk logs MyTestRule/ -f
Removing trailing '/'
2018-02-13 10:55:03 - Tenancy is 'default' - returning COMPLIANT
2018-02-13 10:55:04 - END RequestId: 482e6306-1069-11e8-8696-8f2e469c4c56
2018-02-13 10:55:04 - REPORT RequestId: 482e6306-1069-11e8-8696-8f2e469c4c56&nbsp;&nbsp;&nbsp; Dura
tion: 325.81 ms&nbsp;&nbsp;&nbsp; Billed Duration: 400 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 30 MB
2018-02-13 10:55:04 - END RequestId: 480270e8-1069-11e8-b8de-65b91f7b7901
2018-02-13 10:55:04 - REPORT RequestId: 480270e8-1069-11e8-b8de-65b91f7b7901&nbsp;&nbsp;&nbsp; Dura
tion: 264.03 ms&nbsp;&nbsp;&nbsp; Billed Duration: 300 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 30 MB
2018-02-13 11:00:20 - START RequestId: 07029f1c-106a-11e8-921b-c7902649007e Version:
$LATEST
2018-02-13 11:00:20 - Tenancy is 'default' - returning COMPLIANT
2018-02-13 11:00:20 - END RequestId: 07029f1c-106a-11e8-921b-c7902649007e
2018-02-13 11:00:20 - REPORT RequestId: 07029f1c-106a-11e8-921b-c7902649007e&nbsp;&nbsp;&nbsp; Dura
tion: 272.61 ms&nbsp;&nbsp;&nbsp; Billed Duration: 300 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 31 MB
</code> 
<p>From the logs, make sure that your rule is functioning as expected. If you have a bug in your logic, iterate quickly by editing the rule code and re-deploying in seconds.</p> 
<p>After you’ve deployed your rule and verified that it’s working correctly, you can see your compliance status in the AWS Config console.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/19/screen_shot.png" /></p> 
<p>&nbsp;</p> 
<b>Conclusion</b> 
<p>I’m excited about the ways that the RDK can empower AWS customers to build world-class, enterprise-level compliance controls quickly and easily, leaving the heavy-lifting of the machinery and the framework to AWS Config.</p> 
<p>Config is a powerful component in a cloud-based, end-to-end security and compliance framework. Its ability to track changes over time is a great complement for Amazon CloudWatch Events, which gives you near-real-time responsiveness to individual API calls.</p> 
<p>To learn more about how these services can work together to provide a comprehensive “Compliance As Code” solution, check out the <a href="https://www.youtube.com/watch?v=VR_4209ewIo">Building the Largest Repo for Serverless Compliance-as-Code (SID205)</a> re:Invent 2017 session.</p> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/19/12fd317-cropped.jpg" />Michael Borchert is a Singapore-based Sr. Cloud Architect with AWS Professional Services. Michael enjoys helping AWS customers automate security, compliance, and development to accelerate all aspects of their cloud journey. In his free time he likes to play music and explore Southeast Asia with his family.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Recovering AWS CloudFormation stacks using ContinueUpdateRollback</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Casey Nishant</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:37:00+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/recovering-aws-cloudformation-stacks-using-continueupdaterollback/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS CloudFormation treats a stack as a collection of AWS resources that customers can manage as a single unit. After you launch a stack, you can use the AWS CloudFormation console, API, or AWS CLI to update resources in your stacks. You should not make any changes to stack resources outside of CloudFormation. This is due to something we call resource drift. Resource drift occurs when you make out-of-band changes to CloudFormation managed resources that can cause errors if you later update or delete the stack.</p> 
<p>This blog post walks you through examples of how to recover your stack from states such as <em>UPDATE_ROLLBACK_FAILED</em>. We show you how to regain control of the stack to perform further updates using CloudFormation without intervention from AWS Support.</p> 
<p><span id="more-2526"></span></p> 
<b><span style="text-decoration: underline"><a name="update_rollback_failed"></a>UPDATE_ROLLBACK_FAILED</span></b> 
<p>Out-of-band changes can easily occur when there are newcomers to your organization who make accidental changes to resources created by CloudFormation. These changes can also be made by members of different teams who might not have awareness of the service. Out-of-band changes can cause your CloudFormation stack to enter a state in which you are no longer able to continue modifying the stack. When a stack reaches UPDATE_ROLLBACK_FAILED, this means that the CloudFormation stack was attempting an UPDATE operation, the operation failed, and we began a rollback. An issue occurred that stopped CloudFormation from returning to the previous “good” state during the rollback. As a result, the stack can’t update and can’t roll back, thus it assumes this half-way state. The API then stops any further actions on the stack other than ContinueUpdateRollback and DeleteStack.</p> 
<b><a name="continueupdaterollback"></a>ContinueUpdateRollback</b> 
<p>The <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-continueupdaterollback.html">ContinueUpdateRollback API</a> operation provides customers an override for stacks in an UPDATE_ROLLBACK_FAILED state. It forces CloudFormation to continue with the rollback procedure. Use this operation only for troubleshooting. When a failure occurs and the stack enters an UPDATE_ROLLBACK_FAILED state, the API operation simply continues the rollback. However, it provides no fix to the underlying issue. For example, it doesn’t fix the underlying issue of whether a rollback failed due to an account limit. If you don’t address this account limit constraint, ContinueUpdateRollback will simply retry the rollback and fail once more. You still need to fix the underlying problem separately and, in a break from best-practices, outside of AWS CloudFormation.</p> 
<b>A practical example</b> 
<p>We’ll walk you through a scenario involving stacks entering the UPDATE_ROLLBACK_FAILED state and the use of the Auto Scaling service. Let’s take a look at a CloudFormation template.</p> 
<p><b>Note</b>: This template can be deployed in any Region as long as you specify a valid HVM-compatible Amazon Machine Image (AMI) on launch. Alternatively, to launch it <i>as-is</i> use the Europe (London) (eu-west-2) Region.</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.micro&quot;
</code> 
<p>As you can see, we create an Auto Scaling group with a launch configuration and our stack is created just as we expected.</p> 
<h3><a name="chaos-ensues"></a>Chaos ensues</h3> 
<p>To continue our hypothetical, let’s pretend that we hire Jimmy, a new member of the operations team fresh out his AWS Certified Solutions Architect Associate exam. One day, while you are not around, the development team asks him to decrease the size of the instance type for the Auto Scaling group. He decides it’s best to create a cool new launch configuration for the running the Auto Scaling group and assign the new launch configuration to the group:</p> 
<code class="lang-bash">aws autoscaling create-launch-configuration --launch-configuration-name Jimmys_new_LC --image-id ami-1a7f6d7e --instance-type t2.nano --region eu-west-2
ASName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id ASG --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling update-auto-scaling-group --auto-scaling-group-name $ASName --launch-configuration-name Jimmys_new_LC --region eu-west-2
</code> 
<p>Of course, he also decides to clean up the old Auto Scaling launch configuration for good measure:</p> 
<p>(For your ease of replication, I include the first line below to fetch the physical ID of the launch configuration created by the previous template.)</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling delete-launch-configuration --launch-configuration-name $LCName --region eu-west-2
</code> 
<p>Oh Jimmy, we had such high hopes…</p> 
<h3><a name="rollbacks-and-stabilization"></a>Rollbacks and stabilization</h3> 
<p>In the majority of my tests AWS CloudFormation attempts to fail fast. For example, if we were to add a HealthCheckType with an incorrect value, the initial API call would fail and the stack would roll back. However, because CloudFormation did not replace or successfully change the configuration of the target resource, it correctly assumes that no API call is necessary in order to roll back.</p> 
<p>A rollback can trigger a reapplication of a previous configuration after a period of time. CloudFormation refers to this as stabilization. CloudFormation performs an API call on behalf of a user, and in addition, it attempts to ensure that, when a resource is labeled as CREATE COMPLETE, the resource is running in the desired state. For Auto Scaling for example, it sends a CreateAutoScalingGroup API call and then attempts to DescribeAutoScalingGroup until the group has a Min/Max and Desired count equal to the count defined in the template. If this doesn’t occur, CloudFormation must then reapply the previous configuration.</p> 
<h3><a name="forcing-a-rollback"></a>Forcing a rollback</h3> 
<p>In our example, we could force this type of failure by increasing the Auto Scaling group’s capacity past our account limit for running On-Demand instances. This would in turn fail stabilization and trigger our rollback. At this point CloudFormation would be unable to find the previously defined launch configuration and the stack would then enter the UPDATE_ROLLBACK_FAILED state. However, this would involve launching a number of unused instances, which would not be very frugal. Instead, we can use the CloudFormation Wait Condition resource to simulate a failure and force a rollback.</p> 
<p>This is how we update the CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.large&quot;
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: ASG
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p class="FirstParagraph">As you can see, the template updates our launch configuration to use t2.large instances. However, because we never signal our WaitCondition, the stack will roll back. At this point CloudFormation will attempt to reapply the launch configuration. However, as we saw earlier, Jimmy deleted our launch configuration. So any update on the stack that updates the Auto Scaling group and triggers a rollback will fail.</p> 
<h3><a name="general-guidance-on-recovering-stuck-sta"></a>General guidance on recovering <i>stuck</i> stacks</h3> 
<p class="FirstParagraph">To address issues with CloudFormation stacks that have entered UPDATE_ROLLBACK_FAILED state you have three options:</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">1.<span style="font: 7.0pt 'Times New Roman'"><code> </code></span>Delete the stack. If the deletion fails for any reason, you can then use the DeleteStack API operation with the RetainResources option listing resources that failed deletion.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">2. Make underlying account changes manually/outside the scope of the stack to re-synchronize the stack with the expectation and then perform ContinueUpdateRollback.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">3. If you address the issues with the underlying stack resources you canuse ContinueUpdateRollback along with the ResourcesToSkip option. CloudFormation will mark the problematic/failing resources as UPDATE_COMPLETE and continue with the rest of the rollback.</p> 
<h3><a name="saving-the-day"></a>Saving the day</h3> 
<p>Now to address Jimmy’s mistake. With experience we know that CloudFormation relies on resource names or IDs to keep track of ownership. With launch configurations, we can see that the service uses a combination of the StackName, LogicalId, and a random string to name the launch configuration.</p> 
<p>What we can do is create a new launch configuration using the precise name of the previous one. We can grab that name by describing our stack as before then follow that up with a ContinueUpdateRollback:</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId`
aws autoscaling create-launch-configuration --launch-configuration-name $LCName --image-id ami-1a7f6d7e --instance-type t2.micro --region eu-west-2
aws cloudformation continue-update-rollback --stack-name &lt;stack-name&gt; --region eu-west-2
</code> 
<p class="FirstParagraph">Our stack should now be back to UPDATE_ROLLBACK_COMPLETE and ready for us to perform our update again.</p> 
<code class="lang-basg">aws cloudformation describe-stacks --stack-name &lt;stack-name&gt; --query Stacks[0].StackStatus –region eu-west-2
&quot;UPDATE_ROLLBACK_COMPLETE&quot;</code> 
<p class="FirstParagraph">In our example we forced the rollback by adding a never-completing WaitCondition. In your case the cause might be due to account limitations or other issues.</p> 
<b>When replacement is not an option</b> 
<p>In our example, we were left in the lucky situation in which you can replace the removed resource easily by naming a new resource the same name that your stack expects. Let’s take a look at a situation in which a resource was deleted that does not have a custom-name.</p> 
<p>Consider the following CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Please use your *default* VPC security group so that the steps that follow are successful&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
SecurityGroupIds:
- !Ref InstanceSecurityGroup
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>In this template we are creating an instance and a security group. Let’s pretend our old friend Jimmy was this time instructed to alter the EC2 instance and reference the default VPC security group:</p> 
<code class="lang-bash">defaultSecGroup=`aws ec2 describe-security-groups --group-name default --query SecurityGroups[0].GroupId --output text --region eu-west-2`
stackSecGroup=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id InstanceSecurityGroup --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
instance=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id Instance --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws ec2 modify-instance-attribute --instance-id $instance --group $defaultSecGroup --region eu-west-2
aws ec2 delete-security-group --group-id $stackSecGroup --region eu-west-2
</code> 
<p>And then, once again we update our stack with the failing wait condition to simulate a failure and initiate a rollback:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: Instance
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p>The stack is now in the UPDATE_ROLLBACK_FAILED state due to the ‘Instance’ resource being unable to rollback with an error like:</p> 
<p><em><strong>The security group ‘sg-xxxxxxxx’ does not exist</strong></em></p> 
<p>This time, to recover, because we can’t re-create sg-xxxxxxxx with the exact ID, we will have to continue the rollback and skip past the instance so that we can continue to modify the stack and regain a working and synced state.</p> 
<p>The first step is to perform continue-update-rollback skipping the resource:</p> 
<code class="lang-bash">aws cloudformation continue-update-rollback --resources-to-skip Instance --region eu-west-2</code> 
<p>The stack would now be in the UPDATE_ROLLBACK_COMPLETE state. However, the state of the stack no longer matches the state of the underlying resources. The instance, while still running, will have the default EC2 security group assigned to it by Jimmy instead of the security group we have defined here in the stack. To rectify this, we have to modify our template so that the instance is updated with a different security group ID. We can also remove the reference to the old, now deleted group from our template and use this as the new group for the instance:</p> 
<code class="lang-bash">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
SecurityGroupIds:
- InstanceSecurityGroup2
InstanceSecurityGroup2:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>Our stack should now be back in a state that is synchronized with the underlying resources and in a state that allows for further modifications down the line.</p> 
<b>Conclusion</b> 
<p>Throughout this blog, we learned about various CloudFormation concepts such as rollbacks, stabilization and using the ContinueUpdateRollback operation. We showed you two examples of using ContinueUpdateRollback to rescue a stack from a stuck state. In the first example we simply alter an underlying value then perform the API call. In the second example we have to skip past the problematic resource (due to the fact that it uses a unique ID instead of a user-defined value).</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/24/cnishant.jpeg" /></p> 
<p style="text-align: left"><a href="https://www.linkedin.com/in/nishantcasey">Nishant Casey</a> is a Cloud Support Engineer on the AWS Deployment team where he focuses on AWS CloudFormation and AWS Elastic Beanstalk. Nishant is passionate about Infrastructure as Code and DevOps. A gigging DJ and guitarist in a previous life, he enjoys music, as well as cooking, traveling, and video and board gaming.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Track Changes to Auto Scaling Groups Using AWS Config</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Varun Pole</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:04:27+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-changes-to-auto-scaling-groups-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for Auto Scaling groups. You can now track configuration changes in Auto Scaling groups, such as minimum, maximum, and desired capacities, termination policies, scaling policies, subnets, and instance protection settings.</p> 
<p>You can also use a new managed AWS Config rule to check whether the Auto Scaling groups associated with your load balancers are using the Elastic Load Balancing health checks to determine the health state of your Amazon EC2 instances.</p> 
<p>In this post, I describe two possible ways that you could track changes to Auto Scaling groups and evaluate compliance. I’ll walk you through each scenario.</p> 
<p><span id="more-2483"></span></p> 
<p><strong>AWS services</strong><br /> AWS Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p>An Auto Scaling group is a collection of EC2 instances, with similar configuration and characteristics, that are used for the purpose of scaling and management. These EC2 instances in the Auto Scaling group are treated as a logical group. You can configure the Auto Scaling group with the capacity that you want for instances required for the application to operate. You can configure the group with the minimum and maximum instances, depending on which instances Auto Scaling can launch or terminate based on dynamic scaling.</p> 
<p><strong>Example: Track configuration changes</strong></p> 
<p>Let’s consider a scenario where a customer notices an increase in his Amazon Elastic Compute Cloud (Amazon EC2) bill for a prior month. He notices that there are Amazon EC2 charges related to the use of an m4.xlarge instance type. The customer is confused because his applications have always used t2.micro instances, so he investigates further. He notices that when a scale out happens, the instances launched by the Auto Scaling group are of type m4.xlarge, instead of t2.micro. So it appears that the Auto Scaling launch configuration must have been modified.</p> 
<p>AWS Config can help you investigate in this scenario and determine if and when any configuration changes occurred on the Auto Scaling launch configuration, since it maintains a history of all configuration changes to the Auto Scaling group. We use the AWS Management Console in this scenario, but you can use the AWS CLI or SDKs as well.</p> 
<p>First, log in to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: AutoScaling Group</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling groups that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling group on the <strong>Resource inventory</strong> page.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1024x416.png" /></p> 
<p>Look at the <strong>Config timeline</strong> for the <strong>AS- APP1 – AS group</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1-1024x303.png" /></p> 
<p>The timeline shows you all configuration changes that were made after the Auto Scaling group was created.</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on the 31st August to the Auto Scaling group configuration, when the launch configuration was changed from AS-APP1-Launch config to AS-APPv2-Launch config.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-2.png" /></p> 
<p>Let’s open the EC2 console to check the Auto Scaling launch configurations. We can confirm that the instance type associated with the new launch configuration is m4.xlarge.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/AS-group-m4xlarge-1024x265.png" /></p> 
<p>&nbsp;</p> 
<p>Here is another example of tracking configuration changes using AWS Config. In this example, let’s assume that you are seeing performance degradations for applications hosted on your EC2 instances. Open the Amazon CloudWatch console. You can see spikes but are unable to understand why Auto Scaling did not dynamically scale out based on the CPU threshold scaling policy which was set to scale at 60 percent of average CPU.</p> 
<p>Go back to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: ScalingPolicy</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling Policies that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling policy on the <strong>Resource inventory</strong> page</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1.png" /></p> 
<p>Look at the Config timeline for Scale Group Size scaling policy. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/scaling-policy-changes-scale-1024x281.png" /></p> 
<p>&nbsp;</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on 4th September to the Scaling policy configuration, when the target value for Average CPU threshold was changed from 60 to 90 percent. This explains why the scale out did not happen as soon as the CPU spiked over 60 percent.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/Screen-Shot-2017-09-05-at-10.38.06-AM.jpg" /></p> 
<p>Using this information, you can fix these Auto Scaling configuration issues in the EC2 console.</p> 
<p>Another common scenario some customers have experienced is noticing too many instances in their account. This is because the instance termination policy has been enabled, which does not terminate your instances when the scale-in happens. This can be identified using the AWS Config service as well.</p> 
<p><strong>Example: Verify Heath Check using AWS Config rules</strong></p> 
<p>In addition to tracking the configuration of your Auto Scaling service, you can use AWS Config rules to check your Auto Scaling groups against best practices and internal policies.</p> 
<p>For example, use the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> to check whether your Auto Scaling groups that are associated with a load balancer are using Elastic Load Balancing health checks.</p> 
<p>Auto Scaling groups use Amazon EC2 health checks by default to determine the health of an instance. In situations where EC2 instances are running behind a load balancer, it’s beneficial to leverage the load balancer health checks for EC2 instances instead of Amazon EC2 health checks. This is because the load balancer health checks can determine the health of the application running on top of the EC2 instances, unlike the Amazon EC2 health checks.</p> 
<p>Here’s an example that shows how you can use AWS Config to troubleshoot a scenario where customers notice service errors or failures for the applications hosted on Amazon EC2 behind a load balancer even though the EC2 instance is healthy, reachable, and running.</p> 
<p>On the EC2 console, you can see that the EC2 instances healthy and running. But customers are still reporting errors while running your application. After some troubleshooting you determine that there are issues with the web service running on top of your EC2 instances. Elastic Load Balancing (ELB) load balancers have the capability to detect such failures via application-specific health checks and stop directing traffic to the affected EC2 instances. But since the Auto Scaling group isn’t configured to leverage the ELB health checks, customer requests are still hitting the unhealthy EC2 instances.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-instance-status.png" /></p> 
<p>AWS Config can help you identify Auto Scaling groups with this misconfiguration so that you can take corrective action. With the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> we can identify Auto Scaling groups that do not use ELB health checks. These resources are “non-compliant” as far as the AWS Config rule is concerned, as seen in the AWS Config console:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-nc.png" /></p> 
<p>Go to the EC2 console to change the health check type to ELB in the Auto Scaling group. When you return to the AWS Config console, you can see that the compliance status for the Auto Scaling group changes to the compliant state.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/ELB-hc-complaint-1024x291.png" /></p> 
<p>&nbsp;</p> 
<p><strong>Summary</strong><br /> With support for Auto Scaling in AWS Config, you can track configuration changes to your Auto Scaling groups and associated resource types. You can use the pre-built AWS Config rule or you can create custom rules to scan the configuration of these resources and verify compliance with best practices, internal guidelines, and regulatory requirements.</p> 
<hr /> 
<p><strong>About the Authors</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/3-150x150.jpg" />Varun Pole is a Solutions Architect at Amazon Web Services. He enjoys working with customers providing technical guidance and assist in architect and build solutions and help them make the best use of AWS services. In his free time, he enjoys traveling, cooking and photography.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture2-150x150.png" />Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and help them implement cloud security best practices. In his spare time, he enjoys hiking, reading and spending time with his kids.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to Track Configuration Changes to Classic Load Balancers Using AWS Config</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Parth Shah</span></span> | on 
<time property="datePublished" datetime="2018-02-12T23:24:29+00:00">12 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/networking-content-delivery/elastic-load-balancing/" title="View all posts in Elastic Load Balancing*"><span property="articleSection">Elastic Load Balancing*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/networking-content-delivery/" title="View all posts in Networking &amp; Content Delivery*"><span property="articleSection">Networking &amp; Content Delivery*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-configuration-changes-to-classic-load-balancers-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, AWS Config announced support for <a href="https://aws.amazon.com/elasticloadbalancing/">Classic Load Balancer</a> in all public regions and AWS GovCloud (US). You can now start tracking the current and historical configurations of your Classic Load Balancers, and get notified via&nbsp;<a href="https://aws.amazon.com/sns/">Amazon SNS</a> when your configurations change. You can also use three new managed AWS Config rules to verify whether your Classic Load Balancers are using SSL certificates provided by <a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a>, and whether the SSL listeners are using specific policies.</p> 
<p>Tracking configuration changes to your Classic Load Balancers is valuable from an operations perspective. You can use AWS Config to troubleshoot common operational issues with your Classic Load Balancers such as health check failures, connectivity issues, sticky session failures, SSL certificate issues, etc.</p> 
<p>In this post, I walk you through two possible use cases:</p> 
<ol> 
<li>Monitoring your Classic Load Balancer for configuration changes (two parts)</li> 
<li>Verifying whether the SSL certificate installed on your Classic Load Balancer is provided by AWS Certificate Manager (ACM).</li> 
</ol> 
<p><span id="more-1471"></span></p> 
<b>AWS services</b> 
<p><a href="https://aws.amazon.com/config/">AWS Config</a> enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against the configurations you want. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p><a href="https://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancing</a> offers two types of load balancers that both feature high availability, automatic scaling, and robust security. These include the Classic Load Balancer that routes traffic based on either application or network level information, and the Application Load Balancer that routes traffic based on advanced application-level information that includes the content of the request. The Classic Load Balancer is ideal for simple load balancing of traffic across multiple EC2 instances.</p> 
<p><a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a> is a service that lets you easily provision, manage, and deploy Secure Sockets Layer/Transport Layer Security (SSL/TLS) certificates for use with AWS services such as Elastic Load Balancing.</p> 
<b>Use case: Monitoring a Classic Load Balancer for configuration changes (Part 1)</b> 
<p>Your customers are reporting connectivity issues to your Classic Load Balancer. Here’s how you can use AWS Config to quickly identify the issues and minimize production downtime.</p> 
<p>For this example, a Classic Load Balancer is created with the following health check parameters and listener configurations:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture1-3.png" /></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture2-1.png" /></p> 
<p>In this configuration, your application is running on HTTP port 80. Now, imagine that someone accidentally updates the load balancer and sets the health check and listener ports to 8080. Because the application is not listening on port 8080, the health check fails and the EC2 instances behind the load balancer become unhealthy. Also, there would be connectivity issues because the load balancer is no longer listening on port 80. Until both of these changes are reverted, there would be an impact on production traffic.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture3.png" /></p> 
<p>AWS Config helps you troubleshoot these types of issues.</p> 
<ol> 
<li>Log in to the AWS Config console.</li> 
<li>For <strong>Resources</strong>, choose <strong>ElasticLoadBalancing:LoadBalancer</strong>.</li> 
<li>Choose <strong>Look up</strong> to see the list of Classic Load Balancers that AWS Config has automatically discovered in your account.</li> 
</ol> 
<p>The following screenshot shows an example Classic Load Balancer on the Resource inventory page:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture4.png" /></p> 
<p>Look at the Config timeline for the <strong>ProductionLB</strong>. The following screenshot shows the timeline and configuration details:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture5.png" /></p> 
<p>&nbsp;</p> 
<p>At the top, you see a timeline of all changes that have occurred to the load balancer after creation.</p> 
<p>You can see the configuration of the load balancer under <strong>Configuration Details</strong>. This includes the <strong>Amazon Resource Name (ARN), Resource ID, DNS name, </strong>and<strong> Listeners</strong>.</p> 
<p>In this scenario, there were <strong>3 changes</strong> on <strong>September 8th </strong>at<strong> 07:01:36 PM</strong>. You can drill down further to see what those changes were. The load balancer health check and listener ports were changed to 8080.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/10/Screen-Shot-2017-09-08-at-7.07.23-PM.png" />AWS Config also sends an SNS notification each time that a configuration change is detected, so that you can be alerted of changes to your Classic Load Balancers.</p> 
<b>Use case: Monitoring a Classic Load Balancer for configuration changes (Part 2)</b> 
<p>Your customers intermittently observe blank pages on your website. The session information is stored in the application running on the EC2 instances behind the load balancer. For this reason, you have enabled session stickiness on your load balancer, as seen in the following screenshot:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture7.png" /></p> 
<p>If someone accidentally disables the cross-zone load balancing, the load balancer would not forward requests to EC2 instances across Availability Zones. This breaks the session stickiness for your application and your customers observe intermittent blank pages on your website.</p> 
<p>You can track the configuration changes to your load balancer using AWS Config, as explained in the previous example. In this case, AWS Config shows that cross-zone load balancing was disabled. You can enable it again to fix the issue.</p> 
<b>Use case: Verifying the SSL certificate installed on a Classic Load Balancer</b> 
<p>In addition to tracking the configuration changes on your Classic Load Balancers, you can use AWS Config rules to check your Classic Load Balancers against best practices and internal policies.</p> 
<p>For example, you can use the prebuilt rule <strong>elb-acm-certificate-required</strong> to verify whether your Classic Load Balancers are using SSL certificates provided by ACM.</p> 
<p><strong>Note</strong>: ACM makes it easier to enable SSL/TLS for a website or application on AWS. ACM eliminates many of the manual processes previously associated with using SSL/TLS and managing SSL/TLS certificates. ACM can also help you avoid downtime due to misconfigured, revoked, or expired certificates by managing renewals. You get SSL/TLS protection and easy certificate management.</p> 
<p>The following illustration shows compliant and noncompliant states for this rule. The Classic Load Balancer that you created earlier is showing as noncompliant with this rule because it doesn’t have an SSL certificate installed using ACM.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture8.png" /></p> 
<p>After installing an SSL certificate provided by ACM, you can see that the compliance status changes to the compliant state.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/08/Picture9.png" /></p> 
<b>Additional AWS Config rules</b> 
<p>In addition to the managed Config rule described above, you can use the <strong>elb-predefined-security-policy-ssl-check</strong> and <strong>elb-custom-security-policy-ssl-check</strong> rules to verify that the SSL listeners on the Classic Load Balancer are using specific custom or predefined policies.</p> 
<b>Summary</b> 
<p>With support for Classic Load Balancers in AWS Config, you can now continuously track configuration changes such as health check parameters, listener configuration changes, sticky session configuration changes, and cross-zone load balancing. You can then use managed Config rules to evaluate these configuration changes against your desired configuration and verify your compliance with best practices.</p> 
<p>&nbsp;</p> 
<p>About the Authors</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture1-2-150x150.png" /></p> 
<p>Parth Shah is a Solutions Architect at Amazon Web Services. He enjoys working with customers in cloud adoption and business strategy as well as helping them design applications and services on AWS. Outside of work, he enjoys playing cricket, traveling, and spending time with his friends and family.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/11/Picture2-150x150.png" />Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and helping them implement cloud security best practices. In his spare time, he enjoys hiking, reading, and spending time with his kids.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/29/Social_AWS-Config_es-02.png" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Config: A Year in Review 2017</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Stas Neyman</span></span> | on 
<time property="datePublished" datetime="2018-02-12T08:00:00+00:00">12 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-config-a-year-in-review-2017/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>It’s been another exciting year for <a href="https://aws.amazon.com/config/">AWS Config</a>, a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. We have expanded our regional availability, added support for new resource types, introduced new managed Config rules, and introduced a dashboard view of your resource configuration and compliance. In this post, I recap some of this year’s announcements and provide links to additional resources.</p> 
<p><strong>Regional expansion:</strong> With the addition of the South America (S&atilde;o Paulo), Canada (Central), Asia Pacific (Mumbai), and Europe (London) Regions, AWS Config now supports Config rules in all 17 public AWS Regions and in AWS GovCloud (US). For the complete list of regions where Config and Config rules are available, see the AWS Config section under <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#awsconfig_region">AWS Regions and Endpoints</a>.</p> 
<p><strong>New resource types:</strong> We have added support for eight new services in 2017. You can now record configuration changes from the following:</p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-tracks-changes-to-aws-cloudformation-stacks/">AWS CloudFormation</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-classic-load-balancers/">Classic Load Balancers</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">AWS WAF</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">Amazon CloudFront</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/10/aws-config-adds-support-for-aws-codebuild/">AWS CodeBuild</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-auto-scaling-groups/">Auto Scaling groups</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-amazon-dynamodb-tables/">Amazon DynamoDB</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">Amazon CloudWatch</a></li> 
<p><strong>New managed rules:</strong> AWS Config allows you to enable rules to evaluate whether your AWS resources comply with common best practices. In 2017, we added support for nine new rules, bringing the <a href="https://docs.aws.amazon.com/config/latest/developerguide/managed-rules-by-aws-config.html">total to 47</a>. Two of the rules that we announced during the AWS NY Summit allow you to <a href="https://aws.amazon.com/blogs/mt/example-scenarios-for-aws-config-continuous-monitoring-of-amazon-s3-bucket-access-controls/">secure your Amazon S3 buckets</a>. The rules check your S3 buckets for unrestricted public write access or unrestricted public read access. They are backed by a new semantic-based automated reasoning engine, which returns a compliance decision.</p> 
<p><strong>Notable features:</strong> In 2017, we released <a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">ready-to-use AWS CloudFormation templates</a> for all managed rules and <a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">added support for a test mode</a> to check the functionality of custom Config rules. Using the test mode, you can safely check whether your custom Config rules are correctly reporting evaluation results for your resources without sending evaluation results to Config and incurring charges.</p> 
<p>We also <a href="https://aws.amazon.com/about-aws/whats-new/2017/07/introducing-aws-config-dashboard/">introduced an AWS Config dashboard</a> that allows you to view the total number of resources being recorded in your account and the count of resources by type to easily access the configuration history of a resource. With a Config dashboard, you can also quickly spot the number of resources that are non-compliant with your Config rules in each region, view the Config rules with the most non-compliant resources, and drill down to view the resources that are non-compliant with a particular Config rule.</p> 
<p>For the complete list of 2017 AWS Config announcements, see <a href="https://aws.amazon.com/config/release-notes/">What’s New from AWS Config</a>. To view Config documentation, click <a href="https://docs.aws.amazon.com/config/latest/developerguide/WhatIsConfig.html">here</a>.</p> 
<p>Individual announcements for the releases noted in this post are listed below.</p> 
<p><strong>Regional expansion:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-supports-rules-in-south-america-and-canada-regions/">AWS Config Supports Rules in South America (Sao Paulo) and Canada (Central) regions</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-rules-available-in-aws-govcloud-us/">AWS Config Rules Available in AWS GovCloud (US)</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/04/aws-config-supports-rules-in-asia-pacific-mumbai-region/">AWS Config Supports Rules in Asia Pacific (Mumbai) Region</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-available-in-europe-london-region/">AWS Config Rules Available in Europe (London) Region</a></li> 
<p><strong>New resource types:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-classic-load-balancers/">AWS Config Adds Support for Classic Load Balancers</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/aws-config-adds-support-for-aws-waf-and-amazon-cloudfront/">AWS Config Adds Support for AWS WAF and Amazon CloudFront</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/10/aws-config-adds-support-for-aws-codebuild/">AWS Config Adds Support for AWS CodeBuild</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-auto-scaling-groups/">AWS Config Adds Support for Auto Scaling Groups</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/09/aws-config-adds-support-for-amazon-dynamodb-tables/">AWS Config Adds Support for Amazon DynamoDB Tables</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/aws-config-tracks-changes-to-aws-cloudformation-stacks/">AWS Config Tracks Changes to AWS CloudFormation Stacks</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">AWS Config Supports Amazon CloudWatch Alarms and Additional Rules</a></li> 
<p><strong>New managed rules:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/08/aws-config-supports-new-managed-rules-for-securing-amazon-s3-buckets/">AWS Config Supports New Managed Rules for Securing Amazon S3 Buckets</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/06/aws-config-supports-amazon-cloudwatch-alarms-and-additional-rule/">AWS Config Supports Amazon CloudWatch Alarms and Additional Rules</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-supports-new-managed-rules/">AWS Config Rules Supports New Managed Rules</a></li> 
<p><strong>Notable features:</strong></p> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/07/introducing-aws-config-dashboard/">Introducing AWS Config Dashboard</a></li> 
<li><a href="https://aws.amazon.com/about-aws/whats-new/2017/02/aws-config-rules-adds-aws-cloudformation-templates-and-a-test-mode-for-rule-authoring/">AWS Config Rules Adds AWS CloudFormation Templates and a Test Mode for Rule Authoring</a></li> 
<p>The AWS Config team is excited about 2018 and is looking forward to continually adding new functionality. To learn more about Config features, see the <a href="https://aws.amazon.com/config/">AWS Config page</a>.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Centralized Management of Multiple Accounts and Cross-Platform EC2 Instances Using AWS Systems Manager</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Sohaib Tahir</span></span> | on 
<time property="datePublished" datetime="2018-02-06T15:24:46+00:00">06 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/centralized-management-of-multiple-accounts-and-cross-platform-ec2-instances-using-aws-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<h3><strong>Introduction</strong></h3> 
<p>Many AWS customers, particularly in the public sector, are implementing a central IT agency model. These organizations have an AWS account for central IT that is designated for the management of security and compliance activities such as patch management, use of golden Amazon Machine Images (AMIs), and federates user access for other agencies’ AWS accounts.</p> 
<p>In this blog post, I present a solution that will allow the AWS account for central IT to use AWS Systems Manager (SSM) to execute commands using Run Command and manage patches in the AWS accounts of other agencies. I’ll walk you through the steps for deploying this solution using AWS CloudFormation templates. We will create a Systems Manager Activation in the central account for registering Amazon EC2 instances as managed instances from the other agencies’ AWS accounts. We’ll also deploy AWS Lambda functions to propagate the EC2 tags into the Central IT account and attach them to the managed instances as Systems Manager tags. This way the tags can be used as targets for executing SSM Documents through Run Commands and for other Systems Manager features such as State Manager, Maintenance Windows, and Patch Management.</p> 
<p><span id="more-2227"></span></p> 
<p>These are the minimum requirements for implementing this solution:<br /> • Central IT account (or a parent account)<br /> • Agency account (or child accounts)<br /> • EC2 instance profile in the agency account<br /> • SSM agents and Boto3 library on EC2 instances</p> 
<p>The following diagram shows the system architecture:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/12/27/Blog_ssm_diag.png" /></p> 
<p>&nbsp;</p> 
<h3><strong>Implementation </strong></h3> 
<p><strong>Step one</strong><br /> First, we’ll create a managed instance activation in the central IT AWS account. This activation will be used to register both Windows and Linux EC2 instances from individual agency accounts. On activation creation, an activation ID along with activation code is returned. You need to store these in a text file, we’ll use them in later steps.</p> 
<p>For this blog post I’m providing a Python script for registering Amazon Linux-based EC2 instances from the agency account. You can easily write your own script for Windows or other operating system (OS) platforms.</p> 
<p><strong>Step two</strong><br /> Next, we’ll deploy SSM Agent on EC2 instances in all of the agency/child accounts that will be centrally managed through the activation created in the first step. Note that by default the EC2 instance registers to its own account’s Systems Manager after the agent is installed and started. The EC2 instance appears in the Systems Manager Shared Resources section in the appropriate AWS Region, in the Managed Instances tab.</p> 
<p><strong>Step three</strong><br /> Now we’ll create two parameters, ActivationID and ActivationCode, in the agency’s Systems Manager Parameter Store for the values we already have copied in a text file in step one. Our Python script that registers the EC2 instance to activation uses the values of these parameters for registration. You can use either the AWS Management Console, the API, or AWS CLI for creating the parameters. For the AWS CLI, use the following commands, which are documented in the&nbsp;CLI Command Reference.</p> 
<code class="lang-bash">aws ssm put-parameter --name &quot;ActivationID&quot; --type &quot;String&quot; --value &quot;xxxxxxxxxx&quot; --region &lt;AWS_region&gt;
aws ssm put-parameter --name &quot;ActivationCode&quot; --type &quot;String&quot; --value &quot;xxxxxxxxx&quot; --region &lt;AWS_region&gt;
</code> 
<p>&nbsp;</p> 
<p><strong>Step four</strong><br /> After the SSM Agent is installed, the EC2 instances need to be registered to the activation that we created in the first step. When the registration to an activation is complete, a managed instance ID is returned in the form mi-xxxxxxxxxxxxxxxx. This ID is attached to the instance since neither EC2 instance ID nor the EC2 tags are propagated to the Central IT account from the agency account through activation. We’ll use Lambda functions later to propagate all of the EC2 tags to the Central IT account from each agency account.</p> 
<p>The Python code that follows registers an Amazon Linux-based EC2 instance to an unexpired activation. The code requires the Boto 3 library to be pre-installed on the instance and an EC2 instance profile that has permissions to access Systems Manager Parameter Store and create EC2 tags.</p> 
<code class="lang-python">#!/usr/bin/python
import os
import urllib2
import json
import commands
import re
import boto3
from boto3 import session
instance_details = json.loads(urllib2.urlopen('http://169.254.169.254/2016-06-30/dynamic/instance-identity/document/').read())
instanceid=instance_details['instanceId']
REGION=instance_details['region']
# Getting the AWS credentials from the IAM role
session = session.Session()
credentials = session.get_credentials()
def Activation(InstanceID):
#Getting Activation ID and Code from parameter store
ssm = boto3.client('ssm',region_name=REGION)
activation_id = ssm.get_parameter(Name='ActivationID')
ActivationID=activation_id['Parameter']['Value']
activation_code = ssm.get_parameter(Name='ActivationCode')
ActivationCode=activation_code['Parameter']['Value']
# Registering Instance to Activation and storing ManagedInstanceID for tagging
status_stop_service, Output_stop_service =commands.getstatusoutput(&quot;sudo stop amazon-ssm-agent&quot;)
cmd=&quot;sudo amazon-ssm-agent -register -y -code %s -id %s -region %s&quot;%(ActivationCode,ActivationID,REGION)
status, output = commands.getstatusoutput(cmd)
m = re.search('(mi-)\w{17}',output.splitlines()[-1])
ManagedInstanceID=m.group(0)
if status==0:
status_start_service, Output_start_service =commands.getstatusoutput(&quot;sudo start amazon-ssm-agent&quot;)
print ManagedInstanceID
# Creating Tag for ManagedInstanceID tag
create_tags = ec2.create_tags(Resources=[str(InstanceID)],Tags=[{'Key':'managedinstanceid','Value':ManagedInstanceID}])
# Checking if Instance already has ManagedInstanceID Tag
ec2=boto3.client('ec2',region_name=REGION)
ec2_attached_tags = ec2.describe_instances(Filters=[{'Name': 'tag-key','Values': ['managedinstanceid']}],InstanceIds=[instanceid])
if not ec2_attached_tags['Reservations']:
Activation(instanceid)
else:
print &quot;Instance is already registered to an Activation/Account&quot;</code> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>IAM policy for the EC2 instance profile:</p> 
<p><code></code></p> 
<code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Action&quot;: [
&quot;ec2:CreateTags&quot;,
&quot;ec2:DescribeInstances&quot;
],
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;ssm:GetParameter&quot;
],
&quot;Resource&quot;: &quot;*&quot;
}
]
}
</code> 
 
<p><code></code></p> 
<p>&nbsp;</p> 
<p>Learn more about activation for different operating systems:</p> 
<li>Registering Windows instances to activation: <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-win">http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-win</a></li> 
<li>Registering Linux instances to activation:<br /> <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-linux">http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html#sysman-install-managed-linux</a></li> 
<p>Note that there is a limit of 1,000 instances per activation and activation expires after a maximum of 30 days. After activation expiry, new instances can’t be registered to it, but registered instances can continue to be managed.</p> 
<p><strong>Step five</strong><br /> After they are registered, the EC2 Instances in other accounts will appear in the EC2 console, in the Central IT account, Managed Instances section. They are identified by the same managed ID that was returned during activation process. This returned Managed ID is attached as an EC2 tag in the earlier Python code. A Lambda function, called Automation-EC2-Tags-Collector, copies the EC2 tags in the agency account to the Central IT account by invoking a second Lambda function, called Automation-SSM-Tag-Manager. The following CloudFormation template will deploy this Lambda function in agency accounts:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=Automation-EC2-Tags-Collector&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ec2-tag-collector.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p>The Automation-SSM-Tag-Manager Lambda function is deployed in the Central IT account so that it can accept the EC2 tags passed as an event by each agency’s Lambda function. Since each of the EC2 tags has the managed instance ID tag as well, it can used to map all the relevant EC2 tags propagated from agency accounts to the managed instances in in the central account. A maximum of 10 tags can be attached to a managed instance. Tags are critical to Systems Manager operation because they group resources together for applying and deploying Systems Manager functionalities such as Run Command, State Manager, Patch Manager, and Maintenance Windows.</p> 
<p>Use the following CloudFormation template to deploy Automation-SSM-Tag-Manager Central IT account:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=Automation-SSM-Tag-Manager&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ssm-tag-manager.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p>The Automation-EC2-Tags-Collector Lambda function should have permissions to invoke Automation-SSM-Tag-Manager. We’ll ensure this by deploying the following CloudFormation template. For parameters for adding permissions, you need to provide the agency account ID and the AWS Region into which the Automation-EC2-Tags-Collector is deployed.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new? stackName=AWS-Automation-SSM-Add-Agency&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/SSM/aws-automation-ssm-add-agency.yaml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/10/31/blog_westrich_5.png" /></a></p> 
<p><strong>Step six</strong><br /> After these CloudFormation templates are successfully deployed, you need to validate the instances appearing as managed instances in the central IT account along with the EC2 tags. Execute following AWS CLI command for the central IT account:</p> 
<code class="lang-bash">aws ssm list-tags-for-resource --resource-type “ManagedInstance” --resource-id &quot;&lt;managedinstanceID&gt;&quot; --region &lt;Activation_region&gt;
</code> 
<p>You can now use the propagated tags to execute Systems Manager documents or create Maintenance Windows. As an example you can execute the following Run Command on EC2 tag of “OS=Linux” as under:</p> 
<code class="lang-bash">aws ssm send-command --document-name &quot;AWS-RunShellScript&quot; –parameters commands=[&quot;ifconfig&quot;] --targets Key=tag:OS,Values=Linux --region &lt;your_SSM_region&gt;
</code> 
<h3><strong>Conclusion</strong></h3> 
<p>In this blog post I presented a Central IT solution for cross-account and cross-platform EC2 management using AWS Systems Manager and AWS Lambda. We created an Activation in the central IT account for registering agencies’ EC2 instances, we then deployed Lambda functions to import EC2 tags into the Central IT account for using them in implementing various EC2 SSM features. Using Systems Manager in Central IT provides you a variety of out-of-the-box features such as Patch Management, Maintenance Windows, Automation, and State Manager. These features can be used to enforce compliance and governance. Deploying this solution not only allows you to manage instances centrally but also to keep managing various OS platforms independently using the exported EC2 tags.</p> 
<p>&nbsp;</p> 
<p><strong>About the Author</strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/12/27/Phone_Tool_2-199x300.jpg" /></p> 
<p>Sohaib Tahir is a Solutions Architect for State and Local Government Public Sector Team. Sohaib has a focus in Networking and Automation, and loves to help customers in building architectures with automation services like AWS Systems Manager, AWS Lambda and Cloud-formation and Networking services including Amazon VPC and Direct Connect.</p> 
</article> 
<p>
© 2018 Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
