<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Management Tools Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="aws-blogs" class="layout-inner aws-blogs">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/09/Screen-Shot-2018-04-09-at-4.13.58-PM-917x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">Use AWS Service Catalog to build a custom catalog of products from AWS Marketplace</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Kanchan Waikar</span></span> | on 
<time property="datePublished" datetime="2018-04-10T09:49:04+00:00">10 APR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/artificial-intelligence/aws-deep-learning-amis/" title="View all posts in AWS Deep Learning AMIs*"><span property="articleSection">AWS Deep Learning AMIs*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/software/aws-marketplace/" title="View all posts in AWS Marketplace*"><span property="articleSection">AWS Marketplace*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-service-catalog/" title="View all posts in AWS Service Catalog*"><span property="articleSection">AWS Service Catalog*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/use-aws-service-catalog-to-build-a-custom-catalog-of-products-from-aws-marketplace/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
<p>Some AWS customers I work with have dedicated analytics/AI research teams who use AWS infrastructure to run their own code or use products from the AWS Marketplace to perform computations. Typically, the AI research team deploys multiple solutions. They bundle their own home-grown solutions into an AWS CloudFormation template along with some AWS Marketplace products, such as the <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html" target="_blank" rel="noopener noreferrer">AWS Deep Learning AMI</a>. You want to make it easy for your AI research team to deploy approved AI-based software packages. You can enable your AI research team to innovate while ensuring that governance is built into the process. You (or your procurement team) can procure the software that the research team needs from AWS Marketplace. You can ensure that data scientists can use a wizard to launch the AI software that you distribute to them.</p> 
<p>You can build a custom catalog of products from AWS Marketplace for different combinations of stakeholders, such as all or some users from a business unit, or a specific set of users attached to a federated role, or even a specific user. Use the <a href="https://aws.amazon.com/servicecatalog/" target="_blank" rel="noopener noreferrer">AWS Service Catalog</a> to create and manage custom catalogs of products that you approve for use in your organization. In addition to AWS Marketplace products, you can add your own AWS CloudFormation products to your custom catalog.</p> 
<b>Walkthrough: Using AWS Service Catalog to build your custom catalog of AMIs from AWS Marketplace</b> 
<p>In this blog post, I’ll show you how you can build a custom catalog of Amazon Machine Image (AMI)-based products procured from AWS Marketplace, using AWS Service Catalog.</p> 
<p>First I’ll walk you through a use case to show you how to build a custom catalog of software products. Let’s say that you want your AI Research team to use the free <a href="https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html" target="_blank" rel="noopener noreferrer">AWS Deep learning Marketplace AMI</a> instead of any other paid software. You recently noticed a few unauthorized AWS Marketplace software charges (due to unauthorized software launches by your AI Research team) on your AWS bill. So you want to build a catalog specifically for your AI research team to control what they can launch from AWS Marketplace.</p> 
<p>Before I get into how it works, let’s first review a few key AWS Service Catalog concepts:</p> 
<li>A <a href="http://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-product" target="_blank" rel="noopener noreferrer"><strong>product</strong></a> is a blueprint for building your AWS resources that you want to make available for deployment on AWS along with the configuration information. You create a product by importing a <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-whatis-concepts.html" target="_blank" rel="noopener noreferrer">CloudFormation template</a>, or, in case of AWS Marketplace-based products, by copying the product to the AWS Service Catalog. A product can belong to multiple portfolios. To know more about the product, see the AWS Service Catalog <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-product" target="_blank" rel="noopener noreferrer">documentation</a>.</li> 
<li>A&nbsp;<a href="http://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-portfolio" target="_blank" rel="noopener noreferrer"><strong>portfolio</strong></a>&nbsp;is a collection of&nbsp;<strong>products</strong>, together with the configuration information. You can use portfolios to manage the user access to specific products. You can grant portfolio access at an IAM user, IAM group, and IAM role level. To know more about the portfolio, see the AWS Service Catalog <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-portfolio" target="_blank" rel="noopener noreferrer">documentation</a>.</li> 
<li>A&nbsp;<a href="http://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-provprod" target="_blank" rel="noopener noreferrer"><strong>provisioned product</strong></a>&nbsp;is a <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html" target="_blank" rel="noopener noreferrer">CloudFormation stack</a> that is, the AWS resources that are created. When an <a href="http://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-users" target="_blank" rel="noopener noreferrer">end user</a> launches a product, the AWS Service Catalog provisions the product in form of a CloudFormation stack. To know more about the provisioned product, see the AWS Service Catalog <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-provprod" target="_blank" rel="noopener noreferrer">documentation</a>.</li> 
<li><a href="http://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-constraints" target="_blank" rel="noopener noreferrer"><strong>Constraints</strong></a>&nbsp;control the way users can deploy a product. With <strong>launch constraints</strong>, you can specify a role that the AWS Service Catalog can assume to launch a product from the portfolio. To know more about constraints, see the AWS Service Catalog <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/what-is_concepts.html#what-is_concepts-constraints" target="_blank" rel="noopener noreferrer">documentation</a>.</li> 
<p>The following solution diagram illustrates how you can build a catalog of AWS Marketplace products, using AWS Service Catalog in a single-account-based organization.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/09/Screen-Shot-2018-04-09-at-4.14.29-PM.png" /></p> 
<p>If your organization has multiple AWS accounts to manage, it is a best practice to set up a master/child account&nbsp;relationship to distribute the procured software in your organization. The master account is the central account in which you create (or copy) products, add them to portfolios, and from which you finally share portfolios with the child accounts. In a child account, you import portfolios from the master account and launch software. To learn more about the hub-and-spoke model, see AWS <a href="https://aws.amazon.com/blogs/mt/aws-service-catalog-hub-and-spoke-model-how-to-automate-the-deployment-and-management-of-service-catalog-to-many-accounts/" target="_blank" rel="noopener noreferrer">Service Catalog Hub and Spoke Model</a>. The following solution diagram illustrates how you can build a catalog of AWS Marketplace products, using AWS Service Catalog in a multi-account hub-and-spoke-model-based solution.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/09/Screen-Shot-2018-04-09-at-4.13.58-PM.png"></span><br /> <strong>Note</strong></p> 
<p>In each step, I’ve included specific instructions to follow if you want to distribute the AMI-based products in either the single- or multi-account model.</p> 
<p>Before you start building your custom catalog, terminate the unauthorized software.</p> 
<h3>Step 1: Revoke AWS Marketplace permissions and grant AWS Service Catalog permissions to your catalog users</h3> 
<ol> 
<li>&nbsp;To remove the AWS Marketplace subscription and AWS Marketplace-based AMI launch access from your IAM users, replace <code>Update_Your_Account_ID_here</code> with your account ID in the following example policy document and attach it with your team’s (In this case, &nbsp;the AI research team’s) IAM group or federated role. By associating this policy with your IAM users, you are denying them Run Instance permission for any AMI that is not owned by your account or Amazon (the Deep Learning Base AMI is owned by 898082745236). <code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [{
&quot;Sid&quot;: &quot;DenyAWSMarketplaceWriteAccess&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Action&quot;: [&quot;aws-marketplace:*&quot;],
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Sid&quot;: &quot;DenyMarketplaceAMIAccess&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Action&quot;: [&quot;ec2:RunInstances&quot;],
&quot;Resource&quot;: &quot;arn:aws:ec2:*::image/ami-*&quot;,
&quot;Condition&quot;: {
&quot;ForAnyValue:StringNotEquals&quot;: {
&quot;ec2:Owner&quot;: [
&quot;amazon&quot;,
&quot;self&quot;,
&quot;898082745236&quot;,
&quot;Update_Your_Account_ID_here&quot;
]
}
}
}
]
}</code> <p>To know more about how to create an IAM policy and attach it to a principal, see the documentation for:</p> 
<li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html#access_policies_create-start" target="_blank" rel="noopener noreferrer">Creating an IAM Policy.</a></li> 
<li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage-attach-detach.html#attach-managed-policy-console" target="_blank" rel="noopener noreferrer">Attaching IAM Policies.</a></li> 
</ul> <p><strong>Note</strong></p> <p>If you have created private AMIs from AWS Marketplace-based AMIs, you need to also attach a private paid-AMI-specific <strong>Deny-Effect</strong> policy for <strong>RunInstances-Action</strong> for your users. Here is an example of such policy that you can use after replacing <code>Update_Your_AMI_ID_Here</code> with your private paid AMI ID.</p> <code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [{
&quot;Sid&quot;: &quot;DenyPrivateAMIAccess&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Action&quot;: [&quot;ec2:RunInstances&quot;],
&quot;Resource&quot;: &quot;arn:aws:ec2:*::image/Update_Your_AMI_ID_Here&quot;
}]
}</code> </li> 
<li>Next, you need to allow the AI research team to launch the AWS Service Catalog product. To do so, attach the Amazon managed <strong>AWSServiceCatalogEndUserFullAccess</strong> policy with AI Research team. Next, your procurement team needs to subscribe to the AWS Marketplace AMI-based product that you want to distribute.</li> 
</ol> 
<h3>Step 2: Subscribe to AWS Marketplace AMI product you want to distribute</h3> 
<p><strong>Note</strong>: If you want to distribute the product using the hub-and-spoke model in your multi-account AWS setup, you need to do this step from both of the accounts—the child as well as the master account.</p> 
<p>In this case, your procurement team needs to subscribe to the AWS Deep Learning AMI from the AWS Marketplace console. To subscribe to the product:</p> 
<ol> 
<li>Sign-in to the AWS Management Console and then open AWS Marketplace console at <a href="https://aws.amazon.com/marketplace/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/marketplace/</a>.</li> 
<li>In the <strong>Search</strong> text box, type the product name (In this case,&nbsp;<code class="lang-markup">Deep Learning Base AMI (Amazon Linux)</code>), and press Enter.</li> 
<li>Choose the appropriate result from the search results.</li> 
<li>Choose <strong>Continue to Subscribe</strong>.</li> 
<li>The listing detail page will display three tabs with headers as <strong>1-click launch</strong>, <strong>Manual Launch</strong>, and <strong>Service Catalog</strong>. Choose the <strong>Service Catalog</strong> tab.<br /> <strong>Note</strong><br /> If the AWS Marketplace AMI product you want to distribute does not has the <strong>Service Catalog</strong> option in the AWS Marketplace listing detail page of the product, you can create a CloudFormation template and manually upload it as an AWS Service Catalog product. In this case, you need to skip <strong>Step 3</strong> and continue from <strong>Step 4</strong>. For more information, see <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_marketplace-products.html#catalogs_marketplace-manual" target="_blank" rel="noopener noreferrer">Managing and Adding AWS Marketplace Products Manually</a>.</li> 
<li>Since the Deep Learning Base AMI is sold by <strong>Amazon Web Services</strong>, it does not ask you to accept the software terms again. If your procurement team is procuring AMI based software sold by a vendor that is not <strong>Amazon Web Services</strong>, they need to choose <strong>Accept Software Terms</strong>. (They need to check with your organization’s legal department before choosing this button.)</li> 
</ol> 
<p>Next, you need to make the software product available for distribution in the AWS Service Catalog.</p> 
<h3>Step 3: Copy the software product to the AWS Service Catalog</h3> 
<p><strong>Note</strong>: If you want to distribute the product using the hub-and-spoke model in your multi-account AWS setup, you need to do this step from the master account.</p> 
<p>To make the software product available in the AWS Service Catalog, follow these steps:</p> 
<ol> 
<li>Browse to the product listing page by following the instructions in <strong>Step 2.1</strong> to <strong>Step 2.5</strong>.</li> 
<li>Select an appropriate AWS Region and a version in the <strong>Copy to Service Catalog</strong> panel and then choose <strong>Copy to Service Catalog</strong>.</li> 
<li>This will copy the <code>Deep Learning Base AMI (Amazon Linux)</code> product to the AWS Service Catalog in the selected Region.</li> 
</ol> 
<p><strong>Note</strong></p> 
<p>It is a best practice to standardize the AWS Marketplace-based AMI before you distribute the AMI to your business units. The standardization process involves hardening, Inspection, and validation of an AMI before distribution. To know more, see <a href="https://d1.awsstatic.com/whitepapers/aws-building-ami-factory-process-using-ec2-ssm-marketplace-and-service-catalog.pdf" target="_blank" rel="noopener noreferrer">Building a Secure, Approved AMI Factory Process Using Amazon EC2 Systems Manager (SSM), AWS Marketplace, and AWS Service Catalog</a>. (Note that subsequent to this whitepaper the service name changed from Amazon EC2 Systems Manager to AWS Systems Manager.)</p> 
<h3>Step 4: Create a portfolio to distribute the product to your IAM users</h3> 
<p><strong>Note</strong>: If you want to distribute the product using the hub-and-spoke model in your multi-account AWS setup, you need to do this step from the master account.</p> 
<p>Next, you need to <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-portfolio.html" target="_blank" rel="noopener noreferrer">create an AWS Service Catalog portfolio</a> with the name as <code class="lang-markup">AI Research Team Portfolio</code>. In this walkthrough, we will be naming our portfolio <code class="lang-markup">AI Research Team Portfolio</code>. After you have created a portfolio, add <code class="lang-markup">Deep Learning Base AMI (Amazon Linux)</code> to the <code class="lang-markup">AI Research Team Portfolio</code> that you created. (The product should become available in your catalog, after your procurement team chooses <strong>Copy to Service Catalog</strong> in <strong>Step 3</strong>.) To learn more about adding a product to a portfolio, see the documentation at <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_portfolios_adding-products.html" target="_blank" rel="noopener noreferrer">Adding Products to Portfolios</a>.</p> 
<p>If you have other CloudFormation templates to which you want to give the AI Research team access, you can do so by <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-product.html" target="_blank" rel="noopener noreferrer">uploading your CloudFormation template as a product</a> to the <code class="lang-markup">AI Research Team Portfolio</code>. After your portfolio is ready, you can distribute it to your end users.</p> 
<h3>Step 5: Distribute the catalog</h3> 
<p>Next, you need to grant the AI research team access to the portfolio. If you have a single AWS Account that the entire organization uses, you can grant the AI research team’s users access to the portfolio that you created in <strong>Step 4</strong>. Ensure that you have also associated the role/group selected, with the <strong>AWSServiceCatalogEndUserFullAccess</strong> policy, as suggested in <strong>Step 1</strong>. To know more about how to grant users access to the portfolio, see the documentation at <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-deploy.html" target="_blank" rel="noopener noreferrer">Grant End Users Access to the Portfolio</a>.</p> 
<p>If you want to distribute the product using the hub-and-spoke model, follow these steps:</p> 
<ol> 
<li>From the master account, <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_portfolios_sharing.html#catalogs_portfolios_sharing_how-to-share" target="_blank" rel="noopener noreferrer">share the portfolio</a> created with the child account. For more information on portfolio sharing, see <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_portfolios_sharing.html" target="_blank" rel="noopener noreferrer">Portfolio Sharing</a>. Next, you need to sign-in to the child account and then <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_portfolios_sharing.html#catalogs_portfolios_sharing_importing" target="_blank" rel="noopener noreferrer">import the portfolio</a> shared by the master.</li> 
<li>Next, <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-portfolio.html" target="_blank" rel="noopener noreferrer">create a local portfolio</a> in the child account and <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/catalogs_portfolios_adding-products.html" target="_blank" rel="noopener noreferrer">Add the product</a> imported from the master account’s AWS Service Catalog to the portfolio created in the preceding step.</li> 
<li><a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-deploy.html" target="_blank" rel="noopener noreferrer">Grant the AI research team access</a> to the local portfolio from the child account.</li> 
</ol> 
<p>You can also associate tags (for a cost center, a business unit, etc.), using the Tag Options feature, with a local portfolio to ensure that resources deployed from the portfolio have tags automatically associated with them. To know more about the Tag Options feature,&nbsp;see the <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/tagoptions-manage.html" target="_blank" rel="noopener noreferrer">documentation</a>.</p> 
<h3>Step 6: Create a launch constraint</h3> 
<p>Next, you create an AWS Service Catalog specific IAM role that will have permissions to create a CloudFormation stack and to launch an EC2 instance. You need to create the role in the account from which the AI research team would be launching an AMI instance. To create the role for the launch constraint, use the following policy document.</p> 
<code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [{
&quot;Sid&quot;: &quot;LaunchSCMPAMI&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;ec2:AuthorizeSecurityGroupEgress&quot;,
&quot;ec2:AuthorizeSecurityGroupIngress&quot;,
&quot;ec2:DeleteSecurityGroup&quot;,
&quot;ec2:TerminateInstances&quot;,
&quot;ec2:CreateSecurityGroup&quot;,
&quot;ec2:RunInstances&quot;,
&quot;ec2:createTags&quot;,
&quot;catalog-user:*&quot;,
&quot;cloudformation:CreateStack&quot;,
&quot;cloudformation:DeleteStack&quot;,
&quot;cloudformation:DescribeStackEvents&quot;,
&quot;cloudformation:DescribeStacks&quot;,
&quot;cloudformation:GetTemplateSummary&quot;,
&quot;cloudformation:SetStackPolicy&quot;,
&quot;cloudformation:ValidateTemplate&quot;,
&quot;cloudformation:UpdateStack&quot;,
&quot;ec2:describe*&quot;,
&quot;ec2:get*&quot;,
&quot;s3:GetObject&quot;,
&quot;sns:*&quot;
],
&quot;Resource&quot;: [
&quot;*&quot;
]
}]
}</code> 
<p>After you have created the role, you need to associate the role with the <code class="lang-markup">Deep Learning Base AMI (Amazon Linux)</code> product as a launch constraint inside <code class="lang-markup">AI Research Team Portfolio</code>. To know more about how to create a role and associate it as a launch constraint, see the documentation at <a href="https://docs.aws.amazon.com/servicecatalog/latest/adminguide/getstarted-launchconstraint.html" target="_blank" rel="noopener noreferrer">Add a Launch Constraint to Assign an IAM Role</a>.<br /> You will notice that this IAM-based service role has permission to launch any AMI if your account has subscribed to it. AWS Service Catalog assumes this role for launching the product that you specify, so you don’t need to provide these permissions to your IAM user. You might need to review and add additional permissions to the role you created if you are using the launch role to provision a more complex CloudFormation template.</p> 
<h3>Step 7: Test the solution</h3> 
<p>Finally, here is how you can test whether the AI research team can provision the Deep Learning AMI through the AWS Service Catalog:</p> 
<ol> 
<li>Sign-in to the AWS Management Console using AI research team’s IAM user and then open&nbsp;<a href="https://console.aws.amazon.com/servicecatalog/" target="_blank" rel="noopener noreferrer">https://console.aws.amazon.com/servicecatalog/</a>.</li> 
<li>In the&nbsp;<strong>Products</strong>&nbsp;section of the console, choose the&nbsp;<code class="lang-markup">Deep Learning Base AMI (Amazon Linux)</code>.</li> 
<li>Choose the&nbsp;<strong>Launch product</strong>&nbsp;to start the wizard for configuring your product.</li> 
<li>On the&nbsp;<strong>Product version</strong>&nbsp;page, for&nbsp;<strong>Name</strong>, type&nbsp;<strong>Deep-Learning-AMI</strong>, choose a version.</li> 
<li>Choose&nbsp;<strong>Next</strong>.</li> 
<li>Provide appropriate parameters on the parameters page.</li> 
<li>On the <strong>TagOptions</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Notifications</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Review page</strong>, choose <strong>Launch</strong>.<br /> <strong>Note</strong><br /> Before you choose <strong>Launch</strong>, ensure that the Launch role has the necessary permissions.</li> 
</ol> 
<p>The AI research team should be able to launch the <code class="lang-markup">Deep Learning Base AMI</code> through the AWS Service Catalog. If the AI Research team tries to&nbsp;<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launch-marketplace-console.html" target="_blank" rel="noopener noreferrer">launch an AWS Marketplace instance</a> of the <code class="lang-markup">Deep Learning Base AMI</code> using the EC2 console, the instance will not launch. Since the <code class="lang-markup">Deep Learning Base AMI</code> is owned by Amazon, the end user will be able to launch an instance of the AMI through the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface (CLI)</a> or <a href="https://aws.amazon.com/cloudformation/" target="_blank" rel="noopener noreferrer">AWS CloudFormation</a> if they have necessary permissions to run an EC2 instance. However, the users will not be able to launch any paid AMI that has owner attribute set as <code class="lang-markup">aws-marketplace</code>, through the CLI, CloudFormation, or through Amazon EC2 console.&nbsp; The only way to launch the instance would be through the AWS Service Catalog. This approach helps you tighten the security around your paid purchases.</p> 
<p>AWS Service Catalog recently released a feature called <a href="https://aws.amazon.com/about-aws/whats-new/2018/03/aws-service-catalog-announces-autotags-for-automatic-tagging-of-provisioned-resources/" target="_blank" rel="noopener noreferrer">AutoTags</a>. AutoTags are tags that identify the portfolio, product, and user that launched a product, and are automatically applied by the AWS Service Catalog to provisioned resources. AutoTags do not count towards your 50 Tags limit. AutoTags enable you to do following:</p> 
<ol> 
<li>Identify which <a title="undefined" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_principal.html" target="_blank" rel="noopener noreferrer">principal</a> (IAM user, federated user, or assumed-role user) launched the Service Catalog product. Since there is a one-to-one mapping between an AWS Marketplace product and a service catalog product, you can easily extract the information about the principal that launched the marketplace product.</li> 
<li>Which portfolio was the product launched from – This gives user an insight into the context behind the launch. If portfolios are created based on an Environment/Sprint and the paid-AMI product was distributed through multiple portfolios, the <code>Portfolio ID</code> Autotag would let user identify the context in which it was launched.</li> 
<li>Use <a title="undefined" href="https://docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/what-are-resource-groups.html" target="_blank" rel="noopener noreferrer">Resource Groups</a> to discover all AWS Service Catalog-based Marketplace AMI products launched by a specific principal.</li> 
</ol> 
<b>Conclusion</b> 
<p>AWS Service Catalog allows you to build custom catalogs to suit different business needs. It makes it easier to manage access of the paid (or custom) software products. This blog post demonstrates how you can build a catalog of products for organizations that are single-account-based as well as multi-account-based. With AWS Service Catalog, you can tighten the security around your paid AWS Marketplace AMI-based purchases while enabling their distribution in an organized manner.</p> 
<p>If you have questions about implementing the solution described in this post, you can start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=198" target="_blank" rel="noopener noreferrer">AWS Service Catalog Forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Amazon CloudWatch Metric Math simplifies near real-time monitoring of your Amazon EFS file systems and more</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Mike Anand</span></span> | on 
<time property="datePublished" datetime="2018-04-04T14:37:38+00:00">04 APR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/amazon-cloudwatch-metric-math-simplifies-near-real-time-monitoring-of-your-amazon-efs-file-systems-and-more/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
<p><em>This blog was contributed by Helen Lin, Sr. Product Manager for Amazon&nbsp;CloudWatch and Darryl S. Osborne,&nbsp; Storage Specialist Solutions Architect</em></p> 
<p>Today, we’re releasing a new feature in <a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="noopener noreferrer">Amazon CloudWatch</a> called <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html" target="_blank" rel="noopener noreferrer">Metric Math</a> that makes it easy to perform math analytics on your metrics to derive additional insights into the health and performance of your AWS resources and applications. As you may already know, CloudWatch is a monitoring solution for both your AWS resources and on-premises devices, providing <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CW_Support_For_AWS.html" target="_blank" rel="noopener noreferrer">default metrics</a> for the AWS services you use while enabling you to also monitor <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html" target="_blank" rel="noopener noreferrer">custom application metrics</a> or <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Install-CloudWatch-Agent.html" target="_blank" rel="noopener noreferrer">system metrics</a>.</p> 
<p>With CloudWatch Metric Math, you can now easily convert your CloudWatch metrics such as count of errors or database total IO bytes to metrics that give you a sense of scale and speed, like IOPS, throughput, and percent error rate metrics. In addition to rate and throughput metrics, you can also aggregate individual resource metrics into a cluster or fleet-wide view by using functions as such SUM on a group of metrics. Metric Math supports simple mathematical operations such as addition, subtraction and functions such as SUM, ABSOLUTE, STANDARD DEVIATION, and more. For sparse metrics that publish values at irregular intervals, such as HTTP error counts, you can use a FILL function to fill in default values such as zeros for empty values to make the metric easier to perform math on or to graph. You can create these metric math expressions directly in the <a href="https://console.aws.amazon.com/cloudwatch/home" target="_blank" rel="noopener noreferrer">CloudWatch console</a> or by using the new <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html" target="_blank" rel="noopener noreferrer">GetMetricData API</a> operation which allows for both metric math retrieval and bulk metric retrievals.</p> 
<p><strong><u>Using Metric Math for Amazon EFS Metrics</u></strong></p> 
<p>To show you how Metric Math can be used for operational monitoring, let’s dive deep into a specific example using Metric Math to simplify monitoring your <a href="https://aws.amazon.com/efs/" target="_blank" rel="noopener noreferrer">Amazon EFS</a> file systems’ performance. The best way to understand the workload your file system serves is by monitoring the metrics Amazon CloudWatch collects and processes. By monitoring the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/efs-metricscollected.html" target="_blank" rel="noopener noreferrer">EFS CloudWatch metrics</a> TotalIOBytes, DataWriteIOBytes, DataReadIOBytes, and MetaDataIOBytes in the CloudWatch console, you can see your file system performance in near real-time. These metrics are sent to CloudWatch at one-minute intervals and are available for the next 15 months, so you can access historical information about the workload that has run on your file system over time. The different IOBytes metrics give you the number of bytes for each file system operation (e.g., data read, data write, metadata, and total). To know the throughput of the different file system operations, you need to perform a math calculation on these metrics. For example, in order to know the total throughput of your file system, you take the sum statistic of the TotalIOBytes metric and divide by the number of seconds in the period. If you’re like me, you have a hard time doing calculations like this in your head as you’re monitoring the CloudWatch console in real-time. We no longer have to worry about this because Metric Math solves this problem for us. With Metric Math, you add an expression to a graph or line widget, and it does the calculation for you in real time.</p> 
<p>Here’s an example of how I calculate total throughput using both the old way, and now the new way with Metric Math.</p> 
<p>I open the <a href="https://console.aws.amazon.com/cloudwatch/home" target="_blank" rel="noopener noreferrer">Amazon CloudWatch console</a>, enter my file system ID in the browse field, and press <strong>Enter</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture1.png" />I choose <strong>EFS &gt; File System Metrics</strong> then select the check box next to the <strong>TotalIOBytes</strong> metric name.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture2.png" /></p> 
<p>I choose the <strong>Graphed metrics</strong> tab and change the <strong>Statistic</strong> of the <strong>TotalIOBytes</strong> metric to <strong>Sum</strong> and <strong>Period</strong> to <strong>1 Minute</strong>. I click+hold+drag over an area of the graph I want to zoom in to, then hover the pointer over a data point I want to view.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture3.png" /></p> 
<p><strong>Old way:</strong></p> 
<p>I used to have to manually calculate the total throughput of the value displayed, 15.0G.</p> 
<p>Total throughput (MiB/s) = ( Sum(TotalIOBytes) &divide; 1048576(to convert to MiB) ) &divide; seconds in the period</p> 
<p>Total throughput (MiB/s) = ( 15,000,000,000 &divide; 1048576 ) &divide; 60 = 238.419 MiB/s</p> 
<p><strong>Metric Math:</strong></p> 
<p>Now I use CloudWatch Metric Math to do the calculation just once for the entire graph. I can also add this graph to a dashboard and refer back to it at a later time.</p> 
<p>First, I choose <strong>Add a math expression</strong> and a new expression line is displayed.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture4.png" /></p> 
<p>I optionally add the label <strong>Total Throughput (MiB/s)</strong> to make it easier for me to remember what the metric represents and enter the math expression in the <strong>Details</strong> field. This calculation takes the metric Id <strong>m1</strong>, which is the sum of <strong>TotalIOBytes</strong> for 1 minute, converts it to MiB by dividing by <strong>1048576</strong>, then divides by the number of seconds in the <strong>PERIOD</strong> of metric Id <strong>m1</strong>. I unselect the check box of the <strong>m1</strong> (<strong>EFS *</strong> <strong>TotalIOBytes…</strong>) metric so it doesn’t display in the graph. Now I have all the data points in this time series displaying total throughput in MiB/s.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture5.png" /></p> 
<p>I could use these same steps and create expressions to calculate data read throughput, data write throughput, and metadata throughput, and have all my throughput metrics displayed as MiB/s on this same graph.</p> 
<p>The following are some file system metrics you could calculate using Metric Math.</p> 
<li>Total throughput (MiB/s)</li> 
<li>Metadata throughput (MiB/s)</li> 
<li>Data read throughput (MiB/s)</li> 
<li>Data write throughput (MiB/s)</li> 
<li>Available throughput (MiB/s)</li> 
<li>Percent metadata throughput (%)</li> 
<li>Percent data read throughput (%)</li> 
<li>Percent data write throughput (%)</li> 
<li>Total IOPS</li> 
<li>Metadata IOPS</li> 
<li>Data Read IOPS</li> 
<li>Data Write IOPS</li> 
<li>Percent metadata IOPS (%)</li> 
<li>Percent data read IOPS (%)</li> 
<li>Percent data write IOPS (%)</li> 
<li>Average total IO size (KiB)</li> 
<li>Average read IO size (KiB)</li> 
<li>Average write IO size (KiB)</li> 
<p>You can also use this <a href="https://github.com/aws-samples/amazon-efs-tutorial/" target="_blank" rel="noopener noreferrer">CloudFormation template</a> that I created to build your CloudWatch Dashboard which includes these EFS metrics.</p> 
<p><strong><u>Using Metric Math for other Amazon CloudWatch Metrics</u></strong></p> 
<p>Metric Math is also useful for deriving new operational insights for other my Amazon resources. For example, I can calculate fault rates for my <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/elb-metricscollected.html" target="_blank" rel="noopener noreferrer">Elastic Load Balancing</a> load balancers by creating this math expression in the CloudWatch console (using the Sum statistic):</p> 
<p>Fault Rate = 100 * HTTPCode_Target_5xx_Count &divide; Request_Count</p> 
<p>Or percent error invocations for my <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/lam-metricscollected.html" target="_blank" rel="noopener noreferrer">AWS Lambda</a> functions:</p> 
<p>% Error Rate = Errors &divide; Invocations</p> 
<p>I also find it useful to monitor my <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/dynamo-metricscollected.html" target="_blank" rel="noopener noreferrer">Amazon DynamoDB</a> tables with a % capacity utilization metric, such as:</p> 
<p style="padding-left: 30px">% Read Capacity Utilization = 100 * ConsumedReadCapacityUnits &divide; ProvisionedReadCapacityUnits</p> 
<p>&nbsp; &nbsp; &nbsp; &nbsp; % Write Capacity Utilization = 100 * ConsumedWriteCapacityUnits &divide; ProvisionedWriteCapacityUnits</p> 
<p>To calculate the consumed read and write throughput, I take the Consumed Read and Write Capacity Units and divide that by the total number of seconds in that period, which I can use the PERIOD function to automatically calculate:</p> 
<p style="padding-left: 30px">Consumed Read Throughput = ConsumedReadCapacityUnits &divide; PERIOD(ConsumedReadCapacityUnits)</p> 
<p>I can also calculate IOPS metrics for my <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ebs-metricscollected.html" target="_blank" rel="noopener noreferrer">Amazon EBS</a> volumes. I take the EBS Read and Write Ops metric and divide by the total number of seconds in that period, which I can use the Period()function to automatically calculate:</p> 
<p>EBS Volume Read IOPS = VolumeReadOps &divide; PERIOD(VolumeReadBytes)</p> 
<p>EBS Volume Write IOPS = VolumeWriteOps &divide; PERIOD(VolumeWriteOps)</p> 
<p>As I’m creating new metric math expressions, I can add them to a CloudWatch dashboard for easy referencing and viewing.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture6.png" /></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/04/03/Picture7.png" /></p> 
<p>I can also use the result of one math expression as a parameter for another math expression. If I don’t want to use the CloudWatch console, I can perform the same metric math calculations using the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html" target="_blank" rel="noopener noreferrer">GetMetricData API</a> action.</p> 
<p><strong><u>Available Now</u></strong></p> 
<p>CloudWatch Metric Math is available in all <a href="https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/" target="_blank" rel="noopener noreferrer">AWS Public Regions</a> and the AWS GovCloud (US) Region. To get a full list of the mathematical operations and functions that Amazon CloudWatch supports, see the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/WhatIsCloudWatch.html" target="_blank" rel="noopener noreferrer">user guide</a>. There are no extra charges to use CloudWatch Metric Math in the <a href="https://console.aws.amazon.com/cloudwatch/home">CloudWatch console</a>. You can also retrieve math results using the GetMetricData API action, which follows the <a href="https://aws.amazon.com/cloudwatch/pricing/" target="_blank" rel="noopener noreferrer">CloudWatch pricing</a> for API requests.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Service Catalog Hub and Spoke Model: How to Automate the Deployment and Management of Service Catalog to Many Accounts</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Jason Norton</span></span> | on 
<time property="datePublished" datetime="2018-04-02T08:06:16+00:00">02 APR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-service-catalog/" title="View all posts in AWS Service Catalog*"><span property="articleSection">AWS Service Catalog*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/aws-service-catalog-hub-and-spoke-model-how-to-automate-the-deployment-and-management-of-service-catalog-to-many-accounts/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Many organizations may have tens to hundreds of accounts and thousands of users that require services in AWS. Enforcing organizational governance controls for deploying services requires time and resources to build the necessary guardrails, security controls, and auditing. Using the AWS Service Catalog hub and spoke model and launch constraints, I’ll show you how to centrally manage Service Catalog deployments in a master/child account relationship. I’ll also show you how to enforce service constraints that allow users to self-provision AWS products, often reducing deployment costs, time, and management.</p> 
<p>Before diving into the details, first I’ll discuss the Service Catalog components.<span id="more-1889"></span></p> 
<b>Service Catalog components</b> 
<h3>Product</h3> 
<p>An AWS Service Catalog product is an IT service (VPC, web server, n-tier environment, database, etc.) that you want to make available for deployment on AWS.</p> 
<h3>Portfolio</h3> 
<p>An AWS Service Catalog portfolio is a collection of products and their configuration information, plus launch and access controls.</p> 
<h3>Constraint</h3> 
<p>An AWS Service Catalog constraint is a restriction on the ways that specific AWS resources can be deployed for a product, e.g., template constraints to allow only certain EC2 instance sizes.</p> 
<h3>Provisioned Product</h3> 
<p>An AWS Service Catalog product is launched using an AWS CloudFormation process. The collection of launched services is called a provisioned product. You might also see this collection of launched services referred to as a landscape.</p> 
<b>Implementation overview</b> 
<p>If you need to centrally manage AWS Service Catalog portfolios and products and then deploy across multiple accounts you can use a master Service Catalog account. Use this account to deploy the minimum portfolio, products, and constraints. Then you can share the master portfolios to child accounts where they are imported. Products that form the imported master portfolios are added to local portfolios in the child account. Constraints, tags, and users for these products can be added so that users in the child account can deploy any AWS CloudFormation stack implemented as a product.</p> 
<p>This is called the AWS Service Catalog hub and spoke model.</p> 
<p><strong>Hub and spoke model</strong></p> 
<li>One master account – Creates baseline products and shares the portfolio</li> 
<li>Multiple child accounts – Import portfolios and leverage the products</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/11/01/SC_Master_Child-1024x552.png" /></p> 
<p><strong>AWS Service Catalog administration</strong></p> 
<p>The hub-spoke model allows you to deploy Service Catalog portfolios and products centrally and locally in an account.</p> 
<p><strong>Two methods of leveraging shared portfolios</strong></p> 
<p>Imported portfolio – leverage the imported portfolio</p> 
<li>Launch and template constraints are inherited (Only set Launch constraints in the Child account)</li> 
<li>Constraints cannot be modified</li> 
<p>Local Portfolios – Create a local portfolio and import products from the shared portfolio.</p> 
<li>Only template constraints are inherited</li> 
<li>You can create and assign additional template constraints</li> 
<li>You have to assign launch constraints</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/11/01/SC_Process-1024x497.png" /></p> 
<p><strong>Walkthrough</strong><br /> Prerequisites:</p> 
<li>Two AWS Accounts</li> 
<li>Administrator IAM permissions to each account</li> 
<li>Access keys or AWS STS Credentials for CLI access to each account</li> 
<li>Download the python scripts from <a href="https://s3.amazonaws.com/aws-bigdata-blog/artifacts/service-catalog-hub-and-spoke/Service+Catalog+Hub+and+Spoke.zip">here</a>.</li> 
<p><strong>Note:</strong> Before running the following Python scripts, make sure that your AWS_DEFAULT_PROFILE is set to the correct account for deployment and that you have the proper administrative permissions.</p> 
<p>Files included in the repo:</p> 
<p>Master_SC_Single_Portfolio_Deploy_v1.py</p> 
<li>Python script that creates a Service Catalog portfolio, two products for the portfolio from the CloudFormation scripts that follow, template constraints, and tagging to enforce organization governance controls. The script shares the portfolio with selected child accounts.</li> 
<p>Child_SC_Single_Portfolio_Deploy_v1.py</p> 
<li>Python script that creates a local Service Catalog portfolio in a child account and imports the two products created in the master account, discussed previously. Creates launch constraints for each product to limit launching resources to a single IAM role and appropriate tagging.</li> 
<li>LAMP_Single_Instance_v1.template</li> 
<li>LAMP_Launch_Constraint.json</li> 
<li>Linux_Single_Instance_v1.template</li> 
<li>Linux_Instance_Launch_Constraint.json</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/11/01/SC_Implementation-1024x678.png" /></p> 
<p>A link to the python code can be found <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ServiceCatalogAgileGovernance.zip">here</a>.</p> 
<p><strong>Master Service Catalog deployment</strong></p> 
<p>$ export AWS_DEFAULT_PROFILE=Master_Service_Catalog_Profile</p> 
<p>1. Upload CFTs and constraint files to the Amazon S3 bucket that the Service Catalog master account has access to:</p> 
<li>LAMP_Single_Instance_v1.template</li> 
<li>Linux_Single_Instance_v1.template</li> 
<li>LAMP_Launch_Constraint.json</li> 
<li>Linux_Instance_Launch_Constraint.json</li> 
<p>2. Run the master deployment script with the bucket name from step 1 as a command line argument. Additional command line arguments can be any AWS accounts that you want to share the Master Portfolio and Products with:</p> 
<p>$ python Master_SC_Single_Portfolio_Deploy_v1.py bucketname share_account_1 share_account_2</p> 
<p>3. Copy the portfolio ID provided by this script for deploying Service Catalog in the child account.</p> 
<p>Your Linux Portfolio ID is: port-xxxxxxxxxxxxx</p> 
<p><strong>Child Service Catalog deployment</strong></p> 
<p>4. For each child account that you shared with in the previous master Service catalog section, do the following steps:</p> 
<p>$ export AWS_DEFAULT_PROFILE=Child_Service_Catalog_Profile</p> 
<p>5. Run the child deployment script with the portfolio ID of the master Service Catalog portfolio that you created in step 1:</p> 
<p>$ python Child_SC_Single_Portfolio_Deploy_v1.py port-xxxxxxxxxxxxx</p> 
<p><strong>After deployment</strong></p> 
<p>6. To ensure that everything deployed properly, check your master and child accounts for portfolios, products, and constraints.</p> 
<p>7. Add users in the child account to use the portfolio that you created.</p> 
<p>8. Test launching products in the child account. Users must have an Amazon EC2 key pair to deploy products.</p> 
<p>a. Notice when deploying the LAMP Instance that users are constrained to specific parameter values. When deploying the Linux single instance users are restricted to specific Security Groups (“WebServerSecurityGroup”) that were created by the LAMP instance product.</p> 
<p><strong>Summary</strong><br /> In this blog post I demonstrate the value of deploying the AWS Service Catalog in a hub and spoke model. In addition, I explain the process and have provided code samples. These samples show you how to automate a deployment across many AWS accounts and constrain users to specific AWS resource values to meet organization governance controls.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/12/CloudFormation.jpg" /> 
<b class="lb-b blog-post-title" property="name headline">Using AWS Cloud9, AWS CodeCommit, and Troposphere to author AWS CloudFormation templates</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Luis Colon</span></span> | on 
<time property="datePublished" datetime="2018-03-14T12:13:39+00:00">14 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/developer-tools/" title="View all posts in Developer Tools*"><span property="articleSection">Developer Tools*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/using-aws-cloud9-aws-codecommit-and-troposphere-to-author-aws-cloudformation-templates/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS Cloud9 was announced at AWS re:Invent in November 2017. It’s a browser-based IDE suitable for many cloud development use cases, including serverless applications. AWS CloudFormation now supports quickly spinning up AWS Cloud9 development environments, with integration with AWS CodeCommit. In this blog post, I’ll explore how to quickly spin up AWS Cloud9 environments with CloudFormation, and also how to code in AWS Cloud9 with Python and Boto3, and generate CloudFormation template code in YAML using <a href="https://github.com/cloudtools/troposphere">Troposphere</a>.<span id="more-2791"></span></p> 
<p>Note: As of the time of this writing, AWS Cloud9 is available in the following AWS Regions: Northern Virginia, Ohio, Oregon, Ireland, and Singapore regions.</p> 
<b><strong>Spinning up Cloud9 Environments with CloudFormation</strong></b> 
<p>Using the <code class="lang-clike">AWS::Cloud9::EnvironmentEC2</code> resource type, you can quickly deploy AWS Cloud9 development environments, which you can use to set up development environments for a class or workshop at your company. Each AWS Cloud9 environment also creates an Amazon EC2 instance where you can use a command line to set up additional development tools, much like modern IDEs integrate with your local machine’s terminal sessions. You can also use this automation opportunity to set up CodeCommit repositories for each student that is using the environment. When you create these environments using CloudFormation you can also create a Git-compatible repository and integrate it with the Amazon EC2 instance that gets deployed with the AWS Cloud9 environments.</p> 
<p>The template code that follows shows how simple it is to set up a single environment using CloudFormation with a CodeCommit repository. There are two prerequisites that you must complete before you deploy this template into a stack:</p> 
<li>Your IAM user must belong to a group that includes the <code class="lang-clike">AWSCodeCommitPowerUser</code>&nbsp;and <code class="lang-clike">AWSCodeCommitFullAccess</code></li> 
<li>You need an appropriate subnet to deploy the EC2 instance. I used an account that had a VPC already deployed. (For more information, read <a href="https://docs.aws.amazon.com/AmazonVPC/latest/GettingStartedGuide/getting-started-ipv4.html">Getting Started with Amazon VPC</a>.) I used the intrinsic function <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html"><code class="lang-clike">GetAtt</code></a>&nbsp;to connect the instance to the CodeCommit repository being created.</li> 
<p>After it’s deployed, this template creates a separate stack that includes the EC2 instance as an output. This additional stack gets deleted after you delete the <code class="lang-clike">AWS::Cloud9::EnvironmentEC2</code> resources, so you don’t have to worry about administering this additional stack for the purposes of this example. After the stack deployment is complete, you can verify that it created both the AWS Cloud9 environment and CodeCommit repository by visiting their respective browser-based consoles.</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: A CodeCommit Repo and Cloud9 Environment for Basic Development
Resources:
MyRepo:
Type: &quot;AWS::CodeCommit::Repository&quot;
Properties:
RepositoryName: MyRepo
RepositoryDescription: Sample Repo for Cloud9 CFN Post
MyC9Environment:
Type: &quot;AWS::Cloud9::EnvironmentEC2&quot;
Properties:
Repositories:
- PathComponent: /cfn
RepositoryUrl: !GetAtt MyRepo.CloneUrlHttp
InstanceType: t2.micro
SubnetId: subnet-be8735d6
AutomaticStopTimeMinutes: 45</code> 
<h5><strong>Figure 1. A CloudFormation template to create a Cloud9 environment and a CodeCommit repository.</strong></h5> 
<b><strong>More on AWS Cloud9</strong></b> 
<p>AWS Cloud9 is a versatile browser-based IDE. After you create your environment, you can operate your environment from typical MacOS, Linux and Windows machines, as well as from Chromebooks and tablets. This modern IDE provides multiple coding panes, as well as a command line pane, so you can switch from the editor to command line functions. As shown in Figure 2, I did some of the coding for this article on an iPad Pro, changing a few keyboard settings like splitting the keyboard so I can see both the editor and command line. I could also disable automatic capitalization, automatic word suggestions, and smart punctuation. As I do more iPad-based coding in the future, I’ll probably choose a more programmer-centric keyboard, like SmoothMobile’s <a href="https://itunes.apple.com/us/app/devkey-developer-keyboard-for-programming/id961304986?platform=ipad&amp;preserveScrollPosition=true#platform/ipad">DevKey</a>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/c9oniPad-1024x766.png" /></p> 
<h5><strong>Figure 2. The Cloud9 experience on an iPad.</strong></h5> 
<b><strong>Basic file editing</strong></b> 
<p>When you open your AWS Cloud9 environment, your EC2 instance has already been configured with the AWS CLI and a handful of other utilities, like Python versions 2 and 3, as well as Node 6. Also, the AWS CLI has been preconfigured with the required permissions to execute AWS commands. Finally, your local Git client automatically recognizes the repository you’ve just created, and clones it. Note that because it is a new repository, it will be empty.</p> 
<p>Assuming you’ve never used AWS Cloud9 or CodeCommit, now is a good time to create a simple file and add it to the repository. I’ll create a default markdown text file for the repository. After you navigate to your repository and open it in CodeCommit, it will automatically look for a <code class="lang-clike">README.md</code> file and render it, behaving in a similar way to Git repositories hosted on GitHub.</p> 
<p>The first time you open your AWS Cloud9 environment, it will prompt you to navigate to the (still empty) directory it cloned for your newly created repository. It will also advise you to set up your display name and email for your commits using the following commands:</p> 
<code class="lang-bash">git config --global user.name “YOUR_USER_NAME”
git config --global user.email YOUR_EMAIL_ADDRESS</code> 
<p>I’ll execute those two commands first.</p> 
<p>For this example, I’ll create a bare bones markdown file for my sample project, as shown in Figure 3. First, I navigated to the AWS Cloud9 console, found the environment I recently created, and opened it. Then, I leveraged a pre-packaged file template by choosing the <strong>File</strong> menu, then the <strong>New From Template</strong> submenu, then the <strong>Markdown</strong> template option from the resulting submenu. Notice that I also changed the default color theme for the IDE, and I changed the local Git configuration for my commits. In addition, I checked the versions for some of the pre-installed packages in the EC2 instance that AWS Cloud9 presents. I can also preview my markdown file in a separate pane with the Preview button. After I’ve added a few lines, I saved the file inside my repository folder (<code class="lang-bash">~/environment/cfn</code> in my example).</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/c9blogFig3-1024x731.png" /></p> 
<h5><strong>Figure 3. Editing a markdown file in Cloud9, previewing it, and checking versions on the instance.</strong></h5> 
<p>Now that I have a new local file in my repository folder, it’s time to commit it to my remote CodeCommit repository. After I changed directories to my local repository folder, I’ll enter the following sequence of commands:</p> 
<table style="height: 181px" width="808"> 
<tbody> 
<tr> 
<td><code class="lang-bash">git status</code></td> 
<td>Confirms any new files saved to my local repository</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git add –all</code></td> 
<td>Adds new files to my next commit</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git commit -m “message”</code></td> 
<td>Adds a helpful message context to my commit action</td> 
</tr> 
<tr> 
<td><code class="lang-bash">git push -u origin master</code></td> 
<td>Sends the committed files to the (remote) repository</td> 
</tr> 
</tbody> 
</table> 
<p>To verify that everything works as I expected, go to the CodeCommit console and inspect your repository, which we named MyRepo in our template. The <code class="lang-bash">README.md</code> file we just created should be there, and it should be automatically rendered.</p> 
<b><strong>Using Python and AWS Boto3</strong></b> 
<p>In preparation for using Troposphere to generate CloudFormation code, I’ll make sure that I can create and run a Python program, and that I can use the AWS-provided Boto3 library to execute AWS API calls. You can find a fairly easy Python example as part of the Cloud9 documentation <a href="https://docs.aws.amazon.com/cloud9/latest/user-guide/sample-python.html">here</a>. You’ll find that both Python 2 and 3 are already installed, so you can grab the sample code, save a new file in your instance and repository, and add a new Run Configuration to execute your code. The Run Configuration is handy to inject environment variables as you test your code, as well as to see the active standard output console for a long-running server process.</p> 
<p>In Figure 4, I’ve validated that I’m able to compose and run basic Python code in my environment. I created the file by choosing the <strong>File</strong> menu, then the <strong>New From Template</strong> submenu, then the <strong>Python File</strong> template option from the resulting submenu. When I paste the sample code into my editing pane, I get smart syntax highlighting as well. Note the command I entered in the <strong>Command:</strong> field on the Run pane on the bottom of the screen, and that it is running Python 2.</p> 
<p>Now that I’ve verified that I can edit and run Python programs in my environment, I’ll repeat the sequence of Git commands that I used for my earlier markdown file above, and move on to my next sample file.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/cloud9python-1024x760.png" /></p> 
<h5><strong>Figure 4. Running a basic Python program in AWS Cloud9.</strong></h5> 
<p>Next, let’s ensure we can call AWS APIs with the latest version of Boto3. From a terminal tab, enter the following command:</p> 
<p><code class="lang-bash">sudo python -m pip install boto3</code></p> 
<p>After it is installed, I’ll use the sample AWS SDK code from the previously mentioned documentation page for AWS Cloud9 and copy it into a new file. When creating the new file, I’ll use the <strong>File, New From Template, </strong>and<strong> Python File</strong> menu sequence as I did before, to ensure that I get proper syntax highlighting. Do this for all your language-specific code files and, in some cases, you’ll be able to leverage automatic suggestions as you type. Save your file and execute it in the existing Run Configuration tab. When you use a unique bucket name as the first runtime parameter, and a target Region as the second runtime parameter, the program uses Boto3 to list the current S3 buckets for the current user account. It also adds the new bucket, lists the buckets again, then deletes the newly-added bucket, and lists the buckets again showing that it successfully deleted it. See Figure 5.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/awsbotoapi.png" /></p> 
<h5><strong>Figure 5. Using AWS APIs in Python with Boto3.</strong></h5> 
<b><strong>Generating CloudFormation template code with Troposphere</strong></b> 
<p><a href="https://github.com/cloudtools/troposphere">Troposphere</a> is an open-source project that enables Python developers to use Boto3 to generate CloudFormation code in either JSON or YAML. Many AWS customers use it. Troposphere is a mature project, its repository provides many examples, and it allows you to use imperative language constructs like looping to generate template code. To add it to our environment, run the following command as you did when installing Boto3 before:</p> 
<p><code class="lang-bash">sudo python -m pip install troposphere[policy]</code></p> 
<p>Installing it with the policy option brings an additional project, which makes it easier to generate JSON for the AWS Access Policy Language, although is it not required for this example. To set up our example, first write the header for our template into a file called <code class="lang-bash">template.yaml</code>:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: A CFN Template</code> 
<p>With this file in hand, we’ll create a short Python program to loop through the generation of an EC2 instance three times. The code, which uses the installed Troposphere library, is listed in Figure 6.</p> 
<code class="lang-python">from troposphere import Ref, Template
import troposphere.ec2 as ec2
template = Template()
envs = ['dev', 'test', 'prod']
for x in envs:
instancename = x + &quot;Ec2&quot;
ec2_instance = template.add_resource(ec2.Instance(
instancename,
ImageId=&quot;ami-a7a242da&quot;,
InstanceType=&quot;t2.nano&quot;,
))
fh = open(&quot;template.yaml&quot;, &quot;a&quot;)
fh.writelines(template.to_yaml())
fh.close()
</code> 
<h5><strong>Figure 6. A sample Python file using Troposphere to generate a CloudFormation YAML code snippet.</strong></h5> 
<p>As it loops, the EC2 template instance name will be generated from a list of three items. This will have the effect of generating three instances each for <em>dev</em>, <em>test</em>, and <em>prod</em> environments. Then, we’ll append the generated YAML code into the <code class="lang-bash">template.yaml</code> header file we manually created earlier, although the header could also be generated in Python code as well. The sample code, as well as the resulting YAML file, are shown in Figure 7.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/trop-sample-1024x673.png" /></p> 
<h5><strong>Figure 7. A sample Python file using Troposphere to generate a CloudFormation YAML code snippet.</strong></h5> 
<p>The resulting YAML file is ready for us to use with CloudFormation. You can either list the file and copy and paste its contents to a local YAML file to upload to CloudFormation, or push it back to your CodeCommit repo and pick up the file from there.</p> 
<p><strong>Cleaning up</strong></p> 
<p>Now that the sample exercise is completed, I’ll clean up all the resources I’ve created. But first, I’ll probably want to keep the files in my CodeCommit repository for future reference. Since removing the initial stack will remove my AWS Cloud9 environment and CodeCommit repository, I’ll clone my repository locally so I can keep the files I’ve created. To do so, I’ll go to the <a href="https://console.aws.amazon.com/iam/">AWS IAM console</a> and create HTTPS Git credentials for my user account. You can find this option after you choose your user, then choose the <strong>Security Credentials</strong> tab. Scroll down, and choose the <strong>Generate</strong> button, as shown in Figure 8. Grab the resulting username and password, and clone your repository locally. To find the URL, open the CodeCommit console, select your repository, and choose the <strong>Connect</strong> button. This will give you the URL and the Git clone command to enter locally.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/10/git-credentials.png" /></p> 
<h5><strong>Figure 8. Generating Git credentials so you can copy the sample files from your repository to your local machine.</strong></h5> 
<p>After the files are copied down, go back to the CloudFormation console and delete the sample stack you created from the Troposphere-generated YAML code, as well as the stack that created your AWS Cloud9 environment and CodeCommit repository. You can delete both stacks in parallel since they don’t depend on each other. Also, note that the additional stack that was created to generate your Amazon EC2 instance will be removed as well.</p> 
<b><strong>Bonus Tip: Increasing your AWS Cloud9 storage space</strong></b> 
<p>While coding on your EC2-backed AWS Cloud9 instance, you may run out of the default 8GB storage space in your connected EBS volume. You can expand the space by following these steps:</p> 
<ol> 
<li>On the AWS Cloud9 IDE, switch to a bash terminal session, and enter the <code class="lang-bash">df -k</code> command. You should see the default 8GB disk size under the <code class="lang-bash">1K-blocks</code> column. This is the value you will change in this procedure.</li> 
<li>Close your Cloud9 session, then go to the EC2 console and stop the EC2 instance used by your environment. Its name should have the prefix “<code class="lang-bash">aws-cloud9-YourResourceName-0a0b…</code>”. In the template listed earlier, the prefix is “<code class="lang-bash">aws-cloud9-MyC9Environment-0a0b…</code>”.</li> 
<li>Wait until the instance state is displayed as <em>stopped</em>, and then choose <strong>Volumes</strong> from the Elastic Block Store submenu on the left side of the page.</li> 
<li>Choose your volume, and then choose <strong>Modify Volume</strong> from the Actions menu above the instance list.</li> 
<li>Enter a number larger than 8 in the <strong>Size</strong> field (for example, 16 corresponds to 16GB, which will double your storage).</li> 
<li>Choose the <strong>Modify</strong> button and accept the changes.</li> 
<li>Refresh the page a few times, and you will see the state of the volume changing to <strong><em>in-use – optimizing</em></strong>. Continue to refresh the page until the state of the volume changes to <strong><em>in-use – completed (100%)</em></strong>.</li> 
<li>Return to the AWS Cloud9 console, and choose <strong>Open IDE</strong> to start your environment. It will recognize that the instance is stopped, and it will restart the instance and connect to it.</li> 
<li>Run <code class="lang-bash">df -k</code> again to verify that the space is allocated. In the earlier example, you should see the 16GB size of your disk under the <code class="lang-bash">1K-blocks</code> column, and your <code class="lang-bash">Use %</code> should be updated to reflect the larger size.</li> 
</ol> 
<b><strong>Summary</strong></b> 
<p>Setting up a robust browser-based development environment with CloudFormation, AWS Cloud9, and CodeCommit is fast and easy. Using tools like Boto3 and Troposphere, you can use AWS SDK APIs and generate CloudFormation code in YAML from Python just as quickly. There are other ways to use high-level languages like Python to generate CloudFormation code. Other public projects target other languages like Ruby, JavaScript, and Go.</p> 
<p>Finally, I should note that we only covered a few of the features of AWS Cloud9 in this blog post. Using AWS Cloud9 you can edit remote files, enable live pair programming, and perform debugging with breakpoints, and show variable values as the program runs. You can clone additional repositories and work on multiple projects from a single AWS Cloud9 environment. There are many additional configuration options, accessible by using the Settings menu or by choosing the gear icon on the right edge of the top menu bar. For more information on AWS Cloud9 features, see the <a href="https://aws.amazon.com/documentation/cloud9/">AWS Cloud9 documentation</a>.</p> 
<p>I encourage you to experiment with other AWS Cloud9 features, as well as other projects that allow you to use high-level languages to author CloudFormation templates. It is likely that you’ll discover new ideas to help you improve your infrastructure code and your automation options.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/09/Screen-Shot-2018-03-09-at-11.57.42-AM-1127x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">Distributing your AWS OpsWorks for Chef Automate infrastructure</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Nick Alteen</span></span> | on 
<time property="datePublished" datetime="2018-03-09T13:24:11+00:00">09 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-ops-works/" title="View all posts in AWS OpsWorks*"><span property="articleSection">AWS OpsWorks*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/distributing-your-aws-opsworks-for-chef-automate-infrastructure/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Organizations that manage many nodes over larger geographical AWS Regions may wish to reduce latency and load between nodes in their AWS OpsWorks for Chef Automate implementation. By distributing nodes between multiple servers, organizations encounter the challenge of how to ensure that cookbooks and other configurations are consistently deployed across two or more Chef Servers residing in one or more Regions. To accomplish this, customers can make use of several supplemental AWS services that will drive the process of distributing cookbooks to one or more Chef Automate instances.</p> 
<p><span id="more-2767"></span></p> 
<h3>Overview</h3> 
<p>One situation large-scale Chef users might run into is that the number of nodes managed by their OpsWorks for Chef Automate (OWCA) server exceeds its capacity. Customers can switch to a bigger Amazon EC2 instance by using their most recent backup, but this limit may be reached at some point. Additionally, latency in communications may be experienced in globally-distributed environments.</p> 
<p>This is easy to overcome by distributing management of nodes to multiple OpsWorks for Chef Automate instances. However, this approach introduces the challenge to synchronize cookbooks across multiple OWCA instances. This can be accomplished with the use of AWS CodeCommit, AWS CodeBuild, AWS CodePipeline, and optionally AWS Lambda. For this blog post, we will show you how customers can scale their Chef-managed infrastructure across two Regions.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/09/Screen-Shot-2018-03-09-at-11.57.42-AM-1024x572.png" /></p> 
<p>By using CodePipeline and CodeCommit, a cookbook developer simply has to push changes to a central repository. CodePipeline will trigger off this commit and send the updated repository contents to CodeBuild for processing. With simple scripting, CodeBuild will pull dependencies from Chef Supermarket, and upload the needed cookbooks to each Chef Automate instance in the account (or accounts). By using the chef-client cookbook, nodes will check in automatically on a pre-configured schedule. In this blog post, an Invoke stage in the pipeline can use AWS Lambda and AWS Systems Manager to run chef-client on any nodes in the environment. This step is optional, but useful for testing scenarios where it is helpful to deploy changes more rapidly.</p> 
<h3>Setup</h3> 
<p>To set this up, we use an AWS CloudFormation template. We will walk through each resource to be added to the template. Prior to doing so, at least one OpsWorks for Chef Automate instance must be created. The starter kit for each instance will contain a private key in the <code>[Starter-Kit]/.chef/</code> directory. Though this key can be used for authentication from CodeBuild, we recommend that you create a separate user in the Chef Automate console, and assign it a public/private key pair. Follow the <a title="undefined" href="https://docs.chef.io/delivery_users_and_roles.html" target="_blank" rel="noopener noreferrer">instructions on Chef.io</a> for reference. At minimum, this user account will require Committer permissions. The private key for this user can be saved in an Amazon S3 bucket in your account, which will be accessed by CodeBuild to authenticate with the Chef Automate server during the cookbook upload process. It’s important to ensure that access to this bucket is tightly controlled with appropriate bucket policies. An alternative to consider would be storing the keys in AWS Key Management Service (KMS).</p> 
<h3>Components</h3> 
<h4>Parameters</h4> 
<p>This template requires only one input parameter, <code>KeyBucket</code>, which corresponds to the Amazon S3 bucket that contains the private keys for each Chef Automate instance to be synchronized with this cookbook repository.</p> 
<code class="lang-json">{
&quot;Parameters&quot;: {
&quot;KeyBucket&quot;: {
&quot;Type&quot;: &quot;String&quot;,
&quot;Description&quot;: &quot;Name of S3 bucket which contains the OWCA private keys.&quot;,
&quot;AllowedPattern&quot;: &quot;^[a-z0-9][a-z0-9-.]*$&quot;,
&quot;MinLength&quot;: 3,
&quot;MaxLength&quot;: 63,
&quot;ConstraintDescription&quot;: &quot;Please provide a valid S3 bucket name.&quot;
}
}
}</code> 
<h4>IAM Permissions</h4> 
<p>Two AWS Identity and Access Management (IAM) roles will be needed for the pipeline to function correctly.</p> 
<p>The first IAM role, <code>BuildRole</code>, will be used by CodeBuild during build tasks, and will need the default permissions for CodeBuild containers. Additionally, the role will need access to the Amazon S3 bucket containing the private keys for authentication with each Chef Automate instance (referenced in the Parameters section of the template).</p> 
<p>The second IAM role, <code>FunctionRole</code>, will be used by AWS Lambda to execute <code>chef-client</code> on each instance in the environment. In addition to the Amazon CloudWatch Logs permissions required by Lambda execution roles, this role will require the ability to send commands via AWS Systems Manager.</p> 
<code class="lang-json">{
&nbsp;  &quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;  &nbsp; &quot;BuildRole&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;AssumeRolePolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Principal&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Service&quot;: [ &quot;codebuild.amazonaws.com&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;sts:AssumeRole&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Path&quot;: &quot;/&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Policies&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyName&quot;: &quot;CodeBuildS3WithCWL&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;PolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:Get*&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:List*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
{ &quot;Fn::GetAtt&quot;: [ &quot;ArtifactBucket&quot;, &quot;Arn&quot; ] },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Fn::GetAtt&quot;: [ &quot;ArtifactBucket&quot;, &quot;Arn&quot; ] },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:s3:::&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;KeyBucket&quot; }
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:s3:::&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;KeyBucket&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/codebuild/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/codebuild/*:*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogGroup&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;logs:CreateLogStream&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:PutLogEvents&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Resource&quot;: [ &quot;arn:aws:s3:::codepipeline-*&quot; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;s3:PutObject&quot;,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:GetObject&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s3:GetObjectVersion&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;ssm:GetParameters&quot; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Resource&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:ssm:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:parameter/CodeBuild/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp; }
&nbsp;&nbsp;    },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;FunctionRole&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::IAM::Role&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;AssumeRolePolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Principal&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Service&quot;: [ &quot;lambda.amazonaws.com&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [ &quot;sts:AssumeRole&quot; ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Path&quot;: &quot;/&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Policies&quot;: [ {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyName&quot;: &quot;LambdaBasicExecutionWithSSM&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;PolicyDocument&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;2012-10-17&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Statement&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm:SendCommand&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm:GetCommandInvocation&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: &quot;*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogGroup&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:CreateLogStream&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;logs:PutLogEvents&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&quot;:log-group:/aws/lambda/*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;arn:aws:logs:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::Region&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;:log-group:/aws/lambda/*:*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ] ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Effect&quot;: &quot;Allow&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Action&quot;: [
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;codepipeline:PutJobSuccessResult&quot;,
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;codepipeline:PutJobFailureResult&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Resource&quot;: &quot;*&quot;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ]
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;    }
}
}
}</code> 
<h4>Amazon S3 bucket</h4> 
<p>For use in CodePipeline to store artifacts, the <code>ArtifactBucket</code> resource is created and referenced when creating the pipeline itself.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;ArtifactBucket&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Type&quot;: &quot;AWS::S3::Bucket&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
}
}</code> 
<h4>CodeCommit repository</h4> 
<p>The CodeCommit repository being created will act as the Chef Repo to store cookbooks. The repository structure should adhere to the following format:</p> 
 .
├── .chef
│&nbsp;&nbsp; ├── knife.rb
│&nbsp;&nbsp; ├── ca_certs
│&nbsp;&nbsp; │&nbsp;&nbsp; └── opsworks-cm-ca-2016-root.pem
│&nbsp;&nbsp; └── [CHEF_SERVER_NAME]
│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── config.yml
├── Berksfile
├── buildspec.yml
└── cookbooks/ 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Repo&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::CodeCommit::Repository&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;RepositoryDescription&quot;: &quot;Cookbook repository for multiple region OWCA deployment.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;RepositoryName&quot;: &quot;owca-multi-region-repo&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>.chef</h4> 
<p>The <code>.chef/</code> directory structure is slightly different than what is normally included in the OpsWorks for Chef Automate starter kit. The modifications that follow will allow the knife utility to use environment variables when determining which Chef Automate instance to communicate with and which certificate file to use.</p> 
<p>The <code>knife.rb</code> file below uses the <code>yaml</code> gem to parse configuration data from <code>config.yml</code>. The correct configuration file is determined based on the value of the <code>CHEF_SERVER</code> environment variable.</p> 
<code class="lang-yaml">require 'yaml'
CHEF_SERVER = ENV['CHEF_SERVER'] || &quot;NONE&quot;
current_dir = File.dirname(__FILE__)
base_dir = File.join(File.dirname(File.expand_path(__FILE__)), '..')
env_config = YAML.load_file(&quot;#{current_dir}/#{CHEF_SERVER}/config.yml&quot;)
log_level&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :info
log_location&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STDOUT
node_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'pivotal'
client_key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;#{current_dir}/#{CHEF_SERVER}/private.pem&quot;
syntax_check_cache_path&nbsp; File.join(base_dir, '.chef', 'syntax_check_cache')
cookbook_path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [File.join(base_dir, 'cookbooks')]
chef_server_url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env_config[&quot;server&quot;]
ssl_ca_file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File.join(base_dir, '.chef', 'ca_certs', 'opsworks-cm-ca-2016-root.pem')
trusted_certs_dir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File.join(base_dir, '.chef', 'ca_certs')</code> 
<p>To determine the correct Chef Automate instance to communicate with, each instance should have its own directory underneath <code>.chef/</code>, corresponding to the name of the instance. Within this directory, the <code>config.yml</code> file must follow the below format.</p> 
server: 'https://[SERVER_FQDN]/organizations/default' 
<p>Currently, each Chef Automate instance directory does not contain the private key needed to communicate with the server. It is not recommended to include authentication information such as SSL/API keys or passwords within files committed to source control systems. Instead, steps have been added to the build process to include the needed keys from S3 instead.</p> 
<h4>Berksfile</h4> 
<p>Within the Berksfile, any cookbooks contained in the <code>cookbooks/</code> directory must be referenced in the format that follows. This will indicate to Berkshelf that the cookbook can be found within the local repository.</p> 
# Local Cookbooks
cookbook '[COOKBOOK_NAME]', path: 'cookbooks/[COOKBOOK_NAME]' 
<p>Cookbooks that are imported from Chef Supermarket can be included as normal.</p> 
source 'https://supermarket.chef.io'
# Supermarket Cookbooks
cookbook '[COOKBOOK_NAME]' 
<h4>buildspec.yml</h4> 
<p>The <code>buildspec.yml</code> file provides instructions to CodeBuild for downloading dependencies and uploading the cookbooks to each Chef Automate instance. To use the berks command, ChefDK must be installed during the build process. In this example the installation package is downloaded from Chef.io. Alternatively, ChefDK can be packaged and installed preemptively on a custom build environment to reduce build times. As shown in the following example, these are the major steps for the build process:</p> 
<ol> 
<li>Download and install ChefDK.</li> 
<li>Copy the private keys to authenticate to two Chef Automate instances from S3.</li> 
<li>Run <code>berks install</code> to download and install any dependencies.</li> 
<li>Upload cookbooks to both Chef Automate instances.</li> 
</ol> 
<code class="lang-yaml">version: 0.2
phases:
&nbsp;install:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;wget https://packages.chef.io/files/stable/chefdk/1.5.0/ubuntu/14.04/chefdk_1.5.0-1_amd64.deb&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;dpkg -i ./chefdk_1.5.0-1_amd64.deb&quot;
&nbsp;build:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;aws s3 cp s3://[KEY_BUCKET]/[CHEF_SERVER_1]/private.pem ./.chef/[CHEF_SERVER_1]/private.pem&quot;
&nbsp;&nbsp;&nbsp; &nbsp;- &quot;aws s3 cp s3://[KEY_BUCKET]/[CHEF_SERVER_2/private.pem ./.chef/[CHEF_SERVER_2]/private.pem&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_1] berks install&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_2] berks install&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_1] berks upload --no-ssl-verify&quot;
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;CHEF_SERVER=[CHEF_SERVER_2] berks upload --no-ssl-verify&quot;
&nbsp;post_build:
&nbsp;&nbsp; commands:
&nbsp;&nbsp;&nbsp;&nbsp; - &quot;echo 'Complete'&quot;</code> 
<p>This build specification will be ingested by CodeBuild during the build stage of the pipeline.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp;    &quot;BuildProject&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;Type&quot;: &quot;AWS::CodeBuild::Project&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Artifacts&quot;: { &quot;Type&quot;: &quot;CODEPIPELINE&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Description&quot;: &quot;Installs cookbook dependencies from Berksfile and uploads to one or more OWCA servers.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Environment&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;ComputeType&quot;: &quot;BUILD_GENERAL1_SMALL&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Image&quot;: &quot;aws/codebuild/ubuntu-base:14.04&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Type&quot;: &quot;LINUX_CONTAINER&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;ServiceRole&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;BuildRole&quot;, &quot;Arn&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Source&quot;: { &quot;Type&quot;: &quot;CODEPIPELINE&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>Lambda function</h4> 
<p>The Lambda function, <code>ChefClientFunction</code>, uses AWS Systems Manager via Boto3 to call sudo chef-client on a list of instances provided in the function code. The example below uses two instance IDs passed in a list. However, Boto3 can be leveraged further to generate lists of nodes by tags or other relevant properties. This is left as an exercise for the reader.</p> 
<code class="lang-json">{
&quot;Resources&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;ChefClientFunction&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::Lambda::Function&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Code&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ZipFile&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;\n&quot;, [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;from __future__ import print_function&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;import boto3&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ssm = boto3.client('ssm')&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;code_pipeline = boto3.client('codepipeline')&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;def lambda_handler(event,context):&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; job_id = event['CodePipeline.job']['id']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; try:&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = ssm.send_command(&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InstanceIds=[&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '[INSTANCE_ID_1]',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '[INSTANCE_ID_2]'&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DocumentName='AWS-RunShellScript',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Comment='chef-client',&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Parameters={&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'commands': ['sudo chef-client']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command_id = response['Command']['CommandId']&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('SSM Command ID: ' + command_id)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('Command Status: ' + response['Command']['Status'])&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Include monitoring of job success/failure as needed.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code_pipeline.put_job_success_result(jobId=job_id)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; except Exception as e:&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e)&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; code_pipeline.put_job_failure_result(jobId=job_id, failureDetails={'message': e.message, 'type': 'JobFailed'})&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise e&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Description&quot;: &quot;Executes chef-client on specified nodes.&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Handler&quot;: &quot;index.lambda_handler&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Role&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;FunctionRole&quot;, &quot;Arn&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Runtime&quot;: &quot;python2.7&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Timeout&quot;: &quot;10&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h4>Pipeline</h4> 
<p>Lastly, the Pipeline deployed will use each of the components to deploy a cookbook to both Chef Automate servers simultaneously.</p> 
<code class="lang-json">{
&nbsp;  &quot;Resources&quot;: {
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;OWCAPipeline&quot;: {
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;AWS::CodePipeline::Pipeline&quot;,
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Properties&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ArtifactStore&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Location&quot;: { &quot;Ref&quot;: &quot;ArtifactBucket&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Type&quot;: &quot;S3&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;RoleArn&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::Join&quot;: [ &quot;&quot;, [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &quot;arn:aws:iam::&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Ref&quot;: &quot;AWS::AccountId&quot; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;:role/AWS-CodePipeline-Service&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;] ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Stages&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Source&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;CodeCommit&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;BranchName&quot;: &quot;master&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;RepositoryName&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Fn::GetAtt&quot;: [ &quot;Repo&quot;, &quot;Name&quot; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;ChefRepo&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;OutputArtifacts&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Name&quot;: &quot;Cookbooks&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Source&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Build&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;CodeBuild&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ProjectName&quot;: { &quot;Ref&quot;: &quot;BuildProject&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;InputArtifacts&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { &quot;Name&quot;: &quot;Cookbooks&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;Berkshelf&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Build&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Actions&quot;: [
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ActionTypeId&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Category&quot;: &quot;Invoke&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Owner&quot;: &quot;AWS&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Provider&quot;: &quot;Lambda&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Version&quot;: &quot;1&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &quot;Configuration&quot;: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;FunctionName&quot;: { &quot;Ref&quot;: &quot;ChefClientFunction&quot; }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; },
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Name&quot;: &quot;LambdaChefClient&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &quot;Name&quot;: &quot;Invoke&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }
&nbsp;  }
}</code> 
<h3>Summary</h3> 
<p>By distributing nodes across multiple OpsWorks for Chef Automate instances, the average workload per instance can be reduced, allowing management of considerably more instances as your infrastructure grows. Using several AWS services, it is a simple task to ensure consistency and ease of management of cookbooks across servers, Regions, and even AWS accounts.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to create custom AWS Config rules with AWS CodeStar</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Greg Kim</span></span> | on 
<time property="datePublished" datetime="2018-03-09T07:44:40+00:00">09 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/developer-tools/aws-codestar/" title="View all posts in AWS CodeStar*"><span property="articleSection">AWS CodeStar*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-create-custom-aws-config-rules-with-aws-codestar/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>The <a href="https://aws.amazon.com/config/">AWS Config</a> rules feature enables you to define in code the desired configuration of your AWS resources. For example, you can check that your Amazon S3 buckets are not publicly accessible or that your instances are associated with a security group.</p> 
<p>While Config offers <a href="https://docs.aws.amazon.com/config/latest/developerguide/managed-rules-by-aws-config.html">a set of prebuilt (managed) rules</a> that represent common best practices, you may want to create custom rules to ensure that your AWS resources conform to your organization’s unique guidelines. You can define these guidelines in an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function that executes as your rule’s engine. For more information, see <a href="https://aws.amazon.com/blogs/aws/aws-config-rules-dynamic-compliance-checking-for-cloud-resources/">AWS Config Rules – Dynamic Compliance Checking for Cloud Resources</a>.</p> 
<p><a href="https://aws.amazon.com/codestar/">AWS CodeStar</a> is a centralized dashboard, from which you and your team can collaborate to develop, build, and deploy applications on AWS. AWS CodeStar includes project templates for common development platforms to enable provisioning of projects and resources for coding, building, testing, deploying, and running your software project.</p> 
<p>In order to make the process of authoring Config rules easier, AWS CodeStar recently announced support for AWS Config custom rule templates, which allow you and your team to work together to define and author the set of Config rules that fit your organization. You can then deploy the necessary resources so that you have a working Config Rule at the click of a button.</p> 
<p>In this blog, I show you how to author and create a custom Config rule using the AWS CodeStar end-to-end development experience.</p> 
<p><span id="more-2695"></span></p> 
<p><strong>Walkthrough</strong><br /> First, you need to record your AWS resources with Config. This means that Config records the configuration states of your resources whenever they are created or modified. Follow the steps in:</p> 
<li><a href="https://docs.aws.amazon.com/config/latest/developerguide/gs-console.html">Setting up AWS Config with the Console</a></li> 
<li><a href="https://docs.aws.amazon.com/config/latest/developerguide/gs-cli.html">Setting up AWS Config with the AWS CLI</a></li> 
<p>Now, get started creating your Config rule. For this example, you will write a rule to check that the S3 buckets in your account have versioning enabled. Luckily, this is already a managed rule, but for this example, pretend it isn’t.</p> 
<p>In the AWS CodeStar console, start a project with the Config rule project template, selecting either Python or Node.js to author your rule.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/project_templates-1.png" /></p> 
<p>This example will use&nbsp;Python, but the steps will be the same for Node.js.&nbsp;Click through until you get to the rule’s project dashboard. Use <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a> as the code repository and <a href="https://aws.amazon.com/cloud9/">AWS Cloud9</a> as the IDE. Here’s what the AWS CodeStar dashboard looks like upon arrival.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/codestar_dashboard-1.png" /></p> 
<p>The AWS CodeStar dashboard is a one-stop-shop for the entire development process for your Config rule. It has links to AWS Cloud9, CodeCommit, <a href="https://aws.amazon.com/codebuild/">AWS CodeBuild</a>, <a href="https://aws.amazon.com/codepipeline/">AWS CodePipeline</a>, and <a href="https://aws.amazon.com/codedeploy/">AWS CodeDeploy</a>, as well as the permissions to access this project and the resources that this project creates.</p> 
<p>First, open the link to the AWS Cloud9 IDE to author your rule.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/open_ide.png" /></p> 
<p>Inside the IDE, you see the project directory with the code for the example rule and the <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> template to be used create the Config rule and Lambda function for this project. The rule’s code is separated into two files:</p> 
<li>The rule_util file handles the API calls to report evaluations back to Config (you won’t need to modify this file).</li> 
<li>The rule_code file comprises the actual logic of the rule.</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rules_directory.png" /></p> 
<p>If you open up the rule_code file, you can modify the code to check if your S3 buckets have versioning enabled.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rule_code_change.png" /></p> 
<p>Modify the APPLICABLE_RESOURCES because you want this rule to only report evaluations for S3 buckets. Then, look in the <a href="https://docs.aws.amazon.com/config/latest/developerguide/config-concepts.html#config-items">Configuration Item</a> that was sent by Config to this Lambda function to check if versioning is enabled. If it isn’t, return that this resource is noncompliant with this rule.</p> 
<p>Now, make the necessary changes to your CloudFormation template.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/template_change.png" /></p> 
<p>Change the rule name to something more descriptive (like S3BucketVersioningEnabled), add a description for what the rule does, and change the scope of the rule to only apply to S3 buckets.</p> 
<p>That’s it. At this point, you’ve made all the code changes you need to have a Config rule that checks that your S3 buckets have versioning enabled. Push the change and watch it go through all the related services. The AWS Cloud9 IDE has a terminal window open where you can push the code directly to your CodeCommit repository.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/git_push.png" /></p> 
<p>Now, navigate back to the AWS CodeStar dashboard.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/commit_build_deploy.png" /></p> 
<p>Watch as the change is pushed into the CodeCommit repository. Afterwards, CodeBuild packages up the code that you wrote and stores it in an S3 bucket that was created by this AWS CodeStar project. Then, CodeDeploy takes that build from S3 and creates your Config rule backed by the Lambda function that you just wrote.</p> 
<p>Also accessible from the dashboard is a link to the Config rule console where you can see your rule in action.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rule_link.png" /></p> 
<p>You can see that the Config rule evaluated all of your S3 buckets. Three of them are noncompliant, meaning versioning wasn’t enabled.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/22/rules_console.png" /></p> 
<p><strong>Conclusion</strong><br /> I hope this post has shown you how easy it is to use AWS CodeStar to create custom Config rules that verify the configurations of your AWS resources.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/001_arch_diagram.png" /> 
<b class="lb-b blog-post-title" property="name headline">Using AWS Systems Manager to run compliance scans using InSpec by Chef</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Maitreya Ranganath</span></span> | on 
<time property="datePublished" datetime="2018-03-07T10:16:28+00:00">07 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/using-aws-systems-manager-to-run-compliance-scans-using-inspec-by-chef/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>As described in the <a href="https://d1.awsstatic.com/whitepapers/architecture/AWS-Security-Pillar.pdf">Security Pillar </a>of the <a href="https://aws.amazon.com/architecture/well-architected/">AWS Well-Architected Framework</a>, the careful management of the security configurations of the running systems within your environment forms the foundation of how you will maintain robust, secure, scalable systems.</p> 
<p><a href="https://www.chef.io/inspec/">InSpec by Chef</a>, an open-source testing framework, provides teams the ability to define and assess system state and status across the entire application lifecycle. InSpec can already be used with AWS OpsWorks for Chef Automate to track the compliance of your infrastructure based on predefined policies. For example, you can describe compliance controls in InSpec and integrate these tests into any stage of your deployment pipeline or choose from a set of pre-packaged InSpec profiles. You can then use the Compliance pane as a unified dashboard to identify issues, remediate them, and track progress for various nodes and profiles.</p> 
<blockquote> 
<p><em>“According to the Chef User Survey 2017, 55% of organizations do compliance assessments incompletely or not at all,” says James Casey, Vice President of Partner Engineering and Integration at Chef. “Amazon Web Services and Chef help customers identify and automate compliance by using InSpec, part of Chef’s integration with AWS OpsWorks for Chef Automate. Now, customers have more options to use InSpec’s framework with the addition of InSpec availability through AWS Systems Manager.”</em></p> 
</blockquote> 
<p>In this blog post, I’ll focus on three features of AWS Systems Manager that can be used with InSpec:</p> 
<li><a href="https://aws.amazon.com/systems-manager/features/#Run_Command">Run Command</a>—Provides a simple way of running an ad hoc scan of your infrastructure using InSpec.</li> 
<li><a href="https://aws.amazon.com/systems-manager/features/#State_Manager">State Manager</a>—Allows you to execute InSpec tests on a schedule so that you can continuously assess the compliance of your systems.</li> 
<li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-compliance.html">Configuration Compliance</a> –Collects and aggregates information about InSpec test results.</li> 
<p><span id="more-2726"></span>I’ll use the newly defined Systems Manager Document <strong>AWS-RunInSpecChecks</strong> to run InSpec profiles that check the configuration of both Windows and Linux servers against a security baseline.</p> 
<p>Here’s an outline of the steps:</p> 
<ol> 
<li>Launch Systems Manager Managed Instances.</li> 
<li>Ensure you have an <a href="https://www.inspec.io/docs/reference/profiles/">InSpec Profile</a>. In this blog you will use predefined profiles from the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project on GitHub to check both Linux and Windows servers against a security baseline.</li> 
<li>Execute the InSpec tests using Run Command or State Manager. You don’t need InSpec installed your servers because the scripts will do that for you.</li> 
<li>View the results of your tests in Compliance.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/001_arch_diagram.png" /></p> 
<b>Launch Managed Instances</b> 
<p>You need at least one <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/managed_instances.html">managed instance</a> that can act as a target of InSpec test execution. You can skip this step if you already have one or more Systems Manager managed instances in your AWS Account.</p> 
<p>Otherwise, you can launch an AWS CloudFormation stack that launches two Amazon EC2 instances, one Windows Server 2012 R2 Base and one Amazon Linux, to act as test managed instances. The stack also creates an IAM Role and Instance Profile with the AmazonEC2RoleforSSM managed policy.</p> 
<p>The following link launches the stack in the us-east-1 (N. Virginia) Region:</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=SSM-InSpec&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm_inspec_test_servers.template"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/cloudformation-launch-stack.png" /></a></p> 
<p>The CloudFormation template requires the following parameters:</p> 
<li><strong>KeyPair</strong>: Choose an Amazon EC2 key pair from the list. Ensure that you have the private key corresponding to the key pair.</li> 
<li><strong>Subnet</strong>: Choose a subnet where the instances will be launched. Ensure that the subnet has outbound access to Internet addresses and to the Systems Manager API endpoints via an<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html"> Internet Gateway</a>, a <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html">NAT Gateway</a> or a <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-setting-up-vpc.html">VPC Endpoint for Systems Manager</a>.</li> 
<li><strong>VpcId</strong>: Choose the VPC for the subnet you chose in Subnet.</li> 
<p>The CloudFormation stack provides the following outputs:</p> 
<li><strong>LinuxServer</strong>: The EC2 instance ID of the Linux server.</li> 
<li><strong>WindowsServer</strong>: The EC2 instance ID of the Windows server.</li> 
<b>Create a Parameter to store your GitHub token</b> 
<p>You need a GitHub personal token to download InSpec profiles from GitHub. Follow the steps in <a href="https://github.com/join">Join GitHub</a> to create a GitHub account if you don’t already have one, <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/">create a token</a> and save the token in a secure location.</p> 
<p>You can use Parameter Store to store your GitHub personal access token using the <a href="https://aws.amazon.com/cli/">AWS CLI</a>:</p> 
aws ssm put-parameter --name 'github-personal-token' --description 'GitHub Personal Token' --type SecureString --value '&lt;value&gt;' 
<p>Or you can perform these steps using the Systems Manager console:</p> 
<ol> 
<li>In the AWS Management Console, navigate to the Systems Manager console. Choose <strong>Parameter Store</strong> from the left navigation pane. Then choose <strong>Create Parameter</strong>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/002.png" /></li> 
<li>For <strong>Name</strong>, type <strong>github-personal-token</strong>.</li> 
<li>For <strong>Description</strong>, type <strong>GitHub Personal Token</strong>.</li> 
<li>For <strong>Type</strong>, choose <strong>SecureString</strong> and accept the default KMS Key ID <strong>alias/aws/ssm</strong>.</li> 
<li>For <strong>Value</strong>, copy and paste the value of the GitHub personal token you saved earlier.</li> 
<li>Choose <strong>Create parameter</strong> to create the parameter.</li> 
</ol> 
<b>Execute InSpec tests on Windows Servers</b> 
<p>In this step, you’ll execute an InSpec Profile against a Windows server. An InSpec Profile organizes multiple controls to support dependency management and code reuse. Each profile is a standalone structure with its own distribution and execution flow.</p> 
<ol> 
<li>Log into the Systems Manager console and choose <strong>Run Command</strong> from the left navigation pane.</li> 
<li>Choose <strong>Run Command</strong>.</li> 
<li>In the search bar, choose to search by <strong>Document name prefix</strong>. Choose <strong>Equal</strong> as the condition and type <strong>AWS-Run</strong> as the prefix. From the list of Command documents, choose the document named <strong>AWS-RunInSpecChecks</strong>.</li> 
<li>Choose the Targets (either instances or tags). You can narrow the list to Windows servers in the search bar by choosing the filter <strong>Platform</strong> and choosing <strong>Windows</strong>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/003.png" /></li> 
<li>In the <strong>Command parameters</strong> section, choose <strong>Github</strong> as the <strong>Source Type</strong>. Type the following into the text area for <strong>Source Info</strong> to execute an InSpec profile that checks Windows servers against a <a href="https://github.com/dev-sec/windows-baseline">security baseline</a> defined by the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project on GitHub. {
&quot;owner&quot;:&quot;dev-sec&quot;,
&quot;repository&quot;:&quot;windows-baseline&quot;,
&quot;path&quot;: &quot;&quot;,
&quot;getOptions&quot; : &quot;branch:master&quot;,
&quot;tokenInfo&quot;:&quot;{{ssm-secure:github-personal-token}}&quot;
} <p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/004.png" /></p></li> 
<li>Accept the default values for the remaining parameters and choose <strong>Run</strong>.</li> 
<li>Refresh the Command status page until the status for the instances shown in the <strong>Targets and outputs list</strong> changes from <strong>In Progress</strong> to <strong>Success</strong>.</li> 
<li>Choose an instance ID from the list to see the output of the command run. Expand the steps shown on the <strong>Output</strong> page to view the command output.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/005.png" /></li> 
<li>Verify that the output of the runInSpecWindows step shows that the execution was successful and has a line showing the number of tests executed and the number that were compliant and non-compliant. Note that the scripts install the <a href="https://docs.chef.io/about_chefdk.html">Chef Development Kit</a> (chefdk), execute InSpec tests, and then uninstall chefdk. For example: Installing Chef Development Kit
Installing chefdk from C:\Windows\TEMP\chefdk-2.4.22-1-x64.msi
Executing InSpec tests
Completed InSpec checks and put 27 compliant (27 critical, 0 high, 0 low) and 47 non-compliant (39 critical, 0 high, 8 low) items
Uninstalling Chef Development Kit <p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/006.png" /></p></li> 
</ol> 
<b>View Compliance items</b> 
<p>In this step, you’ll view the results of the tests in Systems Manager Compliance.</p> 
<ol> 
<li>Log into the Systems Manager console and choose <strong>Explore Built-in insights</strong>.</li> 
<li>Choose <strong>Compliance</strong> from the navigation pane on the left.</li> 
<li>A summary of compliance items is shown as a chart, and the list of managed instances is displayed.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/007.png" /></li> 
<li>Choose a Managed Instance to view a list of compliance items of type Custom:InSpec that were created as a result of the InSpec tests executed. You can see that each item has a descriptive title, the compliance status: whether it is compliant (the test passed) or non-compliant (the test failed), and severity.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/03/04/008.png" /></li> 
</ol> 
<b>Execute InSpec tests on Linux servers</b> 
<p>To execute InSpec tests on Linux servers, follow the steps in the previous section, but choose one or more Linux servers in Step 4. In Step 6, type the following for Source Info to execute an InSpec profile that checks Linux servers against the <a href="https://github.com/dev-sec/ssh-baseline">SSH baseline</a> defined by the <a href="https://github.com/dev-sec">DevSec Hardening Framework</a> project.</p> 
{
&quot;owner&quot;:&quot;dev-sec&quot;,
&quot;repository&quot;:&quot;ssh-baseline&quot;,
&quot;path&quot;: &quot;&quot;,
&quot;getOptions&quot; : &quot;branch:master&quot;,
&quot;tokenInfo&quot;:&quot;{{ssm-secure:github-personal-token}}&quot;
} 
<p>You can also choose to execute a sample cross-platform InSpec profile that checks for open SSH and RDP ports. Type the following for <strong>Source Info</strong> and chose a combination of Linux and Windows servers.</p> 
{
&quot;owner&quot;: &quot;awslabs&quot;,
&quot;repository&quot;: &quot;amazon-ssm&quot;,
&quot;path&quot;: &quot;Compliance/InSpec/PortCheck&quot;,
&quot;getOptions&quot;: &quot;branch:master&quot;,
&quot;tokenInfo&quot;: &quot;{{ssm-secure:github-personal-token}}&quot;
} 
<b>Conclusion</b> 
<p>In this blog post, I have shown how Systems Manager now lets you run compliance scans using InSpec by Chef. The walk-throughs used Run Command to execute individual tests. You can also create <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-state-assoc.html">State Manager Associations</a> to execute these tests on a schedule so that you can continuously assess the compliance of your systems.</p> 
<p>Visit the <a href="https://aws.amazon.com/systems-manager/">AWS Systems Manager</a> landing page to learn more and get started.</p> 
<b>Cleaning up</b> 
<p>If you launched instances using the CloudFormation template described earlier, you can delete those resources to avoid being charged for them going forward.</p> 
<ol> 
<li>In the CloudFormation console, choose the stack named <strong>SSM-InSpec</strong>, and from <strong>Actions</strong>, choose <strong>Delete Stack</strong>.</li> 
<li>Refresh the <strong>Events</strong> tab of the stack until the stack disappears from the stack list.</li> 
</ol> 
<h3></h3> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to develop custom AWS Config rules using the Rule Development Kit</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Michael Borchert</span></span> | on 
<time property="datePublished" datetime="2018-03-06T18:09:41+00:00">06 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-develop-custom-aws-config-rules-using-the-rule-development-kit/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>To help customers rapidly prototype, develop, and deploy their custom <a href="https://aws.amazon.com/config">AWS Config</a> rules at scale, AWS introduces a new version of the AWS Config Rule Development Kit (RDK).</p> 
<p>The RDK is a command-line utility designed to help you to shorten your security and compliance feedback cycles when using Config. It helps you build a continuous compliance framework that your auditors will love. It can be included in an end-to-end DevSecOps pipeline or used interactively from your command line to create and atomically deploy the Config, <a href="https://aws.amazon.com/lambda">AWS Lambda</a>, and <a href="https://aws.amazon.com/iam">IAM</a> resources necessary for your custom Config use case.</p> 
<p>In this post, I show you how to get started with the RDK.<span id="more-2669"></span></p> 
<b><strong>Background</strong></b> 
<p>Config is a native service for continuous compliance. It allows you to track the changes to resources and configurations (configuration items) in your account. You can define rules that detect when configuration items have drifted into undesirable territory.</p> 
<p>Config has a number of out-of-the-box rules that cover many the common use cases for customers. You can also create custom Config Rules backed by Lambda functions. Many enterprise customers or customers operating in highly regulated industries have special requirements that need specific definitions of compliant. I also see customers using the robust, serverless Config framework to build other housekeeping functionality such as cost and security controls.</p> 
<b>Getting Started</b> 
<p>The first steps are to make sure that you have the necessary permissions in your AWS account, and then you can install the tool itself.</p> 
<h3>Prerequisites</h3> 
<p>To get started, you need an AWS account, and necessary permissions for modifying Config rules, Lambda functions, and various IAM resources within that account. The <a href="https://github.com/awslabs/aws-config-rdk/blob/master/policy/rdk-minimum-permissions.json">rdk-minimum-permissions.json</a> sample policy document illustrates the required permissions.</p> 
<p>RDK allows you to author Lambda functions in almost all of the supported languages. It is itself written in Python, and is compatible with both Python 2.7 and 3.6. The recommended installation method is through pip (<code>pip install rdk</code>). To see the source code (or even contribute!), clone the GitHub aws-config-rdk repo.</p> 
<p>You can make sure that it is installed correctly by typing rdk at a command prompt. You should see usage instructions and an error about required arguments.</p> 
<code class="lang-bash">
(rdk-demo) 186590d1e043:rdk-demo USER $ rdk
usage: rdk [-h] [-p PROFILE] [-k ACCESS_KEY_ID] [-s SECRET_ACCESS_KEY]
[-r REGION]
&lt;command&gt; ...
rdk: error: the following arguments are required: &lt;command&gt;, 
&lt;command arguments&gt;
</code> 
<h3>Runtime-specific prerequisites</h3> 
<p>Config rules backed by Python and Node.js Lambda functions can be deployed without any additional setup. To use either the Java 8 or .NET Core runtimes, you need some additional components:</p> 
<li>Java: Use gradle to build your deployment package, so install it somewhere accessible from your CLI.</li> 
<li>.NET: Microsoft ships a CLI for .NET called “dotnet” that you need installed, as well as the latest release of the .NET Core framework v1.0. These are necessary to build and create Lambda deployment packages for your .NET code.</li> 
<b>Workflow</b> 
<p>Now that you have the RDK installed, walk through the steps to create, deploy, and manage your custom Config rules.</p> 
<h3>Set credentials</h3> 
<p>RDK uses the boto3 libraries for AWS API access, so any of the standard methods of passing credentials work. For more information about ways to supply your credentials, see options 3 through 8 in <a href="http://boto3.readthedocs.io/en/latest/guide/configuration.html">Credentials</a> in the Boto documentation. Alternately, you can pass them in with the following command-line parameters:</p> 
<li>–profile</li> 
<li>–region</li> 
<li>–access-key-id</li> 
<li>–secret-access-key</li> 
<h3>Initialize</h3> 
<p>Use <code>rdk init</code> to create a working directory. The working directory holds your rule definitions, as well as a snapshot of template files used to build your Config rules. Ideally, your working directory is a local code repo and python virtualenv, but it’s not necessary for just playing around. The <code>init</code> command also configures AWS Config in the account specified by your credentials. Config begins tracking information about your resources and their configurations.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk init
Running init!
Found Config Recorder: default
Found Config Role: arn:aws:iam::123456789012:role/config-role
Found Bucket: config-bucket-123456789012
Config Service is ON
Config setup complete.
Found code bucket: config-rule-code-bucket-123456789012us-west-2
</code> 
<h3>Create or modify</h3> 
<p>Now it’s time to create some rules!</p> 
<p>Use <code>rdk create &lt;rulename&gt; --runtime &lt;runtime&gt;</code> to create a local rule folder that contains your initial rule code, as well as some helper code and the parameters used to deploy the rule later. You need to specify a valid Lambda runtime. Optional flags include resource types for triggering on configuration change events, the frequency for scheduled evaluations, and any parameters that Config passes on to the backing Lambda function.</p> 
<p>To change rule parameters later on, you can use <code>rdk modify &lt;rulename&gt; --&lt;flag&gt; &lt;option&gt;</code> to overwrite any of the options that were previously set for your local rule definition.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk create MyTestRule --runtime python3.6 --resource-types AWS::EC2::Instance
Running create!
Defaulting to TwentyFour_Hours Maximum Frequency.
Local Rule files created.
</code> 
<h3>Edit</h3> 
<p>Navigate to the folder created by create and you see a number of files, depending on the runtime that you selected.</p> 
<p>Config rules backed by Python or Node.js Lambda functions have a .py or .js file named the same as your<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/19/file_structure.png" /> rule name, which is the code template to which to add your custom logic. There are other files associated with each runtime that provide necessary functions to validate inputs, submit compliance results back to Config, and handle errors and logging. You probably don’t need to worry about these.</p> 
<p>Go ahead and add whatever logic you want based on the CI, rule parameters, or any other data that your function should pull out of your AWS environment. Just make you return a valid compliance result. If you are writing your Lambda function in Java, make sure that you update the build.gradle file with any dependencies that you add.</p> 
<h3>Deploy</h3> 
<p>Now you’re ready to deploy your custom rule to AWS!</p> 
<p>From your working directory, use <code>rdk deploy &lt;rulename&gt;</code> to push your changes out to AWS. This uses AWS CloudFormation behind the scenes to build your Config rule, Lambda function. It also creates the necessary policies and permissions to let them talk to one another. You can list multiple rules to deploy, or use the <code>–all</code> flag to push all of the rules in your working directory. If you are using either Java or .NET, this also compiles your code and packages it appropriately for Lambda deployment.</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk deploy MyTestRule
Running deploy!
Zipping MyTestRule
Uploading MyTestRule
Updating CloudFormation Stack for MyTestRule
Waiting for CloudFormation stack operation to complete...
Waiting for CloudFormation stack operation to complete...
Waiting for CloudFormation stack operation to complete...
Publishing Lambda code...
Lambda code updated.
Config deploy complete.
</code> 
<h3>Monitor</h3> 
<p>After your rule has successfully deployed, you’ll want to know what it’s actually doing!</p> 
<p>It can be useful to instrument your Lambda function with some logging so that you can have some debugging output about the decisions that your function is making. RDK provides a quick way to get a view into your function with the <code>logs</code> command. It has command-line arguments for how many log events to look back, and also supports the <code>–f</code> flag for continuously polling the log group for the specified function and returning results as they happen.</p> 
<p>The following is an example of the <code>logs</code> command:</p> 
<code class="lang-bash">
(rdk-demo) 1234567890ab:rdk-demo USER$ rdk logs MyTestRule/ -f
Removing trailing '/'
2018-02-13 10:55:03 - Tenancy is 'default' - returning COMPLIANT
2018-02-13 10:55:04 - END RequestId: 482e6306-1069-11e8-8696-8f2e469c4c56
2018-02-13 10:55:04 - REPORT RequestId: 482e6306-1069-11e8-8696-8f2e469c4c56&nbsp;&nbsp;&nbsp; Dura
tion: 325.81 ms&nbsp;&nbsp;&nbsp; Billed Duration: 400 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 30 MB
2018-02-13 10:55:04 - END RequestId: 480270e8-1069-11e8-b8de-65b91f7b7901
2018-02-13 10:55:04 - REPORT RequestId: 480270e8-1069-11e8-b8de-65b91f7b7901&nbsp;&nbsp;&nbsp; Dura
tion: 264.03 ms&nbsp;&nbsp;&nbsp; Billed Duration: 300 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 30 MB
2018-02-13 11:00:20 - START RequestId: 07029f1c-106a-11e8-921b-c7902649007e Version:
$LATEST
2018-02-13 11:00:20 - Tenancy is 'default' - returning COMPLIANT
2018-02-13 11:00:20 - END RequestId: 07029f1c-106a-11e8-921b-c7902649007e
2018-02-13 11:00:20 - REPORT RequestId: 07029f1c-106a-11e8-921b-c7902649007e&nbsp;&nbsp;&nbsp; Dura
tion: 272.61 ms&nbsp;&nbsp;&nbsp; Billed Duration: 300 ms&nbsp;&nbsp;&nbsp;&nbsp; Memory Size: 25
6 MB&nbsp;&nbsp;&nbsp; Max Memory Used: 31 MB
</code> 
<p>From the logs, make sure that your rule is functioning as expected. If you have a bug in your logic, iterate quickly by editing the rule code and re-deploying in seconds.</p> 
<p>After you’ve deployed your rule and verified that it’s working correctly, you can see your compliance status in the AWS Config console.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/19/screen_shot.png" /></p> 
<b>Conclusion</b> 
<p>I’m excited about the ways that the RDK can empower AWS customers to build world-class, enterprise-level compliance controls quickly and easily, leaving the heavy-lifting of the machinery and the framework to AWS Config.</p> 
<p>Config is a powerful component in a cloud-based, end-to-end security and compliance framework. Its ability to track changes over time is a great complement for Amazon CloudWatch Events, which gives you near-real-time responsiveness to individual API calls.</p> 
<p>To learn more about how these services can work together to provide a comprehensive “Compliance As Code” solution, check out the <a href="https://www.youtube.com/watch?v=VR_4209ewIo">Building the Largest Repo for Serverless Compliance-as-Code (SID205)</a> re:Invent 2017 session.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Recovering AWS CloudFormation stacks using ContinueUpdateRollback</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Casey Nishant</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:37:00+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation*"><span property="articleSection">AWS CloudFormation*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/devops/" title="View all posts in DevOps*"><span property="articleSection">DevOps*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/recovering-aws-cloudformation-stacks-using-continueupdaterollback/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS CloudFormation treats a stack as a collection of AWS resources that customers can manage as a single unit. After you launch a stack, you can use the AWS CloudFormation console, API, or AWS CLI to update resources in your stacks. You should not make any changes to stack resources outside of CloudFormation. This is due to something we call resource drift. Resource drift occurs when you make out-of-band changes to CloudFormation managed resources that can cause errors if you later update or delete the stack.</p> 
<p>This blog post walks you through examples of how to recover your stack from states such as <em>UPDATE_ROLLBACK_FAILED</em>. We show you how to regain control of the stack to perform further updates using CloudFormation without intervention from AWS Support.</p> 
<p><span id="more-2526"></span></p> 
<b><span style="text-decoration: underline"><a name="update_rollback_failed"></a>UPDATE_ROLLBACK_FAILED</span></b> 
<p>Out-of-band changes can easily occur when there are newcomers to your organization who make accidental changes to resources created by CloudFormation. These changes can also be made by members of different teams who might not have awareness of the service. Out-of-band changes can cause your CloudFormation stack to enter a state in which you are no longer able to continue modifying the stack. When a stack reaches UPDATE_ROLLBACK_FAILED, this means that the CloudFormation stack was attempting an UPDATE operation, the operation failed, and we began a rollback. An issue occurred that stopped CloudFormation from returning to the previous “good” state during the rollback. As a result, the stack can’t update and can’t roll back, thus it assumes this half-way state. The API then stops any further actions on the stack other than ContinueUpdateRollback and DeleteStack.</p> 
<b><a name="continueupdaterollback"></a>ContinueUpdateRollback</b> 
<p>The <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-continueupdaterollback.html">ContinueUpdateRollback API</a> operation provides customers an override for stacks in an UPDATE_ROLLBACK_FAILED state. It forces CloudFormation to continue with the rollback procedure. Use this operation only for troubleshooting. When a failure occurs and the stack enters an UPDATE_ROLLBACK_FAILED state, the API operation simply continues the rollback. However, it provides no fix to the underlying issue. For example, it doesn’t fix the underlying issue of whether a rollback failed due to an account limit. If you don’t address this account limit constraint, ContinueUpdateRollback will simply retry the rollback and fail once more. You still need to fix the underlying problem separately and, in a break from best-practices, outside of AWS CloudFormation.</p> 
<b>A practical example</b> 
<p>We’ll walk you through a scenario involving stacks entering the UPDATE_ROLLBACK_FAILED state and the use of the Auto Scaling service. Let’s take a look at a CloudFormation template.</p> 
<p><b>Note</b>: This template can be deployed in any Region as long as you specify a valid HVM-compatible Amazon Machine Image (AMI) on launch. Alternatively, to launch it <i>as-is</i> use the Europe (London) (eu-west-2) Region.</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.micro&quot;
</code> 
<p>As you can see, we create an Auto Scaling group with a launch configuration and our stack is created just as we expected.</p> 
<h3><a name="chaos-ensues"></a>Chaos ensues</h3> 
<p>To continue our hypothetical, let’s pretend that we hire Jimmy, a new member of the operations team fresh out his AWS Certified Solutions Architect Associate exam. One day, while you are not around, the development team asks him to decrease the size of the instance type for the Auto Scaling group. He decides it’s best to create a cool new launch configuration for the running the Auto Scaling group and assign the new launch configuration to the group:</p> 
<code class="lang-bash">aws autoscaling create-launch-configuration --launch-configuration-name Jimmys_new_LC --image-id ami-1a7f6d7e --instance-type t2.nano --region eu-west-2
ASName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id ASG --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling update-auto-scaling-group --auto-scaling-group-name $ASName --launch-configuration-name Jimmys_new_LC --region eu-west-2
</code> 
<p>Of course, he also decides to clean up the old Auto Scaling launch configuration for good measure:</p> 
<p>(For your ease of replication, I include the first line below to fetch the physical ID of the launch configuration created by the previous template.)</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws autoscaling delete-launch-configuration --launch-configuration-name $LCName --region eu-west-2
</code> 
<p>Oh Jimmy, we had such high hopes…</p> 
<h3><a name="rollbacks-and-stabilization"></a>Rollbacks and stabilization</h3> 
<p>In the majority of my tests AWS CloudFormation attempts to fail fast. For example, if we were to add a HealthCheckType with an incorrect value, the initial API call would fail and the stack would roll back. However, because CloudFormation did not replace or successfully change the configuration of the target resource, it correctly assumes that no API call is necessary in order to roll back.</p> 
<p>A rollback can trigger a reapplication of a previous configuration after a period of time. CloudFormation refers to this as stabilization. CloudFormation performs an API call on behalf of a user, and in addition, it attempts to ensure that, when a resource is labeled as CREATE COMPLETE, the resource is running in the desired state. For Auto Scaling for example, it sends a CreateAutoScalingGroup API call and then attempts to DescribeAutoScalingGroup until the group has a Min/Max and Desired count equal to the count defined in the template. If this doesn’t occur, CloudFormation must then reapply the previous configuration.</p> 
<h3><a name="forcing-a-rollback"></a>Forcing a rollback</h3> 
<p>In our example, we could force this type of failure by increasing the Auto Scaling group’s capacity past our account limit for running On-Demand instances. This would in turn fail stabilization and trigger our rollback. At this point CloudFormation would be unable to find the previously defined launch configuration and the stack would then enter the UPDATE_ROLLBACK_FAILED state. However, this would involve launching a number of unused instances, which would not be very frugal. Instead, we can use the CloudFormation Wait Condition resource to simulate a failure and force a rollback.</p> 
<p>This is how we update the CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
Resources:
ASG:
Type: &quot;AWS::AutoScaling::AutoScalingGroup&quot;
Properties:
AvailabilityZones: 
- !Select 
- 0
- Fn::GetAZs: !Ref 'AWS::Region'
DesiredCapacity: 1
LaunchConfigurationName: !Ref &quot;LC&quot;
MaxSize: 1
MinSize: 1
LC:
Type: &quot;AWS::AutoScaling::LaunchConfiguration&quot;
Properties: 
ImageId: !Ref &quot;pAMI&quot;
InstanceType: &quot;t2.large&quot;
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: ASG
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p class="FirstParagraph">As you can see, the template updates our launch configuration to use t2.large instances. However, because we never signal our WaitCondition, the stack will roll back. At this point CloudFormation will attempt to reapply the launch configuration. However, as we saw earlier, Jimmy deleted our launch configuration. So any update on the stack that updates the Auto Scaling group and triggers a rollback will fail.</p> 
<h3><a name="general-guidance-on-recovering-stuck-sta"></a>General guidance on recovering <i>stuck</i> stacks</h3> 
<p class="FirstParagraph">To address issues with CloudFormation stacks that have entered UPDATE_ROLLBACK_FAILED state you have three options:</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">1.<span style="font: 7.0pt 'Times New Roman'"><code> </code></span>Delete the stack. If the deletion fails for any reason, you can then use the DeleteStack API operation with the RetainResources option listing resources that failed deletion.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">2. Make underlying account changes manually/outside the scope of the stack to re-synchronize the stack with the expectation and then perform ContinueUpdateRollback.</p> 
<p class="MsoNormal" style="margin-left: 24.0pt;text-indent: -24.0pt">3. If you address the issues with the underlying stack resources you canuse ContinueUpdateRollback along with the ResourcesToSkip option. CloudFormation will mark the problematic/failing resources as UPDATE_COMPLETE and continue with the rest of the rollback.</p> 
<h3><a name="saving-the-day"></a>Saving the day</h3> 
<p>Now to address Jimmy’s mistake. With experience we know that CloudFormation relies on resource names or IDs to keep track of ownership. With launch configurations, we can see that the service uses a combination of the StackName, LogicalId, and a random string to name the launch configuration.</p> 
<p>What we can do is create a new launch configuration using the precise name of the previous one. We can grab that name by describing our stack as before then follow that up with a ContinueUpdateRollback:</p> 
<code class="lang-bash">LCName=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id LC --output text --query StackResources[0].PhysicalResourceId`
aws autoscaling create-launch-configuration --launch-configuration-name $LCName --image-id ami-1a7f6d7e --instance-type t2.micro --region eu-west-2
aws cloudformation continue-update-rollback --stack-name &lt;stack-name&gt; --region eu-west-2
</code> 
<p class="FirstParagraph">Our stack should now be back to UPDATE_ROLLBACK_COMPLETE and ready for us to perform our update again.</p> 
<code class="lang-basg">aws cloudformation describe-stacks --stack-name &lt;stack-name&gt; --query Stacks[0].StackStatus –region eu-west-2
&quot;UPDATE_ROLLBACK_COMPLETE&quot;</code> 
<p class="FirstParagraph">In our example we forced the rollback by adding a never-completing WaitCondition. In your case the cause might be due to account limitations or other issues.</p> 
<b>When replacement is not an option</b> 
<p>In our example, we were left in the lucky situation in which you can replace the removed resource easily by naming a new resource the same name that your stack expects. Let’s take a look at a situation in which a resource was deleted that does not have a custom-name.</p> 
<p>Consider the following CloudFormation template:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Please use your *default* VPC security group so that the steps that follow are successful&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
SecurityGroupIds:
- !Ref InstanceSecurityGroup
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>In this template we are creating an instance and a security group. Let’s pretend our old friend Jimmy was this time instructed to alter the EC2 instance and reference the default VPC security group:</p> 
<code class="lang-bash">defaultSecGroup=`aws ec2 describe-security-groups --group-name default --query SecurityGroups[0].GroupId --output text --region eu-west-2`
stackSecGroup=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id InstanceSecurityGroup --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
instance=`aws cloudformation describe-stack-resources --stack-name &lt;stack-name&gt; --logical-resource-id Instance --output text --query StackResources[0].PhysicalResourceId --region eu-west-2`
aws ec2 modify-instance-attribute --instance-id $instance --group $defaultSecGroup --region eu-west-2
aws ec2 delete-security-group --group-id $stackSecGroup --region eu-west-2
</code> 
<p>And then, once again we update our stack with the failing wait condition to simulate a failure and initiate a rollback:</p> 
<code class="lang-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
InstanceSecurityGroup:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
WaitCondition:
Type: &quot;AWS::CloudFormation::WaitCondition&quot;
DependsOn: Instance
CreationPolicy:
ResourceSignal:
Count: 1
Timeout: PT1M
</code> 
<p>The stack is now in the UPDATE_ROLLBACK_FAILED state due to the ‘Instance’ resource being unable to rollback with an error like:</p> 
<p><em><strong>The security group ‘sg-xxxxxxxx’ does not exist</strong></em></p> 
<p>This time, to recover, because we can’t re-create sg-xxxxxxxx with the exact ID, we will have to continue the rollback and skip past the instance so that we can continue to modify the stack and regain a working and synced state.</p> 
<p>The first step is to perform continue-update-rollback skipping the resource:</p> 
<code class="lang-bash">aws cloudformation continue-update-rollback --resources-to-skip Instance --region eu-west-2</code> 
<p>The stack would now be in the UPDATE_ROLLBACK_COMPLETE state. However, the state of the stack no longer matches the state of the underlying resources. The instance, while still running, will have the default EC2 security group assigned to it by Jimmy instead of the security group we have defined here in the stack. To rectify this, we have to modify our template so that the instance is updated with a different security group ID. We can also remove the reference to the old, now deleted group from our template and use this as the new group for the instance:</p> 
<code class="lang-bash">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Description: &quot;A template used to illustrate the use of ContinueUpdateRollback API when recovering CloudFormation stacks from Update Rollback Failed&quot;
Parameters: 
pAMI:
Type: &quot;AWS::EC2::Image::Id&quot;
Description: &quot;Pick any HVM compatible AMI-ID for the AutoScaling group, the default works in eu-west-2 only&quot;
Default: &quot;ami-1a7f6d7e&quot;
pVPC:
Type: &quot;AWS::EC2::VPC::Id&quot;
Description: &quot;Any VPC with at least 1 available subnet&quot;
pSubnet:
Type: &quot;AWS::EC2::Subnet::Id&quot;
Description: &quot;A Subnet within the VPC provided&quot;
Resources:
Instance:
Type: &quot;AWS::EC2::Instance&quot;
Properties: 
ImageId: !Ref pAMI
SubnetId: !Ref pSubnet
InstanceType: t2.micro
SecurityGroupIds:
- InstanceSecurityGroup2
InstanceSecurityGroup2:
Type: AWS::EC2::SecurityGroup
Properties:
VpcId: !Ref pVPC
GroupDescription: Allow http to client host
SecurityGroupIngress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
SecurityGroupEgress:
- IpProtocol: tcp
FromPort: '80'
ToPort: '80'
CidrIp: 0.0.0.0/0
</code> 
<p>Our stack should now be back in a state that is synchronized with the underlying resources and in a state that allows for further modifications down the line.</p> 
<b>Conclusion</b> 
<p>Throughout this blog, we learned about various CloudFormation concepts such as rollbacks, stabilization and using the ContinueUpdateRollback operation. We showed you two examples of using ContinueUpdateRollback to rescue a stack from a stuck state. In the first example we simply alter an underlying value then perform the API call. In the second example we have to skip past the problematic resource (due to the fact that it uses a unique ID instead of a user-defined value).</p> 
<hr /> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Track Changes to Auto Scaling Groups Using AWS Config</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Varun Pole</span></span> | on 
<time property="datePublished" datetime="2018-02-20T11:04:27+00:00">20 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config*"><span property="articleSection">AWS Config*</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools*"><span property="articleSection">Management Tools*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-changes-to-auto-scaling-groups-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Recently, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for Auto Scaling groups. You can now track configuration changes in Auto Scaling groups, such as minimum, maximum, and desired capacities, termination policies, scaling policies, subnets, and instance protection settings.</p> 
<p>You can also use a new managed AWS Config rule to check whether the Auto Scaling groups associated with your load balancers are using the Elastic Load Balancing health checks to determine the health state of your Amazon EC2 instances.</p> 
<p>In this post, I describe two possible ways that you could track changes to Auto Scaling groups and evaluate compliance. I’ll walk you through each scenario.</p> 
<p><span id="more-2483"></span></p> 
<p><strong>AWS services</strong><br /> AWS Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p>An Auto Scaling group is a collection of EC2 instances, with similar configuration and characteristics, that are used for the purpose of scaling and management. These EC2 instances in the Auto Scaling group are treated as a logical group. You can configure the Auto Scaling group with the capacity that you want for instances required for the application to operate. You can configure the group with the minimum and maximum instances, depending on which instances Auto Scaling can launch or terminate based on dynamic scaling.</p> 
<p><strong>Example: Track configuration changes</strong></p> 
<p>Let’s consider a scenario where a customer notices an increase in his Amazon Elastic Compute Cloud (Amazon EC2) bill for a prior month. He notices that there are Amazon EC2 charges related to the use of an m4.xlarge instance type. The customer is confused because his applications have always used t2.micro instances, so he investigates further. He notices that when a scale out happens, the instances launched by the Auto Scaling group are of type m4.xlarge, instead of t2.micro. So it appears that the Auto Scaling launch configuration must have been modified.</p> 
<p>AWS Config can help you investigate in this scenario and determine if and when any configuration changes occurred on the Auto Scaling launch configuration, since it maintains a history of all configuration changes to the Auto Scaling group. We use the AWS Management Console in this scenario, but you can use the AWS CLI or SDKs as well.</p> 
<p>First, log in to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: AutoScaling Group</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling groups that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling group on the <strong>Resource inventory</strong> page.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1024x416.png" /></p> 
<p>Look at the <strong>Config timeline</strong> for the <strong>AS- APP1 – AS group</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-1-1024x303.png" /></p> 
<p>The timeline shows you all configuration changes that were made after the Auto Scaling group was created.</p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on the 31st August to the Auto Scaling group configuration, when the launch configuration was changed from AS-APP1-Launch config to AS-APPv2-Launch config.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/LC-change-2.png" /></p> 
<p>Let’s open the EC2 console to check the Auto Scaling launch configurations. We can confirm that the instance type associated with the new launch configuration is m4.xlarge.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/AS-group-m4xlarge-1024x265.png" /></p> 
<p>Here is another example of tracking configuration changes using AWS Config. In this example, let’s assume that you are seeing performance degradations for applications hosted on your EC2 instances. Open the Amazon CloudWatch console. You can see spikes but are unable to understand why Auto Scaling did not dynamically scale out based on the CPU threshold scaling policy which was set to scale at 60 percent of average CPU.</p> 
<p>Go back to the AWS Config console. For <strong>Resources</strong>, choose <strong>AutoScaling: ScalingPolicy</strong>. Choose <strong>Look up</strong> to see the list of Auto Scaling Policies that AWS Config has automatically discovered in your account. The following screenshot shows an example Auto Scaling policy on the <strong>Resource inventory</strong> page</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/AS-group-resources-1.png" /></p> 
<p>Look at the Config timeline for Scale Group Size scaling policy. The following screenshot shows the timeline and configuration details.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/scaling-policy-changes-scale-1024x281.png" /></p> 
<p>Choose <strong>Changes</strong> and notice that a change was made on 4th September to the Scaling policy configuration, when the target value for Average CPU threshold was changed from 60 to 90 percent. This explains why the scale out did not happen as soon as the CPU spiked over 60 percent.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/Screen-Shot-2017-09-05-at-10.38.06-AM.jpg" /></p> 
<p>Using this information, you can fix these Auto Scaling configuration issues in the EC2 console.</p> 
<p>Another common scenario some customers have experienced is noticing too many instances in their account. This is because the instance termination policy has been enabled, which does not terminate your instances when the scale-in happens. This can be identified using the AWS Config service as well.</p> 
<p><strong>Example: Verify Heath Check using AWS Config rules</strong></p> 
<p>In addition to tracking the configuration of your Auto Scaling service, you can use AWS Config rules to check your Auto Scaling groups against best practices and internal policies.</p> 
<p>For example, use the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> to check whether your Auto Scaling groups that are associated with a load balancer are using Elastic Load Balancing health checks.</p> 
<p>Auto Scaling groups use Amazon EC2 health checks by default to determine the health of an instance. In situations where EC2 instances are running behind a load balancer, it’s beneficial to leverage the load balancer health checks for EC2 instances instead of Amazon EC2 health checks. This is because the load balancer health checks can determine the health of the application running on top of the EC2 instances, unlike the Amazon EC2 health checks.</p> 
<p>Here’s an example that shows how you can use AWS Config to troubleshoot a scenario where customers notice service errors or failures for the applications hosted on Amazon EC2 behind a load balancer even though the EC2 instance is healthy, reachable, and running.</p> 
<p>On the EC2 console, you can see that the EC2 instances healthy and running. But customers are still reporting errors while running your application. After some troubleshooting you determine that there are issues with the web service running on top of your EC2 instances. Elastic Load Balancing (ELB) load balancers have the capability to detect such failures via application-specific health checks and stop directing traffic to the affected EC2 instances. But since the Auto Scaling group isn’t configured to leverage the ELB health checks, customer requests are still hitting the unhealthy EC2 instances.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-instance-status.png" /></p> 
<p>AWS Config can help you identify Auto Scaling groups with this misconfiguration so that you can take corrective action. With the prebuilt rules called <strong>autoscaling-group-elb-healthcheck-required</strong> we can identify Auto Scaling groups that do not use ELB health checks. These resources are “non-compliant” as far as the AWS Config rule is concerned, as seen in the AWS Config console:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/02/14/elb-hc-nc.png" /></p> 
<p>Go to the EC2 console to change the health check type to ELB in the Auto Scaling group. When you return to the AWS Config console, you can see that the compliance status for the Auto Scaling group changes to the compliant state.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2018/01/12/ELB-hc-complaint-1024x291.png" /></p> 
<p><strong>Summary</strong><br /> With support for Auto Scaling in AWS Config, you can track configuration changes to your Auto Scaling groups and associated resource types. You can use the pre-built AWS Config rule or you can create custom rules to scan the configuration of these resources and verify compliance with best practices, internal guidelines, and regulatory requirements.</p> 
<hr /> 
</article> 
<p>
© 2018 Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
