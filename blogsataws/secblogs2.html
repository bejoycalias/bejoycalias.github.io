<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/secblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Security Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Security Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li class="active"><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="secblogs1.html">Page 1</a>|<a href="secblogs2.html">Page 2</a>|<a href="secblogs3.html">Page 3</a>|<a href="secblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/03/07/Rajat-featured-image-800-by-400.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Use Bucket Policies and Apply Defense-in-Depth to Help Secure Your Amazon S3 Data</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Rajat Ravinder Varuni</span></span> and 
<span property="author" typeof="Person"><span property="name">Rafael Marcelino Koike</span></span> | on 
<time property="datePublished" datetime="2018-03-07T09:26:22+00:00">07 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-cloudfront/" title="View all posts in Amazon CloudFront*"><span property="articleSection">Amazon CloudFront*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-route-53/" title="View all posts in Amazon Route 53*"><span property="articleSection">Amazon Route 53*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/amazon-simple-storage-services-s3/" title="View all posts in Amazon Simple Storage Services (S3)*"><span property="articleSection">Amazon Simple Storage Services (S3)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/" title="View all posts in Networking &amp; Content Delivery*"><span property="articleSection">Networking &amp; Content Delivery*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/" title="View all posts in Storage*"><span property="articleSection">Storage*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-use-bucket-policies-and-apply-defense-in-depth-to-help-secure-your-amazon-s3-data/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7392" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7392&amp;disqus_title=How+to+Use+Bucket+Policies+and+Apply+Defense-in-Depth+to+Help+Secure+Your+Amazon+S3+Data&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-use-bucket-policies-and-apply-defense-in-depth-to-help-secure-your-amazon-s3-data/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7392');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Amazon S3 provides comprehensive security and compliance capabilities that meet even the most stringent regulatory requirements. It gives you flexibility in the way you manage data for cost optimization, access control, and compliance. However, because the service is flexible, a user could accidentally configure buckets in a manner that is not secure. For example, let’s say you uploaded files to an Amazon S3 bucket with public read permissions, even though you intended only to share this file with a colleague or a partner. Although this might have accomplished your task to share the file internally, the file is now available to anyone on the internet, even without authentication.</p> 
<p>In this blog post, we show you how to prevent your Amazon S3 buckets and objects from allowing public access. We discuss how to secure data in Amazon S3 with a <a title="undefined" href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)" target="_blank" rel="noopener noreferrer">defense-in-depth</a> approach, where multiple security controls are put in place to help prevent data leakage. This approach helps prevent you from allowing public access to confidential information, such as personally identifiable information (PII) or protected health information (PHI).</p> 
<b>Preventing your Amazon S3 buckets and objects from allowing public access</b> 
<p>Every call to an Amazon S3 service becomes a <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html" target="_blank" rel="noopener noreferrer">REST API request</a>. When your request is transformed via a REST call, the permissions are converted into parameters included in the HTTP header or as URL parameters. The Amazon S3 bucket policy allows or denies access to the Amazon S3 bucket or Amazon S3 objects based on policy statements, and then evaluates conditions based on those parameters. To learn more, see <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/using-iam-policies.html" target="_blank" rel="noopener noreferrer">Using Bucket Policies and User Policies</a>.</p> 
<p>With this in mind, let’s say multiple <a title="undefined" href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) users at Example Corp. have access to an Amazon S3 bucket and the objects in the bucket. Example Corp. wants to share the objects among its IAM users, while at the same time preventing the objects from being made available publicly.</p> 
<p>To demonstrate how to do this, we start by creating an Amazon S3 bucket named <code>examplebucket</code>. After creating this bucket, we must apply the following bucket policy. This policy denies any uploaded object (<code>PutObject</code>) with the attribute <code>x-amz-acl</code> having the values <code>public-read</code>, <code>public-read-write</code>, or <code>authenticated-read</code>. This means authenticated users cannot upload objects to the bucket if the objects have public permissions.</p> 
<code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;DenyPublicReadACL&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: [
&quot;s3:PutObject&quot;,
&quot;s3:PutObjectAcl&quot;
],
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket/*&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;s3:x-amz-acl&quot;: [
&quot;public-read&quot;,
&quot;public-read-write&quot;,
&quot;authenticated-read&quot;
]
}
}
},
{
&quot;Sid&quot;: &quot;DenyPublicReadGrant&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: [
&quot;s3:PutObject&quot;,
&quot;s3:PutObjectAcl&quot;
],
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket/*&quot;,
&quot;Condition&quot;: {
&quot;StringLike&quot;: {
&quot;s3:x-amz-grant-read&quot;: [
&quot;*http://acs.amazonaws.com/groups/global/AllUsers*&quot;,
&quot;*http://acs.amazonaws.com/groups/global/AuthenticatedUsers*&quot;
]
}
}
},
{
&quot;Sid&quot;: &quot;DenyPublicListACL&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: &quot;s3:PutBucketAcl&quot;,
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;s3:x-amz-acl&quot;: [
&quot;public-read&quot;,
&quot;public-read-write&quot;,
&quot;authenticated-read&quot;
]
}
}
},
{
&quot;Sid&quot;: &quot;DenyPublicListGrant&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: &quot;s3:PutBucketAcl&quot;,
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket&quot;,
&quot;Condition&quot;: {
&quot;StringLike&quot;: {
&quot;s3:x-amz-grant-read&quot;: [
&quot;*http://acs.amazonaws.com/groups/global/AllUsers*&quot;,
&quot;*http://acs.amazonaws.com/groups/global/AuthenticatedUsers*&quot;
]
}
}
}
]
}
</code> 
<p>To better understand what is happening in this bucket policy, we’ll explain each statement. Let’s start with the first statement.</p> 
<code class="lang-text">
{
&quot;Sid&quot;: &quot;DenyPublicReadACL&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: [
&quot;s3:PutObject&quot;,
&quot;s3:PutObjectAcl&quot;
],
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket/*&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;s3:x-amz-acl&quot;: [
&quot;public-read&quot;,
&quot;public-read-write&quot;,
&quot;authenticated-read&quot;
]
}
}
}
</code> 
<p>This statement accomplishes the following:</p> 
<blockquote> 
<p>“Deny any Amazon S3 request to <code>PutObject</code> or <code>PutObjectAcl</code> in the bucket <code>examplebucket</code> when the request includes one of the following access control lists (ACLs): <code>public-read</code>, <code>public-read-write</code>, or <code>authenticated-read</code>.”</p> 
</blockquote> 
<p>Remember that <a title="undefined" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html#policy-eval-denyallow" target="_blank" rel="noopener noreferrer">IAM policies are evaluated</a> not in a first-match-and-exit model. Instead, IAM evaluates first if there is an explicit Deny. If there is not, IAM continues to evaluate if you have an explicit Allow and then you have an implicit Deny.</p> 
<p>The above policy creates an explicit Deny. Even when any authenticated user tries to upload (<code>PutObject</code>) an object with public read or write permissions, such as <code>public-read</code> or <code>public-read-write</code> or <code>authenticated-read</code>, the action will be denied. To understand how S3 Access Permissions work, you must understand what <strong>Access Control Lists</strong> (ACL) and <strong>Grants</strong> are. You can find the documentation <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html" target="_blank" rel="noopener noreferrer">here</a>.</p> 
<p>Now let’s continue our bucket policy explanation by examining the next statement.</p> 
<code class="lang-text">{
&quot;Sid&quot;: &quot;DenyPublicReadGrant&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: [
&quot;s3:PutObject&quot;,
&quot;s3:PutObjectAcl&quot;
],
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket/*&quot;,
&quot;Condition&quot;: {
&quot;StringLike&quot;: {
&quot;s3:x-amz-grant-read&quot;: [
&quot;*http://acs.amazonaws.com/groups/global/AllUsers*&quot;,
&quot;*http://acs.amazonaws.com/groups/global/AuthenticatedUsers*&quot;
]
}
}
}
</code> 
<p>This statement is very similar to the first statement, except that instead of checking the ACLs, we are checking specific user groups’ grants that represent the following groups:</p> 
<li><strong>AuthenticatedUsers group</strong>. Represented by <code>http://acs.amazonaws.com/groups/global/AuthenticatedUsers</code>, this group represents all AWS accounts. Access permissions to this group allow any AWS account to access the resource. However, all requests must be signed (authenticated).</li> 
<li><strong>AllUsers group</strong>. Represented by <code>http://acs.amazonaws.com/groups/global/AllUsers</code>, access permissions to this group allow anyone on the internet access to the resource. The requests can be signed (authenticated) or unsigned (anonymous). Unsigned requests omit the <code>Authentication</code> header in the request.</li> 
<p>For more information about which parameters you can use to create bucket policies, see <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/using-iam-policies.html" target="_blank" rel="noopener noreferrer">Using Bucket Policies and User Policies</a>.</p> 
<p>Now that you know how to deny object uploads with permissions that would make the object public, you just have two statement policies that prevent users from changing the bucket permissions (Denying s3:PutBucketACL from ACL and Denying s3:PutBucketACL from Grants).</p> 
<p>Below is how we’re preventing users from changing the bucket permisssions.</p> 
<code class="lang-text">{
&quot;Sid&quot;: &quot;DenyPublicListACL&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: &quot;s3:PutBucketAcl&quot;,
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;s3:x-amz-acl&quot;: [
&quot;public-read&quot;,
&quot;public-read-write&quot;,
&quot;authenticated-read&quot;
]
}
}
},
{
&quot;Sid&quot;: &quot;DenyPublicListGrant&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: {
&quot;AWS&quot;: &quot;*&quot;
},
&quot;Action&quot;: &quot;s3:PutBucketAcl&quot;,
&quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket&quot;,
&quot;Condition&quot;: {
&quot;StringLike&quot;: {
&quot;s3:x-amz-grant-read&quot;: [
&quot;*http://acs.amazonaws.com/groups/global/AllUsers*&quot;,
&quot;*http://acs.amazonaws.com/groups/global/AuthenticatedUsers*&quot;
]
}
}
}
</code> 
<p>As you can see above, the statement is very similar to the Object statements, except that now we use <code>s3:PutBucketAcl</code> instead of <code>s3:PutObjectAcl</code>, the Resource is just the bucket ARN, and the objects have the “<code>/*</code>” in the end of the ARN.</p> 
<p>In this section, we showed how to prevent IAM users from accidently uploading Amazon S3 objects with public permissions to buckets. In the next section, we show you how to enforce multiple layers of security controls, such as encryption of data at rest and in transit while serving traffic from Amazon S3.</p> 
<b>Securing data on Amazon S3 with defense-in-depth</b> 
<p>Let’s say that Example Corp. wants to serve files securely from Amazon S3 to its users with the following requirements:</p> 
<li>The data must be encrypted at rest and during transit.</li> 
<li>The data must be accessible only by a limited set of public IP addresses.</li> 
<li>All requests for data should be handled only by <a title="undefined" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> (which is a content delivery network) instead of being directly available from an Amazon S3 URL. If you’re using an Amazon S3 bucket as the origin for a CloudFront distribution, you can grant public permission to read the objects in your bucket. This allows anyone to access your objects either through CloudFront or the Amazon S3 URL. CloudFront doesn’t expose Amazon S3 URLs, but your users still might have access to those URLs if your application serves any objects directly from Amazon S3, or if anyone gives out direct links to specific objects in Amazon S3.</li> 
<li>A domain name is required to consume the content. Custom SSL certificate support lets you deliver content over HTTPS by using your own domain name and your own SSL certificate. This gives visitors to your website the security benefits of CloudFront over an SSL connection that uses your own domain name, in addition to lower latency and higher reliability.</li> 
<p>To represent defense-in-depth visually, the following diagram contains several Amazon S3 objects (A) in a single Amazon S3 bucket (B). You can encrypt these objects on the server side or the client side. You also can configure the bucket policy such that objects are accessible only through CloudFront, which you can accomplish through an <a title="undefined" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html" target="_blank" rel="noopener noreferrer">origin access identity</a> (C). You then can configure CloudFront to deliver content only over HTTPS in addition to using your own domain name (D).</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/bucket_policies_defense_s3.43e6c93a095f2f55b33b30276f4782ab9ec79f47.png" /></p> 
<b>Defense-in-depth requirement 1: Data must be encrypted at rest and during transit</b> 
<p>Let’s start with the objects themselves. Amazon S3 objects—files in this case—can range from zero bytes to multiple terabytes in size (see <a title="undefined" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UploadingObjects.html" target="_blank" rel="noopener noreferrer">service limits</a> for the latest information). Each Amazon S3 bucket includes a collection of objects, and the objects can be uploaded via the Amazon S3 console, <a title="undefined" href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS CLI</a>, or <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html" target="_blank" rel="noopener noreferrer">AWS API</a>.</p> 
<p>You can encrypt Amazon S3 objects at rest and during transit. At rest, objects in a bucket are encrypted with <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingServerSideEncryption.html" target="_blank" rel="noopener noreferrer">server-side encryption</a> by using <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingServerSideEncryption.html" target="_blank" rel="noopener noreferrer">Amazon S3 managed keys</a> or AWS Key Management Service (AWS KMS) <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html" target="_blank" rel="noopener noreferrer">managed keys</a> or <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html" target="_blank" rel="noopener noreferrer">customer-provided</a> keys through AWS KMS. You also can encrypt objects on the <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingClientSideEncryption.html" target="_blank" rel="noopener noreferrer">client side</a> by using AWS KMS managed keys or a customer-supplied <a title="undefined" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingClientSideEncryptionUpload.html" target="_blank" rel="noopener noreferrer">client-side master key</a>.</p> 
<p>If you choose to use server-side encryption, Amazon S3 encrypts your objects before saving them on disks in AWS data centers. To encrypt an object at the time of upload, you need to add the <code>x-amz-server-side-encryption</code> header to the request to tell Amazon S3 to encrypt the object using Amazon S3 managed keys (SSE-S3), AWS KMS managed keys (SSE-KMS), or customer-provided keys (SSE-C). There are two possible values for the <code>x-amz-server-side-encryption</code> header: <code>AES256</code>, which tells Amazon S3 to use Amazon S3 managed keys, and <code>aws:kms</code>, which tells Amazon S3 to use AWS KMS managed keys.</p> 
<p>The following code example shows a <code>Put</code> request using SSE-S3.</p> 
<code class="lang-text">PUT /example-object HTTP/1.1
Host: myBucket.s3.amazonaws.com
Date: Wed, 8 Jun 2016 17:50:00 GMT
Authorization: authorization string
Content-Type: text/plain
Content-Length: 11434
x-amz-meta-author: Janet
Expect: 100-continue
x-amz-server-side-encryption: AES256
[11434 bytes of object data]
</code> 
<p>If you choose to use client-side encryption, you can encrypt data on the client side and upload the encrypted data to Amazon S3. In this case, you manage the encryption process, the encryption keys, and related tools. You encrypt data on the client side by using AWS KMS managed keys or a customer-supplied, client-side master key.</p> 
<b>Defense-in-depth requirement 2: Data must be accessible only by a limited set of public IP addresses</b> 
<p>At the Amazon S3 bucket level, you can configure permissions through a bucket policy. For example, you can limit access to the objects in a bucket by IP address range or specific IP addresses. Alternatively, you can make the objects accessible only through HTTPS.</p> 
<p>The following bucket policy allows access to Amazon S3 objects only through HTTPS (the policy was generated with the <a title="undefined" href="http://awspolicygen.s3.amazonaws.com/policygen.html" target="_blank" rel="noopener noreferrer">AWS Policy Generator</a>). Here the bucket policy explicitly denies (<code>&quot;Effect&quot;: &quot;Deny&quot;</code>) all read access (<code>&quot;Action&quot;: &quot;s3:GetObject&quot;</code>) from anybody who browses (<code>&quot;Principal&quot;: &quot;*&quot;</code>) to Amazon S3 objects within an Amazon S3 bucket if they are not accessed through HTTPS (<code>&quot;aws:SecureTransport&quot;: &quot;false&quot;</code>).</p> 
<code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Id&quot;: &quot;Policy1504640911349&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;Stmt1504640908907&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Action&quot;: &quot;s3:GetObject&quot;,
&quot;Resource&quot;: &quot;arn:aws:s3:::/*&quot;,
&quot;Condition&quot;: {
&quot;Bool&quot;: {
&quot;aws:SecureTransport&quot;: &quot;false&quot;
}
}
}
]
}
</code> 
<b>Defense-in-depth requirement 3: Data must not be publicly accessible directly from an Amazon S3 URL</b> 
<p>Next, configure <a title="undefined" href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> to serve traffic from within the bucket. The use of CloudFront serves several purposes:</p> 
<li>CloudFront is a content delivery network that acts as a cache to serve static files quickly to clients.</li> 
<li>Depending on the number of requests, the cost of delivery is less than if objects were served directly via Amazon S3.</li> 
<li>Objects served through CloudFront can be limited to specific countries.</li> 
<p>Access to these Amazon S3 objects is available only through CloudFront. We do this by creating an <a title="undefined" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html" target="_blank" rel="noopener noreferrer">origin access identity</a> (OAI) for CloudFront and granting access to objects in the respective Amazon S3 bucket only to that OAI. As a result, access to Amazon S3 objects from the internet is possible only through CloudFront; all other means of accessing the objects—such as through an Amazon S3 URL—are denied. CloudFront acts not only as a content distribution network, but also as a host that denies access based on geographic restrictions. You apply these restrictions by updating your CloudFront web distribution and adding a whitelist that contains only a specific country’s name (let’s say Liechtenstein). Alternatively, you could add a blacklist that contains every country except that country. Learn more about how to use CloudFront geographic restriction to whitelist or blacklist a country to restrict or allow users in specific locations from accessing web content in the <a title="undefined" href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudfront-geo-restriction/" target="_blank" rel="noopener noreferrer">AWS Support Knowledge Center</a>.</p> 
<b>Defense-in-depth requirement 4: A domain name is required to consume the content</b> 
<p>To serve content from CloudFront, you must use a domain name in the URLs for objects on your webpages or in your web application. The domain name can be either of the following:</p> 
<li>The domain name that CloudFront automatically assigns when you create a distribution, such as <code>d111111abcdef8.cloudfront.net</code></li> 
<li>Your own domain name, such as <code>example.com</code></li> 
<p>For example, you might use one of the following URLs to return the file image.jpg:</p> 
<li>http://d111111abcdef8.cloudfront.net/images/image.jpg</li> 
<li>http://example.com/images/image.jpg</li> 
<p>You use the same URL format whether you store the content in Amazon S3 buckets or at a custom origin, like one of your own web servers.</p> 
<p>Instead of using the default domain name that CloudFront assigns for you when you create a distribution, you can <a title="undefined" href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesCNAME" target="_blank" rel="noopener noreferrer">add an alternate domain name</a> that’s easier to work with, like <code>example.com</code>. By setting up your own domain name with CloudFront, you can use a URL like this for objects in your distribution: <code>http://example.com/images/image.jpg</code>.</p> 
<p>Let’s say that you already have a domain name hosted on <a title="undefined" href="https://aws.amazon.com/route53/" target="_blank" rel="noopener noreferrer">Amazon Route 53</a>. You would like to serve traffic from the domain name, request an SSL certificate, and add this to your CloudFront web distribution. The <a title="undefined" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-viewers-to-cloudfront.html" target="_blank" rel="noopener noreferrer">SSL offloading</a> occurs in CloudFront by serving traffic securely from each CloudFront location. You also can <a title="undefined" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-cloudfront-walkthrough.html" target="_blank" rel="noopener noreferrer">configure CloudFront</a> to deliver your content over <a title="undefined" href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-https-viewers-to-cloudfront.html" target="_blank" rel="noopener noreferrer">HTTPS</a> by using your custom domain name and your own <a title="undefined" href="https://aws.amazon.com/blogs/aws/new-aws-certificate-manager-deploy-ssltls-based-apps-on-aws/" target="_blank" rel="noopener noreferrer">SSL certificate</a>. Serving web content through CloudFront reduces response from the origin as requests are redirected to the nearest edge location. This results in faster download times than if the visitor had requested the content from a data center that is located farther away.</p> 
<b>Summary</b> 
<p>In this post, we demonstrated how you can apply policies to Amazon S3 buckets so that only users with appropriate permissions are allowed to access the buckets. Anonymous users (with public-read/public-read-write permissions) and authenticated users without the appropriate permissions are prevented from accessing the buckets.</p> 
<p>We also examined how to secure access to objects in Amazon S3 buckets. The objects in Amazon S3 buckets can be encrypted at rest and during transit. Doing so helps provide end-to-end security from the source (in this case, Amazon S3) to your users.</p> 
<p>If you have feedback about this blog post, submit comments in the “Comments” section below. If you have questions about this blog post, start a new thread on the <a title="undefined" href="https://forums.aws.amazon.com/forum.jspa?forumID=24" target="_blank" rel="noopener noreferrer">Amazon S3 forum</a> or contact <a title="undefined" href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">AWS Support</a>.</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7392');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/23/federated_auth_with_adfs_1-1.png" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Federated Authentication with Active Directory Federation Services (AD FS)</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Kevin Higgins</span></span> | on 
<time property="datePublished" datetime="2018-03-02T16:20:07+00:00">02 MAR 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/developer-tools/aws-command-line-interface/" title="View all posts in AWS Command Line Interface*"><span property="articleSection">AWS Command Line Interface*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/" title="View all posts in Security, Identity, &amp; Compliance*"><span property="articleSection">Security, Identity, &amp; Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-federated-authentication-with-active-directory-federation-services-ad-fs/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7338" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7338&amp;disqus_title=AWS+Federated+Authentication+with+Active+Directory+Federation+Services+%28AD+FS%29&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-federated-authentication-with-active-directory-federation-services-ad-fs/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7338');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Today we’d like to walk you through AWS Identity and Access Management (IAM), federated sign-in through Active Directory (AD) and Active Directory Federation Services (ADFS). With IAM, you can centrally manage users, security credentials such as access keys, and permissions that control which resources users can access. Customers have the option of creating users and group objects within IAM or they can utilize a third-party federation service to assign external directory users access to AWS resources. To streamline the administration of user access in AWS, organizations can utilize a federated solution with an external directory, allowing them to minimize administrative overhead. Benefits of this approach include leveraging existing passwords and password policies, roles and groups. This guide provides a walk-through on how to automate the federation setup across multiple accounts/roles with an Active Directory backing identity store. This will establish the minimum baseline for the authentication architecture, including the initial IdP deployment and elements for federation.</p> 
<p><span style="text-decoration: underline"><strong>ADFS Federated Authentication Process</strong></span></p> 
<p>The following describes the process a user will follow to authenticate to AWS using Active Directory and ADFS as the identity provider and identity brokers:</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_25.dc86ecbfbbf80af3f553e7374d2a55ad1afb7016.png" /></p> 
<ol> 
<li>Corporate user accesses the corporate Active Directory Federation Services portal sign-in page and provides Active Directory authentication credentials.</li> 
<li>AD FS authenticates the user against Active Directory.</li> 
<li>Active Directory returns the user’s information, including AD group membership information.</li> 
<li>AD FS dynamically builds ARNs by using Active Directory group memberships for the IAM roles and user attributes for the AWS account IDs, and sends a signed assertion to the users browser with a redirect to post the assertion to AWS STS.</li> 
<li>Temporary credentials are returned using STS AssumeRoleWithSAML.</li> 
<li>The user is authenticated and provided access to the AWS management console.</li> 
</ol> 
<p><span style="text-decoration: underline"><strong>Configuration Steps</strong></span></p> 
<p>Configuration requires setup in the Identity Provider store (e.g. Active Directory), the identity broker (e.g. Active Directory Federation Services), and AWS. It is possible to configure AWS to federate authentication using a variety of third-party SAML 2.0 compliant identity providers, more information can be <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_saml_3rd-party.html">found here</a>.</p> 
<p><span style="text-decoration: underline"><strong>AWS Configuration</strong></span></p> 
<p>The configuration steps outlined in this document can be completed to enable federated access to multiple AWS accounts, facilitating a single sign on process across a multi-account AWS environment. Access can also be provided to multiple roles in each AWS account. The roles available to a user are based on their group memberships in the identity provider (IdP). In a multi-role and/or multi-account scenario, role assumption requires the user to select the account and role they wish to assume during the authentication process.</p> 
<p><span style="text-decoration: underline"><strong>Identity Provider</strong></span></p> 
<p>A SAML 2.0 identity provider is an IAM resource that describes an identity provider (IdP) service that supports the <a href="https://wiki.oasis-open.org/security">SAML 2.0 (Security Assertion Markup Language 2.0)</a> standard. AWS SAML identity provider configurations can be used to establish trust between AWS and SAML-compatible identity providers, such as Shibboleth or Microsoft Active Directory Federation Services. These enable users in an organization to access AWS resources using existing credentials from the identity provider.</p> 
<p>A SAML identify provider can be configured using the AWS console by completing the following steps.</p> 
<p>1. Access the “Identity Providers” section of the AWS IAM console at the following URL: <a href="https://console.aws.amazon.com/iam/home?region=us-east-1#/providers">https://console.aws.amazon.com/iam/home?region=us-east-1#/providers</a>. Click on the “Create Provider” button.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_2.3a1032e31a5de83c858ee1810b1a6842830538b3.png" /></p> 
<p>2. Select SAML for the provider type. Select a provider name of your choosing (this will become the logical name used in the identity provider ARN). Lastly, download the FederationMetadata.xml file from your ADFS server to your client system file (https://yourADFSserverFQDN/FederationMetadata/2007-06/FederationMetadata.xml). Click “Choose File” and upload it to AWS.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_3.8b3a464702bc5a12d2ca84342040b86575eabb06.png" /></p> 
<p>3. Click “Next Step” and then verify the information you have entered. Click “Create” to complete the AWS identity provider configuration process.</p> 
<p><strong>IAM Role Naming Convention for User Access</strong><br /> Once the AWS identity provider configuration is complete, it is necessary to create the roles in AWS that federated users can assume via SAML 2.0. An IAM role is an AWS identity with permission policies that determine what the identity can and cannot do in AWS. In a federated authentication scenario, users (as defined in the IdP) assume an AWS role during the sign-in process. A role should be defined for each access delineation that you wish to define. For example, create a role for each line of business (LOB), or each function within a LOB. Each role will then be assigned a set of policies that define what privileges the users who will be assuming that role will have.</p> 
<p>The following steps detail how to create a single role. These steps should be completed multiple times to enable assumption of different roles within AWS, as required.</p> 
<p>1. Access the “Roles” section of the AWS IAM console at the following URL: <a href="https://console.aws.amazon.com/iam/home?region=us-east-1#/roles">https://console.aws.amazon.com/iam/home?region=us-east-1#/roles</a>. Click on the “Create Role” button.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_4.b66327250fe514d1522d9dafba2ec8a77de0725f.png" /></p> 
<p>2. Select “SAML” as the trusted entity type. Click Next Step.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_5.69a994ecc1645a52e53648efaae211cdfcfaa55a.png" /></p> 
<p>3. Select your previously created identity provider. Click Next: Permissions.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_6.d5efa7a6b3f8b6e01f1dd9b80c2d2d42d021a2e2.png" /></p> 
<p>4. The next step requires selection of policies that represent the desired permissions the user should obtain in AWS, once they have authenticated and successfully assumed the role. This can be either a custom policy or preferably an AWS managed policy. AWS recommends leveraging existing <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_job-functions.html">AWS access policies for job functions</a> for common levels of access. For example, the “Billing” AWS Managed policy should be utilized to provide financial analyst access to AWS billing and cost information.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_7.ef4226b439e98c4ecbe39c96479c7cb1388a4362.png" /></p> 
<p>5.&nbsp;Provide a name for your role. All roles should be created with the prefix ADFS-&lt;rolename&gt; to simplify the identification of roles in AWS that are accessed through the federated authentication process. Next click, “Create Role”.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_8.75deb2c2ef9ab7528e95185865044e1dc09bbb11.png" /></p> 
<p><span style="text-decoration: underline"><strong>Active Directory Configuration</strong></span></p> 
<p>Determining how you will create and delineate your AD groups and IAM roles in AWS is crucial to how you secure access to your account and manage resources. SAML assertions to the AWS environment and the respective IAM role access will be managed through regular expression (regex) matching between your on-premises AD group name to an AWS IAM role.</p> 
<p>One approach for creating the AD groups that uniquely identify the AWS IAM role mapping is by selecting a common group naming convention. For example, your AD groups would start with an identifier, for example AWS-, as this will distinguish your AWS groups from others within the organization. Next, include the 12-digit AWS account number. Finally, add the matching role name within the AWS account. Here is an example:</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_9.8631e991b7762154a86c95050781fa2e40d169c4.png" /></p> 
<p>You should do this for each role and corresponding AWS account you wish to support with federated access. Users in Active Directory can subsequently be added to the groups, providing the ability to assume access to the corresponding roles in AWS. If a user is associated with multiple Active Directory groups and AWS accounts, they will see a list of roles by AWS account and will have the option to choose which role to assume. A user will not be able to assume more than one role at a time, but has the ability to switch between them as needed.</p> 
<p>Note: Microsoft imposes a limit on the number of groups a user can be a member of (approximately 1,015 groups) due to the size limit for the access token that is created for each security principal. This limitation, however, is not affected by how the groups may or may not be nested.</p> 
<p><span style="text-decoration: underline"><strong>Active Directory Federation Services Configuration</strong></span></p> 
<p>ADFS federation occurs with the participation of two parties; the identity or claims provider (in this case the owner of the identity repository – Active Directory) and the relying party, which is another application that wishes to outsource authentication to the identity provider; in this case Amazon Secure Token Service (STS). The relying party is a federation partner that is represented by a claims provider trust in the federation service.</p> 
<p><span style="text-decoration: underline"><strong>Relying Party</strong></span></p> 
<p>You can configure a new relying party in Active Directory Federation Services by doing the following.</p> 
<p>1. From the ADFS Management Console, right-click ADFS and select Add Relying Party Trust.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_10.9fd79859843b0f010de321d51f35f5a94dc5c2e0.png" /></p> 
<p>2. In the Add Relying Party Trust Wizard, click Start.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_11.09329982f8db9c655a025040b6e1586d09b309a9.png" /></p> 
<p>3. Check Import data about the relying party published online or on a local network, enter<br /> https://signin.aws.amazon.com/static/saml-metadata.xml, and then click Next. The metadata XML file is a standard SAML metadata document that describes AWS as a relying party.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_12.4932a319727e7185476763684ab525cb38373e2f.png" /></p> 
<p>Note: SAML federations use metadata documents to maintain information about the public keys and certificates that each party utilizes. At run time, each member of the federation can then use this information to validate that the cryptographic elements of the distributed transactions come from the expected actors and haven’t been tampered with. Since these metadata documents do not contain any sensitive cryptographic material, AWS publishes federation metadata at <a href="https://signin.aws.amazon.com/static/saml-metadata.xml">https://signin.aws.amazon.com/static/saml-metadata.xml</a></p> 
<p>4. Set the display name for the relying party and then click Next.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_13.185958f6c7870d9b6144b06a274d6049a64b062d.png" /></p> 
<p>5. We will not choose to enable/configure the MFA settings at this time.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_14.f8d6fdb15f19bcd1f1b4557e429b31802d03c091.png" /></p> 
<p>6. Select “Permit all users to access this relying party” and click Next.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_15.0e4626b25a2a85532da8c1497b7d02ce9baa01dc.png" /></p> 
<p>7. Review your settings and then click Next.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_16.e5bbe2e02c7b0bcc73cdd4fee9e5d3840e30eff2.png" /></p> 
<p>8. Choose Close on the Finish page to complete the Add Relying Party Trust Wizard. AWS is now configured as a relying party.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_26.png.01e599495877e5ad0aa2eba234bee6f83c90a32e.jpg" /></p> 
<p><span style="text-decoration: underline"><strong>Custom Claim Rules</strong></span></p> 
<p>Microsoft Active Directory Federation Services (AD FS) uses Claims Rule Language to issue and transform claims between claims providers and relying parties. A claim is information about a user from a trusted source. The trusted source is asserting that the information is true, and that source has authenticated the user in some manner. The claims provider is the source of the claim. This can be information pulled from an attribute store such as Active Directory (AD). The relying party is the destination for the claims, in this case AWS.</p> 
<p>AD FS provides administrators with the option to define custom rules that they can use to determine the behavior of identity claims with the claim rule language. The Active Directory Federation Services (AD FS) claim rule language acts as the administrative building block to help manage the behavior of incoming and outgoing claims. There are four claim rules that need to be created to effectively enable Active Directory users to assume roles in AWS based on group membership in Active Directory.</p> 
<p>Right-click on the relying party (in this case Amazon Web Services) and then click Edit Claim Rules</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_19.594240ea64134bc2c79239d9aba7f7de572df07b.png" /></p> 
<p>Here are the steps used to create the claim rules for NameId, RoleSessionName, Get AD Groups and Roles.</p> 
<p>1. NameId</p> 
<p style="margin-left: 5%;margin-right: 5%">a) In the Edit Claim Rules for &lt;relying party&gt; dialog box, click Add Rule.<br /> b) Select Transform an Incoming Claim and then click Next.<br /> c) Use the following settings:</p> 
<p style="margin-left: 10%;margin-right: 10%">i) Claim rule name: NameId<br /> ii) Incoming claim type: Windows Account Name<br /> iii) Outgoing claim type: Name ID<br /> iv) Outgoing name ID format: Persistent Identifier<br /> v) Pass through all claim values: checked</p> 
<p style="margin-left: 5%;margin-right: 5%">d) Click OK.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_20.982922cd43adf189967386acfb3feb380d6a4de2.png" /></p> 
<p>Rule language:<br /> <code>c:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;]<br /> =&gt; issue(Type = &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier&quot;, Issuer = c.Issuer, OriginalIssuer = c.OriginalIssuer, Value = c.Value, ValueType = c.ValueType, Properties[&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claimproperties/format&quot;] = &quot;urn:oasis:names:tc:SAML:2.0:nameid-format:persistent&quot;);</code></p> 
<p>2. RoleSessionName</p> 
<p style="margin-left: 5%;margin-right: 5%">a) Click Add Rule<br /> b) In the Claim rule template list, select Send LDAP Attributes as Claims.<br /> c) Use the following settings:</p> 
<p style="margin-left: 10%;margin-right: 10%">i) Claim rule name: RoleSessionName<br /> ii) Attribute store: Active Directory<br /> iii) LDAP Attribute: E-Mail-Addresses<br /> iv) Outgoing Claim Type: https://aws.amazon.com/SAML/Attributes/RoleSessionName</p> 
<p style="margin-left: 5%;margin-right: 5%">d) Click OK</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_21.f184e9d25b5213e26499c647704cb60022d05003.png" /></p> 
<p>Rule language:<br /> <code>c:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;, Issuer == &quot;AD AUTHORITY&quot;]<br /> =&gt; issue(store = &quot;Active Directory&quot;, types = (&quot;https://aws.amazon.com/SAML/Attributes/RoleSessionName&quot;), query = &quot;;mail;{0}&quot;, param = c.Value);</code></p> 
<p>3. Get AD Groups</p> 
<p style="margin-left: 5%;margin-right: 5%">a) Click Add Rule.<br /> b) In the Claim rule template list, select Send Claims Using a Custom Rule and then click Next.<br /> c) For Claim Rule Name, select Get AD Groups, and then in Custom rule, enter the following:</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_22.6274a5dddac2a7f58315f2c0cc3fc4f0a69b9505.png" /></p> 
<p>Rule language:<br /> <code>c:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;, Issuer == &quot;AD AUTHORITY&quot;]<br /> =&gt; add(store = &quot;Active Directory&quot;, types = (&quot;http://temp/variable&quot;), query = &quot;;tokenGroups;{0}&quot;, param = c.Value);</code></p> 
<p>This custom rule uses a script in the claim rule language that retrieves all the groups the authenticated user is a member of and places them into a temporary claim named http://temp/variable. Think of this as a variable you can access later.</p> 
<p>Note: Ensure there’s no trailing whitespace to avoid unexpected results.</p> 
<p>4. Role Attributes</p> 
<p style="margin-left: 5%;margin-right: 5%">a) Unlike the two previous claims, here we used custom rules to send role attributes. This is done by retrieving all the authenticated user’s AD groups and then matching the groups that start with to IAM roles of a similar name. I used the names of these groups to create Amazon Resource Names (ARNs) of IAM roles in my AWS account (i.e., those that start with AWS-). Sending role attributes requires two custom rules. The first rule retrieves all the authenticated user’s AD group memberships and the second rule performs the transformation to the roles claim.</p> 
<p style="margin-left: 10%;margin-right: 10%">i) Click Add Rule.<br /> ii) In the Claim rule template list, select Send Claims Using a Custom Rule and then click Next.<br /> iii) For Claim Rule Name, enter Roles, and then in Custom rule, enter the following:</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_23.99bb0356c4f02c4cdb9f91888490bf6210bca0cc.png" /></p> 
<p>Rule language:<br /> <code>c:[Type == &quot;http://temp/variable&quot;, Value =~ &quot;(?i)^AWS-([\d]{12})&quot;] =&gt; issue(Type = &quot;https://aws.amazon.com/SAML/Attributes/Role&quot;, Value = RegExReplace(c.Value, &quot;AWS-([\d]{12})-&quot;, &quot;arn:aws:iam::$1:saml-provider/idp1,arn:aws:iam::$1:role/&quot;));</code></p> 
<p>This custom rule uses regular expressions to transform each of the group memberships of the form AWS-&lt;Account Number&gt;-&lt;Role Name&gt; into in the IAM role ARN, IAM federation provider ARN form AWS expects.</p> 
<p>Note: In the example rule language above idp1 represents the logical name given to the SAML identity provider in the AWS identity provider setup. Please change this based on the logical name you chose in the IAM console for your identity provider.</p> 
<p><span style="text-decoration: underline"><strong>Adjusting Session Duration</strong></span></p> 
<p>By default, the temporary credentials that are issued by AWS IAM for SAML federation are valid for an hour. Depending on your organizations security stance, you may wish to adjust. You can allow your federated users to work in the AWS Management Console for up to 12 hours. This can be accomplished by adding another claim rule in your ADFS configuration. To add the rule, do the following:</p> 
<p style="margin-left: 5%;margin-right: 5%">1. Access ADFS Management Tool on your ADFS Server.<br /> 2. Choose Relying Party Trusts, then select your AWS Relying Party configuration.<br /> 3. Choose Edit Claim Rules.<br /> 4. Choose Add Rule to configure a new rule, and then choose Send claims using a custom rule. Finally, choose Next.<br /> 5. Name your Rule “Session Duration” and add the following rule syntax.<br /> 6. Adjust the value of 28800 seconds (8 hours) as appropriate.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/federated_auth_with_adfs_24.edae1e081bc5baeb1979fc2b398f29a81e35607c.png" /></p> 
<p>Rule language:<br /> <code>=&gt; issue(Type = &quot;https://aws.amazon.com/SAML/Attributes/SessionDuration&quot;, Value = &quot;28800&quot;);</code></p> 
<p>Note: AD FS 2012 R2 and AD FS 2016 tokens have a sixty-minute validity period by default. This value is configurable on a per-relying party trust basis. In addition to adding the “Session Duration” claim rule, you will also need to update the security token created by AD FS. To update this value, run the following command:</p> 
<p><code>Set-ADFSRelyingPartyTrust -TargetName “[Display Name]” -TokenLifetime 480</code></p> 
<p>The Parameter “-TokenLifetime” determines the Lifetime in Minutes. In this example, we set the Lifetime to 480 minutes, eight hours.</p> 
<p>These are the main settings related to session lifetimes and user authentication. Once updated, any new console session your federated users initiate will be valid for the duration specified in the SessionDuration claim.</p> 
<p><span style="text-decoration: underline"><strong>API/CLI Access</strong></span><br /> Access to the AWS API and command-line tools using federated access can be accomplished using techniques in the following blog article:</p> 
<p><a href="https://blogs.aws.amazon.com/security/post/Tx1LDN0UBGJJ26Q/How-to-Implement-Federated-API-and-CLI-Access-Using-SAML-2-0-and-AD-FS">https://blogs.aws.amazon.com/security/post/Tx1LDN0UBGJJ26Q/How-to-Implement-Federated-API-and-CLI-Access-Using-SAML-2-0-and-AD-FS</a></p> 
<p>This will enable your users to access your AWS environment using their domain credentials through the AWS CLI or one of the AWS SDKs.</p> 
<p><span style="text-decoration: underline"><strong>Conclusion</strong></span><br /> In this post, I’ve shown you how to provide identity federation, and thus SSO, to the AWS Management Console for multiple accounts using SAML assertions. With this approach, the AWS Security Token service (STS) will provide temporary credentials (via SAML) for the user to ‘assume’ a role (that they have access to use, as denoted by AD Group membership) that has specific permissions associated; as opposed to providing long-term access credentials to the AWS resources. By adopting this model, you will have a secure and robust IAM approach for accessing AWS resources that align with AWS security best practices.</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7338');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/26/ha_hero_certificate.png" /> 
<b class="lb-b blog-post-title" property="name headline">Preparing for AWS Certificate Manager (ACM) Support of Certificate Transparency</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Jonathan Kozolchyk</span></span> | on 
<time property="datePublished" datetime="2018-02-26T14:27:52+00:00">26 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-certificate-manager/" title="View all posts in AWS Certificate Manager*"><span property="articleSection">AWS Certificate Manager*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-get-ready-for-certificate-transparency/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7278" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7278&amp;disqus_title=Preparing+for+AWS+Certificate+Manager+%28ACM%29+Support+of+Certificate+Transparency&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-get-ready-for-certificate-transparency/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7278');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><img width="100%" src="https://d1.awsstatic.com/Digital%20Marketing/House/Hero/products/certificate-manager/ha_hero_certificate-manager.d0ab7b1a8bb871a42a5651a59b110c528fa83553.png" /></p> 
<p>&nbsp;</p> 
<p><strong>Update from March 27, 2018</strong>: On March 27, 2018, we updated ACM APIs so that you can disable Certificate Transparency logging on a per-certificate basis.</p> 
<hr /> 
<p><a href="https://groups.google.com/a/chromium.org/forum/#!topic/ct-policy/wHILiYf31DE" target="_blank" rel="noopener noreferrer">Starting April 30, 2018</a>, Google Chrome will require all publicly trusted certificates to be logged in at least two <a href="https://www.certificate-transparency.org/" target="_blank" rel="noopener noreferrer">Certificate Transparency</a>&nbsp;logs. This means that any certificate issued that is not logged will result in an error message in Google Chrome. Beginning April 24, 2018, Amazon will log all new and renewed certificates in at least two public logs unless you disable Certificate Transparency logging.</p> 
<p>Without Certificate Transparency, it can be difficult for a domain owner to know if an unexpected certificate was issued for their domain. Under the current system, no record is kept of certificates being issued, and domain owners&nbsp;do not have a reliable way to identify rogue certificates.</p> 
<p>To address this situation, Certificate Transparency creates a cryptographically secure log of each certificate issued. Domain owners can search the log to identify unexpected certificates, whether issued by mistake or malice. Domain owners can also identify Certificate Authorities (CAs) that are improperly issuing certificates. In this blog post, I explain more about Certificate Transparency and tell you how to prepare for it.</p> 
<h3>How does Certificate Transparency work?</h3> 
<p>When a CA issues a publicly trusted certificate, the CA must submit the certificate to one or more Certificate Transparency log servers. The Certificate Transparency log server responds with a signed certificate timestamp (SCT) that confirms the log server will add the certificate to the list of known certificates. The SCT is then embedded in the certificate and delivered automatically to a browser.&nbsp;The SCT is like a receipt that proves the certificate was published into the Certificate Transparency log. Starting April 30, Google Chrome will require an SCT as proof that the certificate was published to a Certificate Transparency log in order to trust the certificate without displaying an error message.</p> 
<h3>What is Amazon doing to support Certificate Transparency?</h3> 
<p>Certificate Transparency is a good practice.&nbsp;It enables AWS customers to be more confident that an unauthorized certificate hasn’t been issued by a CA. Beginning on April 24, 2018, Amazon will log all new and renewed certificates in at least two Certificate Transparency logs unless you disable Certificate Transparency logging.</p> 
<p>We recognize that there can be times when our customers do not want to log certificates. For example, if you are building a website for an unreleased product and have registered the subdomain, <code>newproduct.example.com</code>, requesting a logged certificate for your domain will make it publicly known that the new product is coming. Certificate Transparency logging also can expose server hostnames that you want to keep private.&nbsp;Hostnames such as <code>payments.example.com</code>&nbsp;can reveal the purpose of a server and provide attackers with information about your private network. These logs <strong>do not</strong> contain the private key for your certificate. For these reasons, on March 27, 2018 we updated ACM APIs so that you can disable Certificate Transparency logging on a per-certificate basis using the ACM APIs or with the AWS CLI. Doing so will lead to errors in Google Chrome, which may be preferable to exposing the information.</p> 
<p>Please refer to ACM documentation for specifics on <a href="https://docs.aws.amazon.com/acm/latest/userguide/acm-bestpractices.html#best-practices-transparency" title="undefined" target="_blank">how to opt out of Certificate Transparency logging</a>.</p> 
<h3>Conclusion</h3> 
<p>Beginning April 24, 2018, ACM will begin logging all new and renewed certificates by default. If you don’t want a certificate to be logged, you’ll be able to&nbsp;opt out using the AWS API or CLI. However, for Google Chrome to trust the certificate, all issued or imported certificates must have the SCT information embedded in them by April 30, 2018.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=206">ACM forum</a>.</p> 
<p>– Jonathan</p> 
<p><strong>Interested in additional AWS Security news? Follow the AWS Security Blog <a href="https://twitter.com/AWSsecurityinfo">on Twitter</a>.</strong></p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7278');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/22/sso_user_portal_3-1136x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Single Sign-On Now Enables Command Line Interface Access for AWS Accounts Using Corporate Credentials</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Anand Murugesan</span></span> | on 
<time property="datePublished" datetime="2018-02-22T21:57:27+00:00">22 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/developer-tools/aws-command-line-interface/" title="View all posts in AWS Command Line Interface*"><span property="articleSection">AWS Command Line Interface*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-single-sign-on-sso/" title="View all posts in AWS Single Sign-On (SSO)"><span property="articleSection">AWS Single Sign-On (SSO)</span></a>, <a href="https://aws.amazon.com/blogs/security/category/developer-tools/" title="View all posts in Developer Tools*"><span property="articleSection">Developer Tools*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/" title="View all posts in Security, Identity, &amp; Compliance*"><span property="articleSection">Security, Identity, &amp; Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-single-sign-on-now-enables-command-line-interface-access-for-aws-accounts-using-corporate-credentials/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7301" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7301&amp;disqus_title=AWS+Single+Sign-On+Now+Enables+Command+Line+Interface+Access+for+AWS+Accounts+Using+Corporate+Credentials&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-single-sign-on-now-enables-command-line-interface-access-for-aws-accounts-using-corporate-credentials/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7301');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Today, AWS made it easier to use the <a href="https://aws.amazon.com/cli/">AWS Command Line Interface</a> (CLI) to manage services in your AWS accounts. Now you can sign into the <a href="https://aws.amazon.com/single-sign-on/">AWS Single Sign-On</a> (AWS SSO) user portal using your existing corporate credentials, choose an AWS account and a specific permission set, and get temporary credentials to manage your AWS services through the AWS CLI.</p> 
<p><a href="https://aws.amazon.com/blogs/security/introducing-aws-single-sign-on/">AWS SSO</a> is a service that enables you to centrally manage single sign-on access to multiple AWS accounts and business applications. <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html">AWS temporary security credentials</a> are an easy way to get short-term credentials to manage your AWS services through the AWS CLI or a <a href="https://aws.amazon.com/tools/">programmatic client</a>.</p> 
<p>Previously, when you issued commands from the CLI to access resources in each of several AWS accounts, you had to remember the password for each account, sign in to each AWS account individually, and fetch the credentials for each account one at a time. Now, AWS SSO eliminates the need to sign in to each AWS account individually to get temporary credentials. Instead, you can sign in to the AWS SSO user portal once using your existing corporate credentials and then fetch temporary credentials for any of your authorized AWS accounts to use with the AWS CLI to access the resources in that account, limited by the permissions granted to you.</p> 
<p>In this blog post, I’ll show how to fetch temporary credentials from the AWS SSO user portal to use with the AWS CLI to access resources in your AWS accounts. First, I’ll show you how to obtain short-term credentials for any account for a permission set for which you are authorized. Next, I’ll show you three ways to use these credentials.</p> 
<p>For this scenario, let’s say I am an administrator at “AnyCompany” and I want to list instances in two AWS accounts by using the AWS CLI command, <code>aws ec2 describe-instances</code>. “AnyCompany” has enabled access to AWS accounts through AWS SSO.</p> 
<p><strong>Prerequisites</strong></p> 
<p>You need to install the <a href="https://aws.amazon.com/cli/">AWS CLI</a> to use this feature. You also need to configure AWS SSO, connect a corporate directory, and grant access to users or groups to access AWS accounts with permission sets. To learn more, see, “<a href="https://aws.amazon.com/blogs/security/introducing-aws-single-sign-on/">Introducing AWS Single Sign-On</a>“.</p> 
<p><span style="text-decoration: underline"><strong>How to access resources in your AWS accounts by using AWS SSO and the AWS CLI</strong></span></p> 
<p>1. Sign in to the AWS SSO user portal using your corporate credentials. If you don’t know the URL of your AWS SSO user portal, ask your IT administrator. This URL can be found in <a href="https://console.aws.amazon.com/singlesignon">AWS SSO Console</a> in the <strong>Dashboard</strong> menu, under “<strong>User portal URL</strong>” section. In the user portal, you will see the AWS accounts to which you have been granted access.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_1.acb9ce3eaf5a8249f6e27e7f8d6f343211ae297d.png" /></p> 
<p>2. Choose “<strong>AWS Account</strong>” to expand the list of AWS accounts.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_2.90e159e24f3395a815f65ee6f66dd2db8bcea7bf.png" /></p> 
<p>3. Choose the AWS account that you want to access using the AWS CLI. This expands the list of permission sets in the account that you can use to access the account. For this example, I choose “<strong>Administrator</strong>” permission set which has the necessary permissions to create security groups in accounts. I then choose “<strong>Command Line</strong>” or “<strong>Programmatic Access</strong>” associated with the “<strong>Administrator</strong>” permissions set.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_3.092c0aae7b0ae1b4fb702b913290114414fa8d10.png" /></p> 
<p>4. AWS SSO shows the credentials you requested in the appropriate format for your operating system. If you need credentials for an operating system that is different from the one shown, you can switch between the <strong>MacOS</strong> <strong>and Linux</strong> and <strong>Windows</strong> tabs. AWS SSO offers three options to use the temporary security credentials (these credentials are valid for up to 60 minutes; see the following screenshot for examples of each option):</p> 
<p>a. To run commands from the AWS CLI against the selected AWS account, copy the commands in the “<strong>Setup AWS CLI environment variables</strong>” section and paste the commands in the terminal window to set the necessary environment variables. These environment variables will be effective in the current terminal window.</p> 
<p>b. To run commands from multiple terminal windows against the same AWS account, copy the profile in the “<strong>Setup AWS CLI profile</strong>” section<strong>&nbsp;</strong>to setup a new named profile in your AWS credentials file. To learn more, see: “<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html">Configuration and Credential Files</a>“. You then will be able to use the –profile option with your AWS CLI command to use this credential. This will be effective in all terminal windows that use the same credential file.</p> 
<p>c. To access AWS resources from an AWS service client, use the credentials under the “<strong>Copy individual values</strong>” section to initialize your client. For more information, see the “Use the temporary credentials to access AWS resources” section on “<a href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/prog-services-sts.html">Getting Temporary Credentials with AWS STS</a>“.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_4.a38806efb8077d7708aa33cb0ece339a540bca60.png" /></p> 
<p>5. Move your mouse over the option you want to copy credentials. I chose option 1.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_5.50ba04f52ade52f6d8420b317025e94c6e3a899a.png" /></p> 
<p>6. I have copied, pasted, and run the AWS CLI environment variables commands in my terminal window:</p> 
<p><code>$ export AWS_ACCESS_KEY_ID=“ASIAJWOHLDZASDEXAMPLE&quot;<br /> $ export AWS_SECRET_ACCESS_KEY=&quot;feTxcGI2aus2m4RZh+eDASvqw3vOq/jS+EXAMPLE&quot;<br /> $ export AWS_SESSION_TOKEN=&quot;FQoDYXdzEFQaDIiq9STHISISEXAMPLE”</code></p> 
<p>7. Optionally, you can verify that the credentials are set up correctly by running the “<code>aws configure list</code>” command. Verify that the <code>access_key</code> and <code>secret_key</code> have values assigned.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_7.a5b50f4bb1f5abff2173c222c119df89cfa214d1.png" /></p> 
<p>8. Now you can run any applicable AWS CLI commands (based on the permission set granted to you by your administrator). In the following example, I list instances in my AWS account.</p> 
<p><img width="100%" src="https://d1.awsstatic.com/security-center/SecurityBlog/sso_user_portal_8.a9314a8cad12331c4620fd2df7041df872ca8579.png" /></p> 
<p>9. To run the same (or different) AWS CLI command against a different AWS account, repeat this process, starting with Step 3. By keeping the AWS SSO user portal open in a browser window, you can easily switch to another AWS account without needing to sign in again. Every time you want to switch between accounts/permission sets or do additional work in an account after the temporary credentials expire, just copy fresh credentials for that account/permission set from the user portal.</p> 
<p><span style="text-decoration: underline"><strong>Conclusion</strong></span></p> 
<p>In this post, in order to manage services using the AWS CLI, I’ve showed you how to use your existing corporate username and password to get temporary credentials from AWS SSO. If you have questions, please start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=277">AWS SSO Forum</a>.</p> 
<p>– Anand Murugesan</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7301');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH3a1.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Use New Advanced Security Features for Amazon Cognito User Pools</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Tim Hunt</span></span> | on 
<time property="datePublished" datetime="2018-02-19T07:57:01+00:00">19 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/mobile-services/amazon-cognito/" title="View all posts in Amazon Cognito*"><span property="articleSection">Amazon Cognito*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/mobile-services/" title="View all posts in Mobile Services*"><span property="articleSection">Mobile Services*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-use-new-advanced-security-features-for-amazon-cognito-user-pools/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7234" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7234&amp;disqus_title=How+to+Use+New+Advanced+Security+Features+for+Amazon+Cognito+User+Pools&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-use-new-advanced-security-features-for-amazon-cognito-user-pools/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7234');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://aws.amazon.com/cognito/" target="_blank" rel="noopener noreferrer">Amazon Cognito</a> lets you easily add user sign-up, sign-in, and access control to your mobile and web apps. You can use fully managed user directories, called <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" target="_blank" rel="noopener noreferrer">Amazon Cognito user pools</a>, to create accounts for your users, allow them to sign in, and update their profiles. Your users also can sign in by using external identity providers (IdPs) by <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-identity-federation.html" target="_blank" rel="noopener noreferrer">federating</a> with Amazon, Google, Facebook, SAML, or OpenID Connect (OIDC)–based IdPs. If your app is backed by resources, Amazon Cognito also gives you tools to manage permissions for accessing resources through <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" target="_blank" rel="noopener noreferrer">roles</a> and <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html" target="_blank" rel="noopener noreferrer">policies</a>, and through integration with <a href="https://aws.amazon.com/apigateway/" target="_blank" rel="noopener noreferrer">Amazon API Gateway</a>.</p> 
<p>In this post, I explain some new advanced security features (in beta) that were launched at AWS re:Invent 2017 for Amazon Cognito user pools and how to use them. Note that separate prices apply to these advanced security features, as described on our <a href="https://aws.amazon.com/cognito/pricing/" target="_blank" rel="noopener noreferrer">pricing page</a>.</p> 
<h3>The new advanced security features of Amazon Cognito</h3> 
<p>Security is the top priority for Amazon Cognito. We handle user authentication and authorization to control access to your web and mobile apps, so security is vital. The new advanced security features add additional protections for your users that you manage in Amazon Cognito user pools. In particular, we have added protection against compromised credentials and risk-based adaptive authentication.</p> 
<h4>Compromised credentials protection</h4> 
<p>Our compromised credentials feature protects your users’ accounts by preventing your users from reusing credentials (a user name and password pair) that have been exposed elsewhere. This new feature addresses the issue of users reusing the same credentials for multiple websites and apps. For example, a user might use the same email address and password to sign in to multiple websites.</p> 
<p>A security best practice is to never use the same user name password in different systems. If an attacker is able to obtain user credentials through a breach of one system, they could use those user credentials to access other systems. AWS has been able to form partnerships and programs so that Amazon Cognito is informed when a set of credentials has been compromised elsewhere. When you use compromised credentials protection in Amazon Cognito, you can prevent users of your application from signing up, signing in, and changing their password with credentials that are recognized as having been compromised. If a user attempts to use credentials that we detect have been compromised, that user is required to choose a different password.</p> 
<h4>Risk-based adaptive authentication</h4> 
<p>The other major advanced security feature we launched at AWS re:Invent 2017 is risk-based adaptive authentication. Adaptive authentication protects your users from attempts to compromise their accounts—and it does so intelligently to minimize any inconvenience for your customers. With adaptive authentication, Amazon Cognito examines each user pool sign-in attempt and generates a risk score for how likely the sign-in request is to be from a malicious attacker.</p> 
<p>Amazon Cognito examines a number of factors, including whether the user has used the same device before, or has signed in from the same location or IP address. A detected risk is rated as low, medium, or high, and you can determine what actions should be taken at each risk level. You can choose to block the request if the risk level is high, or you can choose to require a second factor of authentication, in addition to the password, for the user to sign in using multi-factor authentication (MFA). With adaptive authentication, users continue to sign in with just their password when the request has characteristics of successful sign-ins in the past. Users are prompted for a second factor only when some risk is detected with a sign-in request.</p> 
<p>To learn more about using MFA with adaptive authentication, see <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html" target="_blank" rel="noopener noreferrer">Multi-Factor (MFA) Authentication Settings</a>. Amazon Cognito also can now <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-email-phone-verification.html" target="_blank" rel="noopener noreferrer">verify email addresses and mobile phone numbers</a> as part of the authentication process.</p> 
<h4><strong>Metrics and data with the advanced security features</strong></h4> 
<p>In addition, both the compromised credentials and adaptive authentication features provide metrics and data about the following:</p> 
<li>Sign-up, sign-in, and forgotten-password events</li> 
<li>The risk scores that are assigned to events</li> 
<li>The results of sign-in attempts and second-factor challenges</li> 
<p>You can view aggregate metrics by using the <a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="noopener noreferrer">Amazon CloudWatch</a> console. You also can view each user’s sign-in history in the <a href="https://console.aws.amazon.com/cognito/home" target="_blank" rel="noopener noreferrer">Amazon Cognito console</a>.</p> 
<h3>How to configure the advanced security features</h3> 
<p>Now that I’ve described the new advanced security features, I will show how to configure them for your mobile or web app. You have to create an Amazon Cognito user pool in the console and save it before you can see the advanced security settings.</p> 
<p>First you must create and configure an Amazon Cognito user pool:</p> 
<ol> 
<li>Go to the <a href="https://console.aws.amazon.com/cognito/home" target="_blank" rel="noopener noreferrer">Amazon Cognito console</a>, and choose <strong>Manage your User Pools</strong> to get started. If you already have a user pool that you can work with, choose that user pool. Otherwise, choose <strong>Create a user pool</strong> to create a new one.</li> 
<li>On the <strong>MFA and verifications</strong> tab (see the following screenshot), enable MFA as <strong>Optional</strong> so that your individual users can choose to configure second factors of authentication, which are needed for adaptive authentication. (If you were to choose <strong>Required</strong> as the MFA setting for your user pool instead, all sign-ins would require a second factor of authentication. This would effectively disable adaptive authentication because a second factor of authentication would always be required.)</li> 
</ol> 
<p style="padding-left: 40px">You should also enable at least one second factor of authentication. As shown in the following screenshot, I have enabled both <strong>SMS text message</strong> and <strong>Time-based One-time Password</strong> (TOTPs).<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH1a.png" /></p> 
<ol start="3"> 
<li>On the <strong>App clients</strong> tab, create an app client by choosing <strong>add an app client</strong>, entering a name, and choosing <strong>Create app client</strong>.</li> 
</ol> 
<p>Second, configure the advanced security features:</p> 
<ol> 
<li>After you’ve configured and saved your user pool, you will see the <strong>Advanced security</strong> tab, as shown in the following screenshot. You can choose one of three modes for enabling the advanced security features: <strong>Yes</strong>, <strong>Audit only</strong>, and <strong>No</strong>: 
<li>If you choose <strong>No</strong>, the advanced features are all turned off.</li> 
<li>If you choose <strong>Audit only</strong>, Amazon Cognito logs all related events to CloudWatch metrics so that you can see what risks are detected, but Amazon Cognito doesn’t take any explicit actions to protect your users. Use the <strong>Audit only</strong> mode to understand what events are happening before you fully turn on the advanced security features.</li> 
<li>If you choose <strong>Yes</strong>, you turn on the advanced security features. We recommend that you initially run the advanced security features in <strong>Audit only</strong> mode for two weeks before choosing <strong>Yes</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH2a.png" /></li> 
</ul> </li> 
</ol> 
<ol start="2"> 
<li>When you choose <strong>Yes</strong> to turn on the advanced security features, configuration options appear, as shown in the following screenshot: 
<ol type="a"> 
<li>First, choose if you want to configure default settings for all of your app clients, or if you want to configure settings for a specific app client. As shown in the following screenshot, you can see that I’ve chosen global default settings for all my app clients.</li> 
<li>Next, choose the action you want to take when compromised credentials are detected. You can either <strong>Allow</strong> compromised credentials, or you can <strong>Block use </strong>of them. If you want to protect your users, you should choose <strong>Block use</strong>. However, you first can watch the metrics in CloudWatch without taking action by choosing <strong>Allow</strong>. You also can choose <strong>Customize when compromised credentials are blocked</strong>, which allows you to choose for which operations—sign up, sign in, and forgotten password—Amazon Cognito will detect and block use of compromised credentials.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH3a.png" /></li> 
</ol> </li> 
</ol> 
<ol start="3"> 
<li>The next section on the <strong>Advanced security</strong> tab includes the configuration for adaptive authentication. For each risk level (<strong>Low</strong>, <strong>Medium</strong>, and <strong>High</strong>), you can require a second factor for MFA or you can block the request, and you can notify users about the events through email. You have two MFA choices for each risk level: 
<ol type="a"> 
<li><strong>Optional MFA</strong> – Requires a second factor at that risk level for all users who have configured either SMS or TOTP as a second factor of authentication. Users who haven’t configured a second factor are allowed to sign in without a second factor. For optional MFA, you should encourage your users to configure a second factor of authentication for added security, but users who haven’t configured a second factor aren’t blocked from signing in.</li> 
<li><strong>Require MFA</strong> – Requires a second factor of authentication from all users when a risk is detected, so any users who haven’t configured a second factor are blocked from signing in at any risk level that requires MFA.</li> 
<li><strong>Block –</strong> Blocks the sign-in attempt.</li> 
<li><strong>Notify users</strong> – Sends an email to the users to notify them about the sign-in attempt. You can customize the emails as described below.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH4a.png" /></li> 
</ol> </li> 
<li>In the next section on the <strong>Advanced security</strong> tab, you can customize the email notifications that Amazon Cognito sends to your users if you have selected <strong>Notify users</strong>. Amazon Cognito sends these notification emails through <a href="https://aws.amazon.com/ses/" target="_blank" rel="noopener noreferrer">Amazon Simple Email Service</a> (Amazon SES). If you haven’t already, you should go to the <a href="https://console.aws.amazon.com/ses/home" target="_blank" rel="noopener noreferrer">Amazon SES console</a> to <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-addresses-and-domains.html" target="_blank" rel="noopener noreferrer">configure and verify an email address or domain</a> so that you can use it as the <strong>FROM email address</strong> for the notification emails that Amazon Cognito sends.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH5a.png" /></li> 
</ol> 
<p style="padding-left: 40px">You can customize the email subject and body for the email notifications with both HTML and plain text versions, as shown in the following screenshot.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH6a.png" /></p> 
<ol start="5"> 
<li>Optionally, you can enter IP addresses that you either want to <strong>Always allow</strong> by bypassing the compromised credentials and adaptive authentication features, or to <strong>Always block</strong>. For example, if you have a site where you do testing and development, you might want to include the IP address range from that site in the <strong>Always allow</strong> list so that it doesn’t get mistaken as a risky sign-in attempt.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH7a.png" /></li> 
</ol> 
<p>That’s all it takes to configure the advanced security features in the Amazon Cognito console.</p> 
<h3>Enabling the advanced security features from you app</h3> 
<p>After you have configured the advanced security features for your user pool, you need to enable them in your mobile or web app. First you need to include a version of our SDK that is recent enough to support the features, and second in some cases, you need to set some values for iOS, Android, and JavaScript.</p> 
<p><strong>iOS:</strong> If you’re building your own user interface to sign in users and integrating the <a href="https://github.com/aws/aws-sdk-ios/tree/master/AWSCognitoIdentityProvider" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity Provider SDK</a>, use at least version 2.6.7 of the SDK. If you’re using the <a href="https://github.com/aws/aws-sdk-ios/tree/master/AWSCognitoAuth" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth SDK</a> to incorporate the customizable, hosted user interface to sign in users, also use at least version 2.6.7. If you’re configuring the Auth SDK by using <code>Info.plist</code>, add the <code>PoolIdForEnablingASF</code> key to your Amazon Cognito user pool configuration, and set it to your user pool ID. If you’re configuring the Auth SDK by using <code>AWSCognitoAuthConfiguration</code>, use <a href="http://docs.aws.amazon.com/AWSiOSSDK/latest/Classes/AWSCognitoAuthConfiguration.html#//api/name/initWithAppClientId:appClientSecret:scopes:signInRedirectUri:signOutRedirectUri:webDomain:identityProvider:idpIdentifier:userPoolIdForEnablingASF:" target="_blank" rel="noopener noreferrer">this initializer</a> and specify your user pool ID as <code>userPoolIdForEnablingASF</code>. For more details, see the <a href="https://github.com/awslabs/aws-sdk-ios-samples/tree/master/CognitoAuth-Sample" target="_blank" rel="noopener noreferrer">CognitoAuth sample app</a>.</p> 
<p><strong>Android:</strong> If you’re using the <a href="https://github.com/aws/aws-sdk-android/tree/master/aws-android-sdk-cognitoauth" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth SDK for Android</a> that incorporates the hosted UI to sign in users, or if you’re using the <a href="https://github.com/aws/aws-sdk-android/tree/master/aws-android-sdk-cognitoidentityprovider" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity Provider SDK for Android</a> to integrate your own native user interface, use at least version 2.6.9 of the SDK.</p> 
<p><strong>JavaScript:</strong> If you’re using the <a href="https://github.com/aws/amazon-cognito-auth-js" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth JS SDK</a> to incorporate the customizable, hosted UI to sign in users, use at least version 1.1.0 of the SDK. To configure the advanced security features, add the <code>AdvancedSecurityDataCollectionFlag</code> parameter and set it as <code>true</code>. Also add the <code>UserPoolId</code> parameter and set it to your user pool ID.&nbsp;In your application, you need to include <code>&quot;https://amazon-cognito-assets.&lt;region&gt;.amazoncognito.com/amazon-cognito-advanced-security-data.min.js&quot;</code> to collect data about requests. For more details, see the <a href="https://github.com/aws/amazon-cognito-auth-js/blob/master/README.md" target="_blank" rel="noopener noreferrer">README.md</a> of the Auth JavaScript SDK and the <a href="https://github.com/aws/amazon-cognito-auth-js/blob/master/sample/SAMPLEREADME.md" target="_blank" rel="noopener noreferrer">SAMPLEREADME.md</a> of the web app sample. If you’re using the <a href="https://github.com/aws/amazon-cognito-identity-js/" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity SDK</a> to build your own UI, use at least version 1.28.0 of the SDK.</p> 
<h3>Some examples of the advanced security features in action</h3> 
<p>Now that I have configured these advanced security features, let’s look at them in action. I’m using the customizable, hosted sign-up and sign-in screens that are built into Amazon Cognito user pools. I’ve done some minimal customization, and my sign-up page is shown in the following screenshot.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH8.png" /></p> 
<p>With the compromised credentials feature, if a user tries to sign up with credentials that have been exposed at another site, the user is told they cannot use that password for security reasons.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH9.png" /></p> 
<p>If a user signs in, Amazon Cognito detects a risk, and you have configured adaptive authentication, the user is asked for a second factor of authentication. The following screenshot shows an example of an SMS text message used for MFA. After the user enters a valid code from their phone, they’re successfully signed in.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH10.png" /></p> 
<p>As I mentioned earlier in this post, Amazon Cognito also can notify your users whenever there’s a sign-in attempt that’s determined to have some risk. The following screenshot shows a basic example of a notification message, and you can customize these messages, as described previously.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH11.png" /></p> 
<p>The advanced security features also provide aggregate metrics and event histories for individual users. You can view the aggregate metrics in the <a href="https://console.aws.amazon.com/cloudwatch" target="_blank" rel="noopener noreferrer">CloudWatch console</a>. Navigate to the <strong>Metrics</strong> section under <strong>Cognito</strong>. When you’re graphing, choose the <strong>Graphed metrics</strong> tab and choose <strong>Sum</strong> as the <strong>Statistic</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH12a.png" /></p> 
<p>You can view the event histories for users in the Amazon Cognito console on the <strong>Users and groups</strong> tab. When you choose an individual user, you see that user’s event history listed under their profile information. As the following screenshot shows, you can see information about users’ events, including the date and time, the event type, the risk detected, and location. The event history includes the <strong>Risk level</strong> that indicates the <strong>Low</strong>, <strong>Medium</strong>, or <strong>High</strong> ratings described earlier and the <strong>Risk decision</strong> that indicates if a risk was detected and what type.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH13a.png" /></p> 
<p>When you choose an entry, you see the event details and the option to <strong>Mark event as</strong> <strong>valid</strong> if it was from the user, or <strong>Mark event as invalid</strong> if it wasn’t.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/15/TH14a.png" /></p> 
<h3>Summary</h3> 
<p>You can use these advanced security features of Amazon Cognito user pools to protect your users from compromised credentials and attempts to compromise their user pool–based accounts in your app. You also can customize the actions taken in response to different risks, or you can use audit mode to gather metrics on detected risks without taking action. For more information about using these features, see the <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-settings-advanced-security.html" target="_blank" rel="noopener noreferrer">Amazon Cognito Developer Guide</a>.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about how to configure or use these features, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=173" target="_blank" rel="noopener noreferrer">Amazon Cognito forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Tim</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7234');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/KVB_0118-767x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Patch Linux Workloads on AWS</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Koen van Blijderveen</span></span> | on 
<time property="datePublished" datetime="2018-02-15T08:04:20+00:00">15 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-patch-linux-workloads-on-aws/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7266" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7266&amp;disqus_title=How+to+Patch+Linux+Workloads+on+AWS&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-patch-linux-workloads-on-aws/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7266');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Most malware tries to compromise your systems by using a known vulnerability that the operating system maker has already patched. As best practices to help prevent malware from affecting your systems, you should apply all operating system patches and actively monitor your systems for missing patches.</p> 
<p>In this blog post, I show you how to patch Linux workloads using <a href="https://aws.amazon.com/ec2/systems-manager" target="_blank" rel="noopener noreferrer">AWS Systems Manager</a>. To accomplish this, I will show you how to use the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface</a> (AWS CLI) to:</p> 
<ol> 
<li><strong>Launch an </strong><a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer"><strong>Amazon EC2</strong></a><strong> instance</strong> for use with Systems Manager.</li> 
<li><strong>Configure Systems Manager</strong> to patch your Amazon EC2 Linux instances.</li> 
</ol> 
<p>In two previous blog posts (<a href="https://aws.amazon.com/blogs/security/how-to-patch-inspect-and-protect-microsoft-windows-workloads-on-aws-part-1/" target="_blank" rel="noopener noreferrer">Part 1</a> and <a href="https://aws.amazon.com/blogs/security/how-to-patch-inspect-and-protect-microsoft-windows-workloads-on-aws-part-2/" target="_blank" rel="noopener noreferrer">Part 2</a>), I showed how to use the AWS Management Console to perform the necessary steps to patch, inspect, and protect Microsoft Windows workloads. You can implement those same processes for your Linux instances running in AWS by changing the instance tags and types shown in the previous blog posts.</p> 
<p>Because most Linux system administrators are more familiar with using a command line, I show how to patch Linux workloads by using the AWS CLI in this blog post. The steps to use the <a href="https://docs.aws.amazon.com/solutions/latest/ebs-snapshot-scheduler/overview.html" target="_blank" rel="noopener noreferrer">Amazon EBS Snapshot Scheduler</a> and <a href="https://aws.amazon.com/inspector/" target="_blank" rel="noopener noreferrer">Amazon Inspector</a> are identical for both Microsoft Windows and Linux.</p> 
<h3>What you should know first</h3> 
<p>To follow along with the solution in this post, you need one or more Amazon EC2 instances. You may use existing instances or create new instances. For this post, I assume this is an <a href="https://aws.amazon.com/amazon-linux-ami/" target="_blank" rel="noopener noreferrer">Amazon EC2 for Amazon Linux</a> instance installed from <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank" rel="noopener noreferrer">Amazon Machine Images</a> (AMIs).</p> 
<p>Systems Manager is a collection of capabilities that helps you automate management tasks for AWS-hosted instances on Amazon EC2 and your on-premises servers. In this post, I use Systems Manager for two purposes: to run remote commands and apply operating system patches. To learn about the full capabilities of Systems Manager, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" target="_blank" rel="noopener noreferrer">What Is AWS Systems Manager?</a></p> 
<p>As of Amazon Linux 2017.09, the AMI comes preinstalled with the Systems Manager agent. <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-patch.html" target="_blank" rel="noopener noreferrer">Systems Manager Patch Manager</a> also supports Red Hat and Ubuntu. To install the agent on these Linux distributions or an older version of Amazon Linux, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html" target="_blank" rel="noopener noreferrer">Installing and Configuring SSM Agent on Linux Instances</a>.</p> 
<p>If you are not familiar with how to launch an Amazon EC2 instance, see <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launching-instance.html" target="_blank" rel="noopener noreferrer">Launching an Instance</a>. I also assume you launched or will launch your instance in a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Subnets.html" target="_blank" rel="noopener noreferrer">private subnet</a>. You must make sure that the Amazon EC2 instance can connect to the internet using a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html" target="_blank" rel="noopener noreferrer">network address translation (NAT) instance</a> or <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">NAT gateway</a> to communicate with Systems Manager. The following diagram shows how you should structure your VPC.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/13/KVB_0118_a.png" /></p> 
<p>Later in this post, you will assign tasks to a maintenance window to patch your instances with Systems Manager. To do this, the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html" target="_blank" rel="noopener noreferrer">IAM user</a> you are using for this post must have the <code><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html" target="_blank" rel="noopener noreferrer">iam:PassRole</a></code> permission. This permission allows the IAM user assigning tasks to pass his own IAM permissions to the AWS service. In this example, when you assign a task to a maintenance window, IAM passes your credentials to Systems Manager. You also should authorize your IAM user to use Amazon EC2 and Systems Manager. As mentioned before, you will be using the AWS CLI for most of the steps in this blog post. Our documentation shows you <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" target="_blank" rel="noopener noreferrer">how to get started with the AWS CLI</a>. Make sure you have the AWS CLI installed and configured with an AWS access key and secret access key that belong to an IAM user that have the following AWS managed policies attached to the IAM user you are using for this example: <code>AmazonEC2FullAccess</code> and <code>AmazonSSMFullAccess</code>.</p> 
<b>Step 1: Launch an Amazon EC2 Linux instance</b> 
<p>In this section, I show you how to launch an Amazon EC2 instance so that you can use Systems Manager with the instance. This step requires you to do three things:</p> 
<ol type="A"> 
<li><strong>Create an IAM role for Systems Manager</strong> before launching your Amazon EC2 instance.</li> 
<li><strong>Launch your Amazon EC2 instance </strong>with Amazon EBS and the IAM role for Systems Manager.</li> 
<li><strong>Add tags</strong> to the instances so that you can add your instances to a Systems Manager maintenance window based on tags.</li> 
</ol> 
<h3>A. Create an IAM role for Systems Manager</h3> 
<p>Before launching an Amazon EC2 instance, I recommend that you first create an <a href="https://aws.amazon.com/iam/details/manage-roles/" target="_blank" rel="noopener noreferrer">IAM role</a> for Systems Manager, which you will use to update the Amazon EC2 instance. AWS already provides a preconfigured policy that you can use for the new role and it is called <code>AmazonEC2RoleforSSM</code>.</p> 
<ol> 
<li>Create a JSON file named <code>trustpolicy-ec2ssm.json</code> that contains the following trust policy. This policy describes which principal (an entity that can take action on an AWS resource) is allowed to assume the role we are going to create. In this example, the principal is the Amazon EC2 service. 
<code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: {
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;Service&quot;: &quot;ec2.amazonaws.com&quot;},
&quot;Action&quot;: &quot;sts:AssumeRole&quot;
}
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to create a role named <code>EC2SSM</code> that has the AWS managed policy <code>AmazonEC2RoleforSSM</code> attached to it. This generates JSON-based output that describes the role and its parameters, if the command is successful. 
<code class="lang-text">$ aws iam create-role --role-name EC2SSM --assume-role-policy-document file://trustpolicy-ec2ssm.json</code> 
</ol> 
<ol start="3"> 
<li>Use the following command to attach the AWS managed IAM policy (<code>AmazonEC2RoleforSSM</code>) to your newly created role. 
<code class="lang-text">$ aws iam attach-role-policy --role-name EC2SSM --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM</code> 
</ol> 
<ol start="4"> 
<li>Use the following commands to create the IAM <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" target="_blank" rel="noopener noreferrer">instance profile</a> and add the role to the instance profile. The instance profile is needed to attach the role we created earlier to your Amazon EC2 instance. 
<code class="lang-text">$ aws iam create-instance-profile --instance-profile-name EC2SSM-IP
$ aws iam add-role-to-instance-profile --instance-profile-name EC2SSM-IP --role-name EC2SSM</code> 
</ol> 
<h3>B. Launch your Amazon EC2 instance</h3> 
<p>To follow along, you need an Amazon EC2 instance that is running Amazon Linux. You can use any existing instance you may have or create a new instance.</p> 
<p>When launching a new Amazon EC2 instance, be sure that:</p> 
<li>The operating system is Amazon Linux.</li> 
<li>You attach the newly created IAM role (<code>EC2SSM</code>).</li> 
<li>The Amazon EC2 instance can connect to Systems Manager through a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">network address translation (NAT) gateway</a> or a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html" target="_blank" rel="noopener noreferrer">NAT instance</a>.</li> 
<ol> 
<li>Use the following command to launch a new Amazon EC2 instance using an Amazon Linux AMI available in the US East (N. Virginia) Region (also known as us-east-1). Replace <code>YourKeyPair</code> and <code>YourSubnetId</code> with your information. For more information about creating a key pair, see the <a href="https://docs.aws.amazon.com/cli/latest/reference/ec2/create-key-pair.html" target="_blank" rel="noopener noreferrer">create-key-pair documentation</a>. Write down the <code>InstanceId</code> that is in the output because you will need it later in this post. 
<code class="lang-text">$ aws ec2 run-instances --image-id ami-cb9ec1b1 --instance-type t2.micro --key-name <span style="color: #ff0000">YourKeyPair</span> --subnet-id <span style="color: #ff0000">YourSubnetId</span> --iam-instance-profile Name=EC2SSM-IP</code> 
</ol> 
<ol start="2"> 
<li>If you are using an existing Amazon EC2 instance, you can use the following command to attach the instance profile you created earlier to your instance. 
<code class="lang-text">$ aws ec2 associate-iam-instance-profile --instance-id <span style="color: #ff0000">YourInstanceId</span> --iam-instance-profile Name=EC2SSM-IP</code> 
</ol> 
<h3>C. Add tags</h3> 
<p>The final step of configuring your Amazon EC2 instances is to add tags. You will use these tags to configure Systems Manager in Step 2 of this post. For this example, I add a tag named <code>Patch Group</code> and set the value to <code>Linux Servers</code>. I could have other groups of Amazon EC2 instances that I treat differently by having the same tag name but a different tag value. For example, I might have a collection of other servers with the tag name <code>Patch Group</code> with a value of <code>Web Servers</code>.</p> 
<li>Use the following command to add the <code>Patch Group</code> tag to your Amazon EC2 instance. 
<code class="lang-text">$ aws ec2 create-tags --resources <span style="color: #ff0000">YourInstanceId</span> --tags --tags Key=&quot;Patch Group&quot;,Value=&quot;Linux Servers&quot;</code> 
<p style="padding-left: 40px"><strong>Note:</strong> You must wait a few minutes until the Amazon EC2 instance is available before you can proceed to the next section. To make sure your Amazon EC2 instance is online and ready, you can use the following AWS CLI command:</p> 
<code class="lang-text">$ aws ec2 describe-instance-status --instance-ids <span style="color: #ff0000">YourInstanceId</span></code> 
<p>At this point, you now have at least one Amazon EC2 instance you can use to configure Systems Manager.</p> 
<b>Step 2: Configure Systems Manager</b> 
<p>In this section, I show you how to configure and use Systems Manager to apply operating system patches to your Amazon EC2 instances, and how to manage patch compliance.</p> 
<p>To start, I provide some background information about Systems Manager. Then, I cover how to:</p> 
<ol> 
<li><strong>Create the Systems Manager IAM role</strong> so that Systems Manager is able to perform patch operations.</li> 
<li><strong>Create a Systems Manager patch baseline and associate it with your instance </strong>to define which patches Systems Manager should apply.</li> 
<li><strong>Define a maintenance window</strong> to make sure Systems Manager patches your instance when you tell it to.</li> 
<li><strong>Monitor patch compliance </strong>to verify the patch state of your instances.</li> 
</ol> 
<p>You must meet two prerequisites to use Systems Manager to apply operating system patches. First, you must attach the IAM role you created in the previous section, <code>EC2SSM</code>, to your Amazon EC2 instance. Second, you must install the Systems Manager agent on your Amazon EC2 instance. If you have used a recent Amazon Linux AMI, Amazon has already installed the Systems Manager agent on your Amazon EC2 instance. You can confirm this by logging in to an Amazon EC2 instance and checking the Systems Manager agent log files that are located at <code>/var/log/amazon/ssm/</code>.</p> 
<p>To install the Systems Manager agent on an instance that does not have the agent preinstalled or if you want to use the Systems Manager agent on your on-premises servers, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html" target="_blank" rel="noopener noreferrer">Installing and Configuring the Systems Manager Agent on Linux Instances</a>. If you forgot to attach the newly created role when launching your Amazon EC2 instance or if you want to attach the role to already running Amazon EC2 instances, see <a href="https://aws.amazon.com/blogs/security/new-attach-an-aws-iam-role-to-an-existing-amazon-ec2-instance-by-using-the-aws-cli/" target="_blank" rel="noopener noreferrer">Attach an AWS IAM Role to an Existing Amazon EC2 Instance by Using the AWS CLI</a> or use the <a href="https://aws.amazon.com/blogs/security/easily-replace-or-attach-an-iam-role-to-an-existing-ec2-instance-by-using-the-ec2-console/" target="_blank" rel="noopener noreferrer">AWS Management Console</a>.</p> 
<h3>A. Create the Systems Manager IAM role</h3> 
<p>For a maintenance window to be able to run any tasks, you must create a new role for Systems Manager. This role is a different kind of role than the one you created earlier: this role will be used by Systems Manager instead of Amazon EC2. Earlier, you created the role, <code>EC2SSM</code>, with the policy, <code>AmazonEC2RoleforSSM</code>, which allowed the Systems Manager agent on your instance to communicate with Systems Manager. In this section, you need a new role with the policy, <code>AmazonSSMMaintenanceWindowRole</code>, so that the Systems Manager service can execute commands on your instance.</p> 
<p>To create the new IAM role for Systems Manager:</p> 
<ol> 
<li>Create a JSON file named <code>trustpolicy-maintenancewindowrole.json</code> that contains the following trust policy. This policy describes which principal is allowed to assume the role you are going to create. This trust policy allows not only Amazon EC2 to assume this role, but also Systems Manager. 
<code class="lang-text">{
&quot;Version&quot;:&quot;2012-10-17&quot;,
&quot;Statement&quot;:[
{
&quot;Sid&quot;:&quot;&quot;,
&quot;Effect&quot;:&quot;Allow&quot;,
&quot;Principal&quot;:{
&quot;Service&quot;:[
&quot;ec2.amazonaws.com&quot;,
&quot;ssm.amazonaws.com&quot;
]
},
&quot;Action&quot;:&quot;sts:AssumeRole&quot;
}
]
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to create a role named <code>MaintenanceWindowRole</code> that has the AWS managed policy, <code>AmazonSSMMaintenanceWindowRole</code>, attached to it. This command generates JSON-based output that describes the role and its parameters, if the command is successful. 
<code class="lang-text">$ aws iam create-role --role-name MaintenanceWindowRole --assume-role-policy-document file://trustpolicy-maintenancewindowrole.json</code> 
</ol> 
<ol start="3"> 
<li>Use the following command to attach the AWS managed IAM policy (<code>AmazonEC2RoleforSSM</code>) to your newly created role. 
<code class="lang-text">$ aws iam attach-role-policy --role-name MaintenanceWindowRole --policy-arn arn:aws:iam::aws:policy/service-role/AmazonSSMMaintenanceWindowRole</code> 
</ol> 
<h3>B. Create a Systems Manager patch baseline and associate it with your instance</h3> 
<p>Next, you will create a Systems Manager patch baseline and associate it with your Amazon EC2 instance. A patch baseline defines which patches Systems Manager should apply to your instance. Before you can associate the patch baseline with your instance, though, you must determine if Systems Manager recognizes your Amazon EC2 instance. Use the following command to list all instances managed by Systems Manager. The <code>--filters</code> option ensures you look only for your newly created Amazon EC2 instance.</p> 
<code class="lang-text">$ aws ssm describe-instance-information --filters Key=InstanceIds,Values= <span style="color: #ff0000">YourInstanceId</span>
{
&quot;InstanceInformationList&quot;: [
{
&quot;IsLatestVersion&quot;: true,
&quot;ComputerName&quot;: &quot;ip-10-50-2-245&quot;,
&quot;PingStatus&quot;: &quot;Online&quot;,
&quot;InstanceId&quot;: &quot;<span style="color: #ff0000">YourInstanceId</span>&quot;,
&quot;IPAddress&quot;: &quot;10.50.2.245&quot;,
&quot;ResourceType&quot;: &quot;EC2Instance&quot;,
&quot;AgentVersion&quot;: &quot;2.2.120.0&quot;,
&quot;PlatformVersion&quot;: &quot;2017.09&quot;,
&quot;PlatformName&quot;: &quot;Amazon Linux AMI&quot;,
&quot;PlatformType&quot;: &quot;Linux&quot;,
&quot;LastPingDateTime&quot;: 1515759143.826
}
]
}</code> 
<p>If your instance is missing from the list, verify that:</p> 
<ol> 
<li>Your instance is running.</li> 
<li>You attached the Systems Manager IAM role, <code>EC2SSM</code>.</li> 
<li>You deployed a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">NAT gateway</a> in your public subnet to ensure your VPC reflects the diagram shown earlier in this post so that the Systems Manager agent can connect to the Systems Manager internet endpoint.</li> 
<li>The <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-agent-logs.html" target="_blank" rel="noopener noreferrer">Systems Manager agent logs</a> don’t include any unaddressed errors.</li> 
</ol> 
<p>Now that you have checked that Systems Manager can manage your Amazon EC2 instance, it is time to create a patch baseline. With a patch baseline, you define which patches are approved to be installed on all Amazon EC2 instances associated with the patch baseline. The <code>Patch Group</code> resource tag you defined earlier will determine to which patch group an instance belongs. If you do not specifically define a patch baseline, the default AWS-managed patch baseline is used.</p> 
<p>To create a patch baseline:</p> 
<ol> 
<li>Use the following command to create a patch baseline named <code>AmazonLinuxServers</code>. With approval rules<strong>,</strong> you can determine the approved patches that will be included in your patch baseline. In this example, you add all <code>Critical</code> severity patches to the patch baseline as soon as they are released, by setting the <code>Auto approval delay</code> to <code>0 days</code>. By setting the <code>Auto approval delay</code> to <code>2 days</code>, you add to this patch baseline the <code>Important</code>, <code>Medium</code>, and <code>Low</code> severity patches two days after they are released. 
<code class="lang-text">$ aws ssm create-patch-baseline --name &quot;AmazonLinuxServers&quot; --description &quot;Baseline containing all updates for Amazon Linux&quot; --operating-system AMAZON_LINUX --approval-rules &quot;PatchRules=[{PatchFilterGroup={PatchFilters=[{Values=[Critical],Key=SEVERITY}]},ApproveAfterDays=0,ComplianceLevel=CRITICAL},{PatchFilterGroup={PatchFilters=[{Values=[Important,Medium,Low],Key=SEVERITY}]},ApproveAfterDays=2,ComplianceLevel=HIGH}]&quot;
{
&quot;BaselineId&quot;: &quot;<span style="color: #ff0000">YourBaselineId</span>&quot;
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to register the patch baseline you created with your instance. To do so, you use the <code>Patch Group</code> tag that you added to your Amazon EC2 instance. 
<code class="lang-text">$ aws ssm register-patch-baseline-for-patch-group --baseline-id <span style="color: #ff0000">YourPatchBaselineId</span> --patch-group &quot;Linux Servers&quot;
{
&quot;PatchGroup&quot;: &quot;Linux Servers&quot;,
&quot;BaselineId&quot;: &quot;<span style="color: #ff0000">YourBaselineId</span>&quot;
}</code> 
</ol> 
<h3>C.&nbsp; Define a maintenance window</h3> 
<p>Now that you have successfully set up a role, created a patch baseline, and registered your Amazon EC2 instance with your patch baseline, you will define a maintenance window so that you can control when your Amazon EC2 instances will receive patches. By creating multiple maintenance windows and assigning them to different patch groups, you can make sure your Amazon EC2 instances do not all reboot at the same time.</p> 
<p>To define a maintenance window:</p> 
<ol> 
<li>Use the following command to define a maintenance window. In this example command, the maintenance window will start every Saturday at 10:00 P.M. UTC. It will have a duration of 4 hours and will not start any new tasks 1 hour before the end of the maintenance window. 
<code class="lang-text">$ aws ssm create-maintenance-window --name SaturdayNight --schedule &quot;cron(0 0 22 ? * SAT *)&quot; --duration 4 --cutoff 1 --allow-unassociated-targets
{
&quot;WindowId&quot;: &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;
}</code> 
</ol> 
<p style="padding-left: 30px">For more information about defining a cron-based schedule for maintenance windows, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-cron.html#sysman-cron-maintenance-window" target="_blank" rel="noopener noreferrer">Cron and Rate Expressions for Maintenance Windows</a>.</p> 
<ol start="2"> 
<li>After defining the maintenance window, you must register the Amazon EC2 instance with the maintenance window so that Systems Manager knows which Amazon EC2 instance it should patch in this maintenance window. You can register the instance by using the same <code>Patch Group</code> tag you used to associate the Amazon EC2 instance with the AWS-provided patch baseline, as shown in the following command. 
<code class="lang-text">$ aws ssm register-target-with-maintenance-window --window-id <span style="color: #ff0000">YourMaintenanceWindowId</span> --resource-type INSTANCE --targets &quot;Key=tag:Patch Group,Values=Linux Servers&quot;
{
&quot;WindowTargetId&quot;: &quot;<span style="color: #ff0000">YourWindowTargetId</span>&quot;
}</code> 
</ol> 
<ol start="3"> 
<li>Assign a task to the maintenance window that will install the operating system patches on your Amazon EC2 instance. The following command includes the following options. 
<ol type="a"> 
<li><code>name</code> is the name of your task and is optional. I named mine <code>Patching</code>.</li> 
<li><code>task-arn</code> is the name of the task document you want to run.</li> 
<li><code>max-concurrency</code> allows you to specify how many of your Amazon EC2 instances Systems Manager should patch at the same time. <code>max-errors</code> determines when Systems Manager should abort the task. For patching, this number should not be too low, because you do not want your entire patch task to stop on all instances if one instance fails. You can set this, for example, to <code>20%</code>.</li> 
<li><code>service-role-arn</code> is the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the <code>AmazonSSMMaintenanceWindowRole</code> role you created earlier in this blog post.</li> 
<li><code>task-invocation-parameters</code> defines the parameters that are specific to the <code>AWS-RunPatchBaseline</code> task document and tells Systems Manager that you want to install patches with a timeout of 600 seconds (10 minutes). 
<code class="lang-text">$ aws ssm register-task-with-maintenance-window --name &quot;Patching&quot; --window-id &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot; --targets &quot;Key=WindowTargetIds,Values=<span style="color: #ff0000">YourWindowTargetId</span>&quot; --task-arn AWS-RunPatchBaseline --service-role-arn &quot;<span style="color: #ff0000">arn:aws:iam::123456789012:role/MaintenanceWindowRole</span>&quot; --task-type &quot;RUN_COMMAND&quot; --task-invocation-parameters &quot;RunCommand={Comment=,TimeoutSeconds=600,Parameters={SnapshotId=[''],Operation=[Install]}}&quot; --max-concurrency &quot;500&quot; --max-errors &quot;20%&quot;
{
&quot;WindowTaskId&quot;: &quot;<span style="color: #ff0000">YourWindowTaskId</span>&quot;
}</code> 
</ol> </li> 
</ol> 
<p>Now, you must wait for the maintenance window to run at least once according to the schedule you defined earlier. If your maintenance window has expired, you can check the status of any maintenance tasks Systems Manager has performed by using the following command.</p> 
<code class="lang-text">$ aws ssm describe-maintenance-window-executions --window-id &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;
{
&quot;WindowExecutions&quot;: [
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;WindowId&quot;: &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;,
&quot;WindowExecutionId&quot;: &quot;b594984b-430e-4ffa-a44c-a2e171de9dd3&quot;,
&quot;EndTime&quot;: 1515766467.487,
&quot;StartTime&quot;: 1515766457.691
}
]
}</code> 
<h3>D.&nbsp; Monitor patch compliance</h3> 
<p>You also can see the overall patch compliance of all Amazon EC2 instances using the following command in the AWS CLI.</p> 
<code class="lang-text">$ aws ssm list-compliance-summaries</code> 
<p>This command shows you the number of instances that are compliant with each category and the number of instances that are not in JSON format.</p> 
<p>You also can see overall patch compliance by choosing <strong>Compliance</strong> under <strong>Insights </strong>in the navigation pane of the <a href="https://console.aws.amazon.com/systems-manager/" target="_blank" rel="noopener noreferrer">Systems Manager console</a>. You will see a visual representation of how many Amazon EC2 instances are up to date, how many Amazon EC2 instances are noncompliant, and how many Amazon EC2 instances are compliant in relation to the earlier defined patch baseline.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/KVB_0218.png" /></p> 
<p>In this section, you have set everything up for patch management on your instance. Now you know how to patch your Amazon EC2 instance in a controlled manner and how to check if your Amazon EC2 instance is compliant with the patch baseline you have defined. Of course, I recommend that you apply these steps to all Amazon EC2 instances you manage.</p> 
<h3>Summary</h3> 
<p>In this blog post, I showed how to use Systems Manager to create a patch baseline and maintenance window to keep your Amazon EC2 Linux instances up to date with the latest security patches. Remember that by creating multiple maintenance windows and assigning them to different patch groups, you can make sure your Amazon EC2 instances do not all reboot at the same time.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about or issues implementing any part of this solution, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=30" target="_blank" rel="noopener noreferrer">Amazon EC2 forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Koen</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7266');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/RB_CustomAuth_diagram_020618aaa-956x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Use Your Own Identity and Access Management Systems to Control Access to AWS IoT Resources</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ramkishore Bhattacharyya</span></span> | on 
<time property="datePublished" datetime="2018-02-14T08:19:48+00:00">14 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/internet-of-things/aws-iot-platform/" title="View all posts in AWS IoT Platform*"><span property="articleSection">AWS IoT Platform*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/internet-of-things/" title="View all posts in Internet of Things*"><span property="articleSection">Internet of Things*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-use-your-own-identity-and-access-management-systems-to-control-access-to-aws-iot-resources/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7208" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7208&amp;disqus_title=How+to+Use+Your+Own+Identity+and+Access+Management+Systems+to+Control+Access+to+AWS+IoT+Resources&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-use-your-own-identity-and-access-management-systems-to-control-access-to-aws-iot-resources/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7208');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT</a> is a managed cloud platform that lets connected devices easily and securely interact with cloud applications and other devices by using the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt" target="_blank" rel="noopener noreferrer">Message Queuing Telemetry Transport</a> (MQTT) protocol, <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#http" target="_blank" rel="noopener noreferrer">HTTP</a>, and the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt-ws" target="_blank" rel="noopener noreferrer">MQTT over the WebSocket protocol</a>. Every connected device must authenticate to AWS IoT, and AWS IoT must authorize all requests to determine if access to the requested operations or resources is allowed. Until now, AWS IoT has supported two kinds of authentication techniques: the Transport Layer Security (TLS) mutual authentication protocol and the AWS Signature Version 4 algorithm. Callers must possess either an X.509 certificate or AWS security credentials to be able to authenticate their calls. The requests are authorized based on the policies attached to the certificate or the AWS security credentials.</p> 
<p>However, many of our customers have their own systems that issue custom authorization tokens to their devices. These systems use different access control mechanisms such as <a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">OAuth</a> over <a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener noreferrer">JWT</a> or <a href="https://aws.amazon.com/identity/saml/" target="_blank" rel="noopener noreferrer">SAML</a> tokens. AWS IoT now supports a <em>custom authorizer</em> to enable you to use custom authorization tokens for access control. You can now use custom tokens to authenticate and authorize HTTPS over the TLS server authentication protocol and <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt-ws" target="_blank" rel="noopener noreferrer">MQTT over WebSocket</a> connections to AWS IoT.</p> 
<p>In this blog post, I explain the AWS IoT custom authorizer design and then demonstrate the end-to-end process of setting up a custom authorizer to authorize an HTTPS over TLS server authentication connection to AWS IoT using a custom authorization token. In this process, you configure an <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> function, which will validate the token and provide the policies necessary to control the access privileges on the connection.</p> 
<p><strong>Note: </strong>This post assumes you are familiar with <a href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT</a> and <a href="https://aws.amazon.com/documentation/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> enough to perform steps using the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" target="_blank" rel="noopener noreferrer">AWS CLI</a> and <a href="https://www.openssl.org/" target="_blank" rel="noopener noreferrer">OpenSSL</a>. Make sure you are running the latest version of the AWS CLI.</p> 
<h3>Overview of the custom authorizer workflow</h3> 
<p>The following numbered diagram illustrates the custom authorizer workflow. The diagram is followed by explanations of the steps.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/07/RB_CustomAuth_diagram_020618aaa1a.png" /></p> 
<p>To explain the steps of the workflow as illustrated in the preceding diagram:</p> 
<ol> 
<li>The connected device uses the AWS SDK or custom client to make an HTTPS or MQTT over WebSocket request to the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT gateway</a>. The request includes a custom authorization token and the name of a preconfigured authorizer Lambda function that is to be invoked to validate the authorization token.</li> 
<li>The AWS IoT gateway identifies the authorization token in the request and determines that it is a custom authorization request. The gateway checks if a Lambda authorization function is configured for the AWS account that owns the device. If yes, the gateway invokes the Lambda function by passing the authorization token.</li> 
<li>The Lambda function verifies the authorization token and returns to the AWS IoT gateway a principal that identifies the connection and a set of <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html" target="_blank" rel="noopener noreferrer">AWS IoT policies</a> that determine permissions for the requested operation. The Lambda function also returns two time-to-live values that determine the validity (in seconds) of the connection and policy documents.</li> 
<li>The AWS IoT gateway invokes the AWS policy evaluation engine to authorize the requested operation against the set of policies that are received from the authorizer Lambda function.</li> 
<li>The AWS policy evaluation engine evaluates the policy documents and returns the result to the AWS IoT gateway. The gateway then caches the policy documents.</li> 
<li>If the policy evaluation allows the requested operation, the AWS IoT gateway serves the request. If the requested operation is denied, the AWS IoT gateway returns an <code>AccessDenied</code> exception with the status code of 403 to the device (the red line in the preceding diagram).</li> 
</ol> 
<h3>Outline of the steps to configure and use the custom authorizer</h3> 
<p>The following are the steps you will perform as part of the solution:</p> 
<ol> 
<li><strong>Create a Lambda function</strong>: Start by creating a Lambda function. The function takes the authorization token in the input, verifies it, and returns authorization policies to determine the caller’s permissions for the requested operation.</li> 
<li><strong>Create an authorizer</strong>: Create an authorizer in AWS IoT. An authorizer is an alternate data model pointing to a pre-created Lambda function. You can specify in the custom authorization request an authorizer name. AWS IoT invokes a corresponding Lambda function to verify the authorization token. You may update the authorizer to point to a different Lambda function and thus easily control which Lambda function to invoke to verify an authorization token.</li> 
<li><strong>Designate the default authorizer</strong>: You may designate one of your authorizers as the default authorizer. AWS IoT invokes the default authorizer implicitly when a custom authorization request does not include a specific authorizer name.</li> 
<li><strong>Add Lambda invocation permissions</strong>: AWS IoT needs to be able to call your Lambda function on your behalf to verify the token in the custom authorization request. You need to associate a resource policy with the Lambda function to allow this.</li> 
<li><strong>Test the Lambda function</strong>: When the Lambda function and the custom authorizer are configured, use the test function to verify that they are functioning correctly.</li> 
<li><strong>Invoke the custom authorizer</strong>: Finally, make an HTTPS request to the gateway that includes a custom authorization token. The request invokes the custom authorizer.</li> 
</ol> 
<b>Deploy the solution</b> 
<h3>1.&nbsp; Create a Lambda function</h3> 
<p>In this step, I show you how to create a Lambda function that runs your custom authorizer code and returns a set of essential attributes to authorize the request.</p> 
<p>Sign in to your AWS account and <a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html" target="_blank" rel="noopener noreferrer">create from the Lambda console a Lambda function</a> that takes as input an authorization token and performs whichever actions are necessary to validate the token, as shown in the following code example. The output, in JSON format, must contain the following attributes:</p> 
<ol type="a"> 
<li><code>IsAuthenticated</code>: This is a Boolean (true/false) attribute that indicates whether the request is authenticated.</li> 
<li><code>PrincipalId</code>: This is an alphanumeric string; the minimum length is 1 character, and the maximum length is 128 characters. This string acts as an identifier associated with the token that is received in the custom authorization request.</li> 
<li><code>PolicyDocuments</code>: This is a list of JSON formatted policy documents following the same conventions as an <a href="http://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html" target="_blank" rel="noopener noreferrer">AWS IoT policy</a>. The list contains at most 10 policy documents, each of which can be a maximum of 2,048 characters.</li> 
<li><code>DisconnectAfterInSeconds</code>: This indicates the maximum duration (in seconds) of the connection to the AWS IoT gateway, after which it will be disconnected. The minimum value is 300 seconds, and the maximum value is 86,400 seconds.</li> 
<li><code>RefreshAfterInSeconds</code>: This is the period between policy refreshes. When it lapses, the Lambda function is invoked again to allow for policy refreshes. The minimum value is 300 seconds, and the maximum value is 86,400 seconds.</li> 
</ol> 
<p>The following code example is a Lambda function in Node.js 6.10 that authenticates a token.</p> 
<code class="lang-text">// A simple authorizer Lambda function demonstrating
// how to parse auth token and generate response 
exports.handler = function(event, context, callback) { 
var token = event.token; 
switch (token.toLowerCase()) { 
case 'allow': 
callback(null, generateAuthResponse(token, 'Allow')); 
case 'deny': 
callback(null, generateAuthResponse(token, 'Deny')); 
default: 
callback(&quot;Error: Invalid token&quot;); 
}
};
// Helper function to generate authorization response 
var generateAuthResponse = function(token, effect) { 
// Invoke your preferred identity provider 
// to get the authN and authZ response. 
// Following is just for simplicity sake 
var authResponse = {}; 
authResponse.isAuthenticated = true; 
authResponse.principalId = 'principalId'; 
var policyDocument = {}; 
policyDocument.Version = '2012-10-17'; 
policyDocument.Statement = []; 
var statement = {}; 
statement.Action = 'iot:Publish'; 
statement.Effect = effect; 
statement.Resource = &quot;arn:aws:iot:us-east-1:&lt;your_aws_account_id&gt;:topic/customauthtesting&quot;; 
policyDocument.Statement[0] = statement; 
authResponse.policyDocuments = [policyDocument]; 
authResponse.disconnectAfterInSeconds = 3600; 
authResponse.refreshAfterInSeconds = 600; 
return authResponse; 
}</code> 
<p>The preceding function takes an authorization token and returns an object containing the five attributes (a-e) described earlier in this step.</p> 
<h3>2.&nbsp; Create an authorizer</h3> 
<p>Now that you have created the Lambda function, you will create an authorizer with AWS IoT pointing to the Lambda function. You do this so that you can easily control which Lambda function to invoke to verify an authorization token. The following attributes are required to create an authorizer:</p> 
<ol type="a"> 
<li><code>AuthorizerName</code>: This is the name of the authorizer. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>AuthorizerFunctionArn</code>: This is the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the Lambda function that you created in the previous step.</li> 
<li><code>TokenKeyName</code>: This specifies the key name that your device chooses, which indicates the token in the custom authorization HTTP request header. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>TokenSigningPublicKeys</code>: This is a map of one (minimum) and two (maximum) public keys. It is a 2,048-bit key at minimum. You need to generate a key pair, sign the custom authorization token and include the digital signature in the request in order to be able to use custom authorization successfully. AWS IoT needs the corresponding public key to verify the digital signature. Therefore, you must provide the public key while creating an authorizer.</li> 
<li><code>Status</code>: This specifies the status (<code>ACTIVE</code> or <code>INACTIVE</code>) of the authorizer. It is optional. The default value is <code>INACTIVE</code>.</li> 
</ol> 
<p>Run the following command in OpenSSL to create an RSA key pair that will be used to generate a token signature.</p> 
<code class="lang-text">openssl genrsa -out private.pem 2048</code> 
<p>Run the following command to create the public key out of the key pair generated in the previous step.</p> 
<code class="lang-text">openssl rsa -in private.pem -outform PEM -pubout -out public.pem</code> 
<p>You need to store the key pair securely and pass the public key in the <code>TokenSigningPublicKeys</code> parameter when creating the authorizer in AWS IoT. You will use the private key in the key pair to sign the authorization token and include the signature in the custom authorization request.</p> 
<p>Run the following command in the AWS CLI to create an authorizer.</p> 
<code class="lang-text">aws iot create-authorizer --authorizer-name &lt;authorizer_name&gt; --authorizer-function-arn &lt;Lambda_function_arn&gt; --token-key-name &lt;token_key_name&gt; --token-signing-public-keys FIRST_KEY=&quot;&lt;public_key_pem&gt;&quot; --status ACTIVE</code> 
<p>The following is sample output of the <code>create-authorizer</code> command. It contains the <code>authorizerName</code> and <code>authorizerArn</code>.</p> 
<code class="lang-text">{
&quot;authorizerName&quot;: &quot;MyAuthorizer&quot;, 
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;
}</code> 
<p>You must set the authorizer in the <code>ACTIVE</code> status to be invoked. The <code>describe-authorizer</code> API returns the attributes of an existing authorizer. You can use the following command to verify if all the attributes in the authorizer are set correctly.</p> 
<code class="lang-text">aws iot describe-authorizer --authorizer-name &lt;authorizer_name&gt;</code> 
<p>The following is sample output of the <code>describe-authorizer</code> command.</p> 
<code class="lang-text">{
&quot;authorizerDescription&quot;: {
&quot;status&quot;: &quot;ACTIVE&quot;,
&quot;lastModifiedDate&quot;: 1515351241.568,
&quot;authorizerName&quot;: &quot;&lt;authorizer_name&gt;&quot;,
&quot;tokenKeyName&quot;: &quot;&lt;token_key_name&gt;&quot;,
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;,
&quot;tokenSigningPublicKeys&quot;: {
FIRST_KEY&quot;: &quot;&lt;public_key_pem&gt;&quot;
},
&quot;creationDate&quot;: 1515351241.568,
&quot;authorizerFunctionArn&quot;: &quot;arn:aws:lambda:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:function:MyCustomAuthFunction&quot;
}
}</code> 
<h3>3.&nbsp; Designate the default authorizer (optional)</h3> 
<p>You can have multiple authorizers in your account. You can designate one of them as the default so that AWS IoT invokes it if the custom authorization request does not specify an authorizer name. Run the following command in the AWS CLI to designate a default authorizer.</p> 
<code class="lang-text">aws iot set-default-authorizer --authorizer-name &lt;authorizer_name&gt;</code> 
<p>The following is sample output of the <code>set-default-authorizer</code> command. It contains the <code>authorizerName</code> and <code>authorizerArn</code>.</p> 
<code class="lang-text">{
&quot;authorizerName&quot;: &quot;MyAuthorizer&quot;, 
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;
}</code> 
<h3>4. Add Lambda invocation permissions</h3> 
<p>AWS IoT needs to invoke your authorizer Lambda function to evaluate the custom authorizer token. You need to provide AWS IoT appropriate permissions to invoke your Lambda function when a custom authorization request is made. Use the AWS CLI with the <a href="http://docs.aws.amazon.com/lambda/latest/dg/API_AddPermission.html" target="_blank" rel="noopener noreferrer">AddPermission</a>&nbsp;command to grant the AWS IoT service principal permission to call <code>lambda:InvokeFunction</code>, as shown in the following command.</p> 
<code class="lang-text">aws lambda add-permission --function-name &lt;lambda_function_name&gt; --principal iot.amazonaws.com --source-arn &lt;authorizer_arn&gt; --statement-id Id-123 --action &quot;lambda:InvokeFunction&quot;</code> 
<p>The following is sample output of the <code>add-permission</code> command.</p> 
<code class="lang-text">{
&quot;Statement&quot;: &quot;{\&quot;Sid\&quot;:\&quot;Id-123\&quot;,\&quot;Effect\&quot;:\&quot;Allow\&quot;,\&quot;Principal\&quot;:{\&quot;Service\&quot;:\&quot;iot.amazonaws.com\&quot;},\&quot;Action\&quot;:\&quot;lambda:InvokeFunction\&quot;,\&quot;Resource\&quot;:\&quot;arn:aws:lambda:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:function:MyCustomAuthFunction\&quot;,\&quot;Condition\&quot;:{\&quot;ArnLike\&quot;:{\&quot;AWS:SourceArn\&quot;:\&quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer\&quot;}}}&quot;
}</code> 
<p>Note that you are using the precreated <code>AuthorizerArn</code> as the <code>SourceArn</code> while granting the permission. The Lambda function gets triggered only if the source ARN provided by AWS IoT during the invocation matches with the <code>SourceArn</code> that you have given permission. Even if your Lambda function ARN is put in an authorizer owned by someone else, they cannot trigger the function causing illegitimate charge to you.</p> 
<h3>5. Test the Lambda function</h3> 
<p>To verify the configuration, test to see if AWS IoT can invoke the Lambda function and get the correct output. You can do this by using the <a href="https://docs.aws.amazon.com/cli/latest/reference/iot/test-invoke-authorizer.html" target="_blank" rel="noopener noreferrer">TestInvokeAuthorizer</a> API. The API takes the following input:</p> 
<ol type="a"> 
<li><code>AuthorizerName</code>: This is the name of the authorizer. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>Token</code>: This specifies the custom authorization token&nbsp;to authorize the request to the AWS IoT gateway. It is a string; the minimum length is 1 character, and the maximum length is 1,024 characters.</li> 
<li><code>TokenSignature</code>: This is the token signature generated by using the private key with the SHA256withRSA algorithm. This is a string with a maximum length 2,560 characters<strong>. </strong>You must Base64-encode the signature while passing it as an input (the command follows).</li> 
</ol> 
<p>Run the following command in OpenSSL to generate a signature for string, <code>allow</code>.</p> 
<code class="lang-text">echo -n allow &gt; token.txt
openssl dgst -sha256 -sign private.pem -out token.sign token.txt</code> 
<p>Run the following command to Base64-encode the string.</p> 
<code class="lang-text">base64 token.sign &gt; token.sign.b64</code> 
<p>Now, run the following command in the AWS CLI to test your authorizer.</p> 
<code class="lang-text">aws iot test-invoke-authorizer --authorizer-name &lt;authorizer_name&gt; --token allow --token-signature &lt;token_signature&gt;</code> 
<p>If AWS IoT is able to invoke the Lambda function successfully, the output of the <code>TestInvokeAuthorizer</code> API will be exactly the same as the output of the Lambda function. The following is sample output of the <code>test-invoke-authorizer</code> command for the Lambda function you created in Step 1 earlier in this post.</p> 
<code class="lang-text">{
&quot;isAuthenticated&quot;: true,
&quot;refreshAfterInSeconds&quot;: 600,
&quot;policyDocuments&quot;: [
{\&quot;Version\&quot;:\&quot;2012-10-17\&quot;,\&quot;Statement\&quot;:[{\&quot;Action\&quot;:\&quot;iot:Publish\&quot;,\&quot;Effect\&quot;:\&quot;Allow\&quot;,\&quot;Resource\&quot;:\&quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:topic/customauthtesting\&quot;}]}&quot;
],
&quot;disconnectAfterInSeconds&quot;: 3600,
&quot;principalId&quot;: &quot;principalId&quot;
}</code> 
<h3>6. Invoke the custom authorizer</h3> 
<p>You can now make a custom authorization request to the AWS IoT gateway. Custom authorization is supported for HTTPS over TLS server authentication and MQTT over WebSocket connections. Regardless of the protocol, requests must include the following attributes in the header. Note that supplying these attributes through query parameters is not allowed for security reasons.</p> 
<ol type="a"> 
<li><code>Token</code>: This specifies the authorization token. The header name must be the same as the <code>TokenKeyName</code> of the authorizer.</li> 
<li><code>TokenSignature</code>: This specifies the Base64-encoded digital signature of the token string. The header name must be <code>x-amz-customauthorizer-signature</code>.</li> 
<li><code>AuthorizerName</code>: This specifies the name of one of the <code>ACTIVE</code> authorizers preconfigured in your account. The header name must be <code>x-amz-customauthorizer-name</code>. If this field is not present and you have preconfigured a default custom authorizer for your account, the AWS IoT gateway invokes the default authorizer to authenticate and authorize the request.</li> 
</ol> 
<p>Run the following command in the AWS CLI to obtain your AWS account-specific AWS IoT endpoint. See the <a href="https://docs.aws.amazon.com/iot/latest/apireference/API_DescribeEndpoint.html" target="_blank" rel="noopener noreferrer">DescribeEndpoint API documentation</a> for further details. You need to specify the endpoint when making requests to the AWS IoT gateway.</p> 
<code class="lang-text">aws iot describe-endpoint</code> 
<p>The following is sample output of the <code>describe-endpoint</code> command. It contains the <code>endpointAddress</code>.</p> 
<code class="lang-text">{
&quot;endpointAddress&quot;: &quot;&lt;<span style="color: #ff0000"><strong>your_aws_account_specific_prefix</strong></span>&gt;.iot.us-east-1.amazonaws.com&quot;
}</code> 
<p>Now, make an HTTPS request to the AWS IoT gateway to post a message. You may use your preferred HTTP client for the request. I use <a href="https://curl.haxx.se/docs/manpage.html" target="_blank" rel="noopener noreferrer">curl</a> in the following example, which posts the message, “Hello from custom auth,” to an MQTT topic, <code>customauthtesting</code>, by using the token, <code>allow</code>.</p> 
<code class="lang-text">curl -X POST -k -i -N -H &quot;Host: &lt;your_aws_iot_endpoint&gt;&quot; -H &quot;X-Amz-CustomAuthorizer-Name: &lt;authorizer_name&gt;&quot; -H &quot;X-Amz-CustomAuthorizer-Signature: &lt;token_signature&gt;&quot; -H &quot;&lt;token_key_name&gt;: allow&quot; -H &quot;User-Agent: aws-cli/1.10.65 Python/2.7.11 Darwin/16.1.0 botocore/1.4.55&quot; --data 'Hello from custom auth' https://&lt;your_aws_iot_endpoint&gt;/topics/customauthtesting</code> 
<p>If the command succeeds, you will see the following output.</p> 
<code class="lang-text">HTTP/1.1 200 OK
content-type: application/json
content-length: 65
date: Sun, 07 Jan 2018 19:56:12 GMT
x-amzn-RequestId: e7c13873-6c61-a12c-1216-9a935901c130
connection: keep-alive
{&quot;message&quot;:&quot;OK&quot;,&quot;traceId&quot;:&quot;e7c13873-6c61-a12c-1216-9a935901c130&quot;}</code> 
<h3>Conclusion</h3> 
<p>In this blog post, I have shown how to configure a custom authorizer in your AWS account and use it to authorize an HTTPS over TLS server authentication connection and publish a message to a specific MQTT topic by using a custom authorization token. Similarly, you can use custom authorizers to authorize MQTT over WebSocket requests to the AWS IoT gateway to publish messages to a specific topic or subscribe to a topic filter.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions about or issues implementing this solution, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=210" target="_blank" rel="noopener noreferrer">AWS IoT forum</a>.</p> 
<p>– Ramkishore</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7208');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/13/Marketo_1200x350_SF_1200x250111.png" /> 
<b class="lb-b blog-post-title" property="name headline">Join Us for AWS Security Week February 20–23 in San Francisco!</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><a href="https://aws.amazon.com/blogs/security/author/clieb/" title="Posts by Craig Liebendorfer" property="name">Craig Liebendorfer</a></span> | on 
<time property="datePublished" datetime="2018-02-13T07:32:31+00:00">13 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/" title="View all posts in Security, Identity, &amp; Compliance*"><span property="articleSection">Security, Identity, &amp; Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/join-us-for-aws-security-week-february-20-23-in-san-francisco/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7226" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7226&amp;disqus_title=Join+Us+for+AWS+Security+Week+February+20%E2%80%9323+in+San+Francisco%21&amp;disqus_url=https://aws.amazon.com/blogs/security/join-us-for-aws-security-week-february-20-23-in-san-francisco/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7226');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/Marketo_1200x350_SF_1200x25011.png" /></p> 
<p><a href="https://awssecurityweeksanfranciscofeb2018.splashthat.com/" target="_blank" rel="noopener noreferrer">Join us</a> for AWS Security Week, February 20–23 at the AWS Pop-up Loft in San Francisco, where&nbsp;you can participate in four days of themed content that will help you secure your workloads on AWS. Each day will highlight a different security and compliance topic, and will include an overview session, a customer or partner speaker, a deep dive into the day’s topic, and a hands-on lab or demos of relevant AWS or partner services.</p> 
<p>Tuesday (February 20) will kick off the week with a day devoted to identity and governance. On Wednesday, we will dig into secure configuration and automation, including a discussion about upcoming General Data Protection Regulation (GDPR) requirements. On Thursday, we will cover threat detection and remediation, which will include&nbsp;an Amazon GuardDuty lab. And on Friday, we will discuss incident response on AWS.</p> 
<p>Sessions, demos, and labs about each of these topics will be led by seasoned security professionals from AWS, who will help you understand not just the basics, but also the nuances of building applications in the AWS Cloud in a robust and secure manner. AWS subject-matter experts will be available for “Ask the Experts” sessions during breaks.</p> 
<p><a href="https://awssecurityweeksanfranciscofeb2018.splashthat.com/" target="_blank" rel="noopener noreferrer">Register today</a>!</p> 
<p>– Craig</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7226');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/Amazon-DynamoDB_1024x512.jpg" /> 
<b class="lb-b blog-post-title" property="name headline">Now Available: Encryption at Rest for Amazon DynamoDB</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Nitin Sagar</span></span> | on 
<time property="datePublished" datetime="2018-02-08T13:49:35+00:00">08 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/database/amazon-dynamodb/" title="View all posts in Amazon DynamoDB*"><span property="articleSection">Amazon DynamoDB*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-available-encryption-at-rest-for-amazon-dynamodb/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7181" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7181&amp;disqus_title=Now+Available%3A+Encryption+at+Rest+for+Amazon+DynamoDB&amp;disqus_url=https://aws.amazon.com/blogs/security/now-available-encryption-at-rest-for-amazon-dynamodb/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7181');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/Amazon-DynamoDB_512x256.jpg" /></p> 
<p>Today, AWS announced <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noopener noreferrer">Amazon DynamoDB</a>&nbsp;encryption at rest, a new DynamoDB feature that&nbsp;gives you enhanced security of your data at rest by encrypting it using your associated <a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service</a>&nbsp;encryption keys.&nbsp;Encryption at rest can help you&nbsp;meet your security requirements for regulatory compliance.</p> 
<p>You now can create an encrypted DynamoDB table anytime with a single click in the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS Management Console</a> or a single API call. Encrypting DynamoDB data has no impact on table performance. DynamoDB encryption at rest is available starting today in the US East (N. Virginia), US East (Ohio), US West (Oregon), and Europe (Ireland) Regions for no additional fees.</p> 
<p>For more information, see the full <a href="https://aws.amazon.com/blogs/aws/new-encryption-at-rest-for-dynamodb/">AWS Blog post</a>.</p> 
<p>– Nitin</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7181');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_companydirectory_0218-1144x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Search More Efficiently in Amazon Cloud Directory</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Mahendra Chheda</span></span> | on 
<time property="datePublished" datetime="2018-02-07T07:58:40+00:00">07 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/amazon-cloud-directory/" title="View all posts in Amazon Cloud Directory*"><span property="articleSection">Amazon Cloud Directory*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-search-more-efficiently-in-amazon-cloud-directory/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7172" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7172&amp;disqus_title=How+to+Search+More+Efficiently+in+Amazon+Cloud+Directory&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-search-more-efficiently-in-amazon-cloud-directory/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7172');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Using <a href="https://aws.amazon.com/clouddirectory/" target="_blank" rel="noopener noreferrer">Amazon Cloud Directory</a>, you can build flexible, cloud-native directories for organizing hierarchies of data along multiple dimensions. And now, you can search more efficiently by searching across only a subset of objects in your directory. For example, instead of searching through all of the employees in a company directory built using Cloud Directory, you can choose to search only full-time employees or contractors.</p> 
<p>To search across such a subset of objects, you must first create a facet-based index. A <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/whatarefacets.html" target="_blank" rel="noopener noreferrer">facet</a> is a set of attributes defined in a <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/cd_schemas.html" target="_blank" rel="noopener noreferrer">schema</a> that is associated with a <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/objectsandlinks.html" target="_blank" rel="noopener noreferrer">directory object</a>. Using facets, you can create different object types in your directory. For instance, you can create different facets for full-time employees and contractors in a schema and then create full-time employee objects and contractor objects. You then can create an index of all the objects that include a specific facet and search those objects more efficiently.</p> 
<p>In this blog post, I show how you can create a facet-based index in Cloud Directory to more efficiently search for objects in your directory.</p> 
<h3>Scenario: Searching a company directory for a specific employee type</h3> 
<p>Let’s say a company called AnyCompany wants to be able to efficiently search in Cloud Directory for information about its full-time employees and contractors. To do this, AnyCompany must create a company directory using Cloud Directory. (If AnyCompany already had a company directory using Cloud Directory, they could use that directory instead.) AnyCompany starts by creating <code>DirectorySchema</code>, which is a schema that includes three facets: <code>FullTimeEmployeeFacet</code>, <code>ManagerFacet</code>, and <code>ContractorFacet</code>.</p> 
<code class="lang-text"><strong>Schema: DirectorySchema</strong>
<strong>Facet: FullTimeEmployeeFacet</strong>
Attribute: EmployeeId, type: Integer
Attribute: Name, type: String
Attribute: EMail, type: String
Attribute: Salary, type: Integer
<strong>Facet: ManagerFacet</strong>
Attribute: Budget, type: Integer
Attribute: LeaveApproval, type: Boolean
<strong>Facet: ContractorFacet</strong>
Attribute: Name, type: String
Attribute: EMail, type: String
Attribute: VendorCompany, type: String
Attribute: VendorPO, type: Integer</code> 
<p>The following diagram is a visual representation of AnyCompany’s company directory, and it includes full-time employees and contractors in a reporting hierarchy. The full-time employees are shown in blue nodes and the contractors are shown in green nodes. The directory’s three facets are shown as they correspond to full-time employees, managers, and contractors.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_companydirectory_0218.png" /></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_legend_0218.png" /></p> 
<p>To more efficiently search your directory, follow these steps:</p> 
<ol> 
<li>Create a facet-based index that includes the facets you want to use when searching.</li> 
<li>Populate the index with the appropriate employee objects.</li> 
<li>List all the objects in the index.</li> 
<li>List objects in the index that include a specific facet.</li> 
</ol> 
<h4><strong>1. Create a facet-based index that includes the facets you want to use when searching</strong></h4> 
<p>The following code example creates a facet-based index of the employee objects in the directory. Cloud Directory currently supports only simple indexes, which means that an index object can only store one type of value, such as a facet.</p> 
<code class="lang-text">     // Create an index
// <span style="color: #ff0000"><strong>&lt;region&gt;</strong></span> indicates an AWS Region value such as “us-east-1”
// <span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span> indicates your AWS account ID
// <span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span> indicates your Cloud Directory ID
// The schemaArn points to the specific schema, which is DirectorySchema
String schemaArn = &quot;arn:aws:clouddirectory:<span style="color: #ff0000"><strong>&lt;region&gt;</strong></span>:<span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span>:directory/<span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span>/schema/DirectorySchema/1.0&quot; ;
// I define attributes that I want to use for indexing. In this case, I use “facets” to define an 
// attribute for indexing. This is a hard-coded value that is defined by Cloud Directory.
AttributeKey indexAttributeKey = new AttributeKey()    
.withSchemaArn(schemaArn)
.withFacetName(&quot;facets&quot;)
.withName(&quot;facets&quot;) ;
List&lt;AttributeKey&gt; orderedIndexedAttributeList = new ArrayList&lt;AttributeKey&gt;() ;
orderedIndexedAttributeList.add(indexAttributeKey) ;
// The directoryArn points to the specific directory that I am working on 
String directoryArn = &quot;arn:aws:clouddirectory:<span style="color: #ff0000"><strong>&lt;region&gt;</strong></span>:<span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span>:directory/<span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span>&quot; ;
// I create the index request and pass in the directoryArn and my attribute list. 
// Because I am defining the facetIndex at the root of my directory, my parentReference is the root of the directory
// For LinkName, I have defined “MyFacetIndex,” as shown in the diagram
ObjectReference dirRoot = new ObjectReference().withSelector(&quot;/&quot;); // Directory root
CreateIndexRequest createRequest = new CreateIndexRequest()
.withDirectoryArn(directoryArn)
.withOrderedIndexedAttributeList(orderedIndexedAttributeList)
.withIsUnique(false)
.withParentReference(dirRoot)  // Attach to directory root
.withLinkName(&quot;MyFacetIndex&quot;) ;
// I assign the indexed object to facetIndex 
CreateIndexResult facetIndexResult = cloudDirectoryClient.createIndex(createRequest) ;
ObjectReference facetIndex = new ObjectReference().withSelector(facetIndexResult.getObjectIdentifier());</code> 
<h4>2.&nbsp;<strong>Populate the index with the appropriate employee objects</strong></h4> 
<p>Next, I add all the objects that I want to include in the index. The following code example adds objects to <code>facetIndex</code>.</p> 
<code class="lang-text">     // I assume userObj1 is “Tim”. The following code adds “Tim” to the index. 
// Create an index attach request with the directory, facet, and object details
AttachToIndexRequest indexAttachRequest = new AttachToIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)
.withTargetReference(userObj1) ;
// Add the object to the index
cloudDirectoryClient.attachToIndex(indexAttachRequest) ;
// You can follow the same code pattern to add other full-time employee and contractor objects to the index. </code> 
<h4>3. List all the objects in the index</h4> 
<p>Now, I can query my directory efficiently for the set of objects I have in <code>facetIndex</code>. The following code example returns all the objects in your index.</p> 
<code class="lang-text">     // List all objects in the facet-based index 
ListIndexResult listResults = cloudDirectoryClient.listIndex(new ListIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)) ;</code> 
<p><strong>4. List objects in the index that include a specific facet</strong></p> 
<p>I can add a filter for retrieving subsets of objects in the index that contain a specific facet. The following code example shows how to add a filter to the query so that only objects that contain the facet <code>FullTimeEmployeeFacet</code> are returned.</p> 
<code class="lang-text">     // I choose the specific facet I will use for filtering my query and get all objects that contain this facet in them.
String filterString = &quot;DirectorySchema/1.0/FullTimeEmployeeFacet&quot; ;
TypedAttributeValue filterStringValue = new TypedAttributeValue().withStringValue(filterString);
// I define the filter range and mention both the start mode and end mode as inclusive because I will query for a specific facet 
ObjectAttributeRange objectAttributeRange = new ObjectAttributeRange()
.withAttributeKey(new AttributeKey()
.withFacetName(&quot;facets&quot;)
.withName(&quot;facets&quot;) 
.withSchemaArn(schemaArn))
.withRange(new TypedAttributeValueRange()
.withStartMode(RangeMode.INCLUSIVE)
.withStartValue(filterStringValue)
.withEndMode(RangeMode.INCLUSIVE)
.withEndValue(filterStringValue)) ; // Query for objects with FullTimeEmployeeFacet which is defined in filterString
// List the index results
ListIndexResult filteredResults = cloudDirectoryClient.listIndex(new ListIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)
.withRangesOnIndexedValues(objectAttributeRange)) ;</code> 
<p>Using this subset of objects, I can now search for a specific employee without searching across all the objects in my directory.</p> 
<b>Summary</b> 
<p>You can use facet-based indexing to search your directory more efficiently by searching across only a subset of objects in of your directory. For more information about this feature, see <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/cd_indexing.html" target="_blank" rel="noopener noreferrer">Indexing and Search</a>.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions about implementing the solution in this blog post, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=180&amp;start=0" target="_blank" rel="noopener noreferrer">Directory Service forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Mahendra</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7172');
});
</script> 
</article> 
<p>
© 2018 Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
