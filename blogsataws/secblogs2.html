<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/secblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Security Blogs @ AWS" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Security Blogs @ AWS</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li>
        <a href="blogsataws1.html">Blogs @ AWS</a>
      </li>

      <li>
        <a href="whatsnew1.html">What's New @ AWS</a>
      </li>
      <li class="active">
        <a href="secblogs1.html">Security Blogs @ AWS</a>
      </li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="secblogs1.html">Page 1</a>|<a href="secblogs2.html">Page 2</a>|<a href="secblogs3.html">Page 3</a>|<a href="secblogs4.html">Page 4</a></p>
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Enable LDAPS for Your AWS Microsoft AD Directory</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Vijay Sharma</span></span> | on 
<time property="datePublished" datetime="2017-09-26T06:01:19+00:00">26 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-directory-service/" title="View all posts in AWS Directory Service*"><span property="articleSection">AWS Directory Service*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-enable-ldaps-for-your-aws-microsoft-ad-directory/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-5161" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=5161&amp;disqus_title=How+to+Enable+LDAPS+for+Your+AWS+Microsoft+AD+Directory&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-enable-ldaps-for-your-aws-microsoft-ad-directory/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5161');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Starting today, you can encrypt the <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_ldap.html" target="_blank" rel="noopener noreferrer">Lightweight Directory Access Protocol</a> (LDAP) communications between your applications and <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">AWS Directory Service for Microsoft Active Directory</a>, also known as AWS Microsoft AD. Many Windows and Linux applications use Active Directory’s (AD) LDAP service to read and write sensitive information about users and devices, including personally identifiable information (PII). Now, you can encrypt your AWS Microsoft AD LDAP communications end to end to protect this information by using LDAP Over Secure Sockets Layer (SSL)/Transport Layer Security (TLS), also called LDAPS. This helps you protect PII and other sensitive information exchanged with AWS Microsoft AD over untrusted networks.</p> 
<p>To enable LDAPS, you need to add a <a href="https://msdn.microsoft.com/en-us/library/cc875810.aspx" target="_blank" rel="noopener noreferrer">Microsoft enterprise Certification Authority (CA)</a> server to your AWS Microsoft AD domain and configure certificate templates for your domain controllers. After you have enabled LDAPS, AWS Microsoft AD encrypts communications with LDAPS-enabled Windows applications, Linux computers that use Secure Shell (SSH) authentication, and applications such as <a href="https://www.atlassian.com/software/jira" target="_blank" rel="noopener noreferrer">Jira</a> and <a href="https://jenkins.io/" target="_blank" rel="noopener noreferrer">Jenkins</a>.</p> 
<p>In this blog post, I show how to enable LDAPS for your AWS Microsoft AD directory in six steps: 1) Delegate permissions to CA administrators, 2) Add a Microsoft enterprise CA to your AWS Microsoft AD directory, 3) Create a certificate template, 4) Configure AWS security group rules, 5) AWS Microsoft AD enables LDAPS, and 6) Test LDAPS access using the LDP tool.<span id="more-5161"></span></p> 
<h3>Assumptions</h3> 
<p>For this post, I assume you are familiar with following:</p> 
<ul> 
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">Creating an Amazon EC2 for Windows Server instance</a> and <a href="https://aws.amazon.com/blogs/aws/seamlessly-join-ec2-instances-to-a-domain/" target="_blank" rel="noopener noreferrer">seamlessly joining it to your AWS Microsoft AD domain</a>.</li> 
<li>Logging in to an <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/connecting_to_windows_instance.html" target="_blank" rel="noopener noreferrer">Amazon EC2 for Windows Server instance using Remote Desktop Protocol (RDP)</a>.</li> 
<li>Launching and using <a href="https://technet.microsoft.com/en-us/library/cc732131(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">Microsoft Windows Server Manager</a>.</li> 
<li>Launching <a href="https://docs.microsoft.com/en-us/powershell/scripting/setup/starting-windows-powershell-on-earlier-versions-of-windows?view=powershell-5.1" target="_blank" rel="noopener noreferrer">Windows PowerShell with administrative privileges</a> and <a href="https://docs.microsoft.com/en-us/powershell/scripting/core-powershell/ise/how-to-write-and-run-scripts-in-the-windows-powershell-ise?view=powershell-5.1" target="_blank" rel="noopener noreferrer">running Windows PowerShell scripts</a>.</li> 
</ul> 
<h3>Solution overview</h3> 
<p>Before going into specific deployment steps, I will provide a high-level overview of deploying LDAPS. I cover how you enable LDAPS on AWS Microsoft AD. In addition, I provide some general background about CA deployment models&nbsp;and explain how to apply these models when deploying Microsoft CA to enable LDAPS on AWS Microsoft AD.</p> 
<h4>How you enable LDAPS on AWS Microsoft AD</h4> 
<p>LDAP-aware applications (LDAP clients) typically access LDAP servers using Transmission Control Protocol (TCP) on port 389. By default, LDAP communications on port 389 are unencrypted. However, many LDAP clients use one of two standards to encrypt LDAP communications: LDAP over SSL on port 636, and LDAP with <a href="https://tools.ietf.org/html/rfc2830" target="_blank" rel="noopener noreferrer">StartTLS</a> on port 389. If an LDAP client uses port 636, the LDAP server encrypts all traffic unconditionally with SSL. If an LDAP client issues a StartTLS command when setting up the LDAP session on port 389, the LDAP server encrypts all traffic to that client with TLS. AWS Microsoft AD now supports both encryption standards when you enable LDAPS on your AWS Microsoft AD domain controllers.</p> 
<p>You enable LDAPS on your AWS Microsoft AD domain controllers by installing a digital certificate that a CA issued. Though Windows servers have different methods for installing certificates, LDAPS with AWS Microsoft AD requires you to add a Microsoft CA to your AWS Microsoft AD domain and deploy the certificate through autoenrollment from the Microsoft CA. The installed certificate enables the LDAP service running on domain controllers to listen for and negotiate LDAP encryption on port 636 (LDAP over SSL) and port 389 (LDAP with StartTLS).</p> 
<h3>Background of CA deployment models</h3> 
<p>You can deploy CAs as part of a single-level or multi-level <a href="https://technet.microsoft.com/en-us/library/cc962065.aspx" target="_blank" rel="noopener noreferrer">CA hierarchy</a>. In a single-level hierarchy, all certificates come from the root of the hierarchy. In a multi-level hierarchy, you organize a collection of CAs in a hierarchy and the certificates sent to computers and users come from subordinate CAs in the hierarchy (not the root).</p> 
<p>Certificates issued by a CA identify the hierarchy to which the CA belongs. When a computer sends its certificate to another computer for verification, the receiving computer must have the public certificate from the CAs in the same hierarchy as the sender. If the CA that issued the certificate is part of a single-level hierarchy, the receiver must obtain the public certificate of the CA that issued the certificate. If the CA that issued the certificate is part of a multi-level hierarchy, the receiver can obtain a public certificate for all the CAs that are in the same hierarchy as the CA that issued the certificate. If the receiver can verify that the certificate came from a CA that is in the hierarchy of the receiver’s “trusted” public CA certificates, the receiver trusts the sender. Otherwise, the receiver rejects the sender.</p> 
<h4>Deploying Microsoft CA to enable LDAPS on AWS Microsoft AD</h4> 
<p>Microsoft offers a standalone CA and an enterprise CA. Though you can configure either as single-level or multi-level hierarchies, only the enterprise CA integrates with AD and offers autoenrollment for certificate deployment. Because you cannot sign in to run commands on your AWS Microsoft AD domain controllers, an automatic certificate enrollment model is required. Therefore, AWS Microsoft AD requires the certificate to come from a Microsoft enterprise CA that you configure to work in your AD domain. When you install the Microsoft enterprise CA, you can configure it to be part of a single-level hierarchy or a multi-level hierarchy. As a best practice, AWS recommends a multi-level <a href="https://technet.microsoft.com/en-us/library/cc962065.aspx" target="_blank" rel="noopener noreferrer">Microsoft CA trust hierarchy</a> consisting of a root CA and a subordinate CA. I cover only a multi-level hierarchy in this post.</p> 
<p>In a multi-level hierarchy, you configure your subordinate CA by importing a certificate from the root CA. You must issue a certificate from the root CA such that the certificate gives your subordinate CA the right to issue certificates on behalf of the root. This makes your subordinate CA part of the root CA hierarchy. You also deploy the root CA’s public certificate on all of your computers, which tells all your computers to trust certificates that your root CA issues and to trust certificates from any authorized subordinate CA.</p> 
<p>In such a hierarchy, you typically leave your root CA offline (inaccessible to other computers in the network) to protect the root of your hierarchy. You leave the subordinate CA online so that it can issue certificates on behalf of the root CA. This multi-level hierarchy increases security because if someone compromises your subordinate CA, you can revoke all certificates it issued and set up a new subordinate CA from your offline root CA. To learn more about setting up a secure CA hierarchy, see <a href="https://technet.microsoft.com/en-us/library/dn786436(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">Securing PKI: Planning a CA Hierarchy</a>.</p> 
<p>When a Microsoft CA is part of your AD domain, you can configure certificate templates that you publish. These templates become visible to client computers through AD. If a client’s profile matches a template, the client requests a certificate from the Microsoft CA that matches the template. Microsoft calls this process <em>autoenrollment,</em> and it simplifies certificate deployment. To enable LDAPS on your AWS Microsoft AD domain controllers, you create a certificate template in the Microsoft CA that generates SSL and TLS-compatible certificates. The domain controllers see the template and automatically import a certificate of that type from the Microsoft CA. The imported certificate enables LDAP encryption.</p> 
<h3>Steps to enable LDAPS for your AWS Microsoft AD directory</h3> 
<p>The rest of this post is composed of the steps&nbsp;for enabling LDAPS for your AWS Microsoft AD directory. First, though, I explain which components you must have running to deploy this solution successfully. I also explain how this solution works and include an architecture diagram.</p> 
<h4>Prerequisites</h4> 
<p>The instructions in this post assume that you already have the following components running:</p> 
<ol> 
<li><strong>An active AWS Microsoft AD directory –</strong> To create a directory, follow the steps in <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/create_directory.html" target="_blank" rel="noopener noreferrer">Create an AWS Microsoft AD directory</a>.</li> 
<li><strong>An Amazon EC2 for Windows Server instance for managing users and groups in your directory </strong>– This instance needs to be <a href="https://aws.amazon.com/blogs/aws/seamlessly-join-ec2-instances-to-a-domain/" target="_blank" rel="noopener noreferrer">joined to your AWS Microsoft AD domain</a> and have <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/install_ad_tools.html" target="_blank" rel="noopener noreferrer">Active Directory Administration Tools</a>&nbsp;installed. Active Directory Administration Tools installs <a href="https://technet.microsoft.com/en-us/library/dd560651(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">Active Directory Administrative Center</a> and the <a href="https://technet.microsoft.com/en-us/library/cc772839(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">LDP tool</a>.</li> 
<li><strong>An existing root Microsoft CA or a multi-level Microsoft CA hierarchy</strong> – You might already have a root CA or a multi-level CA hierarchy in your on-premises network. If you plan to use your on-premises CA hierarchy, you must have <a href="https://technet.microsoft.com/en-us/library/dn786430(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">administrative permissions to issue certificates to subordinate CAs</a>. If you do not have an existing Microsoft CA hierarchy, you can set up a new standalone Microsoft root CA by creating an Amazon EC2 for Windows Server instance and <a href="https://technet.microsoft.com/en-us/library/cc731183(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">installing a standalone root certification authority</a>. You also must create a <a href="https://technet.microsoft.com/en-us/library/cc770642(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">local user account</a> on this instance and add this user to the <a href="https://www.isunshare.com/windows-server/add-a-user-to-local-administrator-group.html" target="_blank" rel="noopener noreferrer">local administrator group</a> so that the user has permissions to issue a certificate to a subordinate CA.</li> 
</ol> 
<h4>The solution setup</h4> 
<p>The following diagram illustrates the setup with the steps you need to follow to enable LDAPS for AWS Microsoft AD. You will learn how to set up a subordinate Microsoft enterprise CA (in this case, <span style="font-family: courier">SubordinateCA</span>) and join it to your AWS Microsoft AD domain (in this case, <span style="font-family: courier">corp.example.com</span>).&nbsp;You also will learn how to create a certificate template on <span style="font-family: courier">SubordinateCA</span> and configure AWS security group rules to enable LDAPS for your directory.</p> 
<p>As a prerequisite, I already created a standalone Microsoft root CA (in this case <span style="font-family: courier">RootCA</span>) for creating <span style="font-family: courier">SubordinateCA</span>. <span style="font-family: courier">RootCA</span> also has a local user account called <span style="font-family: courier">RootAdmin</span> that has administrative permissions to issue certificates to <span style="font-family: courier">SubordinateCA</span>. Note that you may already have a root CA or a multi-level CA hierarchy in your on-premises network that you can use for creating <span style="font-family: courier">SubordinateCA</span> instead of creating a new root CA. If you choose to use your existing on-premises CA hierarchy, you must have administrative permissions on your on-premises CA to issue a certificate to <span style="font-family: courier">SubordinateCA</span>.</p> 
<p>Lastly, I also already created an Amazon EC2 instance (in this case,&nbsp;<span style="font-family: courier">Management</span>) that I use to manage users, configure AWS security groups, and test the LDAPS connection. I join this instance to the AWS Microsoft AD directory domain.</p> 
<p><img class="alignnone wp-image-5166 size-full" title="Diagram showing the process discussed in this post" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/VS-Diagram1-0917-a.png" alt="Diagram showing the process discussed in this post" width="900" height="530" /></p> 
<p>Here is how the process works:</p> 
<ol> 
<li><a href="#step1">Delegate permissions to CA administrators</a> (in this case, <span style="font-family: courier">CAAdmin</span>) so that they can join a Microsoft enterprise CA to your AWS Microsoft AD domain and configure it as a subordinate CA.</li> 
<li><a href="#step2">Add a Microsoft enterprise CA to your AWS Microsoft AD domain</a> (in this case, <span style="font-family: courier">SubordinateCA</span>) so that it can issue certificates to your directory domain controllers to enable LDAPS. This step includes joining&nbsp;<span style="font-family: courier">SubordinateCA</span> to your directory domain, installing the Microsoft enterprise CA, and obtaining a certificate from&nbsp;<span style="font-family: courier">RootCA</span> that grants&nbsp;<span style="font-family: courier">SubordinateCA</span> permissions to issue certificates.</li> 
<li><a href="#step3">Create a certificate template</a> (in this case, <span style="font-family: courier">ServerAuthentication</span>) with server authentication and autoenrollment enabled so that your AWS Microsoft AD directory domain controllers can obtain certificates through autoenrollment to enable LDAPS.</li> 
<li><a href="#step4">Configure AWS security group rules</a> so that AWS Microsoft AD directory domain controllers can connect to the subordinate CA to request certificates.</li> 
<li><a href="#step5">AWS Microsoft AD enables LDAPS</a> through the following process: 
<ol> 
<li>AWS Microsoft AD domain controllers request a certificate from <span style="font-family: courier">SubordinateCA</span>.</li> 
<li><span style="font-family: courier">SubordinateCA</span> issues a certificate to AWS Microsoft AD domain controllers.</li> 
<li>AWS Microsoft AD enables LDAPS for the directory by installing certificates on the directory domain controllers.</li> 
</ol> </li> 
<li><a href="#step6">Test LDAPS access by using the LDP tool</a>.</li> 
</ol> 
<p>I now will show you these steps in detail. I use the names of components—such as <span style="font-family: courier">RootCA</span>, <span style="font-family: courier">SubordinateCA</span>, and <span style="font-family: courier">Management</span>—and refer to users—such as <span style="font-family: courier">Admin</span>, <span style="font-family: courier">RootAdmin</span>, and <span style="font-family: courier">CAAdmin</span>—to illustrate who performs these steps. All component names and user names&nbsp;in this post are used for illustrative purposes only.</p> 
<h3>Deploy the solution</h3> 
<h4>Step 1: Delegate permissions to CA administrators</h4> 
<p><a id="step1"></a><br /> In this step, you delegate permissions to your users who manage your CAs. Your users then can join a subordinate CA to your AWS Microsoft AD domain and create the certificate template in your CA.</p> 
<p>To enable use with a Microsoft enterprise CA, AWS added a new built-in AD security group called <span style="font-family: courier">AWS Delegated Enterprise Certificate Authority Administrators</span> that has <a href="https://technet.microsoft.com/en-us/library/dn722303(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">delegated permissions to install and administer a Microsoft enterprise CA</a>. By default, your directory <span style="font-family: courier">Admin</span> is part of the new group and can add other users or groups in your AWS Microsoft AD directory to this security group. If you have <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/setup_trust.html" target="_blank" rel="noopener noreferrer">trust with your on-premises AD directory</a>, you can also delegate CA administrative permissions to your on-premises users by adding on-premises AD users or <a href="https://technet.microsoft.com/en-us/library/cc755692(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">global groups</a> to this new AD security group.</p> 
<p>To create a new user (in this case <span style="font-family: courier">CAAdmin</span>) in your directory and add this user to the&nbsp;<span style="font-family: courier">AWS Delegated Enterprise Certificate Authority Administrators</span>&nbsp;security group, follow these steps:</p> 
<ol> 
<li>Sign in to the <span style="font-family: courier">Management</span> instance using RDP with the user name <span style="font-family: courier">admin</span> and the password that you set for the <span style="font-family: courier">admin</span> user when you created your directory.</li> 
<li>Launch the <strong>Microsoft Windows Server Manager</strong> on the <span style="font-family: courier">Management</span> instance and navigate to <strong>Tools</strong> &gt; <strong>Active Directory Users and Computers</strong>.<br /> <img class="alignnone wp-image-5167 size-full" title="Screnshot of the menu including the &quot;Active Directory Users and Computers&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.b-1.jpg" alt="Screnshot of the menu including the &quot;Active Directory Users and Computers&quot; choice" width="425" height="212" /></li> 
<li>Switch to the&nbsp;tree view<strong>&nbsp;</strong>and navigate to&nbsp;<strong>corp.example.com</strong> <strong>&gt;</strong> <strong>CORP</strong><strong> &gt; </strong><strong>Users</strong><strong>. </strong>Right-click <strong>Users</strong> and choose <strong>New</strong><strong> &gt; </strong><strong>User</strong><strong><strong>.</strong></strong><br /> <img class="alignnone wp-image-5182 size-full" title="Screenshot of choosing New &gt; User" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.c.jpg" alt="Screenshot of choosing New &gt; User" width="487" height="533" /></li> 
<li>Add a new user with the <strong>First name</strong> <span style="font-family: courier">CA</span>, <strong>Last name</strong> <span style="font-family: courier">Admin</span>, and <strong>User logon name</strong> <span style="font-family: courier">CAAdmin</span>.<br /> <img class="alignnone wp-image-5183 size-full" title="Screenshot of completing the &quot;New Object - User&quot; boxes" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.d.jpg" alt="Screenshot of completing the &quot;New Object - User&quot; boxes" width="462" height="397" /></li> 
<li>In the <strong>Active Directory Users and Computers</strong> tool<strong>, </strong>navigate to <strong>corp.example.com</strong> <strong>&gt; </strong><strong>AWS Delegated Groups</strong><strong>.</strong> In the right pane, right-click <strong>AWS Delegated Enterprise Certificate Authority Administrators</strong> and choose <strong>Properties</strong>.<br /> <img class="alignnone wp-image-5184 size-full" title="Screenshot of navigating to AWS Delegated Enterprise Certificate Authority Administrators &gt; Properties" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.e-1.jpg" alt="Screenshot of navigating to AWS Delegated Enterprise Certificate Authority Administrators &gt; Properties" width="835" height="379" /></li> 
<li>In the <strong>AWS Delegated Enterprise Certificate Authority Administrators</strong> window, switch to the <strong>Members</strong> tab and choose <strong>Add</strong>.<br /> <img class="alignnone wp-image-5185 size-full" title="Screenshot of the &quot;Members&quot; tab of the &quot;AWS Delegate Enterprise Certificate Authority Administrators&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.f.jpg" alt="Screenshot of the &quot;Members&quot; tab of the &quot;AWS Delegate Enterprise Certificate Authority Administrators&quot; window" width="670" height="653" /></li> 
<li>In the <strong>Enter the object names to select</strong> box, type <span style="font-family: courier">CAAdmin</span> and choose <strong>OK</strong>.<br /> <img class="alignnone wp-image-5186 size-full" title="Screenshot showing the &quot;Enter the object names to select&quot; box" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.g-1.jpg" alt="Screenshot showing the &quot;Enter the object names to select&quot; box" width="471" height="256" /></li> 
<li>In the next window, choose <strong>OK</strong> to add <span style="font-family: courier">CAAdmin</span> to the <span style="font-family: courier">AWS Delegated Enterprise Certificate Authority Administrators</span> security group<strong>.<br /> <img class="alignnone wp-image-5187 size-full" title="Screenshot of adding &quot;CA Admin&quot; to the &quot;AWS Delegated Enterprise Certificate Authority Administrators&quot; security group" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/1.h-1.jpg" alt="Screenshot of adding &quot;CA Admin&quot; to the &quot;AWS Delegated Enterprise Certificate Authority Administrators&quot; security group" width="414" height="461" /><br /> </strong></li> 
<li>Also add <span style="font-family: courier">CAAdmin</span> to the <span style="font-family: courier">AWS Delegated Server Administrators</span> security group so that <span style="font-family: courier">CAAdmin</span> can RDP in to the Microsoft enterprise CA machine<strong><strong>.</strong></strong><br /> <img class="alignnone wp-image-5257 size-full" title="Screenshot of adding &quot;CAAdmin&quot; to the &quot;AWS Delegated Server Administrators&quot; security group also so that &quot;CAAdmin&quot; can RDP in to the Microsoft enterprise CA machine" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/1.9-a-1-a.jpg" alt="Screenshot of adding &quot;CAAdmin&quot; to the &quot;AWS Delegated Server Administrators&quot; security group also so that &quot;CAAdmin&quot; can RDP in to the Microsoft enterprise CA machine" width="657" height="478" /></li> 
</ol> 
<p><strong>&nbsp;</strong>You have granted <span style="font-family: courier">CAAdmin</span> permissions to join a Microsoft enterprise CA to your AWS Microsoft AD directory domain.</p> 
<h4>Step 2: Add a Microsoft enterprise CA to your AWS Microsoft AD directory</h4> 
<p><a id="step2"></a><br /> In this step, you set up a subordinate Microsoft enterprise CA and join it to your AWS Microsoft AD directory domain. I will summarize the process first and then walk through the steps.</p> 
<p>First, you create an Amazon EC2 for Windows Server instance called <span style="font-family: courier">SubordinateCA</span> and join it to the domain, <span style="font-family: courier">corp.example.com</span>. You then publish <span style="font-family: courier">RootCA</span>’s public certificate and <a href="https://technet.microsoft.com/en-us/library/ee619754(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">certificate revocation list</a> (CRL) to <span style="font-family: courier">SubordinateCA</span>’s local trusted store. You also publish <span style="font-family: courier">RootCA</span>’s public certificate to your directory domain. Doing so enables <span style="font-family: courier">SubordinateCA</span> and your directory domain controllers to trust <span style="font-family: courier">RootCA</span>. You then install the Microsoft enterprise CA service on <span style="font-family: courier">SubordinateCA</span> and request a certificate from <span style="font-family: courier">RootCA</span> to make <span style="font-family: courier">SubordinateCA</span> a subordinate Microsoft CA. After <span style="font-family: courier">RootCA</span> issues the certificate, <span style="font-family: courier">SubordinateCA</span> is ready to issue certificates to your directory domain controllers.</p> 
<p>Note that you can use an <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3 bucket</a> to pass the certificates between <span style="font-family: courier">RootCA</span> and <span style="font-family: courier">SubordinateCA</span>.</p> 
<p><img class="alignnone size-full wp-image-5206" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/VS-Diagram2-0917-a.png" alt="" width="900" height="705" /></p> 
<p>In detail, here is how the process works, as illustrated in the preceding diagram:</p> 
<ol type="a"> 
<li><strong>Set up an Amazon EC2 instance joined to your AWS Microsoft AD directory domain</strong> – Create an Amazon EC2 for Windows Server instance to use as a subordinate CA, and join it to your AWS Microsoft AD directory domain. For this example, the machine name is <span style="font-family: courier">SubordinateCA</span> and the domain is <span style="font-family: courier">corp.example.com</span>.</li> 
<li><strong>Share RootCA’s public certificate with SubordinateCA</strong> – Log in to <span style="font-family: courier">RootCA</span> as <span style="font-family: courier">RootAdmin</span> and start Windows PowerShell with administrative privileges. Run the following commands to copy <span style="font-family: courier">RootCA</span>’s public certificate and CRL to the folder <span style="font-family: courier">c:\rootcerts</span> on <span style="font-family: courier">RootCA</span>. 
<pre><code class="lang-text">New-Item c:\rootcerts -type directory
copy C:\Windows\system32\certsrv\certenroll\*.cr* c:\rootcerts</code></pre> 
</ol> 
<p style="padding-left: 30px">The following screenshot shows <span style="font-family: courier">RootCA</span>’s public certificate and CRL uploaded to an S3 bucket.<br /> <img class="alignnone wp-image-5232 size-full" title="Screenshot of RootCA’s public certificate and CRL uploaded to the S3 bucket" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/23/2.b-1.jpg" alt="Screenshot of RootCA’s public certificate and CRL uploaded to the S3 bucket" width="443" height="403" /></p> 
<ol start="3" type="a"> 
<li><strong>Publish RootCA’s public certificate to your directory domain</strong> – Log in to <span style="font-family: courier">SubordinateCA</span> as the <span style="font-family: courier">CAAdmin</span>. Download <span style="font-family: courier">RootCA</span>’s public certificate and CRL from the S3 bucket by following the instructions in <a href="http://docs.aws.amazon.com/AmazonS3/latest/user-guide/download-objects.html" target="_blank" rel="noopener noreferrer">How Do I Download an Object from an S3 Bucket?</a>&nbsp;Save the certificate and CRL to the <span style="font-family: courier">C:\rootcerts</span> folder on&nbsp;<span style="font-family: courier">SubordinateCA</span>. Add <span style="font-family: courier">RootCA</span>’s public certificate and the CRL to the local store of&nbsp;<span style="font-family: courier">SubordinateCA</span> and publish <span style="font-family: courier">RootCA</span>’s public certificate to your directory domain by running the following commands using Windows PowerShell with administrative privileges. 
<pre><code class="lang-text">certutil –addstore –f root <strong>&lt;path to the RootCA public certificate file&gt;</strong>
certutil –addstore –f root <strong>&lt;path to the RootCA CRL file&gt;</strong>
certutil –dspublish –f <strong>&lt;path to the RootCA public certificate file&gt;</strong> RootCA</code></pre> 
<li><strong>Install the subordinate Microsoft enterprise CA </strong>– Install the subordinate Microsoft enterprise CA on <span style="font-family: courier">SubordinateCA</span> by following the instructions in <a href="https://technet.microsoft.com/en-us/library/cc772192(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">Install a Subordinate Certification Authority</a>. Ensure that you choose <strong>Enterprise CA</strong> for <strong>Setup Type</strong> to install an enterprise CA.<br /> <img class="alignnone size-full wp-image-5169" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/2.d.jpg" alt="" width="771" height="566" /></li> 
</ol> 
<p style="padding-left: 30px">For the <strong>CA Type</strong>, choose <strong>Subordinate CA</strong>.<br /> <img class="alignnone size-full wp-image-5170" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/2.d.2.jpg" alt="" width="774" height="564" /></p> 
<ol start="5" type="a"> 
<li><strong>Request a certificate from RootCA</strong> – Next, copy the certificate request on&nbsp;<span style="font-family: courier">SubordinateCA</span> to a folder called <span style="font-family: courier">c:\CARequest</span> by running the following commands using Windows PowerShell with administrative privileges. 
<pre><code class="lang-text">New-Item c:\CARequest -type directory
Copy c:\*.req C:\CARequest</code></pre> 
</ol> 
<ol start="6" type="a"> 
<li><strong>Approve SubordinateCA’s certificate request</strong> – Log in to <span style="font-family: courier">RootCA</span> as <span style="font-family: courier">RootAdmin</span> and download the certificate request from the S3 bucket to a folder called <span style="font-family: courier">CARequest</span>. Submit the request by running the following command using Windows PowerShell with administrative privileges. 
<pre><code class="lang-text">certreq -submit <strong>&lt;path to certificate request file&gt;</strong></code></pre> 
</ol> 
<p style="padding-left: 30px">Navigate&nbsp;to <strong>Server Manager &gt; <strong>Tools</strong> &gt; <strong>Certification Authority</strong></strong> on<strong> <span style="font-family: courier">RootCA</span>.<br /> <img class="alignnone wp-image-5173 size-full" title="Screenshot of &quot;Certification Authority&quot; in the drop-down menu" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/2.f.3.jpg" alt="Screenshot of &quot;Certification Authority&quot; in the drop-down menu" width="289" height="131" /></strong></p> 
<p style="padding-left: 30px">In the <strong>Certification Authority</strong> window, expand the <strong>ROOTCA</strong>&nbsp;tree in the left pane and choose<strong> Pending Requests</strong>. In the right pane, note the value in the <strong>Request ID</strong> column. Right-click the request and choose <strong>All Tasks &gt; Issue</strong>.<br /> <img class="alignnone wp-image-5262 size-full" title="Screenshot of noting the value in the &quot;Request ID&quot; column" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/2.f.3-a-1.jpg" alt="Screenshot of noting the value in the &quot;Request ID&quot; column" width="740" height="221" /></p> 
<ol start="7" type="a"> 
<li><strong>Retrieve the SubordinateCA certificate </strong>– Retrieve the <span style="font-family: courier">SubordinateCA</span> certificate by running following command using Windows PowerShell with administrative privileges. The command includes the <strong>&lt;</strong><strong>RequestId</strong><strong>&gt;</strong> that you noted in the previous step. 
<pre><code class="lang-text">certreq –retrieve <strong>&lt;RequestId&gt;</strong> <strong>&lt;drive&gt;</strong>:\subordinateCA.crt</code></pre> 
</ol> 
<ol start="8" type="a"> 
<li><strong>Install the SubordinateCA certificate</strong> – Log in to&nbsp;<span style="font-family: courier">SubordinateCA</span> as the <span style="font-family: courier">CAAdmin</span> and download <span style="font-family: courier">SubordinateCA.crt</span> from the S3 bucket. Install the certificate by running following commands using Windows PowerShell with administrative privileges. 
<pre><code class="lang-text">certutil –installcert c:\subordinateCA.crt
start-service certsvc</code></pre> 
<li><strong>Delete the content that you uploaded to S3 </strong>–<strong>&nbsp;</strong>As a security best practice, <a href="http://docs.aws.amazon.com/AmazonS3/latest/user-guide/delete-objects.html" target="_blank" rel="noopener noreferrer">delete</a> all the certificates and CRLs that you uploaded to the S3 bucket in the previous steps because you already have installed them on&nbsp;<span style="font-family: courier">SubordinateCA</span>.</li> 
</ol> 
<p>You have finished setting up the subordinate Microsoft enterprise CA that is joined to your AWS Microsoft AD directory domain. Now you can use your subordinate Microsoft enterprise CA to create a certificate template so that your directory domain controllers can request a certificate to enable LDAPS for your directory.</p> 
<h4>Step 3: Create a certificate template</h4> 
<p><a id="step3"></a><br /> In this step, you create a certificate template with server authentication and autoenrollment enabled on&nbsp;<span style="font-family: courier">SubordinateCA</span>. You create&nbsp;this new template (in this case, <span style="font-family: courier">ServerAuthentication</span>) by duplicating an existing certificate template (in this case, <span style="font-family: courier">Domain Controller template</span>) and adding server authentication and autoenrollment to the template.</p> 
<p>Follow these steps to create a certificate template:</p> 
<ol> 
<li>Log in to&nbsp;<span style="font-family: courier">SubordinateCA</span> as <span style="font-family: courier">CAAdmin</span>.</li> 
<li>Launch <strong>Microsoft Windows</strong> <strong>Server Manager. </strong>Select<strong> Tools</strong> &gt; <strong>Certification Authority</strong>.</li> 
<li>In the <strong>Certificate Authority</strong> window, expand the <strong>SubordinateCA</strong> tree in the left pane. Right-click <strong>Certificate Templates</strong>, and choose<strong> Manage</strong>.<br /> <img class="alignnone wp-image-5263 size-full" title="Screenshot of choosing &quot;Manage&quot; under &quot;Certificate Template&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/3.3-a-1.jpg" alt="Screenshot of choosing &quot;Manage&quot; under &quot;Certificate Template&quot;" width="287" height="354" /></li> 
<li>In the <strong>Certificate Templates Console</strong> window, right-click <strong>Domain Controller </strong>and choose <strong>Duplicate Template</strong>.<br /> <img class="alignnone wp-image-5178 size-full" title="Screenshot of the Certificate Templates Console window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.d.jpg" alt="Screenshot of the Certificate Templates Console window" width="370" height="399" /></li> 
<li>In the <strong>Properties of New Template</strong> window, switch to the <strong>General</strong> tab and change the <strong>Template display name</strong> to <span style="font-family: courier">ServerAuthentication</span>.<br /> <img class="alignnone wp-image-5179 size-full" title="Screenshot of the &quot;Properties of New Template&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.e.jpg" alt="Screenshot of the &quot;Properties of New Template&quot; window" width="414" height="568" /></li> 
<li>Switch to the <strong>Security</strong> tab, and choose <strong>Domain Controllers</strong> in the <strong>Group or user names</strong>&nbsp;section. Select the <strong>Allow&nbsp;</strong>check box for <strong>Autoenroll</strong> in the <strong>Permissions for</strong> <strong>Domain Controllers</strong> section.<br /> <img class="alignnone wp-image-5180 size-full" title="Screenshot of the &quot;Permissions for Domain Controllers&quot; section of the &quot;Properties of New Template&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.f.jpg" alt="Screenshot of the &quot;Permissions for Domain Controllers&quot; section of the &quot;Properties of New Template&quot; window" width="413" height="565" /></li> 
<li>Switch to the <strong>Extensions</strong> tab, choose <strong>Application Policies</strong> in the <strong>Extensions included in this template</strong> section, and choose <strong>Edit<br /> <img class="alignnone wp-image-5190 size-full" title="Screenshot of the &quot;Extensions&quot; tab of the &quot;Properties of New Template&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.g.jpg" alt="Screenshot of the &quot;Extensions&quot; tab of the &quot;Properties of New Template&quot; window" width="413" height="565" /><br /> </strong></li> 
<li>In the <strong>Edit Application Policies Extension</strong> window, choose <strong>Client Authentication</strong> and choose <strong>Remove</strong>. Choose <strong>OK</strong> to create the <span style="font-family: courier">ServerAuthentication</span> certificate template. Close the <strong>Certificate Templates Console</strong> window.<br /> <img class="alignnone wp-image-5191 size-full" title="Screenshot of the &quot;Edit Application Policies Extension&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.h.jpg" alt="Screenshot of the &quot;Edit Application Policies Extension&quot; window" width="305" height="419" /></li> 
<li>In the <strong>Certificate Authority</strong> window, right-click <strong>Certificate Templates</strong>, and choose<strong> New</strong> &gt; <strong>Certificate Template to Issue</strong>.<br /> <img class="alignnone wp-image-5265 size-full" title="Screenshot of choosing &quot;New&quot; &gt; &quot;Certificate Template to Issue&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/3.9-a.jpg" alt="Screenshot of choosing &quot;New&quot; &gt; &quot;Certificate Template to Issue&quot;" width="519" height="332" /></li> 
<li>In the <strong>Enable Certificate Templates</strong> window, choose <span style="font-family: courier">ServerAuthentication</span> and choose <strong>OK.<br /> <img class="alignnone wp-image-5193 size-full" title="Screenshot of the &quot;Enable Certificate Templates&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/3.j.jpg" alt="Screenshot of the &quot;Enable Certificate Templates&quot; window" width="595" height="378" /><br /> </strong></li> 
</ol> 
<p>You have finished creating a certificate template with server authentication and autoenrollment enabled on <span style="font-family: courier">SubordinateCA</span>. Your AWS Microsoft AD directory domain controllers can now obtain a certificate through autoenrollment to enable LDAPS.</p> 
<h4>Step 4: Configure AWS security group rules</h4> 
<p><a id="step4"></a><br /> In this step, you configure AWS security group rules so that your directory domain controllers can connect to the subordinate CA to request a certificate. To do this, you must add outbound rules to your directory’s AWS security group (in this case, <span style="font-family: courier">sg-4ba7682d</span>) to allow all outbound traffic to <span style="font-family: courier">SubordinateCA</span>’s AWS security group (in this case, <span style="font-family: courier">sg-6fbe7109</span>) so that your directory domain controllers can connect to <span style="font-family: courier">SubordinateCA</span> for requesting a certificate. You also must add inbound rules to <span style="font-family: courier">SubordinateCA</span>’s AWS security group to allow all incoming traffic from your directory’s AWS security group so that the subordinate CA can accept incoming traffic from your directory domain controllers.</p> 
<p>Follow these steps to configure AWS security group rules:</p> 
<ol> 
<li>Log in to the <span style="font-family: courier">Management</span> instance as <span style="font-family: courier">Admin</span>.</li> 
<li>Navigate to the <a href="https://console.aws.amazon.com/ec2" target="_blank" rel="noopener noreferrer">EC2 console</a>.</li> 
<li>In the left pane, choose <strong>Network &amp; Security &gt; Security Groups</strong>.</li> 
<li>In the right pane, choose the AWS security group (in this case, <span style="font-family: courier">sg-6fbe7109</span>) of&nbsp;<span style="font-family: courier">SubordinateCA</span>.</li> 
<li>Switch to the <strong>Inbound</strong> tab and choose <strong>Edit</strong>.</li> 
<li>Choose <strong>Add Rule</strong>. Choose <strong>All traffic</strong> for <strong>Type</strong> and <strong>Custom</strong> for <strong>Source</strong>. Enter your directory’s AWS security group (in this case, <span style="font-family: courier">sg-4ba7682d</span>) in the <strong>Source</strong>&nbsp;box. Choose <strong>Save</strong>.<br /> <img class="alignnone wp-image-5267 size-full" title="Screenshot of adding an inbound rule" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/4.6-a-1.jpg" alt="Screenshot of adding an inbound rule" width="900" height="284" /></li> 
<li>Now choose the AWS security group (in this case, <span style="font-family: courier">sg-4ba7682d</span>) of your AWS Microsoft AD directory, switch to the <strong>Outbound</strong> tab, and choose <strong>Edit</strong>.</li> 
<li>Choose <strong>Add Rule</strong>. Choose <strong>All traffic</strong> for <strong>Type</strong> and <strong>Custom</strong> for <strong>Destination</strong>. Enter your directory’s AWS security group (in this case, <span style="font-family: courier">sg-6fbe7109</span>) in the <strong>Destination</strong> box. Choose <strong>Save</strong>.<br /> <img class="alignnone wp-image-5268 size-full" title="Screenshot of adding an outbound rule" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/24/4.8-a-1.jpg" alt="" width="900" height="280" /></li> 
</ol> 
<p>You have completed the configuration of AWS security group rules to allow traffic between your directory domain controllers and&nbsp;<span style="font-family: courier">SubordinateCA</span>.</p> 
<h4>Step 5: AWS Microsoft AD enables LDAPS</h4> 
<p><a id="step5"></a><br /> The AWS Microsoft AD domain controllers perform this step automatically by recognizing the published template and requesting a certificate from the subordinate Microsoft enterprise CA. The subordinate CA can take up to 180 minutes to issue certificates to the directory domain controllers. The directory imports these certificates into the directory domain controllers and enables LDAPS for your directory automatically. This completes the setup of LDAPS for the AWS Microsoft AD directory. The LDAP service on the directory is now ready to accept LDAPS connections!</p> 
<h4>Step 6: Test LDAPS access by using the LDP tool</h4> 
<p><a id="step6"></a><br /> In this step, you test the LDAPS connection to the AWS Microsoft AD directory by using the LDP tool. The LDP tool is available on the <span style="font-family: courier">Management</span> machine where you installed <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/install_ad_tools.html" target="_blank" rel="noopener noreferrer">Active Directory Administration Tools</a>. Before you test the LDAPS connection, you must wait up to 180 minutes for the subordinate CA to issue a certificate to your directory domain controllers.</p> 
<p>To test LDAPS, you connect to one of the domain controllers using port 636. Here are the steps to test the LDAPS connection:</p> 
<ol> 
<li>Log in to <span style="font-family: courier">Management</span> as <span style="font-family: courier">Admin</span>.</li> 
<li>Launch the <strong>Microsoft Windows</strong> <strong>Server Manager</strong> on <span style="font-family: courier">Management</span> and navigate to <strong>Tools</strong> &gt; <strong>Active Directory Users and Computers</strong>.</li> 
<li>Switch to the <strong>tree view&nbsp;</strong>and navigate to&nbsp;<strong>corp.example.com</strong> <strong>&gt;</strong> <strong>CORP</strong> <strong>&gt; </strong><strong>Domain Controllers</strong><strong>. </strong>In the right pane, right-click on one of the domain controllers and choose <strong>Properties</strong>. Copy the DNS name of the domain controller.<br /> <img class="alignnone wp-image-5199 size-full" title="Screenshot of copying the DNS name of the domain controller" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/6.c.jpg" alt="Screenshot of copying the DNS name of the domain controller" width="845" height="567" /></li> 
<li>Launch the LDP.exe tool by launching Windows PowerShell and running the <span style="font-family: courier">LDP.exe</span> command.<br /> <img class="alignnone size-full wp-image-5200" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/6.d.jpg" alt="" width="498" height="60" /></li> 
<li>In the LDP tool, choose <strong>Connection</strong><strong> &gt; </strong><strong>Connect</strong><strong><strong>.</strong></strong><br /> <img class="alignnone wp-image-5201 size-full" title="Screenshot of choosing &quot;Connnection&quot; &gt; &quot;Connect&quot; in the LDP tool" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/6.e.jpg" alt="Screenshot of choosing &quot;Connnection&quot; &gt; &quot;Connect&quot; in the LDP tool" width="746" height="231" /></li> 
<li>In the <strong>Server</strong> box, paste the DNS name you copied in the previous step. Type <span style="font-family: courier">636</span> in the <strong>Port</strong> box. Choose <strong>OK</strong> to test the LDAPS connection to port 636 of your directory.<br /> <img class="alignnone wp-image-5202 size-full" title="Screenshot of completing the boxes in the &quot;Connect&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/6.f.jpg" alt="Screenshot of completing the boxes in the &quot;Connect&quot; window" width="281" height="149" /></li> 
<li>You should see the following message to confirm that your LDAPS connection is now open.<br /> <img class="alignnone wp-image-5204 size-full" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/22/6.g.jpg" alt="" width="999" height="128" /></li> 
</ol> 
<p>You have completed the setup of LDAPS for your AWS Microsoft AD directory! You can now encrypt LDAP communications between your Windows and Linux applications and your AWS Microsoft AD directory using LDAPS.</p> 
<h3>Summary</h3> 
<p>In this blog post, I walked through the process of enabling LDAPS for your AWS Microsoft AD directory. Enabling LDAPS helps you protect PII and other sensitive information exchanged over untrusted networks between your Windows and Linux applications and your AWS Microsoft AD. To learn more about how to use AWS Microsoft AD, see the <a href="https://aws.amazon.com/documentation/directory-service/" target="_blank" rel="noopener noreferrer">Directory Service documentation</a>. For general information and pricing, see the <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">Directory Service home page</a>.</p> 
<p>If you have comments about this blog post, submit a comment in the “Comments” section below. If you have implementation or troubleshooting questions, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=180" target="_blank" rel="noopener noreferrer">Directory Service forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Vijay</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/active-directory/" rel="tag">Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-microsoft-ad/" rel="tag">AWS Microsoft AD</a>, <a href="https://aws.amazon.com/blogs/security/tag/certificate-authority/" rel="tag">Certificate Authority</a>, <a href="https://aws.amazon.com/blogs/security/tag/encryption/" rel="tag">Encryption</a>, <a href="https://aws.amazon.com/blogs/security/tag/security-group/" rel="tag">security group</a>, <a href="https://aws.amazon.com/blogs/security/tag/ssh/" rel="tag">SSH</a>, <a href="https://aws.amazon.com/blogs/security/tag/ssl/" rel="tag">SSL</a>, <a href="https://aws.amazon.com/blogs/security/tag/tls/" rel="tag">TLS</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5161');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Now Use AWS IAM to Delete a Service-Linked Role When You No Longer Require an AWS Service to Perform Actions on Your Behalf</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Ujjwal Pugalia</span></span> | on 
<time property="datePublished" datetime="2017-09-21T14:56:08+00:00">21 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/identity/" title="View all posts in Identity"><span property="articleSection">Identity</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-use-aws-iam-to-delete-a-service-linked-role-when-you-no-longer-require-an-aws-service-to-perform-actions-on-your-behalf/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4754" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4754&amp;disqus_title=Now+Use+AWS+IAM+to+Delete+a+Service-Linked+Role+When+You+No+Longer+Require+an+AWS+Service+to+Perform+Actions+on+Your+Behalf&amp;disqus_url=https://aws.amazon.com/blogs/security/now-use-aws-iam-to-delete-a-service-linked-role-when-you-no-longer-require-an-aws-service-to-perform-actions-on-your-behalf/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4754');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Earlier this year, <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management (IAM)</a> introduced <a href="https://aws.amazon.com/blogs/security/introducing-an-easier-way-to-delegate-permissions-to-aws-services-service-linked-roles/" target="_blank" rel="noopener noreferrer">service-linked roles</a><em>, </em>which provide you an easy and secure way to delegate permissions to AWS services. Each service-linked role delegates permissions to an AWS service, which is called its <em>linked service</em><strong>.</strong> Service-linked roles help with monitoring and auditing requirements by providing a transparent way to understand all actions performed on your behalf because <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a> logs all actions performed by the linked service using service-linked roles. For information about which services support service-linked roles, see <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html" target="_blank" rel="noopener noreferrer">AWS Services That Work with IAM</a>. Over time, more AWS services will support service-linked roles.</p> 
<p>Today, IAM added support for the deletion of service-linked roles through the IAM console and the IAM API/CLI. This means you now can revoke permissions from the linked service to create and manage AWS resources in your account. When you delete a service-linked role, the linked service no longer has the permissions to perform actions on your behalf. To ensure your AWS services continue to function as expected when you delete a service-linked role, IAM validates that you no longer have resources that require the service-linked role to function properly. This prevents you from inadvertently revoking permissions required by an AWS service to manage your existing AWS resources and helps you maintain your resources in a consistent state. If there are any resources in your account that require the service-linked role, you will receive an error when you attempt to delete the service-linked role, and the service-linked role will remain in your account. If you do not have any resources that require the service-linked role, you can delete the service-linked role and IAM will remove the service-linked role from your account.</p> 
<p>In this blog post, I show how to delete a service-linked role by using the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a>. To learn more about how to delete service-linked roles by using the IAM API/CLI, see the <a href="http://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteServiceLinkedRole.html" target="_blank" rel="noopener noreferrer">DeleteServiceLinkedRole API</a> documentation.</p> 
<p><strong>Note:</strong> The IAM console does not currently support service-linked role deletion for <a href="https://aws.amazon.com/lex/" target="_blank" rel="noopener noreferrer">Amazon Lex</a>, but you can delete your service-linked role by using the <a href="https://console.aws.amazon.com/lex/home" target="_blank" rel="noopener noreferrer">Amazon Lex console</a>. To learn more, see&nbsp;<a href="http://alpha-docs-aws.amazon.com/lex/latest/dg/howitworks-service-permissions.html" target="_blank" rel="noopener noreferrer">Service Permissions</a>.<span id="more-4754"></span></p> 
<h3>How to delete a service-linked role by using the IAM console</h3> 
<p>If you no longer need to use an AWS service that uses a service-linked role, you can remove permissions from that service by deleting the service-linked role through the IAM console. To delete a service-linked role, you must have permissions for the <span style="font-family: courier">iam:DeleteServiceLinkedRole</span> action. For example, the following IAM policy grants the permission to delete service-linked roles used by <a href="http://aws.amazon.com/redshift/" target="_blank" rel="noopener noreferrer">Amazon Redshift</a>.&nbsp;To learn more about working with IAM policies, see <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage.html" target="_blank" rel="noopener noreferrer">Working with Policies</a>.</p> 
<pre><code class="lang-text">{ 
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;AllowDeletionOfServiceLinkedRolesForRedshift&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [&quot;iam:DeleteServiceLinkedRole&quot;],
&quot;Resource&quot;: [&quot;arn:aws:iam::*:role/aws-service-role/redshift.amazonaws.com/AWSServiceRoleForRedshift*&quot;]
}
]
}</code></pre> 
<p>To delete a service-linked role by using the IAM console:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a> and choose <strong>Roles</strong> from the navigation pane.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5150 size-full" title="Screenshot of the Roles page in the IAM console" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP1_SLRD_092117-c.png" alt="Screenshot of the Roles page in the IAM console" width="543" height="518" /></p> 
<ol start="2"> 
<li>Choose the service-linked role you want to delete and then choose <strong>Delete role</strong>. In this example, I choose the&nbsp;&nbsp;<span style="font-family: courier">AWSServiceRoleForRedshift</span> service-linked role.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5156 size-full" title="Screenshot of the AWSServiceRoleForRedshift service-linked role" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP2_SLRD_092117-b.png" alt="Screenshot of the AWSServiceRoleForRedshift service-linked role" width="902" height="301" /></p> 
<ol start="3"> 
<li>A dialog box asks you to confirm that you want to delete the service-linked role you have chosen. In the <strong>Last activity</strong> column, you can see when the AWS service last used the service-linked role, which tells you when the linked service last used the service-linked role to perform an action on your behalf. If you want to continue to delete the service-linked role, choose <strong>Yes, delete</strong> to delete the service-linked role.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5135 size-full" title="Screenshot of the &quot;Delete role&quot; window" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP3_SLRD_092117-a.png" alt="Screenshot of the &quot;Delete role&quot; window" width="900" height="392" /></p> 
<ol start="4"> 
<li>IAM then checks whether you have any resources that require the service-linked role you are trying to delete. While IAM checks, you will see the status message, <strong>Deletion in progress</strong>, below the role name.&nbsp;<img class="alignnone wp-image-5143 size-full" title="Screenshot showing &quot;Deletion in progress&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP4_SLRD_092117-a.png" alt="Screenshot showing &quot;Deletion in progress&quot;" width="902" height="198" /></li> 
</ol> 
<ol start="5"> 
<li>If no resources require the service-linked role, IAM deletes the role from your account and displays a success message on the console.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5138 size-full" title="Screenshot of the success message" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP5_SLRD_092117.png" alt="Screenshot of the success message" width="718" height="91" /></p> 
<ol start="6"> 
<li>If there <em>are</em> AWS resources that require the service-linked role you are trying to delete, you will see the status message,&nbsp;<strong>Deletion failed</strong>, below the role name.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5144 size-full" title="Screenshot showing the &quot;Deletion failed&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP6_SLRD_092117-a.png" alt="Screenshot showing the &quot;Deletion failed&quot;" width="902" height="203" /></p> 
<ol start="7"> 
<li>If you choose <strong>View details</strong>, you will see a message that explains the deletion failed because there are resources that use the service-linked role.<br /> <img class="alignnone wp-image-5157 size-full" title="Screenshot showing details about why the role deletion failed" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP7_SLRD_092117-a.png" alt="Screenshot showing details about why the role deletion failed" width="1408" height="151" /></li> 
<li>Choose <strong>View Resources</strong> to view the Amazon Resource Names (ARNs) of the first five resources that require the service-linked role. You can delete the service-linked role only after you delete all resources that require the service-linked role. In this example, only one resource requires the service-linked role.</li> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5158 size-full" title="Screenshot showing the Amazon Resource Name that requires the service-linked role" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/UP8_SLRD_092117-a.png" alt="" width="983" height="392" /></p> 
<h3>Conclusion</h3> 
<p>Service-linked roles make it easier for you to delegate permissions to AWS services to create and manage AWS resources on your behalf and to understand all actions the service will perform on your behalf. If you no longer need to use an AWS service that uses a service-linked role, you can remove permissions from that service by deleting the service-linked role through the IAM console. However, before you delete a service-linked role, you must delete all the resources associated with that role to ensure that your resources remain in a consistent state.</p> 
<p>If you have any questions, submit a comment in the “Comments” section below. If you need help working with service-linked roles, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Ujjwal</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/access-management/" rel="tag">Access management</a>, <a href="https://aws.amazon.com/blogs/security/tag/roles/" rel="tag">roles</a>, <a href="https://aws.amazon.com/blogs/security/tag/service-linked-roles/" rel="tag">service-linked roles</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4754');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Reset Your AWS Root Account’s Lost MFA Device Faster by Using the AWS Management Console</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Ujjwal Pugalia</span></span> | on 
<time property="datePublished" datetime="2017-09-21T11:39:33+00:00">21 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/reset-your-aws-root-accounts-lost-mfa-device-faster-by-using-the-aws-management-console/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4346" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4346&amp;disqus_title=Reset+Your+AWS+Root+Account%E2%80%99s+Lost+MFA+Device+Faster+by+Using+the+AWS+Management+Console&amp;disqus_url=https://aws.amazon.com/blogs/security/reset-your-aws-root-accounts-lost-mfa-device-faster-by-using-the-aws-management-console/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4346');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>To help secure your AWS resources, AWS recommends that you follow the <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener noreferrer">best practice</a> of enabling <a href="https://aws.amazon.com/iam/details/mfa/" target="_blank" rel="noopener noreferrer">multi-factor authentication (MFA)</a> for the <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html" target="_blank" rel="noopener noreferrer">root user</a> of your account. With MFA turned on, the root user of your account is required to submit one form of authentication, which is the account password, and another form of authentication, such as a one-time password (OTP) from an MFA device. If you have MFA enabled on your root account and you lose or misplace your root MFA device, you can now reset it by using the AWS Management Console.</p> 
<p>Now, your root user can use the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS sign-in page</a> to verify your root account’s email address and phone number. Then, the root user can deactivate the lost MFA device and set up a new MFA device in its place. Note that this information verification feature is available only for AWS root users with a phone number associated with their root account. If your root user does not have a valid phone number associated with your root account, the root user must call <a href="https://aws.amazon.com/forms/aws-mfa-support" target="_blank" rel="noopener noreferrer">AWS Support</a> to reset the lost MFA device.</p> 
<p>In this blog post, I demonstrate how to reset a lost MFA device faster by using the AWS Management Console to verify your root user’s email address and phone number. I then demonstrate how to set up a virtual MFA device that you can use in place of the lost MFA device.</p> 
<p><strong>Note:</strong> This feature is available only to AWS accounts created before September 14, 2017. If you created your account after September 14, 2017,&nbsp;<a href="https://aws.amazon.com/forms/aws-mfa-support" target="_blank" rel="noopener noreferrer">contact AWS Support</a> to reset your lost MFA device.</p> 
<p><span id="more-4346"></span></p> 
<h3>Reset a lost MFA device</h3> 
<p>In this section, I demonstrate how to reset a lost MFA device. To reset your MFA device, you must know and have access to the email address and phone number associated with your root account.</p> 
<p>Follow these steps to reset your lost MFA device:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS sign-in page</a>, and enter your root account’s email address.<br /> <img class="alignnone wp-image-4994 size-full" title="Screenshot of the AWS sign-in page" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/New-Sign-In-Enter-Email-a.png" alt="Screenshot of the AWS sign-in page" width="290" height="296" /></li> 
<li>On the <strong>Root user sign in</strong> page, enter the password of your root account.<br /> <img class="alignnone wp-image-4992 size-full" title="Screenshot of Root user sign in page" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/Root-user-sign-in-page-a.png" alt="Screenshot of Root user sign in page" width="270" height="303" /></li> 
<li>On the <strong>Amazon Web Services Sign In With Authentication Device</strong> page, choose <strong>Having problems with your authentication device? Click here</strong>.<br /> <img class="alignnone wp-image-4934" title="Screenshot showing the link to click if having problems with your authentication device" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/3-MFA-Challenge-Page-a.png" alt="Screenshot showing the link to click if having problems with your authentication device" width="700" height="237" /></li> 
<li>On the <strong>Troubleshoot Your Authentication Device</strong> page, choose <strong>Sign In using alternative factors</strong> under <strong>Sign In Using Alternative Factors of Authentication</strong>.<br /> <img class="alignnone wp-image-4935" title="Screenshot showing the &quot;Sign in using alternative factors&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/4-Sign-In-using-Alternative-Factors-a.png" alt="Screenshot showing the &quot;Sign in using alternative factors&quot; choice" width="700" height="149" /></li> 
<li>On <strong>Step 1: Email address verification</strong>, validate that the email address is correct and choose <strong>Send verification email</strong>.<br /> <img class="alignnone wp-image-4936" title="Screenshot showing the &quot;Send verification email&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/5-Root-Email-Verification-a.png" alt="" width="500" height="296" /></li> 
<li>AWS sends an email with the subject line, <strong>AWS Email Verification</strong>, to the address associated with the root account. After the email is sent to your address, you will see <strong>Email sent </strong>under<strong> Step 1</strong>, as shown in the following screenshot<strong>. </strong>If you do not see the verification email in the root user’s inbox, check the spam folder or choose <strong>Resend the email </strong>under<strong> Step 1</strong>. After you locate the email, you can close the current browser tab. Follow the directions in the email to proceed with the verification process.<br /> <img class="alignnone wp-image-4557 size-full" title="Screenshot showing that the address verification email was sent" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/120-Great-success-080217.png" alt="" width="700" height="277" /></li> 
<li>In the email from AWS with the subject line, <strong>AWS Email Verification</strong>, choose <strong>Verify your email address</strong>.<br /> <img class="alignnone wp-image-4571 size-full" title="Screenshot showing link to choose in the verification email" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/130-Email-Received-080217-b.png" alt="Screenshot showing link to choose in the verification email" width="700" height="402" /></li> 
<li>When you click the verification link, your email is verified and you are taken to Step 2 of the verification process. In <strong>Step 2: Phone number verification</strong>, choose <strong>Call me now</strong> to start the phone number verification process.<br /> <img class="alignnone wp-image-4572 size-full" title="Screenshot showing the &quot;Call me now&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/140-Verify-phone-080217-b.png" alt="Screenshot showing the &quot;Call me now&quot; choice" width="700" height="287" /></li> 
<li>Answer the phone call from AWS and use your phone’s keypad to submit the six-digit verification code that appears on your computer screen.<br /> <img class="alignnone wp-image-4553 size-full" title="Screenshot showing that your phone is being called by AWS for verification" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/141-Calling-080217-a.png" alt="Screenshot showing that your phone is being called by AWS for verification" width="700" height="274" /></li> 
<li>After you have verified your root account’s email address and phone number, proceed to <strong>Step 3: Sign In</strong>. In Step 3, choose <strong>Sign in to the console</strong> to sign in to the AWS Management Console.<br /> <img class="alignnone wp-image-4555 size-full" title="Screenshot showing that you have successfully authenticated" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/160-Login-080217-a.png" alt="" width="700" height="282" /></li> 
</ol> 
<p style="padding-left: 30px">You automatically are redirected to the <strong>Your Security Credentials</strong> page. If your MFA device is lost, deactivate the MFA device by choosing <strong>Deactivate</strong> (see the following screenshot). If you find your MFA device later, you can reactivate it on the same <strong>Your Security Credentials</strong> page. (A reactivated device is treated like a new device, so choose <strong>Activate MFA</strong> to reactivate a device.)<br /> <img class="alignnone wp-image-4943" title="Screenshot showing the &quot;Deactivate&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/Security-Credentials-Deactivate-Existing-MFA-b.png" alt="" width="700" height="178" /></p> 
<ol start="10"> 
<li>You have successfully deactivated your lost MFA device. You will no longer see any details associated with the lost MFA device in the console. You now will see an <strong>Activate MFA</strong> option (see the following screenshot) that you can use to activate a new MFA device.<br /> <img class="alignnone wp-image-4944" title="Screenshot showing the &quot;Activate MFA&quot; option" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/Activate-new-MFA-Device.png" alt="Screenshot showing the &quot;Activate MFA&quot; option" width="700" height="177" /></li> 
</ol> 
<p>We recommend that you enable a new MFA device on your root account as soon as possible to ensure that your root account is protected by MFA. If you find your lost MFA device, you can reactivate it (see Step 9 earlier in this post).</p> 
<p>In place of your lost MFA device, you can use a <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_enable_virtual.html" target="_blank" rel="noopener noreferrer">virtual MFA device</a> to ensure that your root account remains protected by MFA. In the next section, I show how to set up a virtual MFA device and associate it with your root account.</p> 
<h3>Associate a virtual MFA device with your root account</h3> 
<p>After you deactivate your lost MFA device, you can associate a virtual MFA device with your root account to help secure your AWS resources. You need to download a virtual MFA app such as <a href="http://support.google.com/accounts/bin/answer.py?hl=en&amp;answer=1066447" target="_blank" rel="noopener noreferrer">Google Authenticator</a> or&nbsp;<a href="https://play.google.com/store/apps/details?id=com.authy.authy&amp;amp;hl=en" target="_blank" rel="noopener noreferrer">Authy 2-Factor Authentication</a> to use virtual MFA with your AWS account.</p> 
<p>To associate a virtual MFA device with your root account:</p> 
<ol> 
<li>Choose <strong>Activate MFA</strong> on the <strong>Your Security Credentials</strong> page.<strong><br /> <img class="alignnone wp-image-4946" title="Screenshot showing the &quot;Activate MFA&quot; choice" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/Activate-new-MFA-Device.png" alt="" width="700" height="177" /><br /> </strong></li> 
<li>Choose a virtual MFA device and then choose<strong><strong> Next Step.</strong></strong><br /> <img class="alignnone wp-image-4990" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/MFA-options.png" alt="" width="700" height="370" /></li> 
<li>If you do not have an AWS MFA-compatible application, install one of the available applications. Choose <strong>Next Step</strong>.<br /> <img class="alignnone wp-image-4947" title="Screenshot showing that you must first install an AWS MFA-compatible application" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/AWS-MFA-compatible-application-notification.png" alt="Screenshot showing that you must first install an AWS MFA-compatible application" width="700" height="340" /></li> 
<li>Open the virtual MFA app on your phone and choose the option to create a new account.</li> 
<li>Use the app to scan the QR code on your computer screen. Alternatively, you can choose <strong>Show secret key for manual configuration</strong>, and then type the secret key in the MFA app.<br /> <img class="alignnone wp-image-4948" title="Screenshot of the QR code that you scan with your smartphone app" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/Authentication-QR-code.png" alt="Screenshot of the QR code that you scan with your smartphone app" width="600" height="519" /></li> 
<li>In the <strong>Authentication code 1</strong> box, type the OTP that appears in the virtual MFA app. Wait for up to 30 seconds for the app to generate a second OTP. Type the second OTP in the <strong>Authentication code 2</strong> box and then choose <strong>Activate virtual MFA</strong>.</li> 
</ol> 
<p>You have now successfully enabled virtual MFA and associated it with your root account, and your root account is now protected by using MFA. You will use the virtual MFA app to generate an authentication code for subsequent sign-ins.<br /> <img class="alignnone wp-image-4950" title="Screenshot showing that the virtual MFA device was successfully associated with the account" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/Virtual-MFA-setup-complete.png" alt="Screenshot showing that the virtual MFA device was successfully associated with the account" width="700" height="366" /></p> 
<h3>Summary</h3> 
<p>In this blog post, I demonstrated how you can reset your AWS root account’s lost MFA device by using the AWS Management Console. I also showed how you can associate a virtual MFA device with your root account.</p> 
<p>If you have comments about resetting an MFA device for root users, submit them in the “Comments” section below. If you have implementation questions, start a thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Ujjwal</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/access-management/" rel="tag">Access management</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-accounts/" rel="tag">AWS Accounts</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-root-account/" rel="tag">AWS root account</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-users/" rel="tag">IAM users</a>, <a href="https://aws.amazon.com/blogs/security/tag/mfa/" rel="tag">MFA</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4346');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Greater Transparency into Actions AWS Services Perform on Your Behalf by Using AWS CloudTrail</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Ujjwal Pugalia</span></span> | on 
<time property="datePublished" datetime="2017-09-20T14:03:51+00:00">20 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/management-tools/aws-cloudtrail/" title="View all posts in AWS CloudTrail*"><span property="articleSection">AWS CloudTrail*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/get-greater-transparency-into-actions-aws-services-perform-on-your-behalf-by-using-aws-cloudtrail/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-5040" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=5040&amp;disqus_title=Greater+Transparency+into+Actions+AWS+Services+Perform+on+Your+Behalf+by+Using+AWS+CloudTrail&amp;disqus_url=https://aws.amazon.com/blogs/security/get-greater-transparency-into-actions-aws-services-perform-on-your-behalf-by-using-aws-cloudtrail/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5040');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>To make managing your AWS account easier, some AWS services perform actions on your behalf, including the creation and management of AWS resources. For example,&nbsp;<a href="https://aws.amazon.com/elasticbeanstalk/" target="_blank" rel="noopener noreferrer">AWS Elastic Beanstalk</a>&nbsp;automatically handles the deployment details of capacity provisioning, load balancing, auto-scaling, and application health monitoring. To make these AWS actions more transparent, AWS adds an <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a>&nbsp;(IAM)&nbsp;<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_terms-and-concepts.html#iam-term-service-linked-role" target="_blank" rel="noopener noreferrer">service-linked role</a> to your account for each linked service you use. Service-linked roles let you view all actions an AWS service performs on your behalf by using&nbsp;<a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>&nbsp;logs. This helps you monitor and audit the actions AWS services perform on your behalf. No additional actions are required from you and you can continue using AWS services the way you do today.</p> 
<p>To learn more about which AWS services use service-linked roles and log actions on your behalf to CloudTrail, see <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html" target="_blank" rel="noopener noreferrer">AWS Services That Work with IAM</a>. Over time, more AWS services will support service-linked roles. For more information about service-linked roles, see <a href="https://docs.aws.amazon.com/console/iam/service-linked-role" target="_blank" rel="noopener noreferrer">Role Terms and Concepts</a>.</p> 
<p>In this blog post, I demonstrate how to view CloudTrail logs so that you can more easily monitor and audit AWS services performing actions on your behalf. First, I show how AWS creates a service-linked role in your account automatically when you configure an AWS service that supports service-linked roles. Next, I show how you can view the policies of a service-linked role that grants an AWS service permission to perform actions on your behalf. Finally, I use the configured AWS service to perform an action and show you how the action appears in your CloudTrail logs.<br /> <span id="more-5040"></span></p> 
<h3>How AWS creates a service-linked role in your account automatically</h3> 
<p>I will use <a href="https://aws.amazon.com/lex/" target="_blank" rel="noopener noreferrer">Amazon Lex</a> as the AWS service that performs actions on your behalf for this post. You can use Amazon Lex to create <a href="https://aws.amazon.com/what-is-a-chatbot/" target="_blank" rel="noopener noreferrer">chatbots</a> that allow for highly engaging conversational experiences through voice and text. You also can use chatbots on mobile devices, web browsers, and popular chat platform channels such as Slack. Amazon Lex uses <a href="https://aws.amazon.com/polly/" target="_blank" rel="noopener noreferrer">Amazon Polly</a> on your behalf to synthesize speech that sounds like a human voice.</p> 
<p>Amazon Lex uses two IAM service-linked roles:</p> 
<ul> 
<li><span style="font-family: courier">AWSServiceRoleForLexBots</span> — Amazon Lex uses this service-linked role to invoke Amazon Polly to synthesize speech responses for your chatbot.</li> 
<li><span style="font-family: courier">AWSServiceRoleForLexChannels</span> — Amazon Lex uses this service-linked role to post text to your chatbot when managing channels such as Slack.</li> 
</ul> 
<p>You don’t need to create either of these roles manually. When you create your first chatbot using the Amazon Lex console, Amazon Lex creates the <span style="font-family: courier">AWSServiceRoleForLexBots</span> role for you. When you first associate a chatbot with a messaging channel, Amazon Lex creates the <span style="font-family: courier">AWSServiceRoleForLexChannels</span> role in your account.</p> 
<h4>1. Start configuring the AWS service that supports service-linked roles</h4> 
<p>Navigate to the <a href="https://console.aws.amazon.com/lex/home" target="_blank" rel="noopener noreferrer">Amazon Lex console</a>, and&nbsp;choose <strong>Get Started</strong> to navigate to the <strong>Create your Lex bot</strong> page<strong>. </strong>For this example, I choose a sample chatbot called <strong>OrderFlowers. </strong>To learn how to create a custom chatbot, see <a href="http://docs.aws.amazon.com/lex/latest/dg/getting-started-ex2.html" target="_blank" rel="noopener noreferrer">Create a Custom Amazon Lex Bot</a><strong>.</strong></p> 
<p><img class="alignnone wp-image-5096 size-full" title="Screenshot of making the choice to create an OrderFlowers chatbot" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-1.png" alt="Screenshot of making the choice to create an OrderFlowers chatbot" width="900" height="219" /></p> 
<h4>2. Complete the configuration for the AWS service</h4> 
<p>When you scroll down, you will see the settings for the <b>OrderFlowers</b> chatbot. Notice the field for the <b>IAM role</b> with the value, <span style="font-family: courier">AWSServiceRoleForLexBots</span>. This service-linked role is “Automatically created on your behalf.” After you have entered all details, choose <b>Create</b> to build your sample chatbot.</p> 
<p><img class="alignnone wp-image-5120 size-full" title="Screenshot of the automatically created service-linked role" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/20/Ujjwal_SLRbackfill_tweetimage_092017-a.png" alt="Screenshot of the automatically created service-linked role" width="789" height="230" /></p> 
<p>AWS has created the <span style="font-family: courier">AWSServiceRoleForLexBots</span>&nbsp;service-linked role in your account. I will return to using the chatbot later in this post when I discuss how Amazon Lex performs actions on your behalf and how CloudTrail logs these actions. First, I will show how you can view the permissions for the <span style="font-family: courier">AWSServiceRoleForLexBots</span>&nbsp;service-linked role by using the IAM console.</p> 
<h3>How to view actions in the IAM console that AWS services perform on your behalf</h3> 
<p>When you configure an AWS service that supports service-linked roles, AWS creates a service-linked role in your account automatically. You can view the service-linked role by using the IAM console.</p> 
<h4>1. View the AWSServiceRoleForLexBots service-linked role on the IAM console</h4> 
<p>Go to the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a>, and choose <span style="font-family: courier">AWSServiceRoleForLexBots</span> on the <strong>Roles </strong>page. You can confirm that this role is a service-linked role by viewing the <strong>Trusted entities</strong> column.</p> 
<p><img class="alignnone wp-image-5098 size-full" title="Screenshot of the service-linked role" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-3.png" alt="Screenshot of the service-linked role" width="900" height="128" /></p> 
<h4>2.View the trusted entities that can assume the AWSServiceRoleForLexBots service-linked role</h4> 
<p>Choose the <strong>Trust relationships </strong>tab on the <span style="font-family: courier">AWSServiceRoleForLexBots</span> role page. You can view the trusted entities that can assume the <span style="font-family: courier">AWSServiceRoleForLexBots</span> service-linked role to perform actions on your behalf. In this example, the trusted entity is <span style="font-family: courier">lex.amazonaws.com</span>.</p> 
<p><img class="alignnone wp-image-5099 size-full" title="Screenshot of the trusted entities that can assume the service-linked role" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-4.png" alt="Screenshot of the trusted entities that can assume the service-linked role" width="638" height="338" /></p> 
<h4>3. View the policy attached to the AWSServiceRoleForLexBots service-linked role</h4> 
<p>Choose <strong>AmazonLexBotPolicy</strong> on the <strong>Permissions</strong> tab to view the policy attached to the <span style="font-family: courier">AWSServiceRoleForLexBots</span> service-linked role. You can view the policy summary to see that&nbsp;<span style="font-family: courier">AmazonLexBotPolicy</span> grants permission to Amazon Lex to use Amazon Polly.</p> 
<p><img class="alignnone wp-image-5100 size-full" title="Screenshot showing that AmazonLexBotPolicy grants permission to Amazon Lex to use Amazon Polly" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-5.png" alt="Screenshot showing that AmazonLexBotPolicy grants permission to Amazon Lex to use Amazon Polly" width="900" height="437" /></p> 
<h4>4. View the actions that the service-linked role grants permissions to use</h4> 
<p>Choose <strong>Polly</strong> to view the action, <span style="font-family: courier">SynthesizeSpeech</span>, that the <span style="font-family: courier">AmazonLexBotPolicy</span> grants permission to Amazon Lex to perform on your behalf. Amazon Lex uses this permission to synthesize speech responses for your chatbot. I show later in this post how you can monitor this <span style="font-family: courier">SynthesizeSpeech</span> action in your CloudTrail logs.</p> 
<p><img class="alignnone wp-image-5101 size-full" title="Screenshot showing the the action, SynthesizeSpeech, that the AmazonLexBotPolicy grants permission to Amazon Lex to perform on your behalf" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-6.png" alt="Screenshot showing the the action, SynthesizeSpeech, that the AmazonLexBotPolicy grants permission to Amazon Lex to perform on your behalf" width="858" height="452" /></p> 
<p>Now that I know the trusted entity and the policy attached to the service-linked role, let’s go back to the chatbot I created earlier and see how CloudTrail logs the actions that Amazon Lex performs on my behalf.</p> 
<h3>How to use CloudTrail to view actions that AWS services perform on your behalf</h3> 
<p>As discussed already, I created an <strong>OrderFlowers</strong> chatbot on the <a href="https://console.aws.amazon.com/lex/home" target="_blank" rel="noopener noreferrer">Amazon Lex console</a>. I will use the chatbot and display how the <span style="font-family: courier">AWSServiceRoleForLexBots</span> service-linked role helps me track actions in CloudTrail. First, though, I must have an active CloudTrail trail created that stores the logs in an <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> bucket. I will use a trail called <span style="font-family: courier">TestTrail</span> and an S3 bucket called <span style="font-family: courier">account-ids-slr</span>.</p> 
<h4>1. Use the Amazon Lex chatbot via the Amazon Lex console</h4> 
<p>In Step 2 in the first section of this post, when I chose <strong>Create</strong><strong>, </strong>Amazon Lex built the <strong>OrderFlowers </strong>chatbot. After the chatbot was built, the right pane showed that a <strong>Test Bot</strong>&nbsp;was created. Now, I choose the microphone symbol in the right pane and provide voice input to test the <strong>OrderFlowers </strong>chatbot. In this example, I tell the chatbot, “I would like to order some flowers.” The bot replies to me by asking, “What type of flowers would you like to order?”</p> 
<p><img class="alignnone wp-image-5102 size-full" title="Screenshot of voice input to test the OrderFlowers chatbot" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/18/Screen-7.png" alt="Screenshot of voice input to test the OrderFlowers chatbot" width="577" height="364" /></p> 
<p>When the chatbot replies using voice, Amazon Lex uses Amazon Polly to synthesize speech from text to voice. Amazon Lex assumes the <span style="font-family: courier">AWSServiceRoleForLexBots</span> service-linked role to perform the <span style="font-family: courier">SynthesizeSpeech</span> action.</p> 
<h4>2. Check CloudTrail to view actions performed on your behalf</h4> 
<p>Now that I have created the chatbot, let’s see which actions were logged in CloudTrail. Choose <strong>CloudTrail</strong> from the <strong>Services</strong> drop-down menu to reach the <a href="https://console.aws.amazon.com/cloudtrail/home" target="_blank" rel="noopener noreferrer">CloudTrail console</a>. Choose <strong>Trails</strong> and choose the S3 bucket in which you are storing your CloudTrail logs.</p> 
<p><img class="alignnone wp-image-5060 size-full" title="Screenshot of the TestTrail trail" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/14/UP9-091817.png" alt="Screenshot of the TestTrail trail" width="900" height="201" /></p> 
<p>In the S3 bucket, you will find log entries for the <span style="font-family: Courier">SynthesizeSpeech</span> event. This means that CloudTrail logged the action when Amazon Lex assumed the <span style="font-family: Courier">AWSServiceRoleForLexBots</span> service-linked role to invoke Amazon Polly to synthesize speech responses for your chatbot. You can monitor and audit this invocation, and it provides you with transparency into Amazon Polly’s <span style="font-family: Courier">SynthesizeSpeech</span> action that Amazon Lex invoked on your behalf. The applicable CloudTrail log section follows and I have <strong>emphasized</strong> the key lines.</p> 
<pre><code class="lang-text">{  
&quot;eventVersion&quot;:&quot;1.05&quot;,
&quot;userIdentity&quot;:{  
<strong>&quot;type&quot;:&quot;AssumedRole&quot;,</strong>
<strong>&quot;principalId&quot;:&quot;{principal-id}:OrderFlowers&quot;,</strong>
<strong>&quot;arn&quot;:&quot;arn:aws:sts::{account-id}:assumed-role/AWSServiceRoleForLexBots/OrderFlowers&quot;,</strong>
<strong>&quot;accountId&quot;:&quot;{account-id}&quot;,</strong>
<strong>&quot;accessKeyId&quot;:&quot;{access-key-id}&quot;,</strong>
&quot;sessionContext&quot;:{  
&quot;attributes&quot;:{  
&quot;mfaAuthenticated&quot;:&quot;false&quot;,
&quot;creationDate&quot;:&quot;2017-09-17T17:30:05Z&quot;
},
&quot;sessionIssuer&quot;:{  
<strong>&quot;type&quot;:&quot;Role&quot;,</strong>
<strong>&quot;principalId&quot;:&quot;{principal-id}&quot;,</strong>
<strong>&quot;arn&quot;:&quot;arn:aws:iam:: {account-id}:role/aws-service-role/lex.amazonaws.com/AWSServiceRoleForLexBots&quot;,</strong>
<strong>&quot;accountId&quot;:&quot;{account-id}&quot;,</strong>
<strong>&quot;userName&quot;:&quot;AWSServiceRoleForLexBots&quot;</strong>
}
},
<strong>&quot;invokedBy&quot;:&quot;lex.amazonaws.com&quot;</strong>
},
<strong>&quot;eventTime&quot;:&quot;2017-09-17T17:30:05Z&quot;,</strong>
<strong>&quot;eventSource&quot;:&quot;polly.amazonaws.com&quot;,</strong>
<strong>&quot;eventName&quot;:&quot;SynthesizeSpeech&quot;,</strong>
<strong>&quot;awsRegion&quot;:&quot;us-east-1&quot;,</strong>
<strong>&quot;sourceIPAddress&quot;:&quot;lex.amazonaws.com&quot;,</strong>
<strong>&quot;userAgent&quot;:&quot;lex.amazonaws.com&quot;,</strong>
&quot;requestParameters&quot;:{  
&quot;outputFormat&quot;:&quot;mp3&quot;,
&quot;textType&quot;:&quot;text&quot;,
&quot;voiceId&quot;:&quot;Salli&quot;,
&quot;text&quot;:&quot;**********&quot;
},
&quot;responseElements&quot;:{  
&quot;requestCharacters&quot;:45,
&quot;contentType&quot;:&quot;audio/mpeg&quot;
},
&quot;requestID&quot;:&quot;{request-id}&quot;,
&quot;eventID&quot;:&quot;{event-id}&quot;,
&quot;eventType&quot;:&quot;AwsApiCall&quot;,
&quot;recipientAccountId&quot;:&quot;{account-id}&quot;
}</code></pre> 
<h3>Conclusion</h3> 
<p>Service-linked roles make it easier for you to track and view actions that linked AWS services perform on your behalf by using CloudTrail. When an AWS service supports service-linked roles to enable this additional logging, you will see a service-linked role added to your account.</p> 
<p>If you have comments about this post, submit a comment in the “Comments” section below. If you have questions about working with service-linked roles, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Ujjwal</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/amazon-lex/" rel="tag">Amazon Lex</a>, <a href="https://aws.amazon.com/blogs/security/tag/amazon-polly/" rel="tag">Amazon Polly</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-cloudtrail/" rel="tag">AWS CloudTrail</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/security/tag/chatbots/" rel="tag">chatbots</a>, <a href="https://aws.amazon.com/blogs/security/tag/service-linked-roles/" rel="tag">service-linked roles</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5040');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Query Personally Identifiable Information with Amazon Macie</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Chad Woolf</span></span> | on 
<time property="datePublished" datetime="2017-09-20T06:49:25+00:00">20 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/amazon-macie/" title="View all posts in Amazon Macie*"><span property="articleSection">Amazon Macie*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-query-personally-identifiable-information-with-amazon-macie/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4696" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4696&amp;disqus_title=How+to+Query+Personally+Identifiable+Information+with+Amazon+Macie&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-query-personally-identifiable-information-with-amazon-macie/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4696');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone" title="Amazon Macie logo" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/24/AmazonMacie-500x250.png" alt="Amazon Macie logo" width="500" height="250" /></p> 
<p>In August 2017 at the <a href="https://aws.amazon.com/summits/new-york/" target="_blank" rel="noopener noreferrer">AWS Summit New York</a>, AWS launched a new security and compliance service called <a href="https://aws.amazon.com/macie/" target="_blank" rel="noopener noreferrer">Amazon Macie</a>. Macie uses machine learning to automatically discover, classify, and protect sensitive data in AWS. In this blog post, I demonstrate how you can use Macie to help enable compliance with applicable regulations, starting with data retention.</p> 
<h3>How to query retained&nbsp;PII with Macie</h3> 
<p>Data retention and mandatory data deletion are common topics across compliance frameworks, so knowing what is stored and how long it has been or needs to be stored is of critical importance. For example, you can use Macie for <a href="https://aws.amazon.com/compliance/pci-dss-level-1-faqs/" target="_blank" rel="noopener noreferrer">Payment Card Industry Data Security Standard (PCI DSS)</a> 3.2, requirement 3, “Protect stored cardholder data,” which mandates a “quarterly process for identifying and securely deleting stored cardholder data that exceeds defined retention.” You also can use Macie for <a href="https://aws.amazon.com/compliance/iso-27017-faqs/" target="_blank" rel="noopener noreferrer">ISO 27017</a> requirement 12.3.1, which calls for “retention periods for backup data.” In each of these cases, you can use Macie’s built-in queries to identify the age of data in your <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> buckets and to help meet your compliance needs.</p> 
<p>To get started with Macie and run your first queries of personally identifiable information (PII) and sensitive data, follow the initial setup as described in the <a href="https://aws.amazon.com/blogs/aws/launch-amazon-macie-securing-your-s3-buckets/" target="_blank" rel="noopener noreferrer">launch post on the AWS Blog</a>. After you have set up Macie, walk through the following steps to start running queries. Start by focusing on the S3 buckets that you want to inventory and capture important compliance related activity and data.<span id="more-4696"></span></p> 
<p>To start running Macie queries:</p> 
<ol> 
<li>In the AWS Management Console, launch the <a href="https://us-east-1.redirection.macie.aws.amazon.com/" target="_blank" rel="noopener noreferrer">Macie console</a>&nbsp;(you can type <span style="font-family: courier">macie</span> to find the console).<br /> <img class="alignnone wp-image-5037 size-full" title="Screenshot of finding the Macie console" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/14/1-b.png" alt="" width="900" height="459" /></li> 
<li>Click <strong>Dashboard</strong> in the navigation pane. This shows you an overview of the risk level and data classification type of all inventoried S3 buckets, categorized by date and type.<br /> <img class="alignnone wp-image-4706 size-full" title="Screenshot of &quot;Dashboard&quot; in the navigation pane" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/2.png" alt="Screenshot of &quot;Dashboard&quot; in the navigation pane" width="604" height="368" /></li> 
<li>Choose <strong>S3 objects by PII priority</strong>. This dashboard lets you sort by PII priority and PII types.<br /> <img class="alignnone wp-image-4710 size-full" title="Screenshot of &quot;S3 objects by PII priority&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/3-a.png" alt="Screenshot of &quot;S3 objects by PII priority&quot;" width="844" height="464" /></li> 
<li>In this case, I want to find information about credit card numbers. I choose the magnifying glass for the type <strong>cc_number</strong> (note that PII types can be used for custom queries). This view shows the events where PII classified data has been uploaded to S3. When I scroll down, I see the individual files that have been identified.<br /> <img class="alignnone wp-image-5128 size-full" title="Screenshot showing the events where PII classified data has been uploaded to S3" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/5-b.png" alt="Screenshot showing the events where PII classified data has been uploaded to S3" width="818" height="722" /></li> 
<li>Before looking at the files, I want to continue to build the query by only showing items with high priority. To do so, I choose the row called <strong>Object PII Priority</strong> and then the magnifying glass icon next to <strong>High</strong>.<br /> <img class="alignnone wp-image-4709 size-full" title="Screenshot of refining the query for high priority events" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/8.png" alt="Screenshot of refining the query for high priority events" width="825" height="351" /></li> 
<li>To view the results matching these queries, I scroll down and choose any file listed. This shows vital information such as creation date, location, and object access control list (ACL).</li> 
<li>The piece I am most interested in this case is the <strong>Object PII details</strong> line to understand more about what was found in the file. In this case, I see name and credit card information, which is what caused the high priority. Scrolling up again, I&nbsp;also see that the query fields&nbsp;have updated as I interacted with the UI.<br /> <img class="alignnone wp-image-5129 size-full" title="Screenshot showing &quot;Object PII details&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/9-a.png" alt="Screenshot showing &quot;Object PII details&quot;" width="608" height="711" /></li> 
</ol> 
<p style="padding-left: 30px">Let’s say that I want to get an alert every time Macie finds new data matching this query. This alert can be used to automate response actions by using <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> and <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" target="_blank" rel="noopener noreferrer">Amazon CloudWatch Events</a>.</p> 
<ol start="8"> 
<li>I choose the left green icon called <strong>Save query as alert</strong>.<br /> <img class="alignnone wp-image-4716 size-full" title="Screenshot of &quot;Save query as alert&quot; button" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/11-a.png" alt="Screenshot of &quot;Save query as alert&quot; button" width="800" height="102" /></li> 
<li>I can customize the alert and change things like category or severity to fit my needs based on the alert data.</li> 
<li>Another way to find the information I am looking for is to run custom queries. To start using custom queries, I choose <strong>Research</strong> in the navigation pane. 
<ol type="a"> 
<li>To learn more about custom Macie queries and what you can do on the <strong>Research</strong> tab, see <a href="https://docs.aws.amazon.com/macie/latest/userguide/macie-research.html" target="_blank" rel="noopener noreferrer">Using the Macie Research Tab</a>.</li> 
</ol> </li> 
<li>I&nbsp;change the type of query I want to run from <strong>CloudTrail data</strong> to <strong>S3 objects</strong> in the drop-down list menu.<br /> <img class="alignnone wp-image-4717 size-full" title="Screenshot of choosing &quot;S3 objects&quot; from the drop-down list menu" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/15.png" alt="Screenshot of choosing &quot;S3 objects&quot; from the drop-down list menu" width="536" height="363" /></li> 
<li>Because I want PII data, I start typing in the query box, which has an autocomplete feature. I choose the <strong>pii_types:</strong> query. I can now type the data I want to look for. In this case, I want to see all files matching the credit card filter so I type <span style="font-family: courier">cc_number</span> and press <strong>Enter</strong>. The query box now says, <span style="font-family: courier">pii_types:cc_number</span>. I press <strong>Enter</strong> again to enable autocomplete, and then I type <span style="font-family: courier">AND pii_types:email</span> to require both a credit card number and email address in a single object.<br /> <img class="alignnone wp-image-4718 size-full" title="The query looks for all files matching the credit card filter (&quot;cc_number&quot;)" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/30/16_2.png" alt="The query looks for all files matching the credit card filter (&quot;cc_number&quot;)" width="802" height="374" /></li> 
<li>I choose the magnifying glass to search and Macie shows me all S3 objects that are tagged as <strong>PII</strong>&nbsp;of type <strong>Credit Cards</strong>. I can further specify that I only want to see <strong>PII</strong>&nbsp;of type <strong>Credit Card</strong>&nbsp;that are classified as <strong>High</strong>&nbsp;priority by adding <span style="font-family: courier">AND</span> and <span style="font-family: courier">pii_impact:high</span> to the query.<br /> <img class="alignnone wp-image-5130 size-full" title="Screenshot showing narrowing the query results further" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/21/17-a.png" alt="Screenshot showing narrowing the query results further" width="901" height="673" />As before, I can save this new query as an alert by clicking <strong>Save query as alert</strong>, which will be triggered by data matching the query going forward.</li> 
</ol> 
<h3>Advanced tip</h3> 
<p>Try the following advanced queries using <a href="https://lucene.apache.org/" target="_blank" rel="noopener noreferrer">Lucene query syntax</a> and save the queries as alerts in Macie.</p> 
<ul> 
<li>Use a regular-expression based query to search for a minimum of 10 credit card numbers and 10 email addresses in a single object: 
<ul> 
<li><span style="font-family: courier">pii_explain.cc_number:/([1-9][0-9]|[0-9]{3,}) distinct Credit Card Numbers.*/ AND pii_explain.email:/([1-9][0-9]|[0-9]{3,}) distinct Email Addresses.*/</span></li> 
</ul> </li> 
<li>Search for objects containing at least one credit card, name, and email address that have an object policy enabling global access (searching for S3 <span style="font-family: courier">AllUsers</span> or <span style="font-family: courier">AuthenticatedUsers</span> permissions): 
<ul> 
<li><span style="font-family: courier">(object_acl.Grants.Grantee.URI:”http\://acs.amazonaws.com/groups/global/AllUsers” OR&nbsp; object_acl.Grants.Grantee.URI:”http\://acs.amazonaws.com/groups/global/AllUsers”) AND (pii_types.cc_number AND pii_types.email AND pii_types.name)</span></li> 
</ul> </li> 
</ul> 
<p>These are two ways to identify and be alerted about PII by using Macie. In a similar way, you can create custom alerts for various <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a> events by choosing a different data set on which to run the queries again. In the examples in this post, I identified credit cards stored in plain text (all data in this post is example data only), determined how long they had been stored in S3 by viewing the result details, and set up alerts to notify or trigger actions on new sensitive data being stored. With queries like these, you can&nbsp;build a reliable data validation program.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about how to use Macie, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=258&amp;start=0" target="_blank" rel="noopener noreferrer">Macie forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>-Chad</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/pii/" rel="tag">PII</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4696');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">AWS IAM Policy Summaries Now Help You Identify Errors and Correct Permissions in Your IAM Policies</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Joy Chatterjee</span></span> | on 
<time property="datePublished" datetime="2017-09-15T06:45:09+00:00">15 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/iam-policy-summaries-now-help-you-identify-errors-and-correct-permissions-in-your-iam-policies/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4724" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4724&amp;disqus_title=AWS+IAM+Policy+Summaries+Now+Help+You+Identify+Errors+and+Correct+Permissions+in+Your+IAM+Policies&amp;disqus_url=https://aws.amazon.com/blogs/security/iam-policy-summaries-now-help-you-identify-errors-and-correct-permissions-in-your-iam-policies/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4724');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>In March, we made it easier to view and understand the permissions in your <a href="http://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) policies by using <a href="https://aws.amazon.com/blogs/security/move-over-json-policy-summaries-make-understanding-iam-policies-easier/" target="_blank" rel="noopener noreferrer">IAM policy summaries</a>. Today, we updated policy summaries to help you identify and correct errors in your IAM policies. When you set permissions using IAM policies, for each action you specify, you must match that action to supported resources or conditions.&nbsp;Now, you will see a warning if these policy elements (<span style="font-family: courier">Actions</span>, <span style="font-family: courier">Resources</span>, and&nbsp;<span style="font-family: courier">Conditions</span>) defined in your IAM policy do not match.</p> 
<p>When working with policies, you may find that although the policy has valid JSON syntax, it does not grant or deny the desired permissions because the <span style="font-family: courier">Action</span>&nbsp;element does not have an applicable <span style="font-family: courier">Resource</span>&nbsp;element or <span style="font-family: courier">Condition</span>&nbsp;element defined in the policy. For example, you may want to create a policy that allows users to view a specific <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a> instance. To do this, you create a policy that specifies <span style="font-family: courier">ec2:DescribeInstances</span> for the <span style="font-family: courier">Action</span>&nbsp;element and the Amazon Resource Name (ARN) of the instance for the <span style="font-family: courier">Resource </span>element. When testing this policy, you find AWS denies this access because <span style="font-family: courier">ec2:DescribeInstances</span> does not support <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_aws-services-that-work-with-iam.html" target="_blank" rel="noopener noreferrer">resource-level permissions</a> and requires access to list <em>all</em> instances. Therefore, to grant access to this <span style="font-family: courier">Action</span>&nbsp;element, you need to specify a wildcard (*) in the <span style="font-family: courier">Resource</span> element of your policy for this <span style="font-family: courier">Action</span>&nbsp;element in order for the policy to function correctly.</p> 
<p>To help you identify and correct permissions, you will now see a warning in a policy summary if the policy has either of the following:</p> 
<ul> 
<li>An action&nbsp;that does not support the resource&nbsp;specified in a&nbsp;policy.</li> 
<li>An action&nbsp;that does not support the condition&nbsp;specified in a policy.</li> 
</ul> 
<p>In this blog post, I walk through two examples of how you can use policy summaries to help identify and correct these types of errors in your IAM policies.<span id="more-4724"></span></p> 
<h3>How to use IAM policy summaries to debug your policies</h3> 
<h4>Example 1: An action does not support the resource specified in a policy</h4> 
<p>Let’s say a human resources (HR) representative, Casey, needs access to the personnel files stored in HR’s <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> bucket. To do this, I create the following policy to grant all actions&nbsp;that begin with <span style="font-family: courier">s3:List</span>. In addition, I grant access to <span style="font-family: courier">s3:GetObject</span> in the <span style="font-family: courier">Action</span> element of the policy. To ensure that Casey has access only to a specific bucket and not others, I specify the bucket ARN in the <span style="font-family: courier">Resource</span> element of the policy.</p> 
<p><strong>Note:</strong> This policy does <em>not</em> grant the desired permissions.</p> 
<pre><code class="lang-text"><span style="color: #ff0000"><strong>This policy does not work. Do not copy.</strong></span>
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;ThisPolicyDoesNotGrantAllListandGetActions&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [&quot;s3:List*&quot;,
&quot;s3:GetObject&quot;],
&quot;Resource&quot;: [&quot;arn:aws:s3:::HumanResources&quot;]
}
]
}</code></pre> 
<p>After I <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html" target="_blank" rel="noopener noreferrer">create the policy</a>, <span style="font-family: courier">HRBucketPermissions</span>, I select this policy from the <strong>Policies</strong> page to view the policy summary. From here, I check to see if there are any warnings or <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/troubleshoot_policies.html#unrecognized-services-actions" target="_blank" rel="noopener noreferrer">typos</a> in the policy. I see a warning at the top of the policy detail page because the policy does not grant some permissions specified in the policy, which is caused by a mismatch among the actions, resources, or conditions.</p> 
<p><img class="alignnone wp-image-5082 size-full" title="Screenshot showing the warning at the top of the policy" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/14/Capture-JC1-091217-e.jpg" alt="Screenshot showing the warning at the top of the policy" width="662" height="275" /></p> 
<p>To view more details about the warning, I choose <strong>Show remaining </strong>so that I can understand why the permissions do not appear in the policy summary. As shown in the following screenshot, I see no access to the <a href="https://aws.amazon.com/blogs/security/new-features-for-iam-policy-summaries-services-and-actions-not-granted-by-a-policy/" target="_blank" rel="noopener noreferrer">services that are not granted by the IAM policy</a> in the policy, which is expected. However, next to <strong>S3</strong>, I see a warning that one or more S3 actions do not have an applicable resource.</p> 
<p><img class="alignnone wp-image-4745 size-full" title="Screenshot showing that one or more S3 actions do not have an applicable resource" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/31/JC2-0917-se.png" alt="Screenshot showing that one or more S3 actions do not have an applicable resource" width="984" height="259" /></p> 
<p>To understand why the specific actions&nbsp;do not have a supported resource, I choose <strong>S3</strong> from the list of services and choose <strong>Show remaining</strong>. I type <span style="font-family: courier">List</span> in the filter to understand why some of the list actions are not granted by the policy. As shown in the following screenshot, I see these warnings:</p> 
<ul> 
<li><strong>This action does not support resource-level permissions</strong>. This means the action&nbsp;does not support <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-supported-iam-actions-resources.html" target="_blank" rel="noopener noreferrer">resource-level permissions</a> and requires a wildcard (*) in the <span style="font-family: courier">Resource</span> element of the policy.</li> 
<li><strong>This action does not have an applicable resource</strong>. This means the action&nbsp;supports resource-level permissions, but not the resource&nbsp;type defined in the policy. In this example, I specified an S3 bucket for an action&nbsp;that supports only an&nbsp;<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingObjects.html" target="_blank" rel="noopener noreferrer">S3 object resource type</a>.</li> 
</ul> 
<p style="padding-left: 30px"><img class="alignnone wp-image-5029 size-full" title="Screenshot showing two warnings" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/13/Capture-JC2-091217-c.jpg" alt="" width="770" height="284" /></p> 
<p>From these warnings, I see that <span style="font-family: courier">s3:ListAllMyBuckets</span>, <span style="font-family: courier">s3:ListBucketMultipartUploadsPart</span>,&nbsp;<span style="font-family: courier">s3:ListObjects</span>&nbsp;, and <span style="font-family: courier">s3:GetObject</span> do not support an S3 bucket resource&nbsp;type, which results in Casey not having access to the S3 bucket. To correct the policy, I choose <strong>Edit policy</strong> and update the policy with three statements based on the resource&nbsp;that the S3 actions&nbsp;support. Because Casey needs access to view and read all of the objects in the <span style="font-family: courier">HumanResources</span> bucket, I add a wildcard (*) for the S3 object path in the <span style="font-family: courier">Resource</span> ARN.</p> 
<pre><code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;TheseActionsSupportBucketResourceType&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [&quot;s3:ListBucket&quot;,
&quot;s3:ListBucketByTags&quot;,
&quot;s3:ListBucketMultipartUploads&quot;,
&quot;s3:ListBucketVersions&quot;],
&quot;Resource&quot;: [&quot;arn:aws:s3:::HumanResources&quot;]
},{
&quot;Sid&quot;: &quot;TheseActionsRequireAllResources&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [&quot;s3:ListAllMyBuckets&quot;,
&quot;s3:ListMultipartUploadParts&quot;,
&quot;s3:ListObjects&quot;],
&quot;Resource&quot;: [ &quot;*&quot;]
},{
&quot;Sid&quot;: &quot;TheseActionsRequireSupportsObjectResourceType&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [&quot;s3:GetObject&quot;],
&quot;Resource&quot;: [&quot;arn:aws:s3:::HumanResources/*&quot;]
}
]
}</code></pre> 
<p>After I make these changes, I see the updated policy summary and see that warnings are no longer displayed.</p> 
<p><img class="alignnone wp-image-4747 size-full" title="Screenshot of the updated policy summary that no longer shows warnings" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/31/JC4-0917-se.png" alt="Screenshot of the updated policy summary that no longer shows warnings" width="1211" height="312" /></p> 
<p>In the previous example, I showed how to identify and correct permissions errors that include actions&nbsp;that do not support a specified resource. In the next example, I show how to use policy summaries to identify and correct a policy that includes actions that do not support a specified condition.</p> 
<h4>Example 2: An action does not support the condition&nbsp;specified in a policy</h4> 
<p>For this example, let’s assume Bob is a project manager who requires view and read access to all the code builds for his team. To grant him this access, I create the following JSON policy that specifies all list and read actions&nbsp;to <a href="https://aws.amazon.com/codebuild/" target="_blank" rel="noopener noreferrer">AWS CodeBuild</a> and defines a condition&nbsp;to limit access to resources&nbsp;in the <span style="font-family: courier">us-west-2</span>&nbsp;Region in which Bob’s team develops.</p> 
<pre><code class="lang-text"><span style="color: #ff0000"><strong>This policy does not work. Do not copy.</strong> </span>
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;ListReadAccesstoCodeServices&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;codebuild:List*&quot;,
&quot;codebuild:BatchGet*&quot;
],
&quot;Resource&quot;: [&quot;*&quot;], 
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
<strong>&quot;ec2:Region&quot;: &quot;us-west-2&quot;</strong>
}
}
}
]	
}</code></pre> 
<p>After I create the policy, <span style="font-family: courier">PMCodeBuildAccess</span>, I select this policy from the <strong>Policies</strong> page to view the policy summary in the IAM console. From here, I check to see if the policy has any warnings or <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/troubleshoot_policies.html#unrecognized-services-actions" target="_blank" rel="noopener noreferrer">typos</a>. I see an error at the top of the policy detail page because the policy does not grant any permissions.</p> 
<p><img class="alignnone wp-image-5031 size-full" title="Screenshot with an error showing the policy does not grant any permissions" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/13/Capture-JC3-091217-c.jpg" alt="Screenshot with an error showing the policy does not grant any permissions" width="554" height="249" /></p> 
<p>To view more details about the error, I choose <strong>Show remaining </strong>to understand why no permissions result from the policy. I see this warning: <strong>One or more conditions&nbsp;do not have an applicable action.</strong> This means that the condition&nbsp;is not supported by any of the actions&nbsp;defined in the policy.</p> 
<p><img class="alignnone wp-image-5033 size-full" title="Screenshot showing that one or more Conditions do not have an applicable action" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/13/JC8-0917-a.jpg" alt="" width="719" height="443" /></p> 
<p>From the warning message (see preceding screenshot), I realize that <span style="font-family: courier">ec2:Region</span> is not a supported condition&nbsp;for any actions&nbsp;in CodeBuild. To correct the policy, I separate the list actions&nbsp;that do not support resource-level permissions into a separate <span style="font-family: courier">Statement</span>&nbsp;element and specify * as the resource. For the remaining CodeBuild actions&nbsp;that support resource-level permissions, I use the ARN to specify the <span style="font-family: courier">us-west-2</span>&nbsp;Region in the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html#arn-syntax-codebuild" target="_blank" rel="noopener noreferrer">project resource type</a>.</p> 
<pre><code class="lang-text"><span style="color: #008000"><strong>CORRECT POLICY</strong> </span>
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;TheseActionsSupportAllResources&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;codebuild:ListBuilds&quot;,
&quot;codebuild:ListProjects&quot;,
&quot;codebuild:ListRepositories&quot;,
&quot;codebuild:ListCuratedEnvironmentImages&quot;,
&quot;codebuild:ListConnectedOAuthAccounts&quot;
],
&quot;Resource&quot;: [&quot;*&quot;] 
}, {
&quot;Sid&quot;: &quot;TheseActionsSupportAResource&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;codebuild:ListBuildsForProject&quot;,
&quot;codebuild:BatchGet*&quot;
],
&quot;Resource&quot;: [&quot;arn:aws:codebuild:us-west-2:<span style="color: #ff0000"><strong>123456789012</strong></span>:project/*&quot;] 
}
]	
}</code></pre> 
<p>After I make the changes, I view the updated policy summary and see that no warnings are displayed.</p> 
<p><img class="alignnone wp-image-4748 size-full" title="Screenshot showing the updated policy summary with no warnings" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/31/JC5-0917-se.png" alt="Screenshot showing the updated policy summary with no warnings" width="940" height="264" /></p> 
<p>When I choose <strong>CodeBuild</strong> from the list of services, I also see that for the actions&nbsp;that support resource-level permissions, the access is limited to the <span style="font-family: courier">us-west-2</span>&nbsp;Region.</p> 
<p><img class="alignnone wp-image-4749 size-full" title="Screenshow showing that for the Actions that support resource-level permissions, the access is limited to the us-west-2 region." src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/31/JC6-0917-se.png" alt="Screenshow showing that for the Actions that support resource-level permissions, the access is limited to the us-west-2 region." width="875" height="585" /></p> 
<h3>Conclusion</h3> 
<p>Policy summaries make it easier to view and understand the permissions and resources&nbsp;in your IAM policies by displaying the permissions granted by the policies. As I’ve demonstrated in this post, you can also use policy summaries to help you identify and correct your IAM policies. To understand the types of warnings that policy summaries support, you can visit <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/troubleshoot_policies.html" target="_blank" rel="noopener noreferrer">Troubleshoot IAM Policies</a>. To view policy summaries in your AWS account, sign in to the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a> and navigate to any policy on the <strong>Policies</strong> page of the IAM console or the <strong>Permissions</strong> tab on a user’s page.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about or suggestions for this solution, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Joy</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/aws-management-console/" rel="tag">AWS Management Console</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-console/" rel="tag">IAM console</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-policies/" rel="tag">IAM policies</a>, <a href="https://aws.amazon.com/blogs/security/tag/json/" rel="tag">JSON</a>, <a href="https://aws.amazon.com/blogs/security/tag/permissions/" rel="tag">Permissions</a>, <a href="https://aws.amazon.com/blogs/security/tag/policy-summaries/" rel="tag">Policy summaries</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4724');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Enable Your Users to Access Office 365 with AWS Microsoft Active Directory Credentials</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Darryn Hendricks</span></span> and 
<span property="author" typeof="Person"><span property="name">Ron Cully</span></span> | on 
<time property="datePublished" datetime="2017-09-14T06:48:01+00:00">14 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-directory-service/" title="View all posts in AWS Directory Service*"><span property="articleSection">AWS Directory Service*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-enable-your-users-to-access-office-365-with-aws-microsoft-active-directory-credentials/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4898" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4898&amp;disqus_title=How+to+Enable+Your+Users+to+Access+Office+365+with+AWS+Microsoft+Active+Directory+Credentials&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-enable-your-users-to-access-office-365-with-aws-microsoft-active-directory-credentials/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4898');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>You can now enable your users to access Microsoft Office 365 with credentials that you manage in <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">AWS Directory Service for Microsoft Active Directory</a>, also known as AWS Microsoft AD. You can accomplish this by deploying <a href="https://www.microsoft.com/en-us/download/details.aspx?id=47594" target="_blank" rel="noopener noreferrer">Microsoft Azure Active Directory (AD) Connect</a> and <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/install-the-ad-fs-role-service" target="_blank" rel="noopener noreferrer">Active Directory Federation Services for Windows Server 2016 (AD FS 2016)</a> with AWS Microsoft AD. AWS Microsoft AD makes it possible and easy for you to build a Windows environment in the AWS Cloud, synchronize your AWS Microsoft AD users into Microsoft Azure AD, and use Office 365, all without needing to create and manage <a href="https://technet.microsoft.com/en-us/library/cc786438(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">AD domain controllers</a>.&nbsp;Now you can also benefit from the broad set of AWS Cloud services for compute, storage, database, and Internet of Things (IoT) while continuing to use Office 365 business productivity apps—all with a single AD domain.</p> 
<p>Office 365 provides different options to support user authentication with identities that come from AD. One common way to do this is to use Azure AD Connect and AD&nbsp;FS together with your AD directory. In this model, you use Azure AD Connect to synchronize user names from AD into Azure AD so that Office 365 can use those identities. To complete this solution, you use AD&nbsp;FS to enable Office 365 to authenticate the identities against your AD directory. Good news: AWS Microsoft AD now supports this model!</p> 
<p>In this blog post, we show how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD so that your employees can access Office 365 by using their AD credentials.<span id="more-4898"></span></p> 
<h3><strong>Prerequisites</strong></h3> 
<p>The instructions in this post assume that you understand how to <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">create Amazon EC2 for Windows Server instances</a>, know how to <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/connecting_to_windows_instance.html" target="_blank" rel="noopener noreferrer">use Remote Desktop Protocol (RDP) to log in to the instances</a>, and already have completed the following tasks:</p> 
<ol> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/create_managed_ad.html" target="_blank" rel="noopener noreferrer">Create an AWS Microsoft AD directory</a>.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server</a> instance to your AWS Microsoft AD domain to use as a management instance (<span style="font-family: courier">Management</span>).</li> 
<li>Install <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/install_ad_tools.html" target="_blank" rel="noopener noreferrer">Active Directory Administration Tools</a> on your <span style="font-family: courier">Management</span> instance.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server 2016</a> instance to the AWS Microsoft AD domain to use as your <span style="font-family: courier">ADFS</span> server. We show you how to install AD&nbsp;FS later.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server</a> instance to the AWS Microsoft AD domain you use as your <span style="font-family: courier">ADSync</span> server. We will show you how to install Azure AD Connect on this instance later.</li> 
<li>Using Active Directory Users and Computers on your <span style="font-family: courier">Management</span> instance, <a href="https://technet.microsoft.com/en-us/library/dd894463(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">create a standard user</a> named <span style="font-family: courier">ADFSSVC</span> in your AWS Microsoft AD directory. AD&nbsp;FS uses this user account later.</li> 
<li><a href="https://support.office.com/en-us/article/How-to-sign-up-for-Office-365-Admin-Help-9b23c065-eef9-4bf7-acf5-127eb46d5e67?ui=en-US&amp;rs=en-US&amp;ad=US" target="_blank" rel="noopener noreferrer">Create an active Office 365 subscription</a>.</li> 
<li>Add and verify your <a href="https://support.office.com/en-ie/article/Add-a-domain-and-users-to-Office-365-6383f56d-3d09-4dcb-9b41-b5f5a5efd611?ui=en-US&amp;rs=en-IE&amp;ad=IE#ID0EAABAAA=_Step_1" target="_blank" rel="noopener noreferrer">domain</a> in Office 365</li> 
</ol> 
<p><strong>Note:</strong> You must use RDP and sign in with the AWS Microsoft AD <span style="font-family: courier">admin</span> account using the password you specified when you created your AWS Microsoft AD directory when performing Steps 3 and 6 in this “Prerequisites” section.</p> 
<p>The following diagram illustrates the environment you must have in place to implement the solution in this blog post (the numbers in the diagram correspond to Steps 1–8 earlier in this section). We build on this configuration to install and configure Azure AD Connect and AD&nbsp;FS with Azure AD and Office 365.</p> 
<p><img class="alignnone wp-image-5005 size-full" title="Diagram illustrating the environment you must have in place to implement the solution in this blog post" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-Diagram1-h.png" alt="Diagram illustrating the environment you must have in place to implement the solution in this blog post" width="816" height="720" /></p> 
<p><strong>Note:</strong> In this blog post, we use separate Microsoft Windows Server instances on which to run AD&nbsp;FS and Azure AD Connect. You can choose to combine these on a single server, as long as you use Windows Server 2016. Though it is technically possible to use an on-premises server as the AD&nbsp;FS and Azure AD host, such a configuration is counter to the idea of a Windows environment completely in the cloud. Also, this requires configuration of firewall ports and AWS security groups, which is beyond the scope of this blog.</p> 
<h3><strong>Configuration background</strong></h3> 
<p>When you create an AWS Microsoft AD directory, AWS exclusively retains the enterprise administrator account of the forest and domain <span style="font-family: courier">administrator</span> account for the root domain to deliver the directory as a managed service. When you set up your directory, AWS creates an organizational unit (OU) in the directory and delegates administrative privileges for the OU to your <span style="font-family: courier">admin</span> account. Within this OU, you administer users, groups, computers, Group Policy objects, other devices, and additional OUs as needed. You perform these actions using standard AD administration tools from a computer that is joined to an AWS Microsoft AD domain. Typically, the administration computer is an EC2 instance that you access using RDP, by logging in with your <span style="font-family: courier">admin</span> account credentials. From your <span style="font-family: courier">admin</span> account, you can also delegate permissions to other users or groups you create within your OU.</p> 
<p>To use Office 365 with AD identities, you use Azure AD Connect to synchronize the AD identities into Azure AD. There are two commonly supported ways to use Azure AD Connect to support Office 365 use. In one model, you synchronize user names only, and you use AD&nbsp;FS to federate authentication from Office 365 to your AD. In the second model, you synchronize user names and passwords from your AD directory to Azure AD, and you do not have to use AD&nbsp;FS. The model supported by AWS Microsoft AD is the first model: synchronize user names only and use AD&nbsp;FS to authenticate from Office 365 to your AWS Microsoft AD. The AD&nbsp;FS model also enables authentication with SaaS applications that support federated authentication (this topic is beyond the scope of this blog post).</p> 
<p><strong>Note:</strong> Azure AD Connect now has a <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication" target="_blank" rel="noopener noreferrer">pass-through model</a> of authentication. Because this was in a preview status at the time of writing this blog post, this authentication model is beyond the scope of this blog post.</p> 
<p>In a default AD&nbsp;FS installation, AD&nbsp;FS uses two containers that require special AD permissions that your AWS Microsoft AD administrative account does not have. To address this, you will create two nested containers in your OU for AD&nbsp;FS to use. When you install AD&nbsp;FS, you tell AD&nbsp;FS where to find the containers through a Windows PowerShell parameter.</p> 
<p>As described previously, we will now show you how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD with Azure AD and Office 365 in five steps, as illustrated in the following diagram.</p> 
<p><img class="alignnone wp-image-5006 size-full" title="Diagram including the five steps in this blog post" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-Diagram2-f.png" alt="Diagram including the five steps in this blog post" width="816" height="764" /></p> 
<ol> 
<li>Add two containers to AWS Microsoft AD for use by AD&nbsp;FS.</li> 
<li>Install AD&nbsp;FS.</li> 
<li>Integrate AD&nbsp;FS with Azure AD.</li> 
<li>Synchronize users from AWS Microsoft AD to Azure AD with Azure AD Connect.</li> 
<li>Sign in to Office 365 by using your Microsoft AD identities.</li> 
</ol> 
<h3><strong>Step 1: Add two containers to AWS Microsoft AD for use by AD&nbsp;FS</strong></h3> 
<p>The following steps show how to create the AD containers required by AD&nbsp;FS in your AWS Microsoft AD directory.</p> 
<p>From the <span style="font-family: courier">Management</span> instance:</p> 
<ol> 
<li>Generate a random global unique identifier (GUID) using the following Windows PowerShell command. 
<pre><code class="lang-text">(New-Guid).Guid</code></pre> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4962 size-full" title="Screenshot of the (New-Guid).Guid Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-sc1-a.png" alt="Screenshot of the (New-Guid).Guid Windows PowerShell command" width="900" height="151" /><br /> Make a note of the GUID output because it will be required later on. In this case, the GUID is <span style="font-family: courier">67734c62-0805-4274-b72b-f7171110cd56.</span></p> 
<ol start="2"> 
<li>Create a container named <span style="font-family: courier">ADFS</span> in your OU. The OU is located in the domain root and it has the same name as the NetBIOS name you specified when you created your AWS Microsoft AD directory. In this example, our OU name is <span style="font-family: courier">AWS</span>, and our domain is <span style="font-family: courier">DC=<strong>awsexample</strong>,DC=<strong>com</strong></span>. You create the container by running the following Windows PowerShell command. You must replace the names that are in bold text with the names from your AWS Microsoft AD directory. 
<pre><code class="lang-text">New-ADObject -Name &quot;<strong>ADFS</strong>&quot; -Type Container -Path “OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>”</code></pre> 
<p><img class="alignnone wp-image-4963 size-full" title="Screenshot of the Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-sc2-a.png" alt="Screenshot of the Windows PowerShell command" width="900" height="131" /></p> 
<li>Create another AD container in your new <span style="font-family: courier">ADFS</span> container, and use the previously generated GUID as the name. Do this by running the following Windows PowerShell command. Be sure to replace the names in bold text with the names from your AWS Microsoft AD directory and your GUID. In this example, we replace <span style="font-family: courier">GUID</span> with <span style="font-family: courier">67734c62-0805-4274-b72b-f7171110cd56</span>. The other bold items shown match the names in our example AWS Microsoft AD directory. 
<pre><code class="lang-text">New-ADObject -Name &quot;<strong>GUID</strong>&quot; -Type Container -Path “CN=<strong>ADFS</strong>,OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>”</code></pre> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4997 size-full" title="Screenshot of the Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P3-GUIDContainer.png" alt="Screenshot of the Windows PowerShell command" width="900" height="149" /><br /> To verify that you successfully created the <span style="font-family: courier">ADFS</span> and <span style="font-family: courier">GUID</span> containers, open Active Directory Users and Computers and navigate to the containers you created. Your root domain, OU name, and GUID name should match your AWS Microsoft AD configuration.<br /> <img class="alignnone wp-image-4998 size-full" title="Screenshot showing the successful creation of the ADFS and GUID containers" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P4-ADUC.png" alt="Screenshot showing the successful creation of the ADFS and GUID containers" width="557" height="210" /></p> 
<p style="padding-left: 30px"><strong>Note:</strong> If you do not see the <span style="font-family: courier">ADFS</span> and <span style="font-family: courier">GUID</span> containers, turn on Advanced Features by choosing <strong>View</strong> in the Active Directory Users and Computers tool, and then choosing <strong>Advanced Features</strong>.</p> 
<h3><strong>Step 2: Install AD&nbsp;FS</strong></h3> 
<p>In this section, we show how to install AD&nbsp;FS by using Windows PowerShell commands. First, though, select a federation service name for your AD&nbsp;FS server. You can create your federation service name by adding a short name (for example, <span style="font-family: courier">sts</span>) followed by your domain name (for example, <span style="font-family: courier">awsexample.com</span>). In this example, we use <span style="font-family: courier">sts.awsexample.com</span> as the federation service name.</p> 
<p>Using your AWS Microsoft AD <span style="font-family: courier">admin</span> account, open an RDP session to your <span style="font-family: courier">ADFS</span> instance, run Windows PowerShell as a local administrator, and complete the following steps:</p> 
<ol> 
<li>Install the Windows feature, AD&nbsp;FS, by running the following Windows PowerShell command. This command only adds the components needed to install your <span style="font-family: courier">ADFS</span> server later. 
<pre><code class="lang-text">Install-WindowsFeature ADFS-Federation</code></pre> 
<li>Now that you have installed AD&nbsp;FS, you must obtain a certificate for use when you configure your <span style="font-family: courier">ADFS</span>&nbsp;server. The AD&nbsp;FS certificate plays an important role to secure communication between the <span style="font-family: courier">ADFS</span> server and clients, and to ensure tokens issued by the <span style="font-family: courier">ADFS</span> server are secured. AWS recommends that you use a certificate from a trusted Certificate Authority (CA).</li> 
</ol> 
<p style="padding-left: 30px">In our example, we use the SSL certificate, <span style="font-family: courier">sts.awsexample.com</span>. It is important to note that the common name and <span style="font-family: courier">subject alternative name</span> (<span style="font-family: courier">SAN</span>) must include the federation service name we plan to use for the AD&nbsp;FS server. In our example, the name is <span style="font-family: courier">sts.awsexample.com</span>.</p> 
<p>Install the certificate on the AD&nbsp;FS server using the <a href="https://technet.microsoft.com/en-us/library/cc754431(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">Microsoft Management Console (MMC) snap-in for certificates</a> by following these steps:</p> 
<ol> 
<li>Open a command prompt window.</li> 
<li>Type <span style="font-family: courier">mmc</span> and press <strong>Enter</strong>.</li> 
<li>Choose <strong>File</strong>, choose <strong>Add/Remove</strong> snap-in, and choose <strong>Add</strong>.</li> 
<li>For <strong>Add Standalone</strong> <strong>Snap-in</strong>, choose <strong>Certificates</strong> and then choose <strong>Add</strong>.</li> 
<li>For the <strong>Certificates</strong> snap-in, choose <strong>Computer account</strong> and then choose <strong>Next</strong>.</li> 
<li>Choose <strong>Finish</strong>, and then choose <strong>OK</strong> to load the <strong>Certificates</strong> snap In.</li> 
<li>Expand <strong>Certificates (Local Computer).</strong></li> 
<li>Right-click <strong>Personal</strong>, choose <strong>All Tasks</strong>, and then choose <strong>Import</strong>.</li> 
<li>On the <strong>Certificate Import Wizard</strong>, choose <strong>Next</strong>.</li> 
<li>Choose <strong>Browse</strong> to locate and select your certificate that has been given by your CA. Choose <strong>Next</strong>.</li> 
<li>Ensure <strong>Certificate store</strong> is set to <strong>Personal</strong>, and choose <strong>Next</strong>.</li> 
<li>Choose <strong>Finish</strong> and <strong>OK</strong> to complete the installation of the certificate on the AD&nbsp;FS server.</li> 
</ol> 
<p>Next you need to retrieve the <span style="font-family: courier">Thumbprint</span> value of the newly installed certificate and save it for use when you configure your <span style="font-family: courier">ADFS</span> server. Follow the remaining steps:</p> 
<ol start="13"> 
<li>In the <strong>Certificates</strong> console window, expand <strong>Personal</strong>, and choose <strong>Certificates</strong>.</li> 
<li>Right-click the certificate, and then choose <strong>Open</strong>.</li> 
<li>Choose the <strong>Details tab</strong> to locate the <strong>Thumbprint</strong></li> 
</ol> 
<p style="padding-left: 30px"><strong><img class="alignnone wp-image-4999 size-full" title="Screenshot of the Thumbprint value" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P5-Thumbprint.png" alt="Screenshot of the Thumbprint value" width="512" height="126" /><br /> Note:</strong> In this case, we will copy our certificate <span style="font-family: courier">Thumbprint</span>, <span style="font-family: courier">d096652327cfa18487723ff61040c85c7f57f701</span>, and save it in Windows Notepad.</p> 
<ol start="16"> 
<li>Open an RDP session to your <span style="font-family: courier">ADFS</span> server by using the <span style="font-family: courier">admin</span> account for your AWS Microsoft AD directory. Install AD&nbsp;FS by running the following Windows PowerShell command. You must replace the bold strings in the command with the GUID you created in Step 1 and the names from your AWS Microsoft AD directory. 
<pre><code class="lang-text">$adminConfig = @{&quot;DKMContainerDn&quot;=&quot;CN=<strong>GUID</strong>,CN=ADFS,OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>&quot;}</code></pre> 
</ol> 
<ol start="17"> 
<li>Enter the AD&nbsp;FS standard user account credentials for the <span style="font-family: courier">ADFSSVC</span> user and save it in the script variable, <span style="font-family: courier">$svcCred</span>, by running the following Windows PowerShell command. 
<pre><code class="lang-text">$svcCred = (get-credential)</code></pre> 
<p><img class="alignnone wp-image-5000 size-full" title="Screenshot of entering the user account credentials for the ADFSSVC user" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P6-ADFSSVC.png" alt="Screenshot of entering the user account credentials for the ADFSSVC user" width="662" height="422" /></p> 
</ol> 
<ol start="18"> 
<li>Type the Microsoft AD administrator credentials of the <span style="font-family: courier">Admin</span> user and save it in the script variable, <span style="font-family: courier">$localAdminCred</span>, by running the following Windows PowerShell command. 
<pre><code class="lang-text">$localAdminCred = (get-credential)</code></pre> 
<p><img class="alignnone wp-image-5001 size-full" title="Screenshot of entering the credentials of the Admin user" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P7-ADMIN.png" alt="Screenshot of entering the credentials of the Admin user" width="667" height="422" /></p> 
</ol> 
<ol start="19"> 
<li>Install the AD&nbsp;FS server by running the following Windows PowerShell command. You must replace the bold items with the <span style="font-family: courier">Thumbprint</span> ID from your certificate, and replace the federation service name with the federation service name you chose earlier. For our example, the federation service name is <span style="font-family: courier">awsexample.com</span> and we copy our certificate <span style="font-family: courier">Thumbprint</span>, <span style="font-family: courier">d096652327cfa18487723ff61040c85c7f57f701</span>, from where we saved it in Windows Notepad.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> Be sure to remove any empty spaces in the certificate <span style="font-family: courier">Thumbprint</span> value.</p> 
<pre style="padding-left: 30px"><code class="lang-text">Install-ADFSFarm -CertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong> -FederationServiceName &quot;<strong>YourFederationServiceName</strong>&quot; -ServiceAccountCredential $svcCred -Credential $localAdminCred -OverwriteConfiguration -AdminConfiguration $adminConfig -SigningCertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong> -DecryptionCertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong></code></pre> 
<ol start="20"> 
<li>Create a DNS A record for use with AD&nbsp;FS. This record resolves the federation service name to the public IP address you assign to your <span style="font-family: courier">ADFS</span> instance. You must create the DNS A record at the DNS hosting provider that hosts your domain. In the following example, <span style="font-family: courier">sts.awsexample.com</span> is the federation service name and <span style="font-family: courier">54.x.x.x</span> is the public IP address of our AD&nbsp;FS instance. 
<ul style="margin-left: 10px"> 
<li><strong>Hostname:</strong><span style="font-family: courier"> awsexample.com</span></li> 
<li><strong>Record Type:</strong> <span style="font-family: courier">A</span></li> 
<li><strong>IP Address:</strong> <span style="font-family: courier">x.x.x</span></li> 
</ul> </li> 
</ol> 
<ol start="21"> 
<li>Enable the AD&nbsp;FS sign-in page by running the following Windows PowerShell command. 
<pre><code class="lang-text">Set-ADFSProperties -EnableIdpInitiatedSignonPage $true</code></pre> 
</ol> 
<ol start="22"> 
<li>To verify that the AD&nbsp;FS sign-in page works, open a browser on the AD&nbsp;FS instance, and sign in on the AD&nbsp;FS sign-in page (https://&lt;<em>my</em> <em>federation service name</em>&gt;/ADFS/ls/IdpInitiatedSignOn.aspx) by using your AWS Microsoft AD <span style="font-family: courier">admin</span>&nbsp;account. In our example, the federation service name (&lt;<em>my federation service name</em>&gt; in the sign-in page URL) is <span style="font-family: courier">sts.awsexample.com</span>.</li> 
</ol> 
<h3><strong>Step 3: Integrate AD&nbsp;FS with Azure AD </strong></h3> 
<p>The following steps show you how to connect AD&nbsp;FS with Office 365 by connecting to Azure AD with Windows PowerShell and federating the custom domain.From the <span style="font-family: courier">ADFS</span> instance, make sure you run Windows PowerShell as a local administrator and complete the following steps:</p> 
<ul> 
<li><a href="https://docs.microsoft.com/en-us/powershell/azure/active-directory/install-msonlinev1?view=azureadps-1.0" target="_blank" rel="noopener noreferrer">Connect to Azure AD using Windows PowerShell</a>.<br /> Federate the custom domain you added and verified in Azure AD by running the following two Windows PowerShell commands. You must update the items in bold text with the names from your AWS Microsoft AD directory. For our example, our AD&nbsp;FS instance’s Fully Qualified Domain Name (FQDN) is <span style="font-family: courier">adfsserver.awsexample.com</span>, and our domain name is <span style="font-family: courier">awsexample.com</span>.<p></p> 
<pre><code class="lang-text">Set-MsolADFSContext –computer <strong>&lt;ADFS instance FQDN&gt;</strong>
Convert-MsolDomainToFederated –domain <strong>&lt;Domain name&gt;</strong></code></pre> 
</ul> 
<h3><strong>Step 4: Synchronize users from AWS Microsoft AD to Azure AD with Azure AD Connect</strong></h3> 
<p>The following steps show you how to install and customize Azure AD Connect to synchronize your AWS Microsoft AD identities to Azure AD for use with Office 365.Open an RDP session to your <span style="font-family: courier">ADSync</span> instance by using your AWS Microsoft AD <span style="font-family: courier">admin</span> user account:</p> 
<ol> 
<li>Download <a href="https://download.microsoft.com/download/B/0/0/B00291D0-5A83-4DE7-86F5-980BC00DE05A/AzureADConnect.msi" target="_blank" rel="noopener noreferrer">Azure AD Connect</a>.</li> 
<li>On the <strong>Welcome</strong> page of the Azure AD Connect Wizard, accept the license terms and privacy notice, and then choose <strong>Continue</strong>.</li> 
<li>On the <strong>Express Settings</strong> page, choose <strong>Customize</strong>.</li> 
<li>On the <strong>Install required components</strong> page, choose <strong>Install</strong>.</li> 
<li>On the <strong>User sign-in page</strong>, choose <strong>Do not configure</strong> and then choose <strong>Next</strong>.</li> 
<li>On the <strong>Connect to Azure AD</strong> page, enter your Office 365 <a href="https://support.office.com/en-ie/article/Assign-admin-roles-eac4d046-1afd-4f1a-85fc-8219c79e1504?ui=en-US&amp;rs=en-IE&amp;ad=IE" target="_blank" rel="noopener noreferrer">global administrator</a> account credentials and then choose <strong>Next</strong>.</li> 
<li>On the <strong>Connect your directories</strong> page, choose <strong>Active Directory</strong> as the <strong>Directory Type</strong>, and then choose your <strong>Microsoft AD Forest</strong> as your <strong>Forest</strong>. Choose <strong>Add Directory</strong>.</li> 
<li>At the prompt, enter your AWS Microsoft AD <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/admin_permissions.html" target="_blank" rel="noopener noreferrer">admin account</a> credentials, and then choose <strong>OK</strong>.</li> 
<li>Now that you have added the AWS Microsoft AD directory, choose <strong>Next</strong>.</li> 
<li>On the Azure AD sign-in configuration page, choose <strong>Next</strong>.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> AWS recommends the <span style="font-family: courier">userPrincipalName</span> (<span style="font-family: courier">UPN</span>) attribute for use by AWS Microsoft AD users when they sign in to Azure AD and Office 365. The <span style="font-family: courier">UPN</span> attribute format combines the user’s login name and the <span style="font-family: courier">UPN</span>-suffix of an AWS Microsoft AD user. The <span style="font-family: courier">UPN</span> suffix is the domain name of your AWS Microsoft AD domain and the same domain name you added and verified with Azure AD.</p> 
<p style="padding-left: 30px">In the following example from the Active Directory Users and Computers tool, the user’s <span style="font-family: courier">UPN</span> is <span style="font-family: courier">awsuser@awsexample.com</span>, which is a combination of the user’s login name, <span style="font-family: courier">awsuser</span>, with the <span style="font-family: courier">UPN</span>-suffix, <span style="font-family: courier">@awsexample.com</span>.<br /> <img class="alignnone wp-image-5002 size-full" title="Screenshot showing the awsuser@awsexample.com UPN" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P8-UPN.png" alt="Screenshot showing the awsuser@awsexample.com UPN" width="518" height="275" /></p> 
<ol start="11"> 
<li>On the <strong>Domain and OU filtering</strong> page, choose <strong>Sync selected domains and OUs</strong>, choose the <strong>Users</strong> OU under your NetBIOS OU, and then choose <strong>Next</strong>.<br /> <img class="alignnone wp-image-4927 size-full" title="Screenshot of syncing the Users OU" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc9.png" alt="Screenshot of syncing the Users OU" width="624" height="441" /></li> 
<li>On the <strong>Uniquely identifying your users</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Filter users and devices</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Optional features</strong> page, choose <strong>Next</strong>.</li> 
<li>On the Ready to configure page, choose <strong>Start the synchronization process when configuration completes</strong>, and then choose <strong>Install</strong>.</li> 
<li>The Azure AD Connect installation has now completed. Choose <strong>Exit</strong>.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note: </strong>By default, the Azure AD Connect sync scheduler runs every 30 minutes to synchronize your AWS Microsoft AD identities to Azure AD. You can tune the scheduler by opening a Windows PowerShell session as an administrator and running the appropriate Windows PowerShell commands. For more information, go to <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnectsync-feature-scheduler" target="_blank" rel="noopener noreferrer">Azure AD Connect Sync Scheduler</a>.</p> 
<p style="padding-left: 30px"><strong>Tip:</strong> Do you need to synchronize a change immediately? You can manually start a sync cycle outside the scheduled sync cycle from the Azure AD Connect sync instance. Open a Windows PowerShell session as an administrator and run the following Windows PowerShell commands.</p> 
<pre style="padding-left: 30px"><code class="lang-text">Import-Module ADSync
Start-ADSyncSyncCycle -PolicyType Delta</code></pre> 
<h3><strong>Step 5: Sign in to Office 365 by using your AWS Microsoft AD identities</strong></h3> 
<p>The following steps show you how to sign in to Office 365 using AD&nbsp;FS as the authentication method with your AWS Microsoft AD user account. In this example, we assign a license to the AWS Microsoft AD user account, <span style="font-family: courier">awsuser@awsexample.com</span>, in the Office 365 admin center. We then sign in to Office 365 by using the AWS Microsoft AD user account <span style="font-family: courier">UPN</span>, <span style="font-family: courier">awsuser@awsexample.com</span>.</p> 
<p>Using a computer on the internet, open a browser and complete the following steps:</p> 
<ol> 
<li>Access the <a href="https://portal.office.com/adminportal/home#/homepage" target="_blank" rel="noopener noreferrer">Office 365 admin center</a> using your <a href="https://support.office.com/en-ie/article/Assign-admin-roles-eac4d046-1afd-4f1a-85fc-8219c79e1504?ui=en-US&amp;rs=en-IE&amp;ad=IE" target="_blank" rel="noopener noreferrer">global administrator</a> account, and <a href="https://support.office.com/en-ie/article/Assign-licenses-to-users-in-Office-365-for-business-997596b5-4173-4627-b915-36abac6786dc" target="_blank" rel="noopener noreferrer">assign a license</a> to a user you created in your AWS Microsoft AD directory.<br /> <img class="alignnone wp-image-4928 size-full" title="Screenshot of assigning a license to a user created in the AWS Microsoft AD directory" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc10.png" alt="Screenshot of assigning a license to a user created in the AWS Microsoft AD directory" width="419" height="211" /></li> 
<li>Sign in with the AWS Microsoft AD user account at <a href="https://portal.office.com" target="_blank" rel="noopener noreferrer">https://portal.office.com</a>.<br /> <img class="alignnone wp-image-4929 size-full" title="Screenshot of signing in with the AWS Microsoft AD user account" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc11.png" alt="Screenshot of signing in with the AWS Microsoft AD user account" width="369" height="229" /><br /> When entering the <span style="font-family: courier">UPN</span> of the AWS Microsoft AD user account, you will be redirected to your <span style="font-family: courier">ADFS</span> server sign-in page to complete user authentication.<br /> <img class="alignnone wp-image-4930 size-full" title="Screenshot of being redirected to the ADFS server sign-in page to complete user authentication" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc12.png" alt="Screenshot of being redirected to the ADFS server sign-in page to complete user authentication" width="353" height="181" /></li> 
<li>On the AD&nbsp;FS sign-in page, enter your <span style="font-family: courier">UPN</span> and the password of the AWS Microsoft AD user account.</li> 
<li>You have successfully signed in to Office 365 using your AWS Microsoft AD user account!<br /> <img class="alignnone wp-image-5003 size-full" title="Screenshot of successfully signing in to Office 365 using an AWS Microsoft AD user account" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P9-O365.png" alt="Screenshot of successfully signing in to Office 365 using an AWS Microsoft AD user account" width="900" height="365" /></li> 
</ol> 
<h3><strong>Summary</strong></h3> 
<p>In this blog post, we showed how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD so that your employees can access Office 365 using their AD credentials. Now that you have Azure AD Connect and AD&nbsp;FS in place, you also might want to explore how to build upon this infrastructure to add sign-in for other Software as a Service (SaaS) applications that are compatible with AD&nbsp;FS. For example, <a href="https://aws.amazon.com/blogs/compute/enabling-identity-federation-with-ad-fs-3-0-and-amazon-appstream-2-0/" target="_blank" rel="noopener noreferrer">this blog post</a> explains how you can provide your users single sign-on access to Amazon AppStream by using AD&nbsp;FS.</p> 
<p>If you have comments or questions, post them on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=180" target="_blank" rel="noopener noreferrer">Directory Service forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Darryn and Ron</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/active-directory-federation-services/" rel="tag">Active Directory Federation Services</a>, <a href="https://aws.amazon.com/blogs/security/tag/ad-fs/" rel="tag">AD FS</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-directory-service/" rel="tag">AWS Directory Service</a>, <a href="https://aws.amazon.com/blogs/security/tag/azure-active-directory/" rel="tag">Azure Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/azure-ad-connect/" rel="tag">Azure AD Connect</a>, <a href="https://aws.amazon.com/blogs/security/tag/microsoft-active-directory/" rel="tag">Microsoft Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/microsoft-ad/" rel="tag">Microsoft AD</a>, <a href="https://aws.amazon.com/blogs/security/tag/office-365/" rel="tag">Office 365</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4898');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b><a href="https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" property="url" rel="bookmark"><span property="name headline">AWS Earns Department of Defense Impact Level 5 Provisional Authorization</span></a></b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Chris Gile</span></span> | on 
<time property="datePublished" datetime="2017-09-12T14:26:55+00:00">12 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/compute/amazon-ec2/" title="View all posts in Amazon EC2*"><span property="articleSection">Amazon EC2*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/amazon-elastic-block-storage-ebs/" title="View all posts in Amazon Elastic Block Storage (EBS)*"><span property="articleSection">Amazon Elastic Block Storage (EBS)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/amazon-simple-storage-services-s3/" title="View all posts in Amazon Simple Storage Services (S3)*"><span property="articleSection">Amazon Simple Storage Services (S3)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-vpc-networking-content-delivery/" title="View all posts in Amazon VPC*"><span property="articleSection">Amazon VPC*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/compliance/" title="View all posts in Compliance"><span property="articleSection">Compliance</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-5008" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=5008&amp;disqus_title=AWS+Earns+Department+of+Defense+Impact+Level+5+Provisional+Authorization&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5008');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone wp-image-5013 size-full" title="AWS GovCloud (US) Region image" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/gov-cloud_email.png" alt="AWS GovCloud (US) Region image" width="600" height="200" /></p> 
<p>The <a href="https://www.disa.mil/" target="_blank" rel="noopener noreferrer">Defense Information Systems Agency</a> (DISA) has granted the <a href="https://aws.amazon.com/govcloud-us/" target="_blank" rel="noopener noreferrer">AWS GovCloud (US) Region</a> an <a href="https://iase.disa.mil/cloud_security/cloudsrg/Pages/ImpactLevels.aspx" target="_blank" rel="noopener noreferrer">Impact Level 5</a> (IL5) <a href="https://iasecontent.disa.mil/cloud/SRG/index.html" target="_blank" rel="noopener noreferrer">Department of Defense (DoD) Cloud Computing Security Requirements Guide</a> (CC SRG) <a href="http://www.disa.mil/newsandevents/2016/dod-cloud-provisional-authorizations" target="_blank" rel="noopener noreferrer">Provisional Authorization</a> (PA) for six core services. This means that AWS’s DoD customers and partners can now deploy workloads for <a href="https://obamawhitehouse.archives.gov/the-press-office/2010/11/04/executive-order-13556-controlled-unclassified-information" target="_blank" rel="noopener noreferrer">Controlled Unclassified Information</a> (CUI) exceeding IL4 and for unclassified National Security Systems (NSS).</p> 
<p>We have supported sensitive Defense community workloads in the cloud for more than four years, and this latest IL5 authorization is complementary to our <a href="https://aws.amazon.com/blogs/publicsector/amazon-web-services-achieves-fedramp-high-authorization/" target="_blank" rel="noopener noreferrer">FedRAMP High Provisional Authorization</a> that covers 18 services in the AWS GovCloud (US) Region. Our customers now have the flexibility to deploy any range of IL 2, 4, or 5 workloads by leveraging AWS’s services, attestations, and certifications. For example, when the US Air Force needed compute scale to support the Next Generation GPS Operational Control System Program, <a href="https://aws.amazon.com/blogs/publicsector/tag/air-force/" target="_blank" rel="noopener noreferrer">they turned to AWS</a>.</p> 
<p>In partnership with a certified Third Party Assessment Organization (3PAO), an independent validation was conducted to assess both our technical and nontechnical security controls to confirm that they meet the DoD’s stringent CC SRG standards for IL5 workloads. Effective immediately, customers can begin leveraging the IL5 authorization for the following six services in the AWS GovCloud (US) Region:</p> 
<ul> 
<li><a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a></li> 
<li><a href="https://aws.amazon.com/ebs/" target="_blank" rel="noopener noreferrer">Amazon EBS</a></li> 
<li><a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS IAM</a></li> 
<li><a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS KMS</a></li> 
<li><a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon VPC</a></li> 
<li><a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a></li> 
</ul> 
<p>AWS has been a long-standing industry partner with DoD, federal-agency customers, and private-sector customers to enhance cloud security and policy. We continue to collaborate on the DoD CC SRG, <a href="https://www.acq.osd.mil/dpap/dars/" target="_blank" rel="noopener noreferrer">Defense Acquisition Regulation Supplement</a> (DFARS) and other government requirements to ensure that policy makers enact policies to support next-generation security capabilities.</p> 
<p>In an effort to reduce the authorization burden of our DoD customers, we’ve worked with DISA to port our assessment results into an easily ingestible format by the <a href="http://www.disa.mil/Cybersecurity/Assessments-and-Inspections/EMASS" target="_blank" rel="noopener noreferrer">Enterprise Mission Assurance Support Service</a> (eMASS) system. Additionally, we undertook a separate effort to empower our industry partners and customers to efficiently solve their compliance, governance, and audit challenges by launching the <a href="https://aws.amazon.com/compliance/customer-center/" target="_blank" rel="noopener noreferrer">AWS Customer Compliance Center</a>, a portal providing a breadth of AWS-specific compliance and regulatory information.</p> 
<p>We look forward to providing sustained cloud security and compliance support at scale for our DoD customers and adding additional services within the IL5 authorization boundary. See <a href="https://aws.amazon.com/compliance/services-in-scope/" target="_blank" rel="noopener noreferrer">AWS Services in Scope by Compliance Program</a> for updates. To request access to AWS’s DoD security and authorization documentation, <a href="http://aws.amazon.com/compliance/contact/" target="_blank" rel="noopener noreferrer">contact AWS Sales and Business Development</a>. For a list of frequently asked questions related to AWS DoD SRG compliance, see&nbsp;the <a href="https://aws.amazon.com/compliance/dod/" target="_blank" rel="noopener noreferrer">AWS DoD SRG page</a>.</p> 
<p>To learn more about the announcement in this post, tune in for the <a href="https://publish.awswebcasts.com/content/connect/c1/7/en/events/event/shared/4183083/event_landing.html?connect-session=graysonbreez88wh47k6rerqbxs3&amp;sco-id=68532001&amp;_charset_=utf-8" target="_blank" rel="noopener noreferrer">AWS Automating DoD SRG Impact Level 5 Compliance in AWS GovCloud (US)</a> webinar on October 11, 2017, at 11:00 A.M. Pacific Time.</p> 
<p>– Chris Gile, Senior Manager, AWS Public Sector Risk &amp; Compliance</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Now Create and Manage AWS IAM Roles More Easily with the Updated IAM Console</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Rob Moncur</span></span> | on 
<time property="datePublished" datetime="2017-09-08T16:26:46+00:00">08 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/identity/" title="View all posts in Identity"><span property="articleSection">Identity</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-create-and-manage-aws-iam-roles-more-easily-with-the-updated-iam-console/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4760" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4760&amp;disqus_title=Now+Create+and+Manage+AWS+IAM+Roles+More+Easily+with+the+Updated+IAM+Console&amp;disqus_url=https://aws.amazon.com/blogs/security/now-create-and-manage-aws-iam-roles-more-easily-with-the-updated-iam-console/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4760');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Today, we updated the&nbsp;<a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a>&nbsp;(IAM) console to make it easier for you to create, manage, and understand IAM roles. We made improvements that include an updated role-creation workflow that better guides you through the process of creating trust relationships (which define who can assume a role) and attaching permissions to roles. Additionally, you can now view and understand the permissions attached to roles more easily by using <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_understand-policy-summary.html?icmpid=docs_iam_console" target="_blank" rel="noopener noreferrer">policy summaries</a> for each role in your account.</p> 
<p>In this post, I provide background information about roles, show how to create roles correctly by using the updated <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a>, and review other changes to the role list and details pages that help you better manage your roles.</p> 
<h3>Background information about IAM roles</h3> 
<h4><strong>What are IAM roles?</strong></h4> 
<p><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" target="_blank" rel="noopener noreferrer">IAM roles</a> are a secure way to grant permissions to entities you trust. You can use a role in the following scenarios:</p> 
<ul> 
<li><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html" target="_blank" rel="noopener noreferrer">Delegating permissions to an AWS service</a> to carry out actions on your behalf (such as <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Monitoring.OS.html" target="_blank" rel="noopener noreferrer">Enhanced Monitoring for Amazon Relational Database Service [RDS]</a>).</li> 
<li>Enabling application code running on an <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a> instance to access or modify AWS resources (such as data stored in an <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> bucket).</li> 
<li>Granting access to users from another AWS account.</li> 
<li>Enabling <a href="https://aws.amazon.com/iam/details/manage-federation/" target="_blank" rel="noopener noreferrer">federated sign-in</a> to the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS Management Console</a> for employees in your corporate directory.</li> 
</ul> 
<h4><strong>What are the different parts of an IAM role?</strong></h4> 
<p>As illustrated in the following diagram, roles have two types of policies attached to them:</p> 
<ul> 
<li><strong>Trust policy</strong> – This policy defines the entities that can assume a role. When you create a role by using the IAM console, the trust policy is created for you. You can customize the trust policy after it has been created. A role can have only one trust policy.</li> 
<li><strong>Permissions policies</strong> – These policies define which AWS resources a role can access and the actions it can perform on those resources. These <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html" target="_blank" rel="noopener noreferrer">policies</a> can be AWS managed policies, customer managed policies, or inline policies attached directly to the role. You can attach multiple permissions policies to an IAM role.</li> 
</ul> 
<p><span id="more-4760"></span></p> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4862 size-full" title="IAM role diagram with trust policy and permissions policy" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/RM1-0917-diagram-b.png" alt="IAM role diagram with trust policy and permissions policy" width="700" height="305" /></p> 
<h3>How do I use an IAM role?</h3> 
<p>Roles can be used to access AWS both programmatically and via the AWS Management Console.</p> 
<h4>Using a role to access AWS programmatically</h4> 
<p>You can <a href="http://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html" target="_blank" rel="noopener noreferrer">assume a role programmatically by using the AWS CLI or SDK</a>. When you assume a role, the role issues <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html" target="_blank" rel="noopener noreferrer">temporary security credentials</a>&nbsp;that you can use to access resources and call AWS service actions. Using roles enables you to follow the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html#use-roles" target="_blank" rel="noopener noreferrer">security best practice</a> to use temporary security credentials instead of long-term security credentials.</p> 
<p>If you are using AWS services such as EC2 or <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a>, you can assign a role to your EC2 instance or Lambda function. Your code running on either the instance or function will then be able to access AWS using the short-term credentials from that role. These services automatically assume the role and use the returned credentials to enable you to access resources or perform actions. Learn more about <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html" target="_blank" rel="noopener noreferrer">IAM roles for EC2</a> and <a href="http://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html" target="_blank" rel="noopener noreferrer">IAM roles for Lambda</a>.</p> 
<h4>Using a role to access the AWS Management Console</h4> 
<p>You can also assume a role to access an account in the AWS Management Console by using <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-console.html" target="_blank" rel="noopener noreferrer">Switch Role</a> functionality. You can access this functionality by using the drop-down menu in the upper right corner of the console or through a <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_enable-console-custom-url.html" target="_blank" rel="noopener noreferrer">custom sign-in URL</a>. To switch roles, you must sign in as either an IAM or federated user. Swith Role is not supported for root users.</p> 
<h3>Introducing the updated role-creation workflow</h3> 
<p>To make it easier to create IAM roles, we’ve updated the role-creation workflow in the IAM console. To introduce the new experience, let’s look at a specific example.</p> 
<p>Let’s suppose I am developing a new application running on an EC2 instance that reads and writes image data to S3. To enable that application to access the S3 bucket where the image data is stored, I need to create a new role that the EC2 instance running my application code can assume. This role trusts EC2 (defined in the trust policy) and has permissions to read and write to S3 (defined in the permissions policy).</p> 
<p>I first navigate to the <strong>Roles</strong> page of the IAM console, and choose <strong>Create role</strong>.</p> 
<p><img class="alignnone wp-image-4843 size-full" title="Screenshot of choosing &quot;Create new role&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/0-create-role-a.png" alt="" width="893" height="459" /></p> 
<p>I then select the type of trusted entity this role will allow. I have four options in this step:</p> 
<ul> 
<li><strong>AWS service</strong> – To grant access to an AWS service to manage resources in my account.</li> 
<li><strong>Another AWS account</strong> – To grant access to my account from another account.</li> 
<li><strong>Web identities</strong> – To grant access to <a href="https://aws.amazon.com/cognito/" target="_blank" rel="noopener noreferrer">Amazon Cognito</a> or other <a href="https://en.wikipedia.org/wiki/OpenID_Connect" target="_blank" rel="noopener noreferrer">OpenID Connect</a>&nbsp;providers.</li> 
<li><strong>SAML</strong> – To grant access to identities from a SAML-enabled identity provider.</li> 
</ul> 
<p>For this example, I choose <strong>AWS service</strong>. I then see a list of AWS services the new role could trust. Because I need a role that can be assumed by an EC2 instance, I choose <strong>EC2</strong>. This opens a section below it with specific use cases for this service. I choose the&nbsp;<strong>EC2 (Allows EC2 instances to call AWS services on your behalf)</strong> use case. This defines the role’s trust policy to include EC2 as an entity that can assume that role.</p> 
<p><img class="alignnone wp-image-4844 size-full" title="Screenshot of choosing the type of trusted entity" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/1-trust.png" alt="" width="925" height="841" /></p> 
<p>Then, I set the permissions that the role needs to access S3. I already created a permissions policy that <a href="https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/" target="_blank" rel="noopener noreferrer">grants access to my S3 bucket</a> and named it <strong>MyImageApp-S3Access. </strong>I choose that policy and choose <strong>Next</strong> to move to the final step.</p> 
<p><img class="alignnone wp-image-4846 size-full" title="Screenshot showing the MyImageApp-S3Access permissions policy" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/2-permissions-a.png" alt="Screenshot showing the MyImageApp-S3Access permissions policy" width="900" height="516" /></p> 
<p>In the final step, I name the role <strong>MyImageAppRole</strong> and describe it this way: “Allows application code running on EC2 instances to access data in S3.” I choose <strong>Create role </strong>and I am done! I can now attach this role to EC2 instances on which my application is running to give them permissions to access data in S3.</p> 
<p><img class="alignnone wp-image-4852 size-full" title="Screenshot of finishing the role creation process" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/3-review-a.png" alt="Screenshot of finishing the role creation process" width="900" height="550" /></p> 
<h3>Other updates to help you manage your roles</h3> 
<p>With this update, you will see a new column called <strong>Trusted entities</strong> on the <strong>Roles</strong> list page. This column allows you to review at a glance which entities can assume a role. This makes it easier to identify roles that trust a specific account or AWS service. It also makes it easier to audit the trust relationships across all your roles. You also can add other columns to this table, including <strong>Creation time</strong>&nbsp;and&nbsp;<strong>Role ARN</strong>,&nbsp;by clicking the gear icon. Your column selection preference will be remembered when you return to the <strong>Roles</strong>&nbsp;page.</p> 
<p><img class="alignnone wp-image-4847 size-full" title="Screenshot of the Roles page with new column, &quot;Trusted entities&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/list-roles.png" alt="Screenshot of the Roles page with new column, &quot;Trusted entities&quot;" width="891" height="554" /></p> 
<p>To help you understand the permissions attached to your role, we’ve also updated the <strong>Permissions</strong> tab to include <a href="https://aws.amazon.com/blogs/security/move-over-json-policy-summaries-make-understanding-iam-policies-easier/" target="_blank" rel="noopener noreferrer">IAM policy summaries</a>. Policy summaries make it easier for you to understand the permissions for IAM permissions policies attached to roles without having to view a policy’s JSON.</p> 
<p><img class="alignnone wp-image-4849 size-full" title="Screenshot of the updated &quot;Permissions&quot; tab" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/role-details-a.png" alt="Screenshot of the updated &quot;Permissions&quot; tab" width="900" height="577" /></p> 
<h3>Conclusion</h3> 
<p>Now it is easier for you to create and manage your IAM roles using the IAM console. As you manage your roles, be sure to review and follow&nbsp;<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener noreferrer">IAM best practices</a>, which can help to improve the security of your AWS resources and make your account easier to manage.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions or suggestions, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Rob</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/iam-console/" rel="tag">IAM console</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-role-creation-workflow/" rel="tag">IAM role-creation workflow</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-roles/" rel="tag">IAM roles</a>, <a href="https://aws.amazon.com/blogs/security/tag/permissions-policies/" rel="tag">permissions policies</a>, <a href="https://aws.amazon.com/blogs/security/tag/trust-policies/" rel="tag">trust policies</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4760');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Configure an LDAPS Endpoint for Simple AD</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Cameron Worrell</span></span> and 
<span property="author" typeof="Person"><span property="name">Jeff Levine</span></span> | on 
<time property="datePublished" datetime="2017-08-29T05:58:12+00:00">29 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/compute/amazon-ec2/" title="View all posts in Amazon EC2*"><span property="articleSection">Amazon EC2*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-route-53/" title="View all posts in Amazon Route 53"><span property="articleSection">Amazon Route 53</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-certificate-manager/" title="View all posts in AWS Certificate Manager*"><span property="articleSection">AWS Certificate Manager*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-directory-service/" title="View all posts in AWS Directory Service*"><span property="articleSection">AWS Directory Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/elastic-load-balancing/" title="View all posts in Elastic Load Balancing"><span property="articleSection">Elastic Load Balancing</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-configure-an-ldaps-endpoint-for-simple-ad/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4647" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4647&amp;disqus_title=How+to+Configure+an+LDAPS+Endpoint+for+Simple+AD&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-configure-an-ldaps-endpoint-for-simple-ad/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4647');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_simple_ad.html" target="_blank" rel="noopener noreferrer">Simple AD</a>, which is powered by <a href="https://en.wikipedia.org/wiki/Samba_(software)" target="_blank" rel="noopener noreferrer">Samba &nbsp;4</a>, supports basic Active Directory (AD) authentication features such as users, groups, and the ability to join domains. Simple AD also includes an integrated <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_blank" rel="noopener noreferrer">Lightweight Directory Access Protocol</a> (LDAP) server. LDAP is a standard application protocol for the access and management of directory information. You can use the <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol#Bind_.28authenticate.29" target="_blank" rel="noopener noreferrer">BIND operation</a> from Simple AD to authenticate LDAP client sessions. This makes LDAP a common choice for centralized authentication and authorization for services such as <a href="https://en.wikipedia.org/wiki/Secure_Shell" target="_blank" rel="noopener noreferrer">Secure Shell</a> (SSH), client-based virtual private networks (VPNs), and many other applications. Authentication, the process of confirming the identity of a <a href="https://en.wikipedia.org/wiki/Principal_(computer_security)" target="_blank" rel="noopener noreferrer">principal</a>, typically involves the transmission of highly sensitive information such as user names and passwords. To protect this information in transit over untrusted networks, companies often require encryption as part of their information security strategy.</p> 
<p>In this blog post, we show you how to configure an LDAPS (LDAP over SSL/TLS) encrypted endpoint for Simple AD so that you can extend Simple AD over untrusted networks. Our solution uses <a href="https://aws.amazon.com/elasticloadbalancing/" target="_blank" rel="noopener noreferrer">Elastic Load Balancing</a> (ELB) to send decrypted LDAP traffic to <a href="http://www.haproxy.org/" target="_blank" rel="noopener noreferrer">HAProxy</a> running on <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a>, which then sends the traffic to Simple AD. ELB offers integrated certificate management, SSL/TLS termination, and the ability to use a scalable EC2 backend to process decrypted traffic. ELB also tightly integrates with <a href="https://aws.amazon.com/route53/" target="_blank" rel="noopener noreferrer">Amazon Route 53</a>, enabling you to use a custom domain for the LDAPS endpoint. The solution needs the intermediate HAProxy layer because ELB can direct traffic only to EC2 instances. To simplify testing and deployment, we have provided an&nbsp;<a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template/raw/master/cloudformation/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">AWS CloudFormation template</a> to provision the ELB and HAProxy layers.</p> 
<p>This post assumes that you have an understanding of concepts such as <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html" target="_blank" rel="noopener noreferrer">Amazon Virtual Private Cloud (VPC)</a> and its components, including subnets, routing, Internet and network address translation (NAT) gateways, DNS, and security groups. You should also be familiar with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">launching EC2 instances and logging in to them with SSH</a>. If needed, you should familiarize yourself with these concepts and review the solution overview and prerequisites in the next section before proceeding with the deployment.</p> 
<p><strong>Note:&nbsp;</strong>This solution is intended for use by clients requiring an LDAPS endpoint only. If your requirements extend beyond this, you should consider accessing the Simple AD servers directly or by using <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_microsoft_ad.html" target="_blank" rel="noopener noreferrer">AWS Directory Service for Microsoft AD</a>.</p> 
<h3>Solution overview</h3> 
<p>The following diagram and description illustrates and explains the Simple AD LDAPS environment. The <a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template/raw/master/cloudformation/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">CloudFormation template</a> creates the items designated by the bracket (internal ELB load balancer and two HAProxy nodes configured in an Auto Scaling group).<span id="more-4647"></span></p> 
<p><img class="alignnone wp-image-4662 size-full" title="Diagram of the the Simple AD LDAPS environment" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/Screen-Shot-2017-07-25-at-10.30.54-AM.png" alt="Diagram of the the Simple AD LDAPS environment" width="692" height="895" /></p> 
<p>Here is how the solution works, as shown in the preceding numbered diagram:</p> 
<ol> 
<li>The LDAP client sends an LDAPS request to ELB on TCP port 636.</li> 
<li>ELB terminates the SSL/TLS session and decrypts the traffic using a certificate. ELB sends the decrypted LDAP traffic to the EC2 instances running HAProxy on TCP port 389.</li> 
<li>The HAProxy servers forward the LDAP request to the Simple AD servers listening on TCP port 389 in a fixed Auto Scaling group configuration.</li> 
<li>The Simple AD servers send an LDAP response through the HAProxy layer to ELB. ELB encrypts the response and sends it to the client.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> Amazon VPC prevents a third party from intercepting traffic within the VPC. Because of this, the VPC protects the decrypted traffic between ELB and HAProxy and between HAProxy and Simple AD. The ELB encryption provides an additional layer of security for client connections and protects traffic coming from hosts outside the VPC.</p> 
<h3>Prerequisites</h3> 
<ol> 
<li>Our approach requires an Amazon VPC with two public and two private subnets. The previous diagram illustrates the environment’s VPC requirements. If you do not yet have these components in place, follow these guidelines for setting up a sample environment: 
<ol type="a"> 
<li>Identify a region that supports <a href="https://aws.amazon.com/directoryservice/other-directories-pricing/" target="_blank" rel="noopener noreferrer">Simple AD</a>, <a href="https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/pricing/" target="_blank" rel="noopener noreferrer">ELB</a>, and <a href="https://aws.amazon.com/about-aws/whats-new/2015/12/introducing-amazon-vpc-nat-gateway-a-managed-nat-service/" target="_blank" rel="noopener noreferrer">NAT gateways</a>. The NAT gateways are used with an Internet gateway to allow the HAProxy instances to access the internet to perform their required configuration. You also need to identify the two <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html">Availability Zones</a> in that region for use by Simple AD. You will supply these Availability Zones as parameters to the CloudFormation template later in this process.</li> 
<li>Create or choose an <a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon VPC</a> in the region you chose. In order to use Route 53 to resolve the LDAPS endpoint, <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html#vpc-dns-support" target="_blank" rel="noopener noreferrer">make sure you enable DNS support</a> within your VPC. Create an <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html" target="_blank" rel="noopener noreferrer">Internet gateway</a> and attach it to the VPC, which will be used by the NAT gateways to access the internet.</li> 
<li><a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Route_Tables.html#CustomRouteTable" target="_blank" rel="noopener noreferrer">Create a route table</a> with a default route to the Internet gateway. Create two <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html#nat-gateway-creating" target="_blank" rel="noopener noreferrer">NAT gateways</a>, one per Availability Zone in your public subnets to provide additional resiliency across the Availability Zones. Together, the routing table, the NAT gateways, and the Internet gateway enable the HAProxy instances to access the internet.</li> 
<li>Create two private routing tables, one per Availability Zone. Create two private subnets, one per Availability Zone. The dual routing tables and subnets allow for a higher level of redundancy. Add each subnet to the routing table in the same Availability Zone. Add a default route in each routing table to the NAT gateway in the same Availability Zone. The Simple AD servers use subnets that you create.</li> 
<li>The LDAP service requires a DNS domain that resolves within your VPC and from your LDAP clients. If you do not have an existing DNS domain, follow the steps to <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html" target="_blank" rel="noopener noreferrer">create a private hosted zone</a> and <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-associate-vpcs.html" target="_blank" rel="noopener noreferrer">associate it with your VPC</a>. To avoid encryption protocol errors, you must ensure that the DNS domain name is consistent across your Route 53 zone and in the SSL/TLS certificate (see Step 2 in the “Solution deployment” section).</li> 
</ol> </li> 
<li>Make sure you have completed the&nbsp;<a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/prereq_simple.html" target="_blank" rel="noopener noreferrer">Simple AD Prerequisites</a>.</li> 
<li>We will use a self-signed certificate for ELB to perform SSL/TLS decryption. You can use a certificate issued by your preferred certificate authority or a certificate issued by <a href="https://aws.amazon.com/acm/" target="_blank" rel="noopener noreferrer">AWS Certificate Manager</a> (ACM).<br /> <strong>Note:</strong> To prevent unauthorized connections directly to your Simple AD servers, you can modify the Simple AD security group on port 389 to block traffic from locations outside of the Simple AD VPC. You can find the security group in the <a href="https://console.aws.amazon.com/ec2/v2/home" target="_blank" rel="noopener noreferrer">EC2 console</a> by creating a search filter for your Simple AD directory ID. It is also important to allow the Simple AD servers to communicate with each other as shown on <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/prereq_simple.html" target="_blank" rel="noopener noreferrer">Simple AD Prerequisites</a>.</li> 
</ol> 
<h3>Solution deployment</h3> 
<p>This solution includes five main parts:</p> 
<ol> 
<li>Create a Simple AD directory.</li> 
<li>Create a certificate.</li> 
<li>Create the ELB and HAProxy layers by using the supplied CloudFormation template.</li> 
<li>Create a Route 53 record.</li> 
<li>Test LDAPS access using an Amazon Linux client.</li> 
</ol> 
<h3>1. Create a Simple AD directory</h3> 
<p>With the prerequisites completed, you will create a Simple AD directory in your private VPC subnets:</p> 
<ol type="a"> 
<li>In the&nbsp;<a href="https://console.aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">Directory Service console</a> navigation pane, choose&nbsp;<strong>Directories</strong>&nbsp;and then choose&nbsp;<strong>Set up directory</strong>.</li> 
<li>Choose&nbsp;<strong><strong>Simple AD.<br /> <img class="alignnone wp-image-4679 size-full" title="Screenshot of choosing &quot;Simple AD&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL1-a.png" alt="Screenshot of choosing &quot;Simple AD&quot;" width="600" height="559" /><br /> </strong></strong></li> 
<li>Provide the following information: 
<ul> 
<li><strong>Directory DNS</strong> – The <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name" target="_blank" rel="noopener noreferrer">fully qualified domain name</a> (FQDN) of the directory, such as&nbsp;<span style="font-family: courier">corp.example.com</span>. You will use the FQDN as part of the testing procedure.</li> 
<li><strong>NetBIOS name</strong> – The short name for the directory, such as&nbsp;<span style="font-family: courier">CORP</span>.</li> 
<li><strong>Administrator password</strong> – The password for the directory administrator. The directory creation process creates an administrator account with the user name&nbsp;<span style="font-family: courier">Administrator </span>and this password. Do not lose this password because it is nonrecoverable. You also need this password for testing LDAPS access in a later step.</li> 
<li><strong>Description</strong> – An optional description for the directory.</li> 
<li><strong>Directory Size</strong> – The size of the directory.<br /> <img class="alignnone wp-image-4680 size-full" title="Screenshot of the directory details to provide" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL2-a.png" alt="Screenshot of the directory details to provide" width="800" height="367" /></li> 
</ul> </li> 
<li>Provide the following information in the&nbsp;<strong>VPC Details&nbsp;</strong>section, and then choose&nbsp;<strong>Next Step</strong>: 
<ul> 
<li><strong>VPC</strong> – Specify the VPC in which to install the directory.</li> 
<li><strong>Subnets</strong> – Choose two private subnets for the directory servers. The two subnets must be in different Availability Zones. Make a note of the VPC and subnet IDs for use as CloudFormation input parameters. In the following example, the Availability Zones are <span style="font-family: courier">us-east-1a</span> and <span style="font-family: courier">us-east-1c</span>.<br /> <img class="alignnone wp-image-4682 size-full" title="Screenshot of the VPC details to provide" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL3-a.png" alt="Screenshot of the VPC details to provide" width="800" height="241" /></li> 
</ul> </li> 
<li>Review the directory information and make any necessary changes. When the information is correct, choose&nbsp;<strong>Create Simple AD</strong>.</li> 
</ol> 
<p style="padding-left: 30px">It takes several minutes to create the directory. From the <a href="https://console.aws.amazon.com/directoryservice/home" target="_blank" rel="noopener noreferrer">AWS Directory Service console</a>&nbsp;, refresh the screen periodically and wait until the directory <strong>Status</strong>&nbsp;value changes to&nbsp;<span style="font-family: courier">Active</span> before continuing. Choose your Simple AD directory and note the two IP addresses in the <strong>DNS address</strong> section. You will enter them when you run the CloudFormation template later.</p> 
<p style="padding-left: 30px"><strong>Note:</strong> Full administration of your Simple AD implementation is out of scope for this blog post. See the documentation to add <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/creating_ad_users_and_groups.html" target="_blank" rel="noopener noreferrer">users, groups</a>, or <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">instances</a> to your directory. Also see the previous blog post, <a href="https://aws.amazon.com/blogs/security/how-to-manage-identities-in-simple-ad-directories/" target="_blank" rel="noopener noreferrer">How to Manage Identities in Simple AD Directories</a>.</p> 
<h3>2. Create a certificate</h3> 
<p>In the previous step, you created the Simple AD directory. Next, you will generate a self-signed SSL/TLS certificate using <a href="https://en.wikipedia.org/wiki/OpenSSL" target="_blank" rel="noopener noreferrer">OpenSSL</a>. You will use the certificate with ELB to secure the LDAPS endpoint. OpenSSL is a standard, open source library that supports a wide range of cryptographic functions, including the creation and signing of x509 certificates. You then import the certificate into ACM that is integrated with ELB.</p> 
<ol type="a"> 
<li>You must have a system with OpenSSL installed to complete this step. If you do not have OpenSSL, you can install it on Amazon Linux by running the command, <span style="font-family: courier">sudo yum install openssl</span>. If you do not have access to an Amazon Linux instance you can <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">create one</a> with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html" target="_blank" rel="noopener noreferrer">SSH access enabled</a> to proceed with this step. Run the command,&nbsp;<span style="font-family: courier">openssl version</span>, at the command line to see if you already have OpenSSL installed. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 ~]$ openssl version
OpenSSL 1.0.1k-fips 8 Jan 2015</code></pre> 
<li>Create a private key using the command, <span style="font-family: courier">openssl genrsa command</span>. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl genrsa 2048 &gt; privatekey.pem
Generating RSA private key, 2048 bit long modulus
......................................................................................................................................................................+++
..........................+++
e is 65537 (0x10001)</code></pre> 
<li>Generate a certificate signing request (CSR) using the <span style="font-family: courier">openssl req</span> command. Provide the requested information for each field. The <strong>Common Name</strong> is the FQDN for your LDAPS endpoint (for example, <span style="font-family: courier">ldap.corp.example.com</span>). The <strong>Common Name</strong> must use the domain name you will later register in Route 53. You will encounter certificate errors if the names do not match. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl req -new -key privatekey.pem -out server.csr
You are about to be asked to enter information that will be incorporated into your certificate request.</code></pre> 
<li>Use the&nbsp;<span style="font-family: courier">openssl x509</span> command to sign the certificate. The following example uses the private key from the previous step (<span style="font-family: courier">privatekey.pem</span>) and the signing request (<span style="font-family: courier">server.csr</span>) to create a public certificate named&nbsp;<span style="font-family: courier">server.crt</span>&nbsp;that is valid for&nbsp;365&nbsp;days. This certificate must be updated within 365 days to avoid disruption of LDAPS functionality. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl x509 -req -sha256 -days 365 -in server.csr -signkey privatekey.pem -out server.crt
Signature ok
subject=/C=XX/L=Default City/O=Default Company Ltd/CN=ldap.corp.example.com
Getting Private key</code></pre> 
<li>You should see three files: <span style="font-family: courier">privatekey.pem</span>, <span style="font-family: courier">server.crt</span>, and <span style="font-family: courier">server.csr</span>. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ ls
privatekey.pem server.crt server.csr</code></pre> 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ chmod 600 privatekey.pem</code></pre> 
<li>In the <a href="https://console.aws.amazon.com/acm/home" target="_blank" rel="noopener noreferrer">ACM console</a>, choose <strong>Import a certificate</strong>.</li> 
<li>Using your favorite Linux text editor, paste the contents of your <span style="font-family: courier">server.crt</span> file in the <strong>Certificate body</strong> box.</li> 
<li>Using your favorite Linux text editor, paste the contents of your <span style="font-family: courier">privatekey.pem</span> file in the <strong>Certificate private key</strong> box. For a self-signed certificate, you can leave the <strong>Certificate chain</strong> box blank.</li> 
<li>Choose <strong>Review and import</strong>. Confirm the information and choose <strong>Import</strong>.</li> 
</ol> 
<h3>3. Create the ELB and HAProxy layers by using the supplied CloudFormation template</h3> 
<p>Now that you have created your Simple AD directory and SSL/TLS certificate, you are ready to use the CloudFormation template to create the ELB and HAProxy layers.</p> 
<ol type="a"> 
<li><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=ldaps-haproxy&amp;templateURL=https://s3.amazonaws.com/awsiammedia/public/sample/LDAPSEndpointSimpleAD/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">Load the supplied CloudFormation template</a> to deploy an internal ELB and two HAProxy EC2 instances into a fixed Auto Scaling group. After you load the template, provide the following input parameters. <strong>Note:</strong> You can find the parameters relating to your Simple AD from the directory details page by choosing your Simple AD in the <a href="https://console.aws.amazon.com/directoryservice/home" target="_blank" rel="noopener noreferrer">Directory Service console</a>.</li> 
</ol> 
<table style="margin-left: 45px" border="1" width="0"> 
<tbody> 
<tr> 
<td style="padding-left: 10px" width="233"><strong>Input parameter</strong></td> 
<td style="padding-left: 10px" width="301"><strong>Input parameter description</strong></td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">HAProxyInstanceSize</span></td> 
<td style="padding-left: 10px" width="301">The EC2 instance size for HAProxy servers. The default size is t2.micro and can scale up for large Simple AD environments.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">MyKeyPair</span></td> 
<td style="padding-left: 10px" width="301">The SSH key pair for EC2 instances. If you do not have an existing key pair, <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" target="_blank" rel="noopener noreferrer">you must create one</a>.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">VPCId</span></td> 
<td style="padding-left: 10px" width="301">The target VPC for this solution. Must be in the VPC where you deployed Simple AD and is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SubnetId1</span></td> 
<td style="padding-left: 10px" width="301">The Simple AD primary subnet. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SubnetId2</span></td> 
<td style="padding-left: 10px" width="301">The Simple AD secondary subnet. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">MyTrustedNetwork</span></td> 
<td style="padding-left: 10px" width="301">Trusted network Classless Inter-Domain Routing (CIDR) to allow connections to the LDAPS endpoint. For example, use the VPC CIDR to allow clients in the VPC to connect.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SimpleADPriIP</span></td> 
<td style="padding-left: 10px" width="301">The primary Simple AD Server IP. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SimpleADSecIP</span></td> 
<td style="padding-left: 10px" width="301">The secondary Simple AD Server IP. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">LDAPSCertificateARN</span></td> 
<td style="padding-left: 10px" width="301">The Amazon Resource Name (ARN) for the SSL certificate. This information is available in the <a href="https://console.aws.amazon.com/acm/home">ACM console</a>.</td> 
</tr> 
</tbody> 
</table> 
<ol start="2" type="a"> 
<li>Enter the input parameters and choose <strong>Next</strong>.</li> 
<li>On the <strong>Options</strong> page, accept the defaults and choose <strong>Next</strong>.</li> 
<li>On the <strong>Review</strong> page, confirm the details and choose <strong>Create</strong>. The stack will be created in approximately 5 minutes.</li> 
</ol> 
<h3>4. Create a Route 53 record</h3> 
<p>The next step is to create a Route 53 record in your private hosted zone so that clients can resolve your LDAPS endpoint.</p> 
<ol start="1" type="a"> 
<li>If you do not have an existing DNS domain for use with LDAP, <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html" target="_blank" rel="noopener noreferrer">create a private hosted zone</a> and <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-associate-vpcs.html" target="_blank" rel="noopener noreferrer">associate it with your VPC</a>. The hosted zone name should be consistent with your Simple AD (for example, <span style="font-family: courier">corp.example.com</span>).</li> 
<li>When the CloudFormation stack is in <span style="font-family: courier">CREATE_COMPLETE</span> status, locate the value of the <span style="font-family: courier">LDAPSURL</span> on the <strong>Outputs</strong> tab of the stack. Copy this value for use in the next step.</li> 
<li>On the <a href="https://console.aws.amazon.com/route53/home" target="_blank" rel="noopener noreferrer">Route 53 console</a>, choose&nbsp;<strong>Hosted Zones</strong>&nbsp;and then choose the zone you used for the <strong>Common Name</strong> box for your self-signed certificate. Choose <strong>Create Record Set</strong> and enter the following information: 
<ol> 
<li><strong>Name</strong> – The label of the record (such as <span style="font-family: courier">ldap</span>).</li> 
<li><strong>Type</strong> – Leave as <strong>A – IPv4 address</strong>.</li> 
<li><strong>Alias</strong> – Choose <strong>Yes</strong>.</li> 
<li><strong>Alias Target</strong> – Paste the value of the <span style="font-family: courier">LDAPSURL</span> on the <strong>Outputs</strong> tab of the stack.</li> 
</ol> </li> 
<li>Leave the defaults for <strong>Routing Policy</strong> and <strong>Evaluate Target Health</strong>, and choose <strong>Create</strong>.<br /> <img class="alignnone wp-image-4685 size-full" title="Screenshot of finishing the creation of the Route 53 record" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL4-c.png" alt="Screenshot of finishing the creation of the Route 53 record" width="900" height="539" /></li> 
</ol> 
<h3>5. Test LDAPS access using an Amazon Linux client</h3> 
<p>At this point, you have configured your LDAPS endpoint and now you can test it from an Amazon Linux client.</p> 
<ol start="1" type="a"> 
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">Create an Amazon Linux instance</a> with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html" target="_blank" rel="noopener noreferrer">SSH access enabled</a> to test the solution. Launch the instance into one of the public subnets in your VPC. Make sure the IP assigned to the instance is in the trusted IP range you specified in the CloudFormation parameter <span style="font-family: courier">MyTrustedNetwork</span> in Step 3.b.</li> 
<li>SSH into the instance and complete the following steps to verify access. 
<ol> 
<li>Install the <span style="font-family: courier">openldap-clients</span> package and any required dependencies:<br /> <span style="font-family: courier">sudo yum install -y openldap-clients</span>.</li> 
<li>Add the <span style="font-family: courier">server.crt</span> file to the <span style="font-family: courier">/etc/openldap/certs/</span> directory so that the LDAPS client will trust your SSL/TLS certificate. You can copy the file using Secure Copy (SCP) or create it using a text editor.</li> 
<li>Edit the <span style="font-family: courier">/etc/openldap/ldap.conf</span> file and define the environment variables <span style="font-family: courier">BASE</span>, <span style="font-family: courier">URI</span>, and <span style="font-family: courier">TLS_CACERT</span>. 
<ul> 
<li>The value for <span style="font-family: courier">BASE</span> should match the configuration of the Simple AD directory name.</li> 
<li>The value for <span style="font-family: courier">URI</span> should match your DNS alias.</li> 
<li>The value for <span style="font-family: courier">TLS_CACERT</span> is the path to your public certificate.</li> 
</ul> </li> 
</ol> </li> 
</ol> 
<p style="padding-left: 90px">Here is an example of the contents of the file.</p> 
<pre><code class="lang-text">BASE dc=corp,dc=example,dc=com
URI ldaps://ldap.corp.example.com
TLS_CACERT /etc/openldap/certs/server.crt</code></pre> 
<p>To test the solution, query the directory through the LDAPS endpoint, as shown in the following command. Replace <span style="font-family: courier">corp.example.com</span> with your domain name and use the&nbsp;<span style="font-family: courier">Administrator</span> password that you configured with the Simple AD directory</p> 
<pre><code class="lang-text">$ ldapsearch -D &quot;Administrator@<strong>corp.example.com</strong>&quot; -W sAMAccountName=<strong>Administrator</strong></code></pre> 
<p>You should see a response similar to the following response, which provides the directory information in <a href="https://en.wikipedia.org/wiki/LDAP_Data_Interchange_Format" target="_blank" rel="noopener noreferrer">LDAP Data Interchange Format (LDIF)</a> for the administrator distinguished name (DN) from your Simple AD LDAP server.</p> 
<pre><code class="lang-text"># extended LDIF
#
# LDAPv3
# base &lt;dc=corp,dc=example,dc=com&gt; (default) with scope subtree
# filter: sAMAccountName=Administrator
# requesting: ALL
#
# Administrator, Users, corp.example.com
dn: CN=Administrator,CN=Users,DC=corp,DC=example,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
description: Built-in account for administering the computer/domain
instanceType: 4
whenCreated: 20170721123204.0Z
uSNCreated: 3223
name: Administrator
objectGUID:: l3h0HIiKO0a/ShL4yVK/vw==
userAccountControl: 512
…</code></pre> 
<p>You can now use the LDAPS endpoint for directory operations and authentication within your environment. If you would like to learn more about how to interact with your LDAPS endpoint within a Linux environment, here are a few resources to get started:</p> 
<ul> 
<li><a href="https://www.centos.org/docs/5/html/CDS/ag/8.0/Finding_Directory_Entries-Using_ldapsearch.html" target="_blank" rel="noopener noreferrer">Using ldapsearch to locate and retrieve directory entries</a></li> 
<li><a href="https://www.centos.org/docs/5/html/CDS/cli/8.0/Configuration_Command_File_Reference-Command_Line_Utilities-ldapmodify.html" target="_blank" rel="noopener noreferrer">Using ldapmodify to make changes to directory entries</a></li> 
<li><a href="https://en.wikipedia.org/wiki/System_Security_Services_Daemon" target="_blank" rel="noopener noreferrer">Managing access with the System Security Services Daemon (SSSD)</a> – SSSD can be used within a Linux environment to authenticate LDAP sessions.</li> 
</ul> 
<h3>Troubleshooting</h3> 
<p>If you receive an error such as the following error when issuing the <span style="font-family: courier">ldapsearch</span> command, there are a few things you can do to help identify issues.</p> 
<pre><code class="lang-text">ldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)</code></pre> 
<ul> 
<li>You might be able to obtain additional error details by adding the <span style="font-family: courier">-d1</span> debug flag to the <span style="font-family: courier">ldapsearch</span> command in the previous section. 
<pre><code class="lang-text">$ ldapsearch -D &quot;Administrator@corp.example.com&quot; -W sAMAccountName=Administrator –d1</code></pre> 
<li>Verify that the parameters in <span style="font-family: courier">ldap.conf</span> match your configured LDAPS <span style="font-family: courier">URI</span> endpoint and that all parameters can be resolved by DNS. You can use the following <span style="font-family: courier">dig</span> command, substituting your configured endpoint DNS name. 
<pre><code class="lang-text">$ dig ldap.corp.example.com</code></pre> 
<li>Confirm that the client instance from which you are connecting is in the CIDR range of the CloudFormation parameter, <span style="font-family: courier">MyTrustedNetwork</span>.</li> 
<li>Confirm that the path to your public SSL/TLS certificate configured in <span style="font-family: courier">ldap.conf</span> as <span style="font-family: courier">TLS_CAERT</span> is correct. You configured this in Step 5.b.3. You can check your SSL/TLS connection with the command, substituting your configured endpoint DNS name for the string after <span style="font-family: courier">–connect</span>. 
<pre><code class="lang-text">$ echo -n | openssl s_client -connect ldap.corp.example.com:636</code></pre> 
<li>Verify that your HAProxy instances have the status <strong>InService</strong> in the EC2 console: Choose&nbsp;<strong>Load Balancers</strong> under <strong>Load Balancing</strong> in the navigation pane, highlight your LDAPS load balancer, and then choose the <strong>Instances</strong></li> 
</ul> 
<h3>Conclusion</h3> 
<p>You can use ELB and HAProxy to provide an LDAPS endpoint for Simple AD and transport sensitive authentication information over untrusted networks. You can explore using LDAPS to authenticate SSH users or integrate with other software solutions that support LDAP authentication. This solution’s CloudFormation template is <a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template" target="_blank" rel="noopener noreferrer">available on GitHub</a>.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about or issues implementing this solution, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=180" target="_blank" rel="noopener noreferrer">Directory Service forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Cameron and Jeff</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/encryption/" rel="tag">Encryption</a>, <a href="https://aws.amazon.com/blogs/security/tag/haproxy/" rel="tag">HAProxy</a>, <a href="https://aws.amazon.com/blogs/security/tag/ldaps/" rel="tag">LDAPS</a>, <a href="https://aws.amazon.com/blogs/security/tag/simple-ad/" rel="tag">Simple AD</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4647');
});
</script> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
