<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/mgmtblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Management Tools Blogs Blogs @ AWS" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Management Tools Blogs Blogs @ AWS</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li class="active"><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="mgmtblogs1.html">Page 1</a>|<a href="mgmtblogs2.html">Page 2</a>|<a href="mgmtblogs3.html">Page 3</a>|<a href="mgmtblogs4.html">Page 4</a</p>
<br>
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/DSC2_statemanager-888x630.png" /> 
<b class="b post-title" property="name headline">Combating Configuration Drift Using Amazon EC2 Systems Manager and Windows PowerShell DSC</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Shaun Breen</span></span> | on 
<time property="datePublished" datetime="2017-07-26T10:12:43+00:00">26 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/combating-configuration-drift-using-amazon-ec2-systems-manager-and-windows-powershell-dsc/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Configuration drift occurs when a system “drifts” or changes from its intended configuration. It is caused by having inconsistent configuration items (CIs) across environments.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a> is a management service that helps you automatically collect a software inventory, apply OS patches, create system images, and configure Windows and Linux operating systems. These capabilities help you define and track system configurations, prevent drift, and maintain software compliance of your EC2 and on-premises configurations.</p> 
<p>Systems Manager provides a management approach that is designed for the scale and agility of the cloud but extends into your on-premises data center. Systems Manager makes it easier for you to seamlessly bridge your existing infrastructure with AWS.</p> 
<p>In my last <a href="https://aws.amazon.com/blogs/mt/using-microsoft-powershell-dsc-with-amazon-ec2-systems-manager/">post</a>, I introduced the concept of using Systems Manager <a href="https://aws.amazon.com/ec2/systems-manager/run-command/">Run Command</a> to apply a declarative based model for EC2 instance configuration (configuration as code) via Windows PowerShell Desired State Configuration (DSC). In this post, I show how you can combat configuration drift at scale using PowerShell DSC and a management tool from Systems Manager called <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">State Manager</a>.</p> 
<p><span id="more-886"></span></p> 
<b>Configuration drift</b> 
<p>Configuration drift can happen for a multitude of reasons and can occur in many types of environments such as database systems, network configurations, directory services, web servers, and custom APIs. Some possible reasons that drift can occur include system updates, code pushes, hardware upgrades, or software updates that get applied to some, but not all of your intended systems. I am sure that you have seen this firsthand. &nbsp;We have all heard “but it worked in my dev environment.”</p> 
<p>Configuration drift can cause problems that can result in unintended system behaviors, system failures, disaster recovery issues, and many other potential problems. Fortunately, there are tools and technologies that help mitigate drift.</p> 
<ul> 
<li><strong>Configuration as code</strong></li> 
</ul> 
<p style="padding-left: 30px">Declaratively define a desired state within a configuration file that can be applied to a system to interpret and apply.</p> 
<ul> 
<li><strong>State Manager</strong></li> 
</ul> 
<p style="padding-left: 30px">An EC2 tool that helps you apply a configuration to a set of on-premises servers and EC2 instances on a scheduled basis.</p> 
<ul> 
<li><strong>Configuration management databases (CMDB)</strong></li> 
</ul> 
<p style="padding-left: 30px">CMDBs help track the state of IT assets (also known as configuration items), allowing IT administrators the ability to check on the current state of CIs at any time. A common issue with CMDBs is stale data, meaning that the current state is not always up-to-date. The inability to reliably detect drift is problematic as mitigation is not performed. While CMDBs are popular, I do not use them as a solution in this post.</p> 
<b>Configuration as code via PowerShell DSC</b> 
<p>Before I dive into a solution to help with the ongoing struggles of configuration drift, here are the benefits of using configuration as code via PowerShell DSC:</p> 
<ul> 
<li><strong>Definition files.</strong></li> 
</ul> 
<p style="padding-left: 30px">A system “desired state” is defined in declaratively based configuration files. You no longer need to develop custom code and scripts to handle the configuration state that you want for your servers.</p> 
<ul> 
<li><strong>Idempotency.</strong></li> 
</ul> 
<p style="padding-left: 30px">You can apply the configuration file repeatedly without adverse side effects.</p> 
<ul> 
<li><strong>Self-documentation.</strong></li> 
</ul> 
<p style="padding-left: 30px">The configuration files are human-readable and easily understood.</p> 
<b>State Manager</b> 
<p>State Manager allows you to schedule a script to be run against your on-premises servers and EC2 instances on a scheduled basis. If the scripts are idempotent, you can apply them repeatedly. This gives way to a simple and scalable pattern that helps mitigate configuration drift.</p> 
<ol> 
<li>Define your set of servers.</li> 
<li>Create idempotent scripts or use PowerShell DSC to define your desired state configuration.</li> 
<li>Apply the script on a scheduled basis to mitigate any drift that may have occurred since the last time you ran the script.</li> 
</ol> 
<b>State Manager and PowerShell DSC</b> 
<p>This is a powerful combination! State Manager and PowerShell DSC allow you to define configuration policies that can be applied to your EC2 instances at scale. It ensures that your instances remain in that state by reapplying the policy on a defined schedule. While this does not prevent drift from occurring, it helps you mitigate any drift that may have occurred. Thus, this is an excellent pattern to ensure that both your on-premises servers and EC2 instances stay in your desired state.</p> 
<p><img class="alignnone size-full wp-image-902" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/DSC2_statemanager.png" alt="" width="1431" height="1015" /></p> 
<p>In this section, I show you how to use State Manager from the AWS Management Console. You learn to use both State Manager and PowerShell DSC to combat configuration drift.</p> 
<p>At a high level, this is the walk-through process:</p> 
<ol> 
<li>Create EC2 Windows instances.</li> 
<li>Tag those instances such that they are considered a set of instances that share a common purpose.</li> 
<li>Create a State Manager association. This association executes a PowerShell DSC script against the tagged instances on a specified schedule. 
<ul> 
<li>The PowerShell DSC script is contained in a PowerShell module downloaded from a S3 endpoint. It is authored by AWS and its intent is to install IIS on the instance and enable ASP and Tracing features. The module is publicly available and can be <a href="https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip">downloaded</a>.</li> 
</ul> </li> 
</ol> 
<b>Walk-through</b> 
<ol> 
<li>In the EC2 console, <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html#ec2-launch-instance_linux">create two or more new Windows Server instances</a>.</li> 
<li>Choose <strong>Instances</strong>, select the instances that you just created, and choose <strong>Tags</strong>.</li> 
<li>Choose <strong>Add/Edit Tags</strong> and set the following values: 
<ul> 
<li><strong>Set Key</strong> = Metadata</li> 
<li><strong>Set Value</strong> = {“Environment”: “Production”, “Type”: “IIS Web Server”}</li> 
</ul> </li> 
<li>In the EC2 console, choose <strong>State Manager</strong>, <strong>Create Association</strong>, and select the document <strong>AWS-InstallPowerShellModule</strong>. Set the following values: 
<ul> 
<li>Keep the document version as $DEFAULT.</li> 
<li>For <strong>Specifying a Tag</strong>, select: 
<ul> 
<li><strong>Tag Name</strong> = Metadata</li> 
<li><strong>Tag Value</strong> = {“Environment”: “Production”, “Type”: “IIS Web Server”}</li> 
</ul> </li> 
<li>For <strong>Schedule</strong>, choose Every <strong>30</strong> Minutes.</li> 
<li>For the <strong>Source</strong>, enter the following URL: <a href="https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip">https://s3.amazonaws.com/aws-windows-samples-us-east-1/PSModules/SSMDevOps.zip</a></li> 
<li>For <strong>Commands</strong>, copy and paste the following:</li> 
<li> <pre><code class="lang-powershell">Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
Import-Module SSMDevOps
Install-SsmDoIIS
Start-DscConfiguration -Path Install-SsmDoIIS -Wait</code></pre> </li> 
</ul> </li> 
<li>Choose <strong>Create Association</strong>.</li> 
</ol> 
<b>Conclusion</b> 
<p>Systems Manager offers a suite of tools to help you manage both your EC2 and on-premises instances. In this post, I discussed some common approaches to mitigate configuration drift at scale. Finally, I provided an example walk-through to try mitigating configuration drift using Systems Manager and PowerShell DSC.</p> 
<b>About the Author</b> 
<p><strong><a href="https://www.linkedin.com/in/shaunbreen/"><img class="alignleft wp-image-618" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/02/shaunbreen.png" alt="" width="130" height="174" /></a>Shaun Breen is a Systems Development Engineer on the Amazon EC2 Windows team</strong>.&nbsp;The EC2 Windows team is responsible for producing Windows Server AMIs and Systems Manager documents. Shaun enjoys developing solutions that make EC2 the best place to run Microsoft Windows Server in the cloud. When not working on EC2 Windows solutions, he enjoys attending sporting events, coaching ice hockey, and spending time with his wife and three children.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/powershell-dsc/" rel="tag">PowerShell DSC</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Organize Parameters by Hierarchy, Tags, or Amazon CloudWatch Events with Amazon EC2 Systems Manager Parameter Store</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-07-25T17:30:01+00:00">25 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/organize-parameters-by-hierarchy-tags-or-amazon-cloudwatch-events-with-amazon-ec2-systems-manager-parameter-store/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><em>This post was written by Lusha Zhang, Software Development Engineer with Amazon Web Services.</em></p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/parameter-store/">Parameter Store</a>, part of <a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a>, provides a centralized, encrypted store to manage your configuration data, whether plaintext data (database strings) or secrets (passwords, API keys for example). Because Parameter Store is available through the AWS CLI, APIs, and SDKs, you can easily reference parameters across AWS services such as AWS Lambda and Amazon ECS.</p> 
<p>For additional posts on Parameter Store, please see:</p> 
<ul> 
<li><a href="https://aws.amazon.com/blogs/compute/managing-secrets-for-amazon-ecs-applications-using-parameter-store-and-iam-roles-for-tasks/">Managing Secrets for Amazon ECS Applications Using Parameter Store and IAM Roles for Tasks</a></li> 
<li><a href="https://aws.amazon.com/blogs/mt/use-parameter-store-to-securely-access-secrets-and-config-data-in-aws-codedeploy/">Use Parameter Store to Securely Access Secrets and Config Data in AWS CodeDeploy</a></li> 
</ul> 
<p>Parameter Store recently <a href="https://aws.amazon.com/about-aws/whats-new/2017/06/amazon-ec2-systems-manager-adds-hierarchy-tagging-and-notification-support-for-parameter-store/">launched</a> hierarchy support, parameter tagging, and CloudWatch Events support, which makes it easy to organize and manage parameters at scale. In this post, I demonstrate how you can use these new features to scale and improve your security posture.</p> 
<p><span id="more-864"></span></p> 
<h3>Hierarchical parameters</h3> 
<p>Parameter Store support for hierarchies lets you organize parameters based on your deployment. It provides powerful tools for parameter organization, querying, and permission control.</p> 
<p>A common DevOps scenario is to automate software deployment across different environments such as Dev, Beta, and Prod. For example, when you create a deployment configuration, you can use Parameter Store to save your settings. Maybe you have to set the minimum healthy host number or percentage for each deployment environment, and want to store it in Parameter Store, with different values for each environment.</p> 
<h4>Step 1. Create the path for deployment configuration</h4> 
<p>Use the following commands to create the path and parameters to store:</p> 
<pre><code class="lang-bash">aws ssm put-parameter --name /DeploymentConfig/Prod/FleetHealth --value 75 --type String
aws ssm put-parameter --name /DeploymentConfig/Beta/FleetHealth --value 20 --type String
</code></pre> 
<p>You can also organize your secrets under a dedicated path. For example,</p> 
<pre><code class="lang-bash">aws ssm put-parameter –-name /DeploymentConfig/Prod/Password/SQLPassword –-value <span style="color: #ff0000">&lt;password&gt;</span> --type SecureString</code></pre> 
<p>For more information about how to use the SecureString type parameter, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-about.html">About Systems Manager Parameters</a>.</p> 
<p>Your parameter hierarchy now looks like the following:</p> 
<p>&nbsp;</p> 
<p>Step 2. Use parameters to manage your deployment configuration<br /> When you create a deployment configuration using an AWS CloudFormation template, you can set the FleetHealth for a Prod stage as in the following example.</p> 
<p><img class="alignnone size-full wp-image-870" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/hierarchy.png" alt="" width="681" height="349" /></p> 
<h4>Step 2. Use parameters to manage your deployment configuration</h4> 
<p>When you create a deployment configuration using an AWS CloudFormation template, you can set the FleetHealth for a Prod stage as in the following example.</p> 
<pre><code class="lang-bash">#!/bin/bash
fleetHealth=$(aws ssm get-parameter --name /DeploymentConfig/Prod/FleetHealth --query Parameter.Value)
aws cloudformation create-stack --stack-name <span style="color: #ff0000">&lt;stack_name&gt;</span> --template-url <span style="color: #ff0000">&lt;templateurl&gt;</span> --parameters ParameterKey=FleetHealth,ParameterValue=$fleetHealth
</code></pre> 
<p>You can retrieve all the configuration parameters of your Prod or Beta environments using the recursive flag and parse the configuration hierarchy returned to get the parameter of your choice.</p> 
<pre><code class="lang-bash">aws ssm get-parameters-by-path --path /DeploymentConfig/Prod –-recursive</code></pre> 
<p>You can also filter parameters by path from the AWS Management Console or AWS CLI.</p> 
<pre><code class="lang-bash">aws ssm describe-parameters --parameter-filters Key=Path,Option=Recursive,Values=/DeploymentConfig/Prod</code></pre> 
<p><img class="alignnone wp-image-876" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/getParamsbypath.png" alt="" width="941" height="320" /></p> 
<h4>Control access to hierarchies</h4> 
<p>Now that you have created a parameter hierarchy for your deployment configuration in the Prod and Beta environments, you may want to restrict access to parameters. Maybe the Dev team should have access only to the Beta environment parameters, and not to the Prod environment parameters.</p> 
<p>Use IAM to control access to the Beta parameter hierarchy. For example, the following IAM policy restricts user access to Prod parameters.</p> 
<pre><code class="lang-json">{
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Action&quot;: [
&quot;ssm:GetParametersByPath&quot;
],
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;ssm:Recursive&quot;: [
&quot;true&quot;
]
}
},
&quot;Resource&quot;:“arn:aws:ssm:&lt;region&gt;:&lt;account_id&gt;:parameter/DeploymentConfig/Prod*&quot;
}
</code></pre> 
<p>Now when a user runs the following command, they get AccessDeniedException.</p> 
<pre><code class="lang-bash">aws ssm get-parameters-by-path --path /DeploymentConfig/Prod —-recursive</code></pre> 
<h3>Tagging parameters</h3> 
<p>Tags let you manage your AWS resources easily. You can now also tag parameters, allowing you to group and query them. Using the same deployment configuration example, you can add a tag with a <span style="text-decoration: underline">Tag Key</span> value of “Password”, and <span style="text-decoration: underline">Tag Value</span> equal to “Beta” or “Prod”.</p> 
<pre><code class="lang-bash">aws ssm add-tags-to-resource --resource-type Parameter --resource-id  /DeploymentConfig/Beta/FleetHealth --tags Key=Password,Value=Beta</code></pre> 
<p>You can also apply multiple filters to get a combined filter result. For example, if you apply Tag Key Password and a path /DeploymentConfig/Beta with the recursive flag, you get those parameters in your Beta environment that are password-related.</p> 
<pre><code class="lang-bash">aws ssm describe-parameters --parameter-filters Key=tag:Password Key=Path,Option=Recursive,Values=/DeploymentConfig/Beta</code></pre> 
<p><img class="alignnone wp-image-878" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/multiple-tag-filters.png" alt="" width="1012" height="261" /><br /> You can manage the security access with IAM policies. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-access.html">Controlling Access to Systems Manager Parameters</a>.</p> 
<h3>Get change notifications with CloudWatch Events rules</h3> 
<p>Parameter Store is now a <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">CloudWatch Events</a> source. You can set up CloudWatch rules to trigger a CloudWatch Event target such as a Lambda function or SNS topic whenever a parameter gets created, updated, or deleted.</p> 
<p>The following example shows you how to set up a CloudWatch rule to trigger an SNS topic for your parameter update. For more information, see <a href="http://docs.aws.amazon.com/gettingstarted/latest/deploy/creating-an-sns-topic.html">Step 2: Create an SNS Topic</a>. After you set up your SNS topic to trigger an email notification about your parameter update, create a CloudWatch rule to associate with the SNS topic as a target. You can edit the Event Pattern value to specify the parameters for which to get notified:</p> 
<pre><code class="lang-json">{
&quot;source&quot;: [
&quot;aws.ssm&quot;
],
&quot;detail-type&quot;: [
&quot;Parameter Store Change&quot;
],
&quot;detail&quot;: {
&quot;name&quot;: [
&quot;/DeploymentConfig/Prod/FleetHealth&quot;,
&quot;/DeploymentConfig/Beta/FleetHealth&quot;
],
&quot;operation&quot;: [
&quot;Update&quot;,
&quot;Delete&quot;
]
}
}
</code></pre> 
<p><img class="alignnone wp-image-873" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/CWE-filled.png" alt="" width="886" height="572" /></p> 
<p>When you change the value of the /DeploymentConfig/Beta/FleetHealth parameter, the CloudWatch event should show up in the metrics.</p> 
<p><img class="alignnone wp-image-875" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/CWE-metrics.png" alt="" width="593" height="349" /></p> 
<p>In the meantime, the SNS topic that you created is triggered and you should receive an email as well.</p> 
<h3>Conclusion</h3> 
<p>This post demonstrated several new Parameter Store features to manage parameters: &nbsp;hierarchy, tagging, and CloudWatch notifications. Hierarchical parameters make it easier to organize and control access to configuration data, whether plaintext or secrets. Tagging support provides you with another way to group and query parameters easily. With CloudWatch Events, you can get timely notifications about parameter updates.</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img class="size-full wp-image-877 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/25/lusha-zhang.jpg" alt="" width="119" height="160" />Lusha Zhang is a Software Development Engineer in the Amazon EC2 System Manager Team. She has worked on various products at Amazon from Amazon Textbook Rentals to AWS Parameter Store. Outside work, she enjoys playing the violin and the piano as well as surfing in the Pacific Northwest.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch-events/" rel="tag">Amazon Cloudwatch Events</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Windows AMI Patching and Maintenance with Amazon EC2 Systems Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Venkat Krish</span></span> | on 
<time property="datePublished" datetime="2017-07-19T16:47:01+00:00">19 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/windows-ami-patching-and-maintenance-with-amazon-ec2-systems-manager-2/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>The <a href="https://aws.amazon.com/ec2/systems-manager/automation/"><strong>Automation</strong> </a>service, which is part of <strong><a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a></strong>, helps you save time and the effort associated with routine management operations. Automation workflows are streamlined, repeatable, and auditable. For example, you can easily automate manual tasks such as golden image creation, baking applications into Amazon Machine Images (AMIs), or patching and updating agents.</p> 
<p>In a recent post on the AWS Blog (<a href="https://aws.amazon.com/blogs/aws/streamline-ami-maintenance-and-patching-using-amazon-ec2-systems-manager-automation/">Streamline AMI Maintenance and Patching Using Amazon EC2 Systems Manager</a>), AWS announced the availability of the first public Document for Automation: AWS-UpdateLinuxAmi. This Document streamlines patching for Linux AMIs, allowing you to get started quickly with a predefined Automation workflow managed by AWS.</p> 
<p>Today, AWS announces the updated availability of the Windows equivalent: <strong>AWS-UpdateWindowsAmi.</strong> The AWS-UpdateWindowsAmi Document is a great fit for building a hardened AMI from the monthly Windows AMI release, applying Windows patches and AWS agent updates to your proprietary Windows AMI, or baking applications into a golden Windows AMI as part of your CI/CD pipeline. You can also use your custom AMIs as a source for images that meet organizational IT policies.&nbsp;Documents help centrally create, manage, and share code for IT Ops and the management tasks that Systems Manager can perform on your managed infrastructure.</p> 
<p><span id="more-823"></span></p> 
<p><strong>The AWS-UpdateWindowsAmi Document automates the following workflow:</strong></p> 
<ol> 
<li>Launch a temporary EC2 instance from a source Windows AMI.</li> 
<li>Perform Operating System compatibility checks.</li> 
<li>(Optional) Invoke a user-provided, pre-update hook script.</li> 
<li>Update EC2Config or EC2Launch (determined by the version of Windows launched in step 1).</li> 
<li>Update the SSM Agent.</li> 
<li>Update the AWS PV driver.</li> 
<li>Install Windows updates.</li> 
<li>(Optional) Invoke a user-provided, pre-update hook script on the instance.</li> 
<li>Run Sysprep /generalize.</li> 
<li>Stop the temporary instance.</li> 
<li>Create a new AMI from the stopped instance.</li> 
<li>Terminate the instance.</li> 
</ol> 
<h3>Prerequisites</h3> 
<p>If you haven’t used Automation before, you must configure IAM roles and permissions. This <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ami-cf.html">CloudFormation template</a> completes the required prerequisite actions. After logging on to your AWS account, choose <strong>Launch Stack</strong>. The template:</p> 
<ul> 
<li>Creates a service role for Automation.</li> 
<li>Grants PassRole permission to authorize a user to provide the service role.</li> 
<li>Creates an instance role to enable instance management under Systems Manager.</li> 
</ul> 
<h3>Executing Automation</h3> 
<p>1. In the EC2 console, choose Systems Manager, Automations.</p> 
<p><img class="alignnone wp-image-841 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/EC2SSMAutomation-1.png" alt="" width="2294" height="1200" /></p> 
<p>2. Choose <strong>Run automation document</strong>.</p> 
<p>3. Under <strong>Document name</strong>, choose <strong>AWS-UpdateWindowsAmi</strong>. Use the $DEFAULT document version.</p> 
<p><img class="alignnone wp-image-837 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/2.png" alt="" width="1877" height="514" /></p> 
<p>4. For the SourceAmiId variable, enter the ID of the Windows AMI to update. This is the only required field. The InstanceIamRole and AutomationAssumeRole variables are assigned default values that match the resource IDs generated by the CloudFormation template executed earlier.</p> 
<p><img class="alignnone wp-image-838 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/3-1.png" alt="" width="1741" height="860" /></p> 
<p>Optionally, specify values for the following (descriptions for each variable are listed in the console):</p> 
<ul> 
<li>Target AMI name</li> 
<li>Instance type</li> 
<li>KBs to include or exclude</li> 
<li>Update categories (Critical Update, Security Update)</li> 
<li>Severity levels (MSRC level such as Critical, Important, Low)</li> 
<li>Any pre– or post-update scripts to run</li> 
</ul> 
<p>5. Choose <strong>Run Automation</strong>.</p> 
<p>6. Monitor progress in the Automation Steps tab, and view the step-level outputs.</p> 
<p><img class="alignnone wp-image-829 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/4.png" alt="" width="1892" height="838" /></p> 
<p>After execution is complete, you can view any outputs returned by the workflow in the <strong>Description</strong> tab. In this example, <strong>AWS-UpdateWindowsAmi</strong> returns the new AMI ID and is tagged with your source AMI ID.</p> 
<p>Next, choose <strong>Images, AMIs</strong> to view your new AMI.</p> 
<p><img class="alignnone wp-image-830 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/5.png" alt="" width="1898" height="856" /></p> 
<p>There is no additional charge to use the Automation service, and any resources created by a workflow incur published usage charges. If you terminate AWS-UpdateWindowsAmi before reaching the “Terminate Instance” step, you should shut down the temporary instance created by the workflow.</p> 
<h3>Conclusion</h3> 
<p>Now that you’ve successfully run <strong>AWS-UpdateWindowsAmi</strong>, you may want to create default values for the service and instance roles. You can customize your workflow by creating your own Automation Document based on AWS-UpdateWindowsAmi. For more details, see <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/sysman-ami-createdoc.html">Create an Automation Document</a>. After you’ve created your Document, you can write additional steps and add them to the workflow.</p> 
<p>Example steps include:<br /> • Updating an Auto Scaling group with the new AMI ID (aws:invokeLambdaFunction action type)<br /> • Creating an encrypted copy of your new AMI (aws:encryptedCopy action type)<br /> • Validating your new AMI using Run Command with the RunPowerShellScript Document (aws:runCommand action type)<br /> Automation also makes a great addition to a CI/CD pipeline for application bake-in, and can be invoked as a CLI build step in Jenkins. For details on these examples, see the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/systems-manager-ami.html">Systems Manager Automation</a> technical documentation. Be sure to follow the <a href="https://aws.amazon.com/blogs/mt/">Management Tools blog</a> for additional deep dives on maintaining Windows AMIs using <strong>AWS-UpdateWindowsAmi.</strong></p> 
<p><strong>About the author</strong></p> 
<p><strong><img class="size-full wp-image-831 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/19/KRVenkt.jpg" alt="" width="119" height="160" /></strong><a href="https://www.linkedin.com/in/venkatkr/">Venkat Krishnamachari</a> is a Product Manager in the Amazon EC2 Systems Manager team. Venkat is excited by the opportunities presented by cloud computing, and loves helping customers realize the value of efficient infrastructure and management. In his personal time Venkat volunteers with NGOs and loves producing live theater and music shows.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-codedeploy/" rel="tag">AWS CodeDeploy</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-opsworks/" rel="tag">AWS OpsWorks</a>, <a href="https://aws.amazon.com/blogs/mt/tag/documents/" rel="tag">Documents</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-windows/" rel="tag">EC2 Windows</a>, <a href="https://aws.amazon.com/blogs/mt/tag/maintenance-window/" rel="tag">Maintenance Window</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-complaince/" rel="tag">Patch Complaince</a>, <a href="https://aws.amazon.com/blogs/mt/tag/patch-manager/" rel="tag">Patch Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ssm/" rel="tag">SSM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Amazon EC2 Systems Manager Documents: Support for Cross-platform Documents and Multiple Steps of the Same Type</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Ananth Vaidyanathan</span></span> | on 
<time property="datePublished" datetime="2017-07-18T12:21:11+00:00">18 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/amazon-ec2-systems-manager-documents-support-for-cross-platform-documents-and-multiple-steps-of-the-same-type/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><em>This post was written by Babul Mehta, Software Development Engineer with Amazon Web Services.</em></p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager">Amazon EC2 Systems Manager</a> documents define the actions that Systems Manager services perform on your managed instances. <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">Documents</a> are essentially a series of steps executed in sequence, and can be versioned and shared across accounts (and even publicly). Systems Manager includes many pre-configured documents that you can use by specifying parameters at runtime. In addition to these pre-configured public documents, you can create your own documents to perform actions relevant to your needs.</p> 
<p>With the launch of cross-platform support and the ability to have multiple steps of the same type in a document, some of the existing pain points are eliminated and you can build rich documents to perform cross-platform actions. In this post, I show you how to use these new features while creating documents and executing them via <a href="https://aws.amazon.com/ec2/systems-manager/run-command/">Run Command</a> and <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">State Manager</a>.</p> 
<p><span id="more-800"></span></p> 
<h3>Cross-platform document support</h3> 
<p>For each step in a document, you can now set preconditions that let you specify whether a step can target Windows or Linux instances. Previously, you could not add Windows-only compatible and Linux-only compatible steps in a single document. You had to create multiple, duplicate documents. With cross-platform support, this restriction is removed. I walk through an example to demonstrate this. Preconditions are supported from document schema version 2.2, which is the latest version recommended for new documents.</p> 
<h4>Precondition</h4> 
<p>You can now specify an option precondition for each step. The step is executed if the precondition is met, else it is skipped. For example:</p> 
<pre><code class="lang-json">{
&quot;action&quot;:&quot;aws:runPowerShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Windows&quot;]
},
&quot;name&quot;:&quot;runPowerShellScript&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[&quot;hostname&quot;]
}
}
</code></pre> 
<p>Here, the runPowerShellScript step is executed only on Windows instances. On Linux instances, this step is skipped.</p> 
<p>To use cross-platform functionality, your instances must be running Systems Manager (SSM) Agent version 2.0.834.0 or later.</p> 
<p>Another good example of cross-platform document is the AWS-RunPatchBaseline public document. It scans or installs patches from a patch baseline to a Linux or Windows operating system. For more information, see <a href="https://aws.amazon.com/blogs/aws/amazon-ec2-systems-manager-patch-manager-now-supports-linux/">Amazon EC2 Systems Manager Patch Manager now supports Linux</a>.</p> 
<p>Here’s another example where you can create a custom document that lists open ports on Windows and Linux managed instances. The document contains two steps: &nbsp;one runs a PowerShell command and another a Shell command. They have preconditions with platformType equaling Windows and Linux respectively, so that the same document can be targeted against both platforms. Only the compatible step is executed, while the non-compatible step is skipped.</p> 
<h4>Step 1: Create a cross-platform document</h4> 
<p>Store the following JSON in a local file:</p> 
<pre><code class="lang-json">{
&quot;schemaVersion&quot;:&quot;2.2&quot;,
&quot;description&quot;:&quot;Cross-platform demo document&quot;,
&quot;mainSteps&quot;: [
{
&quot;action&quot;:&quot;aws:runPowerShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Windows&quot;]
},
&quot;name&quot;:&quot;WindowsOpenPorts&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;: [&quot;netstat -a&quot;]
}
},
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;precondition&quot;: {
&quot;StringEquals&quot;: [&quot;platformType&quot;, &quot;Linux&quot;]
},
&quot;name&quot;:&quot;LinuxOpenPorts&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;: [&quot;netstat -lntu&quot;]
}
}
]
}
</code></pre> 
<p>To create the document, call the <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-document.html">CreateDocument</a> API operation:</p> 
<pre><code class="lang-bash">aws ssm create-document --name CrossPlatformDemo --content file://cross-platform_demo.json --document-type Command</code></pre> 
<p>You can execute the preceding document using Systems Manager Run Command or State Manager. This post demonstrates both.</p> 
<h4>Step 2: Execute cross-platform document via Run Command</h4> 
<p>First, execute the CrossPlatformDemo document via the Send Command API. You are executing the command against two instances: &nbsp;Windows and Linux. You can do the same via tags as well.</p> 
<pre><code class="lang-bash">aws ssm send-command --document-name &quot;CrossPlatformDemo&quot; --instance-ids &quot;i-09d19a0a297ad4c56&quot; &quot;i-07091332b7f4c71f2&quot;</code></pre> 
<p>You can view the results via AWS CLI or console. Here is the console output:</p> 
<p><img class="alignnone size-full wp-image-804" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_consoleoutput.png" alt="" width="1820" height="894" /></p> 
<p><img class="alignnone size-full wp-image-806" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_OuptutLinuxports.png" alt="" width="1458" height="714" /></p> 
<p><img class="alignnone size-full wp-image-808" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_windowsportoutput.png" alt="" width="1404" height="178" /></p> 
<p>The preceding screenshots are the results from the Linux instance. You can see that the LinuxOpenPorts step got executed and returned valid results, while the WindowsOpenPorts step was skipped because the precondition was not satisfied on the Linux instance.</p> 
<h4>Step 3: &nbsp;Execute the cross-platform document via State Manager</h4> 
<p>Now, execute the same document via State Manager by <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-association.html">creating an association</a>. An association is a binding of the intent (described in the document) to a target specified by either a list of instance IDs or a tag query.</p> 
<p>Use the following command to create an association using a tag query. The document name is from the previous step: “CrossPlatformDemo”.</p> 
<pre><code class="lang-bash">aws ssm create-association --name CrossPlatformDemo --targets &quot;Key=tag:Scenario,Values=Demo&quot; --schedule-expression &quot;cron(0 0/30 * 1/1 * ? *)&quot;</code></pre> 
<p>After you create an association, you can view the details using either the CLI or the console. You can easily drill down and find out which instances were targeted as part of this State Manager association, and their status.</p> 
<p><img class="alignnone size-full wp-image-809" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/SM_mainpage.png" alt="" width="1536" height="956" /></p> 
<h3>Multiple steps of the same type</h3> 
<p>Previously, Systems Manager did not support having the same step or plugin multiple times within a document. This made it cumbersome to separate out logical steps, such as pre- and post-scripts in a configuration.</p> 
<p>With this addition, you can perform more powerful configurations using Systems Manager. For example, you can use RunShellScript to install different applications. It is more organized if you have different steps for each application, instead of forcing everything in one step.</p> 
<p>In the following example, you install SSMAgent and Apache HTTP Server in two separate steps. They both run the RunShellScript plugin.</p> 
<h4>Step 1: &nbsp;Create a document with multiple steps of the same type</h4> 
<p>Store the following JSON in a local file:</p> 
<pre><code class="lang-json">{
&quot;schemaVersion&quot;:&quot;2.0&quot;,
&quot;description&quot;:&quot;Multiple steps of same type demo document&quot;,
&quot;mainSteps&quot;: [
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;name&quot;:&quot;installSSMAgent&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[
&quot;sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm&quot;,
&quot;sudo start amazon-ssm-agent&quot;,
&quot;sudo status amazon-ssm-agent&quot;
]
}
},
{
&quot;action&quot;:&quot;aws:runShellScript&quot;,
&quot;name&quot;:&quot;installApache&quot;,
&quot;inputs&quot;: {
&quot;runCommand&quot;:[
&quot;sudo yum install -y httpd24&quot;
]
}
}
]
}</code></pre> 
<p>To create the document, call the <a href="http://docs.aws.amazon.com/cli/latest/reference/ssm/create-document.html">CreateDocument</a> API operation:</p> 
<pre><code class="lang-bash">aws ssm create-document --name MultipleStepsDemo --content file://multiple-steps_demo.json --document-type Command</code></pre> 
<p>Again, you can execute this document via Systems Manager Run Command or State Manager. For this scenario, execute it via Run Command only.</p> 
<h4>Step 2: Execute the multiple-steps document via Run Command</h4> 
<p>The following command executes the MultipleStepsDemo document against one instance. You can do the same via tags as well.</p> 
<pre><code class="lang-bash">aws ssm send-command --document-name &quot;MultipleStepsDemo&quot; --instance-ids &quot;i-09d19a0a297ad4c56&quot;</code></pre> 
<p>You can view the results via CLI or console. Here’s the output from the console.</p> 
<p><img class="alignnone size-full wp-image-803" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_console_multiplesteps.png" alt="" width="1848" height="896" /></p> 
<p><img class="alignnone size-full wp-image-805" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_istallapache_output.png" alt="" width="1454" height="984" /></p> 
<p><img class="alignnone size-full wp-image-807" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/RC_outputinstallssmagent.png" alt="" width="1436" height="1022" /></p> 
<h3>Conclusion</h3> 
<p>In this post, I showed you how to use the newly launched Systems Manager document features to create cross-platform documents, and have multiple steps of same type within a document. These features eliminate the current pain point of maintaining a duplicate set of documents for different platforms. They also open up more possibilities to create rich documents that you can use with Systems Manager to manage and configure your EC2 instance fleet.</p> 
<hr /> 
<h3>About the Author</h3> 
<p><img class="size-full wp-image-810 alignleft" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/18/babul.jpg" alt="" width="119" height="160" />Babul Mehta is a Software Development Engineer in the Amazon EC2 Systems Manager team. Outside of work, he loves to watch cricket and American football and he is a big fan of the Indian cricket team and the Seahawks.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/documents/" rel="tag">Documents</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ssm/" rel="tag">SSM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to track configuration changes to CloudFormation stacks using AWS Config</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Shashi Prabhakar</span></span> and 
<span property="author" typeof="Person"><span property="name">Sid Gupta</span></span> | on 
<time property="datePublished" datetime="2017-07-18T11:02:01+00:00">18 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-config/" title="View all posts in AWS Config"><span property="articleSection">AWS Config</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/how-to-track-configuration-changes-to-cloudformation-stacks-using-aws-config/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Recently, <a href="https://aws.amazon.com/config/">AWS Config</a> announced support for <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> stacks. You can now start tracking the current and historical configuration of your CloudFormation stacks, and get notified via <a href="https://aws.amazon.com/sns">Amazon SNS</a> when your stack configuration changes. You can also use a managed AWS Config rule to check whether your CloudFormation stacks are sending event notifications to an SNS topic.</p> 
<p>Tracking configuration changes to a CloudFormation stack is valuable from a governance perspective. It tells you how and when a stack got modified. Use this information to troubleshoot operational issues and outages, and maintain audit compliance.</p> 
<p>In this post, I describe two possible use cases, tracking stack changes and evaluating compliance, and walk you through each scenario.</p> 
<p><span id="more-757"></span></p> 
<h3>AWS services</h3> 
<p>AWS Config enables you to assess, audit, and evaluate the configurations of your AWS resources. It continuously monitors and records your AWS resource configurations and allows you to automate the evaluation of recorded configurations against desired configurations. With AWS Config, you can review changes in configurations and relationships between AWS resources, dive into detailed resource configuration histories, and determine your overall compliance against the configurations specified in your internal guidelines.</p> 
<p>CloudFormation gives developers and systems administrators an easy way to create and manage a collection of related AWS resources, provisioning and updating them in an orderly and predictable fashion. CloudFormation standardizes the manner in which resources get deployed into your environments and simplifies the management of cloud resources. You can create your own templates to describe the AWS resources, and any associated dependencies or runtime parameters, required to run your application. You can deploy and update a template and its associated collection of resources (called a stack) by using the AWS Management Console, AWS CLI, or APIs.</p> 
<h3>Example: Track stack configuration changes</h3> 
<p>When you create a stack, all update actions are allowed on all resources. By default, anyone with stack update permissions can update all of the resources in the stack.</p> 
<p>With a stack policy, you can prevent <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">stack resources</a> from being unintentionally updated or deleted during a stack update. A stack policy is a JSON document that defines the update actions that can be performed on designated resources. Use a stack policy only as a fail-safe mechanism to prevent accidental updates to specific stack resources.</p> 
<p>Consider a scenario where Bob, a cloud administrator, provisions a stack that creates a secure VPC for a public-facing application that includes subnets, NAT gateways, route tables, and custom network ACL rules. The security of this stack and its underlying resources is critical since it contains the essential building blocks for creating applications and any changes to this VPC, subnets, route tables etc. could potentially impact all applications hosted within that VPC. Hence, in order to prevent changes to this stack, Bob applies a “deny all” stack policy that disallows updates to all resources in the stack.</p> 
<p>Adam, an application developer with stack update permissions attempts to modify the stack. He realizes that the stack cannot be updated due to the “deny all” stack policy, so he attaches a new stack policy (“allow all”) that allows updates to all resources in the stack.</p> 
<p>You can capture these changes via AWS Config and use them to alert Bob, the cloud administrator. Download the CloudFormation template <a href="https://s3.amazonaws.com/quickstart-reference/enterprise-accelerator/nist/latest/submodules/quickstart-compliance-common/templates/vpc-production.template">VPC-Production</a> for this example. This template configures a secure VPC for a public-facing application that includes subnets, NAT gateways, route tables, and custom network ACL rules. The example uses the AWS Management Console, but you can use the AWS CLI or SDKs as well.</p> 
<p>In the CloudFormation console, you can see what resources were configured when the stack was launched.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image001.png"><img class="alignleft wp-image-758 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image001.png" alt="" width="1430" height="635" /></a></p> 
<p>&nbsp;</p> 
<p>The following stack policy was attached at launch time. This policy denies updates to all resources in this stack.</p> 
<pre><code class="lang-json">{
&quot;Statement&quot; : [
{
&quot;Effect&quot; : &quot;Deny&quot;,
&quot;Action&quot; : &quot;Update:*&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Resource&quot; : &quot;*&quot;
}
]
}</code></pre> 
<p>Now, Adam, the application developer with stack update permissions, wants to modify the management subnet IP address range “pManagement CIDR”. After realizing that the stack has a “deny all” stack policy, he updates the stack policy via CLI as shown below:</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image002.png"><img class="alignleft wp-image-759 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image002.png" alt="" width="813" height="80" /></a></p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p>This policy basically allows all updates to stack resources:</p> 
<p>&nbsp;</p> 
<pre><code class="lang-json">{
&quot;Statement&quot; : [
{
&quot;Effect&quot; : &quot;Allow&quot;,
&quot;Action&quot; : &quot;Update:*&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Resource&quot; : &quot;*&quot;
}
]
}</code></pre> 
<p>He then updates the stack to change the management subnet IP address range.</p> 
<p>Check how AWS Config tracked these modifications. First, log in to the AWS Config console. Choose <strong>Resources</strong>. For <strong>Resources</strong>, choose <strong>CloudFormation: Stack</strong>. To see the list of all CloudFormation stacks being recorded in Config, choose <strong>Look up</strong>.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image003.png"><img class="alignleft wp-image-760 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image003.png" alt="" width="1868" height="703" /></a>In this example, open the CloudFormation stack named <strong>myProdVPC</strong> to view its <strong>Config timeline</strong>. The following screenshot shows the timeline and configuration details.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image004.png"><img class="alignleft wp-image-761 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image004.png" alt="" width="1867" height="824" /></a></p> 
<p>At the top, you see a timeline of all changes that have occurred to the stack after creation.</p> 
<p>You can see the configuration of the stack under <strong>Configuration Details</strong>. This includes the Amazon resource name (ARN), resource ID, rollback settings, and creation time.</p> 
<p>In this scenario, there were 8 changes on July 10th. You can drill down further to see what those changes were. The stack policy was modified to allow updates to all resources, and then an EC2 network ACL entry was modified. Specifically, the “pManagement CIDR” block was modified from 10.100.10.0/24 to 10.100.96.0/21.</p> 
<p>AWS Config also sends an SNS notification each time a configuration change is detected, so that you can be alerted of changes to your CloudFormation stacks.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p2.jpg"><img class="alignleft wp-image-794 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p2.jpg" alt="" width="1856" height="758" /></a> <a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p1.jpg"><img class="alignleft size-full wp-image-793" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/p1.jpg" alt="" width="1846" height="651" /></a></p> 
<p>In addition to reviewing these configuration changes, you can also see the entire list of resources within the stack. View <strong>Relationships</strong> for resource types supported in AWS Config, and view <strong>Unsupported Resources</strong> for resource types not currently supported in AWS Config.</p> 
<p>You can also view the configuration history of resources currently supported in AWS Config, if you choose to investigate further.</p> 
<h3><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image007.png"><img class="alignleft size-full wp-image-764" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image007.png" alt="" width="1847" height="841" /></a>Example: AWS Config rules</h3> 
<p>In addition to tracking the configuration of your CloudFormation stacks, you can use AWS Config rules to check your stacks against best practice rules and internal policies.</p> 
<p>For example, use the prebuilt rules called <strong>cloudformation-stack-notification-check</strong> to verify whether your CloudFormation stacks are sending event notifications to an SNS topic at all times. The following example shows compliant and noncompliant configuration states.</p> 
<p>cloudformation-stack-notification-check</p> 
<p>The CloudFormation stack that you created earlier is showing as noncompliant with this rule, as it does not have any SNS topic configured.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image008.png"><img class="alignleft size-full wp-image-765" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image008.png" alt="" width="1861" height="803" /></a></p> 
<p>&nbsp;</p> 
<p>After adding a notification topic to the stack in the CloudFormation console, you can see that the compliance status changes to the compliant state.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image009.png"><img class="alignleft size-full wp-image-766" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/image009.png" alt="" width="1862" height="508" /></a></p> 
<h3>Summary</h3> 
<p>With support for CloudFormation stacks in AWS Config, you can now continuously track configuration changes to all stacks, including stack policies and parameter changes. You can use AWS Config rules to verify configuration best practices and compliance with internal policies.</p> 
<p>&nbsp;</p> 
<hr /> 
<p>About the Authors</p> 
<p><img class="alignleft wp-image-786 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/profile-pic-150x150.png" alt="" width="150" height="150" /></p> 
<p>Sid Gupta is a Sr. Product Manager for AWS Config. AWS Config is a service that enables you to assess, audit, and evaluate the configurations of your AWS resources. Sid enjoys working with customers and help them implement cloud security best practices. In his spare time, he enjoys hiking, reading and spending time with his kids.</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<p><img class="alignleft wp-image-787 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/14/shashi.jpg" alt="" width="150" height="150" /></p> 
<p>Shashi Prabhakar is a Solutions Architect at AWS. He loves working with customers to help design, architect and build variety of workloads. Shashi always gets excited to learn new Technologies and Businesses while working with customers. When not learning, he likes to run, play tennis, travel, spend time with wife and enjoy life.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-config/" rel="tag">AWS Config</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Running Salt States Using Amazon EC2 Systems Manager</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Andres Silva</span></span> | on 
<time property="datePublished" datetime="2017-07-16T22:38:49+00:00">16 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/running-salt-states-using-amazon-ec2-systems-manager/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Like <a href="https://www.ansible.com/">Ansible</a>, <a href="https://saltstack.com/">Salt</a> is a popular tool for configuration management. As with other tools in the same category, one of the key challenges is efficiently managing the deployment and execution of the automation directives.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/">Amazon EC2 Systems Manager</a> is a powerful configuration management platform. One of its key benefits is that it allows customers to use whatever configuration management tool they are currently using. In the <a href="https://aws.amazon.com/blogs/mt/running-ansible-playbooks-using-ec2-systems-manager-run-command-and-state-manager/">Running Ansible Playbooks using EC2 Systems Manager Run Command and State Manager</a> post, I explained how Systems Manager can be used to manage configuration management states using Ansible.</p> 
<p>In this post, I explore how to use Salt (on master-less mode), while leveraging the power, simplicity, and security of Systems Manager. I also introduce a new Systems Manager document that makes it easier for customers to run Salt states.</p> 
<p><span id="more-693"></span></p> 
<b>Systems Manager overview</b> 
<p>Systems Manager uses <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html">documents</a> to define actions to be executed on your managed instances.</p> 
<p>Some of the benefits of using Systems Manager:</p> 
<ul> 
<li>Improved security posture 
<ul> 
<li>There is no need to open incoming ports to remotely execute the directives. This eliminates the need for using SSH.</li> 
<li>You can use granular IAM policies to restrict and control access to the platform</li> 
<li>All command execution is audited via AWS CloudTrail.</li> 
</ul> </li> 
<li>Performance and reliability 
<ul> 
<li>Asynchronously execute commands.</li> 
<li>Commands are delivered and executed even when the system comes back from being offline.</li> 
<li>Execute at scale by taking advantage of velocity control and sending commands based on tags.</li> 
<li>Control deployment rate if errors increase during deployment.</li> 
</ul> </li> 
</ul> 
<p>&nbsp;</p> 
<b>Salt overview</b> 
<p>Salt uses the concept of states. A state is a set of configuration directives that represents what software should be installed and how it should be configured.</p> 
<p>In typical deployments, Salt is used with a master server. The servers that receive automation directives are called minions. However, Salt states can also be run locally in what is called master-less mode. Using this feature, you can leverage Systems Manager to distribute and execute the Salt state files using <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/">Amazon EC2 State Manager</a> or <a href="https://aws.amazon.com/ec2/run-command/">Run Command</a>.</p> 
<b>AWS-RunSaltState document</b> 
<p>The new document that automates the process of running Salt states locally using Systems Manager is AWSRunSaltState. It is available to use via the console or API. Here are the different parts of the document and how it works:</p> 
<ul> 
<li>Parameters</li> 
<li>Steps</li> 
<li>Salt-call</li> 
</ul> 
<h3>Parameters</h3> 
<p>The AWSRunSaltState document provides a number of parameters to execute the Salt states:</p> 
<ul> 
<li><strong>State</strong> – Allows for input YAML to define the Salt state automation.</li> 
<li><strong>Stateurl</strong> – (Optional) Provides a URL to a file that contains the YAML text for the Salt state. The URL can be in http or s3 format.</li> 
<li><strong>Pillars</strong> – (Optional) Passes additional variables to be used during the execution. Salt uses the concept of pillars to define data that can be used to configure the managed instances (minions).</li> 
<li><strong>Test</strong> – If true, performs a dry-run of the state. This reports on the actions to be performed by the automation but does not execute them.</li> 
</ul> 
<h3>Steps</h3> 
<p>The AWSRunSaltState document performs a few validations, then executes the automation using the YAML definitions passed by the parameters. Here is a summary of how the logic works:</p> 
<ul> 
<li>Checks the Salt version to determine if Salt is present on the system.</li> 
<li>Determines if the <strong>State</strong> parameter was passed as YAML using the <strong>State</strong> text or as a URL using <strong>Stateurl</strong>. Based on the input, it copies the data to a temporary state file for later execution.</li> 
<li>Determines if the test option was selected and executes the proper command.</li> 
</ul> 
<h3>Salt-call</h3> 
<p>Salt includes an application called salt-call that can be used on managed instances to execute Salt states locally. The AWSRunSaltState document uses this application to execute the Salt state locally.</p> 
<b>Walkthrough using Systems Manager and State Manager</b> 
<p>Here’s an example of using State Manager with the new document to execute Salt state files.</p> 
<b>Prerequisites</b> 
<p>Complete the following requirements before going through this walkthrough:</p> 
<ul> 
<li>Target instances must be managed by Systems Manager. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html">Installing SSM Agent</a>.</li> 
<li>Salt must be pre-installed on the target instance or execution fails. This document runs Salt states locally. For more information, see the following section on installing Salt for master-less execution.</li> 
<li>For S3 URLs in the playbook field, the <a href="https://aws.amazon.com/cli/">AWS CLI</a> must be installed on the target instance or server.</li> 
</ul> 
<b>Installing Salt for master-less execution</b> 
<p><em>If you already have Salt installed on the target instances, you can skip this section. </em></p> 
<p>Install Salt on the target instances to run what is called a master-less minion. Execute the following on the Linux instance:</p> 
<pre><code class="lang-bash">curl -L https://bootstrap.saltstack.com -o bootstrap_salt.sh
sudo sh bootstrap_salt.sh</code></pre> 
<p>&nbsp;</p> 
<p>You could also run these two commands using Systems Manager Run Command and the AWS-RunShellScript document. This installs the necessary files to run Salt in master-less mode, using the salt-call application to execute the automation. This command is installed as part of the master-less bootstrapping.</p> 
<b>Using State Manager and the AWSRunSalt document</b> 
<p>The following YAML Salt state file contains automation that installs Apache if it is not already installed.</p> 
<p>&nbsp;</p> 
<pre><code class="lang-yaml">apache:
pkg.installed:
{% if grains['os'] == 'Amazon' %}
- name: httpd
{% elif grains['os'] == 'Ubuntu' %}
- name: apache2
{% endif %}</code></pre> 
<p>To use this Salt state file with Systems Manager, follow these steps:</p> 
<ol> 
<li>In the EC2 console, choose <strong>State Manager, Create Association</strong>.</li> 
<li>From the Document list, choose the new document “AWS-RunSaltState”.</li> 
<li>For <strong>Document Version</strong>, leave $DEFAULT selected.</li> 
<li>Under <strong>Targets</strong>, choose <strong>Manually Selecting instances</strong> and select the instance or instances to target with the Salt state. Alternatively, use a tag to select the instances to target. <img class="wp-image-9" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/07/SaltPicture4.png" /></li> 
<li>Under <strong>Schedule</strong>, enter how frequently to run the association.</li> 
<li>Under <strong>Parameters</strong>, for <strong>State, </strong>paste the YAML text for the Salt state. Leave <strong>Stateurl</strong> empty. <img class="wp-image-10" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/10/SaltPicture6-1.png" /></li> 
<li>For <strong>Pillars</strong>, enter the additional variables to use for the Salt state. Make sure the values are entered in the following format:</li> 
</ol> 
<p>{“SSM”:”True”}</p> 
<p>You can also use nested dict:</p> 
<p>{‘pkg’: {‘apache’: ‘httpd’}}</p> 
<ol> 
<li>(Optional) Choose the test option.</li> 
<li>(Optional) Enter a comment for this association.</li> 
<li>Choose <strong>Run</strong>.</li> 
<li>To verify the output from the console, choose the <strong>Association ID</strong> link for this run. <img class="wp-image-11" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/07/SaltPicture8.png" /></li> 
</ol> 
<p>After the association runs for the first time, you can see the results of the execution by navigating to the association and looking at the <strong>Status</strong> column. Now, every time the association runs, it run the salt state and this in turn ensures that the software is installed and running.</p> 
<b>Integration with Parameter Store</b> 
<p>All Systems Manager documents support referencing settings or secrets stored in Parameter Store, which provides a secure storage for configuration data such as passwords, database connection strings, and license code. For more information, see <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html">Systems Manager Parameter Store</a>.</p> 
<p>To use data stored in Parameter Store with Salt, reference it as part of the State code using the following format:</p> 
<pre><code class="lang-json">{{ssm:parameter_name}}</code></pre> 
<p>&nbsp;</p> 
<p>For example, to run a simple touch command to create a file in the /tmp directory and pass the file name as a saved setting, make sure that the parameter is created in Parameter Store. The Salt state file looks like the following:</p> 
<pre><code class="lang-yaml">mycommand:
cmd.run:
- name: touch /tmp/{{ssm:tempfilename}} /</code></pre> 
<p>&nbsp;</p> 
<b>Summary</b> 
<p>In this post, I introduced the new Systems Manager document to execute Salt state files using State Manager and Run Command. I also demonstrated how you can use this new document to deploy and manage your Salt automation.</p> 
<p>You can also use this Systems Manager document with the Run Command option and leverage velocity control. For an example on how to do this, see the <a href="https://aws.amazon.com/blogs/mt/running-ansible-playbooks-using-ec2-systems-manager-run-command-and-state-manager/">Running Ansible Playbooks using EC2 Systems Manager Run Command and State Manager</a> post.</p> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<p><img class="alignleft wp-image-453 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/05/23/Andres-headshot-150x150.jpg" alt="" width="150" height="150" /></p> 
<p>Andres Silva is a Senior Technical Account Manager for AWS Enterprise Support. He has been working with AWS technology for more than 6 years. Andres works with Enterprise customers to design, implement and support complex cloud infrastructures. When he is not building cloud automation he enjoys skateboarding with his 2 kids.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Monitor and Notify on AWS Account Root User Activity</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Sudhanshu Malhotra</span></span> | on 
<time property="datePublished" datetime="2017-07-14T11:16:44+00:00">14 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch"><span property="articleSection">Amazon CloudWatch</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation"><span property="articleSection">AWS CloudFormation</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/monitor-and-notify-on-aws-account-root-user-activity/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Are you aware when someone uses your AWS account credentials to perform some activity? Are you notified in time?</p> 
<p>When you first create an AWS account, you begin only with a single sign-in identity that has complete access to all AWS services and resources in the account. This identity is called the root user and is accessed by signing in with the email address and password that you used to create the account.</p> 
<p>An AWS account root user has full access to all your resources for all AWS services, including billing information. It is critical to prevent root user access from getting into the wrong hands and to be aware whenever root user activity occurs in your AWS account. For more information about AWS recommendations, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html">IAM Best Practices</a>. Some of the key recommendations include:</p> 
<ul> 
<li>Enabling multi factor authentication (MFA)</li> 
<li>Setting complex passwords</li> 
<li>Avoiding creating access key for root</li> 
<li>Creating an admin level IAM user to perform any high privilege activities</li> 
</ul> 
<p>However, there are <a href="https://docs.aws.amazon.com/general/latest/gr/aws_tasks-that-require-root.html">certain actions that can only be performed by the root user</a>. To be certain that all root user activity is authorized and expected, it is important to monitor root API calls to a given AWS account and to notify when this type of activity is detected. This notification gives you the ability to take any necessary steps when an illegitimate root API activity is detected or it can simply be used as a record for any future auditing needs.</p> 
<p>In this post, I walk through a solution that monitors and notifies on root API activity for an AWS account.</p> 
<p><span id="more-751"></span></p> 
<b>Solution</b> 
<p>The diagram below describes the solution at a high level.</p> 
<p>&nbsp;</p> 
<p><img class="alignnone size-full wp-image-1365" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/flow_diagram-1.jpg" alt="" width="2118" height="294" /></p> 
<ol> 
<li>An <a href="https://aws.amazon.com/cloudwatch">Amazon CloudWatch Events</a> rule detects any AWS account root user API events.</li> 
<li>It triggers an <a href="https://aws.amazon.com/lambda">AWS Lambda</a> function.</li> 
<li>The Lambda function then processes the root API event. It also publishes a message to an <a href="https://aws.amazon.com/sns">Amazon SNS topic</a>, where the subject contains the AWS account ID or AWS account alias where the root API call was detected and the type of API activity.</li> 
<li>The SNS topic then sends notifications to its email subscribers about this event.</li> 
</ol> 
<p>I walk through deploying the <a href="https://aws.amazon.com/cloudformation">AWS CloudFormation</a> stack that creates these resources and then validates that root user activity is detected and notified. It helps if you know about&nbsp;<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">CloudWatch Events rules</a>,&nbsp;<a href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html">Lambda</a>,&nbsp;and&nbsp;<a href="https://docs.aws.amazon.com/sns/latest/dg/welcome.html">SNS</a>.</p> 
<p>&nbsp;</p> 
<b>Prerequisites</b> 
<ul> 
<li>Create and enable a multi-region <a href="https://aws.amazon.com/cloudtrail">AWS CloudTrail</a> trail for all AWS regions.</li> 
<li>Upload the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/RootActivityLambda.zip">RootActivityLambda.zip</a> file to an S3 bucket.</li> 
</ul> 
<p>&nbsp;</p> 
<b>Deployment steps</b> 
<ol> 
<li>In the CloudFormation console, choose <strong>Create Stack</strong>.&nbsp;Use the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/RootAPIMonitor.json">RootAPIMonitor.json</a> CloudFormation JSON template. Choose <strong>Next</strong>.</li> 
<li>Create the stack in the region in which to monitor root API activity, as well as the us-east-1 region. Root API login is a global event and logged in us-east-1. I recommend deploying in all AWS regions.</li> 
<li>Enter the following parameter details and choose <strong>Next</strong>: 
<ul> 
<li><strong>SNSTopicName</strong>: A unique name for the SNS topic to be created.</li> 
<li><strong>SNSSubscriptions</strong>: An email address to subscribe to the SNS topic.&nbsp;. I recommend sending these notifications to a distribution list rather than an individual.</li> 
<li><strong>LambdaTimeout</strong>: The Lambda function timeout value in seconds. The default is 30 seconds.</li> 
<li><strong>LambdaS3Bucket</strong>: Name of the S3 bucket where the Lambda function zip file is stored.</li> 
<li><strong>LambdaS3Key</strong>: Name of the Lambda function zip file. This is the full path to the S3 object, with the prefix. For example, “/dir1/dir2/lambdafunction.zip”.</li> 
</ul> </li> 
<li>Select <strong>Capabilities Acknowledgement</strong> and choose <strong>Create</strong>. This field gives permission to the stack to create IAM roles and policies. These roles and policies are used by the Lambda function to perform certain actions such as publishing messages to the SNS topic, listing the account alias, and so on.</li> 
<li>After the CloudFormation stack completes, check for an SNS subscription email sent to the email provided for <strong>SNSSubscriptions</strong>. Open the <strong>SubscribeURL</strong> link to complete the subscription.<img class="alignnone size-full wp-image-1378" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/subscribe_email.png" alt="" width="496" height="285" /></li> 
<li>After the SNS topic is subscribed, the subscriber starts receiving email notification when root API activity is detected.</li> 
</ol> 
<p>&nbsp;</p> 
<p>The CloudFormation template created three main AWS resources for this solution:</p> 
<p>&nbsp;</p> 
<h3>CloudWatch Events rule</h3> 
<p>The rule catches a console login event and all other API events by a root user, and triggers the Lambda function (set as a target) when such events are detected.</p> 
<p><img class="alignnone size-full wp-image-1379" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/CWE_snapshot.png" alt="" width="824" height="545" /></p> 
<p>&nbsp;</p> 
<h3>Lambda function</h3> 
<p>The function collects the necessary information about the root API event and publishes it to the SNS topic. The function parses the name of the event and the AWS account alias where this root API event occurred and puts them in the subject field for the message that it publishes to the SNS topic.</p> 
<p>&nbsp;</p> 
<p>Code for getting the name of the event:</p> 
<pre><code class="lang-python">def lambda_handler(event, context):
logger.setLevel(logging.INFO)
eventname = event['detail']['eventName']
</code></pre> 
<p>Code for getting the AWS account alias:</p> 
<pre><code class="lang-python">response = client.list_account_aliases()
logger.debug(&quot;List account alias response --- %s&quot; %response)
try:
if not response['AccountAliases']:
accntAlias = (boto3.client('sts').get_caller_identity()['Account'])
logger.info(&quot;Account alias is not defined. Account ID is %s&quot; %accntAliase)
else:
accntAliase = response['AccountAliases'][0]
logger.info(&quot;Account alias is : %s&quot; %accntAliase)
except ClientError as e:
logger.error(&quot;Client error occurred&quot;)</code></pre> 
<p>Code for publishing to the SNS topic:</p> 
<pre><code class="lang-python">try: 
#Sending the notification...
snspublish = snsclient.publish(
TargetArn= snsARN,
Subject=((&quot;Root API call-\&quot;%s\&quot; detected in Account-\&quot;%s\&quot;&quot; %(eventname,accntAliase))[:100]),
Message=json.dumps({'default':json.dumps(event)}),
MessageStructure='json')
</code></pre> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
<h3>SNS topic</h3> 
<p>The topic sends the email notification published by the Lambda function.</p> 
<p><img class="alignnone size-full wp-image-1380" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/SNS.png" alt="" width="826" height="406" /></p> 
<p>&nbsp;</p> 
<b>Solution validation</b> 
<p>Now that you have the solution deployed and ready, test and validate. First, sign in to your AWS account using your access credentials. This console login activity by a root user should send an email notification in near real time.</p> 
<p><img class="alignnone size-full wp-image-1381" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/login_notify.png" alt="" width="609" height="269" /></p> 
<p>&nbsp;</p> 
<p>Next, validate if other root API events are also detected and notified on. For example, you can create an EBS volume using the root credentials and confirm that you receive an email notification in near real time.</p> 
<p><img class="alignnone size-full wp-image-1382" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/ebs.png" alt="" width="630" height="260" /></p> 
<p>Some AWS services—such as Auto Scaling, Elastic Load Balancing, and Trusted Advisor—use root to access resources in your AWS account, instead of an IAM role. When this happens, you see the service name in the&nbsp;<strong>invokedBy</strong>&nbsp;field of the&nbsp;<strong>userIdentity</strong>&nbsp;JSON statement. This event is legitimate and can be ignored. For more information, see <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudtrail-root-action-logs/">My AWS CloudTrail logs show root credentials are being used to authenticate actions I didn’t initiate</a>.</p> 
<b>Summary</b> 
<p>In this post, I showed you how to monitor and notify on root API activity for an AWS account. This framework can be extended to monitor and notify on other IAM user activity, giving you the ability to monitor highly privileged users in near real time.</p> 
<p>For more information, I recommend the following whitepapers:</p> 
<ul> 
<li><a href="https://d0.awsstatic.com/whitepapers/Security/AWS_Security_Whitepaper.pdf">Amazon Web Services: Overview of Security Processes</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Governance_in_AWS_Whitepaper.pdf">Security at Scale: Governance in AWS</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/Automating_Governance_on_AWS.pdf">Automating Governance on AWS</a></li> 
</ul> 
<p>&nbsp;</p> 
<h3>About the Author</h3> 
<p><img class="alignleft size-thumbnail wp-image-747" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/10/dp-119x150.jpeg" alt="" width="119" height="150" />Sudhanshu Malhotra is a Solutions Architect at AWS Professional Services. Sudhanshu enjoys working with our customers and helping them deliver complex solutions in AWS in the area of DevOps, Infrastructure-as-Code and Config Management. In his spare time, Sudhanshu enjoys spending time with his family, hiking and tinkering with cars.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-lambda/" rel="tag">AWS Lambda</a>, <a href="https://aws.amazon.com/blogs/mt/tag/root-credentials/" rel="tag">root credentials</a>, <a href="https://aws.amazon.com/blogs/mt/tag/secdevops/" rel="tag">SecDevOps</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Monitor Changes and Auto-Enable Logging in AWS CloudTrail</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Sudhanshu Malhotra</span></span> | on 
<time property="datePublished" datetime="2017-07-10T10:45:09+00:00">10 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch"><span property="articleSection">Amazon CloudWatch</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation"><span property="articleSection">AWS CloudFormation</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudtrail/" title="View all posts in AWS CloudTrail"><span property="articleSection">AWS CloudTrail</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/monitor-changes-and-auto-enable-logging-in-aws-cloudtrail/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><a href="https://aws.amazon.com/cloudtrail">AWS CloudTrail</a> is a service that enables governance, compliance, operational auditing, and risk auditing of your AWS account. Hence, it’s crucial to monitor any changes to CloudTrail and make sure that logging is always enabled.</p> 
<p>With CloudTrail, you can log, continuously monitor, and retain events related to API calls across your AWS infrastructure. CloudTrail provides a history of API calls for your account, including API calls made through the console, AWS SDKs, command line tools, and other AWS services. This history simplifies security analysis, resource change tracking, and troubleshooting.</p> 
<p>In this post, I describe a solution to notify on changes to CloudTrail and re-enable logging whenever logging is disabled.</p> 
<p><span id="more-744"></span></p> 
<b>Change monitoring and notification</b> 
<p>For this walkthrough, you use an <a href="https://aws.amazon.com/cloudwatch">Amazon CloudWatch Events</a> rule to monitor changes to a CloudTrail trail. An <a href="https://aws.amazon.com/lambda">AWS Lambda</a> function set as a target for this rule contains the logic to detect changes to the trail and publish a message to an <a href="https://aws.amazon.com/sns">Amazon SNS</a> notification. The diagram below depicts the workflow.</p> 
<p>&nbsp;</p> 
<p><img class="aligncenter wp-image-1339 size-full" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/05/Flow_Diagram-1.jpg" alt="" width="1938" height="376" /></p> 
<p>&nbsp;</p> 
<ol> 
<li>An IAM user makes changes to a CloudTrail trail.</li> 
<li>That change event gets detected by a CloudWatch Events rule.</li> 
<li>The rule triggers a Lambda function.</li> 
<li>The function publishes the change event to an SNS topic.</li> 
<li>The SNS topic sends the email to its subscribers.</li> 
<li>If the change event was to disable logging, the function re-enables logging on that trail.</li> 
</ol> 
<p>The CloudWatch Events rule detects the following CloudTrail operational events:</p> 
<ul> 
<li>“StopLogging”</li> 
<li>“StartLogging”</li> 
<li>“UpdateTrail”</li> 
<li>“DeleteTrail”</li> 
<li>“CreateTrail”</li> 
<li>“RemoveTags”</li> 
<li>“AddTags”</li> 
<li>“PutEventSelectors”</li> 
</ul> 
<p>After a “StopLogging” event is detected, the Lambda function re-enables logging for that trail. This generates a “StartLogging” event that again sends an SNS notification.</p> 
<p>&nbsp;</p> 
<b>Walkthrough</b> 
<p>Now, I walk you through creating an SNS topic and subscription, Lambda function, and CloudWatch Events rule. To deploy this solution, download the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/CloudTrailMonitor.json">CloudTrailMonitor.json</a> AWS CloudFormation template. The <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/README.md">README</a> document provides instructions to deploy the stack.</p> 
<b></b> 
<b>Create the SNS topic and subscription</b> 
<p>In the SNS console, choose <strong>Create topic</strong> and enter appropriate values for <strong>Topic name</strong> (such as CloudTrailAlert) and <strong>Display name</strong> (CT-Alert). Choose <strong>Create topic</strong>. Select the topic and view the details.</p> 
<p>Next, choose <strong>Create subscription</strong>.</p> 
<p>For <strong>Protocol</strong>, choose <strong>Email-JSON</strong>. Enter the email address where notifications should be sent and choose <strong>Create subscription</strong>.</p> 
<p>An email is sent to confirm the SNS topic subscription. In the email, open the <strong>SubscribeURL</strong> link to complete the subscription. Note the SNS topic ARN, as it is used later by the Lambda function.</p> 
<p><img class="size-full wp-image-1355 alignnone" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/sid-sns.png" alt="" width="513" height="200" /></p> 
<p>For more information, see <a href="http://docs.aws.amazon.com/sns/latest/dg/CreateTopic.html">Create a Topic</a> in the Amazon SNS Developer Guide.</p> 
<p>&nbsp;</p> 
<b>Create the Lambda function</b> 
<p>In the Lambda console, choose <strong>Functions</strong>, <strong>Create a Lambda function</strong>. Choose Blank Function and on the <strong>Configure trigger page</strong>, choose <strong>Next</strong>.</p> 
<p>On the next page, enter the following values:</p> 
<ul> 
<li><strong>Name:</strong>&nbsp;An appropriate name for the Lambda function</li> 
<li><strong>Runtime:</strong>&nbsp;Python 2.7</li> 
<li><strong>Code entry type:</strong>&nbsp;Upload a ZIP file</li> 
<li><strong>Function package:</strong>&nbsp;Upload the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/Cloudtraillambdamonitor.zip">Cloudtraillambdamonitor.zip</a> file</li> 
<li><strong>Environment variables:</strong> 
<ul> 
<li>Key: SNSARN</li> 
<li>Value: The SNS topic ARN noted earlier</li> 
</ul> </li> 
<li><strong>Handler: </strong>Cloudtraillambdamonitor.lambda_handler</li> 
<li><strong>Role:</strong>&nbsp;Create a custom role (takes you to another page). Call the role CloudTrailLambda.</li> 
</ul> 
<p>For the policy document, enter the following policy:</p> 
<pre><code class="lang-markup">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;LambdaCloudtraiMonitor&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;cloudtrail:DescribeTrails&quot;,
&quot;cloudtrail:GetTrailStatus&quot;,
&quot;cloudtrail:StartLogging&quot;
],
&quot;Resource&quot;: [
&quot;arn:aws:cloudtrail:*:&lt;AWS-ACCOUNT-ID&gt;:trail/*&quot;
]
},
{
&quot;Sid&quot;: &quot;CloudWacthLogspermissions&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;logs:CreateLogGroup&quot;,
&quot;logs:CreateLogStream&quot;,
&quot;logs:PutLogEvents&quot;
],
&quot;Resource&quot;: [
&quot;arn:aws:logs:*:*:*&quot;
]
},
{
&quot;Sid&quot;: &quot;SNSPublishpermissions&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;sns:Publish&quot;
],
&quot;Resource&quot;: [
&quot;arn:aws:sns:*:*:*&quot;
]
}
]
}
</code></pre> 
<p>On the <strong>Configure function</strong> page, choose <strong>Next</strong>. Review the configuration settings before choosing <strong>Create function</strong>.</p> 
<p>For more information, see <a href="http://docs.aws.amazon.com/lambda/latest/dg/get-started-create-function.html"><strong>Step 2.1: Create a Hello World Lambda Function</strong></a> in the <em>AWS Lambda Developer Guide</em>.</p> 
<p>&nbsp;</p> 
<b>Create the CloudWatch Events rule</b> 
<p>In the CloudWatch Events console, choose <strong>Create rule</strong>. Enter the following values:</p> 
<ul> 
<li><strong>Service Name:</strong> &nbsp;CloudTrail</li> 
<li><strong>Event Type:</strong> &nbsp;AWS API call via CloudTrail</li> 
<li><strong>Specific Operations:</strong> &nbsp;StopLogging, StartLogging, UpdateTrail, DeleteTrail, CreateTrail, RemoveTags, AddTags, PutEventSelectors</li> 
</ul> 
<p>For <strong>Targets</strong>, select the name of the Lambda function created earlier and choose <strong>Configure details</strong>. On next page, enter an appropriate name and description for this rule. For <strong>State</strong>, select <strong>Enabled</strong>. Choose <strong>Create rule</strong>.</p> 
<p>For more information, see <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/RunLambdaSchedule.html">Tutorial: Schedule Lambda Functions Using CloudWatch Events</a> in the <em>Amazon CloudWatch Events User Guide</em>.</p> 
<p>&nbsp;</p> 
<b>Validate monitoring</b> 
<p>To validate if the solution is working properly, make a change to CloudTrail and see if you get the notification about this change. The following are some sample emails for when a change in CloudTrail was detected. In this case, logging was disabled and re-enabled automatically.</p> 
<p><img class="alignnone wp-image-1356 size-full" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/sid-stoplogging.png" alt="" width="634" height="319" /></p> 
<p><img class="alignnone wp-image-1357" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/07/06/sid-startlogging.png" alt="" width="634" height="366" /></p> 
<p>&nbsp;</p> 
<b>Summary</b> 
<p>In this post, I explained how to create a solution with CloudWatch Events, Lambda, and SNS to notify you about changes to CloudTrail trails, and to re-enable logging automatically whenever logging is disabled. If you can’t guarantee that your compliance logging is fully managed and automatic, your organizational governance or auditing may be at risk.</p> 
<p>For more information, I recommend the following whitepapers:</p> 
<ul> 
<li><a href="https://d0.awsstatic.com/whitepapers/Security/AWS_Security_Whitepaper.pdf">AWS Security Whitepaper</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Security_at_Scale_Governance_in_AWS_Whitepaper.pdf">Security at Scale: Governance in AWS</a></li> 
<li><a href="https://d0.awsstatic.com/whitepapers/compliance/Automating_Governance_on_AWS.pdf">Automating Governance on AWS</a></li> 
</ul> 
<h3>About the Author</h3> 
<p><img class="alignleft wp-image-747" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/07/10/dp.jpeg" alt="" width="60" height="80" />Sudhanshu Malhotra is a Solutions Architect at AWS Professional Services. Sudhanshu enjoys working with our customers and helping them deliver complex solutions in AWS in the area of DevOps, Infrastructure-as-Code and Config Management. In his spare time, Sudhanshu enjoys spending time with his family, hiking and tinkering with cars.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudtrail/" rel="tag">AWS CloudTrail</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-lambda/" rel="tag">AWS Lambda</a>, <a href="https://aws.amazon.com/blogs/mt/tag/secdevops/" rel="tag">SecDevOps</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Keeping CloudWatch Dashboards up to date using AWS Lambda</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Mike Meaney</span></span> | on 
<time property="datePublished" datetime="2017-07-05T16:12:07+00:00">05 JUL 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-cloudwatch/" title="View all posts in Amazon CloudWatch"><span property="articleSection">Amazon CloudWatch</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/aws-cloudformation/" title="View all posts in AWS CloudFormation"><span property="articleSection">AWS CloudFormation</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/compute/aws-lambda/" title="View all posts in AWS Lambda"><span property="articleSection">AWS Lambda</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/keeping-cloudwatch-dashboards-up-to-date-using-aws-lambda/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>With the launch of the new <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/Welcome.html">CloudWatch Dashboards API</a> and CloudFormation support it is now easy to <a href="https://aws.amazon.com/blogs/aws/new-api-cloudformation-support-for-amazon-cloudwatch-dashboards/">automate your CloudWatch Dashboards</a> and make sure they monitor all the resources that you launched when creating your <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html">CloudFormation stacks</a>.</p> 
<p>Let’s now see how you can use the new CloudWatch Dashboards API to dynamically update your dashboard as EC2 instances are added or removed. When you use auto-scaled EC2 instances for example, EC2 instances may be launched or terminated at any time and if you have a CloudWatch Dashboard monitoring your EC2 resources it can suddenly be monitoring instances that do not exist anymore, and may be missing ones that do exist.</p> 
<b>Use AWS Lambda to keep EC2 instances up to date</b> 
<p>A simple solution is to run the script below periodically in AWS Lambda. The script loads your CloudWatch Dashboards that monitors your instances and updates the EC2 graph widgets if needed.</p> 
<p><span id="more-700"></span></p> 
<p>The script:</p> 
<ul> 
<li>Loads the specified CloudWatch Dashboard(s)</li> 
<li>Looks for all graph widgets displaying EC2 instance metrics</li> 
<li>Calls <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#describeInstances-property">EC2 DescribeInstances API</a> with configured parameters to discover the current EC2 instances for that graph in that region</li> 
<li>Updates the widget if needed</li> 
<li>Saves the CloudWatch Dashboards if any widget definition has changed</li> 
</ul> 
<p>The script is configured via an environment variable <strong>AWS_DASHBOARDS</strong> whose value is a JSON array of the dashboard names that you want to update along with (optional) parameters for <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#describeInstances-property">EC2 DescribeInstances API</a> which sets which EC2 Instances should be displayed on each dashboard.</p> 
<p>Here’s an example that will update a CloudWatch Dashboard called <code>MyAutoScalingDashboard</code> with all running instances in the AutoScaling group called <code>MyAutoScalingGroup</code>:</p> 
<pre><code class="lang-json">[
{
&quot;dashboardName&quot;: &quot; MyAutoScalingDashboard &quot;,
&quot;ec2DescribeInstanceParams&quot;: {
&quot;Filters&quot;: [
{
&quot;Name&quot;: &quot;instance-state-name&quot;,
&quot;Values&quot;: [ &quot;running&quot; ]
},
{
&quot;Name&quot;: &quot;tag:aws:autoscaling:groupName&quot;,
&quot;Values&quot;: [ &quot;MyAutoScalingGroup&quot; ]
}
]
}
}
]
</code></pre> 
<h3>To create the Lambda function:</h3> 
<ol> 
<li>In the <a href="https://console.aws.amazon.com/lambda">Lambda console</a>, choose <strong>Create a Lambda function</strong></li> 
<li>Select <strong>Blank Function</strong> and choose <strong>Next</strong> when asked to configure a trigger.</li> 
<li>For <strong>Name</strong>, enter <code>ec2DashboardUpdater</code></li> 
<li>For <strong>Code entry type</strong> choose <strong>Upload a file from Amazon S3</strong>.</li> 
<li>For <strong>S3 link URL</strong> enter <code>https://s3.amazonaws.com/ec2-dashboard-updater/ec2DashboardUpdater.zip</code></li> 
<li>You’ll need to specify the <code>AWS_DASHBOARDS</code> environment variable with a JSON array for the dashboards you want to update, e.g. with the JSON in the example earlier (no newlines: <pre><code class="lang-json">[{&quot;dashboardName&quot;:&quot;AutoUpdateEC2Dashboard&quot;,&quot;ec2DescribeInstanceParams&quot;:{&quot;Filters&quot;:[{&quot;Name&quot;:&quot;instance-state-name&quot;,&quot;Values&quot;:[&quot;running&quot;]},{&quot;Name&quot;:&quot;tag:aws:autoscaling:groupName&quot;,&quot;Values&quot;:[&quot;test-asg-01&quot;]}]}}]</code></pre> </li> 
<li>Set the <strong>Handler</strong> as <code>ec2DashboardUpdater.handler</code></li> 
<li>For <strong>Role</strong> select <strong>Create a custom role</strong></li> 
<li>In the IAM Console window that opens choose <strong>IAM Role</strong> of <strong>Create a new IAM Role</strong></li> 
<li>Set <strong>Role Name</strong> of <code>ec2DashboardUpdaterRole</code></li> 
<li>Choose <strong>View Policy Document, Edit, Ok</strong>.</li> 
<li>Set the role to: <pre><code class="lang-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;cloudwatch:GetDashboard&quot;,
&quot;cloudwatch:PutDashboard&quot;,
&quot;ec2:DescribeInstances&quot;
],
&quot;Resource&quot;: &quot;*&quot;
}
]
}</code></pre> </li> 
<li>Choose <strong>Allow</strong></li> 
<li>In <strong>Advanced settings</strong> set <strong>Timeout</strong> to a value that is enough to describe all instances for all EC2 graph widgets and load and save all dashboards – set it to <strong>5 min</strong> if unsure</li> 
<li>Select <strong>Next</strong> then <strong>Create function</strong></li> 
</ol> 
<h3>To call the Lambda function periodically:</h3> 
<ol> 
<li>In the <a href="https://console.aws.amazon.com/cloudwatch">CloudWatch console,</a> choose <strong>Rules</strong> in the left navigation pane</li> 
<li>Select <strong>Create rule</strong></li> 
<li>Choose the <strong>Schedule</strong> radio button and set <strong>Fixed rate</strong> of <code>15</code> Minutes</li> 
<li>Select <strong>Add target</strong>, make sure <strong>Lambda function</strong> is active and for <strong>Function</strong> select the previously created <code>ec2DashboardUpdater</code> function</li> 
<li>Choose <strong>Configure details</strong></li> 
<li>Enter <strong>Name</strong> as <code>ec2DashboardUpdaterCron</code></li> 
<li>Select <strong>Create rule</strong></li> 
</ol> 
<p>And that’s it, you’re done. Your selected dashboards will now be kept up to date with your changing EC2 instances hourly. If your EC2 instances do not change from hour to hour then your dashboards will not be updated.</p> 
<p>Please note some limitations of the script:</p> 
<ul> 
<li>It will only update graphs where the first metric is an EC2 instance id metric, such as CPUUtilization, NetworkIn or DiskReadBytes, in the AWS/EC2 namespace.</li> 
<li>It assumes EC2 metrics on a graph all use the same MetricName field.</li> 
<li>All EC2 graphs on a particular dashboard are for the same list of EC2 instances (as specified in the ec2DescribeInstanceParams configuration parameter.</li> 
</ul> 
<p>The (Javascript) code for the script is given below. Feel free to use it as the basis for keeping your CloudWatch Dashboards up to date with other resources.</p> 
<pre><code class="lang-javascript">//
// EC2 Dashboard Updater
// This script will keep EC2 graphs on a chosen list of CloudWatch Dashboards up to date. In the CloudWatch Events
// console create a rule to call this Lambda whenever and EC2 instance changes state.
//
// Configure this script with the AWS_DASHBOARDS environment variable. The content of AWS_DASHBOARDS indicates
// which dashboards to update with which EC2 instances.  The value is an array in JSON format. Each array element
// is an object with two properties, dashboardName and ec2DescribeInstanceParams. dashboardName is the dashboard to
// update and ec2DescribeInstanceParams are parameters to pass to EC2 DescribeInstances API, to determine which
// instances to update the graphs with.
//
// For example, set AWS_DASHBOARDS to the following to keep 'MyDashboard' up to date with the instances in the
// AutoScalingGroup 'MyAutoScalingGroup':
//
// [
//     {
//         dashboardName: 'MyDashboard',
//         ec2DescribeInstanceParams: {
//             Filters: [
//                 {
//                     Name: 'tag:aws:autoscaling:groupName',
//                     Values: [ 'MyAutoScalingGroup' ]
//                 }
//             ]
//         }
//     }
// ]
//
// Limitations:
// - it will only update graphs whose first metric is an EC2 instance metric, all other metrics on the graph
//   will be replaced with these metrics
// - metrics can not have custom periods or statistics, the graph defaults will be used
//
'use strict'
var _ = require('lodash'),
co = require('co'),
AWS = require('aws-sdk'),
EC2_NAMESPACE = 'AWS/EC2',
INSTANCE_ID_DIM = 'InstanceId',
REPEAT_PREVIOUS = '...',
NAME_TAG = 'Name',
METRIC_WIDGET_TYPE = 'metric';
function getDashboards() {
let dashboardDef = process.env.AWS_DASHBOARDS,
dashboards;
if (! dashboardDef) {
throw 'Environment variable AWS_DASHBOARDS is not set. It should be set with JSON array, e.g [{&quot;dashboardName&quot;: &quot;myDashboard&quot;}]';
}
try {
dashboards = JSON.parse(dashboardDef);
} catch (err) {
throw 'Error, AWS_DASHBOARDS is not valid JSON';
}
if (! Array.isArray(dashboards)) {
throw 'Expecting AWS_DASHBOARDS to be an array';
}
return dashboards;
}
function ec2MetricsFromDescribeInstances(ec2DescribeInstances, metricName) {
return _.chain(ec2DescribeInstances.Reservations).
map('Instances').
flatten().
map(function(instance) {
let idAndLabel = {
id: instance.InstanceId,
label: instance.InstanceId
};
_.each(instance.Tags, (tag) =&gt; {        // Use Name tag instead of InstanceId as label, if it exists
if (tag.Key === NAME_TAG) {
idAndLabel.label = tag.Value;
return false;
}
});
return idAndLabel;
}).
sortBy(['label']).
map((idAndLabel, i) =&gt; {
var metric = i == 0 ?
[ EC2_NAMESPACE, metricName, INSTANCE_ID_DIM, idAndLabel.id ] :
[ REPEAT_PREVIOUS, idAndLabel.id ];
if (idAndLabel.id != idAndLabel.label) {
metric.push({label: idAndLabel.label});
}
return metric;
}).
value();
}
function* getEC2Metrics(dashboardContext, region, metricName) {
var params = dashboardContext.dashboard.ec2DescribeInstanceParams || {},
ec2Cache = dashboardContext.ec2Cache,
ec2DescribeInstances;
// ec2Cache is a cache of instance responses per region for the current dashboard, to limit calls to EC2
if (!ec2Cache) {
dashboardContext.ec2Cache = {};
} else if (ec2Cache[region]) {
ec2DescribeInstances = ec2Cache[region];
}
if (!ec2DescribeInstances) {
// Not in cache, call EC2 to get list of regions
let ec2Client = new AWS.EC2({region: region});
ec2DescribeInstances = yield ec2Client.describeInstances(params).promise(),
dashboardContext.ec2Cache[region] = ec2DescribeInstances;
}
return ec2MetricsFromDescribeInstances(ec2DescribeInstances, metricName);
}
function* updateDashboard(cloudwatchClient, dashboardContext, dashboardBody) {
var newDashboard = _.cloneDeep(dashboardBody),
widgets = newDashboard.widgets,
dashboardName = dashboardContext.dashboard.dashboardName;
for (let i = 0; i &lt; widgets.length; i++) {
let widget = widgets[i],
metrics = widget.properties.metrics,
region = widget.region;
// Check to see if it's a metric widget and first metric is an EC2 Instance metric
if (widget.type === METRIC_WIDGET_TYPE &amp;&amp; metrics &amp;&amp; (metrics[0].length === 4 || metrics[0].length === 5) &amp;&amp;
metrics[0][0] === EC2_NAMESPACE &amp;&amp; metrics[0][2] === INSTANCE_ID_DIM) {
let ec2Metrics = yield getEC2Metrics(dashboardContext, region, metrics[0][1]);
widget.properties.metrics = ec2Metrics;
}
}
if (JSON.stringify(dashboardBody) !== JSON.stringify(newDashboard)) {
console.log(`Updating dashboard ${dashboardName} to:`, JSON.stringify(newDashboard));
// Save updated dashboard
yield cloudwatchClient.putDashboard({
DashboardName: dashboardName,
DashboardBody: JSON.stringify(newDashboard)
}).promise();
} else {
console.log(`Dashboard ${dashboardName} is unchanged, update skipped`);
}
}
exports.handler = (event, context, callback) =&gt; {
var dashboards = getDashboards(),
cloudwatchClient = new AWS.CloudWatch(),
dashboard,
dashboardContext;
try {
co(function* () {
for (let i = 0; i &lt; dashboards.length; i++) {
dashboard = dashboards[i];
dashboardContext = { dashboard: dashboard };
if (dashboard.dashboardName) {
let dashboardResponse = yield cloudwatchClient.getDashboard({
DashboardName: dashboard.dashboardName }).promise(),
dashboardBody = JSON.parse(dashboardResponse.DashboardBody);
yield updateDashboard(cloudwatchClient, dashboardContext, dashboardBody);
}
}
callback(null, 'Update complete');
});
} catch (err) {
callback(err);
}
};
</code></pre> 
<p>&nbsp;</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/aws-lambda/" rel="tag">AWS Lambda</a></span> 
</footer> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Join a Microsoft Active Directory Domain with Parameter Store and Amazon EC2 Systems Manager Documents</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Matteo Rinaudo</span></span> | on 
<time property="datePublished" datetime="2017-06-19T10:04:06+00:00">19 JUN 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/mt/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager"><span property="articleSection">Amazon EC2 Systems Manager</span></a>, <a href="https://aws.amazon.com/blogs/mt/category/management-tools/" title="View all posts in Management Tools"><span property="articleSection">Management Tools</span></a></span> | 
<a href="https://aws.amazon.com/blogs/mt/join-a-microsoft-active-directory-domain-with-parameter-store-and-amazon-ec2-systems-manager-documents/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>The process of configuration management can be difficult, in particular when performed at scale. An example could be an application, running on your fleet, which uses configuration values like database connection strings or passwords.</p> 
<p>For deployment best practices, isolate application configuration portions so that you can separately deploy configuration values specific to each environment, for example development and production environments. To ameliorate the security posture of your application, encrypt sensitive configuration values like passwords. From a management standpoint, store configuration values in a central and secure location, instead of storing and maintaining such information on your fleet. Central storage has the advantage of easily maintaining and rotating configuration values in one single place, and it also facilitates auditing changes and access to such configuration values.</p> 
<p><a href="https://aws.amazon.com/ec2/systems-manager/" target="_blank" rel="noopener noreferrer">Amazon EC2 Systems Manager</a> is a management service that helps you configure and manage Amazon EC2 instances and on-premises servers. <a href="https://aws.amazon.com/ec2/systems-manager/parameter-store/" target="_blank" rel="noopener noreferrer">Parameter Store</a> is a Systems Manager feature that makes it easier to reference your configuration data, securely stored in a central location. Parameter Store integrates with other AWS services like <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) and <a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service</a> (AWS KMS). With IAM, you define access control to Systems Manager parameters. With KMS, you can encrypt sensitive information, such as SecureString parameters. API calls made to Systems Manager parameters can be recorded with <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>, so you can audit access or changes to your parameters, for example.</p> 
<p>In this post, I show you a scenario for centralized configuration management, with an example of joining EC2 instances to a Microsoft Active Directory. You launch an EC2 instance that consumes and uses configuration values stored as Systems Manager parameters to join your Active Directory domain. For more information about creating an Active Directory with <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">AWS Directory Service</a> instead, see the <a href="https://aws.amazon.com/blogs/aws/seamlessly-join-ec2-instances-to-a-domain/" target="_blank" rel="noopener noreferrer">Seamlessly Join EC2 Instances to a Domain</a> blog post.</p> 
<p><span id="more-635"></span></p> 
<p>This is the diagram of the example infrastructure you create:</p> 
<p><img class="aligncenter wp-image-638 size-large" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-parameter-store-demo-diagram-1024x576.png" alt="" width="640" height="360" /></p> 
<p><strong>Walkthrough</strong><br /> In this walkthrough, you create an example Active Directory domain to run on a single EC2 instance. Next, you create Systems Manager parameters where you put the following information:</p> 
<ul> 
<li>The Active Directory instance’s private IP address (used as a DNS server for domain members)</li> 
<li>The domain name</li> 
<li>The Active Directory administrator’s user name</li> 
<li>The Active Directory administrator’s password</li> 
</ul> 
<p>Then, you create a KMS customer master key (CMK) that you use to store the Active Directory admin password as an encrypted object in the relevant SecureString parameter.</p> 
<p>Finally, you create an association between a <a href="http://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-ssm-docs.html" target="_blank" rel="noopener noreferrer">Systems Manager document</a>, where an example domain join script is defined, and an EC2 instance that joins the domain. Associations define the state to apply to a set of targets. In your example, the EC2 instance (a target) joins your domain (a state). <a href="https://aws.amazon.com/ec2/systems-manager/state-manager/" target="_blank" rel="noopener noreferrer">State Manager</a>, another Systems Manager feature, uses the association to keep your managed instance in the intended state.</p> 
<p>For this walkthrough, you use the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface</a> (AWS CLI) to create AWS resources. The examples show the us-east-1 region. I’ve also prepared example <a href="https://aws.amazon.com/cloudformation/" target="_blank" rel="noopener noreferrer">AWS CloudFormation</a> templates that you can use to create AWS resources.</p> 
<p><strong>Step 1: &nbsp;Select the AMI</strong><br /> Use an Amazon Machine Image (AMI) for Microsoft Windows 2012 R2 to launch both your example Active Directory instance and the instance you join to the Active Directory domain.</p> 
<p>First, you need the ID of the AMI to use. Generate and choose from a list of AMIs, matching your search pattern. For readability, I’ve broken down the following command (and all the other commands in this post) in multiple lines instead of a single line:</p> 
<pre><code class="lang-bash">aws ec2 describe-images
--owners amazon
--filters
'Name=name,Values=Windows_Server-2012-R2_RTM-English-64Bit-Base-*'
'Name=state,Values=available'
--query 'Images[].[Name, ImageId]'
--output text
--region us-east-1
</code></pre> 
<p>After running the command above, you should get a list with AMI names in the left column, and AMI IDs on the right column. Note the ID of the AMI to use, for example <em>ami-1234abcd</em>.</p> 
<p><strong>Step 2: &nbsp;Create the EC2 key pair</strong><br /> Now, create an Amazon EC2 key pair to use to retrieve Windows passwords for the EC2 instances that you create. Call the key pair <em>your-domain-join-demo</em> and store the private key material on your computer in the <em>your-domain-join-demo.pem</em> file:</p> 
<pre><code class="lang-bash">aws ec2 create-key-pair
--key-name your-domain-join-demo
--query &quot;KeyMaterial&quot;
--output text
--region us-east-1 &gt; your-domain-join-demo.pem
</code></pre> 
<p><strong>Step 3: &nbsp;Create the Active Directory</strong><br /> For this post, you create your example Active Directory on a single EC2 instance, and launch it on a default VPC subnet. The directory’s admin user name is <em>Administrator</em>, and the directory’s admin password is the one retrieved from the instance.</p> 
<p>As part of your example Active Directory creation, specify a value to set up for the restore mode password (SafeModeAdminPassword). The password can have a minimum of 8 characters and contain alphanumeric and special characters.</p> 
<p>You are now ready to create your example Active Directory with CloudFormation. Sign in to the CloudFormation console. Choose <strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ad-single-instance</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ad-single-instance.yaml">ad-single-instance.yaml</a> example template. You can also download the template and use it as a starting point for your own implementation. This template is a modified version of the Microsoft Windows Server Active Directory template found at <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/sample-templates-applications-us-east-1.html" target="_blank" rel="noopener noreferrer">Sample Solutions</a>. I changed it to work with this walkthrough and converted it to YAML.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ad-single-instance&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ad-single-instance.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, choose <strong>Next</strong> and specify the following values&nbsp;for parameters defined in the template:</p> 
<ul> 
<li>The name of the domain to create (example: <em>corp.example.com</em>)</li> 
<li>The NetBIOS name (example: <em>CORP</em>)</li> 
<li>The AMI ID from step 1</li> 
<li>The instance size&nbsp;(example: <em>t2.micro</em>)</li> 
<li>The key pair name from step 2</li> 
<li>The value for your restore mode password</li> 
<li>The IPv4 CIDR block from which you are likely to connect, via RDP (if needed) into your instances</li> 
</ul> 
<p>For more information, see&nbsp;<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-using-console-create-stack-parameters.html" target="_blank" rel="noopener noreferrer">Specifying Stack Name and Parameters</a>.</p> 
<p>In the CloudFormation console, look at the stack you are creating. In the example below, you have just launched your stack and it is in the CREATE_IN_PROGRESS status:</p> 
<p>&nbsp;</p> 
<p><img class="aligncenter wp-image-647 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-domain-join-cfn-stack.png" alt="" width="953" height="188" /></p> 
<p>&nbsp;</p> 
<p>Wait for the stack creation to be in the CREATE_COMPLETE Status. This stack also creates a security group, called DomainMemberSecurityGroup, to be used later by your EC2 instance joining the domain.</p> 
<p><strong>Step 4: &nbsp;Create the KMS CMK</strong><br /> Create the KMS customer master key to encrypt the SecureString parameter that you later create for your directory’s admin password.</p> 
<p>Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-kms-cmk</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/kms-custom-cmk.yaml">kms-custom-cmk.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-kms-cmk&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/kms-custom-cmk.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console,&nbsp;specify the following values for parameters defined in the template:</p> 
<ul> 
<li>The KMS key alias (example: <em>your-domain-join-demo</em>)</li> 
<li>The key description (example: “<em>Example key</em>“)</li> 
</ul> 
<p>When I prepared the example template that describes the KMS key, I added an output, in the template’s <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html" target="_blank" rel="noopener noreferrer">Outputs</a> section, called CMKID. Its value should show the ID of the KMS key created by the stack launched off of the previously mentioned template. When the stack creation is complete, you then describe the Outputs section of the stack to get the ID of the KMS key that you just created:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-kms-cmk
--query &quot;Stacks[0].Outputs[?OutputKey == 'CMKID'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>You need the KMS key ID value later on this walkthrough. Refer to it as YOUR_KMS_KEY_ID.</p> 
<p><strong>Step 5: &nbsp;Create Systems Manager parameters</strong><br /> Start by creating a parameter for the private IP address of the Active Directory instance. You set up this value later on as the DNS server in the DNS client configuration of your instance to join the domain.</p> 
<p>When you created your Active Directory in step 3, in the CloudFormation template that created the instance, you set up output values relevant to the instance configuration, including instance ID and the private IP address of the instance. Retrieve this IP address by describing the Outputs section of the stack that you created on step 3, and by getting the value for the DNSIPAddress output key:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-ad-single-instance
--query &quot;Stacks[0].Outputs[?OutputKey == 'DNSIPAddress'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the IP address that you need, for example <em>172.31.11.22</em>. You could have set up a static private IP address for your Active Directory instance, but for this walkthrough, you just used an IP address that was automatically assigned.</p> 
<p>Now store the value for the IP address in a parameter called <em>your-domain-join-demo-dns-ip-address</em>, as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-dns-ip-address
--description &quot;Example parameter for your DNS server's IP address&quot;
--value '172.31.11.22'
--type String
--region us-east-1
</code></pre> 
<p>Create another parameter where you put the name of the domain you are creating (<em>corp.example.com</em>). Call the parameter <em>your-domain-join-demo-domain-name</em>, as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-domain-name
--description &quot;Example parameter for your domain name&quot;
--value 'corp.example.com'
--type String
--region us-east-1
</code></pre> 
<p>The user name of your directory’s admin, in your example, is <em>Administrator</em>. Create another parameter called <em>your-domain-join-demo-ad-admin-username</em>, where you put this information as a String value:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-ad-admin-username
--description &quot;Example parameter for the username of your AD admin account&quot;
--value 'Administrator'
--type String
--region us-east-1
</code></pre> 
<p>Next, store your directory’s admin password as an encrypted object in another parameter. First, retrieve the Windows password from the Active Directory instance. For this task, you need the instance ID from the Outputs section of the stack created in step 3:</p> 
<pre><code class="lang-bash">aws cloudformation describe-stacks
--stack-name your-domain-join-demo-ad-single-instance
--query &quot;Stacks[0].Outputs[?OutputKey == 'InstanceID'].OutputValue&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the ID of the Active Directory instance, for example <em>i-1234567890abcdef0</em>. Next, retrieve the Windows password for your instance, and decrypt the password with the private key material of the EC2 key pair that you created earlier:</p> 
<pre><code class="lang-bash">aws ec2 get-password-data
--instance-id i-1234567890abcdef0
--priv-launch-key your-domain-join-demo.pem
--query &quot;PasswordData&quot;
--output text
--region us-east-1
</code></pre> 
<p>The command above should return the Windows password for your instance. Refer to this password as YOUR_WINDOWS_PASSWORD_FOR_AD on this step. Next, store YOUR_WINDOWS_PASSWORD_FOR_AD as a SecureString parameter. Create a parameter called <em>your-domain-join-demo-ad-admin-password</em>. Use the KMS CMK, created in step 4, for encryption:</p> 
<pre><code class="lang-bash">aws ssm put-parameter
--name your-domain-join-demo-ad-admin-password
--description &quot;Example parameter for the password of your AD admin account&quot;
--value 'YOUR_WINDOWS_PASSWORD_FOR_AD'
--type SecureString
--key-id YOUR_KMS_KEY_ID
--region us-east-1
</code></pre> 
<p>At the end of this step, you should have four parameters. In the EC2 console, view your parameters:</p> 
<p><img class="aligncenter wp-image-649 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-parameter-store-resources.png" alt="" width="617" height="570" /></p> 
<p>&nbsp;</p> 
<p><strong>Step 6: &nbsp;Create the IAM role for the EC2 instance</strong><br /> On this step, you create an IAM role to be used by your instance joining the domain, via an IAM instance profile, to get read-only access to Systems Manager parameters. The example template describes a role to which the AmazonEC2RoleforSSM managed policy is attached. An example policy is also attached to the role, and a snippet of this policy is shown below:</p> 
<pre><code class="lang-json">[…]
{
&quot;Action&quot;: [
&quot;kms:Decrypt&quot;
],
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Resource&quot;: &quot;THE_ARN_OF_YOUR_KMS_KEY&quot;
}
[…]
</code></pre> 
<p>The example policy above allows kms:Decrypt API calls for the KMS key resource that you created earlier. In the policy snippet, you reference the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the KMS CMK, that you see in the relevant placeholder in capital letters above.</p> 
<p>When editing templates for this walkthrough, I used the CloudFormation feature to <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-exports.html" target="_blank" rel="noopener noreferrer">export stack output values</a>, to facilitate passing values between stacks. The stack that you are creating now needs the ARN of the KMS CMK created earlier, so that it can be referenced in the IAM policy for the role.</p> 
<p>You have already exported the KMS CMK ARN from the stack that created the CMK. You can now import and reference the ARN by specifying the name of the CMK stack (in your example: <em>your-domain-join-demo-kms-cmk</em>) as a parameter to the stack you are creating for the role. Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ec2-instance-role</em>&nbsp;with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance-role.yaml">ec2-instance-role.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ec2-instance-role&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance-role.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the <em>your-domain-join-demo-kms-cmk</em> parameter value.</p> 
<p>Then, wait for the stack creation to complete and continue with the next step.</p> 
<p><strong>Step 7: &nbsp;Create the Systems Manager document</strong><br /> Create, with an example CloudFormation template, the Systems Manager document that contains commands to execute on the EC2 instance for it to join your domain. In the document, specify the parameter names that you created earlier. Pass these names to the CloudFormation stack that creates the document.</p> 
<p>The example code below depicts a portion of an example Systems Manager document. You can see how this document uses the !Sub short form of the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html" target="_blank" rel="noopener noreferrer">Fn::Sub</a> intrinsic function in CloudFormation to reference stack parameters (for example, the DNSParameterStore parameter):</p> 
<pre><code class="lang-yaml">[…]
Document:
Type: AWS::SSM::Document
Properties:
Content:
description: Run a PowerShell script to domain join a Windows instance securely
mainSteps:
- action: aws:runPowerShellScript
inputs:
runCommand:
- '# Example PowerShell script to domain join a Windows instance securely'
- ''
- $ErrorActionPreference = 'Stop'
- ''
- try{
- '    # Parameter names'
- !Sub '    $dnsParameterStore = ''${DNSParameterStore}'''
- !Sub '    $domainNameParameterStore = ''${DomainNameParameterStore}'''
- !Sub '    $domainJoinUserNameParameterStore = ''${DomainJoinUserNameParameterStore}'''
- !Sub '    $domainJoinPasswordParameterStore = ''${DomainJoinPasswordParameterStore}'''
- ''
- '    # Retrieve configuration values from parameters'
- '    $ipdns = (Get-SSMParameterValue -Name $dnsParameterStore).Parameters[0].Value'
- '    $domain = (Get-SSMParameterValue -Name $domainNameParameterStore).Parameters[0].Value'
- '    $username = $domain + ''\'' + (Get-SSMParameterValue -Name $domainJoinUserNameParameterStore).Parameters[0].Value'
- '    $password = (Get-SSMParameterValue -Name $domainJoinPasswordParameterStore
-WithDecryption $True).Parameters[0].Value | ConvertTo-SecureString
-asPlainText -Force'
[…]
</code></pre> 
<p>Create the document with a stack. Choose&nbsp;<strong>Launch Stack</strong>&nbsp;below to create the stack called&nbsp;<em>your-domain-join-demo-ssm-document-domain-join&nbsp;</em>with the <a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm-document-domain-join.yaml">ssm-document-domain-join.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ssm-document-domain-join&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ssm-document-domain-join.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the following values for parameters defined in the template:</p> 
<ul> 
<li><em>your-domain-join-demo-dns-ip-address</em></li> 
<li><em>your-domain-join-demo-ad-admin-password</em></li> 
<li><em>your-domain-join-demo-ad-admin-username</em></li> 
<li><em>your-domain-join-demo-domain-name</em></li> 
</ul> 
<p>After the stack creation is complete, you should find your new document listed in the Documents page in the console:</p> 
<p><img class="aligncenter wp-image-650 size-full" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-ssm-document.png" alt="" width="547" height="169" /></p> 
<p>&nbsp;</p> 
<p><strong>Step 8: &nbsp;Launch the instance and join the domain</strong><br /> On this last step, use CloudFormation to create an EC2 instance based on the Microsoft Windows 2012 R2 AMI you chose in step 1.</p> 
<p>After the instance starts up, it is associated to the document you created in the previous step, and should then join the domain after running the script in the document. When you create the stack for the instance, you import values that you have exported in other stacks, so you can easily reference the values you need. Specify the names of the stacks that created the Active Directory domain and the Systems Manager document, so you can reference the following:</p> 
<ul> 
<li>The ID of the domain member security group for your EC2 instance</li> 
<li>The name of the document for the association between the document and instance</li> 
</ul> 
<p>Now, create the instance. Choose <strong>Launch Stack</strong> below to create the stack called&nbsp;<em>your-domain-join-demo-ec2-instance</em>&nbsp;with the&nbsp;<a href="https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance.yaml">ec2-instance.yaml</a> example template.</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=your-domain-join-demo-ec2-instance&amp;templateURL=https://s3-us-west-2.amazonaws.com/management-tools-blog-cf-template-storage/ec2-instance.yaml" target="_blank" rel="noopener noreferrer"><img class="alignnone size-full wp-image-99" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" alt="" width="107" height="20" /></a></p> 
<p>In the CloudFormation console, specify the following values for parameters defined in the template:</p> 
<ul> 
<li><em>your-domain-join-demo-ad-single-instance</em></li> 
<li><em>your-domain-join-demo-ssm-document-domain-join</em></li> 
<li>The AMI ID from step 1</li> 
<li><em>your-domain-join-demo-ec2-instance-role</em></li> 
<li>The instance size (in your example: <em>t2.micro</em>)</li> 
<li>The key pair name from step 2</li> 
</ul> 
<p>Wait for the stack creation to complete. At the end of the process, your instance should have joined your <em>corp.example.com</em> domain. In the EC2 console, State Manager should show that the association between the Systems Manager document and the instance is successful:</p> 
<p><img class="aligncenter wp-image-651 size-large" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/example-state-manager-1024x446.png" alt="" width="640" height="279" /></p> 
<p>&nbsp;</p> 
<p>Verify that the machine joined the domain by connecting via RDP to the instance with your Active Directory admin credentials.</p> 
<p><strong>Conclusion</strong><br /> In this post, I showed you how to use Parameter Store to set up configuration values in a central and secure location. Using Parameter Store, you securely stored the configuration values needed for your EC2 instance to join the domain. You also stored the admin password for the example Active Directory as a SecureString parameter, and used a KMS key for encryption. Then, you launched an EC2 instance associated with a Systems Manager document, ran a custom script on the instance, and joined your example domain.</p> 
<p><strong>About the Author</strong><br /> <img class="alignleft wp-image-661 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/06/14/matteo-rinaudo-150x150.png" alt="" width="150" height="150" />Matteo Rinaudo is a Sr. Consultant at AWS Professional Services. Matteo enjoys working with our customers to deliver solutions and best practices around DevOps automation, infrastructure-as-code and configuration management. In his spare time, Matteo enjoys spending time with his wife, playing the trumpet, the piano, and listening to classical music.</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/mt/tag/aws-cloudformation/" rel="tag">AWS CloudFormation</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-systems-manager/" rel="tag">EC2 Systems Manager</a>, <a href="https://aws.amazon.com/blogs/mt/tag/ec2-windows/" rel="tag">EC2 Windows</a>, <a href="https://aws.amazon.com/blogs/mt/tag/parameter-store/" rel="tag">Parameter Store</a>, <a href="https://aws.amazon.com/blogs/mt/tag/run-command/" rel="tag">Run Command</a>, <a href="https://aws.amazon.com/blogs/mt/tag/state-manager/" rel="tag">State Manager</a></span> 
</footer> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
