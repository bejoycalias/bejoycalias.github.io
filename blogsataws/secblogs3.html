<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/secblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Security Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Security Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li class="active"><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="secblogs1.html">Page 1</a>|<a href="secblogs2.html">Page 2</a>|<a href="secblogs3.html">Page 3</a>|<a href="secblogs4.html">Page 4</a</p>
<br>
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Enable Your Users to Access Office 365 with AWS Microsoft Active Directory Credentials</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Darryn Hendricks</span></span> and 
<span property="author" typeof="Person"><span property="name">Ron Cully</span></span> | on 
<time property="datePublished" datetime="2017-09-14T06:48:01+00:00">14 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-directory-service/" title="View all posts in AWS Directory Service*"><span property="articleSection">AWS Directory Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-enable-your-users-to-access-office-365-with-aws-microsoft-active-directory-credentials/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4898" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4898&amp;disqus_title=How+to+Enable+Your+Users+to+Access+Office+365+with+AWS+Microsoft+Active+Directory+Credentials&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-enable-your-users-to-access-office-365-with-aws-microsoft-active-directory-credentials/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4898');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>You can now enable your users to access Microsoft Office 365 with credentials that you manage in <a href="https://aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">AWS Directory Service for Microsoft Active Directory</a>, also known as AWS Microsoft AD. You can accomplish this by deploying <a href="https://www.microsoft.com/en-us/download/details.aspx?id=47594" target="_blank" rel="noopener noreferrer">Microsoft Azure Active Directory (AD) Connect</a> and <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/install-the-ad-fs-role-service" target="_blank" rel="noopener noreferrer">Active Directory Federation Services for Windows Server 2016 (AD FS 2016)</a> with AWS Microsoft AD. AWS Microsoft AD makes it possible and easy for you to build a Windows environment in the AWS Cloud, synchronize your AWS Microsoft AD users into Microsoft Azure AD, and use Office 365, all without needing to create and manage <a href="https://technet.microsoft.com/en-us/library/cc786438(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">AD domain controllers</a>.&nbsp;Now you can also benefit from the broad set of AWS Cloud services for compute, storage, database, and Internet of Things (IoT) while continuing to use Office 365 business productivity apps—all with a single AD domain.</p> 
<p>Office 365 provides different options to support user authentication with identities that come from AD. One common way to do this is to use Azure AD Connect and AD&nbsp;FS together with your AD directory. In this model, you use Azure AD Connect to synchronize user names from AD into Azure AD so that Office 365 can use those identities. To complete this solution, you use AD&nbsp;FS to enable Office 365 to authenticate the identities against your AD directory. Good news: AWS Microsoft AD now supports this model!</p> 
<p>In this blog post, we show how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD so that your employees can access Office 365 by using their AD credentials.<span id="more-4898"></span></p> 
<h3><strong>Prerequisites</strong></h3> 
<p>The instructions in this post assume that you understand how to <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">create Amazon EC2 for Windows Server instances</a>, know how to <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/connecting_to_windows_instance.html" target="_blank" rel="noopener noreferrer">use Remote Desktop Protocol (RDP) to log in to the instances</a>, and already have completed the following tasks:</p> 
<ol> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/create_managed_ad.html" target="_blank" rel="noopener noreferrer">Create an AWS Microsoft AD directory</a>.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server</a> instance to your AWS Microsoft AD domain to use as a management instance (<span style="font-family: courier">Management</span>).</li> 
<li>Install <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/install_ad_tools.html" target="_blank" rel="noopener noreferrer">Active Directory Administration Tools</a> on your <span style="font-family: courier">Management</span> instance.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server 2016</a> instance to the AWS Microsoft AD domain to use as your <span style="font-family: courier">ADFS</span> server. We show you how to install AD&nbsp;FS later.</li> 
<li><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">Join an Amazon EC2 for Windows Server</a> instance to the AWS Microsoft AD domain you use as your <span style="font-family: courier">ADSync</span> server. We will show you how to install Azure AD Connect on this instance later.</li> 
<li>Using Active Directory Users and Computers on your <span style="font-family: courier">Management</span> instance, <a href="https://technet.microsoft.com/en-us/library/dd894463(v=ws.10).aspx" target="_blank" rel="noopener noreferrer">create a standard user</a> named <span style="font-family: courier">ADFSSVC</span> in your AWS Microsoft AD directory. AD&nbsp;FS uses this user account later.</li> 
<li><a href="https://support.office.com/en-us/article/How-to-sign-up-for-Office-365-Admin-Help-9b23c065-eef9-4bf7-acf5-127eb46d5e67?ui=en-US&amp;rs=en-US&amp;ad=US" target="_blank" rel="noopener noreferrer">Create an active Office 365 subscription</a>.</li> 
<li>Add and verify your <a href="https://support.office.com/en-ie/article/Add-a-domain-and-users-to-Office-365-6383f56d-3d09-4dcb-9b41-b5f5a5efd611?ui=en-US&amp;rs=en-IE&amp;ad=IE#ID0EAABAAA=_Step_1" target="_blank" rel="noopener noreferrer">domain</a> in Office 365</li> 
</ol> 
<p><strong>Note:</strong> You must use RDP and sign in with the AWS Microsoft AD <span style="font-family: courier">admin</span> account using the password you specified when you created your AWS Microsoft AD directory when performing Steps 3 and 6 in this “Prerequisites” section.</p> 
<p>The following diagram illustrates the environment you must have in place to implement the solution in this blog post (the numbers in the diagram correspond to Steps 1–8 earlier in this section). We build on this configuration to install and configure Azure AD Connect and AD&nbsp;FS with Azure AD and Office 365.</p> 
<p><img class="alignnone wp-image-5005 size-full" title="Diagram illustrating the environment you must have in place to implement the solution in this blog post" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-Diagram1-h.png" alt="Diagram illustrating the environment you must have in place to implement the solution in this blog post" width="816" height="720" /></p> 
<p><strong>Note:</strong> In this blog post, we use separate Microsoft Windows Server instances on which to run AD&nbsp;FS and Azure AD Connect. You can choose to combine these on a single server, as long as you use Windows Server 2016. Though it is technically possible to use an on-premises server as the AD&nbsp;FS and Azure AD host, such a configuration is counter to the idea of a Windows environment completely in the cloud. Also, this requires configuration of firewall ports and AWS security groups, which is beyond the scope of this blog.</p> 
<h3><strong>Configuration background</strong></h3> 
<p>When you create an AWS Microsoft AD directory, AWS exclusively retains the enterprise administrator account of the forest and domain <span style="font-family: courier">administrator</span> account for the root domain to deliver the directory as a managed service. When you set up your directory, AWS creates an organizational unit (OU) in the directory and delegates administrative privileges for the OU to your <span style="font-family: courier">admin</span> account. Within this OU, you administer users, groups, computers, Group Policy objects, other devices, and additional OUs as needed. You perform these actions using standard AD administration tools from a computer that is joined to an AWS Microsoft AD domain. Typically, the administration computer is an EC2 instance that you access using RDP, by logging in with your <span style="font-family: courier">admin</span> account credentials. From your <span style="font-family: courier">admin</span> account, you can also delegate permissions to other users or groups you create within your OU.</p> 
<p>To use Office 365 with AD identities, you use Azure AD Connect to synchronize the AD identities into Azure AD. There are two commonly supported ways to use Azure AD Connect to support Office 365 use. In one model, you synchronize user names only, and you use AD&nbsp;FS to federate authentication from Office 365 to your AD. In the second model, you synchronize user names and passwords from your AD directory to Azure AD, and you do not have to use AD&nbsp;FS. The model supported by AWS Microsoft AD is the first model: synchronize user names only and use AD&nbsp;FS to authenticate from Office 365 to your AWS Microsoft AD. The AD&nbsp;FS model also enables authentication with SaaS applications that support federated authentication (this topic is beyond the scope of this blog post).</p> 
<p><strong>Note:</strong> Azure AD Connect now has a <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication" target="_blank" rel="noopener noreferrer">pass-through model</a> of authentication. Because this was in a preview status at the time of writing this blog post, this authentication model is beyond the scope of this blog post.</p> 
<p>In a default AD&nbsp;FS installation, AD&nbsp;FS uses two containers that require special AD permissions that your AWS Microsoft AD administrative account does not have. To address this, you will create two nested containers in your OU for AD&nbsp;FS to use. When you install AD&nbsp;FS, you tell AD&nbsp;FS where to find the containers through a Windows PowerShell parameter.</p> 
<p>As described previously, we will now show you how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD with Azure AD and Office 365 in five steps, as illustrated in the following diagram.</p> 
<p><img class="alignnone wp-image-5006 size-full" title="Diagram including the five steps in this blog post" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-Diagram2-f.png" alt="Diagram including the five steps in this blog post" width="816" height="764" /></p> 
<ol> 
<li>Add two containers to AWS Microsoft AD for use by AD&nbsp;FS.</li> 
<li>Install AD&nbsp;FS.</li> 
<li>Integrate AD&nbsp;FS with Azure AD.</li> 
<li>Synchronize users from AWS Microsoft AD to Azure AD with Azure AD Connect.</li> 
<li>Sign in to Office 365 by using your Microsoft AD identities.</li> 
</ol> 
<h3><strong>Step 1: Add two containers to AWS Microsoft AD for use by AD&nbsp;FS</strong></h3> 
<p>The following steps show how to create the AD containers required by AD&nbsp;FS in your AWS Microsoft AD directory.</p> 
<p>From the <span style="font-family: courier">Management</span> instance:</p> 
<ol> 
<li>Generate a random global unique identifier (GUID) using the following Windows PowerShell command. 
<pre><code class="lang-text">(New-Guid).Guid</code></pre> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4962 size-full" title="Screenshot of the (New-Guid).Guid Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-sc1-a.png" alt="Screenshot of the (New-Guid).Guid Windows PowerShell command" width="900" height="151" /><br /> Make a note of the GUID output because it will be required later on. In this case, the GUID is <span style="font-family: courier">67734c62-0805-4274-b72b-f7171110cd56.</span></p> 
<ol start="2"> 
<li>Create a container named <span style="font-family: courier">ADFS</span> in your OU. The OU is located in the domain root and it has the same name as the NetBIOS name you specified when you created your AWS Microsoft AD directory. In this example, our OU name is <span style="font-family: courier">AWS</span>, and our domain is <span style="font-family: courier">DC=<strong>awsexample</strong>,DC=<strong>com</strong></span>. You create the container by running the following Windows PowerShell command. You must replace the names that are in bold text with the names from your AWS Microsoft AD directory. 
<pre><code class="lang-text">New-ADObject -Name &quot;<strong>ADFS</strong>&quot; -Type Container -Path “OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>”</code></pre> 
<p><img class="alignnone wp-image-4963 size-full" title="Screenshot of the Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/RC0917-sc2-a.png" alt="Screenshot of the Windows PowerShell command" width="900" height="131" /></p> 
<li>Create another AD container in your new <span style="font-family: courier">ADFS</span> container, and use the previously generated GUID as the name. Do this by running the following Windows PowerShell command. Be sure to replace the names in bold text with the names from your AWS Microsoft AD directory and your GUID. In this example, we replace <span style="font-family: courier">GUID</span> with <span style="font-family: courier">67734c62-0805-4274-b72b-f7171110cd56</span>. The other bold items shown match the names in our example AWS Microsoft AD directory. 
<pre><code class="lang-text">New-ADObject -Name &quot;<strong>GUID</strong>&quot; -Type Container -Path “CN=<strong>ADFS</strong>,OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>”</code></pre> 
</ol> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4997 size-full" title="Screenshot of the Windows PowerShell command" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P3-GUIDContainer.png" alt="Screenshot of the Windows PowerShell command" width="900" height="149" /><br /> To verify that you successfully created the <span style="font-family: courier">ADFS</span> and <span style="font-family: courier">GUID</span> containers, open Active Directory Users and Computers and navigate to the containers you created. Your root domain, OU name, and GUID name should match your AWS Microsoft AD configuration.<br /> <img class="alignnone wp-image-4998 size-full" title="Screenshot showing the successful creation of the ADFS and GUID containers" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P4-ADUC.png" alt="Screenshot showing the successful creation of the ADFS and GUID containers" width="557" height="210" /></p> 
<p style="padding-left: 30px"><strong>Note:</strong> If you do not see the <span style="font-family: courier">ADFS</span> and <span style="font-family: courier">GUID</span> containers, turn on Advanced Features by choosing <strong>View</strong> in the Active Directory Users and Computers tool, and then choosing <strong>Advanced Features</strong>.</p> 
<h3><strong>Step 2: Install AD&nbsp;FS</strong></h3> 
<p>In this section, we show how to install AD&nbsp;FS by using Windows PowerShell commands. First, though, select a federation service name for your AD&nbsp;FS server. You can create your federation service name by adding a short name (for example, <span style="font-family: courier">sts</span>) followed by your domain name (for example, <span style="font-family: courier">awsexample.com</span>). In this example, we use <span style="font-family: courier">sts.awsexample.com</span> as the federation service name.</p> 
<p>Using your AWS Microsoft AD <span style="font-family: courier">admin</span> account, open an RDP session to your <span style="font-family: courier">ADFS</span> instance, run Windows PowerShell as a local administrator, and complete the following steps:</p> 
<ol> 
<li>Install the Windows feature, AD&nbsp;FS, by running the following Windows PowerShell command. This command only adds the components needed to install your <span style="font-family: courier">ADFS</span> server later. 
<pre><code class="lang-text">Install-WindowsFeature ADFS-Federation</code></pre> 
<li>Now that you have installed AD&nbsp;FS, you must obtain a certificate for use when you configure your <span style="font-family: courier">ADFS</span>&nbsp;server. The AD&nbsp;FS certificate plays an important role to secure communication between the <span style="font-family: courier">ADFS</span> server and clients, and to ensure tokens issued by the <span style="font-family: courier">ADFS</span> server are secured. AWS recommends that you use a certificate from a trusted Certificate Authority (CA).</li> 
</ol> 
<p style="padding-left: 30px">In our example, we use the SSL certificate, <span style="font-family: courier">sts.awsexample.com</span>. It is important to note that the common name and <span style="font-family: courier">subject alternative name</span> (<span style="font-family: courier">SAN</span>) must include the federation service name we plan to use for the AD&nbsp;FS server. In our example, the name is <span style="font-family: courier">sts.awsexample.com</span>.</p> 
<p>Install the certificate on the AD&nbsp;FS server using the <a href="https://technet.microsoft.com/en-us/library/cc754431(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">Microsoft Management Console (MMC) snap-in for certificates</a> by following these steps:</p> 
<ol> 
<li>Open a command prompt window.</li> 
<li>Type <span style="font-family: courier">mmc</span> and press <strong>Enter</strong>.</li> 
<li>Choose <strong>File</strong>, choose <strong>Add/Remove</strong> snap-in, and choose <strong>Add</strong>.</li> 
<li>For <strong>Add Standalone</strong> <strong>Snap-in</strong>, choose <strong>Certificates</strong> and then choose <strong>Add</strong>.</li> 
<li>For the <strong>Certificates</strong> snap-in, choose <strong>Computer account</strong> and then choose <strong>Next</strong>.</li> 
<li>Choose <strong>Finish</strong>, and then choose <strong>OK</strong> to load the <strong>Certificates</strong> snap In.</li> 
<li>Expand <strong>Certificates (Local Computer).</strong></li> 
<li>Right-click <strong>Personal</strong>, choose <strong>All Tasks</strong>, and then choose <strong>Import</strong>.</li> 
<li>On the <strong>Certificate Import Wizard</strong>, choose <strong>Next</strong>.</li> 
<li>Choose <strong>Browse</strong> to locate and select your certificate that has been given by your CA. Choose <strong>Next</strong>.</li> 
<li>Ensure <strong>Certificate store</strong> is set to <strong>Personal</strong>, and choose <strong>Next</strong>.</li> 
<li>Choose <strong>Finish</strong> and <strong>OK</strong> to complete the installation of the certificate on the AD&nbsp;FS server.</li> 
</ol> 
<p>Next you need to retrieve the <span style="font-family: courier">Thumbprint</span> value of the newly installed certificate and save it for use when you configure your <span style="font-family: courier">ADFS</span> server. Follow the remaining steps:</p> 
<ol start="13"> 
<li>In the <strong>Certificates</strong> console window, expand <strong>Personal</strong>, and choose <strong>Certificates</strong>.</li> 
<li>Right-click the certificate, and then choose <strong>Open</strong>.</li> 
<li>Choose the <strong>Details tab</strong> to locate the <strong>Thumbprint</strong></li> 
</ol> 
<p style="padding-left: 30px"><strong><img class="alignnone wp-image-4999 size-full" title="Screenshot of the Thumbprint value" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P5-Thumbprint.png" alt="Screenshot of the Thumbprint value" width="512" height="126" /><br /> Note:</strong> In this case, we will copy our certificate <span style="font-family: courier">Thumbprint</span>, <span style="font-family: courier">d096652327cfa18487723ff61040c85c7f57f701</span>, and save it in Windows Notepad.</p> 
<ol start="16"> 
<li>Open an RDP session to your <span style="font-family: courier">ADFS</span> server by using the <span style="font-family: courier">admin</span> account for your AWS Microsoft AD directory. Install AD&nbsp;FS by running the following Windows PowerShell command. You must replace the bold strings in the command with the GUID you created in Step 1 and the names from your AWS Microsoft AD directory. 
<pre><code class="lang-text">$adminConfig = @{&quot;DKMContainerDn&quot;=&quot;CN=<strong>GUID</strong>,CN=ADFS,OU=<strong>YourNetBIOSName</strong>,DC=<strong>YourDomainSuffix</strong>,DC=<strong>YourDomainRoot</strong>&quot;}</code></pre> 
</ol> 
<ol start="17"> 
<li>Enter the AD&nbsp;FS standard user account credentials for the <span style="font-family: courier">ADFSSVC</span> user and save it in the script variable, <span style="font-family: courier">$svcCred</span>, by running the following Windows PowerShell command. 
<pre><code class="lang-text">$svcCred = (get-credential)</code></pre> 
<p><img class="alignnone wp-image-5000 size-full" title="Screenshot of entering the user account credentials for the ADFSSVC user" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P6-ADFSSVC.png" alt="Screenshot of entering the user account credentials for the ADFSSVC user" width="662" height="422" /></p> 
</ol> 
<ol start="18"> 
<li>Type the Microsoft AD administrator credentials of the <span style="font-family: courier">Admin</span> user and save it in the script variable, <span style="font-family: courier">$localAdminCred</span>, by running the following Windows PowerShell command. 
<pre><code class="lang-text">$localAdminCred = (get-credential)</code></pre> 
<p><img class="alignnone wp-image-5001 size-full" title="Screenshot of entering the credentials of the Admin user" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P7-ADMIN.png" alt="Screenshot of entering the credentials of the Admin user" width="667" height="422" /></p> 
</ol> 
<ol start="19"> 
<li>Install the AD&nbsp;FS server by running the following Windows PowerShell command. You must replace the bold items with the <span style="font-family: courier">Thumbprint</span> ID from your certificate, and replace the federation service name with the federation service name you chose earlier. For our example, the federation service name is <span style="font-family: courier">awsexample.com</span> and we copy our certificate <span style="font-family: courier">Thumbprint</span>, <span style="font-family: courier">d096652327cfa18487723ff61040c85c7f57f701</span>, from where we saved it in Windows Notepad.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> Be sure to remove any empty spaces in the certificate <span style="font-family: courier">Thumbprint</span> value.</p> 
<pre style="padding-left: 30px"><code class="lang-text">Install-ADFSFarm -CertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong> -FederationServiceName &quot;<strong>YourFederationServiceName</strong>&quot; -ServiceAccountCredential $svcCred -Credential $localAdminCred -OverwriteConfiguration -AdminConfiguration $adminConfig -SigningCertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong> -DecryptionCertificateThumbprint <strong>&lt;Thumbprint ID&gt;</strong></code></pre> 
<ol start="20"> 
<li>Create a DNS A record for use with AD&nbsp;FS. This record resolves the federation service name to the public IP address you assign to your <span style="font-family: courier">ADFS</span> instance. You must create the DNS A record at the DNS hosting provider that hosts your domain. In the following example, <span style="font-family: courier">sts.awsexample.com</span> is the federation service name and <span style="font-family: courier">54.x.x.x</span> is the public IP address of our AD&nbsp;FS instance. 
<ul style="margin-left: 10px"> 
<li><strong>Hostname:</strong><span style="font-family: courier"> awsexample.com</span></li> 
<li><strong>Record Type:</strong> <span style="font-family: courier">A</span></li> 
<li><strong>IP Address:</strong> <span style="font-family: courier">x.x.x</span></li> 
</ul> </li> 
</ol> 
<ol start="21"> 
<li>Enable the AD&nbsp;FS sign-in page by running the following Windows PowerShell command. 
<pre><code class="lang-text">Set-ADFSProperties -EnableIdpInitiatedSignonPage $true</code></pre> 
</ol> 
<ol start="22"> 
<li>To verify that the AD&nbsp;FS sign-in page works, open a browser on the AD&nbsp;FS instance, and sign in on the AD&nbsp;FS sign-in page (https://&lt;<em>my</em> <em>federation service name</em>&gt;/ADFS/ls/IdpInitiatedSignOn.aspx) by using your AWS Microsoft AD <span style="font-family: courier">admin</span>&nbsp;account. In our example, the federation service name (&lt;<em>my federation service name</em>&gt; in the sign-in page URL) is <span style="font-family: courier">sts.awsexample.com</span>.</li> 
</ol> 
<h3><strong>Step 3: Integrate AD&nbsp;FS with Azure AD </strong></h3> 
<p>The following steps show you how to connect AD&nbsp;FS with Office 365 by connecting to Azure AD with Windows PowerShell and federating the custom domain.From the <span style="font-family: courier">ADFS</span> instance, make sure you run Windows PowerShell as a local administrator and complete the following steps:</p> 
<ul> 
<li><a href="https://docs.microsoft.com/en-us/powershell/azure/active-directory/install-msonlinev1?view=azureadps-1.0" target="_blank" rel="noopener noreferrer">Connect to Azure AD using Windows PowerShell</a>.<br /> Federate the custom domain you added and verified in Azure AD by running the following two Windows PowerShell commands. You must update the items in bold text with the names from your AWS Microsoft AD directory. For our example, our AD&nbsp;FS instance’s Fully Qualified Domain Name (FQDN) is <span style="font-family: courier">adfsserver.awsexample.com</span>, and our domain name is <span style="font-family: courier">awsexample.com</span>.<p></p> 
<pre><code class="lang-text">Set-MsolADFSContext –computer <strong>&lt;ADFS instance FQDN&gt;</strong>
Convert-MsolDomainToFederated –domain <strong>&lt;Domain name&gt;</strong></code></pre> 
</ul> 
<h3><strong>Step 4: Synchronize users from AWS Microsoft AD to Azure AD with Azure AD Connect</strong></h3> 
<p>The following steps show you how to install and customize Azure AD Connect to synchronize your AWS Microsoft AD identities to Azure AD for use with Office 365.Open an RDP session to your <span style="font-family: courier">ADSync</span> instance by using your AWS Microsoft AD <span style="font-family: courier">admin</span> user account:</p> 
<ol> 
<li>Download <a href="https://download.microsoft.com/download/B/0/0/B00291D0-5A83-4DE7-86F5-980BC00DE05A/AzureADConnect.msi" target="_blank" rel="noopener noreferrer">Azure AD Connect</a>.</li> 
<li>On the <strong>Welcome</strong> page of the Azure AD Connect Wizard, accept the license terms and privacy notice, and then choose <strong>Continue</strong>.</li> 
<li>On the <strong>Express Settings</strong> page, choose <strong>Customize</strong>.</li> 
<li>On the <strong>Install required components</strong> page, choose <strong>Install</strong>.</li> 
<li>On the <strong>User sign-in page</strong>, choose <strong>Do not configure</strong> and then choose <strong>Next</strong>.</li> 
<li>On the <strong>Connect to Azure AD</strong> page, enter your Office 365 <a href="https://support.office.com/en-ie/article/Assign-admin-roles-eac4d046-1afd-4f1a-85fc-8219c79e1504?ui=en-US&amp;rs=en-IE&amp;ad=IE" target="_blank" rel="noopener noreferrer">global administrator</a> account credentials and then choose <strong>Next</strong>.</li> 
<li>On the <strong>Connect your directories</strong> page, choose <strong>Active Directory</strong> as the <strong>Directory Type</strong>, and then choose your <strong>Microsoft AD Forest</strong> as your <strong>Forest</strong>. Choose <strong>Add Directory</strong>.</li> 
<li>At the prompt, enter your AWS Microsoft AD <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/admin_permissions.html" target="_blank" rel="noopener noreferrer">admin account</a> credentials, and then choose <strong>OK</strong>.</li> 
<li>Now that you have added the AWS Microsoft AD directory, choose <strong>Next</strong>.</li> 
<li>On the Azure AD sign-in configuration page, choose <strong>Next</strong>.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> AWS recommends the <span style="font-family: courier">userPrincipalName</span> (<span style="font-family: courier">UPN</span>) attribute for use by AWS Microsoft AD users when they sign in to Azure AD and Office 365. The <span style="font-family: courier">UPN</span> attribute format combines the user’s login name and the <span style="font-family: courier">UPN</span>-suffix of an AWS Microsoft AD user. The <span style="font-family: courier">UPN</span> suffix is the domain name of your AWS Microsoft AD domain and the same domain name you added and verified with Azure AD.</p> 
<p style="padding-left: 30px">In the following example from the Active Directory Users and Computers tool, the user’s <span style="font-family: courier">UPN</span> is <span style="font-family: courier">awsuser@awsexample.com</span>, which is a combination of the user’s login name, <span style="font-family: courier">awsuser</span>, with the <span style="font-family: courier">UPN</span>-suffix, <span style="font-family: courier">@awsexample.com</span>.<br /> <img class="alignnone wp-image-5002 size-full" title="Screenshot showing the awsuser@awsexample.com UPN" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P8-UPN.png" alt="Screenshot showing the awsuser@awsexample.com UPN" width="518" height="275" /></p> 
<ol start="11"> 
<li>On the <strong>Domain and OU filtering</strong> page, choose <strong>Sync selected domains and OUs</strong>, choose the <strong>Users</strong> OU under your NetBIOS OU, and then choose <strong>Next</strong>.<br /> <img class="alignnone wp-image-4927 size-full" title="Screenshot of syncing the Users OU" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc9.png" alt="Screenshot of syncing the Users OU" width="624" height="441" /></li> 
<li>On the <strong>Uniquely identifying your users</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Filter users and devices</strong> page, choose <strong>Next</strong>.</li> 
<li>On the <strong>Optional features</strong> page, choose <strong>Next</strong>.</li> 
<li>On the Ready to configure page, choose <strong>Start the synchronization process when configuration completes</strong>, and then choose <strong>Install</strong>.</li> 
<li>The Azure AD Connect installation has now completed. Choose <strong>Exit</strong>.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note: </strong>By default, the Azure AD Connect sync scheduler runs every 30 minutes to synchronize your AWS Microsoft AD identities to Azure AD. You can tune the scheduler by opening a Windows PowerShell session as an administrator and running the appropriate Windows PowerShell commands. For more information, go to <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnectsync-feature-scheduler" target="_blank" rel="noopener noreferrer">Azure AD Connect Sync Scheduler</a>.</p> 
<p style="padding-left: 30px"><strong>Tip:</strong> Do you need to synchronize a change immediately? You can manually start a sync cycle outside the scheduled sync cycle from the Azure AD Connect sync instance. Open a Windows PowerShell session as an administrator and run the following Windows PowerShell commands.</p> 
<pre style="padding-left: 30px"><code class="lang-text">Import-Module ADSync
Start-ADSyncSyncCycle -PolicyType Delta</code></pre> 
<h3><strong>Step 5: Sign in to Office 365 by using your AWS Microsoft AD identities</strong></h3> 
<p>The following steps show you how to sign in to Office 365 using AD&nbsp;FS as the authentication method with your AWS Microsoft AD user account. In this example, we assign a license to the AWS Microsoft AD user account, <span style="font-family: courier">awsuser@awsexample.com</span>, in the Office 365 admin center. We then sign in to Office 365 by using the AWS Microsoft AD user account <span style="font-family: courier">UPN</span>, <span style="font-family: courier">awsuser@awsexample.com</span>.</p> 
<p>Using a computer on the internet, open a browser and complete the following steps:</p> 
<ol> 
<li>Access the <a href="https://portal.office.com/adminportal/home#/homepage" target="_blank" rel="noopener noreferrer">Office 365 admin center</a> using your <a href="https://support.office.com/en-ie/article/Assign-admin-roles-eac4d046-1afd-4f1a-85fc-8219c79e1504?ui=en-US&amp;rs=en-IE&amp;ad=IE" target="_blank" rel="noopener noreferrer">global administrator</a> account, and <a href="https://support.office.com/en-ie/article/Assign-licenses-to-users-in-Office-365-for-business-997596b5-4173-4627-b915-36abac6786dc" target="_blank" rel="noopener noreferrer">assign a license</a> to a user you created in your AWS Microsoft AD directory.<br /> <img class="alignnone wp-image-4928 size-full" title="Screenshot of assigning a license to a user created in the AWS Microsoft AD directory" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc10.png" alt="Screenshot of assigning a license to a user created in the AWS Microsoft AD directory" width="419" height="211" /></li> 
<li>Sign in with the AWS Microsoft AD user account at <a href="https://portal.office.com" target="_blank" rel="noopener noreferrer">https://portal.office.com</a>.<br /> <img class="alignnone wp-image-4929 size-full" title="Screenshot of signing in with the AWS Microsoft AD user account" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc11.png" alt="Screenshot of signing in with the AWS Microsoft AD user account" width="369" height="229" /><br /> When entering the <span style="font-family: courier">UPN</span> of the AWS Microsoft AD user account, you will be redirected to your <span style="font-family: courier">ADFS</span> server sign-in page to complete user authentication.<br /> <img class="alignnone wp-image-4930 size-full" title="Screenshot of being redirected to the ADFS server sign-in page to complete user authentication" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/11/RC0917-sc12.png" alt="Screenshot of being redirected to the ADFS server sign-in page to complete user authentication" width="353" height="181" /></li> 
<li>On the AD&nbsp;FS sign-in page, enter your <span style="font-family: courier">UPN</span> and the password of the AWS Microsoft AD user account.</li> 
<li>You have successfully signed in to Office 365 using your AWS Microsoft AD user account!<br /> <img class="alignnone wp-image-5003 size-full" title="Screenshot of successfully signing in to Office 365 using an AWS Microsoft AD user account" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/P9-O365.png" alt="Screenshot of successfully signing in to Office 365 using an AWS Microsoft AD user account" width="900" height="365" /></li> 
</ol> 
<h3><strong>Summary</strong></h3> 
<p>In this blog post, we showed how to use Azure AD Connect and AD&nbsp;FS with AWS Microsoft AD so that your employees can access Office 365 using their AD credentials. Now that you have Azure AD Connect and AD&nbsp;FS in place, you also might want to explore how to build upon this infrastructure to add sign-in for other Software as a Service (SaaS) applications that are compatible with AD&nbsp;FS. For example, <a href="https://aws.amazon.com/blogs/compute/enabling-identity-federation-with-ad-fs-3-0-and-amazon-appstream-2-0/" target="_blank" rel="noopener noreferrer">this blog post</a> explains how you can provide your users single sign-on access to Amazon AppStream by using AD&nbsp;FS.</p> 
<p>If you have comments or questions, post them on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=180" target="_blank" rel="noopener noreferrer">Directory Service forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Darryn and Ron</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/active-directory-federation-services/" rel="tag">Active Directory Federation Services</a>, <a href="https://aws.amazon.com/blogs/security/tag/ad-fs/" rel="tag">AD FS</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-directory-service/" rel="tag">AWS Directory Service</a>, <a href="https://aws.amazon.com/blogs/security/tag/azure-active-directory/" rel="tag">Azure Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/azure-ad-connect/" rel="tag">Azure AD Connect</a>, <a href="https://aws.amazon.com/blogs/security/tag/microsoft-active-directory/" rel="tag">Microsoft Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/microsoft-ad/" rel="tag">Microsoft AD</a>, <a href="https://aws.amazon.com/blogs/security/tag/office-365/" rel="tag">Office 365</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4898');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b><a href="https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" property="url" rel="bookmark"><span property="name headline">AWS Earns Department of Defense Impact Level 5 Provisional Authorization</span></a></b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Chris Gile</span></span> | on 
<time property="datePublished" datetime="2017-09-12T14:26:55+00:00">12 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/compute/amazon-ec2/" title="View all posts in Amazon EC2*"><span property="articleSection">Amazon EC2*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/amazon-elastic-block-storage-ebs/" title="View all posts in Amazon Elastic Block Storage (EBS)*"><span property="articleSection">Amazon Elastic Block Storage (EBS)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/storage/amazon-simple-storage-services-s3/" title="View all posts in Amazon Simple Storage Services (S3)*"><span property="articleSection">Amazon Simple Storage Services (S3)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-vpc-networking-content-delivery/" title="View all posts in Amazon VPC*"><span property="articleSection">Amazon VPC*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/compliance/" title="View all posts in Compliance*"><span property="articleSection">Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-5008" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=5008&amp;disqus_title=AWS+Earns+Department+of+Defense+Impact+Level+5+Provisional+Authorization&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-earns-department-of-defense-impact-level-5-provisional-authorization/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-5008');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone wp-image-5013 size-full" title="AWS GovCloud (US) Region image" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/12/gov-cloud_email.png" alt="AWS GovCloud (US) Region image" width="600" height="200" /></p> 
<p>The <a href="https://www.disa.mil/" target="_blank" rel="noopener noreferrer">Defense Information Systems Agency</a> (DISA) has granted the <a href="https://aws.amazon.com/govcloud-us/" target="_blank" rel="noopener noreferrer">AWS GovCloud (US) Region</a> an <a href="https://iase.disa.mil/cloud_security/cloudsrg/Pages/ImpactLevels.aspx" target="_blank" rel="noopener noreferrer">Impact Level 5</a> (IL5) <a href="https://iasecontent.disa.mil/cloud/SRG/index.html" target="_blank" rel="noopener noreferrer">Department of Defense (DoD) Cloud Computing Security Requirements Guide</a> (CC SRG) <a href="http://www.disa.mil/newsandevents/2016/dod-cloud-provisional-authorizations" target="_blank" rel="noopener noreferrer">Provisional Authorization</a> (PA) for six core services. This means that AWS’s DoD customers and partners can now deploy workloads for <a href="https://obamawhitehouse.archives.gov/the-press-office/2010/11/04/executive-order-13556-controlled-unclassified-information" target="_blank" rel="noopener noreferrer">Controlled Unclassified Information</a> (CUI) exceeding IL4 and for unclassified National Security Systems (NSS).</p> 
<p>We have supported sensitive Defense community workloads in the cloud for more than four years, and this latest IL5 authorization is complementary to our <a href="https://aws.amazon.com/blogs/publicsector/amazon-web-services-achieves-fedramp-high-authorization/" target="_blank" rel="noopener noreferrer">FedRAMP High Provisional Authorization</a> that covers 18 services in the AWS GovCloud (US) Region. Our customers now have the flexibility to deploy any range of IL 2, 4, or 5 workloads by leveraging AWS’s services, attestations, and certifications. For example, when the US Air Force needed compute scale to support the Next Generation GPS Operational Control System Program, <a href="https://aws.amazon.com/blogs/publicsector/tag/air-force/" target="_blank" rel="noopener noreferrer">they turned to AWS</a>.</p> 
<p>In partnership with a certified Third Party Assessment Organization (3PAO), an independent validation was conducted to assess both our technical and nontechnical security controls to confirm that they meet the DoD’s stringent CC SRG standards for IL5 workloads. Effective immediately, customers can begin leveraging the IL5 authorization for the following six services in the AWS GovCloud (US) Region:</p> 
<ul> 
<li><a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a></li> 
<li><a href="https://aws.amazon.com/ebs/" target="_blank" rel="noopener noreferrer">Amazon EBS</a></li> 
<li><a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS IAM</a></li> 
<li><a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS KMS</a></li> 
<li><a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon VPC</a></li> 
<li><a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a></li> 
</ul> 
<p>AWS has been a long-standing industry partner with DoD, federal-agency customers, and private-sector customers to enhance cloud security and policy. We continue to collaborate on the DoD CC SRG, <a href="https://www.acq.osd.mil/dpap/dars/" target="_blank" rel="noopener noreferrer">Defense Acquisition Regulation Supplement</a> (DFARS) and other government requirements to ensure that policy makers enact policies to support next-generation security capabilities.</p> 
<p>In an effort to reduce the authorization burden of our DoD customers, we’ve worked with DISA to port our assessment results into an easily ingestible format by the <a href="http://www.disa.mil/Cybersecurity/Assessments-and-Inspections/EMASS" target="_blank" rel="noopener noreferrer">Enterprise Mission Assurance Support Service</a> (eMASS) system. Additionally, we undertook a separate effort to empower our industry partners and customers to efficiently solve their compliance, governance, and audit challenges by launching the <a href="https://aws.amazon.com/compliance/customer-center/" target="_blank" rel="noopener noreferrer">AWS Customer Compliance Center</a>, a portal providing a breadth of AWS-specific compliance and regulatory information.</p> 
<p>We look forward to providing sustained cloud security and compliance support at scale for our DoD customers and adding additional services within the IL5 authorization boundary. See <a href="https://aws.amazon.com/compliance/services-in-scope/" target="_blank" rel="noopener noreferrer">AWS Services in Scope by Compliance Program</a> for updates. To request access to AWS’s DoD security and authorization documentation, <a href="http://aws.amazon.com/compliance/contact/" target="_blank" rel="noopener noreferrer">contact AWS Sales and Business Development</a>. For a list of frequently asked questions related to AWS DoD SRG compliance, see&nbsp;the <a href="https://aws.amazon.com/compliance/dod/" target="_blank" rel="noopener noreferrer">AWS DoD SRG page</a>.</p> 
<p>To learn more about the announcement in this post, tune in for the <a href="https://publish.awswebcasts.com/content/connect/c1/7/en/events/event/shared/4183083/event_landing.html?connect-session=graysonbreez88wh47k6rerqbxs3&amp;sco-id=68532001&amp;_charset_=utf-8" target="_blank" rel="noopener noreferrer">AWS Automating DoD SRG Impact Level 5 Compliance in AWS GovCloud (US)</a> webinar on October 11, 2017, at 11:00 A.M. Pacific Time.</p> 
<p>– Chris Gile, Senior Manager, AWS Public Sector Risk &amp; Compliance</p> 
<p>&nbsp;</p> 
<p>&nbsp;</p> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Now Create and Manage AWS IAM Roles More Easily with the Updated IAM Console</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Rob Moncur</span></span> | on 
<time property="datePublished" datetime="2017-09-08T16:26:46+00:00">08 SEP 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/identity/" title="View all posts in Identity"><span property="articleSection">Identity</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-create-and-manage-aws-iam-roles-more-easily-with-the-updated-iam-console/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4760" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4760&amp;disqus_title=Now+Create+and+Manage+AWS+IAM+Roles+More+Easily+with+the+Updated+IAM+Console&amp;disqus_url=https://aws.amazon.com/blogs/security/now-create-and-manage-aws-iam-roles-more-easily-with-the-updated-iam-console/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4760');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Today, we updated the&nbsp;<a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a>&nbsp;(IAM) console to make it easier for you to create, manage, and understand IAM roles. We made improvements that include an updated role-creation workflow that better guides you through the process of creating trust relationships (which define who can assume a role) and attaching permissions to roles. Additionally, you can now view and understand the permissions attached to roles more easily by using <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_understand-policy-summary.html?icmpid=docs_iam_console" target="_blank" rel="noopener noreferrer">policy summaries</a> for each role in your account.</p> 
<p>In this post, I provide background information about roles, show how to create roles correctly by using the updated <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a>, and review other changes to the role list and details pages that help you better manage your roles.</p> 
<h3>Background information about IAM roles</h3> 
<h4><strong>What are IAM roles?</strong></h4> 
<p><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" target="_blank" rel="noopener noreferrer">IAM roles</a> are a secure way to grant permissions to entities you trust. You can use a role in the following scenarios:</p> 
<ul> 
<li><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html" target="_blank" rel="noopener noreferrer">Delegating permissions to an AWS service</a> to carry out actions on your behalf (such as <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Monitoring.OS.html" target="_blank" rel="noopener noreferrer">Enhanced Monitoring for Amazon Relational Database Service [RDS]</a>).</li> 
<li>Enabling application code running on an <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a> instance to access or modify AWS resources (such as data stored in an <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> bucket).</li> 
<li>Granting access to users from another AWS account.</li> 
<li>Enabling <a href="https://aws.amazon.com/iam/details/manage-federation/" target="_blank" rel="noopener noreferrer">federated sign-in</a> to the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS Management Console</a> for employees in your corporate directory.</li> 
</ul> 
<h4><strong>What are the different parts of an IAM role?</strong></h4> 
<p>As illustrated in the following diagram, roles have two types of policies attached to them:</p> 
<ul> 
<li><strong>Trust policy</strong> – This policy defines the entities that can assume a role. When you create a role by using the IAM console, the trust policy is created for you. You can customize the trust policy after it has been created. A role can have only one trust policy.</li> 
<li><strong>Permissions policies</strong> – These policies define which AWS resources a role can access and the actions it can perform on those resources. These <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html" target="_blank" rel="noopener noreferrer">policies</a> can be AWS managed policies, customer managed policies, or inline policies attached directly to the role. You can attach multiple permissions policies to an IAM role.</li> 
</ul> 
<p><span id="more-4760"></span></p> 
<p style="padding-left: 30px"><img class="alignnone wp-image-4862 size-full" title="IAM role diagram with trust policy and permissions policy" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/RM1-0917-diagram-b.png" alt="IAM role diagram with trust policy and permissions policy" width="700" height="305" /></p> 
<h3>How do I use an IAM role?</h3> 
<p>Roles can be used to access AWS both programmatically and via the AWS Management Console.</p> 
<h4>Using a role to access AWS programmatically</h4> 
<p>You can <a href="http://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html" target="_blank" rel="noopener noreferrer">assume a role programmatically by using the AWS CLI or SDK</a>. When you assume a role, the role issues <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html" target="_blank" rel="noopener noreferrer">temporary security credentials</a>&nbsp;that you can use to access resources and call AWS service actions. Using roles enables you to follow the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html#use-roles" target="_blank" rel="noopener noreferrer">security best practice</a> to use temporary security credentials instead of long-term security credentials.</p> 
<p>If you are using AWS services such as EC2 or <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a>, you can assign a role to your EC2 instance or Lambda function. Your code running on either the instance or function will then be able to access AWS using the short-term credentials from that role. These services automatically assume the role and use the returned credentials to enable you to access resources or perform actions. Learn more about <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html" target="_blank" rel="noopener noreferrer">IAM roles for EC2</a> and <a href="http://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html" target="_blank" rel="noopener noreferrer">IAM roles for Lambda</a>.</p> 
<h4>Using a role to access the AWS Management Console</h4> 
<p>You can also assume a role to access an account in the AWS Management Console by using <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-console.html" target="_blank" rel="noopener noreferrer">Switch Role</a> functionality. You can access this functionality by using the drop-down menu in the upper right corner of the console or through a <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_enable-console-custom-url.html" target="_blank" rel="noopener noreferrer">custom sign-in URL</a>. To switch roles, you must sign in as either an IAM or federated user. Swith Role is not supported for root users.</p> 
<h3>Introducing the updated role-creation workflow</h3> 
<p>To make it easier to create IAM roles, we’ve updated the role-creation workflow in the IAM console. To introduce the new experience, let’s look at a specific example.</p> 
<p>Let’s suppose I am developing a new application running on an EC2 instance that reads and writes image data to S3. To enable that application to access the S3 bucket where the image data is stored, I need to create a new role that the EC2 instance running my application code can assume. This role trusts EC2 (defined in the trust policy) and has permissions to read and write to S3 (defined in the permissions policy).</p> 
<p>I first navigate to the <strong>Roles</strong> page of the IAM console, and choose <strong>Create role</strong>.</p> 
<p><img class="alignnone wp-image-4843 size-full" title="Screenshot of choosing &quot;Create new role&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/0-create-role-a.png" alt="" width="893" height="459" /></p> 
<p>I then select the type of trusted entity this role will allow. I have four options in this step:</p> 
<ul> 
<li><strong>AWS service</strong> – To grant access to an AWS service to manage resources in my account.</li> 
<li><strong>Another AWS account</strong> – To grant access to my account from another account.</li> 
<li><strong>Web identities</strong> – To grant access to <a href="https://aws.amazon.com/cognito/" target="_blank" rel="noopener noreferrer">Amazon Cognito</a> or other <a href="https://en.wikipedia.org/wiki/OpenID_Connect" target="_blank" rel="noopener noreferrer">OpenID Connect</a>&nbsp;providers.</li> 
<li><strong>SAML</strong> – To grant access to identities from a SAML-enabled identity provider.</li> 
</ul> 
<p>For this example, I choose <strong>AWS service</strong>. I then see a list of AWS services the new role could trust. Because I need a role that can be assumed by an EC2 instance, I choose <strong>EC2</strong>. This opens a section below it with specific use cases for this service. I choose the&nbsp;<strong>EC2 (Allows EC2 instances to call AWS services on your behalf)</strong> use case. This defines the role’s trust policy to include EC2 as an entity that can assume that role.</p> 
<p><img class="alignnone wp-image-4844 size-full" title="Screenshot of choosing the type of trusted entity" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/1-trust.png" alt="" width="925" height="841" /></p> 
<p>Then, I set the permissions that the role needs to access S3. I already created a permissions policy that <a href="https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/" target="_blank" rel="noopener noreferrer">grants access to my S3 bucket</a> and named it <strong>MyImageApp-S3Access. </strong>I choose that policy and choose <strong>Next</strong> to move to the final step.</p> 
<p><img class="alignnone wp-image-4846 size-full" title="Screenshot showing the MyImageApp-S3Access permissions policy" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/2-permissions-a.png" alt="Screenshot showing the MyImageApp-S3Access permissions policy" width="900" height="516" /></p> 
<p>In the final step, I name the role <strong>MyImageAppRole</strong> and describe it this way: “Allows application code running on EC2 instances to access data in S3.” I choose <strong>Create role </strong>and I am done! I can now attach this role to EC2 instances on which my application is running to give them permissions to access data in S3.</p> 
<p><img class="alignnone wp-image-4852 size-full" title="Screenshot of finishing the role creation process" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/3-review-a.png" alt="Screenshot of finishing the role creation process" width="900" height="550" /></p> 
<h3>Other updates to help you manage your roles</h3> 
<p>With this update, you will see a new column called <strong>Trusted entities</strong> on the <strong>Roles</strong> list page. This column allows you to review at a glance which entities can assume a role. This makes it easier to identify roles that trust a specific account or AWS service. It also makes it easier to audit the trust relationships across all your roles. You also can add other columns to this table, including <strong>Creation time</strong>&nbsp;and&nbsp;<strong>Role ARN</strong>,&nbsp;by clicking the gear icon. Your column selection preference will be remembered when you return to the <strong>Roles</strong>&nbsp;page.</p> 
<p><img class="alignnone wp-image-4847 size-full" title="Screenshot of the Roles page with new column, &quot;Trusted entities&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/list-roles.png" alt="Screenshot of the Roles page with new column, &quot;Trusted entities&quot;" width="891" height="554" /></p> 
<p>To help you understand the permissions attached to your role, we’ve also updated the <strong>Permissions</strong> tab to include <a href="https://aws.amazon.com/blogs/security/move-over-json-policy-summaries-make-understanding-iam-policies-easier/" target="_blank" rel="noopener noreferrer">IAM policy summaries</a>. Policy summaries make it easier for you to understand the permissions for IAM permissions policies attached to roles without having to view a policy’s JSON.</p> 
<p><img class="alignnone wp-image-4849 size-full" title="Screenshot of the updated &quot;Permissions&quot; tab" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/09/06/role-details-a.png" alt="Screenshot of the updated &quot;Permissions&quot; tab" width="900" height="577" /></p> 
<h3>Conclusion</h3> 
<p>Now it is easier for you to create and manage your IAM roles using the IAM console. As you manage your roles, be sure to review and follow&nbsp;<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener noreferrer">IAM best practices</a>, which can help to improve the security of your AWS resources and make your account easier to manage.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions or suggestions, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Rob</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/iam-console/" rel="tag">IAM console</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-role-creation-workflow/" rel="tag">IAM role-creation workflow</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-roles/" rel="tag">IAM roles</a>, <a href="https://aws.amazon.com/blogs/security/tag/permissions-policies/" rel="tag">permissions policies</a>, <a href="https://aws.amazon.com/blogs/security/tag/trust-policies/" rel="tag">trust policies</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4760');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Configure an LDAPS Endpoint for Simple AD</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Cameron Worrell</span></span> and 
<span property="author" typeof="Person"><span property="name">Jeff Levine</span></span> | on 
<time property="datePublished" datetime="2017-08-29T05:58:12+00:00">29 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/compute/amazon-ec2/" title="View all posts in Amazon EC2*"><span property="articleSection">Amazon EC2*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-route-53/" title="View all posts in Amazon Route 53"><span property="articleSection">Amazon Route 53</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-certificate-manager/" title="View all posts in AWS Certificate Manager*"><span property="articleSection">AWS Certificate Manager*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-directory-service/" title="View all posts in AWS Directory Service*"><span property="articleSection">AWS Directory Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/elastic-load-balancing/" title="View all posts in Elastic Load Balancing"><span property="articleSection">Elastic Load Balancing</span></a>, <a href="https://aws.amazon.com/blogs/security/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-configure-an-ldaps-endpoint-for-simple-ad/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4647" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4647&amp;disqus_title=How+to+Configure+an+LDAPS+Endpoint+for+Simple+AD&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-configure-an-ldaps-endpoint-for-simple-ad/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4647');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_simple_ad.html" target="_blank" rel="noopener noreferrer">Simple AD</a>, which is powered by <a href="https://en.wikipedia.org/wiki/Samba_(software)" target="_blank" rel="noopener noreferrer">Samba &nbsp;4</a>, supports basic Active Directory (AD) authentication features such as users, groups, and the ability to join domains. Simple AD also includes an integrated <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_blank" rel="noopener noreferrer">Lightweight Directory Access Protocol</a> (LDAP) server. LDAP is a standard application protocol for the access and management of directory information. You can use the <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol#Bind_.28authenticate.29" target="_blank" rel="noopener noreferrer">BIND operation</a> from Simple AD to authenticate LDAP client sessions. This makes LDAP a common choice for centralized authentication and authorization for services such as <a href="https://en.wikipedia.org/wiki/Secure_Shell" target="_blank" rel="noopener noreferrer">Secure Shell</a> (SSH), client-based virtual private networks (VPNs), and many other applications. Authentication, the process of confirming the identity of a <a href="https://en.wikipedia.org/wiki/Principal_(computer_security)" target="_blank" rel="noopener noreferrer">principal</a>, typically involves the transmission of highly sensitive information such as user names and passwords. To protect this information in transit over untrusted networks, companies often require encryption as part of their information security strategy.</p> 
<p>In this blog post, we show you how to configure an LDAPS (LDAP over SSL/TLS) encrypted endpoint for Simple AD so that you can extend Simple AD over untrusted networks. Our solution uses <a href="https://aws.amazon.com/elasticloadbalancing/" target="_blank" rel="noopener noreferrer">Elastic Load Balancing</a> (ELB) to send decrypted LDAP traffic to <a href="http://www.haproxy.org/" target="_blank" rel="noopener noreferrer">HAProxy</a> running on <a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer">Amazon EC2</a>, which then sends the traffic to Simple AD. ELB offers integrated certificate management, SSL/TLS termination, and the ability to use a scalable EC2 backend to process decrypted traffic. ELB also tightly integrates with <a href="https://aws.amazon.com/route53/" target="_blank" rel="noopener noreferrer">Amazon Route 53</a>, enabling you to use a custom domain for the LDAPS endpoint. The solution needs the intermediate HAProxy layer because ELB can direct traffic only to EC2 instances. To simplify testing and deployment, we have provided an&nbsp;<a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template/raw/master/cloudformation/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">AWS CloudFormation template</a> to provision the ELB and HAProxy layers.</p> 
<p>This post assumes that you have an understanding of concepts such as <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html" target="_blank" rel="noopener noreferrer">Amazon Virtual Private Cloud (VPC)</a> and its components, including subnets, routing, Internet and network address translation (NAT) gateways, DNS, and security groups. You should also be familiar with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">launching EC2 instances and logging in to them with SSH</a>. If needed, you should familiarize yourself with these concepts and review the solution overview and prerequisites in the next section before proceeding with the deployment.</p> 
<p><strong>Note:&nbsp;</strong>This solution is intended for use by clients requiring an LDAPS endpoint only. If your requirements extend beyond this, you should consider accessing the Simple AD servers directly or by using <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/directory_microsoft_ad.html" target="_blank" rel="noopener noreferrer">AWS Directory Service for Microsoft AD</a>.</p> 
<h3>Solution overview</h3> 
<p>The following diagram and description illustrates and explains the Simple AD LDAPS environment. The <a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template/raw/master/cloudformation/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">CloudFormation template</a> creates the items designated by the bracket (internal ELB load balancer and two HAProxy nodes configured in an Auto Scaling group).<span id="more-4647"></span></p> 
<p><img class="alignnone wp-image-4662 size-full" title="Diagram of the the Simple AD LDAPS environment" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/Screen-Shot-2017-07-25-at-10.30.54-AM.png" alt="Diagram of the the Simple AD LDAPS environment" width="692" height="895" /></p> 
<p>Here is how the solution works, as shown in the preceding numbered diagram:</p> 
<ol> 
<li>The LDAP client sends an LDAPS request to ELB on TCP port 636.</li> 
<li>ELB terminates the SSL/TLS session and decrypts the traffic using a certificate. ELB sends the decrypted LDAP traffic to the EC2 instances running HAProxy on TCP port 389.</li> 
<li>The HAProxy servers forward the LDAP request to the Simple AD servers listening on TCP port 389 in a fixed Auto Scaling group configuration.</li> 
<li>The Simple AD servers send an LDAP response through the HAProxy layer to ELB. ELB encrypts the response and sends it to the client.</li> 
</ol> 
<p style="padding-left: 30px"><strong>Note:</strong> Amazon VPC prevents a third party from intercepting traffic within the VPC. Because of this, the VPC protects the decrypted traffic between ELB and HAProxy and between HAProxy and Simple AD. The ELB encryption provides an additional layer of security for client connections and protects traffic coming from hosts outside the VPC.</p> 
<h3>Prerequisites</h3> 
<ol> 
<li>Our approach requires an Amazon VPC with two public and two private subnets. The previous diagram illustrates the environment’s VPC requirements. If you do not yet have these components in place, follow these guidelines for setting up a sample environment: 
<ol type="a"> 
<li>Identify a region that supports <a href="https://aws.amazon.com/directoryservice/other-directories-pricing/" target="_blank" rel="noopener noreferrer">Simple AD</a>, <a href="https://aws.amazon.com/elasticloadbalancing/classicloadbalancer/pricing/" target="_blank" rel="noopener noreferrer">ELB</a>, and <a href="https://aws.amazon.com/about-aws/whats-new/2015/12/introducing-amazon-vpc-nat-gateway-a-managed-nat-service/" target="_blank" rel="noopener noreferrer">NAT gateways</a>. The NAT gateways are used with an Internet gateway to allow the HAProxy instances to access the internet to perform their required configuration. You also need to identify the two <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html">Availability Zones</a> in that region for use by Simple AD. You will supply these Availability Zones as parameters to the CloudFormation template later in this process.</li> 
<li>Create or choose an <a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon VPC</a> in the region you chose. In order to use Route 53 to resolve the LDAPS endpoint, <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html#vpc-dns-support" target="_blank" rel="noopener noreferrer">make sure you enable DNS support</a> within your VPC. Create an <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html" target="_blank" rel="noopener noreferrer">Internet gateway</a> and attach it to the VPC, which will be used by the NAT gateways to access the internet.</li> 
<li><a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Route_Tables.html#CustomRouteTable" target="_blank" rel="noopener noreferrer">Create a route table</a> with a default route to the Internet gateway. Create two <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html#nat-gateway-creating" target="_blank" rel="noopener noreferrer">NAT gateways</a>, one per Availability Zone in your public subnets to provide additional resiliency across the Availability Zones. Together, the routing table, the NAT gateways, and the Internet gateway enable the HAProxy instances to access the internet.</li> 
<li>Create two private routing tables, one per Availability Zone. Create two private subnets, one per Availability Zone. The dual routing tables and subnets allow for a higher level of redundancy. Add each subnet to the routing table in the same Availability Zone. Add a default route in each routing table to the NAT gateway in the same Availability Zone. The Simple AD servers use subnets that you create.</li> 
<li>The LDAP service requires a DNS domain that resolves within your VPC and from your LDAP clients. If you do not have an existing DNS domain, follow the steps to <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html" target="_blank" rel="noopener noreferrer">create a private hosted zone</a> and <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-associate-vpcs.html" target="_blank" rel="noopener noreferrer">associate it with your VPC</a>. To avoid encryption protocol errors, you must ensure that the DNS domain name is consistent across your Route 53 zone and in the SSL/TLS certificate (see Step 2 in the “Solution deployment” section).</li> 
</ol> </li> 
<li>Make sure you have completed the&nbsp;<a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/prereq_simple.html" target="_blank" rel="noopener noreferrer">Simple AD Prerequisites</a>.</li> 
<li>We will use a self-signed certificate for ELB to perform SSL/TLS decryption. You can use a certificate issued by your preferred certificate authority or a certificate issued by <a href="https://aws.amazon.com/acm/" target="_blank" rel="noopener noreferrer">AWS Certificate Manager</a> (ACM).<br /> <strong>Note:</strong> To prevent unauthorized connections directly to your Simple AD servers, you can modify the Simple AD security group on port 389 to block traffic from locations outside of the Simple AD VPC. You can find the security group in the <a href="https://console.aws.amazon.com/ec2/v2/home" target="_blank" rel="noopener noreferrer">EC2 console</a> by creating a search filter for your Simple AD directory ID. It is also important to allow the Simple AD servers to communicate with each other as shown on <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/prereq_simple.html" target="_blank" rel="noopener noreferrer">Simple AD Prerequisites</a>.</li> 
</ol> 
<h3>Solution deployment</h3> 
<p>This solution includes five main parts:</p> 
<ol> 
<li>Create a Simple AD directory.</li> 
<li>Create a certificate.</li> 
<li>Create the ELB and HAProxy layers by using the supplied CloudFormation template.</li> 
<li>Create a Route 53 record.</li> 
<li>Test LDAPS access using an Amazon Linux client.</li> 
</ol> 
<h3>1. Create a Simple AD directory</h3> 
<p>With the prerequisites completed, you will create a Simple AD directory in your private VPC subnets:</p> 
<ol type="a"> 
<li>In the&nbsp;<a href="https://console.aws.amazon.com/directoryservice/" target="_blank" rel="noopener noreferrer">Directory Service console</a> navigation pane, choose&nbsp;<strong>Directories</strong>&nbsp;and then choose&nbsp;<strong>Set up directory</strong>.</li> 
<li>Choose&nbsp;<strong><strong>Simple AD.<br /> <img class="alignnone wp-image-4679 size-full" title="Screenshot of choosing &quot;Simple AD&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL1-a.png" alt="Screenshot of choosing &quot;Simple AD&quot;" width="600" height="559" /><br /> </strong></strong></li> 
<li>Provide the following information: 
<ul> 
<li><strong>Directory DNS</strong> – The <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name" target="_blank" rel="noopener noreferrer">fully qualified domain name</a> (FQDN) of the directory, such as&nbsp;<span style="font-family: courier">corp.example.com</span>. You will use the FQDN as part of the testing procedure.</li> 
<li><strong>NetBIOS name</strong> – The short name for the directory, such as&nbsp;<span style="font-family: courier">CORP</span>.</li> 
<li><strong>Administrator password</strong> – The password for the directory administrator. The directory creation process creates an administrator account with the user name&nbsp;<span style="font-family: courier">Administrator </span>and this password. Do not lose this password because it is nonrecoverable. You also need this password for testing LDAPS access in a later step.</li> 
<li><strong>Description</strong> – An optional description for the directory.</li> 
<li><strong>Directory Size</strong> – The size of the directory.<br /> <img class="alignnone wp-image-4680 size-full" title="Screenshot of the directory details to provide" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL2-a.png" alt="Screenshot of the directory details to provide" width="800" height="367" /></li> 
</ul> </li> 
<li>Provide the following information in the&nbsp;<strong>VPC Details&nbsp;</strong>section, and then choose&nbsp;<strong>Next Step</strong>: 
<ul> 
<li><strong>VPC</strong> – Specify the VPC in which to install the directory.</li> 
<li><strong>Subnets</strong> – Choose two private subnets for the directory servers. The two subnets must be in different Availability Zones. Make a note of the VPC and subnet IDs for use as CloudFormation input parameters. In the following example, the Availability Zones are <span style="font-family: courier">us-east-1a</span> and <span style="font-family: courier">us-east-1c</span>.<br /> <img class="alignnone wp-image-4682 size-full" title="Screenshot of the VPC details to provide" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL3-a.png" alt="Screenshot of the VPC details to provide" width="800" height="241" /></li> 
</ul> </li> 
<li>Review the directory information and make any necessary changes. When the information is correct, choose&nbsp;<strong>Create Simple AD</strong>.</li> 
</ol> 
<p style="padding-left: 30px">It takes several minutes to create the directory. From the <a href="https://console.aws.amazon.com/directoryservice/home" target="_blank" rel="noopener noreferrer">AWS Directory Service console</a>&nbsp;, refresh the screen periodically and wait until the directory <strong>Status</strong>&nbsp;value changes to&nbsp;<span style="font-family: courier">Active</span> before continuing. Choose your Simple AD directory and note the two IP addresses in the <strong>DNS address</strong> section. You will enter them when you run the CloudFormation template later.</p> 
<p style="padding-left: 30px"><strong>Note:</strong> Full administration of your Simple AD implementation is out of scope for this blog post. See the documentation to add <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/creating_ad_users_and_groups.html" target="_blank" rel="noopener noreferrer">users, groups</a>, or <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/join_a_directory.html" target="_blank" rel="noopener noreferrer">instances</a> to your directory. Also see the previous blog post, <a href="https://aws.amazon.com/blogs/security/how-to-manage-identities-in-simple-ad-directories/" target="_blank" rel="noopener noreferrer">How to Manage Identities in Simple AD Directories</a>.</p> 
<h3>2. Create a certificate</h3> 
<p>In the previous step, you created the Simple AD directory. Next, you will generate a self-signed SSL/TLS certificate using <a href="https://en.wikipedia.org/wiki/OpenSSL" target="_blank" rel="noopener noreferrer">OpenSSL</a>. You will use the certificate with ELB to secure the LDAPS endpoint. OpenSSL is a standard, open source library that supports a wide range of cryptographic functions, including the creation and signing of x509 certificates. You then import the certificate into ACM that is integrated with ELB.</p> 
<ol type="a"> 
<li>You must have a system with OpenSSL installed to complete this step. If you do not have OpenSSL, you can install it on Amazon Linux by running the command, <span style="font-family: courier">sudo yum install openssl</span>. If you do not have access to an Amazon Linux instance you can <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">create one</a> with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html" target="_blank" rel="noopener noreferrer">SSH access enabled</a> to proceed with this step. Run the command,&nbsp;<span style="font-family: courier">openssl version</span>, at the command line to see if you already have OpenSSL installed. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 ~]$ openssl version
OpenSSL 1.0.1k-fips 8 Jan 2015</code></pre> 
<li>Create a private key using the command, <span style="font-family: courier">openssl genrsa command</span>. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl genrsa 2048 &gt; privatekey.pem
Generating RSA private key, 2048 bit long modulus
......................................................................................................................................................................+++
..........................+++
e is 65537 (0x10001)</code></pre> 
<li>Generate a certificate signing request (CSR) using the <span style="font-family: courier">openssl req</span> command. Provide the requested information for each field. The <strong>Common Name</strong> is the FQDN for your LDAPS endpoint (for example, <span style="font-family: courier">ldap.corp.example.com</span>). The <strong>Common Name</strong> must use the domain name you will later register in Route 53. You will encounter certificate errors if the names do not match. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl req -new -key privatekey.pem -out server.csr
You are about to be asked to enter information that will be incorporated into your certificate request.</code></pre> 
<li>Use the&nbsp;<span style="font-family: courier">openssl x509</span> command to sign the certificate. The following example uses the private key from the previous step (<span style="font-family: courier">privatekey.pem</span>) and the signing request (<span style="font-family: courier">server.csr</span>) to create a public certificate named&nbsp;<span style="font-family: courier">server.crt</span>&nbsp;that is valid for&nbsp;365&nbsp;days. This certificate must be updated within 365 days to avoid disruption of LDAPS functionality. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ openssl x509 -req -sha256 -days 365 -in server.csr -signkey privatekey.pem -out server.crt
Signature ok
subject=/C=XX/L=Default City/O=Default Company Ltd/CN=ldap.corp.example.com
Getting Private key</code></pre> 
<li>You should see three files: <span style="font-family: courier">privatekey.pem</span>, <span style="font-family: courier">server.crt</span>, and <span style="font-family: courier">server.csr</span>. 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ ls
privatekey.pem server.crt server.csr</code></pre> 
<pre><code class="lang-text">[ec2-user@ip-10-21-32-162 tmp]$ chmod 600 privatekey.pem</code></pre> 
<li>In the <a href="https://console.aws.amazon.com/acm/home" target="_blank" rel="noopener noreferrer">ACM console</a>, choose <strong>Import a certificate</strong>.</li> 
<li>Using your favorite Linux text editor, paste the contents of your <span style="font-family: courier">server.crt</span> file in the <strong>Certificate body</strong> box.</li> 
<li>Using your favorite Linux text editor, paste the contents of your <span style="font-family: courier">privatekey.pem</span> file in the <strong>Certificate private key</strong> box. For a self-signed certificate, you can leave the <strong>Certificate chain</strong> box blank.</li> 
<li>Choose <strong>Review and import</strong>. Confirm the information and choose <strong>Import</strong>.</li> 
</ol> 
<h3>3. Create the ELB and HAProxy layers by using the supplied CloudFormation template</h3> 
<p>Now that you have created your Simple AD directory and SSL/TLS certificate, you are ready to use the CloudFormation template to create the ELB and HAProxy layers.</p> 
<ol type="a"> 
<li><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=ldaps-haproxy&amp;templateURL=https://s3.amazonaws.com/awsiammedia/public/sample/LDAPSEndpointSimpleAD/ldaps-haproxy.template" target="_blank" rel="noopener noreferrer">Load the supplied CloudFormation template</a> to deploy an internal ELB and two HAProxy EC2 instances into a fixed Auto Scaling group. After you load the template, provide the following input parameters. <strong>Note:</strong> You can find the parameters relating to your Simple AD from the directory details page by choosing your Simple AD in the <a href="https://console.aws.amazon.com/directoryservice/home" target="_blank" rel="noopener noreferrer">Directory Service console</a>.</li> 
</ol> 
<table style="margin-left: 45px" border="1" width="0"> 
<tbody> 
<tr> 
<td style="padding-left: 10px" width="233"><strong>Input parameter</strong></td> 
<td style="padding-left: 10px" width="301"><strong>Input parameter description</strong></td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">HAProxyInstanceSize</span></td> 
<td style="padding-left: 10px" width="301">The EC2 instance size for HAProxy servers. The default size is t2.micro and can scale up for large Simple AD environments.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">MyKeyPair</span></td> 
<td style="padding-left: 10px" width="301">The SSH key pair for EC2 instances. If you do not have an existing key pair, <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" target="_blank" rel="noopener noreferrer">you must create one</a>.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">VPCId</span></td> 
<td style="padding-left: 10px" width="301">The target VPC for this solution. Must be in the VPC where you deployed Simple AD and is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SubnetId1</span></td> 
<td style="padding-left: 10px" width="301">The Simple AD primary subnet. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SubnetId2</span></td> 
<td style="padding-left: 10px" width="301">The Simple AD secondary subnet. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">MyTrustedNetwork</span></td> 
<td style="padding-left: 10px" width="301">Trusted network Classless Inter-Domain Routing (CIDR) to allow connections to the LDAPS endpoint. For example, use the VPC CIDR to allow clients in the VPC to connect.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SimpleADPriIP</span></td> 
<td style="padding-left: 10px" width="301">The primary Simple AD Server IP. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">SimpleADSecIP</span></td> 
<td style="padding-left: 10px" width="301">The secondary Simple AD Server IP. This information is available in your Simple AD directory details page.</td> 
</tr> 
<tr style="padding-left: 10px"> 
<td style="padding-left: 10px" width="233"><span style="font-family: courier">LDAPSCertificateARN</span></td> 
<td style="padding-left: 10px" width="301">The Amazon Resource Name (ARN) for the SSL certificate. This information is available in the <a href="https://console.aws.amazon.com/acm/home">ACM console</a>.</td> 
</tr> 
</tbody> 
</table> 
<ol start="2" type="a"> 
<li>Enter the input parameters and choose <strong>Next</strong>.</li> 
<li>On the <strong>Options</strong> page, accept the defaults and choose <strong>Next</strong>.</li> 
<li>On the <strong>Review</strong> page, confirm the details and choose <strong>Create</strong>. The stack will be created in approximately 5 minutes.</li> 
</ol> 
<h3>4. Create a Route 53 record</h3> 
<p>The next step is to create a Route 53 record in your private hosted zone so that clients can resolve your LDAPS endpoint.</p> 
<ol start="1" type="a"> 
<li>If you do not have an existing DNS domain for use with LDAP, <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html" target="_blank" rel="noopener noreferrer">create a private hosted zone</a> and <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-associate-vpcs.html" target="_blank" rel="noopener noreferrer">associate it with your VPC</a>. The hosted zone name should be consistent with your Simple AD (for example, <span style="font-family: courier">corp.example.com</span>).</li> 
<li>When the CloudFormation stack is in <span style="font-family: courier">CREATE_COMPLETE</span> status, locate the value of the <span style="font-family: courier">LDAPSURL</span> on the <strong>Outputs</strong> tab of the stack. Copy this value for use in the next step.</li> 
<li>On the <a href="https://console.aws.amazon.com/route53/home" target="_blank" rel="noopener noreferrer">Route 53 console</a>, choose&nbsp;<strong>Hosted Zones</strong>&nbsp;and then choose the zone you used for the <strong>Common Name</strong> box for your self-signed certificate. Choose <strong>Create Record Set</strong> and enter the following information: 
<ol> 
<li><strong>Name</strong> – The label of the record (such as <span style="font-family: courier">ldap</span>).</li> 
<li><strong>Type</strong> – Leave as <strong>A – IPv4 address</strong>.</li> 
<li><strong>Alias</strong> – Choose <strong>Yes</strong>.</li> 
<li><strong>Alias Target</strong> – Paste the value of the <span style="font-family: courier">LDAPSURL</span> on the <strong>Outputs</strong> tab of the stack.</li> 
</ol> </li> 
<li>Leave the defaults for <strong>Routing Policy</strong> and <strong>Evaluate Target Health</strong>, and choose <strong>Create</strong>.<br /> <img class="alignnone wp-image-4685 size-full" title="Screenshot of finishing the creation of the Route 53 record" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/28/CWJL4-c.png" alt="Screenshot of finishing the creation of the Route 53 record" width="900" height="539" /></li> 
</ol> 
<h3>5. Test LDAPS access using an Amazon Linux client</h3> 
<p>At this point, you have configured your LDAPS endpoint and now you can test it from an Amazon Linux client.</p> 
<ol start="1" type="a"> 
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" target="_blank" rel="noopener noreferrer">Create an Amazon Linux instance</a> with <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html" target="_blank" rel="noopener noreferrer">SSH access enabled</a> to test the solution. Launch the instance into one of the public subnets in your VPC. Make sure the IP assigned to the instance is in the trusted IP range you specified in the CloudFormation parameter <span style="font-family: courier">MyTrustedNetwork</span> in Step 3.b.</li> 
<li>SSH into the instance and complete the following steps to verify access. 
<ol> 
<li>Install the <span style="font-family: courier">openldap-clients</span> package and any required dependencies:<br /> <span style="font-family: courier">sudo yum install -y openldap-clients</span>.</li> 
<li>Add the <span style="font-family: courier">server.crt</span> file to the <span style="font-family: courier">/etc/openldap/certs/</span> directory so that the LDAPS client will trust your SSL/TLS certificate. You can copy the file using Secure Copy (SCP) or create it using a text editor.</li> 
<li>Edit the <span style="font-family: courier">/etc/openldap/ldap.conf</span> file and define the environment variables <span style="font-family: courier">BASE</span>, <span style="font-family: courier">URI</span>, and <span style="font-family: courier">TLS_CACERT</span>. 
<ul> 
<li>The value for <span style="font-family: courier">BASE</span> should match the configuration of the Simple AD directory name.</li> 
<li>The value for <span style="font-family: courier">URI</span> should match your DNS alias.</li> 
<li>The value for <span style="font-family: courier">TLS_CACERT</span> is the path to your public certificate.</li> 
</ul> </li> 
</ol> </li> 
</ol> 
<p style="padding-left: 90px">Here is an example of the contents of the file.</p> 
<pre><code class="lang-text">BASE dc=corp,dc=example,dc=com
URI ldaps://ldap.corp.example.com
TLS_CACERT /etc/openldap/certs/server.crt</code></pre> 
<p>To test the solution, query the directory through the LDAPS endpoint, as shown in the following command. Replace <span style="font-family: courier">corp.example.com</span> with your domain name and use the&nbsp;<span style="font-family: courier">Administrator</span> password that you configured with the Simple AD directory</p> 
<pre><code class="lang-text">$ ldapsearch -D &quot;Administrator@<strong>corp.example.com</strong>&quot; -W sAMAccountName=<strong>Administrator</strong></code></pre> 
<p>You should see a response similar to the following response, which provides the directory information in <a href="https://en.wikipedia.org/wiki/LDAP_Data_Interchange_Format" target="_blank" rel="noopener noreferrer">LDAP Data Interchange Format (LDIF)</a> for the administrator distinguished name (DN) from your Simple AD LDAP server.</p> 
<pre><code class="lang-text"># extended LDIF
#
# LDAPv3
# base &lt;dc=corp,dc=example,dc=com&gt; (default) with scope subtree
# filter: sAMAccountName=Administrator
# requesting: ALL
#
# Administrator, Users, corp.example.com
dn: CN=Administrator,CN=Users,DC=corp,DC=example,DC=com
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
description: Built-in account for administering the computer/domain
instanceType: 4
whenCreated: 20170721123204.0Z
uSNCreated: 3223
name: Administrator
objectGUID:: l3h0HIiKO0a/ShL4yVK/vw==
userAccountControl: 512
…</code></pre> 
<p>You can now use the LDAPS endpoint for directory operations and authentication within your environment. If you would like to learn more about how to interact with your LDAPS endpoint within a Linux environment, here are a few resources to get started:</p> 
<ul> 
<li><a href="https://www.centos.org/docs/5/html/CDS/ag/8.0/Finding_Directory_Entries-Using_ldapsearch.html" target="_blank" rel="noopener noreferrer">Using ldapsearch to locate and retrieve directory entries</a></li> 
<li><a href="https://www.centos.org/docs/5/html/CDS/cli/8.0/Configuration_Command_File_Reference-Command_Line_Utilities-ldapmodify.html" target="_blank" rel="noopener noreferrer">Using ldapmodify to make changes to directory entries</a></li> 
<li><a href="https://en.wikipedia.org/wiki/System_Security_Services_Daemon" target="_blank" rel="noopener noreferrer">Managing access with the System Security Services Daemon (SSSD)</a> – SSSD can be used within a Linux environment to authenticate LDAP sessions.</li> 
</ul> 
<h3>Troubleshooting</h3> 
<p>If you receive an error such as the following error when issuing the <span style="font-family: courier">ldapsearch</span> command, there are a few things you can do to help identify issues.</p> 
<pre><code class="lang-text">ldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)</code></pre> 
<ul> 
<li>You might be able to obtain additional error details by adding the <span style="font-family: courier">-d1</span> debug flag to the <span style="font-family: courier">ldapsearch</span> command in the previous section. 
<pre><code class="lang-text">$ ldapsearch -D &quot;Administrator@corp.example.com&quot; -W sAMAccountName=Administrator –d1</code></pre> 
<li>Verify that the parameters in <span style="font-family: courier">ldap.conf</span> match your configured LDAPS <span style="font-family: courier">URI</span> endpoint and that all parameters can be resolved by DNS. You can use the following <span style="font-family: courier">dig</span> command, substituting your configured endpoint DNS name. 
<pre><code class="lang-text">$ dig ldap.corp.example.com</code></pre> 
<li>Confirm that the client instance from which you are connecting is in the CIDR range of the CloudFormation parameter, <span style="font-family: courier">MyTrustedNetwork</span>.</li> 
<li>Confirm that the path to your public SSL/TLS certificate configured in <span style="font-family: courier">ldap.conf</span> as <span style="font-family: courier">TLS_CAERT</span> is correct. You configured this in Step 5.b.3. You can check your SSL/TLS connection with the command, substituting your configured endpoint DNS name for the string after <span style="font-family: courier">–connect</span>. 
<pre><code class="lang-text">$ echo -n | openssl s_client -connect ldap.corp.example.com:636</code></pre> 
<li>Verify that your HAProxy instances have the status <strong>InService</strong> in the EC2 console: Choose&nbsp;<strong>Load Balancers</strong> under <strong>Load Balancing</strong> in the navigation pane, highlight your LDAPS load balancer, and then choose the <strong>Instances</strong></li> 
</ul> 
<h3>Conclusion</h3> 
<p>You can use ELB and HAProxy to provide an LDAPS endpoint for Simple AD and transport sensitive authentication information over untrusted networks. You can explore using LDAPS to authenticate SSH users or integrate with other software solutions that support LDAP authentication. This solution’s CloudFormation template is <a href="https://github.com/awslabs/cloudformation-ldaps-haproxy-template" target="_blank" rel="noopener noreferrer">available on GitHub</a>.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about or issues implementing this solution, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=180" target="_blank" rel="noopener noreferrer">Directory Service forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Cameron and Jeff</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/encryption/" rel="tag">Encryption</a>, <a href="https://aws.amazon.com/blogs/security/tag/haproxy/" rel="tag">HAProxy</a>, <a href="https://aws.amazon.com/blogs/security/tag/ldaps/" rel="tag">LDAPS</a>, <a href="https://aws.amazon.com/blogs/security/tag/simple-ad/" rel="tag">Simple AD</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4647');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">Now Available: Improvements to How You Sign In to Your AWS Account</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Siraj Valiya Valappil</span></span> | on 
<time property="datePublished" datetime="2017-08-25T15:43:34+00:00">25 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-available-improvements-to-how-you-sign-in-to-your-aws-account/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4335" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4335&amp;disqus_title=Now+Available%3A+Improvements+to+How+You+Sign+In+to+Your+AWS+Account&amp;disqus_url=https://aws.amazon.com/blogs/security/now-available-improvements-to-how-you-sign-in-to-your-aws-account/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4335');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>Today, AWS made improvements to the way you sign in to your AWS account. Whether you sign in as your account’s <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html" target="_blank" rel="noopener noreferrer">root user</a> or an <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) user, you can now sign in from the AWS Management Console’s homepage. This means that if you sign in as an IAM user, you no longer have to use an account-specific URL. However, the account-specific URL you have used in the past to sign in will continue to work.</p> 
<p>In the new sign-in experience, you can sign in from the home page using either your root user’s or IAM user’s credentials. In the first step, root users enter their email address; IAM users enter their <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html" target="_blank" rel="noopener noreferrer">account ID (or account alias)</a>. In the second step, root users enter their password; IAM users enter their user name and password.</p> 
<p>In this blog post, I explain the improvements to the way you sign in to your AWS account as a root user or IAM user. If you use a password manager to help you sign in to your account, you may need to make updates so that it will work with the new sign-in experience.<span id="more-4335"></span></p> 
<h3>The new sign-in experience</h3> 
<p>The new AWS sign-in experience allows both root users and IAM users to sign in using the <strong>Sign In to the Console</strong> link on the AWS Management Consoles’s home page.</p> 
<h4>Step 1: For root users and IAM users</h4> 
<p>As shown in the following screenshot, to sign in as a root user, type the email address associated with the root account. To sign in as an IAM user, type an AWS account ID or account alias. Then choose <strong>Next</strong> to proceed to Step 2.</p> 
<p>If you usually sign in using the same browser and allow the browser to store AWS cookies, you will skip Step 1 on subsequent sign-in attempts. If you regularly switch users or accounts, AWS recommends that you prevent the sign-in page from storing AWS cookies.</p> 
<p><img class="alignnone wp-image-4398 size-full" title="Step 1: Sign in as a root user or IAM user" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/28/Step-1.png" alt="Step 1: Sign in as a root user or IAM user" width="341" height="448" /></p> 
<h4>Step 2: For root users</h4> 
<p>If you entered the email address associated with the root account in Step 1, you were taken to the second step to sign in to the root account, as shown in the following screenshot. Type the password of the root account and choose <strong>Sign in</strong>. If you enabled <a href="https://aws.amazon.com/iam/details/mfa" target="_blank" rel="noopener noreferrer">multi-factor authentication</a> (MFA) for your root account, you will then be prompted to enter the code from your MFA device. After successful authentication, you will be signed in to the AWS Management Console, and your account’s home page will be displayed.</p> 
<p><img class="alignnone wp-image-4399 size-full" title="Step 2: For root users" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/28/Step-2-root.png" alt="Step 2: For root users" width="299" height="352" /></p> 
<h4>Step 2: For IAM users</h4> 
<p>If you entered an AWS account ID or account alias in Step 1, you were taken to the second step to sign in as an IAM user, as shown in the following screenshot. Type the user name and password of the IAM user, and choose <strong>Sign in</strong>. If MFA has been enabled for your IAM user, you will then be prompted to enter the code from your MFA device. After successful authentication, your account’s home page will be displayed.</p> 
<p><img class="alignnone wp-image-4538 size-full" title="Step 2: For IAM users" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/02/IAM-User-Login-b.png" alt="Step 2: For IAM users" width="336" height="439" /></p> 
<p>With these changes, you may need to make updates to password managers so that they will work with the new sign-in experience.</p> 
<p>If you have comments about the changes to how you sign in to your AWS account as a root user or IAM user, submit a comment in the “Comments” section below. If you have questions, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>&nbsp;or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Siraj</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/security/tag/iam-user-sign-in/" rel="tag">IAM user sign-in</a>, <a href="https://aws.amazon.com/blogs/security/tag/root-user-sign-in/" rel="tag">root user sign-in</a>, <a href="https://aws.amazon.com/blogs/security/tag/sign-in/" rel="tag">sign-in</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4335');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b><a href="https://aws.amazon.com/blogs/security/now-available-the-first-guide-in-the-aws-government-handbook-series/" property="url" rel="bookmark"><span property="name headline">Now Available: The First Guide in the AWS Government Handbook Series</span></a></b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><a href="https://aws.amazon.com/blogs/security/author/clieb/" title="Posts by Craig Liebendorfer" property="name">Craig Liebendorfer</a></span> | on 
<time property="datePublished" datetime="2017-08-25T07:18:54+00:00">25 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/compliance/" title="View all posts in Compliance*"><span property="articleSection">Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-available-the-first-guide-in-the-aws-government-handbook-series/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4635" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4635&amp;disqus_title=Now+Available%3A+The+First+Guide+in+the+AWS+Government+Handbook+Series&amp;disqus_url=https://aws.amazon.com/blogs/security/now-available-the-first-guide-in-the-aws-government-handbook-series/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4635');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone wp-image-4636 size-full" title="Secure Network Connections image" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/24/securenetworkconnections.png" alt="Secure Network Connections image" width="337" height="362" /></p> 
<p>AWS recently released the first guide in the new AWS Government Handbook Series: <a href="https://d0.awsstatic.com/whitepapers/compliance/AWS_Secure_Network_Connections.pdf" target="_blank" rel="noopener noreferrer">Secure Network Connections: An evaluation of the US Trusted Internet Connections program</a>. This new series examines key cybersecurity policy initiatives that have been operating in the traditional IT space, unpacks their security objectives, and identifies lessons learned and best practices of global government first movers and early adopters seeking to achieve the initiative’s security outcomes in the cloud.</p> 
<p>In particular, “Secure Network Connections” provides guidance to government policy makers on AWS’s position and recommendations for establishing cloud-based network perimeter monitoring capabilities. Note that this guidance can be applied to any organization that requires centralized perimeter network monitoring. The guide also summarizes lessons learned from AWS’s work with the US Department of Homeland Security (DHS) through an analysis of its federal secure network connections program, Trusted Internet Connections (TIC).</p> 
<p>If you have questions or comments about this new guide, submit them in the “Comments” section below. And note that the next guide in this series will be published later this year.</p> 
<p>–&nbsp;Craig</p> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b><a href="https://aws.amazon.com/blogs/security/new-aws-devops-blog-post-how-to-help-secure-your-code-in-a-cross-regioncross-account-deployment-solution/" property="url" rel="bookmark"><span property="name headline">New AWS DevOps Blog Post: How to Help Secure Your Code in a Cross-Region/Cross-Account Deployment Solution on AWS</span></a></b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><a href="https://aws.amazon.com/blogs/security/author/clieb/" title="Posts by Craig Liebendorfer" property="name">Craig Liebendorfer</a></span> | on 
<time property="datePublished" datetime="2017-08-24T11:09:01+00:00">24 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/new-aws-devops-blog-post-how-to-help-secure-your-code-in-a-cross-regioncross-account-deployment-solution/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4622" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4622&amp;disqus_title=New+AWS+DevOps+Blog+Post%3A+How+to+Help+Secure+Your+Code+in+a+Cross-Region%2FCross-Account+Deployment+Solution+on+AWS&amp;disqus_url=https://aws.amazon.com/blogs/security/new-aws-devops-blog-post-how-to-help-secure-your-code-in-a-cross-regioncross-account-deployment-solution/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4622');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone wp-image-4624 size-full" title="Security image" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/24/security_feature.png" alt="Security image" width="250" height="250" /></p> 
<p>You can help to protect your data in a number of ways while it is in transit and at rest, such as by using Secure Sockets Layer (SSL) or client-side encryption.&nbsp;AWS Key Management Service (AWS KMS)&nbsp;is a managed service that makes it easy for you to create, control, rotate, and use your encryption keys. AWS KMS allows you to create custom keys, which you can share with&nbsp;AWS Identity and Access Management users and roles in your AWS account or in an AWS account owned by someone else.</p> 
<p>In a new AWS DevOps Blog post, BK Chaurasiya&nbsp;describes a solution for building a cross-region/cross-account code deployment solution on AWS. BK explains options for helping to protect your source code as it travels between regions and between AWS accounts.</p> 
<p>For more information, see the full <a href="https://aws.amazon.com/blogs/devops/ensuring-security-of-your-code-in-a-cross-regioncross-account-deployment-solution/" target="_blank" rel="noopener noreferrer">AWS DevOps Blog post</a>.</p> 
<p>– Craig</p> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b><a href="https://aws.amazon.com/blogs/security/aws-announces-amazon-macie/" property="url" rel="bookmark"><span property="name headline">AWS Announces Amazon Macie</span></a></b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Stephen Schmidt</span></span> | on 
<time property="datePublished" datetime="2017-08-14T13:43:50+00:00">14 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/amazon-macie/" title="View all posts in Amazon Macie*"><span property="articleSection">Amazon Macie*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-announces-amazon-macie/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4603" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4603&amp;disqus_title=AWS+Announces+Amazon+Macie&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-announces-amazon-macie/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4603');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p><img class="wp-image-4616 size-full aligncenter" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/24/AmazonMacie-500x250.png" alt="" width="500" height="250" /></p> 
<p>I’m pleased to announce that today we’ve launched a new security service,&nbsp;<a title="undefined" href="https://aws.amazon.com/macie/" target="null">Amazon Macie</a>.</p> 
<p>This service leverages machine learning to help customers prevent data loss by automatically discovering, classifying, and protecting sensitive data in AWS. Amazon Macie recognizes sensitive data such as personally identifiable information (PII) or intellectual property, providing you dashboards and alerts that give visibility into how data is being accessed or moved.&nbsp;This enables you to apply machine learning to a wide&nbsp;array&nbsp;of security and compliance workloads, and we think this will be a significant enabler for you.</p> 
<p>To learn more,&nbsp;<a title="undefined" href="https://aws.amazon.com/blogs/aws/launch-amazon-macie-securing-your-s3-buckets/" target="null">see&nbsp;the&nbsp;full AWS&nbsp;Blog post</a>.</p> 
<p>– Steve</p> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">How to Establish Federated Access to Your AWS Resources by Using Active Directory User Attributes</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">Pierre Liddle</span></span> | on 
<time property="datePublished" datetime="2017-08-08T08:09:24+00:00">08 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/identity/" title="View all posts in Identity"><span property="articleSection">Identity</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-establish-federated-access-to-your-aws-resources-by-using-active-directory-user-attributes/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-4464" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=4464&amp;disqus_title=How+to+Establish+Federated+Access+to+Your+AWS+Resources+by+Using+Active+Directory+User+Attributes&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-establish-federated-access-to-your-aws-resources-by-using-active-directory-user-attributes/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4464');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p>To govern <a href="https://aws.amazon.com/iam/details/manage-federation/" target="_blank" rel="noopener noreferrer">federated access</a> to your AWS resources, it’s a common practice to use <a href="https://technet.microsoft.com/en-us/library/dn579255(v=ws.11).aspx" target="_blank" rel="noopener noreferrer">Microsoft Active Directory (AD) groups</a>. When using AD groups, establishing federation requires the number of AD groups to be equal to the number of your AWS accounts multiplied by the number of roles in each of your AWS accounts. As you can imagine, this can result in the creation of a very large number of AD groups to manage federated access.</p> 
<p>However, some organizations have limits on how many AD groups they can create. For example, an organization might need to keep its AD group hierarchy reasonably flat and avoid a deep nesting of groups. Such a situation needs a solution that doesn’t require you to create exponentially more AD groups while still allowing you to use access control and automated user integration.</p> 
<p>In this blog post, I provide step-by-step instructions for integrating <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management (IAM)</a> with <a href="https://msdn.microsoft.com/en-us/library/bb897402.aspx" target="_blank" rel="noopener noreferrer">Microsoft Active Directory Federation Services</a> (AD&nbsp;FS) by using <a href="https://msdn.microsoft.com/en-us/library/ms680541.aspx" target="_blank" rel="noopener noreferrer">AD user attributes</a>, allowing you to establish federated access without expanding your total number of AD groups. Your organization’s enterprise administrator probably has existing processes in place for managing AD group memberships and provisioning, and you can extend these processes to the management of AD user attributes and the reduction of your organization’s dependency on AD groups.<span id="more-4464"></span></p> 
<h3>Prerequisites</h3> 
<p>This post assumes:</p> 
<ul> 
<li><a href="https://aws.amazon.com/blogs/security/enabling-federation-to-aws-using-windows-active-directory-adfs-and-saml-2-0/" target="_blank" rel="noopener noreferrer">You have a working AD directory and AD&nbsp;FS server</a>.</li> 
<li>You have <a href="https://aws.amazon.com/blogs/security/enabling-federation-to-aws-using-windows-active-directory-adfs-and-saml-2-0/" target="_blank" rel="noopener noreferrer">created an identity provider</a> (IdP) in your AWS account using your XML file (<span style="font-family: courier">https://&lt;your-server-name-here&gt;/FederationMetadata/2007-06/FederationMetadata.xml</span>) from your AD&nbsp;FS server. Remember the name of your IdP because you will use it later in this solution.</li> 
<li>You have created the appropriate <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create.html" target="_blank" rel="noopener noreferrer">IAM roles</a> in your AWS account, which will be used for federated access.</li> 
</ul> 
<p>After you satisfy these prerequisites, you can proceed to the next section of this post to configure your AD users and AD&nbsp;FS server.</p> 
<h3>Solution overview</h3> 
<p>To benefit fully from the solution in this post, your AD and AD&nbsp;FS environment should look similar to what is shown in the following diagram. I focus this post on AD users and <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claim-rules" target="_blank" rel="noopener noreferrer">claim rules</a> in an AD&nbsp;FS server. AD&nbsp;FS claim rules provide the logic to identify who has been correctly set up in AD with the appropriate user attributes to sign in via AD&nbsp;FS to the AWS Management Console.</p> 
<p><img class="alignnone size-full wp-image-4468" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/29/PierreLiddle-Diagram-072917-a.jpg" alt="" width="900" height="498" /></p> 
<p>In the preceding diagram:</p> 
<ol> 
<li>An AD user (let’s call him <span style="font-family: courier">Bob</span>) browses to the AD&nbsp;FS sample site (<span style="font-family: courier">https://<span style="color: #ff0000"><strong>Fully.Qualified.Domain.Name.Here</strong></span>/adfs/ls/IdpInitiatedSignOn.aspx</span>) inside this domain.</li> 
<li>The sign-in page authenticates <span style="font-family: courier">Bob</span> against AD. If <span style="font-family: courier">Bob</span> is already authenticated or using a domain joined workstation, he also might be prompted for his AD user name and password.</li> 
<li><span style="font-family: courier">Bob</span>’s browser receives a <a href="https://aws.amazon.com/iam/details/saml/" target="_blank" rel="noopener noreferrer">SAML </a>assertion in the form of an authentication response from AD&nbsp;FS. <span style="font-family: courier">Bob</span>’s access is authorized based on his AD group membership or on AD user attributes configured on his account.</li> 
<li><span style="font-family: courier">Bob</span>’s browser automatically posts the SAML assertion to the AWS sign-in endpoint for SAML (<span style="font-family: courier">https://signin.aws.amazon.com/saml</span>). The endpoint uses the&nbsp;<a href="http://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithSAML.html" target="_blank" rel="noopener noreferrer">AssumeRoleWithSAML&nbsp;API</a> to request temporary security credentials and then constructs a sign-in URL for the AWS Management Console using those credentials.</li> 
<li><span style="font-family: courier">Bob</span>’s browser receives the sign-in URL and redirects to the AWS Management Console.</li> 
</ol> 
<b>Deploy the solution</b> 
<h3>A. &nbsp;Configure an AD user’s account</h3> 
<p>Because the AD user attributes hold all the associated AWS account and role information when using this solution, you will start by configuring an AD user’s accounts.</p> 
<p>To edit the user attributes in an AD user’s account:</p> 
<ol> 
<li>On your AD server, in the Active Directory Users and &nbsp;Computers console, go to <strong>View</strong> &gt; <strong>Advanced Features</strong> in <strong>Active Directory Users and Computers</strong> to see the <strong>Attribute editor </strong>tab.<br /> <img class="alignnone wp-image-4586 size-full" title="Screenshot showing &quot;Advanced Features&quot; in the &quot;View&quot; menu" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-1.png" alt="Screenshot showing &quot;Advanced Features&quot; in the &quot;View&quot; menu" width="478" height="278" /></li> 
<li>For AD user <span style="font-family: courier">Bob</span>, edit one attribute using the built-in AD attribute editor. The attribute I am using is <span style="font-family: courier">url</span>, which is a multi-valued string. If you use another AD user attribute, consider how you will need to modify your AD&nbsp;FS claim rules later because different attributes may return the values differently back to the AD&nbsp;FS server. The name of the AD user attribute will be used in the AD&nbsp;FS claim rules later in this post.</li> 
<li>Bob has two AWS accounts: <span style="font-family: courier">111122223333</span> and <span style="font-family: courier">444455556666</span>. Each of <span style="font-family: courier">Bob</span>’s AWS accounts has two roles: <span style="font-family: courier">AWS-Dev</span> and <span style="font-family: courier">AWS-ReadOnly</span>. I have configured <span style="font-family: courier">Bob</span>’s <span style="font-family: courier">url</span> attribute with the corresponding values associated with his AWS accounts and roles. As part of the attribute entries, I prefixed each entry with <span style="font-family: courier">AWS-</span> to have a unique identifier. As shown in the following screenshot, I added the entries one at a time so that each value can be returned back to my AD&nbsp;FS server: 
<ul style="margin-left: 30px"> 
<li><span style="font-family: courier">AWS-111122223333-Dev</span></li> 
<li><span style="font-family: courier">AWS-111122223333-ReadOnly</span></li> 
<li><span style="font-family: courier">AWS-444455556666-Dev</span></li> 
<li><span style="font-family: courier">AWS-444455556666-ReadOnly</span></li> 
</ul> </li> 
</ol> 
<p style="padding-left: 60px"><img class="alignnone wp-image-4584 size-full" title="Screenshot of Bob’s &quot;url&quot; attribute with the corresponding values associated with his AWS accounts and roles" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-2.png" alt="Screenshot of Bob’s &quot;url&quot; attribute with the corresponding values associated with his AWS accounts and roles" width="832" height="577" /></p> 
<ol start="4"> 
<li><span style="font-family: courier">Bob</span> also requires an email address because that information will be used in the role session name when <span style="font-family: courier">Bob</span> signs in to the AWS Management Console via his chosen AWS account and associated role. We use <span style="font-family: courier">Bob</span>’s email address only because it’s a common user attribute most users have and is also unique across users. The unique identifier is then forwarded by AD&nbsp;FS to be used by AWS as a unique value for users. If you have enabled <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>, the role session name is captured in CloudTrail and allows for ease of identification of who assumed the role and subsequent API calls the user or role might have executed on the platform (for example, <span style="font-family: courier">ec2:terminateinstance</span>).<br /> <img class="alignnone wp-image-4520 size-full" title="Screenshot showing Bob's email address" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/31/Bob-Email-Address.png" alt="Screenshot showing Bob's email address" width="425" height="564" /></li> 
</ol> 
<p>Now that you have configured <span style="font-family: courier">Bob</span>’s account, you will configure the AD&nbsp;FS server claim rules.</p> 
<h3>B. &nbsp;Configure the AD&nbsp;FS server claim rules</h3> 
<p>Because this blog post assumes your environment is already up and running and to ensure that you can follow along, I am providing <a href="https://s3.amazonaws.com/awsiammedia/public/sample/ActiveDirectoryUserAttributes/AWS_ADFS_Blog_Sample-Code.zip" target="_blank" rel="noopener noreferrer">example Windows PowerShell code</a> that you can run on your AD&nbsp;FS server. This code allows you to choose a conventional approach by using AD groups in AD&nbsp;FS claim rules, or for the purposes of this post, to use AD&nbsp;FS claim rules with AD user attributes. If you use the AD group approach on your AD&nbsp;FS server with the example code, your AD group naming convention must be: <span style="font-family: courier">AWS-<strong>YourAccountNumber</strong>–<strong>YourRoleName</strong></span>. If you have already created claim rules for AWS on your AD&nbsp;FS server, I encourage you to run this code against a different AD&nbsp;FS server that has no existing AWS rules.</p> 
<p>To configure the AD&nbsp;FS claim rules:</p> 
<ol> 
<li>Open the AD&nbsp;FS console. You can find it by searching for <span style="font-family: courier">ad</span>, as shown in the following screenshot.<br /> <img class="alignnone wp-image-4587 size-full" title="Screenshot of searching for the AD FS console" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-4.png" alt="Screenshot of searching for the AD FS console" width="344" height="204" /></li> 
</ol> 
<ol start="2"> 
<li>Expand <strong>Trust Relationships</strong> and choose <strong>Relying Party Trusts.<br /> <img class="alignnone wp-image-4588 size-full" title="Screenshot of the &quot;Relying Party Trusts&quot; folder" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-5.png" alt="Screenshot of the &quot;Relying Party Trusts&quot; folder" width="950" height="216" /><br /> </strong></li> 
</ol> 
<ol start="3"> 
<li>Run the <a href="https://s3.amazonaws.com/awsiammedia/public/sample/ActiveDirectoryUserAttributes/AWS_ADFS_Blog_Sample-Code.zip" target="_blank" rel="noopener noreferrer">example Windows PowerShell code</a> from the command prompt in the same directory where you extracted the .zip file. The following screenshot shows a list of the example files from the .zip file.<br /> <img class="alignnone wp-image-4484 size-full" title="Screenshot of some example files from the supplied .zip file" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/29/PierreLiddle-Image5-072917-a.png" alt="Screenshot of some example files from the supplied .zip file" width="899" height="205" /></li> 
</ol> 
<ol start="4"> 
<li>Run the <strong>01-Configure-ADFS-AD-User-URL-mapping.ps1</strong> Windows PowerShell script to set up the AD&nbsp;FS claim rules. <strong>Note:</strong> Run this script with Administrative permissions. A&nbsp;log file is generated to which you can refer, as shown in the following screenshot.<br /> <img class="alignnone wp-image-4485 size-full" title="Screenshot showing the log file that is generated" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/29/PierreLiddle-Image6-072917.png" alt="Screenshot showing the log file that is generated" width="893" height="66" /></li> 
</ol> 
<ol start="5"> 
<li>After you run the Windows PowerShell script, you will see the new relying party trust that has been created in your AD&nbsp;FS configuration for Amazon Web Services, as shown in the following screenshot.<br /> <img class="alignnone wp-image-4589 size-full" title="Screenshot of the new relying party trust that was created by the script" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-8.png" alt="Screenshot of the new relying party trust that was created by the script" width="946" height="217" /></li> 
</ol> 
<ol start="6"> 
<li>Right-click <strong>Amazon Web Services &amp; AD User URL</strong> and choose <strong>Edit Claim Rules</strong>.<br /> <img class="alignnone wp-image-4590 size-full" title="Screenshot of choosing &quot;Edit Claim Rules&quot;" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-9.png" alt="Screenshot of choosing &quot;Edit Claim Rules&quot;" width="676" height="314" /></li> 
</ol> 
<ol start="7"> 
<li>The following screenshot shows what your AD&nbsp;FS server claim rules should look like now.<br /> <img class="alignnone wp-image-4591 size-full" title="Screenshot of how the cliam rules should look" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-10.png" alt="Screenshot of how the cliam rules should look" width="511" height="187" /></li> 
</ol> 
<p>About these four claim rules:</p> 
<ol> 
<li>Claim rule 1 captures the Windows account name of the current user whose attributes will then be queried further with claim rule 3.</li> 
<li>Claim rule 2 captures <span style="font-family: courier">Bob</span>’s email address for use in the role session name.</li> 
<li>Claim rule 3 queries the current user’s URL attributes to identify which account and role the user is authorized to assume access to. These URL attribute values are then stored in a variable (<span style="font-family: courier">http://temp/variable</span>) for use in claim rule 4.</li> 
<li>Claim rule 4 works by matching the first pattern match, <span style="font-family: courier">([^d]{12})</span>, to <span style="font-family: courier">$1</span> and the second pattern match, <span style="font-family: courier">(\w*)</span>, to <span style="font-family: courier">$2</span> for each entry in <span style="font-family: courier">http://temp/variable</span>. With this final rule, you define the resulting value for the AWS role attribute in a dynamic way, which allows the configuration to scale to support virtually&nbsp;any number of AWS accounts and IAM roles without further configuration within AD&nbsp;FS. By using these claim rules, you query, store, and then convert the values in the URL attributes to the <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_saml_assertions.html" target="_blank" rel="noopener noreferrer">IAM role attributes</a> that AWS expects.<img class="alignnone wp-image-4592 size-full" title="Screenshot of editing claim rule 4" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/08/06/PL-080817-11.png" alt="Screenshot of editing claim rule 4" width="891" height="491" /></li> 
</ol> 
<p>At the beginning of this post, I mentioned that you need to remember the name of the IdP you created in your AWS account, and now is when you will use your IdP’s name. Replace <span style="font-family: courier">myADFS</span>, <mark>highlighted</mark> in the following code, with the name of your IdP. (When modifying the rules, be careful not to insert any additional spaces because they can cause claim rules to not work as designed.)</p> 
<pre><code class="lang-text"><strong> 4)RuleName &quot; Dynamic ARN - Adding Roles &quot;</strong>
c:[Type == &quot;http://temp/variable&quot;, Value =~ &quot;(?i)^AWS-([^d]{12})-(\w*)&quot;]
=&gt; issue(Type = &quot;https://aws.amazon.com/SAML/Attributes/Role&quot;, Value = RegExReplace(c.Value, &quot;AWS-([^d]{12})-(\w*)&quot;, &quot;arn:aws:iam::$1:saml-provider/<mark>myADFS</mark>,arn:aws:iam::$1:role/AWS-$2&quot;));</code></pre> 
<h3>C. &nbsp;Test AD user Bob’s federated access</h3> 
<p>Go to the AD&nbsp;FS sign-in page (<span style="font-family: courier">https://<span style="color: #ff0000"><strong>Fully.Qualified.Domain.Name.Here</strong></span>/adfs/ls/IdpInitiatedSignOn.aspx</span>) to test <span style="font-family: courier">Bob</span>’s federated access. Note that you might see a certificate warning if the server uses a locally self-signed certificate from <a href="https://www.iis.net/" target="_blank" rel="noopener noreferrer">Internet Information Services</a>.</p> 
<p>To test <span style="font-family: courier">Bob</span>’s federated access:</p> 
<ol> 
<li>Choose&nbsp;<strong>Sign in to one of the following sites</strong>, choose&nbsp;<strong>Amazon Web Services</strong><strong>&amp; AD User URL</strong> from the list, and then choose&nbsp;<strong>Continue to Sign In</strong>.</li> 
<li>If prompted, type <span style="font-family: courier">Bob</span>’s user name and password. You will be redirected to sign in to the&nbsp;<strong>Amazon Web Services AD&nbsp;FS </strong>page previously defined when you set up the AD&nbsp;FS relying party trusts.<br /> <img class="alignnone wp-image-4496" title="Screenshot of the sign-in page" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/29/PierreLiddle-Image10-072917-a.jpg" alt="Screenshot of the sign-in page" width="400" height="411" /></li> 
</ol> 
<ol start="3"> 
<li>After you authenticate to the server as <span style="font-family: courier">Bob</span>, your browser is redirected to <span style="font-family: courier">https://signin.aws.amazon.com/saml</span>, and you can choose which of <span style="font-family: courier">Bob</span>’s accounts and roles to use from. Choose a role and then choose&nbsp;<strong>Sign In</strong>.<br /> <img class="alignnone wp-image-4497 size-full" title="Screenshot showing Bob's roles and accounts to choose from" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/29/PierreLiddle-Image11-072917-a.jpg" alt="Screenshot showing Bob's roles and accounts to choose from" width="500" height="409" /></li> 
</ol> 
<ol start="4"> 
<li>You have signed in as <span style="font-family: courier">Bob</span>, and his email address now appears as part of the role session name, as shown in the following screenshot.<br /> <img class="alignnone wp-image-4512 size-full" title="Screenshot showing Bob's email address as part of the role session name" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/31/2017-07-31_7-37-47-a.png" alt="Screenshot showing Bob's email address as part of the role session name" width="814" height="205" /></li> 
</ol> 
<p>You can now see <span style="font-family: courier">Bob</span>’s email address used in the role session name. If you have enabled CloudTrail, the role session name is captured in CloudTrail and allows you to easily identify who assumed the role. If <span style="font-family: courier">Bob</span> wants to switch to a different account or role, he can return to his AD&nbsp;FS sign-in page (<span style="font-family: courier">https://<span style="color: #ff0000"><strong>Fully.Qualified.Domain.Name.Here</strong></span>/adfs/ls/IdpInitiatedSignOn.aspx</span>) and choose an alternative account or role.</p> 
<h3>Summary</h3> 
<p>In this blog post, I demonstrated how to use dynamic resolution of federated access using AD user attributes to scale your configuration and support a large number&nbsp;of AWS accounts and associated IAM roles. This is a powerful technique for managing a large number of AWS accounts and the federated access of associated AD users. Even though I demonstrate the integration of IAM with AD&nbsp;FS and AD, you can replicate this solution across your choice of SAML federated access technology, such as <a href="https://en.wikipedia.org/wiki/Shibboleth_(Internet2)" target="_blank" rel="noopener noreferrer">Shibboleth</a> or <a href="https://en.wikipedia.org/wiki/OpenLDAP" target="_blank" rel="noopener noreferrer">OpenLDAP</a>.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have implementation or troubleshooting questions, start a new thread on the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM forum</a>.</p> 
<p>– Pierre</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/active-directory/" rel="tag">Active Directory</a>, <a href="https://aws.amazon.com/blogs/security/tag/active-directory-federation-services/" rel="tag">Active Directory Federation Services</a>, <a href="https://aws.amazon.com/blogs/security/tag/ad/" rel="tag">AD</a>, <a href="https://aws.amazon.com/blogs/security/tag/ad-fs/" rel="tag">AD FS</a>, <a href="https://aws.amazon.com/blogs/security/tag/ad-fs-setup/" rel="tag">AD FS Setup</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-iam/" rel="tag">AWS IAM</a>, <a href="https://aws.amazon.com/blogs/security/tag/microsoft-ad-fs/" rel="tag">Microsoft AD FS</a>, <a href="https://aws.amazon.com/blogs/security/tag/saml-2-0/" rel="tag">SAML 2.0</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-4464');
});
</script> 
</article> 
<article class="post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="b post-title" property="name headline">AWS Encryption SDK: How to Decide if Data Key Caching Is Right for Your Application</b> 
<footer class="meta">
by 
<span property="author" typeof="Person"><span property="name">June Blender</span></span> | on 
<time property="datePublished" datetime="2017-08-07T07:44:33+00:00">07 AUG 2017</time> | in 
<span class="categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-encryption-sdk-how-to-decide-if-data-key-caching-is-right-for-your-application/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-3955" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=3955&amp;disqus_title=AWS+Encryption+SDK%3A+How+to+Decide+if+Data+Key+Caching+Is+Right+for+Your+Application&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-encryption-sdk-how-to-decide-if-data-key-caching-is-right-for-your-application/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-3955');
});
</script> | 
<a href="#" role="button" data-share-dialog=""><span class="span icon-share"></span>&nbsp;Share</a> 
<ul> 
</ul> 
</footer> 
<p style="text-align: center"><img class="alignnone wp-image-4380 size-full" title="AWS KMS image" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/07/26/KMS_feature.png" alt="AWS KMS image" width="250" height="250" /></p> 
<p>Today, the AWS Crypto Tools team introduced a new feature in the <a href="http://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/introduction.html" target="_blank" rel="noopener noreferrer">AWS Encryption SDK</a>: <em>data key caching</em>. <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/data-key-caching.html" target="_blank" rel="noopener noreferrer">Data key caching</a> lets you reuse the data keys that protect your data, instead of generating a new data key for each encryption operation.</p> 
<p>Data key caching can reduce latency, improve throughput, reduce cost, and help you stay within service limits as your application scales. In particular, caching might help if your application is hitting the <a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service</a> (KMS) <a href="http://docs.aws.amazon.com/kms/latest/developerguide/limits.html#requests-per-second" target="_blank" rel="noopener noreferrer">requests-per-second limit</a>&nbsp;and <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">raising the limit</a> does not solve the problem.</p> 
<p>However, these benefits come with some security tradeoffs. Encryption best practices generally discourage extensive reuse of data keys.</p> 
<p>In this blog post, I explore those tradeoffs and provide information that can help you decide whether data key caching is a good strategy for your application. I also explain how data key caching is implemented in the AWS Encryption SDK and describe the security thresholds that you can set to limit the reuse of data keys. Finally, I provide some practical examples of using the security thresholds to meet cost, performance, and security goals.</p> 
<h3><strong>Introducing data key caching</strong></h3> 
<p>The AWS Encryption SDK is a client-side encryption library that makes it easier for you to implement cryptography best practices in your application. It includes secure default behavior for developers who are not encryption experts, while being flexible enough to work for the most experienced users.<span id="more-3955"></span></p> 
<p>In the AWS Encryption SDK, by default, you generate a new data key for each&nbsp;encryption operation. This is the most secure practice. However, in some applications, the overhead of generating a new data key for each operation is not acceptable.</p> 
<p>Data key caching saves the plaintext and ciphertext of the data keys you use in a configurable cache. When you need a key to encrypt or decrypt data, you can reuse a data key from the cache instead of creating a new data key. You can create multiple data key caches and configure each one independently. Most importantly, the AWS Encryption SDK provides <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/thresholds.html" target="_blank" rel="noopener noreferrer">security thresholds</a> that you can set to determine how much data key reuse you will allow.</p> 
<p>To make data key caching easier to implement, the AWS Encryption SDK provides <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/data-key-caching.html#simplecache" target="_blank" rel="noopener noreferrer">LocalCryptoMaterialsCache</a>, an in-memory, least-recently-used&nbsp;cache with a configurable size. The SDK manages the cache for you, including adding store, search, and match logic to all encryption and decryption operations.</p> 
<p>We recommend that you use LocalCryptoMaterialsCache as it is, but you can customize it, or substitute a compatible cache. However, you should never store plaintext data keys on disk.</p> 
<p>The AWS Encryption SDK documentation includes <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/sample-cache-example.html" target="_blank" rel="noopener noreferrer">sample code</a> in Java and Python for an application that uses data key caching to encrypt data sent to and from <a href="https://aws.amazon.com/kinesis/streams/" target="_blank" rel="noopener noreferrer">Amazon Kinesis Streams</a>.</p> 
<h3><strong>Balance cost and security</strong></h3> 
<p>Your decision to use data key caching should balance cost—in time, money, and resources—against security. In every consideration, though, the balance should favor your security requirements. As a rule, use the minimal caching required to achieve your cost and performance goals.</p> 
<p>Before implementing data key caching, consider the details of your applications, your security requirements, and the cost and frequency of your encryption operations. In general, your application can benefit from data key caching if each operation is slow or expensive, or if you encrypt and decrypt data frequently. If the cost and speed of your encryption operations are already acceptable or can be improved by other means, do not use a data key cache.</p> 
<p>Data key caching can be the right choice for your application if you have high encryption and decryption traffic. For example, if you are hitting your KMS&nbsp;requests-per-second limit, caching can help because you get some of your data keys from the cache instead of calling KMS for every request.</p> 
<p>However, you can also create a case in the <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">AWS Support Center</a> to raise the KMS limit for your account.&nbsp;If raising the limit solves the problem, you do not need data key caching.</p> 
<h3><strong>Configure caching thresholds for cost and security</strong></h3> 
<p>In the AWS Encryption SDK, you can configure data key caching to allow just enough data key reuse to meet your cost and performance targets while conforming&nbsp;to the security requirements of your application. The SDK enforces the thresholds&nbsp;so that you can use them with any compatible cache.</p> 
<p>The data key caching security thresholds apply to each cache entry. The AWS Encryption SDK will not use the data key from a cache entry that exceeds any of the thresholds that you set.</p> 
<ul> 
<li><strong>Maximum age </strong>(required): Set the lifetime of each cached key to be long enough to get cache hits, but short enough to limit exposure of a plaintext data key in memory to a specific time period.</li> 
</ul> 
<p style="padding-left: 30px">You can use the maximum age threshold like a key rotation policy. Use it to limit the reuse of data keys and minimize exposure of cryptographic materials. You can also use it to evict data keys when the type or source of data that your application is processing changes.</p> 
<ul> 
<li><strong>Maximum messages encrypted</strong> (optional; default is 2<sup>32</sup> messages): Set the number of messages protected by each cached data key to be large enough to get value from reuse, but small enough to limit the number of messages that might potentially be exposed.</li> 
</ul> 
<p style="padding-left: 30px">The AWS Encryption SDK only caches data keys that use an <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/supported-algorithms.html" target="_blank" rel="noopener noreferrer">algorithm suite</a> with a <a href="https://en.wikipedia.org/wiki/Key_derivation_function" target="_blank" rel="noopener noreferrer">key derivation function</a>. This technique avoids the cryptographic limits on the number of bytes encrypted with a single key. However, the more data that a key encrypts, the more data that is exposed if the data key is compromised.</p> 
<p style="padding-left: 30px">Limiting the number of messages, rather than the number of bytes, is particularly useful if your application encrypts many messages of a similar size or when potential exposure must be limited to very few messages. This threshold is also useful when you want to reuse a data key for a particular type of message and know in advance how many messages of that type you have. You can also use an <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/data-key-caching.html#caching-encryption-context" target="_blank" rel="noopener noreferrer">encryption context</a> to select particular cached data keys for your encryption requests.</p> 
<ul> 
<li><strong>Maximum bytes encrypted</strong> (optional; default is 2<sup>63</sup> – 1): Set the bytes protected by each cached data key to be large enough to allow the reuse you need, but small enough to limit the amount of data encrypted under the same key.</li> 
</ul> 
<p style="padding-left: 30px">Limiting the number of bytes, rather than the number of messages, is preferable when your application encrypts messages of widely varying size or when possibly exposing large amounts of data is much more of a concern than exposing smaller amounts of data.</p> 
<p>In addition to these security thresholds, the LocalCryptoMaterialsCache in the AWS Encryption SDK lets you set its <em>capacity</em>, which is the maximum number of entries the cache can hold.</p> 
<p>Use the capacity value to tune the performance of your LocalCryptoMaterialsCache. In general, use the smallest value that will achieve the performance improvements that your application requires. You might want to test with a very small cache of 5–10 entries and expand if necessary. You will need a slightly larger cache if you are using the cache for both encryption and decryption requests, or if you are using encryption contexts to select particular cache entries.</p> 
<h3><strong>Consider these cache configuration examples</strong></h3> 
<p>After you determine the security and performance requirements of your application, consider the cache security thresholds carefully and adjust them to meet your needs. There are no magic numbers for these thresholds: the ideal settings are specific to each application, its security and performance requirements, and budget. Use the minimal amount of caching necessary to get acceptable performance and cost.</p> 
<p>The following examples show ways you can use the LocalCryptoMaterialsCache capacity setting and the security thresholds to help meet your security requirements:</p> 
<ul> 
<li><strong>Slow master key operations: </strong>If your master key processes only 100 transactions per second (TPS) but your application needs to process 1,000 TPS, you can meet your application requirements by allowing a maximum of 10 messages to be protected under each data key.</li> 
<li><strong>High frequency and volume:</strong> If your master key costs $0.01 per operation and you need to process a consistent 1,000 TPS while staying within a budget of $100,000 per month, allow a maximum of 275 messages for each cache entry.</li> 
<li><strong>Burst traffic: </strong>If your application’s processing bursts to 100 TPS for five seconds in each minute but is otherwise zero, and your master key costs $0.01 per operation, setting maximum messages to 3 can achieve significant savings. To prevent data keys from being reused across bursts (55 seconds), set the maximum age of each cached data key to 20 seconds.</li> 
<li><strong>Expensive master key operations:</strong> If your application uses a low-throughput encryption service that costs as much as $1.00 per operation, you might want to minimize the number of operations. To do so, create a cache that is large enough to contain the data keys you need. Then, set the byte and message limits high enough to allow reuse while conforming to your security requirements. For example, if your security requirements do not permit a data key to encrypt more than 10 GB of data, setting bytes processed to 10 GB still significantly minimizes operations and conforms to your security requirements.</li> 
</ul> 
<h3><strong>Learn more about data key caching</strong></h3> 
<p>To learn more about data key caching, including how to implement it, how to set the security thresholds, and details about the caching components, see <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/data-key-caching.html" target="_blank" rel="noopener noreferrer">Data Key Caching</a> in the <a href="https://docs.aws.amazon.com/encryption-sdk/latest/developer-guide/introduction.html" target="_blank" rel="noopener noreferrer">AWS Encryption SDK</a>. Also, see the AWS Encryption SDKs for&nbsp;<a href="https://github.com/awslabs/aws-encryption-sdk-java" target="_blank" rel="noopener noreferrer">Java</a> and <a href="https://github.com/awslabs/aws-encryption-sdk-python" target="_blank" rel="noopener noreferrer">Python</a> as well as the <a href="https://awslabs.github.io/aws-encryption-sdk-java/javadoc/" target="_blank" rel="noopener noreferrer">Javadoc</a> and <a href="http://aws-encryption-sdk-python.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Python documentation</a>.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions, file an issue in the GitHub repos for the Encryption SDK in <a href="https://github.com/awslabs/aws-encryption-sdk-java" target="_blank" rel="noopener noreferrer">Java</a> or <a href="https://github.com/awslabs/aws-encryption-sdk-python" target="_blank" rel="noopener noreferrer">Python</a>, or start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=182" target="_blank" rel="noopener noreferrer">KMS forum</a>.</p> 
<p>– June</p> 
<footer> 
TAGS: 
<span property="keywords"><a href="https://aws.amazon.com/blogs/security/tag/aws-encryption-sdk/" rel="tag">AWS Encryption SDK</a>, <a href="https://aws.amazon.com/blogs/security/tag/aws-kms/" rel="tag">AWS KMS</a>, <a href="https://aws.amazon.com/blogs/security/tag/data-key-cache/" rel="tag">data key cache</a>, <a href="https://aws.amazon.com/blogs/security/tag/data-key-caching/" rel="tag">data key caching</a>, <a href="https://aws.amazon.com/blogs/security/tag/encryption/" rel="tag">Encryption</a>, <a href="https://aws.amazon.com/blogs/security/tag/kms-limits/" rel="tag">KMS limits</a></span> 
</footer> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-3955');
});
</script> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
