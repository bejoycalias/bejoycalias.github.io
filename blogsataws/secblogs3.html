<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/secblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS Security Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS Security Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="aws-blogs" class="layout-inner aws-blogs">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li class="active"><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="secblogs1.html">Page 1</a>|<a href="secblogs2.html">Page 2</a>|<a href="secblogs3.html">Page 3</a>|<a href="secblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH3a1.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Use New Advanced Security Features for Amazon Cognito User Pools</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Tim Hunt</span></span> | on 
<time property="datePublished" datetime="2018-02-19T07:57:01+00:00">19 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/mobile-services/amazon-cognito/" title="View all posts in Amazon Cognito*"><span property="articleSection">Amazon Cognito*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/mobile-services/" title="View all posts in Mobile Services*"><span property="articleSection">Mobile Services*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-use-new-advanced-security-features-for-amazon-cognito-user-pools/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7234" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7234&amp;disqus_title=How+to+Use+New+Advanced+Security+Features+for+Amazon+Cognito+User+Pools&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-use-new-advanced-security-features-for-amazon-cognito-user-pools/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7234');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://aws.amazon.com/cognito/" target="_blank" rel="noopener noreferrer">Amazon Cognito</a> lets you easily add user sign-up, sign-in, and access control to your mobile and web apps. You can use fully managed user directories, called <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" target="_blank" rel="noopener noreferrer">Amazon Cognito user pools</a>, to create accounts for your users, allow them to sign in, and update their profiles. Your users also can sign in by using external identity providers (IdPs) by <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-identity-federation.html" target="_blank" rel="noopener noreferrer">federating</a> with Amazon, Google, Facebook, SAML, or OpenID Connect (OIDC)–based IdPs. If your app is backed by resources, Amazon Cognito also gives you tools to manage permissions for accessing resources through <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" target="_blank" rel="noopener noreferrer">roles</a> and <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html" target="_blank" rel="noopener noreferrer">policies</a>, and through integration with <a href="https://aws.amazon.com/apigateway/" target="_blank" rel="noopener noreferrer">Amazon API Gateway</a>.</p> 
<p>In this post, I explain some new advanced security features (in beta) that were launched at AWS re:Invent 2017 for Amazon Cognito user pools and how to use them. Note that separate prices apply to these advanced security features, as described on our <a href="https://aws.amazon.com/cognito/pricing/" target="_blank" rel="noopener noreferrer">pricing page</a>.</p> 
<h3>The new advanced security features of Amazon Cognito</h3> 
<p>Security is the top priority for Amazon Cognito. We handle user authentication and authorization to control access to your web and mobile apps, so security is vital. The new advanced security features add additional protections for your users that you manage in Amazon Cognito user pools. In particular, we have added protection against compromised credentials and risk-based adaptive authentication.</p> 
<h4>Compromised credentials protection</h4> 
<p>Our compromised credentials feature protects your users’ accounts by preventing your users from reusing credentials (a user name and password pair) that have been exposed elsewhere. This new feature addresses the issue of users reusing the same credentials for multiple websites and apps. For example, a user might use the same email address and password to sign in to multiple websites.</p> 
<p>A security best practice is to never use the same user name password in different systems. If an attacker is able to obtain user credentials through a breach of one system, they could use those user credentials to access other systems. AWS has been able to form partnerships and programs so that Amazon Cognito is informed when a set of credentials has been compromised elsewhere. When you use compromised credentials protection in Amazon Cognito, you can prevent users of your application from signing up, signing in, and changing their password with credentials that are recognized as having been compromised. If a user attempts to use credentials that we detect have been compromised, that user is required to choose a different password.</p> 
<h4>Risk-based adaptive authentication</h4> 
<p>The other major advanced security feature we launched at AWS re:Invent 2017 is risk-based adaptive authentication. Adaptive authentication protects your users from attempts to compromise their accounts—and it does so intelligently to minimize any inconvenience for your customers. With adaptive authentication, Amazon Cognito examines each user pool sign-in attempt and generates a risk score for how likely the sign-in request is to be from a malicious attacker.</p> 
<p>Amazon Cognito examines a number of factors, including whether the user has used the same device before, or has signed in from the same location or IP address. A detected risk is rated as low, medium, or high, and you can determine what actions should be taken at each risk level. You can choose to block the request if the risk level is high, or you can choose to require a second factor of authentication, in addition to the password, for the user to sign in using multi-factor authentication (MFA). With adaptive authentication, users continue to sign in with just their password when the request has characteristics of successful sign-ins in the past. Users are prompted for a second factor only when some risk is detected with a sign-in request.</p> 
<p>To learn more about using MFA with adaptive authentication, see <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html" target="_blank" rel="noopener noreferrer">Multi-Factor (MFA) Authentication Settings</a>. Amazon Cognito also can now <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-email-phone-verification.html" target="_blank" rel="noopener noreferrer">verify email addresses and mobile phone numbers</a> as part of the authentication process.</p> 
<h4><strong>Metrics and data with the advanced security features</strong></h4> 
<p>In addition, both the compromised credentials and adaptive authentication features provide metrics and data about the following:</p> 
<li>Sign-up, sign-in, and forgotten-password events</li> 
<li>The risk scores that are assigned to events</li> 
<li>The results of sign-in attempts and second-factor challenges</li> 
<p>You can view aggregate metrics by using the <a href="https://aws.amazon.com/cloudwatch/" target="_blank" rel="noopener noreferrer">Amazon CloudWatch</a> console. You also can view each user’s sign-in history in the <a href="https://console.aws.amazon.com/cognito/home" target="_blank" rel="noopener noreferrer">Amazon Cognito console</a>.</p> 
<h3>How to configure the advanced security features</h3> 
<p>Now that I’ve described the new advanced security features, I will show how to configure them for your mobile or web app. You have to create an Amazon Cognito user pool in the console and save it before you can see the advanced security settings.</p> 
<p>First you must create and configure an Amazon Cognito user pool:</p> 
<ol> 
<li>Go to the <a href="https://console.aws.amazon.com/cognito/home" target="_blank" rel="noopener noreferrer">Amazon Cognito console</a>, and choose <strong>Manage your User Pools</strong> to get started. If you already have a user pool that you can work with, choose that user pool. Otherwise, choose <strong>Create a user pool</strong> to create a new one.</li> 
<li>On the <strong>MFA and verifications</strong> tab (see the following screenshot), enable MFA as <strong>Optional</strong> so that your individual users can choose to configure second factors of authentication, which are needed for adaptive authentication. (If you were to choose <strong>Required</strong> as the MFA setting for your user pool instead, all sign-ins would require a second factor of authentication. This would effectively disable adaptive authentication because a second factor of authentication would always be required.)</li> 
</ol> 
<p style="padding-left: 40px">You should also enable at least one second factor of authentication. As shown in the following screenshot, I have enabled both <strong>SMS text message</strong> and <strong>Time-based One-time Password</strong> (TOTPs).<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH1a.png" /></p> 
<ol start="3"> 
<li>On the <strong>App clients</strong> tab, create an app client by choosing <strong>add an app client</strong>, entering a name, and choosing <strong>Create app client</strong>.</li> 
</ol> 
<p>Second, configure the advanced security features:</p> 
<ol> 
<li>After you’ve configured and saved your user pool, you will see the <strong>Advanced security</strong> tab, as shown in the following screenshot. You can choose one of three modes for enabling the advanced security features: <strong>Yes</strong>, <strong>Audit only</strong>, and <strong>No</strong>: 
<li>If you choose <strong>No</strong>, the advanced features are all turned off.</li> 
<li>If you choose <strong>Audit only</strong>, Amazon Cognito logs all related events to CloudWatch metrics so that you can see what risks are detected, but Amazon Cognito doesn’t take any explicit actions to protect your users. Use the <strong>Audit only</strong> mode to understand what events are happening before you fully turn on the advanced security features.</li> 
<li>If you choose <strong>Yes</strong>, you turn on the advanced security features. We recommend that you initially run the advanced security features in <strong>Audit only</strong> mode for two weeks before choosing <strong>Yes</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH2a.png" /></li> 
</ul> </li> 
</ol> 
<ol start="2"> 
<li>When you choose <strong>Yes</strong> to turn on the advanced security features, configuration options appear, as shown in the following screenshot: 
<ol type="a"> 
<li>First, choose if you want to configure default settings for all of your app clients, or if you want to configure settings for a specific app client. As shown in the following screenshot, you can see that I’ve chosen global default settings for all my app clients.</li> 
<li>Next, choose the action you want to take when compromised credentials are detected. You can either <strong>Allow</strong> compromised credentials, or you can <strong>Block use </strong>of them. If you want to protect your users, you should choose <strong>Block use</strong>. However, you first can watch the metrics in CloudWatch without taking action by choosing <strong>Allow</strong>. You also can choose <strong>Customize when compromised credentials are blocked</strong>, which allows you to choose for which operations—sign up, sign in, and forgotten password—Amazon Cognito will detect and block use of compromised credentials.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH3a.png" /></li> 
</ol> </li> 
</ol> 
<ol start="3"> 
<li>The next section on the <strong>Advanced security</strong> tab includes the configuration for adaptive authentication. For each risk level (<strong>Low</strong>, <strong>Medium</strong>, and <strong>High</strong>), you can require a second factor for MFA or you can block the request, and you can notify users about the events through email. You have two MFA choices for each risk level: 
<ol type="a"> 
<li><strong>Optional MFA</strong> – Requires a second factor at that risk level for all users who have configured either SMS or TOTP as a second factor of authentication. Users who haven’t configured a second factor are allowed to sign in without a second factor. For optional MFA, you should encourage your users to configure a second factor of authentication for added security, but users who haven’t configured a second factor aren’t blocked from signing in.</li> 
<li><strong>Require MFA</strong> – Requires a second factor of authentication from all users when a risk is detected, so any users who haven’t configured a second factor are blocked from signing in at any risk level that requires MFA.</li> 
<li><strong>Block –</strong> Blocks the sign-in attempt.</li> 
<li><strong>Notify users</strong> – Sends an email to the users to notify them about the sign-in attempt. You can customize the emails as described below.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH4a.png" /></li> 
</ol> </li> 
<li>In the next section on the <strong>Advanced security</strong> tab, you can customize the email notifications that Amazon Cognito sends to your users if you have selected <strong>Notify users</strong>. Amazon Cognito sends these notification emails through <a href="https://aws.amazon.com/ses/" target="_blank" rel="noopener noreferrer">Amazon Simple Email Service</a> (Amazon SES). If you haven’t already, you should go to the <a href="https://console.aws.amazon.com/ses/home" target="_blank" rel="noopener noreferrer">Amazon SES console</a> to <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-addresses-and-domains.html" target="_blank" rel="noopener noreferrer">configure and verify an email address or domain</a> so that you can use it as the <strong>FROM email address</strong> for the notification emails that Amazon Cognito sends.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH5a.png" /></li> 
</ol> 
<p style="padding-left: 40px">You can customize the email subject and body for the email notifications with both HTML and plain text versions, as shown in the following screenshot.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH6a.png" /></p> 
<ol start="5"> 
<li>Optionally, you can enter IP addresses that you either want to <strong>Always allow</strong> by bypassing the compromised credentials and adaptive authentication features, or to <strong>Always block</strong>. For example, if you have a site where you do testing and development, you might want to include the IP address range from that site in the <strong>Always allow</strong> list so that it doesn’t get mistaken as a risky sign-in attempt.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH7a.png" /></li> 
</ol> 
<p>That’s all it takes to configure the advanced security features in the Amazon Cognito console.</p> 
<h3>Enabling the advanced security features from you app</h3> 
<p>After you have configured the advanced security features for your user pool, you need to enable them in your mobile or web app. First you need to include a version of our SDK that is recent enough to support the features, and second in some cases, you need to set some values for iOS, Android, and JavaScript.</p> 
<p><strong>iOS:</strong> If you’re building your own user interface to sign in users and integrating the <a href="https://github.com/aws/aws-sdk-ios/tree/master/AWSCognitoIdentityProvider" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity Provider SDK</a>, use at least version 2.6.7 of the SDK. If you’re using the <a href="https://github.com/aws/aws-sdk-ios/tree/master/AWSCognitoAuth" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth SDK</a> to incorporate the customizable, hosted user interface to sign in users, also use at least version 2.6.7. If you’re configuring the Auth SDK by using <code>Info.plist</code>, add the <code>PoolIdForEnablingASF</code> key to your Amazon Cognito user pool configuration, and set it to your user pool ID. If you’re configuring the Auth SDK by using <code>AWSCognitoAuthConfiguration</code>, use <a href="http://docs.aws.amazon.com/AWSiOSSDK/latest/Classes/AWSCognitoAuthConfiguration.html#//api/name/initWithAppClientId:appClientSecret:scopes:signInRedirectUri:signOutRedirectUri:webDomain:identityProvider:idpIdentifier:userPoolIdForEnablingASF:" target="_blank" rel="noopener noreferrer">this initializer</a> and specify your user pool ID as <code>userPoolIdForEnablingASF</code>. For more details, see the <a href="https://github.com/awslabs/aws-sdk-ios-samples/tree/master/CognitoAuth-Sample" target="_blank" rel="noopener noreferrer">CognitoAuth sample app</a>.</p> 
<p><strong>Android:</strong> If you’re using the <a href="https://github.com/aws/aws-sdk-android/tree/master/aws-android-sdk-cognitoauth" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth SDK for Android</a> that incorporates the hosted UI to sign in users, or if you’re using the <a href="https://github.com/aws/aws-sdk-android/tree/master/aws-android-sdk-cognitoidentityprovider" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity Provider SDK for Android</a> to integrate your own native user interface, use at least version 2.6.9 of the SDK.</p> 
<p><strong>JavaScript:</strong> If you’re using the <a href="https://github.com/aws/amazon-cognito-auth-js" target="_blank" rel="noopener noreferrer">Amazon Cognito Auth JS SDK</a> to incorporate the customizable, hosted UI to sign in users, use at least version 1.1.0 of the SDK. To configure the advanced security features, add the <code>AdvancedSecurityDataCollectionFlag</code> parameter and set it as <code>true</code>. Also add the <code>UserPoolId</code> parameter and set it to your user pool ID.&nbsp;In your application, you need to include <code>&quot;https://amazon-cognito-assets.&lt;region&gt;.amazoncognito.com/amazon-cognito-advanced-security-data.min.js&quot;</code> to collect data about requests. For more details, see the <a href="https://github.com/aws/amazon-cognito-auth-js/blob/master/README.md" target="_blank" rel="noopener noreferrer">README.md</a> of the Auth JavaScript SDK and the <a href="https://github.com/aws/amazon-cognito-auth-js/blob/master/sample/SAMPLEREADME.md" target="_blank" rel="noopener noreferrer">SAMPLEREADME.md</a> of the web app sample. If you’re using the <a href="https://github.com/aws/amazon-cognito-identity-js/" target="_blank" rel="noopener noreferrer">Amazon Cognito Identity SDK</a> to build your own UI, use at least version 1.28.0 of the SDK.</p> 
<h3>Some examples of the advanced security features in action</h3> 
<p>Now that I have configured these advanced security features, let’s look at them in action. I’m using the customizable, hosted sign-up and sign-in screens that are built into Amazon Cognito user pools. I’ve done some minimal customization, and my sign-up page is shown in the following screenshot.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH8.png" /></p> 
<p>With the compromised credentials feature, if a user tries to sign up with credentials that have been exposed at another site, the user is told they cannot use that password for security reasons.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH9.png" /></p> 
<p>If a user signs in, Amazon Cognito detects a risk, and you have configured adaptive authentication, the user is asked for a second factor of authentication. The following screenshot shows an example of an SMS text message used for MFA. After the user enters a valid code from their phone, they’re successfully signed in.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH10.png" /></p> 
<p>As I mentioned earlier in this post, Amazon Cognito also can notify your users whenever there’s a sign-in attempt that’s determined to have some risk. The following screenshot shows a basic example of a notification message, and you can customize these messages, as described previously.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH11.png" /></p> 
<p>The advanced security features also provide aggregate metrics and event histories for individual users. You can view the aggregate metrics in the <a href="https://console.aws.amazon.com/cloudwatch" target="_blank" rel="noopener noreferrer">CloudWatch console</a>. Navigate to the <strong>Metrics</strong> section under <strong>Cognito</strong>. When you’re graphing, choose the <strong>Graphed metrics</strong> tab and choose <strong>Sum</strong> as the <strong>Statistic</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH12a.png" /></p> 
<p>You can view the event histories for users in the Amazon Cognito console on the <strong>Users and groups</strong> tab. When you choose an individual user, you see that user’s event history listed under their profile information. As the following screenshot shows, you can see information about users’ events, including the date and time, the event type, the risk detected, and location. The event history includes the <strong>Risk level</strong> that indicates the <strong>Low</strong>, <strong>Medium</strong>, or <strong>High</strong> ratings described earlier and the <strong>Risk decision</strong> that indicates if a risk was detected and what type.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/TH13a.png" /></p> 
<p>When you choose an entry, you see the event details and the option to <strong>Mark event as</strong> <strong>valid</strong> if it was from the user, or <strong>Mark event as invalid</strong> if it wasn’t.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/15/TH14a.png" /></p> 
<h3>Summary</h3> 
<p>You can use these advanced security features of Amazon Cognito user pools to protect your users from compromised credentials and attempts to compromise their user pool–based accounts in your app. You also can customize the actions taken in response to different risks, or you can use audit mode to gather metrics on detected risks without taking action. For more information about using these features, see the <a href="http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-settings-advanced-security.html" target="_blank" rel="noopener noreferrer">Amazon Cognito Developer Guide</a>.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about how to configure or use these features, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=173" target="_blank" rel="noopener noreferrer">Amazon Cognito forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Tim</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7234');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/KVB_0118-767x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Patch Linux Workloads on AWS</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Koen van Blijderveen</span></span> | on 
<time property="datePublished" datetime="2018-02-15T08:04:20+00:00">15 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/management-tools/amazon-ec2-systems-manager/" title="View all posts in Amazon EC2 Systems Manager*"><span property="articleSection">Amazon EC2 Systems Manager*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-patch-linux-workloads-on-aws/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7266" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7266&amp;disqus_title=How+to+Patch+Linux+Workloads+on+AWS&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-patch-linux-workloads-on-aws/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7266');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Most malware tries to compromise your systems by using a known vulnerability that the operating system maker has already patched. As best practices to help prevent malware from affecting your systems, you should apply all operating system patches and actively monitor your systems for missing patches.</p> 
<p>In this blog post, I show you how to patch Linux workloads using <a href="https://aws.amazon.com/ec2/systems-manager" target="_blank" rel="noopener noreferrer">AWS Systems Manager</a>. To accomplish this, I will show you how to use the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS Command Line Interface</a> (AWS CLI) to:</p> 
<ol> 
<li><strong>Launch an </strong><a href="https://aws.amazon.com/ec2/" target="_blank" rel="noopener noreferrer"><strong>Amazon EC2</strong></a><strong> instance</strong> for use with Systems Manager.</li> 
<li><strong>Configure Systems Manager</strong> to patch your Amazon EC2 Linux instances.</li> 
</ol> 
<p>In two previous blog posts (<a href="https://aws.amazon.com/blogs/security/how-to-patch-inspect-and-protect-microsoft-windows-workloads-on-aws-part-1/" target="_blank" rel="noopener noreferrer">Part 1</a> and <a href="https://aws.amazon.com/blogs/security/how-to-patch-inspect-and-protect-microsoft-windows-workloads-on-aws-part-2/" target="_blank" rel="noopener noreferrer">Part 2</a>), I showed how to use the AWS Management Console to perform the necessary steps to patch, inspect, and protect Microsoft Windows workloads. You can implement those same processes for your Linux instances running in AWS by changing the instance tags and types shown in the previous blog posts.</p> 
<p>Because most Linux system administrators are more familiar with using a command line, I show how to patch Linux workloads by using the AWS CLI in this blog post. The steps to use the <a href="https://docs.aws.amazon.com/solutions/latest/ebs-snapshot-scheduler/overview.html" target="_blank" rel="noopener noreferrer">Amazon EBS Snapshot Scheduler</a> and <a href="https://aws.amazon.com/inspector/" target="_blank" rel="noopener noreferrer">Amazon Inspector</a> are identical for both Microsoft Windows and Linux.</p> 
<h3>What you should know first</h3> 
<p>To follow along with the solution in this post, you need one or more Amazon EC2 instances. You may use existing instances or create new instances. For this post, I assume this is an <a href="https://aws.amazon.com/amazon-linux-ami/" target="_blank" rel="noopener noreferrer">Amazon EC2 for Amazon Linux</a> instance installed from <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank" rel="noopener noreferrer">Amazon Machine Images</a> (AMIs).</p> 
<p>Systems Manager is a collection of capabilities that helps you automate management tasks for AWS-hosted instances on Amazon EC2 and your on-premises servers. In this post, I use Systems Manager for two purposes: to run remote commands and apply operating system patches. To learn about the full capabilities of Systems Manager, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" target="_blank" rel="noopener noreferrer">What Is AWS Systems Manager?</a></p> 
<p>As of Amazon Linux 2017.09, the AMI comes preinstalled with the Systems Manager agent. <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-patch.html" target="_blank" rel="noopener noreferrer">Systems Manager Patch Manager</a> also supports Red Hat and Ubuntu. To install the agent on these Linux distributions or an older version of Amazon Linux, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html" target="_blank" rel="noopener noreferrer">Installing and Configuring SSM Agent on Linux Instances</a>.</p> 
<p>If you are not familiar with how to launch an Amazon EC2 instance, see <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launching-instance.html" target="_blank" rel="noopener noreferrer">Launching an Instance</a>. I also assume you launched or will launch your instance in a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Subnets.html" target="_blank" rel="noopener noreferrer">private subnet</a>. You must make sure that the Amazon EC2 instance can connect to the internet using a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html" target="_blank" rel="noopener noreferrer">network address translation (NAT) instance</a> or <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">NAT gateway</a> to communicate with Systems Manager. The following diagram shows how you should structure your VPC.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/13/KVB_0118_a.png" /></p> 
<p>Later in this post, you will assign tasks to a maintenance window to patch your instances with Systems Manager. To do this, the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html" target="_blank" rel="noopener noreferrer">IAM user</a> you are using for this post must have the <code><a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html" target="_blank" rel="noopener noreferrer">iam:PassRole</a></code> permission. This permission allows the IAM user assigning tasks to pass his own IAM permissions to the AWS service. In this example, when you assign a task to a maintenance window, IAM passes your credentials to Systems Manager. You also should authorize your IAM user to use Amazon EC2 and Systems Manager. As mentioned before, you will be using the AWS CLI for most of the steps in this blog post. Our documentation shows you <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" target="_blank" rel="noopener noreferrer">how to get started with the AWS CLI</a>. Make sure you have the AWS CLI installed and configured with an AWS access key and secret access key that belong to an IAM user that have the following AWS managed policies attached to the IAM user you are using for this example: <code>AmazonEC2FullAccess</code> and <code>AmazonSSMFullAccess</code>.</p> 
<b>Step 1: Launch an Amazon EC2 Linux instance</b> 
<p>In this section, I show you how to launch an Amazon EC2 instance so that you can use Systems Manager with the instance. This step requires you to do three things:</p> 
<ol type="A"> 
<li><strong>Create an IAM role for Systems Manager</strong> before launching your Amazon EC2 instance.</li> 
<li><strong>Launch your Amazon EC2 instance </strong>with Amazon EBS and the IAM role for Systems Manager.</li> 
<li><strong>Add tags</strong> to the instances so that you can add your instances to a Systems Manager maintenance window based on tags.</li> 
</ol> 
<h3>A. Create an IAM role for Systems Manager</h3> 
<p>Before launching an Amazon EC2 instance, I recommend that you first create an <a href="https://aws.amazon.com/iam/details/manage-roles/" target="_blank" rel="noopener noreferrer">IAM role</a> for Systems Manager, which you will use to update the Amazon EC2 instance. AWS already provides a preconfigured policy that you can use for the new role and it is called <code>AmazonEC2RoleforSSM</code>.</p> 
<ol> 
<li>Create a JSON file named <code>trustpolicy-ec2ssm.json</code> that contains the following trust policy. This policy describes which principal (an entity that can take action on an AWS resource) is allowed to assume the role we are going to create. In this example, the principal is the Amazon EC2 service. 
<code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: {
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;Service&quot;: &quot;ec2.amazonaws.com&quot;},
&quot;Action&quot;: &quot;sts:AssumeRole&quot;
}
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to create a role named <code>EC2SSM</code> that has the AWS managed policy <code>AmazonEC2RoleforSSM</code> attached to it. This generates JSON-based output that describes the role and its parameters, if the command is successful. 
<code class="lang-text">$ aws iam create-role --role-name EC2SSM --assume-role-policy-document file://trustpolicy-ec2ssm.json</code> 
</ol> 
<ol start="3"> 
<li>Use the following command to attach the AWS managed IAM policy (<code>AmazonEC2RoleforSSM</code>) to your newly created role. 
<code class="lang-text">$ aws iam attach-role-policy --role-name EC2SSM --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM</code> 
</ol> 
<ol start="4"> 
<li>Use the following commands to create the IAM <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" target="_blank" rel="noopener noreferrer">instance profile</a> and add the role to the instance profile. The instance profile is needed to attach the role we created earlier to your Amazon EC2 instance. 
<code class="lang-text">$ aws iam create-instance-profile --instance-profile-name EC2SSM-IP
$ aws iam add-role-to-instance-profile --instance-profile-name EC2SSM-IP --role-name EC2SSM</code> 
</ol> 
<h3>B. Launch your Amazon EC2 instance</h3> 
<p>To follow along, you need an Amazon EC2 instance that is running Amazon Linux. You can use any existing instance you may have or create a new instance.</p> 
<p>When launching a new Amazon EC2 instance, be sure that:</p> 
<li>The operating system is Amazon Linux.</li> 
<li>You attach the newly created IAM role (<code>EC2SSM</code>).</li> 
<li>The Amazon EC2 instance can connect to Systems Manager through a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">network address translation (NAT) gateway</a> or a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html" target="_blank" rel="noopener noreferrer">NAT instance</a>.</li> 
<ol> 
<li>Use the following command to launch a new Amazon EC2 instance using an Amazon Linux AMI available in the US East (N. Virginia) Region (also known as us-east-1). Replace <code>YourKeyPair</code> and <code>YourSubnetId</code> with your information. For more information about creating a key pair, see the <a href="https://docs.aws.amazon.com/cli/latest/reference/ec2/create-key-pair.html" target="_blank" rel="noopener noreferrer">create-key-pair documentation</a>. Write down the <code>InstanceId</code> that is in the output because you will need it later in this post. 
<code class="lang-text">$ aws ec2 run-instances --image-id ami-cb9ec1b1 --instance-type t2.micro --key-name <span style="color: #ff0000">YourKeyPair</span> --subnet-id <span style="color: #ff0000">YourSubnetId</span> --iam-instance-profile Name=EC2SSM-IP</code> 
</ol> 
<ol start="2"> 
<li>If you are using an existing Amazon EC2 instance, you can use the following command to attach the instance profile you created earlier to your instance. 
<code class="lang-text">$ aws ec2 associate-iam-instance-profile --instance-id <span style="color: #ff0000">YourInstanceId</span> --iam-instance-profile Name=EC2SSM-IP</code> 
</ol> 
<h3>C. Add tags</h3> 
<p>The final step of configuring your Amazon EC2 instances is to add tags. You will use these tags to configure Systems Manager in Step 2 of this post. For this example, I add a tag named <code>Patch Group</code> and set the value to <code>Linux Servers</code>. I could have other groups of Amazon EC2 instances that I treat differently by having the same tag name but a different tag value. For example, I might have a collection of other servers with the tag name <code>Patch Group</code> with a value of <code>Web Servers</code>.</p> 
<li>Use the following command to add the <code>Patch Group</code> tag to your Amazon EC2 instance. 
<code class="lang-text">$ aws ec2 create-tags --resources <span style="color: #ff0000">YourInstanceId</span> --tags --tags Key=&quot;Patch Group&quot;,Value=&quot;Linux Servers&quot;</code> 
<p style="padding-left: 40px"><strong>Note:</strong> You must wait a few minutes until the Amazon EC2 instance is available before you can proceed to the next section. To make sure your Amazon EC2 instance is online and ready, you can use the following AWS CLI command:</p> 
<code class="lang-text">$ aws ec2 describe-instance-status --instance-ids <span style="color: #ff0000">YourInstanceId</span></code> 
<p>At this point, you now have at least one Amazon EC2 instance you can use to configure Systems Manager.</p> 
<b>Step 2: Configure Systems Manager</b> 
<p>In this section, I show you how to configure and use Systems Manager to apply operating system patches to your Amazon EC2 instances, and how to manage patch compliance.</p> 
<p>To start, I provide some background information about Systems Manager. Then, I cover how to:</p> 
<ol> 
<li><strong>Create the Systems Manager IAM role</strong> so that Systems Manager is able to perform patch operations.</li> 
<li><strong>Create a Systems Manager patch baseline and associate it with your instance </strong>to define which patches Systems Manager should apply.</li> 
<li><strong>Define a maintenance window</strong> to make sure Systems Manager patches your instance when you tell it to.</li> 
<li><strong>Monitor patch compliance </strong>to verify the patch state of your instances.</li> 
</ol> 
<p>You must meet two prerequisites to use Systems Manager to apply operating system patches. First, you must attach the IAM role you created in the previous section, <code>EC2SSM</code>, to your Amazon EC2 instance. Second, you must install the Systems Manager agent on your Amazon EC2 instance. If you have used a recent Amazon Linux AMI, Amazon has already installed the Systems Manager agent on your Amazon EC2 instance. You can confirm this by logging in to an Amazon EC2 instance and checking the Systems Manager agent log files that are located at <code>/var/log/amazon/ssm/</code>.</p> 
<p>To install the Systems Manager agent on an instance that does not have the agent preinstalled or if you want to use the Systems Manager agent on your on-premises servers, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html" target="_blank" rel="noopener noreferrer">Installing and Configuring the Systems Manager Agent on Linux Instances</a>. If you forgot to attach the newly created role when launching your Amazon EC2 instance or if you want to attach the role to already running Amazon EC2 instances, see <a href="https://aws.amazon.com/blogs/security/new-attach-an-aws-iam-role-to-an-existing-amazon-ec2-instance-by-using-the-aws-cli/" target="_blank" rel="noopener noreferrer">Attach an AWS IAM Role to an Existing Amazon EC2 Instance by Using the AWS CLI</a> or use the <a href="https://aws.amazon.com/blogs/security/easily-replace-or-attach-an-iam-role-to-an-existing-ec2-instance-by-using-the-ec2-console/" target="_blank" rel="noopener noreferrer">AWS Management Console</a>.</p> 
<h3>A. Create the Systems Manager IAM role</h3> 
<p>For a maintenance window to be able to run any tasks, you must create a new role for Systems Manager. This role is a different kind of role than the one you created earlier: this role will be used by Systems Manager instead of Amazon EC2. Earlier, you created the role, <code>EC2SSM</code>, with the policy, <code>AmazonEC2RoleforSSM</code>, which allowed the Systems Manager agent on your instance to communicate with Systems Manager. In this section, you need a new role with the policy, <code>AmazonSSMMaintenanceWindowRole</code>, so that the Systems Manager service can execute commands on your instance.</p> 
<p>To create the new IAM role for Systems Manager:</p> 
<ol> 
<li>Create a JSON file named <code>trustpolicy-maintenancewindowrole.json</code> that contains the following trust policy. This policy describes which principal is allowed to assume the role you are going to create. This trust policy allows not only Amazon EC2 to assume this role, but also Systems Manager. 
<code class="lang-text">{
&quot;Version&quot;:&quot;2012-10-17&quot;,
&quot;Statement&quot;:[
{
&quot;Sid&quot;:&quot;&quot;,
&quot;Effect&quot;:&quot;Allow&quot;,
&quot;Principal&quot;:{
&quot;Service&quot;:[
&quot;ec2.amazonaws.com&quot;,
&quot;ssm.amazonaws.com&quot;
]
},
&quot;Action&quot;:&quot;sts:AssumeRole&quot;
}
]
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to create a role named <code>MaintenanceWindowRole</code> that has the AWS managed policy, <code>AmazonSSMMaintenanceWindowRole</code>, attached to it. This command generates JSON-based output that describes the role and its parameters, if the command is successful. 
<code class="lang-text">$ aws iam create-role --role-name MaintenanceWindowRole --assume-role-policy-document file://trustpolicy-maintenancewindowrole.json</code> 
</ol> 
<ol start="3"> 
<li>Use the following command to attach the AWS managed IAM policy (<code>AmazonEC2RoleforSSM</code>) to your newly created role. 
<code class="lang-text">$ aws iam attach-role-policy --role-name MaintenanceWindowRole --policy-arn arn:aws:iam::aws:policy/service-role/AmazonSSMMaintenanceWindowRole</code> 
</ol> 
<h3>B. Create a Systems Manager patch baseline and associate it with your instance</h3> 
<p>Next, you will create a Systems Manager patch baseline and associate it with your Amazon EC2 instance. A patch baseline defines which patches Systems Manager should apply to your instance. Before you can associate the patch baseline with your instance, though, you must determine if Systems Manager recognizes your Amazon EC2 instance. Use the following command to list all instances managed by Systems Manager. The <code>--filters</code> option ensures you look only for your newly created Amazon EC2 instance.</p> 
<code class="lang-text">$ aws ssm describe-instance-information --filters Key=InstanceIds,Values= <span style="color: #ff0000">YourInstanceId</span>
{
&quot;InstanceInformationList&quot;: [
{
&quot;IsLatestVersion&quot;: true,
&quot;ComputerName&quot;: &quot;ip-10-50-2-245&quot;,
&quot;PingStatus&quot;: &quot;Online&quot;,
&quot;InstanceId&quot;: &quot;<span style="color: #ff0000">YourInstanceId</span>&quot;,
&quot;IPAddress&quot;: &quot;10.50.2.245&quot;,
&quot;ResourceType&quot;: &quot;EC2Instance&quot;,
&quot;AgentVersion&quot;: &quot;2.2.120.0&quot;,
&quot;PlatformVersion&quot;: &quot;2017.09&quot;,
&quot;PlatformName&quot;: &quot;Amazon Linux AMI&quot;,
&quot;PlatformType&quot;: &quot;Linux&quot;,
&quot;LastPingDateTime&quot;: 1515759143.826
}
]
}</code> 
<p>If your instance is missing from the list, verify that:</p> 
<ol> 
<li>Your instance is running.</li> 
<li>You attached the Systems Manager IAM role, <code>EC2SSM</code>.</li> 
<li>You deployed a <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">NAT gateway</a> in your public subnet to ensure your VPC reflects the diagram shown earlier in this post so that the Systems Manager agent can connect to the Systems Manager internet endpoint.</li> 
<li>The <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-agent-logs.html" target="_blank" rel="noopener noreferrer">Systems Manager agent logs</a> don’t include any unaddressed errors.</li> 
</ol> 
<p>Now that you have checked that Systems Manager can manage your Amazon EC2 instance, it is time to create a patch baseline. With a patch baseline, you define which patches are approved to be installed on all Amazon EC2 instances associated with the patch baseline. The <code>Patch Group</code> resource tag you defined earlier will determine to which patch group an instance belongs. If you do not specifically define a patch baseline, the default AWS-managed patch baseline is used.</p> 
<p>To create a patch baseline:</p> 
<ol> 
<li>Use the following command to create a patch baseline named <code>AmazonLinuxServers</code>. With approval rules<strong>,</strong> you can determine the approved patches that will be included in your patch baseline. In this example, you add all <code>Critical</code> severity patches to the patch baseline as soon as they are released, by setting the <code>Auto approval delay</code> to <code>0 days</code>. By setting the <code>Auto approval delay</code> to <code>2 days</code>, you add to this patch baseline the <code>Important</code>, <code>Medium</code>, and <code>Low</code> severity patches two days after they are released. 
<code class="lang-text">$ aws ssm create-patch-baseline --name &quot;AmazonLinuxServers&quot; --description &quot;Baseline containing all updates for Amazon Linux&quot; --operating-system AMAZON_LINUX --approval-rules &quot;PatchRules=[{PatchFilterGroup={PatchFilters=[{Values=[Critical],Key=SEVERITY}]},ApproveAfterDays=0,ComplianceLevel=CRITICAL},{PatchFilterGroup={PatchFilters=[{Values=[Important,Medium,Low],Key=SEVERITY}]},ApproveAfterDays=2,ComplianceLevel=HIGH}]&quot;
{
&quot;BaselineId&quot;: &quot;<span style="color: #ff0000">YourBaselineId</span>&quot;
}</code> 
</ol> 
<ol start="2"> 
<li>Use the following command to register the patch baseline you created with your instance. To do so, you use the <code>Patch Group</code> tag that you added to your Amazon EC2 instance. 
<code class="lang-text">$ aws ssm register-patch-baseline-for-patch-group --baseline-id <span style="color: #ff0000">YourPatchBaselineId</span> --patch-group &quot;Linux Servers&quot;
{
&quot;PatchGroup&quot;: &quot;Linux Servers&quot;,
&quot;BaselineId&quot;: &quot;<span style="color: #ff0000">YourBaselineId</span>&quot;
}</code> 
</ol> 
<h3>C.&nbsp; Define a maintenance window</h3> 
<p>Now that you have successfully set up a role, created a patch baseline, and registered your Amazon EC2 instance with your patch baseline, you will define a maintenance window so that you can control when your Amazon EC2 instances will receive patches. By creating multiple maintenance windows and assigning them to different patch groups, you can make sure your Amazon EC2 instances do not all reboot at the same time.</p> 
<p>To define a maintenance window:</p> 
<ol> 
<li>Use the following command to define a maintenance window. In this example command, the maintenance window will start every Saturday at 10:00 P.M. UTC. It will have a duration of 4 hours and will not start any new tasks 1 hour before the end of the maintenance window. 
<code class="lang-text">$ aws ssm create-maintenance-window --name SaturdayNight --schedule &quot;cron(0 0 22 ? * SAT *)&quot; --duration 4 --cutoff 1 --allow-unassociated-targets
{
&quot;WindowId&quot;: &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;
}</code> 
</ol> 
<p style="padding-left: 30px">For more information about defining a cron-based schedule for maintenance windows, see <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-cron.html#sysman-cron-maintenance-window" target="_blank" rel="noopener noreferrer">Cron and Rate Expressions for Maintenance Windows</a>.</p> 
<ol start="2"> 
<li>After defining the maintenance window, you must register the Amazon EC2 instance with the maintenance window so that Systems Manager knows which Amazon EC2 instance it should patch in this maintenance window. You can register the instance by using the same <code>Patch Group</code> tag you used to associate the Amazon EC2 instance with the AWS-provided patch baseline, as shown in the following command. 
<code class="lang-text">$ aws ssm register-target-with-maintenance-window --window-id <span style="color: #ff0000">YourMaintenanceWindowId</span> --resource-type INSTANCE --targets &quot;Key=tag:Patch Group,Values=Linux Servers&quot;
{
&quot;WindowTargetId&quot;: &quot;<span style="color: #ff0000">YourWindowTargetId</span>&quot;
}</code> 
</ol> 
<ol start="3"> 
<li>Assign a task to the maintenance window that will install the operating system patches on your Amazon EC2 instance. The following command includes the following options. 
<ol type="a"> 
<li><code>name</code> is the name of your task and is optional. I named mine <code>Patching</code>.</li> 
<li><code>task-arn</code> is the name of the task document you want to run.</li> 
<li><code>max-concurrency</code> allows you to specify how many of your Amazon EC2 instances Systems Manager should patch at the same time. <code>max-errors</code> determines when Systems Manager should abort the task. For patching, this number should not be too low, because you do not want your entire patch task to stop on all instances if one instance fails. You can set this, for example, to <code>20%</code>.</li> 
<li><code>service-role-arn</code> is the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the <code>AmazonSSMMaintenanceWindowRole</code> role you created earlier in this blog post.</li> 
<li><code>task-invocation-parameters</code> defines the parameters that are specific to the <code>AWS-RunPatchBaseline</code> task document and tells Systems Manager that you want to install patches with a timeout of 600 seconds (10 minutes). 
<code class="lang-text">$ aws ssm register-task-with-maintenance-window --name &quot;Patching&quot; --window-id &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot; --targets &quot;Key=WindowTargetIds,Values=<span style="color: #ff0000">YourWindowTargetId</span>&quot; --task-arn AWS-RunPatchBaseline --service-role-arn &quot;<span style="color: #ff0000">arn:aws:iam::123456789012:role/MaintenanceWindowRole</span>&quot; --task-type &quot;RUN_COMMAND&quot; --task-invocation-parameters &quot;RunCommand={Comment=,TimeoutSeconds=600,Parameters={SnapshotId=[''],Operation=[Install]}}&quot; --max-concurrency &quot;500&quot; --max-errors &quot;20%&quot;
{
&quot;WindowTaskId&quot;: &quot;<span style="color: #ff0000">YourWindowTaskId</span>&quot;
}</code> 
</ol> </li> 
</ol> 
<p>Now, you must wait for the maintenance window to run at least once according to the schedule you defined earlier. If your maintenance window has expired, you can check the status of any maintenance tasks Systems Manager has performed by using the following command.</p> 
<code class="lang-text">$ aws ssm describe-maintenance-window-executions --window-id &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;
{
&quot;WindowExecutions&quot;: [
{
&quot;Status&quot;: &quot;SUCCESS&quot;,
&quot;WindowId&quot;: &quot;<span style="color: #ff0000">YourMaintenanceWindowId</span>&quot;,
&quot;WindowExecutionId&quot;: &quot;b594984b-430e-4ffa-a44c-a2e171de9dd3&quot;,
&quot;EndTime&quot;: 1515766467.487,
&quot;StartTime&quot;: 1515766457.691
}
]
}</code> 
<h3>D.&nbsp; Monitor patch compliance</h3> 
<p>You also can see the overall patch compliance of all Amazon EC2 instances using the following command in the AWS CLI.</p> 
<code class="lang-text">$ aws ssm list-compliance-summaries</code> 
<p>This command shows you the number of instances that are compliant with each category and the number of instances that are not in JSON format.</p> 
<p>You also can see overall patch compliance by choosing <strong>Compliance</strong> under <strong>Insights </strong>in the navigation pane of the <a href="https://console.aws.amazon.com/systems-manager/" target="_blank" rel="noopener noreferrer">Systems Manager console</a>. You will see a visual representation of how many Amazon EC2 instances are up to date, how many Amazon EC2 instances are noncompliant, and how many Amazon EC2 instances are compliant in relation to the earlier defined patch baseline.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/KVB_0218.png" /></p> 
<p>In this section, you have set everything up for patch management on your instance. Now you know how to patch your Amazon EC2 instance in a controlled manner and how to check if your Amazon EC2 instance is compliant with the patch baseline you have defined. Of course, I recommend that you apply these steps to all Amazon EC2 instances you manage.</p> 
<h3>Summary</h3> 
<p>In this blog post, I showed how to use Systems Manager to create a patch baseline and maintenance window to keep your Amazon EC2 Linux instances up to date with the latest security patches. Remember that by creating multiple maintenance windows and assigning them to different patch groups, you can make sure your Amazon EC2 instances do not all reboot at the same time.</p> 
<p>If you have comments about this post, submit them in the “Comments” section below. If you have questions about or issues implementing any part of this solution, start a new thread on the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=30" target="_blank" rel="noopener noreferrer">Amazon EC2 forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Koen</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7266');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/RB_CustomAuth_diagram_020618aaa-956x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Use Your Own Identity and Access Management Systems to Control Access to AWS IoT Resources</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ramkishore Bhattacharyya</span></span> | on 
<time property="datePublished" datetime="2018-02-14T08:19:48+00:00">14 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/internet-of-things/aws-iot-platform/" title="View all posts in AWS IoT Platform*"><span property="articleSection">AWS IoT Platform*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/internet-of-things/" title="View all posts in Internet of Things*"><span property="articleSection">Internet of Things*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-use-your-own-identity-and-access-management-systems-to-control-access-to-aws-iot-resources/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7208" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7208&amp;disqus_title=How+to+Use+Your+Own+Identity+and+Access+Management+Systems+to+Control+Access+to+AWS+IoT+Resources&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-use-your-own-identity-and-access-management-systems-to-control-access-to-aws-iot-resources/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7208');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT</a> is a managed cloud platform that lets connected devices easily and securely interact with cloud applications and other devices by using the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt" target="_blank" rel="noopener noreferrer">Message Queuing Telemetry Transport</a> (MQTT) protocol, <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#http" target="_blank" rel="noopener noreferrer">HTTP</a>, and the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt-ws" target="_blank" rel="noopener noreferrer">MQTT over the WebSocket protocol</a>. Every connected device must authenticate to AWS IoT, and AWS IoT must authorize all requests to determine if access to the requested operations or resources is allowed. Until now, AWS IoT has supported two kinds of authentication techniques: the Transport Layer Security (TLS) mutual authentication protocol and the AWS Signature Version 4 algorithm. Callers must possess either an X.509 certificate or AWS security credentials to be able to authenticate their calls. The requests are authorized based on the policies attached to the certificate or the AWS security credentials.</p> 
<p>However, many of our customers have their own systems that issue custom authorization tokens to their devices. These systems use different access control mechanisms such as <a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">OAuth</a> over <a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener noreferrer">JWT</a> or <a href="https://aws.amazon.com/identity/saml/" target="_blank" rel="noopener noreferrer">SAML</a> tokens. AWS IoT now supports a <em>custom authorizer</em> to enable you to use custom authorization tokens for access control. You can now use custom tokens to authenticate and authorize HTTPS over the TLS server authentication protocol and <a href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html#mqtt-ws" target="_blank" rel="noopener noreferrer">MQTT over WebSocket</a> connections to AWS IoT.</p> 
<p>In this blog post, I explain the AWS IoT custom authorizer design and then demonstrate the end-to-end process of setting up a custom authorizer to authorize an HTTPS over TLS server authentication connection to AWS IoT using a custom authorization token. In this process, you configure an <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> function, which will validate the token and provide the policies necessary to control the access privileges on the connection.</p> 
<p><strong>Note: </strong>This post assumes you are familiar with <a href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT</a> and <a href="https://aws.amazon.com/documentation/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> enough to perform steps using the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" target="_blank" rel="noopener noreferrer">AWS CLI</a> and <a href="https://www.openssl.org/" target="_blank" rel="noopener noreferrer">OpenSSL</a>. Make sure you are running the latest version of the AWS CLI.</p> 
<h3>Overview of the custom authorizer workflow</h3> 
<p>The following numbered diagram illustrates the custom authorizer workflow. The diagram is followed by explanations of the steps.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/07/RB_CustomAuth_diagram_020618aaa1a.png" /></p> 
<p>To explain the steps of the workflow as illustrated in the preceding diagram:</p> 
<ol> 
<li>The connected device uses the AWS SDK or custom client to make an HTTPS or MQTT over WebSocket request to the <a href="https://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html" target="_blank" rel="noopener noreferrer">AWS IoT gateway</a>. The request includes a custom authorization token and the name of a preconfigured authorizer Lambda function that is to be invoked to validate the authorization token.</li> 
<li>The AWS IoT gateway identifies the authorization token in the request and determines that it is a custom authorization request. The gateway checks if a Lambda authorization function is configured for the AWS account that owns the device. If yes, the gateway invokes the Lambda function by passing the authorization token.</li> 
<li>The Lambda function verifies the authorization token and returns to the AWS IoT gateway a principal that identifies the connection and a set of <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html" target="_blank" rel="noopener noreferrer">AWS IoT policies</a> that determine permissions for the requested operation. The Lambda function also returns two time-to-live values that determine the validity (in seconds) of the connection and policy documents.</li> 
<li>The AWS IoT gateway invokes the AWS policy evaluation engine to authorize the requested operation against the set of policies that are received from the authorizer Lambda function.</li> 
<li>The AWS policy evaluation engine evaluates the policy documents and returns the result to the AWS IoT gateway. The gateway then caches the policy documents.</li> 
<li>If the policy evaluation allows the requested operation, the AWS IoT gateway serves the request. If the requested operation is denied, the AWS IoT gateway returns an <code>AccessDenied</code> exception with the status code of 403 to the device (the red line in the preceding diagram).</li> 
</ol> 
<h3>Outline of the steps to configure and use the custom authorizer</h3> 
<p>The following are the steps you will perform as part of the solution:</p> 
<ol> 
<li><strong>Create a Lambda function</strong>: Start by creating a Lambda function. The function takes the authorization token in the input, verifies it, and returns authorization policies to determine the caller’s permissions for the requested operation.</li> 
<li><strong>Create an authorizer</strong>: Create an authorizer in AWS IoT. An authorizer is an alternate data model pointing to a pre-created Lambda function. You can specify in the custom authorization request an authorizer name. AWS IoT invokes a corresponding Lambda function to verify the authorization token. You may update the authorizer to point to a different Lambda function and thus easily control which Lambda function to invoke to verify an authorization token.</li> 
<li><strong>Designate the default authorizer</strong>: You may designate one of your authorizers as the default authorizer. AWS IoT invokes the default authorizer implicitly when a custom authorization request does not include a specific authorizer name.</li> 
<li><strong>Add Lambda invocation permissions</strong>: AWS IoT needs to be able to call your Lambda function on your behalf to verify the token in the custom authorization request. You need to associate a resource policy with the Lambda function to allow this.</li> 
<li><strong>Test the Lambda function</strong>: When the Lambda function and the custom authorizer are configured, use the test function to verify that they are functioning correctly.</li> 
<li><strong>Invoke the custom authorizer</strong>: Finally, make an HTTPS request to the gateway that includes a custom authorization token. The request invokes the custom authorizer.</li> 
</ol> 
<b>Deploy the solution</b> 
<h3>1.&nbsp; Create a Lambda function</h3> 
<p>In this step, I show you how to create a Lambda function that runs your custom authorizer code and returns a set of essential attributes to authorize the request.</p> 
<p>Sign in to your AWS account and <a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html" target="_blank" rel="noopener noreferrer">create from the Lambda console a Lambda function</a> that takes as input an authorization token and performs whichever actions are necessary to validate the token, as shown in the following code example. The output, in JSON format, must contain the following attributes:</p> 
<ol type="a"> 
<li><code>IsAuthenticated</code>: This is a Boolean (true/false) attribute that indicates whether the request is authenticated.</li> 
<li><code>PrincipalId</code>: This is an alphanumeric string; the minimum length is 1 character, and the maximum length is 128 characters. This string acts as an identifier associated with the token that is received in the custom authorization request.</li> 
<li><code>PolicyDocuments</code>: This is a list of JSON formatted policy documents following the same conventions as an <a href="http://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html" target="_blank" rel="noopener noreferrer">AWS IoT policy</a>. The list contains at most 10 policy documents, each of which can be a maximum of 2,048 characters.</li> 
<li><code>DisconnectAfterInSeconds</code>: This indicates the maximum duration (in seconds) of the connection to the AWS IoT gateway, after which it will be disconnected. The minimum value is 300 seconds, and the maximum value is 86,400 seconds.</li> 
<li><code>RefreshAfterInSeconds</code>: This is the period between policy refreshes. When it lapses, the Lambda function is invoked again to allow for policy refreshes. The minimum value is 300 seconds, and the maximum value is 86,400 seconds.</li> 
</ol> 
<p>The following code example is a Lambda function in Node.js 6.10 that authenticates a token.</p> 
<code class="lang-text">// A simple authorizer Lambda function demonstrating
// how to parse auth token and generate response 
exports.handler = function(event, context, callback) { 
var token = event.token; 
switch (token.toLowerCase()) { 
case 'allow': 
callback(null, generateAuthResponse(token, 'Allow')); 
case 'deny': 
callback(null, generateAuthResponse(token, 'Deny')); 
default: 
callback(&quot;Error: Invalid token&quot;); 
}
};
// Helper function to generate authorization response 
var generateAuthResponse = function(token, effect) { 
// Invoke your preferred identity provider 
// to get the authN and authZ response. 
// Following is just for simplicity sake 
var authResponse = {}; 
authResponse.isAuthenticated = true; 
authResponse.principalId = 'principalId'; 
var policyDocument = {}; 
policyDocument.Version = '2012-10-17'; 
policyDocument.Statement = []; 
var statement = {}; 
statement.Action = 'iot:Publish'; 
statement.Effect = effect; 
statement.Resource = &quot;arn:aws:iot:us-east-1:&lt;your_aws_account_id&gt;:topic/customauthtesting&quot;; 
policyDocument.Statement[0] = statement; 
authResponse.policyDocuments = [policyDocument]; 
authResponse.disconnectAfterInSeconds = 3600; 
authResponse.refreshAfterInSeconds = 600; 
return authResponse; 
}</code> 
<p>The preceding function takes an authorization token and returns an object containing the five attributes (a-e) described earlier in this step.</p> 
<h3>2.&nbsp; Create an authorizer</h3> 
<p>Now that you have created the Lambda function, you will create an authorizer with AWS IoT pointing to the Lambda function. You do this so that you can easily control which Lambda function to invoke to verify an authorization token. The following attributes are required to create an authorizer:</p> 
<ol type="a"> 
<li><code>AuthorizerName</code>: This is the name of the authorizer. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>AuthorizerFunctionArn</code>: This is the <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Name</a> (ARN) of the Lambda function that you created in the previous step.</li> 
<li><code>TokenKeyName</code>: This specifies the key name that your device chooses, which indicates the token in the custom authorization HTTP request header. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>TokenSigningPublicKeys</code>: This is a map of one (minimum) and two (maximum) public keys. It is a 2,048-bit key at minimum. You need to generate a key pair, sign the custom authorization token and include the digital signature in the request in order to be able to use custom authorization successfully. AWS IoT needs the corresponding public key to verify the digital signature. Therefore, you must provide the public key while creating an authorizer.</li> 
<li><code>Status</code>: This specifies the status (<code>ACTIVE</code> or <code>INACTIVE</code>) of the authorizer. It is optional. The default value is <code>INACTIVE</code>.</li> 
</ol> 
<p>Run the following command in OpenSSL to create an RSA key pair that will be used to generate a token signature.</p> 
<code class="lang-text">openssl genrsa -out private.pem 2048</code> 
<p>Run the following command to create the public key out of the key pair generated in the previous step.</p> 
<code class="lang-text">openssl rsa -in private.pem -outform PEM -pubout -out public.pem</code> 
<p>You need to store the key pair securely and pass the public key in the <code>TokenSigningPublicKeys</code> parameter when creating the authorizer in AWS IoT. You will use the private key in the key pair to sign the authorization token and include the signature in the custom authorization request.</p> 
<p>Run the following command in the AWS CLI to create an authorizer.</p> 
<code class="lang-text">aws iot create-authorizer --authorizer-name &lt;authorizer_name&gt; --authorizer-function-arn &lt;Lambda_function_arn&gt; --token-key-name &lt;token_key_name&gt; --token-signing-public-keys FIRST_KEY=&quot;&lt;public_key_pem&gt;&quot; --status ACTIVE</code> 
<p>The following is sample output of the <code>create-authorizer</code> command. It contains the <code>authorizerName</code> and <code>authorizerArn</code>.</p> 
<code class="lang-text">{
&quot;authorizerName&quot;: &quot;MyAuthorizer&quot;, 
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;
}</code> 
<p>You must set the authorizer in the <code>ACTIVE</code> status to be invoked. The <code>describe-authorizer</code> API returns the attributes of an existing authorizer. You can use the following command to verify if all the attributes in the authorizer are set correctly.</p> 
<code class="lang-text">aws iot describe-authorizer --authorizer-name &lt;authorizer_name&gt;</code> 
<p>The following is sample output of the <code>describe-authorizer</code> command.</p> 
<code class="lang-text">{
&quot;authorizerDescription&quot;: {
&quot;status&quot;: &quot;ACTIVE&quot;,
&quot;lastModifiedDate&quot;: 1515351241.568,
&quot;authorizerName&quot;: &quot;&lt;authorizer_name&gt;&quot;,
&quot;tokenKeyName&quot;: &quot;&lt;token_key_name&gt;&quot;,
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;,
&quot;tokenSigningPublicKeys&quot;: {
FIRST_KEY&quot;: &quot;&lt;public_key_pem&gt;&quot;
},
&quot;creationDate&quot;: 1515351241.568,
&quot;authorizerFunctionArn&quot;: &quot;arn:aws:lambda:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:function:MyCustomAuthFunction&quot;
}
}</code> 
<h3>3.&nbsp; Designate the default authorizer (optional)</h3> 
<p>You can have multiple authorizers in your account. You can designate one of them as the default so that AWS IoT invokes it if the custom authorization request does not specify an authorizer name. Run the following command in the AWS CLI to designate a default authorizer.</p> 
<code class="lang-text">aws iot set-default-authorizer --authorizer-name &lt;authorizer_name&gt;</code> 
<p>The following is sample output of the <code>set-default-authorizer</code> command. It contains the <code>authorizerName</code> and <code>authorizerArn</code>.</p> 
<code class="lang-text">{
&quot;authorizerName&quot;: &quot;MyAuthorizer&quot;, 
&quot;authorizerArn&quot;: &quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer&quot;
}</code> 
<h3>4. Add Lambda invocation permissions</h3> 
<p>AWS IoT needs to invoke your authorizer Lambda function to evaluate the custom authorizer token. You need to provide AWS IoT appropriate permissions to invoke your Lambda function when a custom authorization request is made. Use the AWS CLI with the <a href="http://docs.aws.amazon.com/lambda/latest/dg/API_AddPermission.html" target="_blank" rel="noopener noreferrer">AddPermission</a>&nbsp;command to grant the AWS IoT service principal permission to call <code>lambda:InvokeFunction</code>, as shown in the following command.</p> 
<code class="lang-text">aws lambda add-permission --function-name &lt;lambda_function_name&gt; --principal iot.amazonaws.com --source-arn &lt;authorizer_arn&gt; --statement-id Id-123 --action &quot;lambda:InvokeFunction&quot;</code> 
<p>The following is sample output of the <code>add-permission</code> command.</p> 
<code class="lang-text">{
&quot;Statement&quot;: &quot;{\&quot;Sid\&quot;:\&quot;Id-123\&quot;,\&quot;Effect\&quot;:\&quot;Allow\&quot;,\&quot;Principal\&quot;:{\&quot;Service\&quot;:\&quot;iot.amazonaws.com\&quot;},\&quot;Action\&quot;:\&quot;lambda:InvokeFunction\&quot;,\&quot;Resource\&quot;:\&quot;arn:aws:lambda:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:function:MyCustomAuthFunction\&quot;,\&quot;Condition\&quot;:{\&quot;ArnLike\&quot;:{\&quot;AWS:SourceArn\&quot;:\&quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:authorizer/MyAuthorizer\&quot;}}}&quot;
}</code> 
<p>Note that you are using the precreated <code>AuthorizerArn</code> as the <code>SourceArn</code> while granting the permission. The Lambda function gets triggered only if the source ARN provided by AWS IoT during the invocation matches with the <code>SourceArn</code> that you have given permission. Even if your Lambda function ARN is put in an authorizer owned by someone else, they cannot trigger the function causing illegitimate charge to you.</p> 
<h3>5. Test the Lambda function</h3> 
<p>To verify the configuration, test to see if AWS IoT can invoke the Lambda function and get the correct output. You can do this by using the <a href="https://docs.aws.amazon.com/cli/latest/reference/iot/test-invoke-authorizer.html" target="_blank" rel="noopener noreferrer">TestInvokeAuthorizer</a> API. The API takes the following input:</p> 
<ol type="a"> 
<li><code>AuthorizerName</code>: This is the name of the authorizer. It is a string; the minimum length is 1 character, and the maximum length is 128 characters.</li> 
<li><code>Token</code>: This specifies the custom authorization token&nbsp;to authorize the request to the AWS IoT gateway. It is a string; the minimum length is 1 character, and the maximum length is 1,024 characters.</li> 
<li><code>TokenSignature</code>: This is the token signature generated by using the private key with the SHA256withRSA algorithm. This is a string with a maximum length 2,560 characters<strong>. </strong>You must Base64-encode the signature while passing it as an input (the command follows).</li> 
</ol> 
<p>Run the following command in OpenSSL to generate a signature for string, <code>allow</code>.</p> 
<code class="lang-text">echo -n allow &gt; token.txt
openssl dgst -sha256 -sign private.pem -out token.sign token.txt</code> 
<p>Run the following command to Base64-encode the string.</p> 
<code class="lang-text">base64 token.sign &gt; token.sign.b64</code> 
<p>Now, run the following command in the AWS CLI to test your authorizer.</p> 
<code class="lang-text">aws iot test-invoke-authorizer --authorizer-name &lt;authorizer_name&gt; --token allow --token-signature &lt;token_signature&gt;</code> 
<p>If AWS IoT is able to invoke the Lambda function successfully, the output of the <code>TestInvokeAuthorizer</code> API will be exactly the same as the output of the Lambda function. The following is sample output of the <code>test-invoke-authorizer</code> command for the Lambda function you created in Step 1 earlier in this post.</p> 
<code class="lang-text">{
&quot;isAuthenticated&quot;: true,
&quot;refreshAfterInSeconds&quot;: 600,
&quot;policyDocuments&quot;: [
{\&quot;Version\&quot;:\&quot;2012-10-17\&quot;,\&quot;Statement\&quot;:[{\&quot;Action\&quot;:\&quot;iot:Publish\&quot;,\&quot;Effect\&quot;:\&quot;Allow\&quot;,\&quot;Resource\&quot;:\&quot;arn:aws:iot:us-east-1:&lt;<span style="color: #ff0000"><strong>your_aws_account_id</strong></span>&gt;:topic/customauthtesting\&quot;}]}&quot;
],
&quot;disconnectAfterInSeconds&quot;: 3600,
&quot;principalId&quot;: &quot;principalId&quot;
}</code> 
<h3>6. Invoke the custom authorizer</h3> 
<p>You can now make a custom authorization request to the AWS IoT gateway. Custom authorization is supported for HTTPS over TLS server authentication and MQTT over WebSocket connections. Regardless of the protocol, requests must include the following attributes in the header. Note that supplying these attributes through query parameters is not allowed for security reasons.</p> 
<ol type="a"> 
<li><code>Token</code>: This specifies the authorization token. The header name must be the same as the <code>TokenKeyName</code> of the authorizer.</li> 
<li><code>TokenSignature</code>: This specifies the Base64-encoded digital signature of the token string. The header name must be <code>x-amz-customauthorizer-signature</code>.</li> 
<li><code>AuthorizerName</code>: This specifies the name of one of the <code>ACTIVE</code> authorizers preconfigured in your account. The header name must be <code>x-amz-customauthorizer-name</code>. If this field is not present and you have preconfigured a default custom authorizer for your account, the AWS IoT gateway invokes the default authorizer to authenticate and authorize the request.</li> 
</ol> 
<p>Run the following command in the AWS CLI to obtain your AWS account-specific AWS IoT endpoint. See the <a href="https://docs.aws.amazon.com/iot/latest/apireference/API_DescribeEndpoint.html" target="_blank" rel="noopener noreferrer">DescribeEndpoint API documentation</a> for further details. You need to specify the endpoint when making requests to the AWS IoT gateway.</p> 
<code class="lang-text">aws iot describe-endpoint</code> 
<p>The following is sample output of the <code>describe-endpoint</code> command. It contains the <code>endpointAddress</code>.</p> 
<code class="lang-text">{
&quot;endpointAddress&quot;: &quot;&lt;<span style="color: #ff0000"><strong>your_aws_account_specific_prefix</strong></span>&gt;.iot.us-east-1.amazonaws.com&quot;
}</code> 
<p>Now, make an HTTPS request to the AWS IoT gateway to post a message. You may use your preferred HTTP client for the request. I use <a href="https://curl.haxx.se/docs/manpage.html" target="_blank" rel="noopener noreferrer">curl</a> in the following example, which posts the message, “Hello from custom auth,” to an MQTT topic, <code>customauthtesting</code>, by using the token, <code>allow</code>.</p> 
<code class="lang-text">curl -X POST -k -i -N -H &quot;Host: &lt;your_aws_iot_endpoint&gt;&quot; -H &quot;X-Amz-CustomAuthorizer-Name: &lt;authorizer_name&gt;&quot; -H &quot;X-Amz-CustomAuthorizer-Signature: &lt;token_signature&gt;&quot; -H &quot;&lt;token_key_name&gt;: allow&quot; -H &quot;User-Agent: aws-cli/1.10.65 Python/2.7.11 Darwin/16.1.0 botocore/1.4.55&quot; --data 'Hello from custom auth' https://&lt;your_aws_iot_endpoint&gt;/topics/customauthtesting</code> 
<p>If the command succeeds, you will see the following output.</p> 
<code class="lang-text">HTTP/1.1 200 OK
content-type: application/json
content-length: 65
date: Sun, 07 Jan 2018 19:56:12 GMT
x-amzn-RequestId: e7c13873-6c61-a12c-1216-9a935901c130
connection: keep-alive
{&quot;message&quot;:&quot;OK&quot;,&quot;traceId&quot;:&quot;e7c13873-6c61-a12c-1216-9a935901c130&quot;}</code> 
<h3>Conclusion</h3> 
<p>In this blog post, I have shown how to configure a custom authorizer in your AWS account and use it to authorize an HTTPS over TLS server authentication connection and publish a message to a specific MQTT topic by using a custom authorization token. Similarly, you can use custom authorizers to authorize MQTT over WebSocket requests to the AWS IoT gateway to publish messages to a specific topic or subscribe to a topic filter.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions about or issues implementing this solution, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=210" target="_blank" rel="noopener noreferrer">AWS IoT forum</a>.</p> 
<p>– Ramkishore</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7208');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/13/Marketo_1200x350_SF_1200x250111.png" /> 
<b class="lb-b blog-post-title" property="name headline">Join Us for AWS Security Week February 20–23 in San Francisco!</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><a href="https://aws.amazon.com/blogs/security/author/clieb/" title="Posts by Craig Liebendorfer" property="name">Craig Liebendorfer</a></span> | on 
<time property="datePublished" datetime="2018-02-13T07:32:31+00:00">13 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/" title="View all posts in Security, Identity, &amp; Compliance*"><span property="articleSection">Security, Identity, &amp; Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/join-us-for-aws-security-week-february-20-23-in-san-francisco/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7226" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7226&amp;disqus_title=Join+Us+for+AWS+Security+Week+February+20%E2%80%9323+in+San+Francisco%21&amp;disqus_url=https://aws.amazon.com/blogs/security/join-us-for-aws-security-week-february-20-23-in-san-francisco/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7226');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/12/Marketo_1200x350_SF_1200x25011.png" /></p> 
<p><a href="https://awssecurityweeksanfranciscofeb2018.splashthat.com/" target="_blank" rel="noopener noreferrer">Join us</a> for AWS Security Week, February 20–23 at the AWS Pop-up Loft in San Francisco, where&nbsp;you can participate in four days of themed content that will help you secure your workloads on AWS. Each day will highlight a different security and compliance topic, and will include an overview session, a customer or partner speaker, a deep dive into the day’s topic, and a hands-on lab or demos of relevant AWS or partner services.</p> 
<p>Tuesday (February 20) will kick off the week with a day devoted to identity and governance. On Wednesday, we will dig into secure configuration and automation, including a discussion about upcoming General Data Protection Regulation (GDPR) requirements. On Thursday, we will cover threat detection and remediation, which will include&nbsp;an Amazon GuardDuty lab. And on Friday, we will discuss incident response on AWS.</p> 
<p>Sessions, demos, and labs about each of these topics will be led by seasoned security professionals from AWS, who will help you understand not just the basics, but also the nuances of building applications in the AWS Cloud in a robust and secure manner. AWS subject-matter experts will be available for “Ask the Experts” sessions during breaks.</p> 
<p><a href="https://awssecurityweeksanfranciscofeb2018.splashthat.com/" target="_blank" rel="noopener noreferrer">Register today</a>!</p> 
<p>– Craig</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7226');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/Amazon-DynamoDB_1024x512.jpg" /> 
<b class="lb-b blog-post-title" property="name headline">Now Available: Encryption at Rest for Amazon DynamoDB</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Nitin Sagar</span></span> | on 
<time property="datePublished" datetime="2018-02-08T13:49:35+00:00">08 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/database/amazon-dynamodb/" title="View all posts in Amazon DynamoDB*"><span property="articleSection">Amazon DynamoDB*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/now-available-encryption-at-rest-for-amazon-dynamodb/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7181" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7181&amp;disqus_title=Now+Available%3A+Encryption+at+Rest+for+Amazon+DynamoDB&amp;disqus_url=https://aws.amazon.com/blogs/security/now-available-encryption-at-rest-for-amazon-dynamodb/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7181');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/06/Amazon-DynamoDB_512x256.jpg" /></p> 
<p>Today, AWS announced <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noopener noreferrer">Amazon DynamoDB</a>&nbsp;encryption at rest, a new DynamoDB feature that&nbsp;gives you enhanced security of your data at rest by encrypting it using your associated <a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service</a>&nbsp;encryption keys.&nbsp;Encryption at rest can help you&nbsp;meet your security requirements for regulatory compliance.</p> 
<p>You now can create an encrypted DynamoDB table anytime with a single click in the <a href="https://console.aws.amazon.com/console/home" target="_blank" rel="noopener noreferrer">AWS Management Console</a> or a single API call. Encrypting DynamoDB data has no impact on table performance. DynamoDB encryption at rest is available starting today in the US East (N. Virginia), US East (Ohio), US West (Oregon), and Europe (Ireland) Regions for no additional fees.</p> 
<p>For more information, see the full <a href="https://aws.amazon.com/blogs/aws/new-encryption-at-rest-for-dynamodb/">AWS Blog post</a>.</p> 
<p>– Nitin</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7181');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_companydirectory_0218-1144x630.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Search More Efficiently in Amazon Cloud Directory</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Mahendra Chheda</span></span> | on 
<time property="datePublished" datetime="2018-02-07T07:58:40+00:00">07 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/amazon-cloud-directory/" title="View all posts in Amazon Cloud Directory*"><span property="articleSection">Amazon Cloud Directory*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-search-more-efficiently-in-amazon-cloud-directory/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7172" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7172&amp;disqus_title=How+to+Search+More+Efficiently+in+Amazon+Cloud+Directory&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-search-more-efficiently-in-amazon-cloud-directory/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7172');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Using <a href="https://aws.amazon.com/clouddirectory/" target="_blank" rel="noopener noreferrer">Amazon Cloud Directory</a>, you can build flexible, cloud-native directories for organizing hierarchies of data along multiple dimensions. And now, you can search more efficiently by searching across only a subset of objects in your directory. For example, instead of searching through all of the employees in a company directory built using Cloud Directory, you can choose to search only full-time employees or contractors.</p> 
<p>To search across such a subset of objects, you must first create a facet-based index. A <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/whatarefacets.html" target="_blank" rel="noopener noreferrer">facet</a> is a set of attributes defined in a <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/cd_schemas.html" target="_blank" rel="noopener noreferrer">schema</a> that is associated with a <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/objectsandlinks.html" target="_blank" rel="noopener noreferrer">directory object</a>. Using facets, you can create different object types in your directory. For instance, you can create different facets for full-time employees and contractors in a schema and then create full-time employee objects and contractor objects. You then can create an index of all the objects that include a specific facet and search those objects more efficiently.</p> 
<p>In this blog post, I show how you can create a facet-based index in Cloud Directory to more efficiently search for objects in your directory.</p> 
<h3>Scenario: Searching a company directory for a specific employee type</h3> 
<p>Let’s say a company called AnyCompany wants to be able to efficiently search in Cloud Directory for information about its full-time employees and contractors. To do this, AnyCompany must create a company directory using Cloud Directory. (If AnyCompany already had a company directory using Cloud Directory, they could use that directory instead.) AnyCompany starts by creating <code>DirectorySchema</code>, which is a schema that includes three facets: <code>FullTimeEmployeeFacet</code>, <code>ManagerFacet</code>, and <code>ContractorFacet</code>.</p> 
<code class="lang-text"><strong>Schema: DirectorySchema</strong>
<strong>Facet: FullTimeEmployeeFacet</strong>
Attribute: EmployeeId, type: Integer
Attribute: Name, type: String
Attribute: EMail, type: String
Attribute: Salary, type: Integer
<strong>Facet: ManagerFacet</strong>
Attribute: Budget, type: Integer
Attribute: LeaveApproval, type: Boolean
<strong>Facet: ContractorFacet</strong>
Attribute: Name, type: String
Attribute: EMail, type: String
Attribute: VendorCompany, type: String
Attribute: VendorPO, type: Integer</code> 
<p>The following diagram is a visual representation of AnyCompany’s company directory, and it includes full-time employees and contractors in a reporting hierarchy. The full-time employees are shown in blue nodes and the contractors are shown in green nodes. The directory’s three facets are shown as they correspond to full-time employees, managers, and contractors.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_companydirectory_0218.png" /></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/02/MH_legend_0218.png" /></p> 
<p>To more efficiently search your directory, follow these steps:</p> 
<ol> 
<li>Create a facet-based index that includes the facets you want to use when searching.</li> 
<li>Populate the index with the appropriate employee objects.</li> 
<li>List all the objects in the index.</li> 
<li>List objects in the index that include a specific facet.</li> 
</ol> 
<h4><strong>1. Create a facet-based index that includes the facets you want to use when searching</strong></h4> 
<p>The following code example creates a facet-based index of the employee objects in the directory. Cloud Directory currently supports only simple indexes, which means that an index object can only store one type of value, such as a facet.</p> 
<code class="lang-text">     // Create an index
// <span style="color: #ff0000"><strong>&lt;region&gt;</strong></span> indicates an AWS Region value such as “us-east-1”
// <span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span> indicates your AWS account ID
// <span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span> indicates your Cloud Directory ID
// The schemaArn points to the specific schema, which is DirectorySchema
String schemaArn = &quot;arn:aws:clouddirectory:<span style="color: #ff0000"><strong>&lt;region&gt;</strong></span>:<span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span>:directory/<span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span>/schema/DirectorySchema/1.0&quot; ;
// I define attributes that I want to use for indexing. In this case, I use “facets” to define an 
// attribute for indexing. This is a hard-coded value that is defined by Cloud Directory.
AttributeKey indexAttributeKey = new AttributeKey()    
.withSchemaArn(schemaArn)
.withFacetName(&quot;facets&quot;)
.withName(&quot;facets&quot;) ;
List&lt;AttributeKey&gt; orderedIndexedAttributeList = new ArrayList&lt;AttributeKey&gt;() ;
orderedIndexedAttributeList.add(indexAttributeKey) ;
// The directoryArn points to the specific directory that I am working on 
String directoryArn = &quot;arn:aws:clouddirectory:<span style="color: #ff0000"><strong>&lt;region&gt;</strong></span>:<span style="color: #ff0000"><strong>&lt;accountId&gt;</strong></span>:directory/<span style="color: #ff0000"><strong>&lt;directoryId&gt;</strong></span>&quot; ;
// I create the index request and pass in the directoryArn and my attribute list. 
// Because I am defining the facetIndex at the root of my directory, my parentReference is the root of the directory
// For LinkName, I have defined “MyFacetIndex,” as shown in the diagram
ObjectReference dirRoot = new ObjectReference().withSelector(&quot;/&quot;); // Directory root
CreateIndexRequest createRequest = new CreateIndexRequest()
.withDirectoryArn(directoryArn)
.withOrderedIndexedAttributeList(orderedIndexedAttributeList)
.withIsUnique(false)
.withParentReference(dirRoot)  // Attach to directory root
.withLinkName(&quot;MyFacetIndex&quot;) ;
// I assign the indexed object to facetIndex 
CreateIndexResult facetIndexResult = cloudDirectoryClient.createIndex(createRequest) ;
ObjectReference facetIndex = new ObjectReference().withSelector(facetIndexResult.getObjectIdentifier());</code> 
<h4>2.&nbsp;<strong>Populate the index with the appropriate employee objects</strong></h4> 
<p>Next, I add all the objects that I want to include in the index. The following code example adds objects to <code>facetIndex</code>.</p> 
<code class="lang-text">     // I assume userObj1 is “Tim”. The following code adds “Tim” to the index. 
// Create an index attach request with the directory, facet, and object details
AttachToIndexRequest indexAttachRequest = new AttachToIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)
.withTargetReference(userObj1) ;
// Add the object to the index
cloudDirectoryClient.attachToIndex(indexAttachRequest) ;
// You can follow the same code pattern to add other full-time employee and contractor objects to the index. </code> 
<h4>3. List all the objects in the index</h4> 
<p>Now, I can query my directory efficiently for the set of objects I have in <code>facetIndex</code>. The following code example returns all the objects in your index.</p> 
<code class="lang-text">     // List all objects in the facet-based index 
ListIndexResult listResults = cloudDirectoryClient.listIndex(new ListIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)) ;</code> 
<p><strong>4. List objects in the index that include a specific facet</strong></p> 
<p>I can add a filter for retrieving subsets of objects in the index that contain a specific facet. The following code example shows how to add a filter to the query so that only objects that contain the facet <code>FullTimeEmployeeFacet</code> are returned.</p> 
<code class="lang-text">     // I choose the specific facet I will use for filtering my query and get all objects that contain this facet in them.
String filterString = &quot;DirectorySchema/1.0/FullTimeEmployeeFacet&quot; ;
TypedAttributeValue filterStringValue = new TypedAttributeValue().withStringValue(filterString);
// I define the filter range and mention both the start mode and end mode as inclusive because I will query for a specific facet 
ObjectAttributeRange objectAttributeRange = new ObjectAttributeRange()
.withAttributeKey(new AttributeKey()
.withFacetName(&quot;facets&quot;)
.withName(&quot;facets&quot;) 
.withSchemaArn(schemaArn))
.withRange(new TypedAttributeValueRange()
.withStartMode(RangeMode.INCLUSIVE)
.withStartValue(filterStringValue)
.withEndMode(RangeMode.INCLUSIVE)
.withEndValue(filterStringValue)) ; // Query for objects with FullTimeEmployeeFacet which is defined in filterString
// List the index results
ListIndexResult filteredResults = cloudDirectoryClient.listIndex(new ListIndexRequest()
.withDirectoryArn(directoryArn)
.withIndexReference(facetIndex)
.withRangesOnIndexedValues(objectAttributeRange)) ;</code> 
<p>Using this subset of objects, I can now search for a specific employee without searching across all the objects in my directory.</p> 
<b>Summary</b> 
<p>You can use facet-based indexing to search your directory more efficiently by searching across only a subset of objects in of your directory. For more information about this feature, see <a href="http://docs.aws.amazon.com/directoryservice/latest/admin-guide/cd_indexing.html" target="_blank" rel="noopener noreferrer">Indexing and Search</a>.</p> 
<p>If you have comments about this blog post, submit them in the “Comments” section below. If you have questions about implementing the solution in this blog post, start a new thread in the <a href="https://forums.aws.amazon.com/forum.jspa?forumID=180&amp;start=0" target="_blank" rel="noopener noreferrer">Directory Service forum</a> or <a href="https://console.aws.amazon.com/support/home" target="_blank" rel="noopener noreferrer">contact AWS Support</a>.</p> 
<p>– Mahendra</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7172');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/01/whitepaper-generic_1100x550_whitebg.png" /> 
<b class="lb-b blog-post-title" property="name headline">Addressing Data Residency with AWS</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Min Hyun</span></span> | on 
<time property="datePublished" datetime="2018-02-02T07:59:57+00:00">02 FEB 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/compliance/" title="View all posts in Compliance*"><span property="articleSection">Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/addressing-data-residency-with-aws/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7161" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7161&amp;disqus_title=Addressing+Data+Residency+with+AWS&amp;disqus_url=https://aws.amazon.com/blogs/security/addressing-data-residency-with-aws/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7161');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/02/01/whitepaper-generic-300x235.png" /></p> 
<p>AWS has released a new whitepaper that has been requested by many AWS customers: <a href="https://d1.awsstatic.com/whitepapers/compliance/Data_Residency_Whitepaper.pdf" target="_blank" rel="noopener noreferrer">AWS Policy Perspectives: Data Residency</a>. <em>Data residency</em> is the requirement that all customer content processed and stored in an IT system must remain within a specific country’s borders, and it is one of the foremost concerns of governments that want to use commercial cloud services. General cybersecurity concerns and&nbsp;concerns about government requests for data have contributed to a continued focus on keeping data within countries’ borders. In fact, some governments have determined that <a href="http://www2.itif.org/2015-cross-border-data-flows.pdf?_ga=1.8208626.1580578791.1473954628" target="_blank" rel="noopener noreferrer">mandating data residency provides an extra layer of security</a>.</p> 
<p>This approach, however, is counterproductive to the data protection objectives and the&nbsp;<a href="http://documents.worldbank.org/curated/en/961621467994698644/pdf/102724-WDR-WDR2016Overview-ENGLISH-WebResBox-394840B-OUO-9.pdf" target="_blank" rel="noopener noreferrer">IT modernization and global economic growth goals</a> that many governments have set as milestones. This new whitepaper addresses the real and perceived security risks expressed by governments when they demand in-country data residency by identifying the most likely and prevalent IT vulnerabilities and security risks, explaining the native security embedded in cloud services, and highlighting the roles and responsibilities of cloud service providers (CSPs), governments, and customers in protecting data.</p> 
<p>Large-scale, multinational CSPs, often called <em>hyperscale</em> CSPs, represent a transformational disruption in technology because of how they support their customers with high degrees of efficiency, agility, and innovation as part of world-class security offerings. The whitepaper explains how hyperscale CSPs, such as AWS, that might be located out of country provide their customers the ability to achieve high levels of data protection through safeguards on their own platform and with turnkey tooling for their customers. They do this while at the same time preserving nation-state regulatory sovereignty.</p> 
<p>The whitepaper also considers the commercial, public-sector, and economic effects of data residency policies and offers considerations for governments to evaluate before enforcing requirements that can unintentionally limit public-sector digital transformation goals, in turn possibly leading to increased cybersecurity risk.</p> 
<p>AWS continues to engage with governments around the world to hear and address their top-of-mind security concerns. We take seriously our commitment to advocate for our customers’ interests and enforce security from “ground zero.” This means that when customers use AWS, they can have the confidence that their data is protected with a level of assurance that meets, if not exceeds, their needs, regardless of where the data resides.</p> 
<p>–&nbsp;Min Hyun, Cloud Security Policy Strategist</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7161');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/16/PCIBox11.jpg" /> 
<b class="lb-b blog-post-title" property="name headline">AWS Adds 16 More Services to Its PCI DSS Compliance Program</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Chad Woolf</span></span> | on 
<time property="datePublished" datetime="2018-01-26T07:49:31+00:00">26 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/compliance/" title="View all posts in Compliance*"><span property="articleSection">Compliance*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/aws-adds-16-more-services-to-its-pci-dss-compliance-program/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7094" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7094&amp;disqus_title=AWS+Adds+16+More+Services+to+Its+PCI+DSS+Compliance+Program&amp;disqus_url=https://aws.amazon.com/blogs/security/aws-adds-16-more-services-to-its-pci-dss-compliance-program/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7094');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p style="text-align: center"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/16/PCIBox11.jpg" /></p> 
<p>AWS has added 16 more AWS services to its&nbsp;<a href="https://aws.amazon.com/compliance/pci-dss-level-1-faqs/" target="_blank" rel="noopener noreferrer">Payment Card Industry Data Security Standard</a>&nbsp;(PCI DSS) compliance program, giving you more options, flexibility, and functionality to process and store sensitive payment card data in the AWS Cloud. The services were audited by&nbsp;<a href="https://www.coalfire.com/" target="_blank" rel="noopener noreferrer">Coalfire</a>&nbsp;to ensure that they meet strict&nbsp;<a href="https://www.pcisecuritystandards.org/" target="_blank" rel="noopener noreferrer">PCI DSS standards</a>.</p> 
<p>The newly compliant AWS services are:</p> 
<li><a href="https://aws.amazon.com/inspector" target="_blank" rel="noopener noreferrer">Amazon Inspector</a></li> 
<li><a href="http://aws.amazon.com/macie" target="_blank" rel="noopener noreferrer">Amazon Macie</a></li> 
<li><a href="https://aws.amazon.com/quicksight" target="_blank" rel="noopener noreferrer">Amazon QuickSight</a></li> 
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/transfer-acceleration.html" target="_blank" rel="noopener noreferrer">Amazon S3 Transfer Acceleration</a></li> 
<li><a href="https://aws.amazon.com/documentation/sagemaker/" target="_blank" rel="noopener noreferrer">Amazon SageMaker</a></li> 
<li><a href="http://aws.amazon.com/sns" target="_blank" rel="noopener noreferrer">Amazon Simple Notification Service</a></li> 
<li><a href="http://aws.amazon.com/batch" target="_blank" rel="noopener noreferrer">AWS Batch</a></li> 
<li><a href="http://aws.amazon.com/codebuild" target="_blank" rel="noopener noreferrer">AWS CodeBuild</a></li> 
<li><a href="https://aws.amazon.com/lambda/edge/" target="_blank" rel="noopener noreferrer">AWS Lambda@Edge</a></li> 
<li><a href="http://aws.amazon.com/shield" target="_blank" rel="noopener noreferrer">AWS Shield</a></li> 
<li><a href="http://aws.amazon.com/snowball" target="_blank" rel="noopener noreferrer">AWS Snowball</a></li> 
<li><a href="https://aws.amazon.com/snowball-edge/" target="_blank" rel="noopener noreferrer">AWS Snowball Edge</a></li> 
<li><a href="http://aws.amazon.com/snowmobile/" target="_blank" rel="noopener noreferrer">AWS Snowmobile</a></li> 
<li><a href="https://aws.amazon.com/ec2/systems-manager" target="_blank" rel="noopener noreferrer">AWS Systems Manager</a></li> 
<li><a href="http://aws.amazon.com/xray" target="_blank" rel="noopener noreferrer">AWS X-Ray</a></li> 
<p>AWS now offers&nbsp;<a href="https://aws.amazon.com/compliance/services-in-scope/" target="_blank" rel="noopener noreferrer">58 services</a>&nbsp;that are officially PCI DSS compliant, giving administrators more service options for implementing a PCI-compliant cardholder environment.</p> 
<p>For more information about the AWS PCI DSS compliance program, see&nbsp;<a href="https://aws.amazon.com/compliance/resources/" target="_blank" rel="noopener noreferrer">Compliance Resources</a>,&nbsp;<a href="https://aws.amazon.com/compliance/services-in-scope/" target="_blank" rel="noopener noreferrer">AWS Services in Scope by Compliance Program</a>, and&nbsp;<a href="https://aws.amazon.com/compliance/pci-dss-level-1-faqs/" target="_blank" rel="noopener noreferrer">PCI DSS Compliance</a>.</p> 
<p>– Chad Woolf</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7094');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR_Diagram_010418.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Create an AWS IAM Policy to Grant AWS Lambda Access to an Amazon DynamoDB Table</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Andrew Robinson</span></span> | on 
<time property="datePublished" datetime="2018-01-23T06:57:07+00:00">23 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/database/amazon-dynamodb/" title="View all posts in Amazon DynamoDB*"><span property="articleSection">Amazon DynamoDB*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-identity-and-access-management-iam/" title="View all posts in AWS Identity and Access Management (IAM)*"><span property="articleSection">AWS Identity and Access Management (IAM)*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/compute/aws-lambda/" title="View all posts in AWS Lambda*"><span property="articleSection">AWS Lambda*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-create-an-aws-iam-policy-to-grant-aws-lambda-access-to-an-amazon-dynamodb-table/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7128" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7128&amp;disqus_title=How+to+Create+an+AWS+IAM+Policy+to+Grant+AWS+Lambda+Access+to+an+Amazon+DynamoDB+Table&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-create-an-aws-iam-policy-to-grant-aws-lambda-access-to-an-amazon-dynamodb-table/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7128');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>When managing your AWS resources, you often need to grant one AWS service access to another to accomplish tasks. For example, you could use an <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer">AWS Lambda</a> <a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-introduction-function.html" target="_blank" rel="noopener noreferrer">function</a> to resize, watermark, and postprocess images, for which you would need to store the associated metadata in <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noopener noreferrer">Amazon DynamoDB</a>. You also could use Lambda, <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a>, and <a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener noreferrer">Amazon CloudFront</a> to build a serverless website that uses a DynamoDB <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithTables.html" target="_blank" rel="noopener noreferrer">table</a> as a session store, with Lambda updating the information in the table. In both these examples, you need to grant Lambda functions permissions to write to DynamoDB.</p> 
<p>In this post, I demonstrate how to create an <a href="https://aws.amazon.com/iam/" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management</a> (IAM) <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html" target="_blank" rel="noopener noreferrer">policy</a> that will be attached to an IAM role. The role is then used to grant a Lambda function access to a DynamoDB table. By using an IAM policy and role to control access, I don’t need to embed credentials in code and can tightly control which services the Lambda function can access. The policy also includes permissions to allow the Lambda function to write log files to <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html" target="_blank" rel="noopener noreferrer">Amazon CloudWatch Logs</a>. This allows me to view utilization statistics for your Lambda functions and to have access to additional logging for troubleshooting issues.</p> 
<h3>Solution overview</h3> 
<p>The following architecture diagram presents an overview of the solution in this post.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR_Diagram_010418.png" /></p> 
<p>The architecture of this post’s solution uses a Lambda function (1 in the preceding diagram) to make read API calls such as <code>GET</code> or <code>SCAN</code> &nbsp;and write API calls such as <code>PUT</code> or <code>UPDATE</code> to a DynamoDB table (2). The Lambda function also writes log files to CloudWatch Logs (3). The Lambda function uses an IAM role (4) that has an IAM policy attached (5) that grants access to DynamoDB and CloudWatch.</p> 
<h3>Overview of the AWS services used in this post</h3> 
<p>I use the following AWS services in this post’s solution:</p> 
<li>IAM – For securely controlling access to AWS services. With IAM, you can centrally manage users, security credentials such as access keys, and permissions that control which AWS resources users and applications can access.</li> 
<li>DynamoDB – A fast and flexible&nbsp;<a href="https://aws.amazon.com/nosql/" target="_blank" rel="noopener noreferrer">NoSQL database</a>&nbsp;service for all applications that need consistent, single-digit-millisecond latency at any scale.</li> 
<li>Lambda – Run code without provisioning or managing servers. You pay only for the compute time you consume—there is no charge when your code is not running.</li> 
<li>CloudWatch Logs– For monitoring, storing, and accessing log files generated by AWS resources, including Lambda.</li> 
<h3>IAM access policies</h3> 
<p>I have authored an IAM access policy with <a href="http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/working-with-json.html" target="_blank" rel="noopener noreferrer">JSON</a> to grant the required permissions to the DynamoDB table and CloudWatch Logs. I will attach this policy to a role, and this role will then be attached to a Lambda function, which will assume the required access to DynamoDB and CloudWatch Logs</p> 
<p>I will walk through this policy, and explain its elements and how to create the policy in the IAM console.</p> 
<p>The following policy grants a Lambda function read and write access to a DynamoDB table and writes log files to CloudWatch Logs. This policy is called <code>MyLambdaPolicy</code>. The following is the full JSON document of this policy (the <span style="color: #ff0000"><strong>AWS account ID</strong></span> is a placeholder value that you would replace with your own account ID).</p> 
<code class="lang-text">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;dynamodb:BatchGetItem&quot;,
&quot;dynamodb:GetItem&quot;,
&quot;dynamodb:Query&quot;,
&quot;dynamodb:Scan&quot;,
&quot;dynamodb:BatchWriteItem&quot;,
&quot;dynamodb:PutItem&quot;,
&quot;dynamodb:UpdateItem&quot;
],
&quot;Resource&quot;: &quot;arn:aws:dynamodb:eu-west-1:<strong><span style="color: #ff0000">123456789012</span></strong>:table/SampleTable&quot;
},
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: [
&quot;logs:CreateLogStream&quot;,
&quot;logs:PutLogEvents&quot;
],
&quot;Resource&quot;: &quot;arn:aws:logs:eu-west-1:<span style="color: #ff0000"><strong>123456789012</strong></span>:*&quot;
},
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: &quot;logs:CreateLogGroup&quot;,
&quot;Resource&quot;: &quot;*&quot;
}
]
}</code> 
<p>The first element in this policy is the <code>Version</code>, which defines the JSON version. At the time of this post’s publication, the most recent version of JSON is <code>2012-10-17</code>.</p> 
<p>The next element in this first policy is a <code>Statement</code>. This is the main section of the policy and includes multiple elements. This first statement is to <code>Allow</code> access to DynamoDB, and in this example, the elements I use are:</p> 
<li>An <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Effect" target="_blank" rel="noopener noreferrer">Effect</a> element – Specifies whether the statement results in an <code>Allow</code> or an explicit <code>Deny</code>. By default, access to resources is implicitly denied. In this example, I have used <code>Allow</code> because I want to allow the actions.</li> 
<li>An <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Action" target="_blank" rel="noopener noreferrer">Action</a> element – Describes the specific actions for this statement. Each AWS service has its own set of actions that describe tasks that you can perform with that service. I have used the DynamoDB actions that I want to allow. For the definitions of all available actions for DynamoDB, see the <a href="http://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Operations.html" target="_blank" rel="noopener noreferrer">DynamoDB API Reference</a>.</li> 
<li>A <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Resource" target="_blank" rel="noopener noreferrer">Resource</a> element – Specifies the object or objects for this statement using <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html" target="_blank" rel="noopener noreferrer">Amazon Resource Names</a> (ARNs). You use an ARN to uniquely identify an AWS resource. All Resource elements start with <code>arn:aws</code> and then define the object or objects for the statement. I use this to specify the DynamoDB table to which I want to allow access. To build the <code>Resource</code> element for DynamoDB, I have to specify: 
<li>The AWS service (<code>dynamodb</code>)</li> 
<li>The AWS Region (<code>eu-west-1</code>)</li> 
<li>The AWS account ID (<code><span style="color: #ff0000"><strong>123456789012</strong></span></code>)</li> 
<li>The table (<code>table/SampleTable</code>)</li> 
</ul> </li> 
<p>The complete <code>Resource</code> element of the first statement is: <code>arn:aws:dynamodb:eu-west-1:<span style="color: #ff0000"><strong>123456789012</strong></span>:table/SampleTable</code></p> 
<p>In this policy, I created a second statement to allow access to CloudWatch Logs so that the Lambda function can write log files for troubleshooting and analysis. I have used the same elements as for the DynamoDB statement, but have changed the following values:</p> 
<li>For the <code>Action</code> element, I used the CloudWatch actions that I want to allow. Definitions of all the available actions for CloudWatch are provided in the <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_Operations.html" target="_blank" rel="noopener noreferrer">CloudWatch API Reference</a>.</li> 
<li>For the <code>Resource</code> element, I specified the AWS account to which I want to allow my Lambda function to write its log files. As in the preceding example for DynamoDB, I have to use the ARN for CloudWatch Logs to specify where access should be granted. To build the <code>Resource</code> element for CloudWatch Logs, I have to specify: 
<li>The AWS service (<code>logs</code>)</li> 
<li>The AWS Region (<code>eu-west-1</code>)</li> 
<li>The AWS account ID (<code><span style="color: #ff0000"><strong>123456789012</strong></span></code>)</li> 
<li>All log groups in this account&nbsp;(<code>*</code>)</li> 
</ul> </li> 
<p>The complete <code>Resource</code> element of the second statement is: <code>arn:aws:logs:eu-west-1:<span style="color: #ff0000"><strong>123456789012</strong></span>:*</code></p> 
<p>I also created a third statement to allow access to CloudWatch Logs so that the Lambda function can create a log group. This is required because the <code>logs:CreateLogGroup</code> action supports only wildcard element names.&nbsp;I used the same elements as for the DynamoDB statement, but changed the following values:</p> 
<li>For the&nbsp;<code>Action</code>&nbsp;element, I used the CloudWatch actions that I want to allow. Definitions of all the available actions for CloudWatch are provided in the&nbsp;<a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_Operations.html" target="_blank" rel="noopener noreferrer">CloudWatch API Reference</a>.</li> 
<li>For the&nbsp;<code>Resource</code>&nbsp;element, I used a wildcard character (“<code>*</code>“) because the <code>logs:CreateLogGroup</code> action supports only wildcard element names.</li> 
<p>The complete <code>Resource</code> element of the second statement is: <code>*</code></p> 
<h3>Create the IAM policy in your account</h3> 
<p>Before you can apply <code>MyLambdaPolicy</code> to a Lambda function, you have to create the policy in your own account and then apply it to an IAM role.</p> 
<p>To create an IAM policy:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a> and choose <strong>Policies</strong> in the navigation pane. Choose <strong>Create policy</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR1_0118.png" /></li> 
<li>Because I have already written the policy in JSON, you don’t need to use the Visual Editor, so you can choose the <strong>JSON</strong> tab and paste the content of the JSON policy document shown earlier in this post (remember to replace the <span style="color: #ff0000"><strong>placeholder account ID</strong>&nbsp;</span>with your own account ID). Choose <strong>Review policy</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/30/AR2_0118_a.png" /></li> 
<li>Name the policy <code>MyLambdaPolicy</code> and give it a description that will help you remember the policy’s purpose. You also can view a summary of the policy’s permissions. Choose <strong>Create policy</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/30/AR3_0118_a.png" /></li> 
</ol> 
<p>You have created the IAM policy that you will apply to the Lambda function.</p> 
<h3>Attach the IAM policy to an IAM role</h3> 
<p>To apply <code>MyLambdaPolicy</code> to a Lambda function, you first have to attach the policy to an IAM role.</p> 
<p>To create a new role and attach <code>MyLambdaPolicy</code> to the role:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/iam/home" target="_blank" rel="noopener noreferrer">IAM console</a> and choose <strong>Roles</strong> in the navigation pane. Choose <strong>Create role</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR4_0118.png" /></li> 
<li>Choose <strong>AWS service</strong> and then choose <strong>Lambda</strong>. Choose <strong>Next: Permissions</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR5_0118.png" /></li> 
<li>On the <strong>Attach permissions policies</strong> page, type <code>MyLambdaPolicy</code> in the <strong>Search</strong>&nbsp;box. Choose <code>MyLambdaPolicy</code> from the list of returned search results, and then choose <strong>Next: Review</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR6_0118.png" /></li> 
<li>On the <strong>Review</strong> page, type <code>MyLambdaRole</code> in the <strong>Role name</strong> box and an appropriate description, and then choose <strong>Create role</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR7_0118.png" /></li> 
</ol> 
<p>You have attached the policy you created earlier to a new IAM role, which in turn can be used by a Lambda function.</p> 
<h3>Apply the IAM role to a Lambda function</h3> 
<p>You have created an IAM role that has an attached IAM policy that grants both read and write access to DynamoDB and write access to CloudWatch Logs. The next step is to apply the IAM role to a Lambda function.</p> 
<p>To apply the IAM role to a Lambda function:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/lambda/home" target="_blank" rel="noopener noreferrer">Lambda console</a> and choose <strong>Create function</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR8_0118.png" /></li> 
<li>On the <strong>Create function</strong> page under <strong>Author from scratch</strong>, name the function <code>MyLambdaFunction</code>, and choose the runtime you want to use based on your application requirements. Lambda currently supports Node.js, Java, Python, Go, and .NET Core. From the <strong>Role</strong> dropdown, choose <strong>Choose an existing role</strong>, and from the <strong>Existing role</strong> dropdown, choose <strong>MyLambdaRole</strong>. Then choose <strong>Create function</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/21/AR9_0118.png" /></li> 
</ol> 
<p><code>MyLambdaFunction</code> now has access to CloudWatch Logs and DynamoDB. You can choose either of these services to see the details of which permissions the function has.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/30/AR10_0118_a.png" /></p> 
<h3>Summary</h3> 
<p>In this post, I demonstrated how to grant a Lambda function access to a DynamoDB table by using an IAM policy. The <a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-dg.pdf" target="_blank" rel="noopener noreferrer">Lambda Developer Guide</a> features guidance about how you can expand on the examples in this post and how to integrate Lambda with <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-on-demand-https.html" target="_blank" rel="noopener noreferrer">Amazon API Gateway</a>, <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-s3.html" target="_blank" rel="noopener noreferrer">S3</a>, <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-ddb.html" target="_blank" rel="noopener noreferrer">DynamoDB</a>, <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html" target="_blank" rel="noopener noreferrer">Amazon Kinesis</a>, <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-cloudtrail.html" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>, and <a href="http://docs.aws.amazon.com/lambda/latest/dg/with-sns.html" target="_blank" rel="noopener noreferrer">Amazon SNS</a>.</p> 
<p>If you have any comments about this blog post, submit them in the “Comments” section below. If you have any questions about the services used, start a new thread in the applicable AWS forum: <a href="https://forums.aws.amazon.com/forum.jspa?forumID=76" target="_blank" rel="noopener noreferrer">IAM</a>, <a href="https://forums.aws.amazon.com/forum.jspa?forumID=186" target="_blank" rel="noopener noreferrer">Lambda</a>, <a href="https://forums.aws.amazon.com/forum.jspa?forumID=131" target="_blank" rel="noopener noreferrer">DynamoDB</a>, or <a href="https://forums.aws.amazon.com/forum.jspa?forumID=138" target="_blank" rel="noopener noreferrer">CloudWatch</a>.</p> 
<p>– Andrew</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7128');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<meta property="image" content="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/22/KMS_social.png" /> 
<b class="lb-b blog-post-title" property="name headline">How to Connect Directly to AWS Key Management Service from Amazon VPC by Using an AWS PrivateLink Endpoint</b> 
<p style="margin: 0; padding:0;">=======================<p>
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Joe Wright</span></span> | on 
<time property="datePublished" datetime="2018-01-22T11:23:31+00:00">22 JAN 2018</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/amazon-vpc-networking-content-delivery/" title="View all posts in Amazon VPC*"><span property="articleSection">Amazon VPC*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/security-identity-compliance/aws-key-management-service/" title="View all posts in AWS Key Management Service*"><span property="articleSection">AWS Key Management Service*</span></a>, <a href="https://aws.amazon.com/blogs/security/category/networking-content-delivery/aws-privatelink/" title="View all posts in AWS PrivateLink"><span property="articleSection">AWS PrivateLink</span></a></span> | 
<a href="https://aws.amazon.com/blogs/security/how-to-connect-directly-to-aws-key-management-service-from-amazon-vpc-by-using-an-aws-privatelink-endpoint/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-7104" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-security-blog&amp;disqus_identifier=7104&amp;disqus_title=How+to+Connect+Directly+to+AWS+Key+Management+Service+from+Amazon+VPC+by+Using+an+AWS+PrivateLink+Endpoint&amp;disqus_url=https://aws.amazon.com/blogs/security/how-to-connect-directly-to-aws-key-management-service-from-amazon-vpc-by-using-an-aws-privatelink-endpoint/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7104');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://aws.amazon.com/kms/" target="_blank" rel="noopener noreferrer">AWS Key Management Service (AWS KMS)</a> now supports <a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon Virtual Private Cloud (Amazon VPC)</a> endpoints powered by <a href="https://aws.amazon.com/about-aws/whats-new/2017/11/introducing-aws-privatelink-for-aws-services/" target="_blank" rel="noopener noreferrer">AWS PrivateLink</a>. This means you now can connect directly to AWS KMS through a private endpoint in your VPC, keeping all traffic within your VPC and the AWS network.</p> 
<p>Previously, applications running inside a VPC required internet access to connect to AWS KMS. This meant managing internet connectivity through <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html" target="_blank" rel="noopener noreferrer">internet gateways</a>, <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-gateway.html" target="_blank" rel="noopener noreferrer">Network Address Translation</a> (NAT) devices, or firewall proxies. With support for Amazon VPC endpoints, you can now keep all traffic between your VPC and AWS KMS within the AWS network and avoid management of internet connectivity. In this blog post, I show you how to create and use an Amazon VPC endpoint for AWS KMS, audit the use of AWS KMS keys through the Amazon VPC endpoint, and build stricter access controls using <a href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html" target="_blank" rel="noopener noreferrer">key policies</a>.</p> 
<h3>Create and use an Amazon VPC endpoint with AWS KMS</h3> 
<p>To get started, I will show you how to use the <a href="https://console.aws.amazon.com/vpc/home" target="_blank" rel="noopener noreferrer">Amazon VPC console</a> to create an endpoint in the US East (N. Virginia) Region, also known as us-east-1.</p> 
<p>To create an endpoint in the US East (N. Virginia) Region:</p> 
<ol> 
<li>Navigate to the <a href="https://console.aws.amazon.com/vpc/home?region=us-east-1" target="_blank" rel="noopener noreferrer">Amazon VPC console</a>. In the navigation pane, choose <strong>Endpoints</strong>, and then choose <strong>Create Endpoint</strong>.</li> 
<li>Choose <strong>AWS services</strong> for <strong>Service category</strong>.</li> 
<li>Choose the AWS KMS <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/endpoint-service.html" target="_blank" rel="noopener noreferrer">endpoint service</a>, <code>com.amazonaws.us-east-1.kms</code>, from the <strong>Service Name </strong>list, as shown in the following screenshot.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/19/JW_1_011818b.png" /></li> 
<li>Your VPC endpoint can span multiple <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" target="_blank" rel="noopener noreferrer">Availability Zones</a>, providing isolation and fault tolerance. Choose a subnet from each Availability Zone from which you want to connect. An elastic network interface for the VPC endpoint is created in each subnet that you choose, each with its own <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html#vpc-dns-hostnames" target="_blank" rel="noopener noreferrer">DNS hostname</a> and private IP address.&nbsp;<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/18/JW_2_011818.png" /></li> 
<li>If your VPC has DNS hostnames and DNS support enabled, choose <strong>Enable for this endpoint</strong> under <strong>Enable Private DNS Name</strong> to have applications use the VPC endpoint by default.</li> 
<li>You use <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_SecurityGroups.html" target="_blank" rel="noopener noreferrer">security groups</a> to control access to your endpoint. Choose a security group from the list, or create a new one.</li> 
<li>To finish creating the endpoint, choose <strong>Create endpoint</strong>. The console returns a VPC Endpoint ID. In our example, the VPC Endpoint ID is <code>vpce-0c0052e3fbffdb450</code>.</li> 
<li>To connect to this endpoint, you need a DNS hostname that is generated for this endpoint. You can view these DNS hostnames by choosing the VPC Endpoint ID and then choosing the <strong>Details</strong> tab of the endpoint in the Amazon VPC console. One of the DNS hostnames for the endpoint that I created in the previous step is <code>vpce-0c0052e3fbffdb450-afmosqu8.kms.us-east-1.vpce.amazonaws.com</code>.</li> 
</ol> 
<p style="padding-left: 30px"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2018/01/18/JW_3_011818.png" /></p> 
<p>You can connect to AWS KMS through the VPC endpoint by using the <a href="https://aws.amazon.com/cli/" target="_blank" rel="noopener noreferrer">AWS CLI</a> or an <a href="https://aws.amazon.com/tools/" target="_blank" rel="noopener noreferrer">AWS SDK</a>. In this example, I use the following AWS CLI command to list all AWS KMS keys in the account in us-east-1.</p> 
<p><code>aws kms list-keys --endpoint-url https://vpce-0c0052e3fbffdb450-afmosqu8.kms.us-east-1.vpce.amazonaws.com</code></p> 
<p>If your VPC has DNS hostnames and DNS support enabled and you enabled private DNS names in the preceding steps, you can connect to your VPC endpoint by using the standard AWS KMS DNS hostname (<code>https://kms.<strong>&lt;region&gt;</strong>.amazonaws.com</code>), instead of manually configuring the endpoints in the AWS CLI or AWS SDKs. The AWS CLI and SDKs use this hostname by default to connect to KMS, so there’s nothing to change in your application to begin using the VPC endpoint.</p> 
<p>You can monitor and audit AWS KMS usage through your VPC endpoint. Every request made to AWS KMS is logged by <a href="https://aws.amazon.com/cloudtrail/" target="_blank" rel="noopener noreferrer">AWS CloudTrail</a>. Now, when you use a VPC endpoint to make requests to AWS KMS, the endpoint ID appears in the CloudTrail log entries.</p> 
<h3>Restrict access using key policies</h3> 
<p>A good security practice to follow is <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege" target="_blank" rel="noopener noreferrer">least privilege</a>: granting the fewest permissions required to complete a task. You can control access to your AWS KMS keys from a specific VPC endpoint by using <a href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html" target="_blank" rel="noopener noreferrer">AWS KMS key policies</a> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html" target="_blank" rel="noopener noreferrer">AWS Identity and Access Management (IAM) policies</a>. The <code>aws:sourceVpce</code> condition key lets you grant or restrict access to AWS KMS keys based on the VPC endpoint used. For example, the following example key policy allows a user to perform encryption operations with a key only when the request comes through the specified VPC endpoint (replace the <span style="color: #ff0000"><strong>placeholder AWS account ID</strong></span> with your own account ID, and the <span style="color: #0000ff"><strong>placeholder VPC endpoint ID</strong></span> with your own endpoint ID).</p> 
<code class="lang-text">{
&quot;Id&quot;: &quot;example-key-1&quot;,
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;Enable IAM user permissions&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;AWS&quot;:[&quot;<span style="color: #ff0000"><strong>123456789012</strong></span>&quot;]},
&quot;Action&quot;: [&quot;kms:*&quot;],
&quot;Resource&quot;: &quot;*&quot;
},
{
&quot;Sid&quot;: &quot;Restrict usage to my VPC endpoint&quot;,
&quot;Effect&quot;: &quot;Deny&quot;,
&quot;Principal&quot;: &quot;*&quot;,
&quot;Action&quot;: [
&quot;kms:Encrypt&quot;,
&quot;kms:Decrypt&quot;,
&quot;kms:ReEncrypt*&quot;,
&quot;kms:GenerateDataKey*&quot;
],
&quot;Resource&quot;: &quot;*&quot;,
&quot;Condition&quot;: {
&quot;StringNotEquals&quot;: {
&quot;aws:sourceVpce&quot;: &quot;<span style="color: #0000ff"><strong>vpce-1a2b3c4d5e6f7g8h</strong></span>&quot;
}
}
}
]
}</code> 
<p>This policy works by including a Deny statement with a <code>StringNotEquals</code> condition. When a user makes a request to AWS KMS through a VPC endpoint, the endpoint’s ID is compared to the <code>aws:sourceVpce</code> value specified in the policy. If the two values are not the same, the request is denied. You can modify AWS KMS key policies in the AWS KMS console. For more information, see <a href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying.html" target="_blank" rel="noopener noreferrer">Modifying a Key Policy</a>.</p> 
<p>You also can control access to your AWS KMS keys from any endpoint running in one or more VPCs by using the <code>aws:sourceVpc</code> policy condition key. Suppose you have an application that is running in one VPC, but uses a second VPC for resource management functions. In the following example policy, AWS KMS key administrative actions can only be made from VPC <code>vpc-12345678</code>, and the key can only be used for cryptographic operations from VPC <code>vpc-2b2b2b2b</code>.</p> 
<code class="lang-text">{
&quot;Id&quot;: &quot;example-key-2&quot;,
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Sid&quot;: &quot;Allow administrative actions from vpc-12345678&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;AWS&quot;: &quot;<span style="color: #ff0000"><strong>123456789012</strong></span>&quot;},
&quot;Action&quot;: [
&quot;kms:Create*&quot;,&quot;kms:Enable*&quot;,&quot;kms:Put*&quot;,&quot;kms:Update*&quot;,
&quot;kms:Revoke*&quot;,&quot;kms:Disable*&quot;,&quot;kms:Delete*&quot;,
&quot;kms:TagResource&quot;, &quot;kms:UntagResource&quot;
],
&quot;Resource&quot;: &quot;*&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;aws:sourceVpc&quot;: &quot;<span style="color: #0000ff"><strong>vpc-12345678</strong></span>&quot;
}
}
},
{
&quot;Sid&quot;: &quot;Allow key usage from vpc-2b2b2b2b&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;AWS&quot;: &quot;<span style="color: #ff0000"><strong>123456789012</strong></span>&quot;},
&quot;Action&quot;: [
&quot;kms:Encrypt&quot;,&quot;kms:Decrypt&quot;,&quot;kms:GenerateDataKey*&quot;
],
&quot;Resource&quot;: &quot;*&quot;,
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
&quot;aws:sourceVpc&quot;: &quot;<span style="color: #0000ff"><strong>vpc-2b2b2b2b</strong></span>&quot;
}
}
},
{
&quot;Sid&quot;: &quot;Allow read actions from everywhere&quot;,
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Principal&quot;: {&quot;AWS&quot;: &quot;<span style="color: #ff0000"><strong>123456789012</strong></span>&quot;},
&quot;Action&quot;: [
&quot;kms:Describe*&quot;,&quot;kms:List*&quot;,&quot;kms:Get*&quot;
],
&quot;Resource&quot;: &quot;*&quot;,
}
]
}</code> 
<p>The previous examples show how you can limit access to AWS KMS API actions that are attached to a key policy. If you want to limit access to AWS KMS API actions that are not attached to a specific key, you have to use these VPC-related conditions in an IAM policy that refers to the desired AWS KMS API actions.</p> 
<h3>Summary</h3> 
<p>In this post, I have demonstrated how to create and use a VPC endpoint for AWS KMS, and how to use the <code>aws:sourceVpc</code> and <code>aws:sourceVpce</code> policy conditions to scope permissions to call various AWS KMS APIs. AWS KMS VPC endpoints provide you with more control over how your applications connect to AWS KMS and can save you from managing internet connectivity from your VPC.</p> 
<p>To learn more about connecting to AWS KMS through a VPC endpoint, see the <a href="https://docs.aws.amazon.com/kms/latest/developerguide/kms-vpc-endpoint.html" target="_blank" rel="noopener noreferrer">AWS KMS Developer Guide</a>. For helpful guidance about your overall VPC network structure, see <a href="https://aws.amazon.com/blogs/startups/practical-vpc-design/" target="_blank" rel="noopener noreferrer">Practical VPC Design</a>.</p> 
<p>If you have questions about this feature or anything else related to AWS KMS, start a new thread in the&nbsp;<a href="https://forums.aws.amazon.com/forum.jspa?forumID=182" target="_blank" rel="noopener noreferrer">AWS KMS forum</a>.</p> 
<p>– Joe</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-7104');
});
</script> 
</article> 
<p>
© 2018 Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
