<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/blogsataws/devopsblogs1.html" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:title" content="Bejoy's TechNotes - Kindle Friendly AWS DevOps Blogs" />
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>Bejoy's TechNotes - Kindle Friendly AWS DevOps Blogs</title>
    <link href="../assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="../assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="../assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="uh-oh-" class="layout-inner page-uh-oh-">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="../aws.html">AWS</a></li>
                  <li><a href="../linux.html">Linux</a></li>
                  <li><a href="../docker.html">Docker</a></li>
                  <li><a href="../ibmpower.html">IBM Power</a></li>
                  <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="../aws.html">AWS</a></li>
    <li><a href="../linux.html">Linux</a></li>
    <li><a href="../docker.html">Docker</a></li>
    <li><a href="../ibmpower.html">IBM Power</a></li>
    <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
      <ul class="nav docs-sidenav">
      <li><a href="blogsataws1.html">Blogs @ AWS</a></li>
      <li><a href="whatsnew1.html">What's New @ AWS</a></li>
      <li><a href="secblogs1.html">Security Blogs @ AWS</a></li>
      <li><a href="computeblogs1.html">Compute Blogs @ AWS</a></li>
      <li><a href="apnblogs1.html">APN Blogs @ AWS</a></li>
      <li class="active"><a href="devopsblogs1.html">DevOps Blogs @ AWS</a></li>
      <li><a href="mgmtblogs1.html">Management Tools Blogs @ AWS</a></li>

    </ul>
    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
<p></p>
<p><i>Contents of this page is copied directly from AWS blog sites to make it Kindle friendly. Some styles & sections from these pages are removed to render this properly in 'Article Mode' of Kindle e-Reader browser. All the contents of this page is property of AWS.</i></p>
<p><a href="devopsblogs1.html">Page 1</a>|<a href="devopsblogs2.html">Page 2</a>|<a href="devopsblogs3.html">Page 3</a>|<a href="devopsblogs4.html">Page 4</a></p>
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Database Continuous Integration and Automated Release Management Workflow with AWS and Datical DB</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Balaji Iyer</span></span> | on 
<time property="datePublished" datetime="2017-06-02T05:00:14+00:00">02 JUN 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/best-practices/" title="View all posts in Best practices"><span property="articleSection">Best practices</span></a>, <a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a>, <a href="https://aws.amazon.com/blogs/devops/category/partners/" title="View all posts in Partners"><span property="articleSection">Partners</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/database-continuous-integration-and-automated-release-management-workflow-with-aws-and-datical-db/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Just as a herd can move only as fast as its slowest member, companies must increase the speed of all parts of their release process, especially the database change process, which is often manual. One bad database change can bring down an app or compromise data security.</p> 
<p>We need to make database code deployment as fast and easy as application release automation, while eliminating risks that cause application downtime and data security vulnerabilities. Let’s take a page from the application development playbook and bring a continuous deployment approach to the database.</p> 
<p>By creating a continuous deployment database, you can:</p> 
<li>Discover mistakes more quickly.</li> 
<li>Deliver updates faster and frequently.</li> 
<li>Help developers write better code.</li> 
<li>Automate the database release management process.</li> 
<p>The database deployment package can be promoted automatically with application code changes. With database continuous deployment, application development teams can deliver smaller, less risky deployments, making it possible to respond more quickly to business or customer needs.</p> 
<p>In our previous post, <a href="https://aws.amazon.com/blogs/devops/building-end-to-end-continuous-delivery-and-deployment-pipelines-in-aws-and-teamcity/">Building End-to-End Continuous Delivery and Deployment Pipelines in AWS</a>, we walked through steps for implementing a continuous deployment and automated delivery pipeline for your application.</p> 
<p>In this post, we walk through steps for building a continuous deployment workflow for databases using <a href="https://aws.amazon.com/codepipeline/">AWS CodePipeline</a> (a fully managed continuous delivery service) and <a href="http://www.datical.com/solution/">Datical DB</a> (a database release automation application). We use <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a> for source code control and <a href="https://aws.amazon.com/rds/">Amazon RDS</a> for database hosting to demonstrate end-to-end database change management — from check-in to final deployment.</p> 
<p>As part of this example, we will show how a database change that does not meet standards is rejected automatically and actionable feedback is provided to the developer. Just like a code unit test, Datical DB evaluates changes and enforces your organization’s standards. In the sample use case, database table indexes of more than three columns are disallowed. In some cases, this type of index can slow performance.</p> 
<p><strong>Prerequisites</strong></p> 
<p>You’ll need an AWS account, an Amazon EC2 key pair, and administrator-level permissions for <a href="https://aws.amazon.com/iam/">AWS Identity and Access Management (IAM)</a>, AWS CodePipeline, AWS CodeCommit, Amazon RDS, <a href="https://aws.amazon.com/ec2/">Amazon EC2</a>, and <a href="https://aws.amazon.com/s3/">Amazon S3</a>.</p> 
<p>From Datical DB, you’ll need access to software.datical.com portal, your license key, a database, and JDBC drivers. You can request a free trial of Datical <a href="http://pages.datical.com/aws-blog-trial-request.html">here</a>.</p> 
<b>Overview</b> 
<p>Here are the steps:</p> 
<ol> 
<li style="text-align: left">Install and configure Datical DB.</li> 
<li style="text-align: left">Create an RDS database instance running the Oracle database engine.</li> 
<li style="text-align: left">Configure Datical DB to manage database changes across your software development life cycle (SDLC).</li> 
<li style="text-align: left">Set up database version control using AWS CodeCommit.</li> 
<li style="text-align: left">Set up a continuous integration server to stage database changes.</li> 
<li style="text-align: left">Integrate the continuous integration server with Datical DB.</li> 
<li style="text-align: left">Set up automated release management for your database through AWS CodePipeline.</li> 
<li style="text-align: left">Enforce security governance and standards with the Datical DB Rules Engine.</li> 
</ol> 
<b>1. Install and configure Datical DB</b> 
<p>Navigate to <a href="https://software.datical.com">https://software.datical.com</a> and sign in with your credentials. From the left navigation menu, expand the <strong>Common</strong> folder, and then open the <strong>Datical_DB_Folder</strong>. Choose the latest version of the application by reviewing the date suffix in the name of the folder. Download the installer for your platform — Windows (32-bit or 64-bit) or Linux (32-bit or 64-bit).</p> 
<b>Verify the JDK Version</b> 
<p>In a terminal window, run the following command to ensure you’re running JDK version 1.7.x or later.</p> 
<code class="lang-code"># java –version
java version &quot;1.7.0_75&quot;
Java(TM) SE Runtime Environment (build 1.7.0_75-b13)
Java HotSpot(TM) Client VM (build 24.75-b04, mixed mode, sharing)</code> 
<p>The Datical DB installer contains a graphical (GUI) and command line (CLI) interface that can be installed on Windows and Linux operating systems.</p> 
<b>Install Datical DB (GUI)</b> 
<ol> 
<li>Double-click on the installer</li> 
<li>Follow the prompts to install the application.</li> 
<li>When prompted, type the path to a valid license.</li> 
</ol> 
<h3>Install JDBC drivers</h3> 
<ol> 
<li>Open the Datical DB application.</li> 
<li>From the menu, choose <strong>Help</strong>, and then choose <strong>Install New Software</strong>.</li> 
<li>From the <strong>Work with</strong> drop-down list, choose Database Drivers – <a href="http://update.datical.com/drivers/updates">http://update.datical.com/drivers/updates</a>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/1-2.png" /></li> 
<li>Follow the prompts to install the drivers.</li> 
</ol> 
<b>Install Datical DB (CLI)</b> 
<p>Datical DB (CLI only) can be installed on a headless Linux system. Select the correct 32-bit or 64-bit Linux installer for your system.</p> 
<ol> 
<li>Run the installer as root and install it to /usr/local/DaticalDB. <code class="lang-bash">sudo java -jar ../installers/&lt;Datical Installer&gt;.jar -console</code> </li> 
<li>Follow the prompts to install the application.</li> 
<li>When prompted, type the path to a valid license.</li> 
</ol> 
<h3>Install JDBC drivers</h3> 
<ol> 
<li>Copy JDBC drivers to /usr/local/DaticalDB/jdbc_drivers. <code class="lang-bash">sudo mkdir /usr/local/DaticalDB/jdbc_drivers
copy JDBC Drivers from software.datical.com to /usr/local/DaticalDB/jdbc_drivers</code> </li> 
<li><code class="lang-bash"></code>Copy the license file to /usr/local/DaticalDB/repl. <code class="lang-bash">sudo cp &lt;license_filename&gt; /usr/local/DaticalDB/repl
sudo chmod 777 /usr/local/DaticalDB/repl/&lt;license_filename&gt;</code> </li> 
</ol> 
<b>2. Create an RDS instance running the Oracle database engine</b> 
<p>Datical DB supports database engines like Oracle, MySQL, Microsoft SQL Server, PostgreSQL, and IBM DB2. The example in this post uses a DB instance running Oracle. To create a DB instance running Oracle, <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_CreateOracleInstance.html">follow these steps</a>.<br /> Make sure that you can access the Oracle port (1521) from the location where you will be using Datical DB. Just like SQLPlus or other database management tools, Datical DB must be able to connect to the Oracle port. When you configure the security group for your RDS instance, make sure you can access port 1521 from your location.</p> 
<b>3. Manage database changes across the SDLC</b> 
<p>This one-time process is required to ensure databases are in sync so that you can manage database changes across the SDLC:</p> 
<ol> 
<li>Create a Datical DB deployment plan with connections to the databases to be managed.</li> 
<li>Baseline the first database (DEV/CI). This must be the original or best configured database – your reference database.</li> 
<li>For each additional database (TEST and PROD):<br /> a. Compare databases to ensure the application schema are in sync.<br /> b. Resolve any differences.<br /> c. Perform a change log sync to get each setup for Datical DB management.</li> 
</ol> 
<p>Datical DB creates an initial model change log from one of the databases. It also creates in each database a metadata table named DATABASECHANGELOG that will be used to track the state. Now the databases look like this:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/2.png" /></p> 
<p><strong>Note</strong>: In the preceding figure, the Datical DB model and metadata table are a representation of the actual model.</p> 
<b>Create a deployment plan</b> 
<ol> 
<li style="list-style-type: none"> 
<ol> 
<li>In Datical DB, right-click <strong>Deployment Plans</strong>, and choose <strong>New</strong>.</li> 
<li>On the <strong>New Deployment Plan</strong> page, type a name for your project (for example, AWS-Sample-Project), and then choose <strong>Next</strong>.</li> 
<li>Select <strong>Oracle 11g Instant Client</strong>, type a name for the database (for example, DevDatabase), and then choose <strong>Next</strong>.</li> 
<li>On the following page, provide the database connection information.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/3-1.png" /> 
<ol> 
<li>For <strong>Hostname</strong>, enter the RDS endpoint..</li> 
<li>Select <strong>SID</strong>, and then type ORCL.</li> 
<li>Type the user name and password used to connect to the RDS instance running Oracle.</li> 
<li>Before you choose <strong>Finish</strong>, choose the <strong>Test Connection</strong> button.</li> 
</ol> </li> 
</ol> </li> 
</ol> 
<p>When Datical DB creates the project, it also creates a baseline snapshot that captures the current state of the database schema. Datical DB stores the snapshot in Datical change sets for future forecasting and modification.</p> 
<b>Create a database change set</b> 
<p>A change set describes the change/refactoring to apply to the database.<br /> From the <strong>AWS-Sample-Project</strong> project in the left pane, right-click <strong>Change Log</strong>, select <strong>New</strong>, and then select <strong>Change Set</strong>. Choose the type of change to make, and then choose <strong>Next</strong>. In this example, we’re creating a table. For <strong>Table Name</strong>, type a name. Choose <strong>Add Column</strong>, and then provide information to add one or more columns to the new table. Follow the prompts, and then choose <strong>Finish</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/4.png" /></p> 
<p>The new change set will be added at the end of your current change log. You can tag change sets with a sprint label. Depending on the environment, changes can be deployed based on individual labels or by the higher-level grouping construct.<br /> Datical DB also provides an option to load SQL scripts into a database, where the change sets are labeled and captured as objects. This makes them ready for deployment in other environments.</p> 
<b>Best practices for continuous delivery</b> 
<p>Change sets are stored in an XML file inside the Datical DB project. The file, changelog.xml, is stored inside the Changelog folder. (In the Datical DB UI, it is called Change Log.)</p> 
<p>Just like any other files stored in your source code repository, the Datical DB change log can be branched and merged to support agile software development, where individual work spaces are isolated until changes are merged into the parent branch.</p> 
<p>To implement this best practice, your Datical DB project should be checked into the same location as your application source code. That way, branches and merges will be applied to your Datical DB project automatically. Use unique change set IDs to avoid collisions with other scrum teams.</p> 
<b>4. Set up database version control using AWS CodeCommit</b> 
<p>To create a new CodeCommit repository, <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/how-to-create-repository.html">follow these steps</a>.</p> 
<p><strong>Note</strong>: On some versions of Windows and Linux, you might see a pop-up dialog box asking for your user name and password. This is the built-in credential management system, but it is not compatible with the credential helper for AWS CodeCommit. Choose <strong>Cancel</strong>.</p> 
<p>Commit the contents located in the Datical working directory (for example, ~/datical/AWS-Sample-Project) to the AWS CodeCommit repository.</p> 
<b>5. Set up a continuous integration server to stage database changes</b> 
<p>In this example, Jenkins is the continuous integration server. To create a Jenkins server, <a href="https://aws.amazon.com/getting-started/projects/setup-jenkins-build-server/">follow these steps</a>. Be sure your instance security group allows port 8080 access.</p> 
<code class="lang-basg">sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo</code> 
<p>For more information about installing Jenkins, see the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins">Jenkins wiki</a>.</p> 
<p>After setup, connect to your Jenkins server, and create a job.</p> 
<ol> 
<li>Install the following Jenkins plugins:<br /> For this project, you will need to install the following Jenkins plugins:<p></p> 
<ol> 
<li>AWS CodeCommit plugin</li> 
<li>DaticalDB4Jenkins plugin</li> 
<li>Hudson Post Build Task plugin</li> 
<li>HTML Publisher plugin</li> 
</ol> </li> 
<li>To configure Jenkins for AWS CodeCommit, <a href="https://aws.amazon.com/blogs/devops/integrating-aws-codecommit-with-jenkins/">follow these steps</a>.</li> 
<li>To configure Jenkins with Datical DB, navigate to Jenkins, choose <strong>Manage Jenkins</strong>, and then choose <strong>Configure System</strong>. In the Datical DB section, provide the requested directory information.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/5-1.png" /></p> 
<p>For example:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/6-1.png" /></p> 
<b>Add a build step:</b> 
<p>Go to your newly created Jenkins project and choose <strong>Configure</strong>. On the <strong>Build</strong> tab, under <strong>Build</strong>, choose <strong>Add build step</strong>, and choose <strong>Datical DB</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/7-1.png" /></p> 
<p>In <strong>Project Dir</strong>, enter the Datical DB project directory (in this example, /var/lib/jenkins/workspace/demo/MyProject). You can use Jenkins environment variables like $WORKSPACE. The first build action&nbsp;is <strong>Check Drivers</strong>. This allow you to verify that Datical DB and Jenkins are configured correctly.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/8-1.png" /></p> 
<p>Choose <strong>Save</strong>. Choose <strong>Build Now</strong> to test the configuration.</p> 
<p>After you’ve verified the drivers are installed, add forecast and deploy steps.</p> 
<b>Add forecast and deploy steps:</b> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/9-1.png" /><br /> Choose <strong>Save</strong>. Then choose <strong>Build Now</strong> to test the configuration.</p> 
<b>6. Configure the continuous integration server to publish Datical DB reports</b> 
<p>In this step, we will configure Jenkins to publish Datical DB forecast and HTML reports. In your Jenkins project, select <strong>Delete workspace before build starts</strong>.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/10-2.png" /></p> 
<b>Add post-build steps</b> 
<h3>1. Archive the Datical DB reports, logs, and snapshots</h3> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/11.png" /><br /> To expose Datical DB reports in Jenkins, you must create a post-build task step to copy the forecast and deployment HTML reports to a location easily published, and then publish the HTML reports.</p> 
<h4>2. Copy the forecast and deploy HTML reports</h4> 
<code class="lang-bash">mkdir /var/lib/jenkins/workspace/Demo/MyProject/report
cp -rv /var/lib/jenkins/workspace/Demo/MyProject/Reports/*/*/*/forecast*/* /var/lib/jenkins/workspace/Demo/MyProject/report 2&gt;NUL
cp -rv /var/lib/jenkins/workspace/Demo/MyProject/Reports/*/*/*/deploy*/deployReport.html /var/lib/jenkins/workspace/Demo/MyProject/report 2&gt;NUL</code> 
<h4><code class="lang-code"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/12.png" /><br /> </code></h4> 
<p>&nbsp;</p> 
<h4>3. Publish HTML reports</h4> 
<p>Use the information in the following screen shot. Depending on the location where you configured Jenkins to build, your details might be different.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/13-1.png" /></p> 
<p><strong>Note</strong>: Datical DB HTML reports use CSS, so update the JENKINS_JAVA_OPTIONS in your config file as follows:</p> 
<p>Edit /etc/sysconfig/jenkins and set JENKINS_JAVA_OPTIONS to:</p> 
<code class="lang-code">JENKINS_JAVA_OPTIONS=&quot;-Djava.awt.headless=true -Dhudson.model.DirectoryBrowserSupport.CSP= &quot;
</code> 
<b>7. Enable automated release management for your database through AWS CodePipeline</b> 
<p>To create an automated release process for your databases using AWS CodePipeline, follow these instructions.</p> 
<ol> 
<li>Sign in to the AWS Management Console and open the AWS CodePipeline console at <a href="http://console.aws.amazon.com/codepipeline">http://console.aws.amazon.com/codepipeline</a>.</li> 
<li>On the introductory page, choose <strong>Get started</strong>. If you see the <strong>All pipelines</strong> page, choose <strong>Create pipeline</strong>.</li> 
<li>In <strong>Step 1: Name</strong>, in <strong>Pipeline name</strong>, type <strong>DatabasePipeline</strong>, and then choose <strong>Next step</strong>.</li> 
<li>In <strong>Step 2: Source</strong>, in <strong>Source provider</strong>, choose <strong>AWS CodeCommit</strong>. In <strong>Repository name</strong>, choose the name of the AWS CodeCommit repository you created earlier. In <strong>Branch name</strong>, choose the name of the branch that contains your latest code update. Choose <strong>Next step</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/15-1.png" /></li> 
<li>In <strong>Step 3: Build</strong>, chose <strong>Jenkins</strong>.<br /> <img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/17-1.png" /></li> 
</ol> 
<p>To complete the deployment workflow, follow steps 6 through 9 in the <a href="http://docs.aws.amazon.com/codepipeline/latest/userguide/tutorials-simple-codecommit.html#codecommit-create-pipeline">Create a Simple Pipeline Tutorial</a>.</p> 
<b>8. Enforce database standards and compliance with the Datical DB Rules Engine</b> 
<p>The Datical DB Dynamic Rules Engine automatically inspects the Virtual Database Model to make sure that proposed database code changes are safe and in compliance with your organization’s database standards. The Rules Engine also makes it easy to identify complex changes that warrant further review and empowers DBAs to efficiently focus only on the changes that require their attention. It also provides application developers with a self-service validation capability that uses the same automated build process established for the application. The consistent evaluation provided by the Dynamic Rules Engine removes uncertainty about what is acceptable and empowers application developers to write safe, compliant changes every time.</p> 
<p>Earlier, you created a Datical DB project with no changes. To demonstrate rules, you will now create changes that violate a rule.</p> 
<p>First, create a table with four columns. Then try to create an index on the table that comprises all four columns. For some databases, having more than three columns in an index can cause performance issues. For this reason, create a rule that will prevent the creation of an index on more than three columns, long before the change is proposed for production. Like a unit test that will fail the build, the Datical DB Rules Engine fails the build at the forecast step and provides feedback to the development team about the rule and the change to fix.</p> 
<b>Create a Datical DB rule</b> 
<p>To create a Datical DB rule, open the Datical DB UI and navigate to your project. Expand the Rules folder. In this example, you will create a rule in the Forecast folder.</p> 
<p>Right-click the Forecast folder, and then select <strong>Create Rules File</strong>. In the dialog box, type a unique file name for your rule. Use a .drl extension.</p> 
<p>.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/18-2.png" /></p> 
<p>In the editor window that opens, type&nbsp;the following:</p> 
<code class="lang-java">package com.datical.hammer.core.forecast
import java.util.Collection;
import java.util.List;
import java.util.Arrays;
import java.util.ArrayList;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.collections.ListUtils;
import com.datical.db.project.Project;
import com.datical.hammer.core.rules.Response;
import com.datical.hammer.core.rules.Response.ResponseType;
// ************************************* Models *************************************
// Database Models
import com.datical.dbsim.model.DbModel;
import com.datical.dbsim.model.Schema;
import com.datical.dbsim.model.Table;
import com.datical.dbsim.model.Index;
import com.datical.dbsim.model.Column;
import org.liquibase.xml.ns.dbchangelog.CreateIndexType;
import org.liquibase.xml.ns.dbchangelog.ColumnType;
/* @return false if validation fails; true otherwise */
function boolean validate(List columns)
{
// FAIL If more than 3 columns are included in new index
if (columns.size() &gt; 3)
return false;
else
return true;
}
rule &quot;Index Too Many Columns Error&quot;
salience 1
when
$createIndex : CreateIndexType($indexName: indexName, $columns: columns, $tableName: tableName, $schemaName: schemaName)
eval(!validate($columns))
then
String errorMessage = &quot;The new index [&quot; + $indexName + &quot;] contains more than 3 columns.&quot;;
insert(new Response(ResponseType.FAIL, errorMessage, drools.getRule().getName()));
end</code> 
<p>Save the new rule file, and then right-click the Forecast folder, and select Check Rules. You should see “Rule Validation returned no errors.”</p> 
<p>Now check your rule into source code control and request a new build. The build will fail, which is expected. Go back to Datical DB, and change the index to comprise only three columns. After your check-in, you will see a successful deployment to your RDS instance.</p> 
<p>The following forecast report shows the Datical DB rule violation:</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/06/01/19-2.png" /></p> 
<p>To implement database continuous delivery into your existing continuous delivery process, consider creating a separate project for your database changes that use the Datical DB forecast functionality at the same time unit tests are run on your code. This will catch database changes that violate standards before deployment.</p> 
<b>Summary:</b> 
<p>In this post, you learned how to build a modern database continuous integration and automated release management workflow on AWS. You also saw how Datical DB can be seamlessly integrated with AWS services to enable database release automation, while eliminating risks that cause application downtime and data security vulnerabilities. This fully automated delivery mechanism for databases can accelerate every organization’s ability to deploy software rapidly and reliably while improving productivity, performance, compliance, and auditability, and increasing data security. These methodologies simplify process-related overhead and make it possible for organizations to serve their customers efficiently and compete more effectively in the market.</p> 
<p>I hope you enjoyed this post. If you have any feedback, please leave a comment below.</p> 
<hr /> 
<h3 style="text-align: left">About the Authors</h3> 
<p>&nbsp;</p> 
<p style="text-align: left"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/pic-150x150.jpg" /></p> 
<p style="text-align: left"><strong>Balaji Iyer is an Enterprise Consultant for the Professional Services Team&nbsp;at Amazon Web Services</strong>. In this role, he has helped several customers successfully navigate their journey to AWS. His specialties include architecting and implementing highly scalable distributed systems, serverless architectures, large scale migrations, operational&nbsp;security, and leading strategic AWS initiatives. Before he joined Amazon, Balaji spent more than&nbsp;a decade building operating systems, big data analytics solutions, mobile services, and web applications. In his spare time, he enjoys experiencing the great outdoors and spending time with his family.</p> 
<p style="text-align: left"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/29/robert-reeves-150x150.jpg" /></p> 
<p style="text-align: left"><strong>Robert Reeves&nbsp;is a Co-Founder &amp;&nbsp;Chief Technology Officer at Datical</strong>. In this role, he advocates for Datical’s customers and provides technical architecture leadership. Prior to cofounding Datical, Robert was a Director at the Austin Technology Incubator. At ATI, he provided real-world entrepreneurial expertise to ATI member companies to aid in market validation, product development, and fundraising efforts. Robert cofounded Phurnace Software in 2005. He invented and created the flagship product, Phurnace Deliver, which provides middleware infrastructure management to multiple Fortune 500 companies. As Chief Technology Officer for Phurnace, he led technical evangelism efforts, product vision, and large account technical sales efforts. After BMC Software acquired Phurnace in 2009, Robert served as Chief Architect and lead worldwide technology evangelism.</p> 
<hr /> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">How to Create an AMI Builder with AWS CodeBuild and HashiCorp Packer</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Jason Barto</span></span> | on 
<time property="datePublished" datetime="2017-06-01T04:05:35+00:00">01 JUN 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/how-to-create-an-ami-builder-with-aws-codebuild-and-hashicorp-packer/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><strong>Written by AWS Solutions Architects Jason Barto and Heitor Lessa</strong></p> 
<p>It’s an operational and security best practice to create and maintain custom <a href="https://aws.amazon.com/answers/configuration-management/aws-ami-design/">Amazon Machine Images</a>. Because it’s also a best practice to maintain infrastructure as code, it makes sense to use automated tooling to script the creation and configuration of AMIs that are used to quickly launch <a href="https://aws.amazon.com/ec2/">Amazon EC2</a> instances.</p> 
<p>In this first of two posts, we’ll use <a href="https://aws.amazon.com/codebuild/">AWS CodeBuild</a> to programmatically create AMIs for use in our environment. As a part of the AMI generation, we will apply OS patches, configure a banner statement, and install some common software, forming a solid base for future Amazon EC2-based deployments.<br /> <span id="more-1046"></span></p> 
<b>Requirements</b> 
<p>You will need <a href="https://git-scm.com/downloads">Git</a> and a text editor.</p> 
<b>Technologies</b> 
<p><a href="https://aws.amazon.com/codebuild/details/">AWS CodeBuild</a> is a fully managed build service that enables customers to compile source code, run tests, and produce software packages that are ready to deploy. It is elastic, scalable, and provides curated build environments for programming languages such as Java, Ruby, Python, Go, and Node.js. With AWS CodeBuild, you don’t need to provision, manage, and scale your own build servers. For more information, see the <a href="http://docs.aws.amazon.com/codebuild/latest/userguide/welcome.html">AWS CodeBuild User Guide</a>.</p> 
<p><a href="https://www.packer.io/">HashiCorp Packer</a> is an open source utility designed to automate the creation of identical virtual machine images for multiple platforms from a single source configuration. For more information, see the <a href="https://www.packer.io/guides/index.html">HashiCorp Packer documentation</a>.</p> 
<b>Getting Started</b> 
<p>We need to host the AWS CodeBuild and HashiCorp Packer project somewhere. AWS CodeBuild can use <a href="https://aws.amazon.com/s3/">Amazon S3</a>, <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a>, or <a href="https://github.com/">GitHub</a> as source code repositories. For this tutorial, sign in to the AWS Management Console and create an AWS CodeCommit repository. If you have not used AWS CodeCommit before, we recommend that you start with the <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/getting-started.html">Git with AWS CodeCommit Tutorial</a>.</p> 
<b>Create an AWS CodeBuild Project in the Console</b> 
<p>Create an AWS CodeBuild project. It will be used later to build our HashiCorp Packer template.</p> 
<ol> 
<li>From the AWS Management Console, open the AWS CodeBuild console.</li> 
<li>If you have no AWS CodeBuild projects, choose <strong>Get Started</strong> or, on the <strong>Build Projects</strong> page, choose <strong>Create project</strong>.</li> 
<li>On the <strong>Create project</strong> page, type a name for your AWS CodeBuild project (for example, <strong>AMI_Builder</strong>).</li> 
<li>For <strong>Source provider</strong>, choose AWS CodeCommit. From the <strong>Repository</strong> drop-down list, select the repository you created in the Getting Started step.</li> 
</ol> 
<p>AWS CodeBuild uses containers to execute the project’s build instructions and build your project. You can specify custom container images hosted in <a href="https://aws.amazon.com/ecr/">Amazon EC2 Container Registry</a> or <a href="https://hub.docker.com/">DockerHub</a>, but this tutorial uses the default managed Ubuntu container.</p> 
<ol start="5"> 
<li>For <strong>Environment Image</strong>, select <strong>Use an image managed by AWS CodeBuild</strong>. For <strong>Operating system</strong>, choose <strong>Ubuntu</strong>. For <strong>Runtime</strong>, choose <strong>Base</strong>. For <strong>Version</strong>, choose <strong>aws/codebuild/ubuntu-base:14.04</strong>.</li> 
</ol> 
<p>The next section of the page tells AWS CodeBuild where to find commands that will be executed as a part of the build. For this project, the build commands are stored in the buildspec.yml file in your repository.</p> 
<ol start="6"> 
<li>For <strong>Build specification</strong>, accept the default.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/24/configure_project.png" /></p> 
<p>The buildspec.yml file will use HashiCorp Packer to execute a template and generate an Amazon EC2 AMI. There is no binary output or build result that will be used as an artifact.</p> 
<ol start="7"> 
<li>For <strong>Artifacts type</strong>, choose <strong>No artifacts</strong>.</li> 
</ol> 
<p>In the Service Role section the service role you select here will provide the AWS CodeBuild container with permissions to your AWS account. HashiCorp Packer needs permissions to create a temporary EC2 instance and an AMI, delete an EC2 instance, and perform other EC2-related actions. .</p> 
<p>For the purposes of this post, allow AWS CodeBuild to create a service role for you. You will update it later with the permissions required by HashiCorp Packer.</p> 
<ol start="8"> 
<li>For <strong>Service Role</strong> choose the default of <strong>Create a service role in your account</strong>.</li> 
<li>Choose <strong>Continue</strong>.</li> 
<li>Review the settings on the next page, and then choose <strong>Save</strong>.</li> 
</ol> 
<b>Update Service Role Permissions</b> 
<p>You have now created an AWS CodeBuild project that is connected to an AWS CodeCommit repository and is ready to build our source code. Now we need to grant AWS CodeBuild the additional permissions it will need to create, delete, and image an EC2 instance.</p> 
<ol> 
<li>Open the IAM console and click the AWS CodeBuild service role, created in the last section, to display its summary page.</li> 
<li>On the summary page, under <strong>Permissions</strong>, expand <strong>Inline policies</strong>, and click the link to create a policy.</li> 
<li>Choose <strong>Custom Policy</strong>, and then choose <strong>Select</strong>.</li> 
<li>Copy and paste the IAM policy from the <a href="https://www.packer.io/docs/builders/amazon.html#using-an-iam-instance-profile">HashiCorp Packer documentation</a> into the text area. Type a name for the policy (for example, <strong>codebuild-AMI_Builder-ec2-permissions</strong>).</li> 
<li>Choose <strong>Validate Policy</strong>, and then choose <strong>Apply Policy</strong> to link the policy with the service role.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/24/permissions.png" /></p> 
<p>AWS CodeBuild should now have the permissions required to create AMIs.</p> 
<b>Initial Commit</b> 
<p>The next step is to create the HashiCorp Packer template and build specification. Check out a copy of the Git repository and create two files:</p> 
<li>The HashiCorp Packer template, amazon-linux_packer-template.json.</li> 
<li>The AWS CodeBuild configuration file, buildspec.yml.</li> 
<b>Create a HashiCorp Packer Template</b> 
<p>A HashiCorp Packer template is a JSON-formatted document that provides HashiCorp Packer with information about how to build a machine image. A HashiCorp Packer template can be composed of many keys. In this post, the focus is on the builders and provisioners keys. For more information, see <a href="https://www.packer.io/docs/templates/index.html">Templates</a> on the HashiCorp Packer website.</p> 
<p>Using a text editor, create a HashiCorp Packer template named amazon-linux_packer-template.json that contains three sections: variables, builders, and provisioners.</p> 
<p>The variables section defines two variables, <code>aws_region</code> and <code>aws_ami_name</code>. These variables can be reused later in the template. They are defined by using an environment variable <code>{{env `AWS_REGION`}}</code> and an internal HashiCorp Packer function <code>{{isotime \&quot;02Jan2006\&quot;}}</code> . For more information about HashiCorp Packer functions, see <a href="https://www.packer.io/docs/templates/engine.html">Template Engine</a> on the HashiCorp Packer website.</p> 
<p>The builders section configures the amazon-ebs builder to deploy an instance into the same region in which AWS CodeBuild is running, using a t2.micro instance, and to connect to the instance with a username of ec2-user. The source_ami_filter is being used to find the latest version of Amazon Linux available for the target region. The selected source AMI will be the base for your custom AMI. After the EC2 instance has been provisioned, amazon-ebs will create an AMI using the value of the <code>aws_ami_name</code> variable as the AMI name.</p> 
<code class="lang-json">{
&quot;variables&quot;: {
&quot;aws_region&quot;: &quot;{{env `AWS_REGION`}}&quot;,
&quot;aws_ami_name&quot;: &quot;amazon-linux_{{isotime \&quot;02Jan2006\&quot;}}&quot;
},
&quot;builders&quot;: [{
&quot;type&quot;: &quot;amazon-ebs&quot;,
&quot;region&quot;: &quot;{{user `aws_region`}}&quot;,
&quot;instance_type&quot;: &quot;t2.micro&quot;,
&quot;ssh_username&quot;: &quot;ec2-user&quot;,
&quot;ami_name&quot;: &quot;{{user `aws_ami_name`}}&quot;,
&quot;ami_description&quot;: &quot;Customized Amazon Linux&quot;,
&quot;associate_public_ip_address&quot;: &quot;true&quot;,
&quot;source_ami_filter&quot;: {
&quot;filters&quot;: {
&quot;virtualization-type&quot;: &quot;hvm&quot;,
&quot;name&quot;: &quot;amzn-ami*-ebs&quot;,
&quot;root-device-type&quot;: &quot;ebs&quot;
},
&quot;owners&quot;: [&quot;137112412989&quot;, &quot;591542846629&quot;, &quot;801119661308&quot;, &quot;102837901569&quot;, &quot;013907871322&quot;, &quot;206029621532&quot;, &quot;286198878708&quot;, &quot;443319210888&quot;],
&quot;most_recent&quot;: true
}
}],
&quot;provisioners&quot;: [
{
&quot;type&quot;: &quot;shell&quot;,
&quot;inline&quot;: [
&quot;sudo yum update -y&quot;,
&quot;sudo /usr/sbin/update-motd --disable&quot;,
&quot;echo 'No unauthorized access permitted' | sudo tee /etc/motd&quot;,
&quot;sudo rm /etc/issue&quot;,
&quot;sudo ln -s /etc/motd /etc/issue&quot;,
&quot;sudo yum install -y elinks screen&quot;
]
}
]
}
</code> 
<p>The provisioners section provides shell commands that Packer will use to configure the virtual machine after it has been created by the builders, but before it is captured as a machine image. The provisioners section updates the package management system and cleans up temporary keys before exiting. For more information, see <a href="https://www.packer.io/docs/provisioners/index.html">Provisioners</a>&nbsp;on the HashiCorp Packer website.</p> 
<p>AWS CodeBuild and the containers it executes operate outside of a customer’s VPC. Any actions performed as a part of your build project will not have access to private IP addresses in your VPC. As a result a public IP address must be assigned to the EC2 instance so that HashiCorp Packer can remotely connect to it and configure the system. If the instance is not going to be launched in your default VPC, you must provide HashiCorp Packer with the VPC and a public-facing subnet. You will also need to be able to use SSH to connect to the EC2 instance from the internet.</p> 
<p>To protect against malicious behavior and prevent unnecessary access, during the short life of the EC2 instance, HashiCorp Packer will use a newly created key pair and security group to deploy the EC2 instance. They will be deleted after the AMI has been created.</p> 
<p>The source_ami_filter is an alternative to source_ami, which states which AMI should be used to create the EC2 instance. source_ami_filter will query the AMIs available in your region and select the one that best matches the filter criteria. In this example, source_ami_filter is configured to find the most recent AMI that matches the expression amzn-ami*-ebs. The filter has been restricted to match AMIs owned by a limited set of AWS accounts. The owners listed are accounts owned and managed by AWS.</p> 
<b>Create a Build Specification</b> 
<p>AWS CodeBuild uses the buildspec.yml file to execute user-defined commands at various phases of the build process. This file tells AWS CodeBuild how to use HashiCorp Packer to execute the template.</p> 
<p>The buildspec.yml must contain the following:</p> 
<code class="lang-yaml">---
version: 0.2
phases:
pre_build:
commands:
- echo &quot;Installing HashiCorp Packer...&quot;
- curl -qL -o packer.zip https://releases.hashicorp.com/packer/0.12.3/packer_0.12.3_linux_amd64.zip &amp;&amp; unzip packer.zip
- echo &quot;Installing jq...&quot;
- curl -qL -o jq https://stedolan.github.io/jq/download/linux64/jq &amp;&amp; chmod +x ./jq
- echo &quot;Validating amazon-linux_packer-template.json&quot;
- ./packer validate amazon-linux_packer-template.json
build:
commands:
### HashiCorp Packer cannot currently obtain the AWS CodeBuild-assigned role and its credentials
### Manually capture and configure the AWS CLI to provide HashiCorp Packer with AWS credentials
### More info here: https://github.com/mitchellh/packer/issues/4279
- echo &quot;Configuring AWS credentials&quot;
- curl -qL -o aws_credentials.json http://169.254.170.2/$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI &gt; aws_credentials.json
- aws configure set region $AWS_REGION
- aws configure set aws_access_key_id `./jq -r '.AccessKeyId' aws_credentials.json`
- aws configure set aws_secret_access_key `./jq -r '.SecretAccessKey' aws_credentials.json`
- aws configure set aws_session_token `./jq -r '.Token' aws_credentials.json`
- echo &quot;Building HashiCorp Packer template, amazon-linux_packer-template.json&quot;
- ./packer build amazon-linux_packer-template.json
post_build:
commands:
- echo &quot;HashiCorp Packer build completed on `date`&quot;
</code> 
<p>During pre_build, this build file configures the AWS CodeBuild container with the tools it will need to execute the Packer template. The first tool is HashiCorp Packer, which is available for download from the <a href="https://www.packer.io/downloads.html">HashiCorp website</a>. The second tool is the <a href="https://stedolan.github.io/jq/">jq</a> utitility, used to parse JSON files. The last command in this phase validates the HashiCorp Packer template to ensure there are no syntax errors.</p> 
<p>In the build phase, the build file configures the build container’s AWS credentials using the metadata URL. This metadata will provide the AWS credentials provided by the IAM role assigned to the AWS CodeBuild project earlier to HashiCorp Packer so that it can create EC2 resources on your behalf. As a final step the HashiCorp Packer template is executed, resulting in the building of an EC2 AMI.</p> 
<b>Execute the AWS CodeBuild Project</b> 
<p>Commit the new files to your repository and push them to AWS CodeCommit. You are now ready to have AWS CodeBuild create the AMI.</p> 
<ol> 
<li>From the AWS Management Console, navigate to the AWS CodeBuild console.</li> 
<li>In the list of build projects, choose the project you created, and then choose <strong>Start build</strong>.</li> 
<li>In <strong>Start new build</strong>, choose which branch and revision of your AWS CodeCommit repository should be used to build your AMI.</li> 
<li>From the <strong>Branch</strong> drop-down list, choose <strong>master</strong>. This should populate the <strong>Source version</strong> field with the latest commit you pushed to the repository.</li> 
<li>Choose <strong>Start build</strong>. AWS CodeBuild will execute the buildspec.yml file in your repository.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/24/build_start.png" /></p> 
<p>You will be taken to a page that provides status and results for each phase of the build. <strong>Succeeded</strong> should be displayed for every stage. If an error occurred, you can review the build logs at the bottom of the page for any error messages.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/24/build_status.png" /></p> 
<p>During the build, HashiCorp Packer will generate a temporary key pair, launch an EC2 instance, remotely connect to the instance using the generated key pair, and then provision the machine, before converting the instance to an AMI and tearing down everything that was created to build the AMI. After these steps are complete, the build log should contain output that shows an AMI with an ID of something like <strong>ami-1a2b3cde</strong> was created.</p> 
<p>This AMI can now be used to create EC2 instances on demand or as part of an Auto Scaling group to elastically scale your infrastructure.</p> 
<b>Next Steps</b> 
<p>We hope you found the information in this first post helpful and will use it as a starting point for your own infrastructure as code pipeline. In this post, we created a portion of your infrastructure as code in the form of a HashiCorp Packer template. We used AWS CodeBuild to create an AMI based on the template. Your next steps could include:</p> 
<li>Building more than one HashiCorp Packer template. Multiple HashiCorp Packer templates can be used to build custom AMIs based on different source AMIs, perhaps one for Ubuntu and another for Microsoft Windows.</li> 
<li>Adding AWS CodePipeline to monitor your AWS CodeCommit repository. When a new version is committed, AWS CodePipeline will call AWS CodeBuild and re-create your AMIs automatically.</li> 
<li>Using CloudWatch Events to implement automated compliance. You can use an <a href="https://aws.amazon.com/lambda/?sc_channel=PS&amp;sc_campaign=acquisition_US&amp;sc_publisher=google&amp;sc_medium=lambda_b&amp;sc_content=lambda_e&amp;sc_detail=aws%20lambda&amp;sc_category=lambda&amp;sc_segment=186623768554&amp;sc_matchtype=e&amp;sc_country=US&amp;s_kwcid=AL!4422!3!186623768554!e!!g!!aws%20lambda&amp;ef_id=WFGCgwAABYUoeNPB:20170501191444:s">AWS Lambda</a> function to verify that all EC2 instances launched in your account are using one of your preconfigured custom AMIs.</li> 
<p>For next steps and taking advantage of other more advanced features and services please see <a href="https://aws.amazon.com/blogs/devops/how-to-create-an-ami-builder-with-aws-codebuild-and-hashicorp-packer-part-2/" title="How to Create an AMI Builder with AWS CodeBuild and HashiCorp Packer – Part 2" target="null">part 2</a> in this two-part series. The post uses AWS services such as AWS CodePipeline, AWS CloudFormation, and Amazon Cloudwatch Events to continuously release new AMIs from end to end.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Building a Secure Cross-Account Continuous Delivery Pipeline</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Anuj Sharma</span></span> | on 
<time property="datePublished" datetime="2017-05-16T08:58:11+00:00">16 MAY 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/aws-building-a-secure-cross-account-continuous-delivery-pipeline/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>Most organizations create multiple AWS accounts because they provide the highest level of resource and security isolation. In this blog post, I will discuss how to use cross account <a title="undefined" href="https://aws.amazon.com/iam/" target="null">AWS Identity and Access Management (IAM)</a> access to orchestrate continuous integration and continuous deployment.</p> 
<b>Do I need multiple accounts?</b> 
<p>If you answer “yes” to any of the following questions you should consider creating more AWS accounts:</p> 
<li>Does your business require administrative isolation between workloads? Administrative isolation by account is the most straightforward way to grant independent administrative groups different levels of administrative control over AWS resources based on workload, development lifecycle, business unit (BU), or data sensitivity.</li> 
<li>Does your business require limited visibility and discoverability of workloads? Accounts provide a natural boundary for visibility and discoverability. Workloads cannot be accessed or viewed unless an administrator of the account enables access to users managed in another account.</li> 
<li>Does your business require isolation to minimize blast radius? Separate accounts help define boundaries and provide natural blast-radius isolation to limit the impact of a critical event such as a security breach, an unavailable <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">AWS Region or Availability Zone</a>, account suspensions, and so on.</li> 
<li>Does your business require a particular workload to operate within <a href="http://docs.aws.amazon.com/general/latest/gr/aws_service_limits.html">AWS service limits</a> without impacting the limits of another workload? You can use AWS account service limits to impose restrictions on a business unit, development team, or project. For example, if you create an AWS account for a project group, you can limit the number of Amazon Elastic Compute Cloud (<a href="https://aws.amazon.com/ec2/">Amazon EC2</a>) or high performance computing (HPC) instances that can be launched by the account.</li> 
<li>Does your business require strong isolation of recovery or auditing data? If regulatory requirements require you to control access and visibility to auditing data, you can isolate the data in an account separate from the one where you run your workloads (for example, by writing <a href="https://aws.amazon.com/cloudtrail/?sc_channel=PS&amp;sc_campaign=acquisition_US&amp;sc_publisher=google&amp;sc_medium=cloudtrail_b_test_q32016&amp;sc_content=cloudtrail_bmm&amp;sc_detail=%2Bcloudtrail&amp;sc_category=cloudtrial&amp;sc_segment=105093175122&amp;sc_matchtype=b&amp;sc_country=US&amp;s_kwcid=AL!4422!3!105093175122!b!!g!!%2Bcloudtrail&amp;ef_id=WFGCgwAABYUoeNPB:20170502153559:s">AWS CloudTrail</a> logs to a different account).</li> 
<li>Do your workloads depend on specific instance reservations to support high availability (HA) or disaster recovery (DR) capacity requirements? Reserved Instances (RIs) ensure reserved capacity for services such as Amazon EC2 and Amazon Relational Database Service (<a href="https://aws.amazon.com/rds/">Amazon RDS</a>) at the individual account level.</li> 
<b>Use case</b> 
<p>The identities in this use case are set up as follows:</p> 
<li><strong>DevAccount </strong></li> 
<p>Developers check the code into an <a href="https://aws.amazon.com/codecommit/">AWS CodeCommit</a> repository. It stores all the repositories as a single source of truth for application code. Developers have full control over this account. This account is usually used as a sandbox for developers.</p> 
<li><strong>ToolsAccount</strong></li> 
<p>A central location for all the tools related to the organization, including continuous delivery/deployment services such as <a href="https://aws.amazon.com/codepipeline/">AWS CodePipeline</a> and <a href="https://aws.amazon.com/codebuild/">AWS CodeBuild</a>. Developers have limited/read-only access in this account. The Operations team has more control.</p> 
<li><strong>TestAccount</strong></li> 
<p>Applications using the CI/CD orchestration for test purposes are deployed from this account. Developers and the Operations team have limited/read-only access in this account.</p> 
<li><strong>ProdAccount</strong></li> 
<p>Applications using the CI/CD orchestration tested in the ToolsAccount are deployed to production from this account. Developers and the Operations team have limited/read-only access in this account.</p> 
<b>Solution</b> 
<p>In this solution, we will check in sample code for an <a href="https://aws.amazon.com/lambda">AWS Lambda</a> function in the Dev account. This will trigger the pipeline (created in AWS CodePipeline) and run the build using AWS CodeBuild in the Tools account. The pipeline will then deploy the Lambda function to the Test and Prod accounts.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/CrossAccount-CI-CD.jpg"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/CrossAccount-CI-CD.jpg" /></a></p> 
<p>&nbsp;</p> 
<b>Setup</b> 
<ol> 
<li>Clone this repository. It contains the <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation templates </a>that we will use in this walkthrough.</li> 
</ol> 
<code class="lang-bash">git clone https://github.com/awslabs/aws-refarch-cross-account-pipeline.git
</code> 
<ol start="2"> 
<li>Follow the instructions in the repository README to push the sample AWS Lambda application to an AWS CodeCommit repository in the Dev account.</li> 
<li>Install the AWS Command Line Interface as described <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html">here</a>. To prepare your access keys or assume-role to make calls to AWS, configure the AWS CLI as described <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">here</a>.</li> 
</ol> 
<b></b> 
<b>Walkthrough</b> 
<p><strong>Note:</strong> Follow the steps in the order they’re written. Otherwise, the resources might not be created correctly.</p> 
<ol> 
<li>In the Tools account, deploy this CloudFormation template. It will create <a href="http://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#master_keys">the customer master keys</a> (CMK) in <a href="http://docs.aws.amazon.com/kms/latest/developerguide/overview.html">AWS Key Management Service</a> (AWS KMS), grant access to Dev, Test, and Prod accounts to use these keys, and create an <a href="https://aws.amazon.com/s3/">Amazon S3</a> bucket to hold artifacts from AWS CodePipeline.</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name pre-reqs \
--template-file ToolsAcct/pre-reqs.yaml --parameter-overrides \
DevAccount=ENTER_DEV_ACCT TestAccount=ENTER_TEST_ACCT \
ProductionAccount=ENTER_PROD_ACCT</code> 
<p>In the output section of the CloudFormation console, make a note of the <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">Amazon Resource Number</a> (ARN) of the CMK and the S3 bucket name. You will need them in the next step.</p> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/10/Screen-Shot-2017-04-18-at-5.36.32-PM.png"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/10/Screen-Shot-2017-04-18-at-5.36.32-PM.png" /></a></p> 
<ol start="2"> 
<li>In the Dev account, which hosts the AWS CodeCommit repository, deploy this CloudFormation template. This template will create the IAM roles, which will later be assumed by the pipeline running in the Tools account. Enter the AWS account number for the Tools account and the CMK ARN.</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name toolsacct-codepipeline-role \
--template-file DevAccount/toolsacct-codepipeline-codecommit.yaml \
--capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides ToolsAccount=ENTER_TOOLS_ACCT CMKARN=FROM_1st_Step</code> 
<ol start="3"> 
<li>In the Test and Prod accounts where you will deploy the Lambda code, execute this CloudFormation template. This template creates IAM roles, which will later be assumed by the pipeline to create, deploy, and update the sample AWS Lambda function through CloudFormation.</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name toolsacct-codepipeline-cloudformation-role \
--template-file TestAccount/toolsacct-codepipeline-cloudformation-deployer.yaml \
--capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides ToolsAccount=ENTER_TOOLS_ACCT CMKARN=FROM_1st_STEP  \
S3Bucket=FROM_1st_STEP</code> 
<ol start="4"> 
<li>In the Tools account, which hosts AWS CodePipeline, execute this CloudFormation template. This creates a pipeline, but does not add permissions for the cross accounts (Dev, Test, and Prod).</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name sample-lambda-pipeline \
--template-file ToolsAcct/code-pipeline.yaml \
--parameter-overrides DevAccount=ENTER_DEV_ACCT TestAccount=ENTER_TEST_ACCT \
ProductionAccount=ENTER_PROD_ACCT CMKARN=FROM_1st_STEP \
S3Bucket=FROM_1st_STEP--capabilities CAPABILITY_NAMED_IAM</code> 
<ol start="5"> 
<li>In the Tools account, execute this CloudFormation template, which give access to the role created in step 4. This role will be assumed by AWS CodeBuild to decrypt artifacts in the S3 bucket. This is the same template that was used in step 1, but with different parameters.</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name pre-reqs \
--template-file ToolsAcct/pre-reqs.yaml \
--parameter-overrides CodeBuildCondition=true</code> 
<ol start="6"> 
<li>In the Tools account, execute this CloudFormation template, which will do the following: 
<ol start="a"> 
<li>Add the IAM role created in step 2. This role is used by AWS CodePipeline in the Tools account for checking out code from the AWS CodeCommit repository in the Dev account.</li> 
<li>Add the IAM role created in step 3. This role is used by AWS CodePipeline in the Tools account for deploying the code package to the Test and Prod accounts.</li> 
</ol> </li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --stack-name sample-lambda-pipeline \
--template-file ToolsAcct/code-pipeline.yaml \
--parameter-overrides CrossAccountCondition=true \
--capabilities CAPABILITY_NAMED_IAM</code> 
<b>What did we just do?</b> 
<p><a href="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/details-cross-account-pipeline.png"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/details-cross-account-pipeline.png" /></a></p> 
<ol> 
<li>The pipeline created in step 4 and updated in step 6 checks out code from the AWS CodeCommit repository. It uses the IAM role created in step 2. The IAM role created in step 4 has permissions to assume the role created in step 2. This role will be assumed by AWS CodeBuild to decrypt artifacts in the S3 bucket, as described in step 5.</li> 
<li>The IAM role created in step 2 has permission to check out code. See <a href="https://github.com/awslabs/aws-refarch-cross-account-pipeline/blob/master/DevAccount/toolsacct-codepipeline-codecommit.yaml#L35">here</a>.</li> 
<li>The IAM role created in step 2 also has permission to upload the checked-out code to the S3 bucket created in step 1. It uses the KMS keys created in step 1 for server-side encryption.</li> 
<li>Upon successfully checking out the code, AWS CodePipeline triggers AWS CodeBuild. The AWS CodeBuild project created in step 4 is configured to use the CMK created in step 1 for cryptography operations. See <a href="https://github.com/awslabs/aws-refarch-cross-account-pipeline/blob/master/ToolsAcct/code-pipeline.yaml#L94">here</a>. The AWS CodeBuild role is created later in step 4. In step 5, access is granted to the AWS CodeBuild role to allow the use of the CMK for cryptography.</li> 
<li>AWS CodeBuild uses <a href="https://pypi.python.org/pypi/pip">pip</a> to install any libraries for the sample Lambda function. It also executes the <a href="http://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html">aws cloudformation package</a> command to create a Lambda function deployment package, uploads the package to the specified S3 bucket, and adds a reference to the uploaded package to the CloudFormation template. See <a href="https://github.com/awslabs/aws-refarch-cross-account-pipeline/blob/master/ToolsAcct/code-pipeline.yaml#L118">here</a>.</li> 
<li>Using the role created in step 3, AWS CodePipeline executes the transformed CloudFormation template (received as an output from AWS CodeBuild) in the Test account. The AWS CodePipeline role created in step 4 has permissions to assume the IAM role created in step 3, as described in step 5.</li> 
<li>The IAM role assumed by AWS CodePipeline passes the role to an IAM role that can be assumed by CloudFormation. AWS CloudFormation creates and updates the Lambda function using the code that was built and uploaded by AWS CodeBuild.</li> 
</ol> 
<p>This is what the pipeline looks like using the sample code:<br /> <a href="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/Screen-Shot-2017-04-27-at-10.56.56-AM.png"><img class="aligncenter wp-image-1011 size-medium" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/08/Screen-Shot-2017-04-27-at-10.56.56-AM.png" /></a></p> 
<b>Conclusion</b> 
<p>Creating multiple AWS accounts provides the highest degree of isolation and is appropriate for a number of use cases. However, keeping a centralized account to orchestrate continuous delivery and deployment using AWS CodePipeline and AWS CodeBuild eliminates the need to duplicate the delivery pipeline. You can secure the pipeline through the use of cross account IAM roles and the encryption of artifacts using AWS KMS. For more information, see <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html">Providing Access to an IAM User in Another AWS Account That You Own in the IAM User Guide</a>.</p> 
<b>References</b> 
<li><a href="https://d0.awsstatic.com/aws-answers/AWS_Multi_Account_Security_Strategy.pdf">AWS Multiple Account Security Strategy</a></li> 
<li><a href="https://d0.awsstatic.com/aws-answers/AWS_Multi_Account_Billing_Strategy.pdf">AWS Multiple Account Billing Strategy</a></li> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Use AWS CloudFormation to Automate the Creation of an S3 Bucket with Cross-Region Replication Enabled</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Rajakumar Sampathkumar</span></span> | on 
<time property="datePublished" datetime="2017-05-15T13:16:10+00:00">15 MAY 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/use-aws-cloudformation-to-automate-the-creation-of-an-s3-bucket-with-cross-region-replication-enabled/" property="url">Permalink</a> | 
<a id="aws-comment-trigger-938" href="https://commenting.awsblogs.com/embed.html?disqus_shortname=aws-devops-blog&amp;disqus_identifier=938&amp;disqus_title=Use+AWS+CloudFormation+to+Automate+the+Creation+of+an+S3+Bucket+with+Cross-Region+Replication+Enabled&amp;disqus_url=https://aws.amazon.com/blogs/devops/use-aws-cloudformation-to-automate-the-creation-of-an-s3-bucket-with-cross-region-replication-enabled/" data-sandbox-attr="allow-forms allow-scripts allow-popups allow-same-origin" property="discussionUrl"><i class="icon-comment"></i> Comments</a> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-938');
});
</script> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>At the request of many of our customers, in this blog post, we will discuss how to use <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> to create an <a href="https://aws.amazon.com/s3/">S3</a> bucket with <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/crr.html">cross-region replication</a> enabled. We’ve included a CloudFormation template with this post that uses an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a>-backed custom resource to create source and destination buckets.</p> 
<p><strong></strong></p> 
<strong> <h3>What is S3 cross-region replication?</h3> </strong> 
<p><strong></strong></p> 
<p>Cross-region replication is a bucket-level feature that enables automatic, asynchronous copying of objects across buckets in different AWS regions. You can create two buckets in two different regions and use the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html#cfn-s3-bucket-replicationconfiguration">ReplicationConfiguration</a> property to replicate the objects from one bucket to the other. For example, you can have a bucket in us-east-1 and replicate the bucket objects to a bucket in us-west-2.</p> 
<p>For more information, see <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/crr-what-is-isnot-replicated.html">What Is and Is Not Replicated in Cross-Region Replication</a>.</p> 
<p><strong></strong></p> 
<strong> <h3>Challenge</h3> </strong> 
<p><strong></strong></p> 
<p>When you enable cross-region replication, the replicated objects will be stored in only one destination (an S3 bucket). The destination bucket must already exist and it must be in an AWS region different from your source bucket.</p> 
<p>Using CloudFormation, you cannot create the destination bucket in a region different from the region in which you are creating your stack. To create the destination bucket, you can:</p> 
<li>Use another CloudFormation template.</li> 
<li>Use <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html">AWS Lambda-backed custom resources</a> in the same template.</li> 
<p><strong></strong></p> 
<strong> <h3>Solution overview</h3> </strong> 
<p><strong></strong></p> 
<p>The CloudFormation template provided with this post uses an AWS Lambda-backed custom resource to create an S3 destination bucket in one region and a source S3 bucket in the same region as the CloudFormation endpoint.</p> 
<p><strong>Note</strong>: In this scenario, CloudFormation is not aware of the destination bucket created by AWS Lambda. For this reason, CloudFormation will not delete this resource when the stack is deleted.</p> 
<p><span id="more-938"></span></p> 
<p><strong></strong></p> 
<strong> <h3>How does it work?</h3> </strong> 
<p><strong></strong></p> 
<p>Launch the stack and provide the following custom values to the CloudFormation template. These (user input) values will be passed as <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">parameters</a> to the template.</p> 
<li>OriginalBucketName</li> 
<li>ReplicationBucketName</li> 
<li>ReplicationRegion (different from the source region from which you are launching the stack)</li> 
<p>After the parameters are received by the template, the CloudFormation stack creates these IAM roles:</p> 
<li>A Lambda execution role with access to Amazon CloudWatch Logs, Amazon EC2, and Amazon S3</li> 
<li>An S3 role with AmazonS3FullAccess</li> 
<p>The AWS Lambda function is created after the roles are created. Lambda triggers the creation of the S3 destination bucket in the region specified in the CloudFormation template. Versioning is enabled on the bucket.</p> 
<p>When the destination bucket is available, CloudFormation initiates the creation of the source bucket with cross-region replication enabled. The destination bucket is the target for cross-region replication.</p> 
<p><strong>Note</strong>: The creation of the IAM role and Lambda function is automated in the template. You do not need not create them manually.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/03/AWS-Blogpost-Create-S3-bucket-with-CRR-using-cloud-formation-v2-952x1024.jpg" /></p> 
<p><strong></strong></p> 
<strong> <h3>Automated deployment</h3> </strong> 
<p><strong></strong></p> 
<p>The step-by-step instructions in this section show you how you can automate the creation of an S3 bucket with cross-region replication enabled. After you click the button, the bucket will be created in approximately two minutes.</p> 
<p><strong>Note</strong>: Running this solution may result in charges to your AWS account. These include possible charges for Amazon S3 and AWS Lambda.</p> 
<p>1. Sign in to the AWS Management Console and open the AWS CloudFormation console. Choose the <strong>Launch Stack</strong> button to create the AWS CloudFormation stack (S3CrossRegionReplication).</p> 
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=S3CrossRegionReplication&amp;templateURL=https://s3.amazonaws.com/blog-s3-crr-automate/cfn-s3-x-region-replication_final.yml"><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/972a67c48192728a34979d9a35164c1295401b71/2017/03/30/Launch-Stack.png" /></a></p> 
<p><em>The template will be loaded from an S3 bucket automatically.</em></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/02/S3CRR_Create_A_New_Stack_1-1024x597.png" /></p> 
<p>2. On the <strong>Specify details</strong> page, change the stack name, if required. Provide the following custom values to the CloudFormation template. These (user input) values will be passed as parameters to the template.</p> 
<li>OriginalBucketName</li> 
<li>ReplicationBucketName</li> 
<li>ReplicationRegion</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/02/S3CRR_Create_A_New_Stack_2-1024x584.png" /></p> 
<p>Choose <strong>Next</strong>.</p> 
<p>3. On the <strong>Options</strong> page, you can specify tags for your AWS CloudFormation template, if you like, and then choose <strong>Next</strong>.</p> 
<p>Permissions are built in the template. You don’t have to choose an IAM role.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/02/S3CRR_Create_A_New_Stack_3-1024x674.png" /></p> 
<p>Choose <strong>Next</strong>.</p> 
<p>4. On the <strong>Review</strong> page, review your template details. Select the acknowledgement check box, and then choose <strong>Create</strong> to create the stack.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/02/S3CRR_Create_A_New_Stack_4-1024x749.png" /></p> 
<p>You can also <a href="https://s3.amazonaws.com/blog-s3-crr-automate/cfn-s3-x-region-replication_final.yml">download the template</a> and use it as a starting point for your own implementation. The template is launched in the US East (N. Virginia) region by default. To launch the CloudFormation stack in a different AWS region, use the region selector in the console navigation bar after you click <strong>Launch stack</strong>.</p> 
<p><strong>Note</strong>: Because this solution uses AWS Lambda, which is currently available in selected regions only, be sure you launch this solution in an AWS region where Lambda is available. For more information, see <a href="https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/">AWS service offerings by region</a>.</p> 
<p><strong></strong></p> 
<strong> <h3>Conclusion</h3> </strong> 
<p><strong></strong></p> 
<p>In this blog post, we showed you how to use a single AWS CloudFormation template and AWS Lambda-backed custom resources to create an S3 bucket with cross-region replication enabled.<br /> &nbsp;<br /> <em>I would like to thank my colleague Arun Tunuri for his contributions in designing the CloudFormation template.</em></p> 
<p>&nbsp;</p> 
<hr /> 
<p><strong></strong></p> 
<strong> <h3>About the author</h3> </strong> 
<p><strong></strong></p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/05/02/d695a2abcda41fc682c5ef06305d8d21.jpeg" /><strong>Rajakumar Sampathkumar</strong> is a Senior Technical Account Manager for Amazon Web Services. In his spare time, he is a passionate author and likes to spend quality time with his kids and nature.</p> 
<p>&nbsp;<br /> &nbsp;</p> 
<script>
require(['blog'], function() {
AWS.Blog.commenting('#aws-comment-trigger-938');
});
</script> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Performing Blue/Green Deployments with AWS CodeDeploy and Auto Scaling Groups</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Jeff Levine</span></span> | on 
<time property="datePublished" datetime="2017-04-18T23:26:52+00:00">18 APR 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/performing-bluegreen-deployments-with-aws-codedeploy-and-auto-scaling-groups/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><em>Jeff Levine is a Solutions Architect for Amazon Web Services.</em></p> 
<p>Amazon Web Services offers services that enable organizations to leverage the power of the cloud for their development and deployment needs. <a href="https://aws.amazon.com/codedeploy/">AWS CodeDeploy</a> makes it possible to automate the deployment of code to either <a href="https://aws.amazon.com/ec2/">Amazon EC2</a> or on-premises instances. AWS CodeDeploy now supports <a href="https://aws.amazon.com/about-aws/whats-new/2017/01/aws-codedeploy-introduces-blue-green-deployments/">blue/green deployments</a>. In this blog post, I will discuss the benefits of blue/green deployments and show you how to perform one.</p> 
<p><span id="more-870"></span></p> 
<p><strong>The benefits of blue/green deployments</strong></p> 
<p>Blue/green deployment involves two production environments:</p> 
<li>Blue is the active environment.</li> 
<li>Green is for the release of a new version.</li> 
<p>Here are some of the advantages of a blue/green deployment:</p> 
<li>You can perform testing on the green environment without disrupting the blue environment.</li> 
<li>Switching to the green environment involves no downtime. It only requires the redirecting of user traffic.</li> 
<li>Rolling back from the green environment to the blue environment in the event of a problem is easier because you can redirect traffic to the blue environment without having to rebuild it.</li> 
<li>You can incorporate the principle of infrastructure immutability by provisioning fresh instances when you need to make changes. In this way, you avoid configuration drift.</li> 
<p>AWS CodeDeploy offers two ways to perform blue/green deployments:</p> 
<li>In the first approach, AWS CodeDeploy makes a copy of an Auto Scaling group. It, in turn, provisions new Amazon EC2 instances, deploys the application to these new instances, and then redirects traffic to the newly deployed code.</li> 
<li>In the second approach, you use instance tags or an Auto Scaling group to select the instances that will be used for the green environment. AWS CodeDeploy then deploys the code to the tagged instances.</li> 
<p>So how do you set up your first blue environment? A best practice is to start with an in-place deployment. You can also start with an existing, empty Auto Scaling group.</p> 
<p><strong>An example of blue/green deployments</strong></p> 
<p>Let’s take a look at an example of how to use Auto Scaling groups to perform a blue/green deployment.</p> 
<p><strong>Overview</strong></p> 
<p>In the following figure, the example environment includes an Amazon EC2 instance that serves as a workstation for AWS CodeDeploy. A release manager or developer could use this workstation to deploy new versions of code. The blue environment consists of an Auto Scaling group that provisions two more instances to function as web servers. The web servers will initially contain the first version of an application and the AWS CodeDeploy agent. A load balancer directs traffic to the two web servers in a round-robin manner.</p> 
<p>The release manager uses the workstation instance to push a new version of the application to AWS CodeDeploy and starts a blue-green deployment. AWS CodeDeploy creates a copy of the Auto Scaling group. It launches two new web server instances just like the original two. AWS CodeDeploy installs the new version of the application and then redirects the load balancer to the new instances. The original instances continue to be part of the original Auto Scaling group. They can be reattached to the load balancer, if needed.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/18/CDBG-topology.png" /></p> 
<p><strong>Prerequisites for building the example</strong></p> 
<p>Here are the things you will need to build out this example.</p> 
<li>An IAM user with permissions to use Amazon EC2, Amazon S3, Amazon VPC, AWS CodeDeploy, and AWS CloudFormation.</li> 
<li>An AWS region and Availability Zone in which you can provision the environment.</li> 
<li>An Amazon EC2 key pair.</li> 
<li>Working knowledge of the aforementioned services and the AWS Management Console, and familiarity with connecting to an Amazon EC2 instance.</li> 
<p><strong>Other Considerations</strong></p> 
<p>You will incur charges from AWS for the use of the underlying AWS services in this example. The Amazon EC2 t2.micro instances and Amazon S3 storage might be covered under the <a href="https://aws.amazon.com/free/">AWS Free Tier</a>, depending on your eligibility. The resources provided in this example are for training purposes. Be sure to consider the security needs of your organization when implementing techniques similar to those described in this blog post.</p> 
<p>Step 1: Create the initial environment</p> 
<ol> 
<li>Download an archive containing the sample template from this <a href="https://github.com/awslabs/codedeploy-blue-green" target="_blank">location</a> and save it in a convenient location.</li> 
<li>Sign in to the AWS Management Console and open the AWS CloudFormation console at <a href="https://console.aws.amazon.com/cloudformation/">https://console.aws.amazon.com/cloudformation/</a>.</li> 
<li>If this is a new AWS CloudFormation account, click <strong>Create New Stack</strong>. Otherwise, click <strong>Create Stack</strong>.</li> 
<li>Under <strong>Upload a template to Amazon S3</strong>, click <strong>Choose File</strong>, choose the YAML file from the archive you downloaded, and then click <strong>Next</strong>.</li> 
<li>In <strong>Specify Details</strong>, in <strong>Stack name</strong>, type <code>bluegreen</code>.</li> 
<li>In <strong>AZName</strong>, select one of the Availability Zones. (In this blog post, I am using us-east-1a.)</li> 
<li>In <strong>BlueGreenKeyPairName</strong>, select the key pair to use.</li> 
<li>In <strong>NamePrefix</strong>, use the default value of <code>bluegreen</code>&nbsp;unless you are already running an application with a name that starts with <code>bluegreen</code>. The name prefix is used to assign name tags to the created resources. Click <strong>Next</strong>.</li> 
<li>On the Options page, click <strong>Next</strong>.</li> 
<li>Select the acknowledgement box to allow the creation of IAM resources, and then click <strong>Create</strong>. It will take CloudFormation about 10 minutes to create the sample environment. In addition to creating the infrastructure resources shown in the diagram, the CloudFormation template also sets up an AWS CodeDeploy application and blue/green deployment group.</li> 
</ol> 
<p>Step 2: Review initial environment</p> 
<ol> 
<li>Look at the CloudFormation stack outputs. You should see something similar to the following.&nbsp;<strong>WorkstationIP</strong> is the IP address of the workstation instance.&nbsp;<strong>AutoScalingGroup</strong> and <strong>LoadBalancer</strong> are the DNS names created by CloudFormation for the Auto Scaling group and the Elastic Load Balancing load balancer.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/CloudFormationOutputs2-1.png" /></li> 
<li>Copy the <strong>LoadBalancer</strong> value into your browser and browse to that link. The following application should be displayed. This PHP application queries the Amazon EC2 instance metadata. If you refresh the page, you will see the IP address and instance ID change in accordance with the round-robin load balancing algorithm.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/appversion1-v2-1.png" /></li> 
<li>Go to the EC2 console and display the instances. You will see three running instances associated with this example: the workstation and the two web server instances created by the Auto Scaling group. The web server instances make up the blue environment.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/instances1-v2.png" /></li> 
</ol> 
<p>Step 3: Deploy the new version of code</p> 
<ol> 
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html">Connect to the workstation instance</a> at the address displayed in <strong>WorkStationIP</strong>. This instance is running the Ubuntu operating system, so the user name is <strong>ubuntu</strong>. After you sign in, you will see two directories. The scripts directory contains Bourne shell scripts. The newversion directory contains an update to the PHP application.</li> 
<li>Here is the PHP code for the new version in newversion/content/index.php. The only difference from the initially installed code is the application version number.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/newappcode-1.png" /></li> 
<li>Now look at the following scripts/pushnewversion.sh shell script. It uses the <strong>aws deploy push command</strong> to bundle the code and upload it to Amazon S3.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/pushversion.png" /></li> 
<li>Run the pushnewversion.sh script. You will see a message that tells you how to deploy the code with the AWS command line interpreter, but we will use the AWS CodeDeploy console to do this instead.</li> 
<li>Open the AWS CodeDeploy console at <a href="https://console.aws.amazon.com/codedeploy">https://console.aws.amazon.com/codedeploy</a>.</li> 
<li>Click the link for bluegreen-app. If you chose a name other than the default for <strong>NamePrefix</strong>, click that name instead. Expand <strong>Revisions</strong>. You will see the revision you just pushed from the AWS CodeDeploy workstation. Click <strong>Deploy revision</strong>.</li> 
<li>On the <strong>Create deployment</strong> page, select the bluegreen-app application and the bluegreen-dg deployment group. Leave all the other default values in place, and then click <strong>Deploy</strong>. AWS CodeDeploy will provision the Auto Scaling group and instances, deploy the code, set up health checks, and redirect traffic to the new instances. This process will take a few minutes. When the deployment is complete, the deployment should appear, as shown here. AWS CodeDeploy skips the termination of the original instances because of the settings in the deployment group.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/codedeployresults.png" /></li> 
</ol> 
<p>Step 4: Review the updated environment</p> 
<ol> 
<li>Browse to the DNS name for the load balancer. You should see the new version of the application, as shown here. The application version has changed from 1 to 2, as expected.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/appversion2-v2.png" /></li> 
<li>Go to the EC2 console and display the instances. You will see four instances that have been tagged by the Auto Scaling group and launch configuration. The instances with IP addresses 10.200.11.11 and 10.200.11.192 are the ones we saw before in the blue environment. The deployment process created the instances with IP addresses 10.200.11.13 and 10.200.22 that are now part of the green environment.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/instances2-v2-1.png" /></li> 
<li>Go to the <a href="https://console.aws.amazon.com/ec2/autoscaling/home">Auto Scaling console</a>. You will see that there are now two Auto Scaling groups, each of which has two instances. The Auto Scaling group whose names begins with CodeDeploy was created during the deployment process.<img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/19/AutoScaling2-v2-1.png" /></li> 
</ol> 
<p>You have now successfully completed a blue/green deployment using AWS CodeDeploy.</p> 
<p>Step 5: Cleanup</p> 
<ol> 
<li>Return to the session on the AWS CodeDeploy workstation.</li> 
<li>Run the scripts/cleanup.sh script. This will remove the deployment bundle and shut down the Auto Scaling groups.</li> 
<li>Go to the CloudFormation console, select the stack you created, and delete it.</li> 
</ol> 
<p><strong>Conclusion</strong></p> 
<p>AWS CodeDeploy enables developers to automate code deployments to Amazon EC2 and on-premises instances. The blue/green deployment option enables release managers to create a new production environment and makes it easier to roll back to the previous environment if problems arise. For more information about AWS CodeDeploy, see the <a href="https://aws.amazon.com/documentation/codedeploy/">AWS CodeDeploy documentation</a>. You can get started in just a few clicks.</p> 
<p>Enjoy life in the blue/green world!</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Use Parameter Store to Securely Access Secrets and Config Data in AWS CodeDeploy</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Chirag Dhull</span></span> | on 
<time property="datePublished" datetime="2017-04-11T10:57:28+00:00">11 APR 2017</time> | 
<a href="https://aws.amazon.com/blogs/devops/use-parameter-store-to-securely-access-secrets-and-config-data-in-aws-codedeploy/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>AWS CodeDeploy is a service that automates code deployments to any instance, including Amazon EC2 instances and instances running on-premises. Many customers use AWS CodeDeploy to automate application deployment because it provides a uniform method for:<br /> • Updating applications across development, staging, and production environments.<br /> • Handling the complexity of updating applications and avoiding service downtime.</p> 
<p>&nbsp;<br /> Visit this <a href="https://aws.amazon.com/blogs/mt/use-parameter-store-to-securely-access-secrets-and-config-data-in-aws-codedeploy/">post</a> on the management tools blog and learn how to simplify your AWS CodeDeploy workflows by using Parameter Store to store and reference a configuration secret.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Introducing Amazon CloudWatch Logs Integration for AWS OpsWorks Stacks</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Kai Rubarth</span></span> | on 
<time property="datePublished" datetime="2017-04-10T11:59:44+00:00">10 APR 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/new-stuff/" title="View all posts in New stuff"><span property="articleSection">New stuff</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/introducing-amazon-cloudwatch-logs-integration-for-aws-opsworks-stacks/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="http://aws.amazon.com/opsworks">AWS OpsWorks Stacks</a> now supports <a href="http://aws.amazon.com/cloudwatch">Amazon CloudWatch Logs</a>. This benefits all users who want to stream their log files from OpsWorks instances to CloudWatch. This enables you to take advantage of CloudWatch Logs features such as centralized log archival, real-time monitoring of log data, or generating CloudWatch alarms. Until now, OpsWorks customers had to manually install and configure the CloudWatch Logs agent on every instance they wanted to ship log data from. Now, with the built-in CloudWatch Logs integration these features are made available with just a few clicks across all instances in a layer.</p> 
<p><span id="more-852"></span></p> 
<p>The OpsWorks CloudWatch logs integration is compatible with all Chef 11 and Chef 12 Linux stacks. To get started, simply click the new <strong>CloudWatch Logs</strong> tab in your layer settings screen. OpsWorks agent command logs, which include Chef recipe output, are enabled by default; to enable logging for custom log files, simply input an absolute path or file pattern for every log file you want shipped.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/04/07/OpsWorks-CloudWatchLogs.png" /></p> 
<p>It’s that simple. OpsWorks creates log groups and log streams for you, and starts streaming your system and application logs within a few minutes.</p> 
<p>For more information, see <a href="http://docs.aws.amazon.com/opsworks/latest/userguide/monitoring-cloudwatch-logs.html">Using Amazon CloudWatch Logs with AWS OpsWorks Stacks</a> in the <em>AWS OpsWorks User Guide</em>.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Using AWS Lambda and Amazon DynamoDB in an Automated Approach to Managing AWS CloudFormation Template Parameters and Mappings</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Anuj Sharma</span></span> | on 
<time property="datePublished" datetime="2017-04-04T10:15:33+00:00">04 APR 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/custom-lookup-using-aws-lambda-and-amazon-dynamodb/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> gives you an easy way to codify the creation and management of related AWS resources. The optional <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">Mappings</a> and <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">Parameters</a> sections of CloudFormation templates help you organize and parameterize your templates so you can quickly customize your stack. As organizations adopt Infrastructure as Code best practices, the number of mappings and parameters can quickly grow. In this blog post, we’ll discuss how <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> and <a href="https://aws.amazon.com/dynamodb/">Amazon DynamoDB</a> can be used to simplify updates, reuse, quick lookups, and reporting for these mappings and parameters.</p> 
<h3>Solution overview</h3> 
<p>There are three parts to the solution described in this post. You’ll find sample code for this solution in this <a href="https://github.com/awslabs/custom-lookup-lambda">AWS Labs GitHub repository</a>.</p> 
<ol> 
<li><strong>DynamoDB table</strong>: Used as a central location to store and update all key-value pairs used in the ‘Mappings’ and ‘Parameters’ sections of the CloudFormation template. This could be a centralized table for the whole organization, with a partition key consisting of the team name and environment (for example, development, test, production) and a sort key for the application name. For more information about the types of keys supported by DynamoDB, see <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html#HowItWorks.CoreComponents.PrimaryKey">Core Components</a> in the Amazon DynamoDB Developer Guide.</li> 
</ol> 
<p>Here is the sample data in the table. “teamname-environment” is the partition key and “appname” is the sort key.</p> 
<code class="lang-json">{
&quot;teamname-environment&quot;: &quot;team1-dev&quot;,
&quot;appname&quot;: &quot;app1&quot;,
&quot;mappings&quot;: {
&quot;elbsubnet1&quot;: &quot;subnet-123456&quot;,
&quot;elbsubnet2&quot;: &quot;subnet-234567&quot;,
&quot;appsubnet1&quot;: &quot;subnet-345678&quot;,
&quot;appsubnet2&quot;: &quot;subnet-456789&quot;,
&quot;vpc&quot;: &quot;vpc-123456&quot;,
&quot;appname&quot;:&quot;app1&quot;,
&quot;costcenter&quot;:&quot;123456&quot;,
&quot;teamname&quot;:&quot;team1&quot;,
&quot;environment&quot;:&quot;dev&quot;,
&quot;certificate&quot;:&quot;arn-123456qwertyasdfgh&quot;,
&quot;compliancetype&quot;:&quot;pci&quot;,
&quot;amiid&quot;:&quot;ami-123456&quot;,
&quot;region&quot;:&quot;us-west-1&quot;,
&quot;publichostedzoneid&quot;:&quot;Z234asdf1234asdf&quot;,
&quot;privatehostedzoneid&quot;:&quot;Z345SDFGCVHD123&quot;,
&quot;hostedzonename&quot;:&quot;demo.internal&quot;
}
}
</code> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/29/Screen-Shot-2017-03-26-at-3.43.48-PM.png" /><br /> &nbsp;</p> 
<ol start="2"> 
<li><strong>Lambda function:</strong> Accepts the inputs of the primary keys, looks up the DynamoDB table, and returns all the key-value data.</li> 
<li><strong>Custom lookup resource:</strong> Makes a call to the Lambda function, with the inputs of primary keys (accepted by the Lambda function) and retrieves the key-value data. All CloudFormation templates can duplicate this&nbsp;generic custom resource.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/29/custom-lookup-workflow.png" /></p> 
<p>&nbsp;</p> 
<p>The diagram shows the interaction of services and resources in this solution.</p> 
<ol> 
<li>Users create a DynamoDB table and, using the DynamoDB console, AWS SDK, or AWS CLI, insert the mappings, parameters, and key-value data.</li> 
<li>CloudFormation templates have a custom resource, which calls a Lambda function. The combination of team name and application environment (“teamname-environment”) is the partition key input. Application Name (“appname”) is the sort key input to the Lambda function.</li> 
<li>The Lambda function queries the DynamoDB table based on the inputs.</li> 
<li>DynamoDB responds to the Lambda function with the results.</li> 
<li>The Lambda function responds to the custom resource in the CloudFormation stack, with the key-value data.</li> 
<li>The key-value data retrieved by the custom resource is then used by other resources in the stack using <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html">GetAtt Intrinsic function</a>.</li> 
</ol> 
<p>&nbsp;</p> 
<b>Using the sample code</b> 
<p>To use the sample code for this solution, follow these steps:</p> 
<ol> 
<li>Clone the repository.</li> 
</ol> 
<code class="lang-bash">git clone https://github.com/awslabs/custom-lookup-lambda.git
cd custom-lookup-lambda
</code> 
<ol start="2"> 
<li>The values in the sample-mappings.json file will be inserted into DynamoDB. Each record in sample-mappings.json corresponds to an item in DynamoDB. The mappings object contains the mapping.</li> 
<li>This solution uses Python as a <a href="http://docs.aws.amazon.com/lambda/latest/dg/python-programming-model-handler-types.html">programming model</a> for AWS Lambda. If you haven’t set up your local development environment for Python, follow <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create-deploy-python-common-steps.html#python-common-setup-venv">these steps</a>, and then install the <a href="https://pypi.python.org/pypi/awscli/1.11.63">awscli python package</a>.</li> 
</ol> 
<code class="lang-bash">pip install awscli
</code> 
<ol start="4"> 
<li>To prepare your access keys or assume-role to make calls to AWS, configure the AWS Command Line Interface as described <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">here</a>. The IAM user or the assumed role used to make API calls must have, at minimum, <a href="https://github.com/awslabs/custom-lookup-lambda/blob/master/sample-user-policy.json">this access</a>. You can attach <a href="https://github.com/awslabs/custom-lookup-lambda/blob/master/sample-user-policy.json">this policy</a> to the IAM user or IAM group if you are using access keys, or to the IAM role if you are assuming a role. For more information, see <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-using.html#attach-managed-policy-console">Attaching Managed Policies</a> in the IAM User Guide.</li> 
<li>Run insertrecord.sh to create the DynamoDB table named custom-lookup and insert the items in sample-mappings.json.</li> 
</ol> 
<code class="lang-bash">./insertrecord.sh</code> 
<p>This script does the following:</p> 
<li>Installs <a href="https://pypi.python.org/pypi/boto3">boto3</a> and <a href="https://pypi.python.org/pypi/requests">requests</a> Python packages through <a href="https://pypi.python.org/pypi/pip">pip</a>.</li> 
<li>Executes the Python script to create the DynamoDB table (custom-lookup) and puts the data in sample-mappings.json.</li> 
<ol start="6"> 
<li>Run deployer.sh to package and create the Lambda function.</li> 
</ol> 
<code class="lang-bash">./deployer.sh</code> 
<p>This script does the following:</p> 
<li>Installs <a href="https://pypi.python.org/pypi/boto3">boto3</a> and <a href="https://pypi.python.org/pypi/requests">requests</a> Python packages through <a href="https://pypi.python.org/pypi/pip">pip</a>.</li> 
<li>Uses <a href="http://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html">CloudFormation package cli</a> to package the Lambda function (as coded in lambda-cloudformation.yaml).</li> 
<li>Uploads the packaged code to the S3 bucket (as prompted when you execute this script).</li> 
<li>Uses <a href="http://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/index.html">CloudFormation deploy cli </a>to deploy the Lambda function. lambda-cloudformation.yaml also <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-exports.html">exports</a> the Lambda function’s<a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html"> Amazon Resource Name (ARN)</a> using <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html#w1ab2c19c12d587c13">GetAtt intrinsic function</a>, which can be <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html">imported</a> by other stacks.</li> 
<ol start="7"> 
<li>Using sample-stack.yaml, create a stack that makes a call to the Lambda function created in step 6. The function queries the DynamoDB table and produces as output the values corresponding to team1-dev and app1.</li> 
</ol> 
<code class="lang-bash">aws cloudformation deploy --template-file sample-stack.yaml --stack-name sample-stack
</code> 
<ol start="8"> 
<li>Examine the output in the AWS CloudFormation console. You should see the values retrieved from the DynamoDB table. The Fn::GetAtt function allows you to use the values retrieved by the custom resource Lambda function.</li> 
</ol> 
<p>For example, if the custom resource Lambda function is called using resource name as CUSTOMLOOKUP in the sample-stack, the value of key=amiid will be used in the stack using !GetAtt CUSTOMLOOKUP.amiid. Likewise, the value of key=vpc will be used in the stack using !GetAtt CUSTOMLOOKUP.vpc and so on.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/29/Screen-Shot-2017-03-26-at-2.53.28-PM.png" /></p> 
<b>Conclusion</b> 
<p>In this blog post, we showed how to use an AWS CloudFormation custom resource backed by an AWS Lambda function to query Amazon DynamoDB to retrieve key-value data, thereby replacing the Mappings and Parameter sections of the CloudFormation template. This solution provides a more automated approach to managing template parameters and mappings. You can use the DynamoDB table to simplify updates, reuse, quick lookups, and reporting for these mappings and parameters.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Implementing DevSecOps Using AWS CodePipeline</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Ramesh Adabala</span></span> | on 
<time property="datePublished" datetime="2017-03-23T10:57:15+00:00">23 MAR 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/implementing-devsecops-using-aws-codepipeline/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p><a href="https://aws.amazon.com/devops/what-is-devops/" target="_blank">DevOps </a>is a combination of cultural philosophies, practices, and tools that emphasizes collaboration and communication between software developers and IT infrastructure teams while automating an organization’s ability to deliver applications and services rapidly, frequently, and more reliably.</p> 
<p><a href="https://aws.amazon.com/getting-started/projects/set-up-ci-cd-pipeline/" target="_blank">CI/CD</a> stands for continuous integration and continuous deployment. These concepts represent everything related to automation of application development and the deployment pipeline — from the moment a developer adds a change to a central repository until that code winds up in production.</p> 
<p>DevSecOps covers security of and in the CI/CD pipeline, including <a href="https://d0.awsstatic.com/whitepapers/compliance/Intro_to_Security_by_Design.pdf" target="_blank">automating security operations and auditing</a>. The goals of DevSecOps are to:</p> 
<li>Embed security knowledge into DevOps teams so that they can secure the pipelines they design and automate.</li> 
<li>Embed application development knowledge and automated tools and processes into security teams so that they can provide security at scale in the cloud.</li> 
<p>The <a href="https://d0.awsstatic.com/whitepapers/AWS_CAF_Security_Perspective.pdf" target="_blank">Security Cloud Adoption Framework (CAF) whitepaper</a> provides prescriptive controls to improve the security posture of your AWS accounts. These controls are in line with a DevOps blog post published last year about the <a href="https://aws.amazon.com/blogs/devops/it-governance-in-a-dynamic-devops-environment/" target="_blank">control-monitor-fix governance model</a>.</p> 
<p>Security CAF controls are grouped into four categories:</p> 
<li><strong>Directive</strong>: controls establish the governance, risk, and compliance models on AWS.</li> 
<li><strong>Preventive</strong>: controls protect your workloads and mitigate threats and vulnerabilities.</li> 
<li><strong>Detective</strong>: controls provide full visibility and transparency over the operation of your deployments in AWS.</li> 
<li><strong>Responsive</strong>: controls drive remediation of potential deviations from your security baselines.</li> 
<p>To embed the DevSecOps discipline in the enterprise, AWS customers are automating CAF controls using a combination of AWS and third-party solutions.</p> 
<li>AWS solutions: <a href="http://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudwatch-alarms-for-cloudtrail.html" target="_blank">Amazon Cloudwatch Alarms</a>,&nbsp; <a href="https://aws.amazon.com/cloudtrail/" target="_blank">AWS CloudTrail</a>,&nbsp; <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" target="_blank">Amazon CloudWatch Events</a>, <a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a>, <a href="https://aws.amazon.com/config/" target="_blank">AWS Config</a></li> 
<li>Third-party solutions: <a href="https://aws.amazon.com/marketplace/seller-profile?id=59a38c69-0c0e-490c-8427-e4c4ed1b4371" target="_blank">Dome9</a>, <a href="https://aws.amazon.com/marketplace/seller-profile?id=fad58384-1745-4c81-a502-a081c858ea67" target="_blank">Evident.IO</a></li> 
<p>In this blog post, I will show you how to use a CI/CD pipeline to automate preventive and detective security controls. I’ll use an example that show how you can take the creation of a simple security group through the CI/CD pipeline stages and enforce security CAF controls at various stages of the deployment. I’ll use <a href="https://aws.amazon.com/codepipeline/" target="_blank">AWS CodePipeline</a> to orchestrate the steps in a continuous delivery pipeline.</p> 
<p>These resources are being used in this example:</p> 
<li>An <a href="https://aws.amazon.com/cloudformation/" target="_blank">AWS CloudFormation</a> template to create the demo pipeline.</li> 
<li>A <a href="https://aws.amazon.com/lambda/" target="_blank">Lambda </a>function to perform the static code analysis of the CloudFormation template.</li> 
<li>A <a href="https://aws.amazon.com/lambda/" target="_blank">Lambda </a>function to perform dynamic stack validation for the security groups in scope.</li> 
<li>An <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/Welcome.html" target="_blank">S3 bucket</a> as the sample code repository.</li> 
<li>An <a href="https://aws.amazon.com/cloudformation/" target="_blank">AWS CloudFormation</a> source template file to create the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html" target="_blank">security groups</a>.</li> 
<li>Two <a href="https://aws.amazon.com/vpc/" target="_blank">VPCs</a> to deploy the test and production security groups.</li> 
<p>These are the high-level security checks enforced by the pipeline:</p> 
<li>During the Source stage, static code analysis for any open security groups. The pipeline will fail if there are any violations.</li> 
<li>During the Test stage, dynamic analysis to make sure port 22 (SSH) is open only to the approved IP CIDR range. The pipeline will fail if there are any violations.</li> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/23/demo_pipeline1.png" /></p> 
<p>&nbsp;</p> 
<p>These are the pipeline stages:</p> 
<p>1. <strong>Source stage</strong>: In this example, the pipeline gets the CloudFormation code that creates the security group from S3, the code repository service.</p> 
<p>This stage passes the CloudFormation template and pipeline name to a Lambda function, CFNValidateLambda. This function performs the static code analysis. It uses the regular expression language to find patterns and identify security group policy violations. If it finds violations, then Lambda fails the pipeline and includes the violation details.</p> 
<p>Here is the regular expression that Lambda function using for static code analysis of the open SSH port:</p> 
<code class="lang-json">&quot;^.*Ingress.*(([fF]rom[pP]ort|[tT]o[pP]ort).\s*:\s*u?.(22).*[cC]idr[iI]p.\s*:\s*u?.((0\.){3}0\/0)|[cC]idr[iI]p.\s*:\s*u?.((0\.){3}0\/0).*([fF]rom[pP]ort|[tT]o[pP]ort).\s*:\s*u?.(22))&quot;</code> 
<p>2. <strong>Test stage</strong>: After the static code analysis is completed successfully, the pipeline executes the following steps:</p> 
<p>a. <strong>Create stack</strong>: This step creates the stack in the test VPC, as described in the test configuration.</p> 
<p>b. <strong>Stack validation</strong>: This step triggers the StackValidationLambda Lambda function. It passes the stack name and pipeline name in the event parameters. Lambda validates the security group for the following security controls. If it finds violations, then Lambda deletes the stack, stops the pipeline, and returns an error message.</p> 
<p>The following is the sample Python code used by AWS Lambda to check if the SSH port is open to the approved IP CIDR range (in this example, 72.21.196.67/32):</p> 
<code class="lang-python">for n in regions:
client = boto3.client('ec2', region_name=n)
response = client.describe_security_groups(
Filters=[{'Name': 'tag:aws:cloudformation:stack-name', 'Values': [stackName]}])
for m in response['SecurityGroups']:
if &quot;72.21.196.67/32&quot; not in str(m['IpPermissions']):
for o in m['IpPermissions']:
try:
if int(o['FromPort']) &lt;= 22 &lt;= int(o['ToPort']):
result = False
failReason = &quot;Found Security Group with port 22 open to the wrong source IP range&quot;
offenders.append(str(m['GroupId']))
except:
if str(o['IpProtocol']) == &quot;-1&quot;:
result = False
failReason = &quot;Found Security Group with port 22 open to the wrong source IP range&quot;
offenders.append(str(n) + &quot; : &quot; + str(m['GroupId']))
</code> 
<p>c. <strong>Approve test stack</strong>: This step creates a manual approval task for stack review. This step could be eliminated for automated deployments.</p> 
<p>d. <strong>Delete test stack</strong>: After all the stack validations are successfully completed, this step deletes the stack in the test environment to avoid unnecessary costs.</p> 
<p>3. <strong>Production stage</strong>: After the static and dynamic security checks are completed successfully, this stage creates the stack in the production VPC using the production configuration supplied in the template.</p> 
<p>a. <strong>Create change set</strong>: This step creates the change set for the resources in the scope.</p> 
<p>b. <strong>Execute change set</strong>: This step executes the change set and creates/updates the security group in the production VPC.</p> 
<p><strong>&nbsp;</strong></p> 
<h3>Source code and CloudFormation template</h3> 
<p>You’ll find the source code at <a href="https://github.com/awslabs/automating-governance-sample/tree/master/DevSecOps-Blog-Code">https://github.com/awslabs/automating-governance-sample/tree/master/DevSecOps-Blog-Code</a></p> 
<p><a href="https://github.com/awslabs/automating-governance-sample/blob/master/DevSecOps-Blog-Code/basic-sg-3-cfn.json">basic-sg-3-cfn.json</a> creates the pipeline in AWS CodePipeline with all the stages previously described. It also creates the static code analysis and stack validation Lambda functions.</p> 
<p>The CloudFormation template points to a shared S3 bucket. The codepipeline-lambda.zip file contains the Lambda functions. Before you run the template, upload the zip file to your S3 bucket and then update the CloudFormation template to point to your S3 bucket location.</p> 
<p>The CloudFormation template uses the codepipe-single-sg.zip file, which contains the sample security group and test and production configurations. Update these configurations with your VPC details, and then upload the modified zip file to your S3 bucket.</p> 
<p>Update these parts of the code to point to your S3 bucket:</p> 
<code class="lang-json"> &quot;S3Bucket&quot;: {
&quot;Default&quot;: &quot;codepipeline-devsecops-demo&quot;,
&quot;Description&quot;: &quot;The name of the S3 bucket that contains the source artifact, which must be in the same region as this stack&quot;,
&quot;Type&quot;: &quot;String&quot;
},
&quot;SourceS3Key&quot;: {
&quot;Default&quot;: &quot;codepipe-single-sg.zip&quot;,
&quot;Description&quot;: &quot;The file name of the source artifact, such as myfolder/myartifact.zip&quot;,
&quot;Type&quot;: &quot;String&quot;
},
&quot;LambdaS3Key&quot;: {
&quot;Default&quot;: &quot;codepipeline-lambda.zip&quot;,
&quot;Description&quot;: &quot;The file name of the source artifact of the Lambda code, such as myfolder/myartifact.zip&quot;,
&quot;Type&quot;: &quot;String&quot;
},
&quot;OutputS3Bucket&quot;: {
&quot;Default&quot;: &quot;codepipeline-devsecops-demo&quot;,
&quot;Description&quot;: &quot;The name of the output S3 bucket that contains the processed artifact, which must be in the same region as this stack&quot;,
&quot;Type&quot;: &quot;String&quot;
},</code> 
<p>After the stack is created, AWS CodePipeline executes the pipeline and starts deploying the sample CloudFormation template. In the default template, security groups have wide-open ports (0.0.0.0/0), so the pipeline execution will fail. Update the CloudFormation template in codepipe-single-sg.zip with more restrictive ports and then upload the modified zip file to S3 bucket. Open the AWS CodePipeline console, and choose the <strong>Release Change</strong> button. This time the pipeline will successfully create the security groups.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/23/demo_pipeline2.png" /></p> 
<p>You could expand the security checks in the pipeline to include other AWS resources, not just security groups. The following table shows the sample controls you could enforce in the pipeline using the static and dynamic analysis Lambda functions.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/23/demo_pipeline3.png">Developer Tools forum</a>.</p> 
</article> 
<article class="blog-post" vocab="http://schema.org/" typeof="TechArticle"> 
<meta property="inLanguage" content="en-US" /> 
<b class="lb-b blog-post-title" property="name headline">Replicating and Automating Sync-Ups for a Repository with AWS CodeCommit</b> 
<footer class="blog-post-meta" data-lb-comp="aws-blog:share-dialog">
by 
<span property="author" typeof="Person"><span property="name">Cherry Zhou</span></span> | on 
<time property="datePublished" datetime="2017-03-13T17:01:41+00:00">13 MAR 2017</time> | in 
<span class="blog-post-categories"><a href="https://aws.amazon.com/blogs/devops/category/how-to/" title="View all posts in How-To*"><span property="articleSection">How-To*</span></a></span> | 
<a href="https://aws.amazon.com/blogs/devops/replicating-and-automating-sync-ups-for-a-repository-with-aws-codecommit/" property="url">Permalink</a> | 
<a href="#" role="button" data-share-dialog-toggle=""><span class="span icon-share"></span>&nbsp;Share</a> 
</footer> 
<p>by Chenwei (Cherry) Zhou, Software Development Engineer</p> 
<hr /> 
<p>&nbsp;</p> 
<p>Many of our customers have expressed interest in the following scenarios:</p> 
<li>Backing up or replicating an AWS CodeCommit repository to another AWS region.</li> 
<li>Automatically backing up repositories currently hosted on other services (for example, GitHub or BitBucket) to AWS CodeCommit.</li> 
<p>In this blog post, we’ll show you how to automate the replication of a source repository to a repository in AWS CodeCommit. Your source repository could be another AWS CodeCommit repository, a local repository, or a repository hosted on other Git services.</p> 
<p>To replicate your repository, you’ll first need to set up a repository in AWS CodeCommit to use as your backup/replica repository. After replicating the contents in your source repository to the backup repository, we’ll demonstrate how you can set up a scheduled job to periodically sync up your source repository with the backup/replica.</p> 
<p><span id="more-705"></span></p> 
<p><strong>Where do I host this?</strong></p> 
<p>You can host your local repository and schedule your task on your own machine or on an Amazon EC2 instance. For an example of how to set up an EC2 instance for access to an AWS CodeCommit repository, including a sample AWS CloudFormation template for launching the instance, see <a href="http://docs.aws.amazon.com/devops/latest/gsg/setup-codecommit-launch-instance.html">Launch an Amazon EC2 Instance to Access the AWS CodeCommit Repository</a> in the AWS for DevOps Guide.</p> 
<p>&nbsp;</p> 
<p><strong>Part 1: Set Up a Replica Repository</strong></p> 
<p>In this section, we’ll create an AWS CodeCommit repository and replicate your source repository to it.</p> 
<ol> 
<li>If you haven’t already done so, <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/setting-up.html">set up for AWS CodeCommit</a>. Then follow the steps to <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/how-to-create-repository.html">create a CodeCommit repository</a> in the region of your choice. Choose a name that will help you remember that this repository is a replica or backup repository. For example, you could create a repository in the US East (Ohio) region and name it <em><code class="lang-git">MyReplicaRepo</code></em>. This is the name and region we’ll use in this post.</li> 
<li>Use the <code class="lang-git">git clone --mirror</code> command to clone the source repository, including the directory where you want to create the local repo, to your local computer. You are not cloning the repository you just created in AWS CodeCommit. You are cloning the repository you want to replicate or back up to that AWS CodeCommit repository. For example, to clone a sample application created for AWS demonstration purposes and hosted on GitHub <em>(https://github.com/awslabs/aws-demo-php-simple-app.git)</em> to a local repo in a directory named <em><code class="lang-git">my-repo-replica</code></em>:</li> 
</ol> 
git clone --mirror https://github.com/awslabs/aws-demo-php-simple-app.git <span style="color: #c24040"><em>my-repo-replica</em></span> 
<p><strong>IMPORTANT</strong></p> 
<li>DO NOT use your working directory as the local clone repository. Your work-in-progress commits would also be pushed for backup.</li> 
<li>DO NOT make local changes to this local repository. It should be used for sync-up operations only.</li> 
<li>DO NOT manually push any changes to this replica repository. It will cause conflicts later when your scheduled job pushes changes in the source repository. Treat it as a read-only repository, and push all of your development changes to your source repository.</li> 
<ol start="3"> 
<li>Change directories to the directory where you made the clone:</li> 
</ol> 
cd <span style="color: #c24040"><em>my-repo-replica</em></span> 
<ol start="4"> 
<li>Use the&nbsp;<strong><code class="lang-git">git remote add</code> </strong><em><code class="lang-git">RemoteName RemoteRepositoryURL</code></em> command to add the AWS CodeCommit repository you created as a remote repository for the local repo. Use an appropriate nickname, such as <em><code class="lang-git">sync</code></em>. (Because this is a mirror, the default nickname, <strong>origin</strong>, will already be in use.) For example, to add your AWS CodeCommit repository&nbsp;<em><code class="lang-git">MyReplicaRepo</code></em> as a remote for&nbsp;<em><code class="lang-git">my-repo-replica</code></em> with the nickname <em>sync</em>:</li> 
</ol> 
git remote add <span style="color: #c24040"><em>sync</em></span> ssh://git-codecommit.us-east-2.amazonaws.com/v1/repos/<span style="color: #c24040"><em>MyReplicaRepo</em></span> 
<p style="padding-left: 30px">When you push large repositories, consider using SSH instead of HTTPS. When you push a large change, a large number of changes, or a large repository, long-running HTTPS connections are often terminated prematurely due to networking issues or firewall settings. For more information about setting up AWS CodeCommit for SSH, see <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-ssh-unixes.html">For SSH Connections on Linux, macOS, or Unix</a> or <a href="http://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-ssh-windows.html">For SSH Connections on Windows</a>.</p> 
<p style="padding-left: 30px"><strong>Tip</strong></p> 
<p style="padding-left: 30px">Use the git remote show command to review the list of remotes set for your local repo.</p> 
<ol start="5"> 
<li>Run the <code class="lang-git">git push</code> <em><code class="lang-git">sync</code></em> <code class="lang-git">--mirror</code> command to push to your replica repository.</li> 
</ol> 
<li>If you named your remote for the replica repository something else, replace&nbsp;<em><code class="lang-git">sync</code></em> with your remote name.</li> 
<li>The&nbsp;<code class="lang-git">--mirror</code> option specifies that all refs under <strong>refs/</strong> (which includes, but is not limited to, <strong>refs/heads/</strong>, <strong>refs/remotes/</strong>, and <strong>refs/tags/</strong>) will be mirrored to the remote repository. If you only want to push branches and commits, but don’t care if you push other references such as tags, you can use the <code class="lang-git">--all</code> option instead.</li> 
<p>&nbsp;</p> 
<p>Your replica repository is now ready for sync-up operations. To do a manual sync, run <code class="lang-git">git pull</code> to pull from your original repository, and then run <code class="lang-git">git push</code>&nbsp;<em><code class="lang-git">sync</code></em> <code class="lang-git">--mirror</code> to push to the replica repository. Again, do not push any local changes to your replica repository at any time.</p> 
<p>&nbsp;</p> 
<p><strong>Part 2: Create a Periodic Sync Job</strong></p> 
<p>You can use a number of tools to set up an automated sync job. In this section, we’ll briefly cover four common tools: a cron job (Linux), a task in Windows Task Scheduler (Windows), a launchd instance (macOS), and, for those users who already have a Jenkins server set up, a Freestyle project with build triggers. Feel free to use whatever tools are best for you.</p> 
<p><strong>Note</strong></p> 
<p>Some hosted repositories offer options for syncing repositories, such as Git hooks, notifications, and other triggers. To learn more about those options, consult the documentation for your source repository system.</p> 
<p>&nbsp;</p> 
<p>All of the following approaches rely on commands that pull the latest changes from the source repository to your local clone repo, and then mirror those changes to your AWS CodeCommit repository. They can be summed up as follows:</p> 
cd <span style="color: #c24040"><em>/path/to/your/local/repo </em></span>git pull
git push <span style="color: #c24040"><em>sync</em></span> --mirror 
<p>Where and how you save and schedule these commands depends on your operating system and tool(s). We’ve included just a few options/examples from a variety of approaches.</p> 
<p>&nbsp;</p> 
<p><strong>In Linux:</strong></p> 
<ol> 
<li>At the terminal, run the crontab -e command to edit your crontab file in your default editor.</li> 
<li>Add a line for a new cron job that will change directories to your local clone repo, pull from your source repository, and mirror any changes to your AWS CodeCommit repository on the schedule you specify. For example, to run a daily job at 2:45 A.M. for a local repo named&nbsp;<em><code class="lang-git">my-repo-replica</code></em> in the ~/tmp directory where you nicknamed your remote (the AWS CodeCommit repository) <em><code class="lang-ggit">sync</code></em>, your new line might look like this:</li> 
</ol> 
45 2 * * * cd <em>~</em>/tmp/<span style="color: #c24040"><em>my-repo-replica</em></span> &amp;&amp; git pull &amp;&amp; git push <span style="color: #c24040"><em>sync</em></span> --mirror 
<ol start="3"> 
<li>Save the crontab file and exit your editor.</li> 
</ol> 
<p>&nbsp;</p> 
<p><strong>In Windows:</strong></p> 
<ol> 
<li>Create a batch file that contains the command to change directories to your local clone repo, pull from your source repository, and mirror any changes up to your AWS CodeCommit repository. For example, if you created your local repo&nbsp;<em><code class="lang-git">my-repo-replica</code></em> in a c:\temp directory, and you nicknamed your remote (the AWS CodeCommit repository) <em><code class="lang-ggit">sync</code></em>, your file might look like this:</li> 
</ol> 
cd /d c:\temp\<em><span style="color: #c24040">my-repo-replica</span>
</em>git pull
git push <span style="color: #c24040"><em>sync</em></span> --mirror 
<ol start="2"> 
<li>Save the batch file with a name like <em><code class="lang-git">my-repo-backup.bat</code></em>.</li> 
<li>Open Task Scheduler. (Not sure how? The simplest way is to open a command line and run <strong>msc</strong>.)</li> 
<li>In <strong>Actions</strong>, choose <strong>Create Basic Task</strong>, and then follow the steps in the wizard.</li> 
</ol> 
<p><strong>&nbsp;</strong></p> 
<p><strong>In macOS:</strong></p> 
<ol> 
<li>Create a shell script that contains the command to change directories to your local clone repo, pull from your source repository, and mirror any changes up to your AWS CodeCommit repository. For example, if you created your local repo&nbsp;<em><code class="lang-git">my-repo-replica</code></em> in a ~/Documents directory, and you nicknamed your remote (the AWS CodeCommit repository) <em><code class="lang-ggit">sync</code></em>, your file might look like this:</li> 
</ol> 
cd ~/Documents/<em><span style="color: #c24040">my-repo-replica</span>
</em>git pull
git push <span style="color: #c24040"><em>sync</em></span> --mirror 
<ol start="2"> 
<li>Save the shell script with a name like <em><code class="lang-git">my-repo-backup.sh</code></em>.</li> 
<li>Create a <strong>launchd</strong> property list file that runs the shell script on the schedule you specify. For example, if you stored&nbsp;<em><code class="lang-git">my-repo-backup.sh</code></em> in ~/Documents, to run the script daily at 2:45 A.M., your plist file might look like this:</li> 
</ol> 
<code class="lang-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
&lt;plist version=&quot;1.0&quot;&gt;
&lt;dict&gt;
&lt;key&gt;Label&lt;/key&gt;
&lt;string&gt;com.example.codecommit.backup&lt;/string&gt;
&lt;key&gt;ProgramArguments&lt;/key&gt;
&lt;array&gt;
&lt;string&gt;~/Documents/<em>my-repo-backup.sh</em>&lt;/string&gt;
&lt;/array&gt;
&lt;key&gt;StartCalendarInterval&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;Minute&lt;/key&gt;
&lt;integer&gt;45&lt;/integer&gt;
&lt;key&gt;Hour&lt;/key&gt;
&lt;integer&gt;2&lt;/integer&gt;
&lt;/dict&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code> 
<ol start="4"> 
<li>Save your plist file in ~/Library/LaunchAgents, /Library/LaunchAgents, or /Library/LaunchDaemons folder, depending on the definition you want for the job.</li> 
<li>Run the <strong>launtchctl</strong> command to load your job. For example, if you want to load a plist file named&nbsp;<em><code class="lang-git">codecommit.sync.plist</code></em> in ~/Library/LaunchAgents, your command might look like this:</li> 
</ol> 
launchctl load ~/Library/LaunchAgents/<span style="color: #c24040"><em>codecommit.sync.plist</em></span> 
<p>&nbsp;</p> 
<p><strong>For Jenkins:</strong></p> 
<ol> 
<li>Open Jenkins.</li> 
<li>Create a new job as a Freestyle project.</li> 
</ol> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/09/New-Item.png" /></p> 
<ol start="3"> 
<li>In the <strong>Build Triggers</strong> section, select <strong>Build periodically</strong>, and set up a schedule for the task. Jenkins uses cron expressions to run periodic tasks. For more information, see the <a href="https://github.com/jenkinsci/jenkins/blob/master/core/src/main/resources/hudson/triggers/TimerTrigger/help-spec.html">Jenkins documentation for the syntax of cron</a>.</li> 
</ol> 
<p style="padding-left: 30px">If you are replicating a GitHub or BitBucket repository, you can also set the task to build when the <a href="https://developer.github.com/webhooks/">Git hook</a> is triggered.</p> 
<p style="padding-left: 30px">The following example builds once a day between midnight and 1 A.M.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/09/Build-Triggers.png" /></p> 
<ol start="4"> 
<li>In the <strong>Build</strong> section, add a build step and choose <strong>Execute Windows batch command</strong> or <strong>Execute Shell</strong>. Then write a script and implement the Git operations:</li> 
</ol> 
cd <span style="color: #c24040"><em>/path/to/your/local/repo </em></span>git pull
git push <span style="color: #c24040"><em>sync</em></span> --mirror 
<p style="padding-left: 30px">Note: Jenkins may require the full path for Git.</p> 
<p style="padding-left: 30px">The following example is a Windows batch command file, with the full path for Git on the host.</p> 
<p><img width="100%" src="https://d2908q01vomqb2.cloudfront.net/7719a1c782a1ba91c031a682a0a2f8658209adbf/2017/03/09/Build.png" /></p> 
<ol start="5"> 
<li>Save the configuration for the task.</li> 
</ol> 
<p>&nbsp;</p> 
<p>Your AWS CodeCommit replica repository will now be automatically updated with any changes to your source repository as scheduled.</p> 
<p>We hope you’ve enjoyed this blog post. If you have questions or suggestions for future blog post, please leave it in the comments below or visit our <a href="https://forums.aws.amazon.com/forum.jspa?forumID=189&amp;start=0">user forum</a>!</p> 
<p>&nbsp;</p> 
</article> 
<p>
© 2017, Amazon Web Services, Inc. or its affiliates. All rights reserved.
</p>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="../aws.html">AWS</a></li>
              <li><a href="../linux.html">Linux</a></li>
              <li><a href="../docker.html">Docker</a></li>
              <li><a href="../ibmpower.html">IBM Power</a></li>
              <li><a href="blogsataws1.html">Blogs@AWS (Kindle Friendly)</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="../comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
