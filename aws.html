<!DOCTYPE html>
<html lang="en">
  <head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-593498H');</script>
<!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <meta name="msapplication-config" content="/microsoft-tile.xml" />
    <meta name="theme-color" content="#ffffff">

    <meta property="og:url" content="https://bejoycalias.github.io/aws.html" />
    <meta property="og:title" content="AWS - Bejoy's TechNotes" />
    <meta property="og:site_name" content="Bejoy's TechNotes"/>
    <meta property="og:image" content="https://bejoycalias.github.io/assets/images/og-image.png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="1200"/>
    <meta property="og:description" content="" />

    <title>AWS - Bejoy's TechNotes</title>

    <link href="/assets/stylesheets/application-832aa42c.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="/assets/javascripts/ie-compat-c141a02d.js"></script>
    <![endif]-->
    <script src="/assets/javascripts/application-ff53d307.js"></script>

    <!-- Typekit script to import Klavika font -->
    <script src="https://use.typekit.net/wxf7mfi.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100043608-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>

  <body id="page-sso" class="layout-intro page-aws">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-593498H"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <div id="header" class="navigation navbar-static-top hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <div class="navbar-header">
              <div class="navbar-brand">
                <a href="/">
                  <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="50" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet" class="logo">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

                </a>
              </div>
              <button class="navbar-toggle" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
            </div>
            <div class="buttons hidden-xs">
              <nav class="navigation-links" role="navigation">
                <ul class="main-links nav navbar-nav navbar-right">
                  <li><a href="aws.html">AWS</a></li>
                  <li><a href="linux.html">Linux</a></li>
                  <li><a href="docker.html">Docker</a></li>
                  <li><a href="ibmpower.html">IBM Power</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-overlay"></div>

<aside class="sidebar" role="navigation">
  <div class="sidebar-header">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="135.000000pt" height="42" viewbox="0 0 135.000000 45.000000" preserveaspectratio="xMidYMid meet">

<g transform="translate(0.000000,45.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path class="text" fill="#000000" d="M527 384 c-4 -4 -7 -18 -7 -31 0 -21 4 -24 28 -21 21 2 27 8 27 28 0
18 -6 26 -20 28 -12 2 -24 0 -28 -4z"></path>
<path class="text" fill="#000000" d="M1080 335 c0 -48 2 -55 20 -55 18 0 20 7 20 55 0 48 -2 55 -20 55
-18 0 -20 -7 -20 -55z"></path>
<path class="text" fill="#000000" d="M54 357 c-2 -7 -3 -69 -2 -138 l3 -124 65 -3 c90 -3 130 20 130 77 0
29 -6 44 -20 54 -20 14 -20 15 -3 45 14 25 15 34 5 56 -6 15 -23 31 -38 36
-38 15 -134 13 -140 -3z m110 -33 c19 -7 21 -45 4 -62 -7 -7 -22 -12 -35 -12
-20 0 -23 5 -23 40 0 41 13 50 54 34z m20 -130 c19 -18 19 -20 6 -45 -8 -13
-21 -19 -45 -19 -34 0 -35 1 -35 40 0 38 2 40 29 40 16 0 37 -7 45 -16z"></path>
<path class="text" fill="#000000" d="M319 271 c-23 -24 -29 -38 -29 -74 0 -25 3 -53 6 -62 20 -50 164 -64
164 -15 0 15 -7 17 -45 12 -46 -5 -75 8 -75 34 0 11 16 14 65 14 l65 0 0 35
c0 80 -92 114 -151 56z m99 -33 c3 -15 -4 -18 -37 -18 -43 0 -50 7 -29 28 18
18 62 11 66 -10z"></path>
<path class="text" fill="#000000" d="M520 184 c0 -107 -1 -116 -20 -121 -11 -3 -20 -12 -20 -19 0 -21 76
-19 84 2 3 9 6 69 6 135 l0 119 -25 0 -25 0 0 -116z"></path>
<path class="text" fill="#000000" d="M649 271 c-24 -25 -29 -37 -29 -78 1 -70 34 -103 105 -103 55 0 95
44 95 103 0 60 -7 75 -41 92 -47 25 -96 19 -130 -14z m111 -30 c25 -48 2 -111
-40 -111 -45 0 -69 80 -34 114 21 22 61 20 74 -3z"></path>
<path class="text" fill="#000000" d="M850 287 c0 -8 16 -57 36 -110 28 -76 33 -100 25 -116 -16 -28 -14
-31 18 -31 27 0 29 4 70 123 23 67 41 128 41 135 0 6 -11 12 -24 12 -21 0 -26
-8 -41 -65 -10 -36 -21 -68 -25 -70 -3 -2 -16 27 -29 66 -19 60 -25 69 -47 69
-13 0 -24 -6 -24 -13z"></path>
<path class="text" fill="#000000" d="M1192 284 c-17 -12 -22 -24 -20 -47 2 -26 10 -36 45 -52 49 -23 59
-55 17 -55 -14 0 -34 5 -45 10 -16 9 -19 7 -19 -13 0 -17 7 -27 23 -31 69 -18
117 6 117 60 0 32 -4 37 -45 55 -60 26 -62 54 -4 46 37 -5 40 -3 37 16 -2 18
-11 23 -43 25 -25 2 -49 -3 -63 -14z"></path>
</g>
</svg>

  </div>

  <ul class="nav sidebar-nav">
    <li><a href="aws.html">AWS</a></li>
    <li><a href="linux.html">Linux</a></li>
    <li><a href="docker.html">Docker</a></li>
    <li><a href="ibmpower.html">IBM Power</a></li>
  </ul>
</aside>


    <div class="container">
  <div class="row">
    <div id="docs-sidebar" class="col-sm-3 col-md-3 col-xs-12 hidden-print" role="complementary">
          <ul class="nav docs-sidenav">
      <li class="active">
        <a href="aws.html">AWS SSO with Shibboleth IdP 3.3.0 in CentOS 7, with two separate LDAP schemas for Users and Groups</a>
      </li>

      <li>
        <a href="aws-apigateway-ec2.html">Using AWS API Gateway to Power Off/On EC2 instances remotely</a>
      </li>

    </ul>

    </div>

    <div id="inner" class="col-sm-9 col-md-9 col-xs-12" role="main">
      
  <h1 id="aws-sso-with-shibboleth-idp-3-3-0-in-centos-7-with-two-separate-ldap-schemas-for-users-and-groups">
  <a name="aws-sso-with-shibboleth-idp-3-3-0-in-centos-7-with-two-separate-ldap-schemas-for-users-and-groups" class="anchor" href="#aws-sso-with-shibboleth-idp-3-3-0-in-centos-7-with-two-separate-ldap-schemas-for-users-and-groups">&raquo;</a>
  AWS SSO with Shibboleth IdP 3.3.0 in CentOS 7, with two separate LDAP schemas for Users and Groups
</h1>
<p>Below steps shows how to setup AWS single sign-on using Shibboleth IdP 3.3.0, when you have two separate LDAP schemas to store the user and group details. Usually, user&#39;s LDAP attributes would show the group memberships for that user, but in my case, my enterprise LDAP had two separate schemas to store the user information and group membership information. So, I had to create two Shibboleth attribute-resolver configurations to do the user search in one schema and group search in another, and then do a single sign-on based on that. This is an update to the already available AWS whitepaper <a href="https://aws.amazon.com/blogs/security/new-whitepaper-single-sign-on-integrating-aws-openldap-and-shibboleth/" style="color: #337ab7;">here</a> which explains the SSO setup using IdP version 2.0. I couldn&#39;t setup IdP 3.3.0 by following those steps, since it required few changes for 3.3.0. As mentioned in the IdP 2.0 whitepaper, it is assumed that the IdP will be hosted at idp.example.com. Replace this with your actual IdP FQDN. It is also assumed that you have adequate experience with Linux and AWS. I am not explaining the Shibboleth IdP concepts here, requesting you to get a fair understanding of the terms Shibboleth uses, before starting this configuration. Please refer the original AWS whitepaper if you need more clarity on the overall IdP steps described here.</p>
<p>Additional reference:<br><a href="https://wiki.shibboleth.net/confluence/display/IDP30/ApacheTomcat8
"><a href="https://wiki.shibboleth.net/confluence/display/IDP30/ApacheTomcat8">https://wiki.shibboleth.net/confluence/display/IDP30/ApacheTomcat8</a></a><br><a href="https://wiki.shibboleth.net/confluence/display/IDP30/Installation">
<a href="https://wiki.shibboleth.net/confluence/display/IDP30/Installation">https://wiki.shibboleth.net/confluence/display/IDP30/Installation</a></a><br></p>
<pre>
<p><code class="language-bash" data-lang="bash">
[root@linux1 ~]# wget -O apache-tomcat-8.0.41.tar.gz <a href="http://www.us.apache.org/dist/tomcat/tomcat-7/v8.0.41//bin/apache-tomcat-8.0.41.tar.gz">http://www.us.apache.org/dist/tomcat/tomcat-7/v8.0.41//bin/apache-tomcat-8.0.41.tar.gz</a>
[root@linux1 ~]# cd /opt; tar -xvzf /root/apache-tomcat-8.0.41.tar.gz; cd ~
[root@linux1 ~]# wget <a href="http://shibboleth.net/downloads/identity-provider/latest/shibboleth-identity-provider-3.3.0.tar.gz">http://shibboleth.net/downloads/identity-provider/latest/shibboleth-identity-provider-3.3.0.tar.gz</a>
[root@linux1 ~]# cd /opt; tar -xvzf ~/shibboleth-identity-provider-3.3.0.tar.gz ; cd ~
[root@linux1 ~]# yum install -y java-1.8.0-openjdk-devel
[root@linux1 ~]# export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.121-0.b13.el7_3.x86_64/
[root@linux1 ~]# cd /opt/shibboleth-identity-provider-3.3.0/bin/
[root@linux1 bin]# ./install.sh
Source (Distribution) Directory (press <enter> to accept default: [/opt/shibboleth-identity-provider-3.3.0]
Installation Directory: [/opt/shibboleth-idp]
Hostname: [centos7.localdomain]
idp.example.com
SAML EntityID: [<a href="https://idp.example.com/idp/shibboleth">https://idp.example.com/idp/shibboleth</a>]
Attribute Scope: [localdomain]
Backchannel PKCS12 Password: passw0rd
Re-enter password: passw0rd
Cookie Encryption Key Password: passw0rd
Re-enter password: passw0rd
Warning: /opt/shibboleth-idp/bin does not exist.
Warning: /opt/shibboleth-idp/dist does not exist.
Warning: /opt/shibboleth-idp/doc does not exist.
Warning: /opt/shibboleth-idp/system does not exist.
Warning: /opt/shibboleth-idp/webapp does not exist.
Generating Signing Key, CN = idp.example.com URI = <a href="https://idp.example.com/idp/shibboleth">https://idp.example.com/idp/shibboleth</a> ...
...done
Creating Encryption Key, CN = idp.example.com URI = <a href="https://idp.example.com/idp/shibboleth">https://idp.example.com/idp/shibboleth</a> ...
...done
Creating Backchannel keystore, CN = idp.example.com URI = <a href="https://idp.example.com/idp/shibboleth">https://idp.example.com/idp/shibboleth</a> ...
...done
Creating cookie encryption key files...
...done
Rebuilding /opt/shibboleth-idp/war/idp.war ...
...done
BUILD SUCCESSFUL
Total time: 1 minute 5 seconds
[root@linux1 ~]# cd /opt/apache-tomcat-8.0.41/conf
[root@linux1 conf]# vi server.xml
<b><i># Comment out the section for 8080, replace 8443 as 443, add key store details for 443</i></b>
<span style="color: blue;">
&lt;Connector port=&quot;443&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;
           maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; scheme=&quot;https&quot; secure=&quot;true&quot;
           clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot;
            keystoreFile=&quot;/opt/shibboleth-idp/credentials/idp-backchannel.p12&quot;
            keystorePass=&quot;passw0rd&quot;
            keystoreType=&quot;PKCS12&quot;
    /&gt;
&lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;443&quot; /&gt;
</span>
[root@linux1 bin]# vi /opt/apache-tomcat-8.0.41/conf/tomcat-users.xml
<span style="color: blue;">
&lt;user username=&quot;root&quot; password=&quot;passw0rd&quot; roles=&quot;manager-gui&quot;/&gt;
</span>
[root@linux1 conf]# mkdir -p Catalina/localhost/
[root@linux1 conf]# cd Catalina/localhost/
[root@linux1 localhost]# vi idp.xml
<span style="color: blue;">
&lt;Context docBase=&quot;/opt/shibboleth-idp/war/idp.war&quot;
privileged=&quot;true&quot;
antiResourceLocking=&quot;false&quot;
swallowOutput=&quot;true&quot; /&gt;
</span>
[root@linux1 # cd /opt/shibboleth-idp/edit-webapp/WEB-INF/lib
[root@linux1 lib]# wget <a href="https://build.shibboleth.net/nexus/service/local/repositories/thirdparty/content/javax/servlet/jstl/1.2/jstl-1.2.jar">https://build.shibboleth.net/nexus/service/local/repositories/thirdparty/content/javax/servlet/jstl/1.2/jstl-1.2.jar</a>
[root@linux1 lib]# cp /opt/shibboleth-idp/webapp/WEB-INF/web.xml /opt/shibboleth-idp/edit-webapp/WEB-INF/
[root@linux1 lib]# vi /opt/shibboleth-idp/edit-webapp/WEB-INF/web.xml
<b><i># Add this in the beginning</i></b>
<span style="color: blue;">
&lt;context-param&gt;
    &lt;param-name&gt;idp.home&lt;/param-name&gt;
    &lt;param-value&gt;/opt/shibboleth-idp&lt;/param-value&gt;
&lt;/context-param&gt;
</span>
<b><i># Add any organization logos to /opt/shibboleth-idp/edit-webapp/images, smaller size logo is preferred. Optionally, edit the file /opt/shibboleth-idp/system/messages/messages.properties to replace the values for below variables, and any more values as needed. These values are used in the IdP login screens.</i></b><br>
[root@linux1 lib]# vi /opt/shibboleth-idp/system/messages/messages.properties
<span style="color: blue;">
idp.login.username = Enter Your E-Mail
idp.login.password = Enter Your Password
idp.url.password.reset = <a href="https://your.idmanager.site/password">https://your.idmanager.site/password</a>
idp.url.helpdesk = <a href="https://your.ticketing.site">https://your.ticketing.site</a>
idp.title = Bejoy AWS SSO
idp.title.suffix = Error
idp.logo = /images/logo.jpg
idp.logo.alt-text = Logo
idp.message = An unidentified error occurred.
idp.footer = Bejoy AWS SSO
root.title = Bejoy AWS SSO
root.message = &lt;a href=&quot;/idp/profile/SAML2/Unsolicited/SSO?providerId=urn:amazon:webservices&quot;&gt;Click here to login to AWS using intranet ID.&lt;/a&gt;
root.footer = Bejoy AWS SSO
</span>
[root@linux1 lib]# cd /opt/shibboleth-idp/bin/
[root@linux1 bin]# ./build.sh
<b><i># Edit /opt/apache-tomcat-8.0.41/webapps/ROOT/index.jsp to replace the entire contents with this single line, so that tomcat will redirect you to the SSO login page when you open tomcat home page.</i></b>
[root@linux1 bin]# vi /opt/apache-tomcat-8.0.41/webapps/ROOT/index.jsp
<span style="color: blue;">
&lt;%
response.sendRedirect(&quot;/idp/profile/SAML2/Unsolicited/SSO?providerId=urn:amazon:webservices&quot;);
%&gt;
</span>
[root@linux1 lib]# vi /opt/apache-tomcat-8.0.41/conf/context.xml
<b><i># Uncomment the below section to disable session persistence</i></b>
<span style="color: blue;">
&lt;Manager pathname=&quot;&quot; /&gt;
</span>
<b><i># Keep a copy of default log configuration, so that we can revert back to normal logging once everything is working fine</i></b>
[root@linux1 bin]# cp /opt/shibboleth-idp/conf/logback.xml /opt/shibboleth-idp/conf/logback.xml.org 
[root@linux1 bin]# vi /opt/shibboleth-idp/conf/logback.xml 
<b><i># Enable all level= as DEBUG and other log level values to DEBUG.</i></b>
<span style="color: brown;">
<a href="samples/aws/shibboleth/logback.xml" style="color: brown;">Click here for a sample DEBUG enabled log configuration file</a>
</span>
[root@linux1 bin]# vi /opt/shibboleth-idp/conf/access-control.xml
<b><i># Edit below section to add the subnet details from where this IdP needs to be accessed</i></b>
<span style="color: blue;">
    &lt;entry key=&quot;AccessByIPAddress&quot;&gt;
        &lt;bean id=&quot;AccessByIPAddress&quot; parent=&quot;shibboleth.IPRangeAccessControl&quot;
            p:allowedRanges=&quot;#{ {&#39;127.0.0.1/32&#39;, &#39;::1/128&#39;, &#39;10.0.0.0/8&#39;} }&quot; /&gt;
    &lt;/entry&gt;
</span> 
<span style="color: brown;">
<a href="samples/aws/shibboleth/access-control.xml" style="color: brown;">Click here for a sample access-control configuration file</a>
</span>
[root@linux1 bin]# /opt/apache-tomcat-8.0.41/bin/startup.sh; tail -f /opt/apache-tomcat-8.0.41/logs/catalina.out
</code></p>
</pre><p>Open <a href="https://idp.example.com/idp/status" style="color: #337ab7;"><a href="https://idp.example.com/idp/status">https://idp.example.com/idp/status</a></a>, it should display the details of OS and services. Download /opt/shibboleth-idp/metadata/idp-metadata.xml from the IdP server and use it to create a SAML Identity provider in AWS.</p>
<p>While creating the identity provider in AWS, select:</p>
<p>Provider Type: SAML, Provider Name: BejoyIdP330, Upload the file downloaded above from IdP.</p>
<p>Note down the complete ARN of the Identity provider -&gt; arn:aws:iam::123456789012:saml-provider/BejoyIdP330</p>
<p>
Create new IAM role with type as &#39;Identity Provider Access&#39; and &#39;WebSSO Access&#39;, and select the identity provider created in previous step as the SAML provider. Associate necessary Groups/Permissions corresponding to the groups in LDAP, like Bejoy-AWS-ReadOnly, Bejoy-AWS-SysAdmins. For the roles, you can put additional conditions so that it can be assumed only with certain criteria like below (you can refer any other attributes like eduPersonPrimaryOrgUnitDN which gets released by IdP to AWS to do this condition validation)</p></p>
<figure class="highlight">
<pre>
<p><code class="language-js" data-lang="js">
{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
{
&quot;Effect&quot;: &quot;Allow&quot;,
&quot;Action&quot;: &quot;sts:AssumeRoleWithSAML&quot;,
&quot;Principal&quot;: {
&quot;Federated&quot;: &quot;arn:aws:iam::123456789012:saml-provider/BejoyIdP330&quot;
},
&quot;Condition&quot;: {
&quot;StringEquals&quot;: {
  &quot;SAML:aud&quot;: &quot;<a href="https://signin.aws.amazon.com/saml">https://signin.aws.amazon.com/saml</a>&quot;
}
}
}
]
}</p>
<p><b><i># Sample condition to allow this role only if the department is HR</i></b>
&quot;Condition&quot;: { 
&quot;StringEquals&quot;: { &quot;SAML:aud&quot;: &quot;<a href="https://signin.aws.amazon.com/saml">https://signin.aws.amazon.com/saml</a>&quot; },
&quot;ForAnyValue:StringEquals&quot;: { &quot;SAML:eduPersonPrimaryOrgUnitDN&quot;: &quot;ou=hr,dc=example,dc=com&quot; }
}
</code></p>
</pre></figure><p>
<p>Note down the role ARNs as well:</p>
<p>
arn:aws:iam::123456789012:role/Bejoy-AWS-ReadOnly<br>
arn:aws:iam::123456789012:role/Bejoy-AWS-SysAdmins</p>
</p><p>
<p>Modify /opt/shibboleth/conf/ldap.properties to update your LDAP server details, user search base, and groups search base.</p>
</p><figure class="highlight">
<pre>
<p><code class="language-js" data-lang="js">
idp.authn.LDAP.ldapURL                          = ldap://myldap.example.com
idp.authn.LDAP.useStartTLS                     = false
idp.authn.LDAP.useSSL                          = false
idp.authn.LDAP.returnAttributes                 = passwordExpirationTime,loginGraceRemaining
idp.authn.LDAP.baseDN                           = ou=users,o=example.com
idp.authn.LDAP.baseDNGroups                     = ou=groups,o=example.com
idp.authn.LDAP.subtreeSearch                   = true
idp.authn.LDAP.userFilter                       = (preferredIdentity={user})
idp.authn.LDAP.dnFormat                         = uid=%s,ou=users,o=example.com
idp.attribute.resolver.LDAP.ldapURL             = %{idp.authn.LDAP.ldapURL}
idp.attribute.resolver.LDAP.connectTimeout      = %{idp.authn.LDAP.connectTimeout:PT3S}
idp.attribute.resolver.LDAP.responseTimeout     = %{idp.authn.LDAP.responseTimeout:PT3S}
idp.attribute.resolver.LDAP.baseDN              = %{idp.authn.LDAP.baseDN:undefined}
idp.attribute.resolver.LDAP.baseDNGroups        = %{idp.authn.LDAP.baseDNGroups:undefined}
idp.attribute.resolver.LDAP.bindDN              = %{idp.authn.LDAP.bindDN:undefined}
idp.attribute.resolver.LDAP.bindDNCredential    = %{idp.authn.LDAP.bindDNCredential:undefined}
idp.attribute.resolver.LDAP.useStartTLS         = %{idp.authn.LDAP.useStartTLS:true}
idp.attribute.resolver.LDAP.searchFilter        = (preferredIdentity=$resolutionContext.principal)
</code></p>
</pre></figure><p>
<p>Modify the file /opt/shibboleth/conf/attribute-resolver.xml as <a href="samples/aws/shibboleth/attribute-resolver.xml" style="color: #337ab7;">this sample file</a> (replace the role names, IdP names as required)</p>
<p> 
Modify the file /opt/shibboleth/conf/attribute-filter.xml as <a href="samples/aws/shibboleth/attribute-filter.xml" style="color: #337ab7;">this sample file</a>.</p>
</p><p>
<p>Modify /opt/shibboleth/conf/relying-party.xml (<a href="samples/aws/shibboleth/relying-party.xml" style="color: #337ab7;">sample here</a>) &amp; metadata-providers.xml (<a href="samples/aws/shibboleth/metadata-providers.xml" style="color: #337ab7;">sample here</a>) to make Shibboleth talk to AWS.</p>
</p><p>
<p>Restart Tomcat to reflect the configuration changes</p>
<figure class="highlight"><pre><code class="language-js" data-lang="js">
[root@linux1 ~]# /opt/apache-tomcat-8.0.41/bin/shutdown.sh; sleep 10; /opt/apache-tomcat-8.0.41/bin/startup.sh; tail -f /opt/apache-tomcat-8.0.41/logs/catalina.out
[root@linux1 ~]# tail -f /opt/shibboleth/logs/idp-process.log
</code></pre></figure>
To test if the IdP is able to create the SAML for AWS assertion, run this. This should output a SAML xml with proper AWS roles and other values as defined.
<figure class="highlight"><pre><code class="language-js" data-lang="js">
[root@linux1 ~]# cd /opt/shibboleth-idp/bin; ./aacli.sh --requester &quot;urn:amazon:webservices&quot; --principal <a href="mailto:bejoy@email.com">bejoy@email.com</a>
(<a href="http://localhost/idp/profile/admin/resolvertest?requester=urn%3Aamazon%3Awebservices&principal=bejoy%40email.com">http://localhost/idp/profile/admin/resolvertest?requester=urn%3Aamazon%3Awebservices&amp;principal=bejoy%40email.com</a>) <a href="http://localhost/idp/profile/admin/resolvertest?requester=urn%3Aamazon%3Awebservices&principal=bejoy%40email.com">http://localhost/idp/profile/admin/resolvertest?requester=urn%3Aamazon%3Awebservices&amp;principal=bejoy%40email.com</a>
<b><i># replace &#39;http&#39; with &#39;https&#39; for testing the URL you get from this script, and open it in browser.</i></b>
</code></pre></figure>
<p>
Open URL <a href="https://idp.example.com/idp/profile/SAML2/Unsolicited/SSO?providerId=urn:amazon:webservices" style="color: #337ab7;"><a href="https://idp.example.com/idp/profile/SAML2/Unsolicited/SSO?providerId=urn:amazon:webservices">https://idp.example.com/idp/profile/SAML2/Unsolicited/SSO?providerId=urn:amazon:webservices</a></a>
to open the Shibboleth IdP login page and fill in the user name password with your intranet ID and password, this should login to AWS with the appropriate role based on your LDAP group membership. (Copy &amp; paste this URL to your browser if the link in browser says <a href="https://idp.example.com/idp/Authn/UserPassword">https://idp.example.com/idp/Authn/UserPassword</a> instead of the above complete URL)</p>
</p><p>
<p>If everything works fine, replace /opt/shibboleth-idp/conf/logback.xml with the original base logging file and restart tomcat</p>
</p><figure class="highlight">
<pre>
<p><code class="language-js" data-lang="js">
[root@linux1 ~]# /opt/apache-tomcat-8.0.41/bin/shutdown.sh; sleep 10; /opt/apache-tomcat-8.0.41/bin/startup.sh; tail -f /opt/apache-tomcat-8.0.41/logs/catalina.out
</code></p>
</pre></figure>

    </div>
  </div>
</div>


    <div id="footer" class="navigation hidden-print">
      <div class="container">
        <div class="row">
          <div class="col-xs-12">
            <ul class="footer-links nav navbar-nav">
              <li><a href="aws.html">AWS</a></li>
              <li><a href="linux.html">Linux</a></li>
              <li><a href="docker.html">Docker</a></li>
              <li><a href="ibmpower.html">IBM Power</a></li>
            </ul>
            <ul class="footer-links nav navbar-nav navbar-right">
              <li><a href="/comments.html">Comments?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
