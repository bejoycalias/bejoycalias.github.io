<?xml version="1.0" encoding="UTF-8"?>
<AttributeResolver
        xmlns="urn:mace:shibboleth:2.0:resolver"
        xmlns:sec="urn:mace:shibboleth:2.0:security"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:mace:shibboleth:2.0:resolver http://shibboleth.net/schema/idp/shibboleth-attribute-resolver.xsd
                            urn:mace:shibboleth:2.0:security http://shibboleth.net/schema/idp/shibboleth-security.xsd">

    <!--      Attribute Definitions                 -->

    <AttributeDefinition xsi:type="Simple" id="uid" sourceAttributeID="uid">
        <Dependency ref="myLDAP" />
        <AttributeEncoder xsi:type="SAML1String" name="urn:mace:dir:attribute-def:uid" encodeType="false" />
        <AttributeEncoder xsi:type="SAML2String" name="urn:oid:0.9.2342.19200300.100.1.1" friendlyName="uid" encodeType="false" />
    </AttributeDefinition>
<AttributeDefinition id="awsRoles" xsi:type="Mapped" sourceAttributeID="cn">
<Dependency ref="LDAPGroups"/>
<AttributeEncoder xsi:type="SAML2String" name="https://aws.amazon.com/SAML/Attributes/Role" friendlyName="Role" />
<ValueMap>
<ReturnValue>
arn:aws:iam::123456789012:role/Bejoy-AWS-ReadOnly,arn:aws:iam::123456789012:saml-provider/BejoyIdP330
</ReturnValue>
<SourceValue>LDAPGroup-AWS-ReadOnly</SourceValue>
</ValueMap>
<ValueMap>
<ReturnValue>
arn:aws:iam::123456789012:role/Bejoy-AWS-ReadOnly,arn:aws:iam::123456789012:saml-provider/BejoyIdP330
</ReturnValue>
<SourceValue>LDAPGroup-AWS-ReadOnly</SourceValue>
</ValueMap>
<ValueMap>
<ReturnValue>
arn:aws:iam::123456789012:role/Bejoy-AWS-SysAdmins,arn:aws:iam::123456789012:saml-provider/BejoyIdP330
</ReturnValue>
<SourceValue>LDAPGroup-AWS-SysAdmins</SourceValue>
</ValueMap>
</AttributeDefinition>
<AttributeDefinition id="awsRoleSessionName" xsi:type="Simple" sourceAttributeID="preferredIdentity">
<Dependency ref="myLDAP"/>
<AttributeEncoder xsi:type="SAML2String" name="https://aws.amazon.com/SAML/Attributes/RoleSessionName" friendlyName="RoleSessionName" />
</AttributeDefinition>

    <!--      Data Connectors                       -->

    <DataConnector id="myLDAP" xsi:type="LDAPDirectory"
        ldapURL="%{idp.attribute.resolver.LDAP.ldapURL}"
        baseDN="%{idp.attribute.resolver.LDAP.baseDN}" 
	maxResultSize="100">
        <FilterTemplate>
            <![CDATA[
                %{idp.attribute.resolver.LDAP.searchFilter}
            ]]>
        </FilterTemplate>
	<ReturnAttributes>preferredIdentity uid dn</ReturnAttributes>
    </DataConnector>
    <DataConnector id="LDAPGroups" xsi:type="LDAPDirectory"
	ldapURL="%{idp.attribute.resolver.LDAP.ldapURL}"
        baseDN="%{idp.attribute.resolver.LDAP.baseDNGroups}" 
	maxResultSize="100">
        <FilterTemplate>
            <![CDATA[
		(&(cn=*aws*)(uniquemember=uid=${uid.get(0)},*,ou=users,o=example.com))
            ]]>
        </FilterTemplate>
	<Dependency ref="myLDAP" />
	<Dependency ref="uid" />
	<ReturnAttributes>cn</ReturnAttributes>
    </DataConnector>
</AttributeResolver>
